+function(){function a(a,b,c){null!=a&&("number"==typeof a?this.fromNumber(a,b,c):null==b&&"string"!=typeof a?this.fromString(a,256):this.fromString(a,b))}function b(){return new a(null)}function c(a,b,c,d,e,f){for(;--f>=0;){var g=b*this[a++]+c[d]+e;e=Math.floor(g/67108864),c[d++]=67108863&g}return e}function d(a,b,c,d,e,f){for(var g=32767&b,h=b>>15;--f>=0;){var i=32767&this[a],j=this[a++]>>15,k=h*i+j*g;i=g*i+((32767&k)<<15)+c[d]+(1073741823&e),e=(i>>>30)+(k>>>15)+h*j+(e>>>30),c[d++]=1073741823&i}return e}function e(a,b,c,d,e,f){for(var g=16383&b,h=b>>14;--f>=0;){var i=16383&this[a],j=this[a++]>>14,k=h*i+j*g;i=g*i+((16383&k)<<14)+c[d]+e,e=(i>>28)+(k>>14)+h*j,c[d++]=268435455&i}return e}function f(a){return bc.charAt(a)}function g(a,b){var c=cc[a.charCodeAt(b)];return null==c?-1:c}function h(a){for(var b=this.t-1;b>=0;--b)a[b]=this[b];a.t=this.t,a.s=this.s}function j(a){this.t=1,this.s=0>a?-1:0,a>0?this[0]=a:-1>a?this[0]=a+DV:this.t=0}function k(a){var c=b();return c.fromInt(a),c}function l(b,c){var d;if(16==c)d=4;else if(8==c)d=3;else if(256==c)d=8;else if(2==c)d=1;else if(32==c)d=5;else{if(4!=c)return void this.fromRadix(b,c);d=2}this.t=0,this.s=0;for(var e=b.length,f=!1,h=0;--e>=0;){var i=8==d?255&b[e]:g(b,e);0>i?"-"==b.charAt(e)&&(f=!0):(f=!1,0==h?this[this.t++]=i:h+d>this.DB?(this[this.t-1]|=(i&(1<<this.DB-h)-1)<<h,this[this.t++]=i>>this.DB-h):this[this.t-1]|=i<<h,h+=d,h>=this.DB&&(h-=this.DB))}8==d&&0!=(128&b[0])&&(this.s=-1,h>0&&(this[this.t-1]|=(1<<this.DB-h)-1<<h)),this.clamp(),f&&a.ZERO.subTo(this,this)}function m(){for(var a=this.s&this.DM;this.t>0&&this[this.t-1]==a;)--this.t}function n(a){if(this.s<0)return"-"+this.negate().toString(a);var b;if(16==a)b=4;else if(8==a)b=3;else if(2==a)b=1;else if(32==a)b=5;else{if(4!=a)return this.toRadix(a);b=2}var c,d=(1<<b)-1,e=!1,g="",h=this.t,i=this.DB-h*this.DB%b;if(h-->0)for(i<this.DB&&(c=this[h]>>i)>0&&(e=!0,g=f(c));h>=0;)b>i?(c=(this[h]&(1<<i)-1)<<b-i,c|=this[--h]>>(i+=this.DB-b)):(c=this[h]>>(i-=b)&d,0>=i&&(i+=this.DB,--h)),c>0&&(e=!0),e&&(g+=f(c));return e?g:"0"}function o(){var c=b();return a.ZERO.subTo(this,c),c}function p(){return this.s<0?this.negate():this}function q(a){var b=this.s-a.s;if(0!=b)return b;var c=this.t;if(b=c-a.t,0!=b)return b;for(;--c>=0;)if(0!=(b=this[c]-a[c]))return b;return 0}function r(a){var b,c=1;return 0!=(b=a>>>16)&&(a=b,c+=16),0!=(b=a>>8)&&(a=b,c+=8),0!=(b=a>>4)&&(a=b,c+=4),0!=(b=a>>2)&&(a=b,c+=2),0!=(b=a>>1)&&(a=b,c+=1),c}function s(){return this.t<=0?0:this.DB*(this.t-1)+r(this[this.t-1]^this.s&this.DM)}function t(a,b){var c;for(c=this.t-1;c>=0;--c)b[c+a]=this[c];for(c=a-1;c>=0;--c)b[c]=0;b.t=this.t+a,b.s=this.s}function u(a,b){for(var c=a;c<this.t;++c)b[c-a]=this[c];b.t=Math.max(this.t-a,0),b.s=this.s}function v(a,b){var c,d=a%this.DB,e=this.DB-d,f=(1<<e)-1,g=Math.floor(a/this.DB),h=this.s<<d&this.DM;for(c=this.t-1;c>=0;--c)b[c+g+1]=this[c]>>e|h,h=(this[c]&f)<<d;for(c=g-1;c>=0;--c)b[c]=0;b[g]=h,b.t=this.t+g+1,b.s=this.s,b.clamp()}function w(a,b){b.s=this.s;var c=Math.floor(a/this.DB);if(c>=this.t)return void(b.t=0);var d=a%this.DB,e=this.DB-d,f=(1<<d)-1;b[0]=this[c]>>d;for(var g=c+1;g<this.t;++g)b[g-c-1]|=(this[g]&f)<<e,b[g-c]=this[g]>>d;d>0&&(b[this.t-c-1]|=(this.s&f)<<e),b.t=this.t-c,b.clamp()}function x(a,b){for(var c=0,d=0,e=Math.min(a.t,this.t);e>c;)d+=this[c]-a[c],b[c++]=d&this.DM,d>>=this.DB;if(a.t<this.t){for(d-=a.s;c<this.t;)d+=this[c],b[c++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;c<a.t;)d-=a[c],b[c++]=d&this.DM,d>>=this.DB;d-=a.s}b.s=0>d?-1:0,-1>d?b[c++]=this.DV+d:d>0&&(b[c++]=d),b.t=c,b.clamp()}function y(b,c){var d=this.abs(),e=b.abs(),f=d.t;for(c.t=f+e.t;--f>=0;)c[f]=0;for(f=0;f<e.t;++f)c[f+d.t]=d.am(0,e[f],c,f,0,d.t);c.s=0,c.clamp(),this.s!=b.s&&a.ZERO.subTo(c,c)}function z(a){for(var b=this.abs(),c=a.t=2*b.t;--c>=0;)a[c]=0;for(c=0;c<b.t-1;++c){var d=b.am(c,b[c],a,2*c,0,1);(a[c+b.t]+=b.am(c+1,2*b[c],a,2*c+1,d,b.t-c-1))>=b.DV&&(a[c+b.t]-=b.DV,a[c+b.t+1]=1)}a.t>0&&(a[a.t-1]+=b.am(c,b[c],a,2*c,0,1)),a.s=0,a.clamp()}function A(c,d,e){var f=c.abs();if(!(f.t<=0)){var g=this.abs();if(g.t<f.t)return null!=d&&d.fromInt(0),void(null!=e&&this.copyTo(e));null==e&&(e=b());var h=b(),i=this.s,j=c.s,k=this.DB-r(f[f.t-1]);k>0?(f.lShiftTo(k,h),g.lShiftTo(k,e)):(f.copyTo(h),g.copyTo(e));var l=h.t,m=h[l-1];if(0!=m){var n=m*(1<<this.F1)+(l>1?h[l-2]>>this.F2:0),o=this.FV/n,p=(1<<this.F1)/n,q=1<<this.F2,s=e.t,t=s-l,u=null==d?b():d;for(h.dlShiftTo(t,u),e.compareTo(u)>=0&&(e[e.t++]=1,e.subTo(u,e)),a.ONE.dlShiftTo(l,u),u.subTo(h,h);h.t<l;)h[h.t++]=0;for(;--t>=0;){var v=e[--s]==m?this.DM:Math.floor(e[s]*o+(e[s-1]+q)*p);if((e[s]+=h.am(0,v,e,t,0,l))<v)for(h.dlShiftTo(t,u),e.subTo(u,e);e[s]<--v;)e.subTo(u,e)}null!=d&&(e.drShiftTo(l,d),i!=j&&a.ZERO.subTo(d,d)),e.t=l,e.clamp(),k>0&&e.rShiftTo(k,e),0>i&&a.ZERO.subTo(e,e)}}}function B(c){var d=b();return this.abs().divRemTo(c,null,d),this.s<0&&d.compareTo(a.ZERO)>0&&c.subTo(d,d),d}function C(a){this.m=a}function D(a){return a.s<0||a.compareTo(this.m)>=0?a.mod(this.m):a}function E(a){return a}function F(a){a.divRemTo(this.m,null,a)}function G(a,b,c){a.multiplyTo(b,c),this.reduce(c)}function H(a,b){a.squareTo(b),this.reduce(b)}function I(){if(this.t<1)return 0;var a=this[0];if(0==(1&a))return 0;var b=3&a;return b=b*(2-(15&a)*b)&15,b=b*(2-(255&a)*b)&255,b=b*(2-((65535&a)*b&65535))&65535,b=b*(2-a*b%this.DV)%this.DV,b>0?this.DV-b:-b}function J(a){this.m=a,this.mp=a.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<a.DB-15)-1,this.mt2=2*a.t}function K(c){var d=b();return c.abs().dlShiftTo(this.m.t,d),d.divRemTo(this.m,null,d),c.s<0&&d.compareTo(a.ZERO)>0&&this.m.subTo(d,d),d}function L(a){var c=b();return a.copyTo(c),this.reduce(c),c}function M(a){for(;a.t<=this.mt2;)a[a.t++]=0;for(var b=0;b<this.m.t;++b){var c=32767&a[b],d=c*this.mpl+((c*this.mph+(a[b]>>15)*this.mpl&this.um)<<15)&a.DM;for(c=b+this.m.t,a[c]+=this.m.am(0,d,a,b,0,this.m.t);a[c]>=a.DV;)a[c]-=a.DV,a[++c]++}a.clamp(),a.drShiftTo(this.m.t,a),a.compareTo(this.m)>=0&&a.subTo(this.m,a)}function N(a,b){a.squareTo(b),this.reduce(b)}function O(a,b,c){a.multiplyTo(b,c),this.reduce(c)}function P(){return 0==(this.t>0?1&this[0]:this.s)}function Q(c,d){if(c>4294967295||1>c)return a.ONE;var e=b(),f=b(),g=d.convert(this),h=r(c)-1;for(g.copyTo(e);--h>=0;)if(d.sqrTo(e,f),(c&1<<h)>0)d.mulTo(f,g,e);else{var i=e;e=f,f=i}return d.revert(e)}function R(a,b){var c;return c=256>a||b.isEven()?new C(b):new J(b),this.exp(a,c)}function S(){var a=b();return this.copyTo(a),a}function T(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function U(){return 0==this.t?this.s:this[0]<<24>>24}function V(){return 0==this.t?this.s:this[0]<<16>>16}function W(a){return Math.floor(Math.LN2*this.DB/Math.log(a))}function X(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function Y(a){if(null==a&&(a=10),0==this.signum()||2>a||a>36)return"0";var c=this.chunkSize(a),d=Math.pow(a,c),e=k(d),f=b(),g=b(),h="";for(this.divRemTo(e,f,g);f.signum()>0;)h=(d+g.intValue()).toString(a).substr(1)+h,f.divRemTo(e,f,g);return g.intValue().toString(a)+h}function Z(b,c){this.fromInt(0),null==c&&(c=10);for(var d=this.chunkSize(c),e=Math.pow(c,d),f=!1,h=0,i=0,j=0;j<b.length;++j){var k=g(b,j);0>k?"-"==b.charAt(j)&&0==this.signum()&&(f=!0):(i=c*i+k,++h>=d&&(this.dMultiply(e),this.dAddOffset(i,0),h=0,i=0))}h>0&&(this.dMultiply(Math.pow(c,h)),this.dAddOffset(i,0)),f&&a.ZERO.subTo(this,this)}function $(b,c,d){if("number"==typeof c)if(2>b)this.fromInt(1);else for(this.fromNumber(b,d),this.testBit(b-1)||this.bitwiseTo(a.ONE.shiftLeft(b-1),ga,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(c);)this.dAddOffset(2,0),this.bitLength()>b&&this.subTo(a.ONE.shiftLeft(b-1),this);else{var e=new Array,f=7&b;e.length=(b>>3)+1,c.nextBytes(e),f>0?e[0]&=(1<<f)-1:e[0]=0,this.fromString(e,256)}}function _(){var a=this.t,b=new Array;b[0]=this.s;var c,d=this.DB-a*this.DB%8,e=0;if(a-->0)for(d<this.DB&&(c=this[a]>>d)!=(this.s&this.DM)>>d&&(b[e++]=c|this.s<<this.DB-d);a>=0;)8>d?(c=(this[a]&(1<<d)-1)<<8-d,c|=this[--a]>>(d+=this.DB-8)):(c=this[a]>>(d-=8)&255,0>=d&&(d+=this.DB,--a)),0!=(128&c)&&(c|=-256),0==e&&(128&this.s)!=(128&c)&&++e,(e>0||c!=this.s)&&(b[e++]=c);return b}function aa(a){return 0==this.compareTo(a)}function ba(a){return this.compareTo(a)<0?this:a}function ca(a){return this.compareTo(a)>0?this:a}function da(a,b,c){var d,e,f=Math.min(a.t,this.t);for(d=0;f>d;++d)c[d]=b(this[d],a[d]);if(a.t<this.t){for(e=a.s&this.DM,d=f;d<this.t;++d)c[d]=b(this[d],e);c.t=this.t}else{for(e=this.s&this.DM,d=f;d<a.t;++d)c[d]=b(e,a[d]);c.t=a.t}c.s=b(this.s,a.s),c.clamp()}function ea(a,b){return a&b}function fa(a){var c=b();return this.bitwiseTo(a,ea,c),c}function ga(a,b){return a|b}function ha(a){var c=b();return this.bitwiseTo(a,ga,c),c}function ia(a,b){return a^b}function ja(a){var c=b();return this.bitwiseTo(a,ia,c),c}function ka(a,b){return a&~b}function la(a){var c=b();return this.bitwiseTo(a,ka,c),c}function ma(){for(var a=b(),c=0;c<this.t;++c)a[c]=this.DM&~this[c];return a.t=this.t,a.s=~this.s,a}function na(a){var c=b();return 0>a?this.rShiftTo(-a,c):this.lShiftTo(a,c),c}function oa(a){var c=b();return 0>a?this.lShiftTo(-a,c):this.rShiftTo(a,c),c}function pa(a){if(0==a)return-1;var b=0;return 0==(65535&a)&&(a>>=16,b+=16),0==(255&a)&&(a>>=8,b+=8),0==(15&a)&&(a>>=4,b+=4),0==(3&a)&&(a>>=2,b+=2),0==(1&a)&&++b,b}function qa(){for(var a=0;a<this.t;++a)if(0!=this[a])return a*this.DB+pa(this[a]);return this.s<0?this.t*this.DB:-1}function ra(a){for(var b=0;0!=a;)a&=a-1,++b;return b}function sa(){for(var a=0,b=this.s&this.DM,c=0;c<this.t;++c)a+=ra(this[c]^b);return a}function ta(a){var b=Math.floor(a/this.DB);return b>=this.t?0!=this.s:0!=(this[b]&1<<a%this.DB)}function ua(b,c){var d=a.ONE.shiftLeft(b);return this.bitwiseTo(d,c,d),d}function va(a){return this.changeBit(a,ga)}function wa(a){return this.changeBit(a,ka)}function xa(a){return this.changeBit(a,ia)}function ya(a,b){for(var c=0,d=0,e=Math.min(a.t,this.t);e>c;)d+=this[c]+a[c],b[c++]=d&this.DM,d>>=this.DB;if(a.t<this.t){for(d+=a.s;c<this.t;)d+=this[c],b[c++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;c<a.t;)d+=a[c],b[c++]=d&this.DM,d>>=this.DB;d+=a.s}b.s=0>d?-1:0,d>0?b[c++]=d:-1>d&&(b[c++]=this.DV+d),b.t=c,b.clamp()}function za(a){var c=b();return this.addTo(a,c),c}function Aa(a){var c=b();return this.subTo(a,c),c}function Ba(a){var c=b();return this.multiplyTo(a,c),c}function Ca(){var a=b();return this.squareTo(a),a}function Da(a){var c=b();return this.divRemTo(a,c,null),c}function Ea(a){var c=b();return this.divRemTo(a,null,c),c}function Fa(a){var c=b(),d=b();return this.divRemTo(a,c,d),new Array(c,d)}function Ga(a){this[this.t]=this.am(0,a-1,this,0,0,this.t),++this.t,this.clamp()}function Ha(a,b){if(0!=a){for(;this.t<=b;)this[this.t++]=0;for(this[b]+=a;this[b]>=this.DV;)this[b]-=this.DV,++b>=this.t&&(this[this.t++]=0),++this[b]}}function Ia(){}function Ja(a){return a}function Ka(a,b,c){a.multiplyTo(b,c)}function La(a,b){a.squareTo(b)}function Ma(a){return this.exp(a,new Ia)}function Na(a,b,c){var d=Math.min(this.t+a.t,b);for(c.s=0,c.t=d;d>0;)c[--d]=0;var e;for(e=c.t-this.t;e>d;++d)c[d+this.t]=this.am(0,a[d],c,d,0,this.t);for(e=Math.min(a.t,b);e>d;++d)this.am(0,a[d],c,d,0,b-d);c.clamp()}function Oa(a,b,c){--b;var d=c.t=this.t+a.t-b;for(c.s=0;--d>=0;)c[d]=0;for(d=Math.max(b-this.t,0);d<a.t;++d)c[this.t+d-b]=this.am(b-d,a[d],c,0,0,this.t+d-b);c.clamp(),c.drShiftTo(1,c)}function Pa(c){this.r2=b(),this.q3=b(),a.ONE.dlShiftTo(2*c.t,this.r2),this.mu=this.r2.divide(c),this.m=c}function Qa(a){if(a.s<0||a.t>2*this.m.t)return a.mod(this.m);if(a.compareTo(this.m)<0)return a;var c=b();return a.copyTo(c),this.reduce(c),c}function Ra(a){return a}function Sa(a){for(a.drShiftTo(this.m.t-1,this.r2),a.t>this.m.t+1&&(a.t=this.m.t+1,a.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);a.compareTo(this.r2)<0;)a.dAddOffset(1,this.m.t+1);for(a.subTo(this.r2,a);a.compareTo(this.m)>=0;)a.subTo(this.m,a)}function Ta(a,b){a.squareTo(b),this.reduce(b)}function Ua(a,b,c){a.multiplyTo(b,c),this.reduce(c)}function Va(a,c){var d,e,f=a.bitLength(),g=k(1);if(0>=f)return g;d=18>f?1:48>f?3:144>f?4:768>f?5:6,e=8>f?new C(c):c.isEven()?new Pa(c):new J(c);var h=new Array,i=3,j=d-1,l=(1<<d)-1;if(h[1]=e.convert(this),d>1){var m=b();for(e.sqrTo(h[1],m);l>=i;)h[i]=b(),e.mulTo(m,h[i-2],h[i]),i+=2}var n,o,p=a.t-1,q=!0,s=b();for(f=r(a[p])-1;p>=0;){for(f>=j?n=a[p]>>f-j&l:(n=(a[p]&(1<<f+1)-1)<<j-f,p>0&&(n|=a[p-1]>>this.DB+f-j)),i=d;0==(1&n);)n>>=1,--i;if((f-=i)<0&&(f+=this.DB,--p),q)h[n].copyTo(g),q=!1;else{for(;i>1;)e.sqrTo(g,s),e.sqrTo(s,g),i-=2;i>0?e.sqrTo(g,s):(o=g,g=s,s=o),e.mulTo(s,h[n],g)}for(;p>=0&&0==(a[p]&1<<f);)e.sqrTo(g,s),o=g,g=s,s=o,--f<0&&(f=this.DB-1,--p)}return e.revert(g)}function Wa(a){var b=this.s<0?this.negate():this.clone(),c=a.s<0?a.negate():a.clone();if(b.compareTo(c)<0){var d=b;b=c,c=d}var e=b.getLowestSetBit(),f=c.getLowestSetBit();if(0>f)return b;for(f>e&&(f=e),f>0&&(b.rShiftTo(f,b),c.rShiftTo(f,c));b.signum()>0;)(e=b.getLowestSetBit())>0&&b.rShiftTo(e,b),(e=c.getLowestSetBit())>0&&c.rShiftTo(e,c),b.compareTo(c)>=0?(b.subTo(c,b),b.rShiftTo(1,b)):(c.subTo(b,c),c.rShiftTo(1,c));return f>0&&c.lShiftTo(f,c),c}function Xa(a){if(0>=a)return 0;var b=this.DV%a,c=this.s<0?a-1:0;if(this.t>0)if(0==b)c=this[0]%a;else for(var d=this.t-1;d>=0;--d)c=(b*c+this[d])%a;return c}function Ya(b){var c=b.isEven();if(this.isEven()&&c||0==b.signum())return a.ZERO;for(var d=b.clone(),e=this.clone(),f=k(1),g=k(0),h=k(0),i=k(1);0!=d.signum();){for(;d.isEven();)d.rShiftTo(1,d),c?(f.isEven()&&g.isEven()||(f.addTo(this,f),g.subTo(b,g)),f.rShiftTo(1,f)):g.isEven()||g.subTo(b,g),g.rShiftTo(1,g);for(;e.isEven();)e.rShiftTo(1,e),c?(h.isEven()&&i.isEven()||(h.addTo(this,h),i.subTo(b,i)),h.rShiftTo(1,h)):i.isEven()||i.subTo(b,i),i.rShiftTo(1,i);d.compareTo(e)>=0?(d.subTo(e,d),c&&f.subTo(h,f),g.subTo(i,g)):(e.subTo(d,e),c&&h.subTo(f,h),i.subTo(g,i))}return 0!=e.compareTo(a.ONE)?a.ZERO:i.compareTo(b)>=0?i.subtract(b):i.signum()<0?(i.addTo(b,i),i.signum()<0?i.add(b):i):i}function Za(a){var b,c=this.abs();if(1==c.t&&c[0]<=dc[dc.length-1]){for(b=0;b<dc.length;++b)if(c[0]==dc[b])return!0;return!1}if(c.isEven())return!1;for(b=1;b<dc.length;){for(var d=dc[b],e=b+1;e<dc.length&&ec>d;)d*=dc[e++];for(d=c.modInt(d);e>b;)if(d%dc[b++]==0)return!1}return c.millerRabin(a)}function $a(c){var d=this.subtract(a.ONE),e=d.getLowestSetBit();if(0>=e)return!1;var f=d.shiftRight(e);c=c+1>>1,c>dc.length&&(c=dc.length);for(var g=b(),h=0;c>h;++h){g.fromInt(dc[Math.floor(Gb.Util.random()*dc.length)]);var i=g.modPow(f,this);if(0!=i.compareTo(a.ONE)&&0!=i.compareTo(d)){for(var j=1;j++<e&&0!=i.compareTo(d);)if(i=i.modPowInt(2,this),0==i.compareTo(a.ONE))return!1;if(0!=i.compareTo(d))return!1}}return!0}function _a(){this.i=0,this.j=0,this.S=new Array}function ab(a){var b,c,d;for(b=0;256>b;++b)this.S[b]=b;for(c=0,b=0;256>b;++b)c=c+this.S[b]+a[b%a.length]&255,d=this.S[b],this.S[b]=this.S[c],this.S[c]=d;this.i=0,this.j=0}function bb(){var a;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,a=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=a,this.S[a+this.S[this.i]&255]}function cb(){return new _a}function db(a){gc[hc++]^=255&a,gc[hc++]^=a>>8&255,gc[hc++]^=a>>16&255,gc[hc++]^=a>>24&255,hc>=ic&&(hc-=ic)}function eb(){db((new Date).getTime())}function fb(){if(null==fc){for(eb(),fc=cb(),fc.init(gc),hc=0;hc<gc.length;++hc)gc[hc]=0;hc=0}return fc.next()}function gb(a){var b;for(b=0;b<a.length;++b)a[b]=fb()}function hb(){}function ib(b,c){return new a(b,c)}function jb(b,c){if(c<b.length+11)return null;for(var d=new Array,e=b.length-1;e>=0&&c>0;){var f=b.charCodeAt(e--);128>f?d[--c]=f:f>127&&2048>f?(d[--c]=63&f|128,d[--c]=f>>6|192):(d[--c]=63&f|128,d[--c]=f>>6&63|128,d[--c]=f>>12|224)}d[--c]=0;for(var g=new hb,h=new Array;c>2;){for(h[0]=0;0==h[0];)g.nextBytes(h);d[--c]=h[0]}return d[--c]=2,d[--c]=0,new a(d)}function kb(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function lb(a,b){this.n=ib(a,16),this.e=parseInt(b,16)}function mb(a){return a.modPowInt(this.e,this.n)}function nb(a){var b=jb(a,this.n.bitLength()+7>>3);if(null==b)return null;var c=this.doPrivate(b);if(null==c)return null;var d=c.toString(16);return 0==(1&d.length)?d:"0"+d}function ob(a,b){for(var c=a.toByteArray(),d=0;d<c.length&&0==c[d];)++d;if(c.length-d!=b-1||2!=c[d])return null;for(++d;0!=c[d];)if(++d>=c.length)return null;for(var e="";++d<c.length;){var f=255&c[d];128>f?e+=String.fromCharCode(f):f>191&&224>f?(e+=String.fromCharCode((31&f)<<6|63&c[d+1]),++d):(e+=String.fromCharCode((15&f)<<12|(63&c[d+1])<<6|63&c[d+2]),d+=2)}return e}function pb(a,b,c){this.n=ib(a,16),this.e=parseInt(b,16),this.d=ib(c,16)}function qb(a,b,c,d,e,f,g,h){this.n=ib(a,16),this.e=parseInt(b,16),this.d=ib(c,16),this.p=ib(d,16),this.q=ib(e,16),this.dmp1=ib(f,16),this.dmq1=ib(g,16),this.coeff=ib(h,16)}function rb(a){if(null==this.p||null==this.q)return a.modPow(this.d,this.n);for(var b=a.mod(this.p).modPow(this.dmp1,this.p),c=a.mod(this.q).modPow(this.dmq1,this.q);b.compareTo(c)<0;)b=b.add(this.p);return b.subtract(c).multiply(this.coeff).mod(this.p).multiply(this.q).add(c)}function sb(a){var b=ib(a,16),c=this.doPublic(b);return null==c?null:ob(c,this.n.bitLength()+7>>3)}function tb(a,b,c){var d=0,e=0,f=b.split("\n"),g=2*a.measureText("e").width;return f.forEach(function(b){if(c){var f,h,i,j,k,l=b.split(" "),m=l.length,n="";for(i=0;m>i;i++)if(f=l[i]+(i===m-1?"":" "),h=n+f,j=a.measureText(h).width,c>j)n=h;else if(j==c)n="",e+=g;else{for(k=0;k<f.length;k++)if(h=n+f.substr(0,k+1),a.measureText(h).width>c){n=f.substring(k,f.length),e+=g;break}for(;n.length>0&&a.measureText(n).width>c;)for(k=0;k<n.length;k++)if(h=n.substr(0,k+1),a.measureText(h).width>c){n=n.substring(k,n.length),e+=g;break}}}else j=a.measureText(b).width,d=j>d?j:d;e+=g}),d=c?c:d,{w:d,h:e}}function ub(a,b,c,d){var e,f=a.animate,g=d._now,h=d._shapeDataIndex,i=c._animates;if(i||(i=c._animates={}),h.length)for(var j=0;j<h.length;j++){e=h[j];var k=i[e];k||(k=i[e]={}),i=k}else e=h;var l=i[e];l||(l=i[e]={},f.forEach(function(e){var f,h=e.attr,i=l[h];e={attr:h,to:e.to,type:e.type||"number",delay:e.delay||0,dur:e.dur||1e3,interval:e.interval||0,finish:e.finish,repeat:e.repeat||1,reverse:null==e.reverse?!0:e.reverse,onDone:e.onDone,easing:e.easing,trigger:null==e.to,start:g,time:0,total:0,count:0,started:!1,stopped:!1,current:null},Array.isArray(e.dur)&&(e.groupDur=e.dur.slice(0,e.dur.length-1),e.dur=e.dur[e.dur.length-1],e.groupDurTotal=e.groupDur.reduce(function(a,b,c){return e.groupDur[c]=a+b},0),e.groupIndex=0,e.groupTime=0,e.groupStart=g),null==e.finish&&(e.finish=e.delay+e.dur+e.interval),i?Array.isArray(i)?(i.push(e),i=i[i.length-2]):l[h]=[i,e]:(f=Xc(c,b,a,h,d),l[h]=e),i&&(f=i.to,"group_set"===i.type&&(f=f[f.length-1])),e.from=f,e.trigger||(e.started=!0,Db(e),Eb(e))})),f=l,Object.keys(f).forEach(function(e){var h=f[e];if(Array.isArray(h)){var i=h[h.length-1];i.count+1===i.repeat?h.forEach(function(e){vb(e,a,b,c,d,!0)}):i.count+1<i.repeat&&(i.total>=i.finish&&h.forEach(function(a){a.trigger||(a.started=!0),a.stopped=!1,a.time=0,a.start=g,a.total=0,"group_set"===a.type&&(a.groupIndex=0,a.groupTime=0,a.groupStart=g)}),h.forEach(function(e){vb(e,a,b,c,d,!1)}))}else vb(h,a,b,c,d,!0)})}function vb(a,b,c,d,e,f){if(a.trigger){var g=Xc(d,c,b,a.attr,e,null,!1);if(!a.started){if(g===a.from)return;a.started=!0,a.start=e._now,a.to=g,Db(a),Eb(a)}a.started&&g!==a.to&&(a.start=e._now,a.from=a.current,a.to=g,a.time=0,a.total=0,a.count=0,Db(a),Eb(a))}if(a.started&&!a.stopped){var h=e._now,i=h-a.start;if(i>=a.delay&&(a.total=i,i-=a.delay,a.time=i>a.dur?a.dur:i,"group_set"===a.type&&(a.groupTime=h-a.groupStart,a.groupStart===a.start&&(a.groupTime-=a.delay),a.groupTime>=a.groupDur[a.groupIndex]&&a.groupIndex++,a.groupTime>=a.groupDurTotal&&(a.groupIndex=0,a.groupTime=a.groupTime-a.groupDurTotal,a.groupStart=h)),a.total>=a.finish))if(a.count++,"group_set"===a.type,a.count>=a.repeat)a.time=a.dur,a.stopped=!0,a.trigger&&(a.from=a.to,a.to=null,a.start=null,a.time=0,a.total=0,a.count=0,a.started=!1,a.stopped=!1),a.onDone&&a.onDone.call(c,d,e);else if(f&&(a.time=0,a.start=h,a.total=0,a.reverse)){var j=a.from;a.from=a.to,a.to=j,Eb(a)}e&&!e._invalidate&&(e._invalidate=!0)}}function wb(a){if(!gd[a.id]){if(id=!0,gd[a.id]=a,null==a.from&&a.attr&&a.source){var b;a.from=(b=a.attr.match(/^S[:@](.*)/i))?a.source.getStyle(b[1]):(b=a.attr.match(/^C[:@](.*)/i))?a.source.getClient(b[1]):Gb.Util.getValue(a.source,a.attr)}Db(a),Eb(a)}return a.resume(),a}function xb(a,b){return gd[a.id]&&(null==b&&(b=!0),b&&Cb(a,a.to),a.onStop&&a.onStop(),a.time=0,a.total=0,a.start=null,a.count=0,a.started=!1,a.stopped=!1,a.paused=!1,a.pausedTime=null,a.pausedTotal=0,a._oldSpeed=null,a._speedTotal=0,a._speedTime=null,a._percent=0,a._percentSet=null,a._percentDiff=0,delete gd[a.id]),a}function yb(a){null==a&&(a=!0),Object.keys(gd).forEach(function(b){var c=gd[b];c&&(a&&Cb(c,c.to),c.onStop&&c.onStop())}),gd={}}function zb(){Object.keys(gd).forEach(function(a){var b=gd[a];b&&b.pause()})}function Ab(){Object.keys(gd).forEach(function(a){var b=gd[a];b&&b.resume()})}function Bb(a){Object.keys(gd).forEach(function(b){var c=gd[b];if(c&&(null==c.start&&(c._speedTime=c.start=a),null!=c._percentSet&&(c._percentDiff+=(c._percentSet-c._percent)*c.finish),!c.paused||(c.pausedTime||(c.pausedTime=a),null!=c._percentSet))){if(null==c._percentSet&&c.pausedTime&&(c.pausedTotal+=(a-c.pausedTime)*(c._oldSpeed||c._speed),c.pausedTime=null),c._oldSpeed&&!c.pausedTime&&(c._speedTotal=(a-c._speedTime)*c._oldSpeed-c.pausedTotal+c._percentDiff+c._speedTotal,c._percentDiff=0,c.pausedTotal=0,c._speedTime=a,c._oldSpeed=null),c.total=(a-c._speedTime)*c._speed-c.pausedTotal+c._percentDiff+c._speedTotal,null!=c._percentSet&&c.pausedTime&&(c.total-=(a-c.pausedTime)*(c._oldSpeed||c._speed)),c._percent=c.total>=c.finish?1:c.total/c.finish,c.total>c.delay){c.time=c.total-c.delay;var d=!1;if(c.time>=c.dur&&(c.time=c.dur,c.total>=c.finish&&(d=!0)),!c.stopped&&Cb(c,Fb(c)),c.stopped=d,c.total>=c.finish)if(c.count++,c.count>=c.repeat)xb(c,!1),c.onDone&&c.onDone();else if(c.time=0,c.total=0,c.start=null,c.stopped=!1,c.reverse){var e=c.from;c.from=c.to,c.to=e,Eb(c)}}c.paused||!id&&(id=!0),null!=c._percentSet&&(c._percentSet=null)}})}function Cb(a,b){if(a.started||(a.started=!0,a.onPlay&&a.onPlay()),a.filter&&(b=a.filter(b)),a.attr&&a.source){var c;(c=a.attr.match(/^S[:@](.*)/i))?a.source.setStyle(c[1],b):(c=a.attr.match(/^C[:@](.*)/i))?a.source.setClient(c[1],b):Gb.Util.setValue(a.source,a.attr,b)}a.onUpdate&&a.onUpdate(b)}function Db(a){var b=a.type,c=a.from,d=a.to;"number"===b?(a.from=c||0,a.to=d||0):"point"===b?(c?c.length&&(a.from={x:c[0],y:c[1]}):a.from="scale"===a.attr?{x:1,y:1}:{x:0,y:0},d?d.length&&(a.to={x:d[0],y:d[1]}):a.to="scale"===a.attr?{x:1,y:1}:{x:0,y:0}):"rect"===b?(c?c.length&&(a.from={x:c[0],y:c[1],w:c[2],h:c[3]}):a.from={x:0,y:0,w:0,h:0},d?d.length&&(a.to={x:d[0],y:d[1],w:d[2],h:d[3]}):a.to={x:0,y:0,w:0,h:0}):"color"===b&&(a.from=rd(c),a.to=rd(d)),a.current=a.from}function Eb(a){var b=a.type,c=a.from,d=a.to;"number"===b?a.delta=d-c:"point"===b?a.delta={x:d.x-c.x,y:d.y-c.y}:"rect"===b?a.delta={x:d.x-c.x,y:d.y-c.y,w:d.w-c.w,h:d.h-c.h}:"color"===b&&(a.delta={r:d.r-c.r,g:d.g-c.g,b:d.b-c.b,a:d.a-c.a})}function Fb(a,b){var c=a.type,d=a.delta,e=a.from,f=a.time,g=a.dur,h=jd[a.easing||"easeNone"];return h||(h=jd.easeNone),"number"===c?b=h(f,e,d,g):"point"===c?b={x:h(f,e.x,d.x,g),y:h(f,e.y,d.y,g)}:"rect"===c?b={x:h(f,e.x,d.x,g),y:h(f,e.y,d.y,g),w:h(f,e.w,d.w,g),h:h(f,e.h,d.h,g)}:"color"===c?b="rgba("+Math.floor(h(f,e.r,d.r,g))+","+Math.floor(h(f,e.g,d.g,g))+","+Math.floor(h(f,e.b,d.b,g))+","+Math.floor(h(f,e.a,d.a,g))+")":"set"===c?a.time&&(b=a.to):"group_set"===c&&(b=a.to[a.groupIndex]),a.current=b,b}window.twaver&&(window.twaver.animateLoopId&&cancelAnimationFrame(window.twaver.animateLoopId),window.twaver.animateLoopId=null),String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return b=b||0,this.indexOf(a,b)===b});var Gb={};Gb._isInitializing=!1;var Hb={isDeserializing:!1,isCalculatingBus:!1,images:{},registerImage:function(a,b,c,d,e){Hb.images[a]=new Gb.ImageAsset(a,b,c,d,e),xd(a)},getRegisteredImageNames:function(){return Object.keys(Hb.images)},unregisterImage:function(a){delete Hb.images[a]},getImageAsset:function(a){if("string"==typeof a){var b=Hb.images[a];return b}},showVersion:function(a){Hb.isCtrlDown(a)&&a.shiftKey&&76==a.keyCode&&alert("TWaver HTML5 "+Gb.Util.getVersion()+"\n"+Ib)},callLater:function(a,b,c,d){return setTimeout(function(){a.apply(b,c)},d||Dd.CALL_LATER_DELAY)},isEmptyObject:function(a){for(var b in a)return!1;return!0},xml:function(a){if(window.DOMParser)return(new DOMParser).parseFromString(a,"text/xml");var b=new ActiveXObject("Microsoft.XmlDOM");return b.async=!1,b.loadXml(a),b},num:function(a){return"number"==typeof a&&!isNaN(a)&&isFinite(a)},getter:function(a){var b=a.charAt(0).toUpperCase()+a.slice(1),c=/ble$/.test(a)||/ed$/.test(a)?"is":"get";return c+b},setter:function(a){var b=a.charAt(0).toUpperCase()+a.slice(1);return"set"+b},_id:["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],id:function(){for(var a=[],b=0;32>b;b++)a[b]=this._id[Math.floor(16*Gb.Util.random())];return a[12]="4",a[16]=this._id[3&a[16]|8],a.join("")},keys:function(a){var b=new md;for(var c in a)b.add(c);return b},es:["toString","toLocaleString","valueOf"],ip:function(a,b){var c="_"+b;a[Hb.getter(b)]=function(){return this[c]},a[Hb.setter(b)]=function(a){var d=this[c];this[c]=a,this.firePropertyChange(b,d,a)}},validateLicense:function(a){Ib=a,lc()},ibool:function(a,b){var c="_"+b,d=b.charAt(0).toUpperCase()+b.slice(1);a["is"+d]=function(){return this[c]},a[Hb.setter(b)]=function(a){var d=this[c];this[c]=a,this.firePropertyChange(b,d,a)}},getValue:function(a,b,c){var d=b.charAt(0).toUpperCase()+b.slice(1),e="get"+d,f="is"+d;return c?"boolean"===c?a[f]():a[e]():a[e]?a[e]():a[f]?a[f]():a[b]},setValue:function(a,b,c){a["set"+b.charAt(0).toUpperCase()+b.slice(1)](c)},clone:function(a){if(!a)return null;var b={};for(var c in a)b[c]=a[c];return b},cloneRect:function(a){return a?{x:a.x,y:a.y,width:a.width,height:a.height}:null},classCache:{},getClass:function(a){var b=Hb.classCache[a];if(!b){var c=a.split("."),d=c.length;b=window;for(var e=0;d>e;e++)b=b[c[e]],b||"twaver"===c[e]&&(b=Gb);Hb.classCache[a]=b}return b},newInstance:function(a){var b=Hb.getClass(a)||window[a];if(!b)return null;var c=arguments.length,d=arguments;if(1===c)return new b;if(2===c)return new b(d[1]);if(3===c)return new b(d[1],d[2]);if(4===c)return new b(d[1],d[2],d[3]);if(5===c)return new b(d[1],d[2],d[3],d[4]);if(6===c)return new b(d[1],d[2],d[3],d[4],d[5]);if(7===c)return new b(d[1],d[2],d[3],d[4],d[5],d[6]);if(8===c)return new b(d[1],d[2],d[3],d[4],d[5],d[6],d[7]);throw"don't support args more than 7"},addMethod:function(a,b){var c=a.prototype;for(var d in b)c[d]=b[d]},ext:function(a,b,c){var d;if("string"==typeof a&&(d=a,a=Hb.getClass(a)),b){var e=function(){};e.prototype=b.prototype,a.prototype=new e,a.prototype.constructor=a,a.superClass=b.prototype,b.prototype.constructor==Object.prototype.constructor&&(b.prototype.constructor=b)}if(d&&(a.prototype.getClassName=function(){return d}),c){var f=a.prototype;for(var g in c)Pb.ext(g,f,c);for(var h=Hb.es.length,i=0;h>i;i++)g=Hb.es[i],c.hasOwnProperty(g)&&!c.propertyIsEnumerable(g)&&(f[g]=c[g])}},setViewBounds:function(a,b){if(a)if(a.adjustBounds)a.adjustBounds(b);else{var c=a.style;!c&&a.getView()&&(c=a.getView().style),c&&(c.position="absolute",c.left=b.x+"px",c.top=b.y+"px",c.width=b.width+"px",c.height=b.height+"px")}},getImageSrc:function(a){var b=Hb.getImageAsset(a);return b?b.getSrc()?b.getSrc():b.getImage().getAttribute("src"):a},nextColorCount:0,nextColor:function(){return Hb.nextColorCount>=Dd.COLORS.length&&(Hb.nextColorCount=0),Dd.COLORS[Hb.nextColorCount++]},isCtrlDown:function(a){return a.ctrlKey||a.metaKey},isShiftDown:function(a){return a.shiftKey},isAltDown:function(a){return a.altKey},setText:function(a,b,c){c?Ob.isFirefox?a.textContent=b:a.innerText=b:a.innerHTML=b},fillDescendant:function(a,b){b.add(a),a.hasChildren()&&a.getChildren().forEach(function(a){Hb.fillDescendant(a,b)})}},Ib=(Date,"l=1.0\ntype=1\ngis=1\n3d=0\nstart=2017-06-29\nend=2017-10-01\nnote=This license applies to the evaluation version of TWaver. The License is limited to noncommercial use. Noncommercial use relates only to educational, research, personal or evaluation purposes. Any other use is commercial use. You may not use the Software in connection with any business activities.And You are not permitted to modify the software or attempt to decipher, decompile, disassemble or reverse engineer this Software.\nsignature=4ee4186cf7fa3f498dfbefc37d9e0776e648680ac266604664268939f449e44378d7f5e64a821e7a4e271b2cbaf8c6d0f5b04b5941717569682b7e2435416006dace269bd9d0573f6d036e73d47359a08deab61b8888b9594aea18f2a6803181bed01a0e0883b42802d39588452c24705cf43707e616d08f5cc834079a2fa1d7489a5b648b3a3197a4f00dee4ec640b867c77124a2aed2333d859cd44f09a6e7ab16293ab5991b9ab712c19b17729a54c5cb6ae0d11080c9308b72ba0685673c4012f7ad30e0bc7edbdd4eee19d99019df97f9e65d370154c14d6651583974185a2164337bcf414bb91a89f55950a2a0962e733fd095b33f4573a2241a8dda726249eff7d43ca219293cc07c317244f44dc217f2afd23fd001346d71ccd550528269e00614b0046087f1116c4d8741bd1f72869717a58cae852d2decddcdcc71d023e4b0bd6f1c77fc9f01b1673f4a03a4f7c6d9763b867939b89b6421a37b616e4f5aa7d1e60a64c843868816186c98bf3c07796f841d85de85cce340b0f459540f08596af14a6c0824fa8775f5b60b3a34000a491f1c7ecf593937381637ae13d32d6e9c4431c0f33d83d5b26bfbc2c519d6290c09f4a91592df26c338f138933a64868d56c9f2e1d238ed3458999628748f1859efebfed4c5c66d0daf6f683a5388c7832331121a3b0b907cbc160d6e3f1bd1b3fb536de491100f2f7bd45425f05351d9ea1a5c0b664fcf3a488398f48b36b2451e8715dec1b66091f61fc0fa0215c633174ec2e5f51f09559fdb85befb664d27fff283d91a714f9e04e58f38f07afad314a5db6e245c781e6ccc314575cf76e3be3512d0f35f5ec36ecb7af747267ca57c3bf4de3a3214a2d77064555d0ccf73ec6b2ddd20ac0254bfbfcf");"function"==typeof define?define(function(){return Gb}):"object"==typeof exports&&(module.exports=Gb),window&&(window.twaver=Gb,window._twaver=Hb),Gb.animate={},Gb.network={},Gb.network.interaction={},Gb.controls={},Gb.charts={},Gb.layout={};var Jb,Kb,Lb=window.navigator,Mb=window.document,Nb=window.Image;window.document||(Kb=!0,Jb=function(){},Nb=Jb.Image,Lb={userAgent:""},Mb={});var Ob=function(){var a={},b=Lb.userAgent.toLowerCase();return a.isOpera=/opera/.test(b),a.isIE=/msie/.test(b)||/trident/.test(b)||/edge/.test(b),a.isFirefox=/firefox/i.test(b),a.isChrome=/chrome/i.test(b),a.isSafari=!a.isChrome&&/safari/i.test(b),a.isIPhone=/iphone/.test(b),a.isIPod=/ipod/.test(b),a.isIPad=/ipad/.test(b),a.isAndroid=/android/i.test(b),a.isWebOS=/webos/i.test(b),a.isMSTouchable=a.isIE&&(Lb.msMaxTouchPoints&&Lb.msMaxTouchPoints>1||Lb.maxTouchPoints&&Lb.maxTouchPoints>1),a.isTouchable="ontouchend"in Mb||a.isMSTouchable,a}();Hb.ua=Ob;var Pb={__accessor:function(a,b){for(var c=b.__accessor,d=c.length,e=0;d>e;e++)Hb.ip(a,c[e])},__bool:function(a,b){for(var c=b.__bool,d=c.length,e=0;d>e;e++)Hb.ibool(a,c[e])},__client:function(a,b){a.getClient=function(a){return this._clientMap[a]},a.setClient=function(a,b){var c=this._clientMap[a];return null==b?delete this._clientMap[a]:this._clientMap[a]=b,this.firePropertyChange("C:"+a,c,b)&&this.onClientChanged(a,c,b),this},a.getClientProperties=function(){return Hb.keys(this._clientMap)},a.getClientMap=function(){return this._clientMap},a.onClientChanged=function(a,b,c){}},__style:function(a,b){a.getStyle=function(a){var b=this._styleMap[a];return null==b?Ed._m[a]:b},a.setStyle=function(a,b){var c=this._styleMap[a];return null==b?delete this._styleMap[a]:this._styleMap[a]=b,this.firePropertyChange("S:"+a,c,b)&&this.onStyleChanged(a,c,b),this},a.getStyleProperties=function(){return Hb.keys(this._styleMap);

},a.onStyleChanged=function(a,b,c){}},__new:function(a,b){a.newInstance=function(){var a=Hb.getClass(this.getClassName());if(!a)return null;var b=arguments.length,c=arguments;if(0===b)return new a;if(1===b)return new a(c[0]);if(2===b)return new a(c[0],c[1]);if(3===b)return new a(c[0],c[1],c[2]);if(4===b)return new a(c[0],c[1],c[2],c[3]);if(5===b)return new a(c[0],c[1],c[2],c[3],c[4]);if(6===b)return new a(c[0],c[1],c[2],c[3],c[4],c[5]);if(7===b)return new a(c[0],c[1],c[2],c[3],c[4],c[5],c[6]);throw"don't support args more than 7"}},__property:function(a,b){a.getValue=function(a,b){return"accessor"===this._propertyType?Hb.getValue(a,this._propertyName):"style"===this._propertyType&&a.getStyle?a.getStyle(this._propertyName):"client"===this._propertyType&&a.getClient?a.getClient(this._propertyName):"field"===this._propertyType?a[this._propertyName]:null},a.setValue=function(a,b,c){if("accessor"===this._propertyType)a[Hb.setter(this._propertyName)](b);else{if("style"===this._propertyType&&a.setStyle)return a.setStyle(this._propertyName,b);if("client"===this._propertyType&&a.setClient)return a.setClient(this._propertyName,b);"field"===this._propertyType&&(a[this._propertyName]=b)}}},map:{__accessor:1,__bool:1,__client:1,__style:1,__new:1,__tree:1,__property:1},ext:function(a,b,c){1===Pb.map[a]?Pb[a](b,c):b[a]=c[a]}};Hb.extend=Pb;var Qb=Hb.Matrix=function(a,b,c,d,e,f){this.setMatrix(a,b,c,d,e,f)};Qb.identity=function(){return new Qb(1,0,0,1,0,0)},Qb.prototype.setMatrix=function(a,b,c,d,e,f){this._m11=a,this._m12=b,this._m21=c,this._m22=d,this._offsetX=e,this._offsetY=f,this._type=0,0!=this._m21||0!=this._m12?this._type=4:((1!=this._m11||1!=this._m22)&&(this._type=2),(0!=this._offsetX||0!=this._offsetY)&&(this._type|=1),0==(3&this._type)&&(this._type=0))},Qb.prototype.transform=function(){var a;if(a=2===arguments.length?{x:arguments[0],y:arguments[1]}:arguments[0],!a||!Hb.num(a.x)||!Hb.num(a.y))throw"arguments should contain x, y";switch(this._type){case 0:return{x:a.x,y:a.y};case 1:return{x:this._offsetX+a.x,y:this._offsetY+a.y};case 2:return{x:a.x*this._m11,y:a.y*this._m22};case 3:return{x:a.x*this._m11+this._offsetX,y:a.y*this._m22+this._offsetY}}return{x:this._m11*a.x+a.y*this._m21+this._offsetX,y:this._m22*a.y+a.x*this._m12+this._offsetY}},Qb.prototype.translate=function(a,b){this.multiply(new Qb(1,0,0,1,a,b))},Qb.prototype.scale=function(a,b){this.multiply(new Qb(a,0,0,b,0,0))},Qb.prototype.rotate=function(a,b,c){a=a*Math.PI/180;var d=Math.sin(a),e=Math.cos(a),f=b*(1-e)+c*d,g=c*(1-e)-b*d;this.multiply(new Qb(e,d,-d,e,f,g))},Qb.prototype.skew=function(a,b){this.multiply(new Qb(1,Math.tan(b*Math.PI/180),Math.tan(a*Math.PI/180),1,0,0))},Qb.prototype.multiply=function(a){var b=this,c=a,d=b._type,e=c._type;if(0!=e)if(0==d)b.setMatrix(c._m11,c._m12,c._m21,c._m22,c._offsetX,c._offsetY);else if(1==e)b._offsetX+=c._offsetX,b._offsetY+=c._offsetY,4!=d&&(b._type|=1);else if(1==d){var f=b._offsetX,g=b._offsetY;b.setMatrix(c._m11,c._m12,c._m21,c._m22,c._offsetX,c._offsetY),b._offsetX=f*c._m11+g*c._m21+c._offsetX,b._offsetY=f*c._m12+g*c._m22+c._offsetY,b._type=4==e?4:3}else switch(d<<4|e){case 34:return b._m11*=c._m11,void(b._m22*=c._m22);case 35:return b._m11*=c._m11,b._m22*=c._m22,b._offsetX=c._offsetX,b._offsetY=c._offsetY,void(b._type=3);case 36:case 52:case 66:case 67:case 68:return void b.setMatrix(b._m11*c._m11+b._m12*c._m21,b._m11*c._m12+b._m12*c._m22,b._m21*c._m11+b._m22*c._m21,b._m21*c._m12+b._m22*c._m22,b._offsetX*c._m11+b._offsetY*c._m21+c._offsetX,b._offsetX*c._m12+b._offsetY*c._m22+c._offsetY);case 50:return b._m11*=c._m11,b._m22*=c._m22,b._offsetX*=c._m11,void(b._offsetY*=c._m22);case 51:return b._m11*=c._m11,b._m22*=c._m22,b._offsetX=c._m11*b._offsetX+c._offsetX,void(b._offsetY=c._m22*b._offsetY+c._offsetY);default:console.log("Matrix multiply hit an invalid case: "+combinedType)}};var Rb={getDistance:function(a,b){var c=b.x-a.x,d=b.y-a.y;return Math.sqrt(c*c+d*d)},getCenterPoint:function(a,b){return a&&b?{x:(a.x+b.x)/2,y:(a.y+b.y)/2}:null==b&&a.width?{x:a.x+a.width/2,y:a.y+a.height/2}:void 0},isPointInPolygon:function(a,b){a=a._as?a._as:a;var c=0,d=0,e=!1,f=a.length;for(c=0,d=f-1;f>c;d=c++){var g=a[c],h=a[d];g.y>b.y!=h.y>b.y&&b.x<(h.x-g.x)*(b.y-g.y)/(h.y-g.y)+g.x&&(e=!e)}return e},unionRect:function(a,b){if(a&&!b)return Hb.cloneRect(a);if(!a&&b)return Hb.cloneRect(b);if(a&&b){var c=Math.min(a.x,b.x),d=Math.min(a.y,b.y),e=Math.max(a.x+a.width,b.x+b.width)-c,f=Math.max(a.y+a.height,b.y+b.height)-d;return a.x=c,a.y=d,a.width=e,a.height=f,a}return null},intersects:function(a,b){if(!a||!b)return!1;var c=b.width,d=b.height,e=a.width,f=a.height;if(0>=e||0>=f||0>=c||0>=d)return!1;var g=b.x,h=b.y,i=a.x,j=a.y;return e+=i,f+=j,c+=g,d+=h,(i>e||e>g)&&(j>f||f>h)&&(g>c||c>i)&&(h>d||d>j)},intersection:function(a,b){if(!a||!b)return!1;var c=b.x,d=b.y,e=a.x,f=a.y,g=c;g+=b.width;var h=d;h+=b.height;var i=e;i+=a.width;var j=f;return j+=a.height,e>c&&(c=e),f>d&&(d=f),g>i&&(g=i),h>j&&(h=j),g-=c,h-=d,0===g||0===h?null:{x:c,y:d,width:g,height:h}},contains:function(a,b){var c=b.x,d=b.y,e=b.width,f=b.height,g=a.width,h=a.height;if(0>(g|h|e|f))return!1;var i=a.x,j=a.y;if(i>c||j>d)return!1;if(g+=i,e+=c,c>=e){if(g>=i||e>g)return!1}else if(g>=i&&e>g)return!1;if(h+=j,f+=d,d>=f){if(h>=j||f>h)return!1}else if(h>=j&&f>h)return!1;return!0},getLinePoints:function(a){if(!a)return null;var b=new md;return a.forEach(function(a){b.addAll(a)}),b},getLineRect:function(a){var b=Rb.getLinePoints(a);return Rb.getRect(b)},getRect:function(a,b){if(!a)return null;a._as&&(a=a._as);var c=a.length;if(0>=c)return null;var d=a[0];b=b||{x:null,y:null,width:0,height:0};for(var e=0;c>e;e++)if(d=a[e],d instanceof md)Rb.getRect(d,b);else{null==b.x&&(b.x=d.x,b.y=d.y);var f=Math.min(b.x,d.x),g=Math.min(b.y,d.y),h=Math.max(b.x+b.width,d.x),i=Math.max(b.y+b.height,d.y);b.x=f,b.y=g,b.width=h-f,b.height=i-g}return b},addPadding:function(a,b,c,d){d=d||-1;var e=b.getStyle(c)*d;0!=e&&Rb.grow(a,e,e),e=b.getStyle(c+".left")*d,0!=e&&(a.x-=e,a.width+=e),e=b.getStyle(c+".right")*d,0!=e&&(a.width+=e),e=b.getStyle(c+".top")*d,0!=e&&(a.y-=e,a.height+=e),e=b.getStyle(c+".bottom")*d,0!=e&&(a.height+=e),a.width<0&&(a.width=-a.width,a.x-=a.width),a.height<0&&(a.height=-a.height,a.y-=a.height)},grow:function(a,b,c){if(null==a)return null;null==c&&(c=b);var d=a.width+b+b;if(!(0>d)){var e=a.height+c+c;if(!(0>e))return a.x-=b,a.y-=c,a.width=d,a.height=e,a}},containsPoint:function(a,b,c){return arguments.length<3&&(c=b.y,b=b.x),!a||b<a.x||c<a.y||b>a.x+a.width||c>a.y+a.height?!1:!0},getHotSpot:function(a,b,c,d,e){if("oval"===e){var f=.35;return{x:a+.5*c+c*f,y:b+d/2-Math.sqrt(.25-f*f)*d}}if("circle"===e){var g=a+c/2,h=b+d/2,i=Math.min(c,d)/2;a=g-i,b=h-i,c=2*i,d=2*i;var j=c/2,k=d/2,l=j*k/Math.sqrt(j*j+k*k);return{x:a+c/2+l,y:b+d/2-l}}var m={x:a+c,y:b};return c>3&&(m.x-=3),d>3&&(m.y+=3),m},getCircleRect:function(a){var b=Math.min(a.width,a.height)/2;return{x:a.x+a.width/2-b,y:a.y+a.height/2-b,width:2*b,height:2*b}},getEllipsePoint:function(a,b){if(!a||!b)return null;var c=a.x+a.width/2,d=a.y+a.height/2,e=b.x-c,f=b.y-d,g=a.width/2,h=a.height/2,i=Math.sqrt(1/(1/g/g+f*f/e/e/h/h));0>e&&(i=-i);var j;return j=0==e?f>0?h:-h:i*f/e,{x:c+i,y:d+j}},createMatrix:function(a,b,c){var d=Math.sin(a),e=Math.cos(a),f=b*(1-e)+c*d,g=c*(1-e)-b*d;return new Qb(e,d,-d,e,f,g)},calculatePointInfoAlongLineBySegments:function(a,b,c,d,e){return Rb.calculatePointInfoAlongLine(Rb.getPointObject(a,b),c,d,e)},calculatePointInfoAlongLine:function(a,b,c,d){if(b=void 0===b?!0:b,c=c||0,d=d||0,!a||a.size()<2)throw"must more than two points";if(!b){var e=Rb.reversePath(a);return Rb.calculatePointInfoAlongLine(e,!0,c,d)}a._as&&(a=a._as);var f,g,h,i,j,k=0,l=0,m=a.length;for(i=0;m>i;i++)if(j=a[i],0!=i){if(0>=c){h=Rb.calculatePointInfoOnStraightLine(Rb._getPoint(g),Rb._getControlPoint(j),c,d),f=h;break}if(l=Rb._getLength(j,g),k+l>c){h=Rb.getPathInfo(j,g,c-k,d,l),f=h;break}k+=l,g=j}else g=j;if(null==f){var n,o;g=a[m-1],o=Rb._getPoint(g),g instanceof md&&(g=g._as),n=g instanceof Array?Rb._getControlPoint(g):Rb._getPoint(a[m-2]);var p=Math.atan2(o.y-n.y,o.x-n.x);h=Rb.transformPoint(o,p,c-k,d),h.angle=p,f=h}return f},reversePath:function(a){var b,c=new md,d=null;a._as&&(a=a._as);for(var e=a.length-1;e>=0;e--)b=a[e],c.add(Rb._getReversePath(b,d)),d=b;return c},_getPoint:function(a){return a._as&&(a=a._as),a instanceof Array?a[a.length-1]:a},_getControlPoint:function(a){return a._as&&(a=a._as),a instanceof Array?a[a.length-2]:a},_getReversePath:function(a,b){var c=Rb._getPoint(a);return b&&b._as&&(b=b._as),null!=b&&b instanceof Array?new md(2==b.length?[b[0],c]:[b[1],b[0],c]):c},_getLength:function(a,b){var c=Rb._getPoint(b),d=Rb._getPoint(a);if(a instanceof md&&(a=a._as),a instanceof Array)return Rb.calculateCurveLength(c,a,1);var e=d.y-c.y,f=d.x-c.x;return Math.sqrt(f*f+e*e)},getPathInfo:function(a,b,c,d,e){var f,g=Rb._getPoint(b),h=Rb._getPoint(a);if(a instanceof md&&(a=a._as),a instanceof Array){0>e&&(e=Rb._getLength(a,b));var i=c/e,j=Rb.calculatePointInfoOnCurveLine(g,a,i);g=j.point,f=j.angle,c=0}else f=Math.atan2(h.y-g.y,h.x-g.x);return Rb.transformPoint(g,f,c,d)},transformPoint:function(a,b,c,d){var e={x:c,y:d},f=Rb.createMatrix(b,0,0);return e=f.transform(e),e.x+=a.x,e.y+=a.y,{point:e,angle:b}},calculatePointInfoOnStraightLine:function(a,b,c,d){var e=Math.atan2(b.y-a.y,b.x-a.x);return Rb.transformPoint(a,e,c,d)},calculatePointInfoOnCurveLine:function(a,b,c){if(0>c||c>1)throw"Illegal arguments";return b._as&&(b=b._as),2==b.length?Rb._calculatePointInfoOnCurveLine2(a,b[0],b[1],c):Rb._calculatePointInfoOnCurveLine3(a,b[0],b[1],b[2],c)},_calculatePointInfoOnCurveLine2:function(a,b,c,d){var e=2*(a.x+c.x-2*b.x)*d+2*b.x-2*a.x,f=2*(a.y+c.y-2*b.y)*d+2*b.y-2*a.y,g=Math.atan2(f,e),h=(a.x+c.x-2*b.x)*d*d+(2*b.x-2*a.x)*d+a.x,i=(a.y+c.y-2*b.y)*d*d+(2*b.y-2*a.y)*d+a.y;return{point:{x:h,y:i},angle:g}},_calculatePointInfoOnCurveLine3:function(a,b,c,d,e){var f,g,h;f=1-e,g=f*f*f,h=e*e*e;var i=g*a.x+3*e*f*f*b.x+3*e*e*f*c.x+h*d.x,j=g*a.y+3*e*f*f*b.y+3*e*e*f*c.y+h*d.y;return{point:{x:i,y:j},angle:Math.atan2(Rb._bezeSpeedY(a,b,c,d,e),Rb._bezeSpeedX(a,b,c,d,e))}},calculateCurveLength:function(a,b,c){return b._as&&(b=b._as),2==b.length?Rb._calculateCurveLength(a,b[0],b[1],c):Rb._calculateBezierCurveLength(a,b[0],b[1],b[2],c)},_calculateCurveLength:function(a,b,c,d){if(0>=d||d>1)return 0;var e=Math.floor(d*(Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))+Math.sqrt((c.x-b.x)*(c.x-b.x)+(c.y-b.y)*(c.y-b.y)))/2),f=0;0>=e&&(e=1);for(var g,h,i=d/e,j=0,k=0;e>k;k++)j=i*k,g=2*(a.x+c.x-2*b.x)*j+2*b.x-2*a.x,h=2*(a.y+c.y-2*b.y)*j+2*b.y-2*a.y,g*=i,h*=i,f+=Math.sqrt(g*g+h*h);return f},_calculateBezierCurveLength:function(a,b,c,d,e){if(0>=e||e>1)return 0;var f=1e4,g=Math.floor(f*e);if(1==(1&g)&&g++,0==g)return 0;var h,i=Math.floor(g/2),j=0,k=0,l=e/g;for(h=0;i>h;h++)j+=Rb._bezeSpeed(a,b,c,d,(2*h+1)*l);for(h=1;i>h;h++)k+=Rb._bezeSpeed(a,b,c,d,2*h*l);return(Rb._bezeSpeed(a,b,c,d,0)+Rb._bezeSpeed(a,b,c,d,1)+2*k+4*j)*l/3},_bezeSpeedX:function(a,b,c,d,e){var f=1-e;return-3*a.x*f*f+3*b.x*f*f-6*b.x*f*e+6*c.x*f*e-3*c.x*e*e+3*d.x*e*e},_bezeSpeedY:function(a,b,c,d,e){var f=1-e;return-3*a.y*f*f+3*b.y*f*f-6*b.y*f*e+6*c.y*f*e-3*c.y*e*e+3*d.y*e*e},_bezeSpeed:function(a,b,c,d,e){var f=Rb._bezeSpeedX(a,b,c,d,e),g=Rb._bezeSpeedY(a,b,c,d,e);return Math.sqrt(f*f+g*g)},getPointObject:function(a,b){if(b&&0!=b.size()){var c=new md;b=b._as,a=a._as;var d,e,f=0,g=b.length,h=a.length;for(d=0;g>d&&(e=b[d],f!=h);d++)"cubicto"===e?h-2>f&&c.add([a[f++],a[f++],a[f++]]):"quadto"===e?h-1>f&&c.add([a[f++],a[f++]]):h>f&&c.add(a[f++]);for(;h>f;f++)c.add(a[f]);return c}return a},calculateLineLength:function(a,b){if(!a||a.size()<2)return 0;if(b)return Rb.calculateLineLength(Rb.getPointObject(a,b));a=a._as;var c,d,e,f,g,h,i,j=a.length,k=0;for(c=0;j>c;c++)f=a[c],0!=c?(e=f,e instanceof md&&(e=e._as),e instanceof Array?(g=Rb.calculateCurveLength(d,e,1),d=e[e.length-1]):(i=f.y-d.y,h=f.x-d.x,g=Math.sqrt(h*h+i*i),d=e),k+=g):d=f;return k},toDegrees:function(a){return 180*a/Math.PI},toRadians:function(a){return a/180*Math.PI},getRadiansBetweenLines:function(a,b){return Math.atan2(b.y-a.y,b.x-a.x)},getAngle:function(a,b){return a.x===b.x?b.y===a.y?0:b.y>a.y?Math.PI/2:-Math.PI/2:Math.atan((b.y-a.y)/(b.x-a.x))}};Hb.math=Rb;var Sb={getPoints:function(a){var b=new md;return a.forEach(function(a){b.add({x:a.x,y:a.y}),b.add({x:a.x+a.width,y:a.y+a.height}),b.add({x:a.x+a.width,y:a.y}),b.add({x:a.x,y:a.y+a.height})}),b},rectangle:function(a){var b;return a.forEach(function(a){b=Rb.unionRect(b,a)}),b},oval:function(a){var b=Sb.rectangle(a),c=0,d=b.height/b.width,e=d*d,f=b.x+b.width/2,g=b.y+b.height/2,h=Sb.getPoints(a);h.forEach(function(a){var b=a.x-f,d=a.y-g,h=b*b+d*d/e;h>c&&(c=h)}),c=Math.sqrt(c);var i=d*c;return{x:f-c,y:g-i,width:2*c,height:2*i}},circle:function(a){var b=Sb.rectangle(a),c=0,d=b.x+b.width/2,e=b.y+b.height/2,f=Sb.getPoints(a);return f.forEach(function(a){var b=a.x-d,f=a.y-e,g=b*b+f*f;g>c&&(c=g)}),c=Math.sqrt(c),{x:d-c,y:e-c,width:2*c,height:2*c}},roundrect:function(a){var b=Sb.rectangle(a),c=Math.min(b.width,b.height)/16;return Rb.grow(b,c,c),b},star:function(a){var b=Sb.rectangle(a);return Rb.grow(b,b.width,b.height),b},triangle:function(a){var b=Sb.rectangle(a);return b.x-=b.width/2,b.width*=2,b.y-=b.height,b.height*=2,b},hexagon:function(a){var b=Sb.rectangle(a);return b.x-=b.width/2,b.width*=2,b},pentagon:function(a){var b=Sb.rectangle(a);return b.x-=b.width/6,b.width+=b.width/3,b.y-=b.height/4,b.height+=b.height/4,b},diamond:function(a){var b=Sb.rectangle(a);return b.x-=b.width/2,b.width+=b.width,b.y-=b.height/2,b.height+=b.height,b},trapezoidal:function(a){var b=Sb.rectangle(a);return b.x-=b.width/2,b.width+=b.width,b.y-=b.height/2,b.height+=b.height,b}};Hb.group=Sb;var Tb={"topleft.topleft":function(a,b){return{x:a.x-b.width,y:a.y-b.height}},"topleft.topright":function(a,b){return{x:a.x,y:a.y-b.height}},"top.top":function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y-b.height}},"topright.topleft":function(a,b){return{x:a.x+a.width-b.width,y:a.y-b.height}},"topright.topright":function(a,b){return{x:a.x+a.width,y:a.y-b.height}},topleft:function(a,b){return{x:a.x-b.width/2,y:a.y-b.height/2}},top:function(a,b){return{x:a.x-b.width/2+a.width/2,y:a.y-b.height/2}},topright:function(a,b){return{x:a.x-b.width/2+a.width,y:a.y-b.height/2}},"topleft.bottomleft":function(a,b){return{x:a.x-b.width,y:a.y}},"topleft.bottomright":function(a,b){return{x:a.x,y:a.y}},"top.bottom":function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y}},"topright.bottomleft":function(a,b){return{x:a.x-b.width+a.width,y:a.y}},"topright.bottomright":function(a,b){return{x:a.x+a.width,y:a.y}},"left.left":function(a,b){return{x:a.x-b.width,y:a.y+a.height/2-b.height/2}},left:function(a,b){return{x:a.x-b.width/2,y:a.y+a.height/2-b.height/2}},"left.right":function(a,b){return{x:a.x,y:a.y+a.height/2-b.height/2}},center:function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y+a.height/2-b.height/2}},"right.left":function(a,b){return{x:a.x+a.width-b.width,y:a.y+a.height/2-b.height/2}},right:function(a,b){return{x:a.x+a.width-b.width/2,y:a.y+a.height/2-b.height/2}},"right.right":function(a,b){return{x:a.x+a.width,y:a.y+a.height/2-b.height/2}},"bottomleft.topleft":function(a,b){return{x:a.x-b.width,y:a.y+a.height-b.height}},"bottomleft.topright":function(a,b){return{x:a.x,y:a.y+a.height-b.height}},"bottom.top":function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y+a.height-b.height}},"bottomright.topleft":function(a,b){return{x:a.x+a.width-b.width,y:a.y+a.height-b.height}},"bottomright.topright":function(a,b){return{x:a.x+a.width,y:a.y+a.height-b.height}},bottomleft:function(a,b){return{x:a.x-b.width/2,y:a.y+a.height-b.height/2}},bottom:function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y+a.height-b.height/2}},bottomright:function(a,b){return{x:a.x+a.width-b.width/2,y:a.y+a.height-b.height/2}},"bottomleft.bottomleft":function(a,b){return{x:a.x-b.width,y:a.y+a.height}},"bottomleft.bottomright":function(a,b){return{x:a.x,y:a.y+a.height}},"bottom.bottom":function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y+a.height}},"bottomright.bottomleft":function(a,b){return{x:a.x+a.width-b.width,y:a.y+a.height}},"bottomright.bottomright":function(a,b){return{x:a.x+a.width,y:a.y+a.height}},get:function(a,b,c){if(!b)throw"refRect can not be null";c||(c={width:0,height:0});var d=Tb[a];if(d)return d(b,c);throw"Can not resolve '"+a+"' position"}};Hb.position=Tb;var Ub={preventDefault:function(a){Dd.KEEP_DEFAULT_FUNCTION(a)||(a.preventDefault?a.preventDefault():a.preventManipulation?a.preventManipulation():a.returnValue=!1)},insertAfter:function(a,b){return b?b.parentNode.insertBefore(a,b.nextSibling):a.parentNode.insertBefore(a,a.parentNode.firstChild),a},forEach:function(a,b,c){if(Ub.isVisible(a)){for(var d=a.childNodes.length,e=0;d>e;e++)Ub.forEach(a.childNodes[e],b,c);c?b.call(c,a):b(a)}},setVisible:function(a,b){a.style.display=b?"block":"none"},isVisible:function(a){return"style"in a&&"none"!==a.style.display},release:function(a){for(var b=a.childNodes.length,c=0;b>c;c++)Ub.release(a.childNodes[c]);b>0&&Ub.clear(a),a._pool&&a._pool.release(a)},clear:function(a){for(;a.firstChild;)a.removeChild(a.firstChild)},setZoom:function(a,b){var c=a.style;if(c.setProperty)if(Ob.isFirefox)c.setProperty("-moz-transform","scale("+b+")",null),c.setProperty("-moz-transform-origin","0 0",null);else if(Ob.isOpera)c.setProperty("-o-transform","scale("+b+")",null),c.setProperty("-o-transform-origin","0 0",null);else if(Ob.isChrome||Ob.isSafari){c.setProperty("-webkit-transform","scale("+b+")",null),c.setProperty("-webkit-transform-origin","0 0",null);var d=null;a._webkitInvaildateDiv?d=a._webkitInvaildateDiv:(d=Mb.createElement("div"),a._webkitInvaildateDiv=d),d.parentNode&&d.parentNode==a?a.removeChild(d):a.appendChild(d)}else Ob.isIE?(c.setProperty("-ms-transform","scale("+b+")",null),c.setProperty("-ms-transform-origin","0 0",null)):(c.setProperty("transform","scale("+b+")",null),c.setProperty("transform-origin","0 0",null))},setRotate:function(a,b){var c=a.style;if(c.setProperty)if(Ob.isFirefox)c.setProperty("-moz-transform","scale("+b+")",null),c.setProperty("-moz-transform-origin","0 0",null);else if(Ob.isOpera)c.setProperty("-o-transform","scale("+b+")",null),c.setProperty("-o-transform-origin","0 0",null);else if(Ob.isChrome||Ob.isSafari){c.setProperty("-webkit-transform","scale("+b+")",null),c.setProperty("-webkit-transform-origin","0 0",null);var d=null;a._webkitInvaildateDiv?d=a._webkitInvaildateDiv:(d=Mb.createElement("div"),a._webkitInvaildateDiv=d),d.parentNode&&d.parentNode==a?a.removeChild(d):a.appendChild(d)}else Ob.isIE?(c.setProperty("-ms-transform","scale("+b+")",null),c.setProperty("-ms-transform-origin","0 0",null)):(c.setProperty("transform","scale("+b+")",null),c.setProperty("transform-origin","0 0",null))},setCSSStyle:function(a,b,c){a.style.setProperty(b,c,null)},removeCSSStyle:function(a,b){a.style.removeProperty(b)},getCSSStyle:function(a,b){return a.style.getPropertyValue(b)},setBorderRaidus:function(a,b){Ob.isFirefox?a.style.MozBorderRadius=b:a.style.borderRadius=b},createSelect:function(a,b){var c,d,e,f=Mb.createElement("select");if(Array.isArray(a))for(c=0;c<a.length;c++)d=a[c],e=Mb.createElement("option"),e.innerHTML=d,e.setAttribute("value",d),d===b&&e.setAttribute("selected","true"),f.appendChild(e);else for(c=0;c<a.values.length;c++)d=a.values[c],e=Mb.createElement("option"),e.innerHTML=a.map[d],e.setAttribute("value",d),d===b&&e.setAttribute("selected","true"),f.appendChild(e);return f},createImg:function(a){var b=Mb.createElement("img");return b.style.position="absolute","string"==typeof a&&b.setAttribute("src",a),b},createView:function(a,b){var c=Mb.createElement("div");return c.style.position=Dd.VIEW_POSITION,c.style.fontSize=Dd.VIEW_FONT_SIZE,c.style.fontFamily=Dd.VIEW_FONT_FAMILY,c.style.cursor="default",c.style.outline="none",c.style.textAlign="left",c.style.msTouchAction="none",c.style.touchAction="none",c.tabIndex=0,b||(c.onmousedown=Ub.preventDefault),c.style.setProperty&&(c.style.setProperty("-khtml-user-select","none",null),c.style.setProperty("-webkit-user-select","none",null),c.style.setProperty("-moz-user-select","none",null),c.style.setProperty("-webkit-tap-highlight-color","rgba(0, 0, 0, 0)",null)),a&&(c.style.overflow=a),c},createDiv:function(){var a=Mb.createElement("div");return a.style.position="absolute",a.style.msTouchAction="none",a.style.touchAction="none",a},createCanvas:function(a,b){if(a=a||0,b=b||0,Kb)return new Jb(a,b);var c=Mb.createElement("canvas");return c.style.position="absolute",c.style.msTouchAction="none",c.style.touchAction="none",c.width=a,c.height=b,c},setCanvas:function(a,b,c,d,e){2===arguments.length&&(c=b.y,d=b.width,e=b.height,b=b.x),a.style.left=b+"px",a.style.top=c+"px",a.setAttribute("width",d),a.setAttribute("height",e),a._viewRect={x:b,y:c,width:d,height:e};var f=a.getContext("2d");return 0!==f.shadowBlur&&(f.shadowOffsetX=0,f.shadowOffsetY=0,f.shadowBlur=0,f.shadowColor="rgba(0,0,0,0.0)"),f.clearRect(0,0,d,e),f.translate(-b,-c),f},setImg:function(a,b,c){a.setAttribute("src",b),a.style.left=c.x+"px",a.style.top=c.y+"px",a.style.width=c.width+"px",a.style.height=c.height+"px",a._viewRect=Hb.clone(c)},setDiv:function(a,b,c,d,e){d=Hb.num(d)?d:0,a.style.left=b.x-d+"px",a.style.top=b.y-d+"px",a.style.width=b.width+"px",a.style.height=b.height+"px",a._viewRect=Hb.clone(b),a.style.backgroundColor=c?c:"",a.style.border=d>0?d+"px "+e+" solid":""},changeTypeForMS:function(a){var b=a;if(0===a.indexOf("MSPointer")||0===a.indexOf("pointer")){var c;0===a.indexOf("MSPointer")?(c=a.substring(9,10).toLowerCase(),c+=a.substring(10)):c=a.substring(7,8),window.MSPointerEvent?b="MSPointer"+c.substring(0,1).toUpperCase()+c.substring(1):window.PointerEvent&&(b="pointer"+c)}return b},addEventListener:function(a,b,c,d){a=this.changeTypeForMS(a);var e="_"+a+"_";if(!d[e]){var f=function(a){f.instance[f.method](a)};f.method=b,f.instance=d,d[e]=f,c.addEventListener(a,f,!1)}},removeEventListener:function(a,b,c){a=this.changeTypeForMS(a);var d="_"+a+"_",e=c[d];e&&(b.removeEventListener(a,e,!1),delete c[d])},isValidEvent:function(a,b){if(!b)return!1;if(b.target===a)if(Ob.isFirefox){if(a.clientHeight<a.scrollHeight&&b.layerX<25)return!1;if(a.clientWidth<a.scrollWidth&&b.layerY<25)return!1}else if(b.offsetX>a.clientWidth||b.offsetY>a.clientHeight)return!1;return!0},getLogicalPoint:function(a,b,c,d){c=c?c:1;var e,f=a.getBoundingClientRect();if(Ob.isTouchable&&b.changedTouches&&b.changedTouches.length>0){var g=b.changedTouches[0],h=Ob.isAndroid?0:yc.scrollLeft(),i=Ob.isAndroid?0:yc.scrollTop();e={x:(g.clientX+a.scrollLeft-f.left-h)/c,y:(g.clientY+a.scrollTop-f.top-i)/c}}else{if(!Ub.isValidEvent(a,b))return null;e={x:(b.clientX-f.left+a.scrollLeft)/c,y:(b.clientY-f.top+a.scrollTop)/c}}return e},handle_mousedown:function(a,b){Ub.target&&Ub.handle_mouseup(b),window.addEventListener("mousemove",Ub.handle_mousemove,!1),window.addEventListener("mouseup",Ub.handle_mouseup,!1),Ub.target=a},handle_mousemove:function(a){Ub.target.handle_mousemove&&Ub.target.handle_mousemove(a),Ub.target.handleMouseMove&&Ub.target.handleMouseMove(a)},handle_mouseup:function(a){Ub.target.handle_mouseup&&Ub.target.handle_mouseup(a),Ub.target.handleMouseUp&&Ub.target.handleMouseUp(a),window.removeEventListener("mousemove",Ub.handle_mousemove,!1),window.removeEventListener("mouseup",Ub.handle_mouseup,!1),delete Ub.target},getClientPoint:function(a){return{x:a.clientX,y:a.clientY}},windowWidth:function(){return"number"==typeof window.innerWidth?window.innerWidth:Mb.documentElement&&Mb.documentElement.clientWidth?Mb.documentElement.clientWidth:Mb.body&&Mb.body.clientWidth?Mb.body.clientWidth:0},windowHeight:function(){return"number"==typeof window.innerHeight?window.innerHeight:Mb.documentElement&&Mb.documentElement.clientHeight?Mb.documentElement.clientHeight:Mb.body&&Mb.body.clientHeight?Mb.body.clientHeight:0}};Hb.html=Ub;var Vb={cache:{},g:Ub.createCanvas().getContext("2d"),getTextSize:function(a,b){Vb.g.font=a?a:Dd.FONT;var c=Vb.cache[Vb.g.font];c||(c=2*Vb.g.measureText("e").width+4,Vb.cache[Vb.g.font]=c),b=b||"",b=String(b);for(var d,e=b.split("\n"),f=e.length,g=0,h=f-1;h>=0;h--)d=Vb.g.measureText(e[h]).width,d>g&&(g=d);return{width:g+4,height:c*f}},getSubStringInLength:function(a,b,c){var d=this,e=function(a,b,c,f,g){if(a>=b)return f.substring(0,a+1);var h=Math.floor((a+b)/2),i=f.substring(0,h+1),j=d.getTextSize(c,i).width;if(j>g)return e(a,h-1,c,f,g);var k=h+1,l=f.substring(0,k+1),m=d.getTextSize(c,l).width;return m>g?i:e(k,b,c,f,g)},f=this.getTextSize(a,b).width;return f>c?e(0,b.length-1,a,b,c):b},getCollapseTextInLength:function(a,b,c){var d=this.getTextSize(a,b).width;if(d>c){for(var e=0,f="",g=b,h=d;h>c;){var i=this.getSubStringInLength(a,g,c);f=f+i+"\n",e+=i.length,g=b.substring(e),h=this.getTextSize(a,g).width}return f+g}return b},drawText:function(a,b,c,d,e,f){b=b||"",b=String(b),d||(d=Dd.FONT);var g="center";f&&(g=f),a.font=d,a.fillStyle=e,a.textAlign=g,a.textBaseline="middle";var h,i,j=b.split("\n"),k=j.length,l=0;c?void 0===c.width?(h=c.x,i=c.y):(l=c.height/k,"left"==g?h=c.x:"center"==g&&(h=c.x+c.width/2),i=c.y+l/2):(h=0,i=0),Ob.isOpera&&(i-=2);for(var m=0;k>m;m++)"right"==g&&(a.textAlign="left",h=c.x+c.width-Vb.getTextSize(d,j[m]).width),a.fillText(j[m],h,i),i+=l},drawArc:function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s;if(Math.abs(e)>2*Math.PI&&(e=2*Math.PI),m=Math.ceil(Math.abs(e)/(Math.PI/4)),i=e/m,j=-i,k=-d,m>0){n=b+Math.cos(d)*f,o=c+Math.sin(-d)*g,h?a.lineTo(n,o):a.moveTo(n,o);for(var t=0;m>t;t++)k+=j,l=k-j/2,p=b+Math.cos(k)*f,q=c+Math.sin(k)*g,r=b+Math.cos(l)*(f/Math.cos(j/2)),s=c+Math.sin(l)*(g/Math.cos(j/2)),a.quadraticCurveTo(r,s,p,q)}},dashedLine:function(a,b,c,d,e,f,g){var h=f-d,i=g-e,j=Math.sqrt(h*h+i*i);if(0!=j){h/=j,i/=j;for(var k=j,l=-c.offset,m=c.drawing,n=c.patternIndex;k>l;)l+=b[n],l>=k&&(c.offset=b[n]-(l-k),c.patternIndex=n,c.drawing=m,l=k),m?a.lineTo(d+l*h,e+l*i):a.moveTo(d+l*h,e+l*i),m=!m,n=(n+1)%b.length}},drawLinePoints:function(a,b,c,d,e){var f,g,h,i,j,k,l=0,m=0,n=b.size();if(k=c&&c.length>0?new tc(a,c[0],c.length>1?c[1]:c[0]):a,d)for(m=0,j=d.size();j>m;m++)if(f=d.get(m),"moveto"===f&&n>l)g=b.get(l++),k.moveTo(g.x,g.y);else if("lineto"===f&&n>l)g=b.get(l++),k.lineTo(g.x,g.y);else if("cubicto"===f&&n-2>l)g=b.get(l++),h=b.get(l++),i=b.get(l++),k.bezierCurveTo(g.x,g.y,h.x,h.y,i.x,i.y);else{if(!("quadto"===f&&n-1>l))throw"Can not resolve segment '"+f+"'";g=b.get(l++),h=b.get(l++),k.quadraticCurveTo(g.x,g.y,h.x,h.y)}else this._drawLine(b,k);e&&k.closePath()},_drawLine:function(a,b){var c,d,e,f,g,h=0,i=a.size();for(c=a.get(0),b.moveTo(c.x,c.y),h=1;i>h;h++)g=a.get(h),g.size?(f=g.size(),2===f?(c=g.get(0),d=g.get(1),b.quadraticCurveTo(c.x,c.y,d.x,d.y)):3===f&&(c=g.get(0),d=g.get(1),e=g.get(2),b.bezierCurveTo(c.x,c.y,d.x,d.y,e.x,e.y))):b.lineTo(g.x,g.y)},drawRoundRect:function(a,b,c,d,e,f,g,h,i){6===arguments.length&&(g=f,h=f,i=f);var j=b+d,k=c+e,l=e>d?2*d:2*e;f=l>f?f:l,g=l>g?g:l,h=l>h?h:l,i=l>i?i:l;var m=.292893218813453*i,n=.585786437626905*i;a.moveTo(j,k-i),a.quadraticCurveTo(j,k-n,j-m,k-m),a.quadraticCurveTo(j-n,k,j-i,k),m=.292893218813453*h,n=.585786437626905*h,a.lineTo(b+h,k),a.quadraticCurveTo(b+n,k,b+m,k-m),a.quadraticCurveTo(b,k-n,b,k-h),m=.292893218813453*f,n=.585786437626905*f,a.lineTo(b,c+f),a.quadraticCurveTo(b,c+n,b+m,c+m),a.quadraticCurveTo(b+n,c,b+f,c),m=.292893218813453*g,n=.585786437626905*g,a.lineTo(j-g,c),a.quadraticCurveTo(j-n,c,j-m,c+m),a.quadraticCurveTo(j,c+n,j,c+g),a.lineTo(j,k-i)},drawVector:function(a,b,c,d,e,f,g){var h;4===arguments.length?(e=d.y,f=d.width,g=d.height,d=d.x):5===arguments.length&&"roundrect"===b&&(h={},h.topLeft=e,h.topRight=e,h.bottomLeft=e,h.bottomRight=e,e=d.y,f=d.width,g=d.height,d=d.x);var i=Vb["_"+b];i&&(a.beginPath(),c&&c.length>0&&(a=new tc(a,c[0],c.length>1?c[1]:c[0])),5===arguments.length&&"roundrect"===b?i(a,{x:d,y:e,width:f,height:g},h):i(a,d,e,f,g))},_rectangle:function(a,b,c,d,e){a.rect(b,c,d,e)},_circle:function(a,b,c,d,e){var f=b+d/2,g=c+e/2,h=Math.min(d,e)/2;a instanceof tc?Vb.drawArc(a,f,g,0,2*Math.PI,h,h,!1):a.arc(f,g,h,0,2*Math.PI,!0)},_oval:function(a,b,c,d,e){if(a instanceof tc)Vb.drawArc(a,b+d/2,c+e/2,0,2*Math.PI,d/2,e/2,!1);else{var f=.5522848,g=d/2*f,h=e/2*f,i=b+d,j=c+e,k=b+d/2,l=c+e/2;a.moveTo(b,l),a.bezierCurveTo(b,l-h,k-g,c,k,c),a.bezierCurveTo(k+g,c,i,l-h,i,l),a.bezierCurveTo(i,l+h,k+g,j,k,j),a.bezierCurveTo(k-g,j,b,l+h,b,l)}},_roundrect:function(a,b,c,d,e){if(3===arguments.length){var f=c;c=b.y,d=b.width,e=b.height,b=b.x,f.topLeft?Vb.drawRoundRect(a,b,c,d,e,f.topLeft):Vb.drawRoundRect(a,b,c,d,e,Math.min(Math.min(d,e)/4,10))}else Vb.drawRoundRect(a,b,c,d,e,Math.min(Math.min(d,e)/4,10))},_star:function(a,b,c,d,e){var f=2*d,g=2*e,h=b+d/2,i=c+e/2;a.moveTo(h-f/4,i-g/12),a.lineTo(b+.306*d,c+.579*e),a.lineTo(h-f/6,i+g/4),a.lineTo(b+d/2,c+.733*e),a.lineTo(h+f/6,i+g/4),a.lineTo(b+.693*d,c+.579*e),a.lineTo(h+f/4,i-g/12),a.lineTo(b+.611*d,c+.332*e),a.lineTo(h+0,i-g/4),a.lineTo(b+.388*d,c+.332*e),a.closePath()},_triangle:function(a,b,c,d,e){a.moveTo(b+d/2,c),a.lineTo(b+d,c+e),a.lineTo(b,c+e),a.closePath()},_hexagon:function(a,b,c,d,e){a.moveTo(b,c+e/2),a.lineTo(b+d/4,c+e),a.lineTo(b+3*d/4,+c+e),a.lineTo(b+d,c+e/2),a.lineTo(b+3*d/4,c),a.lineTo(b+d/4,c),a.closePath()},_pentagon:function(a,b,c,d,e){var f=2*d,g=2*e,h=b+d/2,i=c+e/2;a.moveTo(h-f/4,i-g/12),a.lineTo(h-f/6,i+g/4),a.lineTo(h+f/6,i+g/4),a.lineTo(h+f/4,i-g/12),a.lineTo(h+0,i-g/4),a.closePath()},_trapezoidal:function(a,b,c,d,e){a.moveTo(b+d/4,c),a.lineTo(b,c+e),a.lineTo(b+d,c+e),a.lineTo(b+3*d/4,c),a.closePath()},_diamond:function(a,b,c,d,e){a.moveTo(b+d/2,c),a.lineTo(b,c+e/2),a.lineTo(b+d/2,c+e),a.lineTo(b+d,c+e/2),a.closePath()},fill:function(a,b,c,d,e,f,g,h){var i=Wb[c];a.fillStyle=i?5===arguments.length?i(a,b,d,e.x,e.y,e.width,e.height):i(a,b,d,e,f,g,h):b},createRadialGradient:function(a,b,c,d,e,f,g,h,i){var j=a.createRadialGradient(d+f*h,e+g*i,Math.min(f,g)/24,d+f/2,e+g/2,Math.max(f,g)/2);return j.addColorStop(0,c),j.addColorStop(1,b),j},drawPath:function(a,b,c,d,e,f,g,h){var i=a._element,j=a.getBodyRect();d&&Rb.addPadding(j,i,c+".padding",1);var k=Hb.clone(j),l=i.getStyle(c+".outline.width");l>0&&Rb.grow(k,l/2,l/2);var m=a.setShadow(a,b,k);0!=i.getAngle()&&(i instanceof Nd||(j=i.getOriginalRect()),Gb.Util.rotateCanvas(m,j,i.getAngle()));var n,o=i.getStyle(c+".fill");if(o){n=a._innerColor&&!uc.hasDefault(a._element)?a._innerColor:i.getStyle(c+".fill.color");var p=i.getStyle(c+".gradient");p?Vb.fill(m,n,p,i.getStyle(c+".gradient.color"),j):m.fillStyle=n}var q=i.getStyle(c+".shape"),r=i.getStyle("group.shape.roundrect.radius");return o&&(m.beginPath(),f?Vb.drawLinePoints(m,f,null,g,h):"roundrect"===q&&"group"===c?Vb.drawVector(m,q,null,j,r):Vb.drawVector(m,q,null,j),m.fill()),l>0&&(m.lineWidth=l,m.lineCap=i.getStyle(c+".cap"),m.lineJoin=i.getStyle(c+".join"),m.strokeStyle=i.getStyle(c+".outline.color"),m.beginPath(),f?Vb.drawLinePoints(m,f,e,g,h):"roundrect"===q&&"group"===c?Vb.drawVector(m,q,e,j,r):Vb.drawVector(m,q,e,j),m.stroke()),k},draw3DRect:function(a,b,c,d,e,f,g){if(0!==c){arguments.length<=4&&(g=d.height,f=d.width,e=d.y,d=d.x);var h=c>0;c=Math.abs(c);var i,j;if(a.lineWidth=1,a.lineCap="square",1===c)i=Vb.brighter(b),j=Vb.darker(b),a.strokeStyle=h?i:j,a.beginPath(),a.moveTo(d,e),a.lineTo(d,e+g),a.moveTo(d,e),a.lineTo(d+f,e),a.closePath(),a.stroke(),a.strokeStyle=h?j:i,a.beginPath(),a.moveTo(d,e+g),a.lineTo(d+f,e+g),a.moveTo(d+f,e),a.lineTo(d+f,e+g),a.closePath(),a.stroke();else for(var k=2*c,l=50/k,m=0;k>m;m++)i=Vb.brighter(b,50-m*l),j=Vb.darker(b,50-m*l),d+=.5,e+=.5,f-=1,g-=1,a.strokeStyle=h?i:j,a.beginPath(),a.moveTo(d,e),a.lineTo(d,e+g),a.moveTo(d,e),a.lineTo(d+f,e),a.closePath(),a.stroke(),a.strokeStyle=h?j:i,a.beginPath(),a.moveTo(d,e+g),a.lineTo(d+f,e+g),a.moveTo(d+f,e),a.lineTo(d+f,e+g),a.closePath(),a.stroke()}},brighter:function(a,b){return b||(b=50),Vb.adjustBrightness2(a,b)},darker:function(a,b){return b||(b=50),Vb.adjustBrightness2(a,-b)},adjustBrightness2:function(a,b){var c,d,e;

if(0===b)return a;var f=rd(a);return 0>b?(b=(100+b)/100,c=Math.ceil(f.r*b),d=Math.ceil(f.g*b),e=Math.ceil(f.b*b)):(b/=100,c=f.r,d=f.g,e=f.b,c+=(255-c)*b,d+=(255-d)*b,e+=(255-e)*b,c=Math.min(Math.ceil(c),255),d=Math.min(Math.ceil(d),255),e=Math.min(Math.ceil(e),255)),"rgba("+c+","+d+","+e+",1)"},getColorArray:function(a){return qd.clearRect(0,0,1,1),qd.fillStyle=a,qd.fillRect(0,0,1,1),qd.getImageData(0,0,1,1).data},hit:function(a,b,c,d){if(!a)return!1;var e=a._viewRect;if(!e)return!1;if(b-=e.x,c-=e.y,0>b||0>c||b>=e.width||c>=e.height)return!1;try{for(var f=a.getContext("2d").getImageData(b,c,1,1),g=f.data,h=0,i=g.length;i>h;h+=4)if(0!==g[h+3])return!0}catch(j){return!0}return!1},intersects:function(a,b){if(!a)return!1;if(b=Rb.intersection(b,a._viewRect),!b)return!1;b.x-=a._viewRect.x,b.y-=a._viewRect.y;try{for(var c=a.getContext("2d").getImageData(b.x,b.y,b.width,b.height),d=c.data,e=0,f=d.length;f>e;e+=4)if(0!==d[e+3])return!0}catch(g){}return!1},strokeRect:function(a,b,c,d){b&&(a.beginPath(),a.strokeStyle=c?c:Gb.Util.randomColor(),a.lineWidth=d?d:2,a.strokeRect(b.x,b.y,b.width,b.height),a.stroke())}};Hb.g=Vb;var Wb={"linear.southwest":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e+g,d+f,e);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.southeast":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d+f,e+g,d,e);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.northwest":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d+f,e+g,d,e);return h.addColorStop(0,b),h.addColorStop(1,c),h},"linear.northeast":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d+f,e,d,e+g);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.north":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d,e+g);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.south":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d,e+g);return h.addColorStop(0,b),h.addColorStop(1,c),h},"linear.west":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d+f,e);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.east":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d+f,e);return h.addColorStop(0,b),h.addColorStop(1,c),h},"radial.center":function(a,b,c,d,e,f,g){return Vb.createRadialGradient(a,b,c,d,e,f,g,.5,.5)},"radial.southwest":function(a,b,c,d,e,f,g){return Vb.createRadialGradient(a,b,c,d,e,f,g,.25,.75)},"radial.southeast":function(a,b,c,d,e,f,g){return Vb.createRadialGradient(a,b,c,d,e,f,g,.75,.75)},"radial.northwest":function(a,b,c,d,e,f,g){return Vb.createRadialGradient(a,b,c,d,e,f,g,.25,.25)},"radial.northeast":function(a,b,c,d,e,f,g){return Vb.createRadialGradient(a,b,c,d,e,f,g,.75,.25)},"radial.north":function(a,b,c,d,e,f,g){return Vb.createRadialGradient(a,b,c,d,e,f,g,.5,.25)},"radial.south":function(a,b,c,d,e,f,g){return Vb.createRadialGradient(a,b,c,d,e,f,g,.5,.75)},"radial.west":function(a,b,c,d,e,f,g){return Vb.createRadialGradient(a,b,c,d,e,f,g,.25,.5)},"radial.east":function(a,b,c,d,e,f,g){return Vb.createRadialGradient(a,b,c,d,e,f,g,.75,.5)},"spread.horizontal":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d+f,e);return h.addColorStop(0,b),h.addColorStop(.5,c),h.addColorStop(1,b),h},"spread.vertical":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d,e+g);return h.addColorStop(0,b),h.addColorStop(.5,c),h.addColorStop(1,b),h},"spread.diagonal":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d+f,e,d,e+g);return h.addColorStop(0,b),h.addColorStop(.5,c),h.addColorStop(1,b),h},"spread.antidiagonal":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d+f,e+g);return h.addColorStop(0,b),h.addColorStop(.5,c),h.addColorStop(1,b),h},"spread.north":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e-g/4,d,e+g+g/4);return h.addColorStop(0,b),h.addColorStop(1/3,c),h.addColorStop(2/3,b),h.addColorStop(1,c),h},"spread.south":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e-g/4,d,e+g+g/4);return h.addColorStop(0,c),h.addColorStop(1/3,b),h.addColorStop(2/3,c),h.addColorStop(1,b),h},"spread.west":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d-f/4,e,d+f+f/4,e);return h.addColorStop(0,b),h.addColorStop(1/3,c),h.addColorStop(2/3,b),h.addColorStop(1,c),h},"spread.east":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d-f/4,e,d+f+f/4,e);return h.addColorStop(0,c),h.addColorStop(1/3,b),h.addColorStop(2/3,c),h.addColorStop(1,b),h}};Gb.Util={getVersion:function(){return"5.7.5"},registerImage:function(a,b,c,d,e){Hb.registerImage(a,b,c,d,e)},registerImageByUrl:function(a,b,c,d){if(b&&a&&a.indexOf(".json")>0){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var a=JSON.parse(e.responseText);Gb.Util.registerImage(b,a),c&&c.invalidateElementUIs(),d&&d()}},e.open("GET",a,!0),e.send()}else{var f=new Nb;f.src=a,f.onload=function(){Gb.Util.registerImage(b,f,f.width,f.height),f.onload=null,c&&c.invalidateElementUIs(),d&&d()}}},getRegisteredImageNames:function(){return Hb.getRegisteredImageNames()},unregisterImage:function(a){Hb.unregisterImage(a)},getImageAsset:function(a){return Hb.getImageAsset(a)},validateLicense:function(a){Hb.validateLicense(a)},getLicense:function(){return Ib},isPermissionGIS:function(){return sc()},moveElements:function(a,b,c,d,e,f){if((0!==b||0!==c)&&a&&!a.isEmpty()){var g,h,i=Gb.animate.AnimateManager;i.endAnimate(),a=uc.filterMovingElements(a),d&&(g=new md,h=new md),a.forEach(function(a){a instanceof Ld&&(d?(g.add(a),h.add({x:a.getX()+b,y:a.getY()+c})):a.translate(b,c))}),d?i.start(new Gb.animate.AnimateLocation(g,h,e)):e&&e()}},isTypeOf:function(a,b){if(a===b)return!0;for(var c=a.superClass;c;){if(c===b.prototype)return!0;c=c.constructor.superClass}return!1},setFocus:function(a){if(Mb.activeElement!==a){var b,c,d,e=Mb.documentElement,f=Mb.body;e&&(Ob.isIE||Ob.isOpera||e.scrollLeft||e.scrollTop)?(b=e.scrollLeft,c=e.scrollTop,d=e):f&&(b=f.scrollLeft,c=f.scrollTop,d=f),a.focus(),d&&(d.scrollLeft=b,d.scrollTop=c)}},isOpera:Ob.isOpera,isIE:Ob.isIE,isFirefox:Ob.isFirefox,isChrome:Ob.isChrome,isSafari:Ob.isSafari,isIPhone:Ob.isIPhone,isIPod:Ob.isIPod,isIPad:Ob.isIPad,isAndroid:Ob.isAndroid,isWebOS:Ob.isWebOS,isTouchable:Ob.isTouchable,ext:function(a,b,c){Hb.ext(a,b,c)},getValue:function(a,b,c){return Hb.getValue(a,b,c)},setValue:function(a,b,c){Hb.setValue(a,b,c)},grow:function(a,b,c){Rb.grow(a,b,c)},containsPoint:function(a,b,c){return Rb.containsPoint.apply(null,arguments)},intersects:function(a,b){return Rb.intersects(a,b)},getRect:function(a){return Rb.getRect(a)},unionRect:function(a,b){return Rb.unionRect(a,b)},createDiv:function(){return Ub.createDiv()},createCanvas:function(){return Ub.createCanvas()},setCanvas:function(a,b,c,d,e){return Ub.setCanvas.apply(null,arguments)},drawVector:function(a,b,c,d,e,f,g){Vb.drawVector.apply(null,arguments)},fill:function(a,b,c,d,e,f,g,h){Vb.fill.apply(null,arguments)},getClass:function(a){return Hb.getClass(a)},getAllClassNames:function(){var a,b=[];for(a in Hb.classCache)b.push(a);return b},newInstance:function(a){return Hb.newInstance.apply(null,arguments)},isDeserializing:function(){return Hb.isDeserializing},addEventListener:function(a,b,c,d){Ub.addEventListener(a,b,c,d)},removeEventListener:function(a,b,c){Ub.removeEventListener(a,b,c)},drawArrow:function(a,b,c,d,e,f,g,h,i,j,k,l,m){nd.drawArrow.apply(null,arguments)},calculatePointAngleAlongLine:function(a,b,c,d,e){return Rb.calculatePointInfoAlongLineBySegments(a,b,c,d,e)},getSubNetwork:function(a){return uc.getSubNetwork(a)},transformPoint:function(a,b,c,d){return Rb.transformPoint(a,b,c,d)},getToolTipDiv:function(){return Ac.getToolTipDiv()},showToolTip:function(a,b){Ac.showToolTip(a,b)},hideToolTip:function(){Ac.hideToolTip()},resetToolTip:function(){Ac.resetToolTip()},setCSSStyle:function(a,b,c){Ub.setCSSStyle(a,b,c)},removeCSSStyle:function(a,b){Ub.removeCSSStyle(a,b)},getCSSStyle:function(a,b){return Ub.getCSSStyle(a,b)},toDegrees:function(a){return Rb.toDegrees(a)},toRadians:function(a){return Rb.toDegrees(a)},getRadiansBetweenLines:function(a,b){return Rb.getRadiansBetweenLines(a,b)},getElementsBounds:function(a,b){var c=null;return a.forEach(function(a){if(a.getRect){var d,e;b&&(e=b.getElementUI(a),e&&(d=e.getViewRect())),d||(d=a.getRect()),c=c?Gb.Util.unionRect(c,d):d}}),c},getPointIndex:function(a,b,c){if(c||(c=10),a)for(var d=a.size();d--;d>=0)if(Rb.getDistance(a.get(d),b)<=c)return d;return-1},registerVectorShape:function(a,b){Hb.g["_"+a]=b},rotateCanvas:function(a,b,c){a.translate(b.x+b.width/2,b.y+b.height/2),a.rotate(c*Math.PI/180),a.translate(-(b.x+b.width/2),-(b.y+b.height/2))},registerShape:function(a,b){ed(a,b)},registerDraw:function(a,b){dd(a,b)},getFilterColor:function(a,b){return sd(a,b)},registerGifImage:function(a,b){},parseVectorData:function(a){return Dc(a)},getSharedLinks:function(a,b){var c=a.getLinks(),d=b.getLinks();if(c&&0!=c.size()&&d&&0!=d.size()){var e=c.size()>d.size()?c:d;return e.toList(function(c){return c.getFromNode()==a&&c.getToNode()==b||c.getFromNode()==b&&c.getToNode()==a})}return null},isSharedLinks:function(a,b){var c=!1,d=a.getLinks(),e=b.getLinks();if(d&&0!=d.size()&&e&&0!=e.size()){var f=d.size()>e.size()?d:e;f.forEach(function(d){return d.getFromNode()==a&&d.getToNode()==b||d.getFromNode()==b&&d.getToNode()==a?(c=!0,!1):!0})}return c},playAnimate:function(a){return wb(a)},pauseAnimate:function(a){a.pause()},resumeAnimate:function(a){a.resume()},stopAnimate:function(a,b){xb(a,b)},pauseAllAnimates:function(){zb()},resumeAllAnimates:function(){Ab()},stopAllAnimates:function(a){yb(a)},randomColor:function(){return"#"+("00000"+(16777216*this.random()<<0).toString(16)).substr(-6)},random:function(){return Math.random()},getHSVColor:function(a,b,c){var d,e,f,g,h,i,j,k;switch(a&&void 0===b&&void 0===c&&(b=a.s,c=a.v,a=a.h),g=Math.floor(6*a),h=6*a-g,i=c*(1-b),j=c*(1-h*b),k=c*(1-(1-h)*b),g%6){case 0:d=c,e=k,f=i;break;case 1:d=j,e=c,f=i;break;case 2:d=i,e=c,f=k;break;case 3:d=i,e=j,f=c;break;case 4:d=k,e=i,f=c;break;case 5:d=c,e=i,f=j}var l="#"+toHex(255*d)+toHex(255*e)+toHex(255*f);return l},toHex:function(a){var b=parseInt(a).toString(16);return 1==b.length&&(b="0"+b),b},makeHighRes:function(a){var b=a.getContext("2d"),c=window.devicePixelRatio||1,d=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1,e=c/d;if(c!==d){var f=a.width,g=a.height;a.width=Math.round(f*e),a.height=Math.round(g*e),a.style.width=f+"px",a.style.height=g+"px",b.scale(e,e)}},newFunction:function(){var a=arguments,b=a.length;return 1===b?Hb.newInstance("Function",a[0]):2===b?Hb.newInstance("Function",a[0],a[1]):3===b?Hb.newInstance("Function",a[0],a[1],a[2]):4===b?Hb.newInstance("Function",a[0],a[1],a[2],a[3]):5===b?Hb.newInstance("Function",a[0],a[1],a[2],a[3],a[4]):6===b?Hb.newInstance("Function",a[0],a[1],a[2],a[3],a[4],a[5]):7===b?Hb.newInstance("Function",a[0],a[1],a[2],a[3],a[4],a[5],a[6]):8===b?Hb.newInstance("Function",a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7]):null}},Hb.ext("twaver.Util",Object,{});var Xb,Yb=0xdeadbeefcafe,Zb=15715070==(16777215&Yb);Zb&&"Microsoft Internet Explorer"==Lb.appName?(a.prototype.am=d,Xb=30):Zb&&"Netscape"!=Lb.appName?(a.prototype.am=c,Xb=26):(a.prototype.am=e,Xb=28),a.prototype.DB=Xb,a.prototype.DM=(1<<Xb)-1,a.prototype.DV=1<<Xb;var $b=52;a.prototype.FV=Math.pow(2,$b),a.prototype.F1=$b-Xb,a.prototype.F2=2*Xb-$b;var _b,ac,bc="0123456789abcdefghijklmnopqrstuvwxyz",cc=new Array;for(_b="0".charCodeAt(0),ac=0;9>=ac;++ac)cc[_b++]=ac;for(_b="a".charCodeAt(0),ac=10;36>ac;++ac)cc[_b++]=ac;for(_b="A".charCodeAt(0),ac=10;36>ac;++ac)cc[_b++]=ac;C.prototype.convert=D,C.prototype.revert=E,C.prototype.reduce=F,C.prototype.mulTo=G,C.prototype.sqrTo=H,J.prototype.convert=K,J.prototype.revert=L,J.prototype.reduce=M,J.prototype.mulTo=O,J.prototype.sqrTo=N,a.prototype.copyTo=h,a.prototype.fromInt=j,a.prototype.fromString=l,a.prototype.clamp=m,a.prototype.dlShiftTo=t,a.prototype.drShiftTo=u,a.prototype.lShiftTo=v,a.prototype.rShiftTo=w,a.prototype.subTo=x,a.prototype.multiplyTo=y,a.prototype.squareTo=z,a.prototype.divRemTo=A,a.prototype.invDigit=I,a.prototype.isEven=P,a.prototype.exp=Q,a.prototype.toString=n,a.prototype.negate=o,a.prototype.abs=p,a.prototype.compareTo=q,a.prototype.bitLength=s,a.prototype.mod=B,a.prototype.modPowInt=R,a.ZERO=k(0),a.ONE=k(1),Ia.prototype.convert=Ja,Ia.prototype.revert=Ja,Ia.prototype.mulTo=Ka,Ia.prototype.sqrTo=La,Pa.prototype.convert=Qa,Pa.prototype.revert=Ra,Pa.prototype.reduce=Sa,Pa.prototype.mulTo=Ua,Pa.prototype.sqrTo=Ta;var dc=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],ec=(1<<26)/dc[dc.length-1];a.prototype.chunkSize=W,a.prototype.toRadix=Y,a.prototype.fromRadix=Z,a.prototype.fromNumber=$,a.prototype.bitwiseTo=da,a.prototype.changeBit=ua,a.prototype.addTo=ya,a.prototype.dMultiply=Ga,a.prototype.dAddOffset=Ha,a.prototype.multiplyLowerTo=Na,a.prototype.multiplyUpperTo=Oa,a.prototype.modInt=Xa,a.prototype.millerRabin=$a,a.prototype.clone=S,a.prototype.intValue=T,a.prototype.byteValue=U,a.prototype.shortValue=V,a.prototype.signum=X,a.prototype.toByteArray=_,a.prototype.equals=aa,a.prototype.min=ba,a.prototype.max=ca,a.prototype.and=fa,a.prototype.or=ha,a.prototype.xor=ja,a.prototype.andNot=la,a.prototype.not=ma,a.prototype.shiftLeft=na,a.prototype.shiftRight=oa,a.prototype.getLowestSetBit=qa,a.prototype.bitCount=sa,a.prototype.testBit=ta,a.prototype.setBit=va,a.prototype.clearBit=wa,a.prototype.flipBit=xa,a.prototype.add=za,a.prototype.subtract=Aa,a.prototype.multiply=Ba,a.prototype.divide=Da,a.prototype.remainder=Ea,a.prototype.divideAndRemainder=Fa,a.prototype.modPow=Va,a.prototype.modInverse=Ya,a.prototype.pow=Ma,a.prototype.gcd=Wa,a.prototype.isProbablePrime=Za,a.prototype.square=Ca,_a.prototype.init=ab,_a.prototype.next=bb;var fc,gc,hc,ic=256;if(null==gc){gc=new Array,hc=0;var jc;if("Netscape"==Lb.appName&&Lb.appVersion<"5"&&window.crypto){var kc=window.crypto.random(32);for(jc=0;jc<kc.length;++jc)gc[hc++]=255&kc.charCodeAt(jc)}for(;ic>hc;)jc=Math.floor(65536*Gb.Util.random()),gc[hc++]=jc>>>8,gc[hc++]=255&jc;hc=0,eb()}hb.prototype.nextBytes=gb;kb.prototype.doPublic=mb,kb.prototype.setPublic=lb,kb.prototype.encrypt=nb,kb.prototype.doPrivate=rb,kb.prototype.setPrivate=pb,kb.prototype.setPrivateEx=qb,kb.prototype.decrypt=sb;var lc=function(){mc.v(Ib)},mc={},nc="6a384c1259bdb5e731ec96b3174683f48a2c56a85e52e7a5bb20b58711ce50c1a294bd5e1d1752e766085e9ae94bae6d217c25dbb5fcdb86a8a9a7e180fa066723d00fcb85fcf7c9d29f8cc8859f53244a49c0bc30dcc45156daf8843ce1d24fe8ebc9a3c186bb26e9d0714041aef160304c1db8cc5728cf4acb39d29755f319",oc="10001",pc="b881f568eb43e7a60c256a8a90e08b7c7638fd66ce3cded9005c72e283ca4f2b8601e2edc687d7f898348a05723b515d9edeb626af7b499a56ddaea93b0c2047";mc.cross=function(a){if(a){for(var b="",c=0;c<a.length;)c+1<a.length?(b+=a[c+1],b+=a[c]):b+=a[c],c+=2;return b}return null},mc.reverse=function(a){if(a){for(var b="",c=a.length;c>0;c--)b+=a[c-1];return b}return null},mc.v=function(a){if(a){var b=mc;if(b.start=null,b.beginDate=null,b.end=null,b.endDate=null,b.gis=null,b["3D"]=null,b["3d"]=null,b.l=null,b.__li__=null,a.indexOf("signature=")>0){var c=a.split("signature="),d=c[0],e=c[1],f=new kb;f.setPublic(nc,oc);for(var g=e,h=g.length,i=256,j=0,k="",l="";h>j;)k=g.substr(j,i),l+=f.decrypt(k),j+=i;if(l===d)return b.i(a),!0}}return!1},mc.i=function(a){var b=mc;b.__li__=a;var c,d,e,f,g,h=a.split("\n");for(c=h.length-1;c>=0;c--)d=h[c],g=d.split("="),e=g[0],f=g[1],b[e]=f;void 0!=b.start&&(b.beginDate=new Date(Date.parse(b.start.replace(/-/g,"/")))),void 0!=b.end&&(b.endDate=new Date(Date.parse(b.end.replace(/-/g,"/"))));var i=b.gis;void 0!=i&&(i=parseInt(i)),i&&(b._isPermissionGIS=!0);var j=b["3D"]||b["3d"];void 0!=j&&(j=parseInt(j)),j&&(b._isPermission3D=!0),b["3D"]&&(b._isPermission3D=!0),void 0!=b.l&&(b.version=b.l)};var qc=function(a){return void 0!==a.__li__&&!a._isPermission3D},rc=function(a){if(!qc(a))return!0;var b=new Date;return null!=a.beginDate&&a.beginDate.getTime()-b.getTime()>=0||null!=a.endDate&&a.endDate.getTime()-b.getTime()<=0},sc=function(){return rc(mc)?!1:mc._isPermissionGIS};mc.$z=function(a){var b=new kb;b.setPublic(nc,oc);for(var c=a,d=c.length,e=256,f=0,g="",h="";d>f;)g=c.substr(f,e),h+=b.decrypt(g),f+=e;return h},mc.twm=function(a){var b=mc,c=b.$z("4cd18113d0c7046bfe51f7a3fbd41c2b7cf14dd785d6ea7cec9da17710d3acfb8ce0cb9cf10839f4bd51e88819de19cdc0db09278584396156fcb65abe0353ac49d01326b30efa0ea98a07da9f8ceeb7572fc1b37b5965ba6103ccba4913b62e36e49425c6ff21a2f008830c59cff8f29058769f858c8a9f0bab3eaea7fb8a9e"),d=this.type,e=this.markText,f=b.$z("648be38cd61c870e95ffc1ea0676af40736c1365015abc326e891a4de67b4de3d4b05da70b9aebedc83ec26ecf71eb74c72f42f6d9a4be2d507d2f67d2860b7b66e3ba1d565e15923f2db335ff922eef17c01b59818b583d5656412d6cc9d9ba70001c2c88e3efd492c6b13a07fda5f325b333138a2036f4696542ec137cc341");if(a[f]=b.__li__,"3"!==d||rc(mc)||void 0!==e){void 0==a.__liLabel&&(a.__liLabel=Mb.createElement("div")),void 0===b.startDate&&(b.startDate=new Date);var g=(new Date).getTime()-b.startDate.getTime();if(!(3e5>g)){var h=rc(b)&&g>3e5,i=e;if(h?i=b.$z("0dd629dbd0ce341ecdd447e35ddc3135a0b46916f7571a687f38ae665cf0ae095fee885e14329caa75112d8787508da17285b0897845d8ccae73e6a2727dd19f1ca335fe139d0e60d240f9ececc78f81c2c5667f51aeed4135b9c4bb436b8acb7cd418eeeb404bc4f3bcdedb481ac0edff7644435ce2b9f2bda78c892bd56d73"):"2"!=d||void 0!==i&&""!=i?"1"!=d||e||(i=c):i=b.$z("644d54bf9c59afbd8a742a9e7e2731f23f149ccb7f04c3547548c50ac2d77faea108b55f1f6261e99869f1c06b84e8abdefdf45b5170048531421f3d528123972ba2f03d70f37c33f1341dc12f986e0089e42bab517e2a05b455d12d90991bbba9bc45c715a81943062ea5fa5408c8b1b9270d260cc5a67b38ecc4178ce512fc"),void 0!==i){var j=a,k=j.__liLabel;if(k.innerHTML=i,j._rootCanvas)k.type=d,k.mark=e,k.expired=h,j._xyz=k;else{var l=0,m=0;k.style.position="absolute";var n=j.getView().style;void 0!=e&&null!=e&&""!=e||"2"==d?(l=10-j.getView().scrollLeft,m=10-j.getView().scrollTop):(l=n.width.replace("px","")/2-50-j.getView().scrollLeft,m=n.height.replace("px","")/2-j.getView().scrollTop),k.style.right=l+"px",k.style.bottom=m+"px",k.style.fontSize="120%",h&&(j.getView().style.opacity=.1,k.style.color="red",k.style.fontSize="150%"),j.getView().appendChild(k)}}}}},Hb.validateLicense(Ib);var tc=function(a,b,c){this.g=a,this.onLength=b,this.offLength=c,this.isLine=!0,this.overflow=0,this.dashLength=b+c,this.pen={x:0,y:0}};Hb.ext(tc,Object,{_curveaccuracy:6,moveTo:function(a,b){this.pen={x:a,y:b},this.g.moveTo(a,b),this.start||(this.start={x:a,y:b})},lineTo:function(a,b){var c=a-this.pen.x,d=b-this.pen.y,e=Math.atan2(d,c),f=Math.cos(e),g=Math.sin(e),h=this.lineLength(this.pen.x,this.pen.y,a,b);if(this.overflow){if(this.overflow>h)return this.isLine?this._lineTo(a,b):this.moveTo(a,b),void(this.overflow-=h);if(this.isLine?this._lineTo(this.pen.x+f*this.overflow,this.pen.y+g*this.overflow):this.moveTo(this.pen.x+f*this.overflow,this.pen.y+g*this.overflow),h-=this.overflow,this.overflow=0,this.isLine=!this.isLine,!h)return}var i=Math.floor(h/this.dashLength);if(i){for(var j=f*this.onLength,k=g*this.onLength,l=f*this.offLength,m=g*this.offLength,n=0;i>n;n++)this.isLine?(this._lineTo(this.pen.x+j,this.pen.y+k),this.moveTo(this.pen.x+l,this.pen.y+m)):(this.moveTo(this.pen.x+l,this.pen.y+m),this._lineTo(this.pen.x+j,this.pen.y+k));h-=this.dashLength*i}this.isLine?h>this.onLength?(this._lineTo(this.pen.x+f*this.onLength,this.pen.y+g*this.onLength),this.moveTo(a,b),this.overflow=this.offLength-(h-this.onLength),this.isLine=!1):(this._lineTo(a,b),h==this.onLength?(this.overflow=0,this.isLine=!this.isLine):(this.overflow=this.onLength-h,this.moveTo(a,b))):h>this.offLength?(this.moveTo(this.pen.x+f*this.offLength,this.pen.y+g*this.offLength),this._lineTo(a,b),this.overflow=this.onLength-(h-this.offLength),this.isLine=!0):(this.moveTo(a,b),h==this.offLength?(this.overflow=0,this.isLine=!this.isLine):this.overflow=this.offLength-h)},quadraticCurveTo:function(a,b,c,d){var e,f=this.pen.x,g=this.pen.y,h=this.curveLength(f,g,a,b,c,d),i=0,j=0;if(this.overflow){if(this.overflow>h)return this.isLine?this._curveTo(a,b,c,d):this.moveTo(c,d),void(this.overflow-=h);if(i=this.overflow/h,e=this.curveSliceUpTo(f,g,a,b,c,d,i),this.isLine?this._curveTo(e[2],e[3],e[4],e[5]):this.moveTo(e[4],e[5]),this.overflow=0,this.isLine=!this.isLine,!h)return}var k=h-h*i,l=Math.floor(k/this.dashLength),m=this.onLength/h,n=this.offLength/h;if(l)for(var o=0;l>o;o++)this.isLine?(j=i+m,e=this.curveSlice(f,g,a,b,c,d,i,j),this._curveTo(e[2],e[3],e[4],e[5]),i=j,j=i+n,e=this.curveSlice(f,g,a,b,c,d,i,j),this.moveTo(e[4],e[5])):(j=i+n,e=this.curveSlice(f,g,a,b,c,d,i,j),this.moveTo(e[4],e[5]),i=j,j=i+m,e=this.curveSlice(f,g,a,b,c,d,i,j),this._curveTo(e[2],e[3],e[4],e[5])),i=j;k=h-h*i,this.isLine?k>this.onLength?(j=i+m,e=this.curveSlice(f,g,a,b,c,d,i,j),this._curveTo(e[2],e[3],e[4],e[5]),this.moveTo(c,d),this.overflow=this.offLength-(k-this.onLength),this.isLine=!1):(e=this.curveSliceFrom(f,g,a,b,c,d,i),this._curveTo(e[2],e[3],e[4],e[5]),h==this.onLength?(this.overflow=0,this.isLine=!this.isLine):(this.overflow=this.onLength-k,this.moveTo(c,d))):k>this.offLength?(j=i+n,e=this.curveSlice(f,g,a,b,c,d,i,j),this.moveTo(e[4],e[5]),e=this.curveSliceFrom(f,g,a,b,c,d,j),this._curveTo(e[2],e[3],e[4],e[5]),this.overflow=this.onLength-(k-this.offLength),this.isLine=!0):(this.moveTo(c,d),k==this.offLength?(this.overflow=0,this.isLine=!this.isLine):this.overflow=this.offLength-k)},bezierCurveTo:function(a,b,c,d,e,f){this.pen={x:e,y:f};var g=[this.onLength,this.offLength];this.g.setLineDash&&this.g.setLineDash(g),this.g.lineDash=g,this.g.bezierCurveTo(a,b,c,d,e,f)},rect:function(a,b,c,d){this.pen={x:a,y:b},this.moveTo(a,b),this.lineTo(a,b+d),this.lineTo(a+c,b+d),this.lineTo(a+c,b),this.lineTo(a,b)},closePath:function(){this.lineTo(this.start.x,this.start.y)},lineLength:function(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(e*e+f*f)},curveLength:function(a,b,c,d,e,f,g){for(var h,i,j,k,l,m,n,o=0,p=a,q=b,r=g>0?g:this._curveaccuracy,s=1;r>=s;s++)j=s/r,k=1-j,l=k*k,m=2*j*k,n=j*j,h=l*a+m*c+n*e,i=l*b+m*d+n*f,o+=this.lineLength(p,q,h,i),p=h,q=i;return o},curveSlice:function(a,b,c,d,e,f,g,h){if(0==g)return this.curveSliceUpTo(a,b,c,d,e,f,h);if(1==h)return this.curveSliceFrom(a,b,c,d,e,f,g);var i=this.curveSliceUpTo(a,b,c,d,e,f,h);return i.push(g/h),this.curveSliceFrom.apply(this,i)},curveSliceUpTo:function(a,b,c,d,e,f,g){if(1!=g){var h=c+(e-c)*g,i=d+(f-d)*g;c=a+(c-a)*g,d=b+(d-b)*g,e=c+(h-c)*g,f=d+(i-d)*g}return[a,b,c,d,e,f]},curveSliceFrom:function(a,b,c,d,e,f,g){if(1!=g){var h=a+(c-a)*g,i=b+(d-b)*g;c+=(e-c)*g,d+=(f-d)*g,a=h+(c-h)*g,b=i+(d-i)*g}return[a,b,c,d,e,f]},_lineTo:function(a,b){(a!=this.pen.x||b!=this.pen.y)&&(this.pen={x:a,y:b},this.g.lineTo(a,b))},_curveTo:function(a,b,c,d){(a!=c||b!=d||c!=this.pen.x||d!=this.pen.y)&&(this.pen={x:c,y:d},this.g.quadraticCurveTo(a,b,c,d))}}),Hb.DashedLine=tc;var uc={DEFAULTS:{"default":1,"default.vector":1,"vector.default":1},VECTORS:{vector:1,"default.vector":1,"vector.default":1},hasDefault:function(a){if(a instanceof Ld){var b=a.getStyle("body.type");return 1===uc.DEFAULTS[b]}return!0},hasVector:function(a){if(a instanceof Ld){var b=a.getStyle("body.type");return 1===uc.VECTORS[b]}return!1},hasAgentLinks:function(a){for(var b=a.getChildrenSize(),c=0;b>c;c++){var d=a.getChildAt(c);if(d instanceof Ld&&uc.hasAgentLinks(d))return!0}return a.hasAgentLinks()},getParents:function(a,b,c){c||(c=!0);for(var d=new md,e=a._parent;null!=e&&e!==b;)d.add(e,0),e=e._parent;return c&&null!=e&&e===b&&d.add(e,0),d},getSubNetwork:function(a){if(!a)return null;if(a instanceof Gb.Link){var b=a._fromAgent,c=a._toAgent;if(!b||!c)return null;var d=uc.getSubNetwork(b),e=uc.getSubNetwork(c);return d===e?d:null}var f=a._parent;if(!f)return null;for(;f instanceof Gb.Link&&!f.ISubNetwork;)f=f._parent;return f.ISubNetwork?f:uc.getSubNetwork(f)},figureSameSubNetworkAgent:function(a){if(!a)return null;for(var b=a._parent;b instanceof Nd;){if(!(b._parent instanceof Nd))return b.isExpanded()?a:b;b.isExpanded()||(a=b),b=b._parent}return a},figureSpanSubNetworkAgent:function(a,b){if(!a||!b)return null;var c=uc.getSubNetwork(a),d=uc.getSubNetwork(b);if(c!=d){for(;null!=d&&c!=d;)d=uc.getSubNetwork(d);if(c===d)return a;var e=new md;e.add(a,0);for(var f=a._parent;f instanceof Ld&&!b.isDescendantOf(f);)e.add(f,0),f=f._parent;for(var g=e.size(),h=0;g>h;h++){var i=e.get(h);if(i instanceof Nd&&!i.isExpanded())return i;if(i.ISubNetwork)return i}return a}return a},figureFromAgent:function(a){if(a.isLooped())return a.getFromNode();var b=uc.figureSameSubNetworkAgent(a.getFromNode()),c=uc.figureSameSubNetworkAgent(a.getToNode());return b===c?a.getFromNode():uc.figureSpanSubNetworkAgent(b,c)},figureToAgent:function(a){if(a.isLooped())return a.getToNode();var b=uc.figureSameSubNetworkAgent(a.getFromNode()),c=uc.figureSameSubNetworkAgent(a.getToNode());return b===c?a.getToNode():uc.figureSpanSubNetworkAgent(c,b)},getBundleLinks:function(a,b){if(!a||!b)return null;var c,d,e,f;if(a===b){if(f=a.getLoopedLinks(),!f)return null;f=new md(f)}else{var g=a.getAgentLinks(),h=b.getAgentLinks();if(!g||!h)return null;for(d=g.size(),c=0;d>c;c++)e=g.get(c),h.contains(e)&&(f||(f=new md),f.add(e))}if(null!=f)for(c=0;c<f.size();c++)e=f.get(c),e.getStyle("link.bundle.enable")||(e._setBundleLinks(null),f.removeAt(c),c--);return f},resetBundleLinks:function(a,b){var c=uc.getBundleLinks(a,b);if(c&&0!==c.size()){var d=null;if(1===c.size())return d=c.get(0),void d._setBundleLinks(null);var e,f,g=new md;for(e=0;e<c.size();e++)d=c.get(e),f=d.getStyle("link.bundle.id"),g.indexOf(f)<0&&g.add(f);g.sort();var h,i,j=new md;for(i=0;i<g.size();i++){f=g.get(i);var k=new md;for(e=0;e<c.size();e++)d=c.get(e),f===d.getStyle("link.bundle.id")&&k.add(d);h=new Gb.BundleLinks(k,j),j.add(h)}for(i=0;i<j.size();i++)for(h=j.get(i),e=0;e<h.getLinks().size();e++)d=h.getLinks().get(e),d._setBundleLinks(h)}},moveElements:function(a,b,c,d){for(var e=uc.filterMovingElements(a,d),f=e.size(),g=0;f>g;g++)e.get(g).translate(b,c)},filterMovingElements:function(a,b){for(var c=new md,d=a.size(),e=0;d>e;e++){var f=a.get(e);if(f instanceof Ld&&(!b||b(f))){for(var g=!0,h=c.toArray(),i=0;i<h.length;i++){var j=h[i];g&&j instanceof Gb.Follower&&f instanceof Gb.Follower&&f.isLoopedHostOn(j)?g=!1:j instanceof Gb.Follower&&j.isHostOn(f)?c.remove(j):g&&f instanceof Gb.Follower&&j instanceof Ld&&f.isHostOn(j)?g=!1:uc.isDescendantOfGroup(j,f)?c.remove(j):g&&uc.isDescendantOfGroup(f,j)&&(g=!1)}g&&c.add(f)}}return c},isDescendantOfGroup:function(a,b){if(!(a&&b instanceof Nd))return!1;if(!b.hasChildren())return!1;for(a=a._parent;a instanceof Nd;){if(a===b)return!0;a=a._parent}return!1}};Hb.element=uc;var vc={between:function(a,b,c){return c>=a&&b>=c?!0:c>=b&&a>=c?!0:!1},considerEast:function(a,b,c){return b?vc.between(b.x,c.x,a.x)?c.x>b.x:Math.abs(b.x-a.x)>Math.abs(c.x-a.x):!0},considerWest:function(a,b,c){return b?vc.between(b.x,c.x,a.x)?c.x<b.x:Math.abs(b.x-a.x)>Math.abs(c.x-a.x):!0},considerNorth:function(a,b,c){return b?vc.between(b.y,c.y,a.y)?c.y<b.y:Math.abs(b.y-a.y)>Math.abs(c.y-a.y):!0},considerSouth:function(a,b,c){return b?vc.between(b.y,c.y,a.y)?c.y>b.y:Math.abs(b.y-a.y)>Math.abs(c.y-a.y):!0},getHorizontalPoint:function(a,b,c){return vc.between(b.x,c.x,a.x)?{x:a.x,y:b.y}:Math.abs(a.x-b.x)<Math.abs(a.x-c.x)?{x:b.x,y:b.y}:{x:c.x,y:c.y}},getVerticalPoint:function(a,b,c){return vc.between(b.y,c.y,a.y)?{x:b.x,y:a.y}:Math.abs(a.y-b.y)<Math.abs(a.y-c.y)?{x:b.x,y:b.y}:{x:c.x,y:c.y}},getPoint:function(a,b,c,d,e){var f=Math.abs(d.x-c.x)>Math.abs(d.y-c.y);if("south"===e)return f&&vc.considerSouth(b,a,c)?vc.getHorizontalPoint(b,c,d):null;if("north"===e)return f&&vc.considerNorth(b,a,c)?vc.getHorizontalPoint(b,c,d):null;if("west"===e)return!f&&vc.considerWest(b,a,c)?vc.getVerticalPoint(b,c,d):null;if("east"===e)return!f&&vc.considerEast(b,a,c)?vc.getVerticalPoint(b,c,d):null;if("nearby"===e){var g;return g=f?vc.getHorizontalPoint(b,c,d):vc.getVerticalPoint(b,c,d),!a||Rb.getDistance(a,b)>Rb.getDistance(g,b)?g:null}return null},getBusPoint:function(a,b,c){var d,e=a.size();if(e>0){for(var f=a.get(0),g=1;e>g;g++){var h=a.get(g),i=vc.getPoint(d,b,f,h,c);i&&(d=i),f=h}d||(d={x:f.x,y:f.y})}return d}};Hb.bus=vc;var wc={createFromPoint:function(a,b){var c=a._element;if(!c.getFromAgent())return{x:0,y:0};var d,e=c.getStyle("link.from.position"),f=c.getStyle("link.from.xoffset"),g=c.getStyle("link.from.yoffset"),h=c.getStyle("link.from.percent");if(h&&h instanceof Array&&2===h.length&&h[0]<=1&&h[0]>=0&&h[1]<=1&&h[1]>=0){var i=c.getFromAgent(),j=i.getSize(),k=i.getRect().x+j.width*h[0],l=i.getRect().y+j.height*h[1];return{x:k,y:l}}if(a._network._edgeDetect){var i=c.getFromAgent(),m=c.getToAgent(),n=i.getImage(),o=Hb.images[n],p=i.getCenterLocation(),q=m.getCenterLocation(),r=this._getPointAngleDegree(q.x,q.y,p.x,p.y),s={x:0,y:0};if(o){var t=o._image;if(t&&bd(t)||t&&Gb.Util.getImageAsset(n)._cache)return bd(t)?o._edgeData||(o._edgeData=o._createEdgeData(t,i._width,i._height)):"object"==typeof t&&(o._edgeData||(o._edgeData=o._createEdgeData(Gb.Util.getImageAsset(n)._cache,i.getWidth(),i.getHeight()))),s.x=o._edgeData[r].x+i.getRect().x,s.y=o._edgeData[r].y+i.getRect().y,s}}if(!Hb.isCalculatingBus){if(Hb.isCalculatingBus=!0,c.getFromAgent()instanceof Gb.Bus){var u=c.getFromAgent();if(uc.hasVector(u)){var v=b?b._getElementZoomRect(a,u.getRect()):u.getRect(),w=u.getStyle("vector.shape");if("oval"===w)d=Rb.getEllipsePoint(v,wc.createToPoint(a));else if("circle"===w)d=Rb.getEllipsePoint(Rb.getCircleRect(v),wc.createToPoint(a));else if("rectangle"===w||"roundrect"===w){var x=new md;x.add({x:u.x,y:u.y}),x.add({x:u.x+u.width,y:u.y}),x.add({x:u.x+u.width,y:u.y+u.height}),x.add({x:u.x,y:u.y+u.height}),x.add({x:u.x,y:u.y}),x=b?b._getShapeNodeZoomPoints(a,x):x,d=vc.getBusPoint(x,wc.createToPoint(a),u.getStyle("bus.style"))}}else{var x=b?b._getShapeNodeZoomPoints(a,u.getPoints()):u.getPoints();d=vc.getBusPoint(x,wc.createToPoint(a),u.getStyle("bus.style"))}}Hb.isCalculatingBus=!1}return d?(d.x+=f,d.y+=g):d=a._network.getPosition(e,c.getFromAgent(),null,f,g,!0),d},createToPoint:function(a,b){var c=a._element;if(!c.getToAgent())return{x:0,y:0};var d,e=c.getStyle("link.to.position"),f=c.getStyle("link.to.xoffset"),g=c.getStyle("link.to.yoffset"),h=c.getStyle("link.to.percent");if(h&&h instanceof Array&&2===h.length&&h[0]<=1&&h[0]>=0&&h[1]<=1&&h[1]>=0){var i=c.getToAgent(),j=i.getSize(),k=i.getRect().x+j.width*h[0],l=i.getRect().y+j.height*h[1];return{x:k,y:l}}if(a._network._edgeDetect){var m=c.getFromAgent(),i=c.getToAgent(),n=i.getImage(),o=Hb.images[n],p=m.getLocation(),q=i.getCenterLocation(),r=this._getPointAngleDegree(p.x,p.y,q.x,q.y),s={x:0,y:0};if(o){var t=o._image;if(t&&bd(t)||t&&Gb.Util.getImageAsset(n)._cache)return bd(t)?o._edgeData||(o._edgeData=o._createEdgeData(t,i.getWidth(),i.getHeight())):"object"==typeof t&&(o._edgeData||(o._edgeData=o._createEdgeData(Gb.Util.getImageAsset(n)._cache,i.getWidth(),i.getHeight()))),s.x=o._edgeData[r].x+i.getRect().x,s.y=o._edgeData[r].y+i.getRect().y,s}}if(!Hb.isCalculatingBus){if(Hb.isCalculatingBus=!0,c.getToAgent()instanceof Gb.Bus){var u=c.getToAgent();if(uc.hasVector(u)){var v=b?b._getElementZoomRect(a,u.getRect()):u.getRect(),w=u.getStyle("vector.shape");if("oval"===w)d=Rb.getEllipsePoint(v,wc.createFromPoint(a));else if("circle"===w)d=Rb.getEllipsePoint(Rb.getCircleRect(v),wc.createFromPoint(a));else if("rectangle"===w||"roundrect"===w){var x=new md;x.add({x:u.x,y:u.y
}),x.add({x:u.x+u.width,y:u.y}),x.add({x:u.x+u.width,y:u.y+u.height}),x.add({x:u.x,y:u.y+u.height}),x.add({x:u.x,y:u.y}),x=b?b._getShapeNodeZoomPoints(a,x):x,d=vc.getBusPoint(x,wc.createFromPoint(a),u.getStyle("bus.style"))}}else{var x=b?b._getShapeNodeZoomPoints(a,u.getPoints()):u.getPoints();d=vc.getBusPoint(x,wc.createFromPoint(a),u.getStyle("bus.style"))}}Hb.isCalculatingBus=!1}return d?(d.x+=f,d.y+=g):d=a._network.getPosition(e,c.getToAgent(),null,f,g,!0),d},fillLoopedPoints:function(a,b,c){var d,e=wc.getBundleGap(a,!0),f=e,g=a.getStyle("link.looped.type"),h=a.getStyle("link.looped.direction");if("north"===h)return"arc"===g?wc.drawArc(b.x+b.width/2,b.y,0,Math.PI,e,e,!1,c):(d={x:b.x+b.width/2,y:b.y},c.add({x:d.x+f,y:d.y}),c.add({x:d.x+f,y:d.y-e}),c.add({x:d.x-f,y:d.y-e}),c.add({x:d.x-f,y:d.y})),{x:b.x+b.width/2,y:b.y-e};if("northeast"===h)return"arc"===g?wc.drawArc(b.x+b.width,b.y,1.5*Math.PI,1.5*Math.PI,e,e,!1,c):(d={x:b.x+b.width,y:b.y},c.add({x:d.x,y:d.y+f}),c.add({x:d.x+f,y:d.y+f}),c.add({x:d.x+f,y:d.y-e}),c.add({x:d.x-f,y:d.y-e}),c.add({x:d.x-f,y:d.y})),{x:b.x+b.width+.707*e,y:b.y-.707*e};if("east"===h)return"arc"===g?wc.drawArc(b.x+b.width,b.y+b.height/2,1.5*Math.PI,Math.PI,e,e,!1,c):(d={x:b.x+b.width,y:b.y+b.height/2},c.add({x:d.x,y:d.y-f}),c.add({x:d.x+e,y:d.y-f}),c.add({x:d.x+e,y:d.y+f}),c.add({x:d.x,y:d.y+f})),{x:b.x+b.width+e,y:b.y+b.height/2};if("southeast"===h)return"arc"===g?wc.drawArc(b.x+b.width,b.y+b.height,Math.PI,1.5*Math.PI,e,e,!1,c):(d={x:b.x+b.width,y:b.y+b.height},c.add({x:d.x,y:d.y-f}),c.add({x:d.x+f,y:d.y-f}),c.add({x:d.x+f,y:d.y+e}),c.add({x:d.x-f,y:d.y+e}),c.add({x:d.x-f,y:d.y})),{x:b.x+b.width+.707*e,y:b.y+b.height+.707*e};if("south"===h)return"arc"===g?wc.drawArc(b.x+b.width/2,b.y+b.height,Math.PI,Math.PI,e,e,!1,c):(d={x:b.x+b.width/2,y:b.y+b.height},c.add({x:d.x-f,y:d.y}),c.add({x:d.x-f,y:d.y+e}),c.add({x:d.x+f,y:d.y+e}),c.add({x:d.x+f,y:d.y})),{x:b.x+b.width/2,y:b.y+b.height+e};if("southwest"===h)return"arc"===g?wc.drawArc(b.x,b.y+b.height,.5*Math.PI,1.5*Math.PI,e,e,!1,c):(d={x:b.x,y:b.y+b.height},c.add({x:d.x,y:d.y-f}),c.add({x:d.x-f,y:d.y-f}),c.add({x:d.x-f,y:d.y+e}),c.add({x:d.x+f,y:d.y+e}),c.add({x:d.x+f,y:d.y})),{x:b.x-.707*e,y:b.y+b.height+.707*e};if("west"===h)return"arc"===g?wc.drawArc(b.x,b.y+b.height/2,.5*Math.PI,Math.PI,e,e,!1,c):(d={x:b.x,y:b.y+b.height/2},c.add({x:d.x,y:d.y-f}),c.add({x:d.x-e,y:d.y-f}),c.add({x:d.x-e,y:d.y+f}),c.add({x:d.x,y:d.y+f})),{x:b.x-e,y:b.y+b.height/2};if("northwest"===h)return"arc"===g?wc.drawArc(b.x,b.y,0,1.5*Math.PI,e,e,!1,c):(d={x:b.x,y:b.y},c.add({x:d.x,y:d.y+f}),c.add({x:d.x-f,y:d.y+f}),c.add({x:d.x-f,y:d.y-e}),c.add({x:d.x+f,y:d.y-e}),c.add({x:d.x+f,y:d.y})),{x:b.x-.707*e,y:b.y-.707*e};throw"Can not resolve link looped direction '"+h+"'"},drawArc:function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s;if(Math.abs(d)>2*Math.PI&&(d=2*Math.PI),m=Math.ceil(Math.abs(d)/(Math.PI/4)),i=d/m,j=-i,k=-c,m>0){n=a+Math.cos(c)*e,o=b+Math.sin(-c)*f,h.add({x:n,y:o});for(var t=0;m>t;t++){k+=j,l=k-j/2,p=a+Math.cos(k)*e,q=b+Math.sin(k)*f,r=a+Math.cos(l)*(e/Math.cos(j/2)),s=b+Math.sin(l)*(f/Math.cos(j/2));var u=new md;u.add({x:r,y:s}),u.add({x:p,y:q}),h.add(u)}}},fillBundlePoints:function(a,b,c,d,e,f){{var g;a._element.getBundleCount(),a._element.getBundleIndex(),a.getStyle("link.bundle.expanded")}if("parallel"!==b&&0===(g=wc.getBundleGap(a,!1)))return e.add(c),e.add(d),Rb.getCenterPoint(c,d);void 0===g&&(g=wc.getBundleGap(a,!1));var h=wc.getBundleOffset(a),i=Rb.getDistance(c,d);if(f){var j=f.getSizeZoom();h*=j,g*=j}("arc"===b||"triangle"===b)&&e.add({x:0,y:0}),"arc"===b&&e.add({x:0,y:g}),e.add({x:h,y:g}),e.add({x:i-h,y:g}),"arc"===b&&e.add({x:i,y:g}),("arc"===b||"triangle"===b)&&e.add({x:i,y:0});for(var k=Math.atan2(d.y-c.y,d.x-c.x),l=Rb.createMatrix(k,0,0),m=0,n=e.size();n>m;m++){var o=e.get(m);o=l.transform(o),o.x+=c.x,o.y+=c.y,e.set(m,o)}if("arc"===b){var p=Rb.getCenterPoint(e.get(2),e.get(3)),q=new md;return q.add(e.get(1)),q.add(e.get(2)),e.set(1,q),q=new md,q.add(e.get(4)),q.add(e.get(5)),e.set(4,q),e.removeAt(5),e.removeAt(2),p}return wc.calculateCenterPoint(e)},calculateCenterPoint:function(a){var b=a.size();if(null==a||1>b)return{x:0,y:0};if(b%2===0){var c=b/2,d=a.get(c-1),e=a.get(c);return{x:(d.x+e.x)/2,y:(d.y+e.y)/2}}return a.get((b-1)/2)},getBundleOffset:function(a){var b=Rb.getDistance(a.getFromPoint(),a.getToPoint()),c=a.getStyle("link.bundle.offset");return b>2*c?c:b/2},getBundleGap:function(a,b){var c=a._element;if(!c.getBundleLinks())return b?c.getStyle("link.looped.gap"):0;for(var d=b?"link.looped.gap":"link.bundle.gap",e=null,f=0,g=0,h=c.getBundleLinks().getSiblings(),i=0,j=c.getStyle("link.bundle.independent"),k=c.getStyle("link.bundle.group.gap"),l=0,m=h.size();m>l;l++){var n=h.get(l);if(!j||n===c.getBundleLinks()){for(var o=0,p=n.getLinks().size();p>o;o++){var q=n.getLinks().get(o);if(j===q.getStyle("link.bundle.independent")&&a._network.isVisible(q)){if(null==e)e=q,i=q.getStyle(d);else{var r=q.getStyle(d);g+=i/2+r/2,i=r}q===c&&(f=g+k/2)}}g+=k}}if(b)return g-f+i;var s=f-g/2;return null!=e&&c.getFromAgent()!==e.getFromAgent()&&(s=-s),s},isTargetPriority:function(a,b,c){if(a){if(b.height<c.height)return b.height+c.height<Math.max(b.y+b.height,c.y+c.height)-Math.min(b.y,c.y)+b.height/2}else if(b.width<c.width)return b.width+c.width<Math.max(b.x+b.width,c.x+c.width)-Math.min(b.x,c.x)+b.width/2;return!0},calculateOrthogonalAndFlexionalLinkPoints:function(a,b,c,d){var e=wc.isHorizontal(a,b,c,d),f=new md;if(wc.isFlexionalTypeLink(a))wc.flexional(e,b,c,f,d.getStyle("link.extend"));else{wc.orthogonal(a,b,c,f,e,d);var g=wc.isSplitByPercent(a,d),h=g?wc.calculateSplitValueByPercent(a,e,b,c,d.getStyle("link.split.percent")):d.getStyle("link.split.value");0===h&&(e=!e)}var i;0===f.size()?wc.isTargetPriority(e,b,c)?(i={x:c.x+c.width/2,y:c.y+c.height/2},f.add(wc.rectanglePerimeter(b,!0,i)),f.add(wc.rectanglePerimeter(c,!1,f.get(f.size()-1)))):(i={x:b.x+b.width/2,y:b.y+b.height/2},i=wc.rectanglePerimeter(c,!1,i),f.add(wc.rectanglePerimeter(b,!0,i)),f.add(i)):(i=f.get(0),f.add(wc.rectanglePerimeter(b,!0,i),0),f.add(wc.rectanglePerimeter(c,!1,f.get(f.size()-1))));var j=f.size();if(2>j)return f;for(var k=f.get(0),l=1;j-1>l;l++){var m=f.get(l);m.x===k.x&&m.y===k.y&&(f.remove(m),j--,l--),k=m}return f},isHorizontal:function(a,b,c,d){if(a){if("flexional.horizontal"===a||"orthogonal.horizontal"===a||"orthogonal.H.V"===a||"extend.left"===a||"extend.right"===a)return!0;if("flexional.vertical"===a||"orthogonal.vertical"===a||"orthogonal.V.H"===a||"extend.top"===a||"extend.bottom"===a)return!1}var e=wc.calculateXGap(b,c),f=wc.calculateYGap(b,c);return e>=f},flexional:function(a,b,c,d,e){a?wc.flexionalHorizontal(b,c,d,e):wc.flexionalVertical(b,c,d,e)},isSplitByPercent:function(a,b){return b.getStyle("link.split.by.percent")},isExtendTypeLink:function(a){return a&&("extend.top"===a||"extend.left"===a||"extend.bottom"===a||"extend.right"===a)},isFlexionalTypeLink:function(a){return a&&("flexional"===a||"flexional.horizontal"===a||"flexional.vertical"===a)},calculateControlPoint:function(a,b,c,d,e){if("orthogonal.H.V"===a||"orthogonal.V.H"===a)return{x:d.x+d.width/2,y:d.y+d.height/2};var f;if(wc.isExtendTypeLink(a)){var g=Math.min(c.y,d.y),h=Math.min(c.x,d.x),i=Math.max(c.y+c.height,d.y+d.height),j=Math.max(c.x+c.width,d.x+d.width);if(f=e.getStyle("link.extend"),"extend.top"===a)return{x:(h+j)/2,y:g-f};if("extend.left"===a)return{x:h-f,y:(g+i)/2};if("extend.bottom"===a)return{x:(h+j)/2,y:i+f};if("extend.right"===a)return{x:j+f,y:(g+i)/2}}var k=wc.isSplitByPercent(a,e);if(f=k?wc.calculateSplitValueByPercent(a,b,c,d,e.getStyle("link.split.percent")):e.getStyle("link.split.value"),f===Number.NEGATIVE_INFINITY||f===Number.POSITIVE_INFINITY)return{x:d.x+d.width/2,y:d.y+d.height/2};if(0===f)return{x:c.x+c.width/2,y:c.y+c.height/2};if(b){var l=c.x+c.x+c.width<d.x+d.x+d.width;return{x:wc.calculateSplitLocation(l,f,c.x,c.width),y:c.y+c.height/2}}var m=c.y+c.y+c.height<d.y+d.y+d.height;return{x:c.x+c.width/2,y:wc.calculateSplitLocation(m,f,c.y,c.height)}},calculateGap:function(a,b,c,d){var e=Math.max(b,d)-Math.min(a,c);return e-(b-a+d-c)},calculateXGap:function(a,b){var c=Math.max(a.x+a.width,b.x+b.width)-Math.min(a.x,b.x);return c-a.width-b.width},calculateYGap:function(a,b){var c=Math.max(a.y+a.height,b.y+b.height)-Math.min(a.y,b.y);return c-a.height-b.height},calculateSplitValueByPercent:function(a,b,c,d,e){var f=wc.calculateSplitGapByPercent(e,b,c,d);return f*e},calculateSplitGapByPercent:function(a,b,c,d,e){return b?wc._calculateSplitGapByPercent(a,c.x,c.x+c.width,d.x,d.x+d.width):wc._calculateSplitGapByPercent(a,c.y,c.y+c.height,d.y,d.y+d.height)},_calculateSplitGapByPercent:function(a,b,c,d,e){var f=wc.calculateGap(b,c,d,e),g=d+e>b+c;if(f>0){if(1===a)return f+(e-d)/2;if(a>=0&&1>a)return f;if(0>a)return g?d-b:c-e}return Math.abs(g&&a>0||!g&&0>a?c-e:b-d)},calculateSplitPercentByControlPoint:function(a,b,c,d){return b?wc.calculateSplitPercent(a.x,c.x,c.x+c.width,d.x,d.x+d.width):wc.calculateSplitPercent(a.y,c.y,c.y+c.height,d.y,d.y+d.height)},calculateSplitPercent:function(a,b,c,d,e){if(a>=b&&c>=a)return 0;var f=wc.calculateGap(b,c,d,e);if(f>0&&a>=d&&e>=a)return 1;var g=d+e>b+c;if(f>0){if(a>Math.min(c,e)&&a<Math.max(b,d))return Math.abs(a-(g?c:b))/f;if(g){if(b>a)return(a-b)/(d-b)}else if(a>c)return(c-a)/(c-e)}return a>c?(g?a-c:c-a)/Math.abs(c-e):(g?a-b:b-a)/Math.abs(b-d)},calculateSplitLocation:function(a,b,c,d){return a===b>0?c+d+Math.abs(b):c-Math.abs(b)},calculateAngle:function(a,b){if(0!==a&&0!==b)return Math.atan2(a,b);if(0===a){if(b>0)return 0;if(0>b)return Math.PI}return a>0?Math.PI/2:-Math.PI/2},drawCorner:function(a,b){var c=a.size();if(!(3>c)){var d=b.getStyle("link.corner");if("none"!==d){for(var e,f,g,h,i=b.getStyle("link.xradius"),j=b.getStyle("link.yradius"),k=a.get(0),l=a.get(1),m=2;c>m;m++){var n=a.get(m),o=l.x-k.x,p=l.y-k.y,q=n.x-l.x,r=n.y-l.y,s=0===p;if(0===o&&0===r||0===p&&0===q)if(s?(e=Math.min(2===m?Math.abs(o):Math.abs(o)/2,i),f=Math.min(m===c-1?Math.abs(r):Math.abs(r)/2,j),g={x:l.x-(o>0?e:-e),y:l.y},h={x:l.x,y:l.y+(r>0?f:-f)}):(e=Math.min(m===c-1?Math.abs(q):Math.abs(q)/2,i),f=Math.min(2===m?Math.abs(p):Math.abs(p)/2,j),g={x:l.x,y:l.y-(p>0?f:-f)},h={x:l.x+(q>0?e:-e),y:l.y}),a.remove(l),m--,c--,(g.x!==k.x||g.y!==k.y)&&(a.add(g,m),m++,c++),"bevel"===d)a.add(h,m),m++,c++;else if("round"===d){var t=new md;t.add(l),t.add(h),a.add(t,m),m++,c++}k=l,l=n}h&&h.x===l.x&&h.y===l.y&&a.remove(l)}}},orthogonal:function(a,b,c,d,e,f){var g=f.getStyle("link.control.point"),h=null==g;if(g){var i=Rb.unionRect(b,c);Rb.containsPoint(i,g)||(e=wc.calculateIsHorizontalByControlPoint(g.x,g.y,i.y,i.x,i.y+i.height,i.x+i.width))}else g=wc.calculateControlPoint(a,e,b,c,f);e?wc.sideToSide(b,c,g,d,h):wc.topToBottom(b,c,g,d,h)},calculateIsHorizontalByControlPoint:function(a,b,c,d,e,f){return c>b&&c-b>d-a&&c-b>a-f||b>e&&b-e>d-a&&b-e>a-f?!1:!0},contains:function(a,b,c){return b>=a.x&&b<=a.x+a.width&&c>=a.y&&c<=a.y+a.height},topToBottom:function(a,b,c,d,e){var f=Math.max(a.y,b.y),g=Math.min(a.y+a.height,b.y+b.height),h=c?c.y:g+(f-g)/2,i=a.x+a.width/2,j=b.x+b.width/2;if(!e&&c&&(c.x>=a.x&&c.x<=a.x+a.width&&(i=c.x),c.x>=b.x&&c.x<=b.x+b.width&&(j=c.x)),wc.contains(b,i,h)||wc.contains(a,i,h)||d.add({x:i,y:h}),wc.contains(b,j,h)||wc.contains(a,j,h)||d.add({x:j,y:h}),0===d.size())if(c)wc.contains(b,c.x,h)||wc.contains(a,c.x,h)||d.add({x:c.x,y:h});else{var k=Math.max(a.x,b.x),l=Math.min(a.x+a.width,b.x+b.width);d.add({x:k+(l-k)/2,y:h})}},sideToSide:function(a,b,c,d,e){var f=Math.max(a.x,b.x),g=Math.min(a.x+a.width,b.x+b.width),h=c?c.x:g+(f-g)/2,i=a.y+a.height/2,j=b.y+b.height/2;if(!e&&c&&(c.y>=a.y&&c.y<=a.y+a.height&&(i=c.y),c.y>=b.y&&c.y<=b.y+b.height&&(j=c.y)),wc.contains(b,h,i)||wc.contains(a,h,i)||d.add({x:h,y:i}),wc.contains(b,h,j)||wc.contains(a,h,j)||d.add({x:h,y:j}),0===d.size())if(c)wc.contains(b,h,c.y)||wc.contains(a,h,c.y)||d.add({x:h,y:c.y});else{var k=Math.max(a.y,b.y),l=Math.min(a.y+a.height,b.y+b.height);d.add({x:h,y:k+(l-k)/2})}},flexionalHorizontal:function(a,b,c,d){var e=b.x+b.width<a.x,f=a.x+a.width<b.x,g=e?a.x:a.x+a.width,h=a.y+a.height/2,i=f?b.x:b.x+b.width,j=b.y+b.height/2,k=d,l=e?-k:k,m={x:g+l,y:h};l=f?-k:k;var n={x:i+l,y:j};if(e===f){var o=e?Math.min(g,i)-d:Math.max(g,i)+d;c.add({x:o,y:h}),c.add({x:o,y:j})}else if(m.x<n.x===e){var p=h+(j-h)/2;c.add(m),c.add({x:m.x,y:p}),c.add({x:n.x,y:p}),c.add(n)}else c.add(m),c.add(n)},flexionalVertical:function(a,b,c,d){var e=b.y+b.height<a.y,f=a.y+a.height<b.y,g=a.x+a.width/2,h=e?a.y:a.y+a.height,i=b.x+b.width/2,j=f?b.y:b.y+b.height,k=d,l=e?-k:k,m={x:g,y:h+l};l=f?-k:k;var n={x:i,y:j+l};if(e===f){var o=e?Math.min(h,j)-d:Math.max(h,j)+d;c.add({x:g,y:o}),c.add({x:i,y:o})}else if(m.y<n.y===e){var p=g+(i-g)/2;c.add(m),c.add({x:p,y:m.y}),c.add({x:p,y:n.y}),c.add(n)}else c.add(m),c.add(n)},rectanglePerimeter:function(a,b,c){var d=a.x+a.width/2,e=a.y+a.height/2,f=c.x-d,g=c.y-e,h=Math.atan2(g,f),i={x:0,y:0},j=Math.PI,k=Math.PI/2,l=k-h,m=Math.atan2(a.height,a.width);return-j+m>h||h>j-m?(i.x=a.x,i.y=e-a.width*Math.tan(h)/2):-m>h?(i.y=a.y,i.x=d-a.height*Math.tan(l)/2):m>h?(i.x=a.x+a.width,i.y=e+a.width*Math.tan(h)/2):(i.y=a.y+a.height,i.x=d+a.height*Math.tan(l)/2),c.x>=a.x&&c.x<=a.x+a.width?i.x=c.x:c.y>=a.y&&c.y<=a.y+a.height&&(i.y=c.y),c.x<a.x?i.x=a.x:c.x>a.x+a.width&&(i.x=a.x+a.width),c.y<a.y?i.y=a.y:c.y>a.y+a.height&&(i.y=a.y+a.height),i},isSplitTypeLink:function(a){return a&&("orthogonal"===a||"orthogonal.horizontal"===a||"orthogonal.vertical"===a)},isOrthogonalOrFlexionalLink:function(a){if(a instanceof Gb.ShapeLink)return!1;if(a.isLooped())return!1;var b=a.getStyle("link.type");return wc.isOrthogonalOrFlexionalType(b)},isOrthogonalLink:function(a){if(a instanceof Gb.ShapeLink)return!1;if(a.isLooped())return!1;var b=a.getStyle("link.type");return wc.isOrthogonalType(b)},isOrthogonalOrFlexionalType:function(a){return"orthogonal"===a||"orthogonal.horizontal"===a||"orthogonal.H.V"===a||"orthogonal.vertical"===a||"orthogonal.V.H"===a||"extend.top"===a||"extend.left"===a||"extend.bottom"===a||"extend.right"===a||"flexional"===a||"flexional.horizontal"===a||"flexional.vertical"===a},isOrthogonalType:function(a){return"orthogonal"===a||"orthogonal.horizontal"===a||"orthogonal.H.V"===a||"orthogonal.vertical"===a||"orthogonal.V.H"===a||"extend.top"===a||"extend.left"===a||"extend.bottom"===a||"extend.right"===a},hasControlPoint:function(a){return"orthogonal"===a||"orthogonal.horizontal"===a||"orthogonal.vertical"===a||"extend.bottom"===a||"extend.left"===a||"extend.right"===a||"extend.top"===a},getControlPoint:function(a,b,c){if(!a)throw"link can't be null";var d=a.getStyle("link.type");if(!wc.hasControlPoint(d))return null;var e=a.getStyle("link.control.point");if(e)return e;var f,g;if(null==b?(f=a.getFromAgent().getRect(),g=a.getToAgent().getRect()):(f=wc.getLinkSourceBounds(b,c),g=wc.getLinkTargetBounds(b,c)),null==f||null==g)return null;var h=wc.isHorizontal(d,f,g,a);return wc.calculateControlPoint(a.getStyle("link.type"),h,f,g,a)},getSplitValueByControlPoint:function(a,b,c,d,e){if("extend.top"===b)return Math.min(c.y,d.y)-a.y;if("extend.left"===b)return Math.min(c.x,d.x)-a.x;if("extend.bottom"===b)return a.y-Math.max(c.y+c.height,d.y+d.height);if("extend.right"===b)return a.x-Math.max(c.x+c.width,d.x+d.width);var f;if(e){var g=c.x+c.x+c.width<d.x+d.x+d.width;return f=g?a.x-c.x+c.width:c.x-a.x,f>0?f:f>-c.width?0:f+c.width}var h=c.y+c.y+c.height<d.y+d.y+d.height;return f=h?a.y-c.y-c.height:c.y-a.y,f>0?f:f>-c.height?0:f+c.height},isHorizontalByControlPoint:function(a,b,c,d,e){var f=Rb.unionRect(c,d);return Rb.containsPoint(f,a)?wc.isHorizontal(b,c,d,e):wc.calculateIsHorizontalByControlPoint(a.x,a.y,f.y,f.x,f.y+f.height,f.x+f.width)},setParamsByControlPoint:function(a,b,c,d,e){var f=wc.isHorizontalByControlPoint(a,d,b,c,e),g=e.getStyle("link.control.point");if((g||"orthogonal"===d||"orthogonal.horizontal"===d||"orthogonal.vertical"===d)&&e.setStyle("link.type",f?"orthogonal.horizontal":"orthogonal.vertical"),g)return void e.setStyle("link.control.point",a);var h=wc.getSplitValueByControlPoint(a,d,b,c,f);if(wc.isExtendTypeLink(d))return void e.setStyle("link.extend",h);var i=wc.isSplitByPercent(d,e);return i?0===h?void e.setStyle("link.split.percent",0):void e.setStyle("link.split.percent",wc.calculateSplitPercentByControlPoint(a,f,b,c)):void e.setStyle("link.split.value",h)},getLinkNodeBounds:function(a,b,c,d,e,f){if(f){var g=f.getLocationZoom();f.getSizeZoom(a)}if(null==a)return null;var h;if(d)f?(h=a.getZoomBodyRect(),h.x+=b,h.y+=c):(h=a.getBodyRect(),h.x+=b,h.y+=c);else{var i=a.getNetwork().getPosition(e,a,null,b,c);h=f?{x:i.x*g,y:i.y*g,width:1,height:1}:{x:i.x,y:i.y,width:1,height:1}}return h},getLinkSourceBounds:function(a,b){var c=a._element,d=a.getNetwork().getElementUI(c.getFromAgent());if(null==d)return null;var e=c.getStyle("link.from.position"),f=c.getStyle("link.from.xoffset"),g=c.getStyle("link.from.yoffset"),h=c.getStyle("link.from.at.edge");return wc.getLinkNodeBounds(d,f,g,h,e,b)},getLinkTargetBounds:function(a,b){var c=a._element,d=a.getNetwork().getElementUI(c.getToAgent());if(null==d)return null;var e=c.getStyle("link.to.position"),f=c.getStyle("link.to.xoffset"),g=c.getStyle("link.to.yoffset"),h=c.getStyle("link.to.at.edge");return wc.getLinkNodeBounds(d,f,g,h,e,b)},orthogonalAndFlexional:function(a,b,c){var d=wc.getLinkSourceBounds(a,c);if(null==d)return null;var e=wc.getLinkTargetBounds(a,c);if(null==e)return null;var f=wc.calculateOrthogonalAndFlexionalLinkPoints(b,d,e,a._element);return wc.offsetLink(a,f),a.setHotSpot(wc.calculateCenterPoint(f)),"flexional"!==b&&wc.drawCorner(f,a._element),f},offsetLink:function(a,b){var c=a._element,d=c.isBundleAgent();if(!d){var e=wc.getBundleGap(a,!1);if(0!==e)for(var f,g,h=!1,i=!1,j=b.get(0),k=Hb.clone(j),l=1,m=b.size();m>l;l++){var n=b.get(l),o=n.x-k.x,p=n.y-k.y;k=Hb.clone(n),g=wc.calculateAngle(o,p),0===o?((g-f)%Math.PI===0&&(g-f)%(2*Math.PI)!==0&&(h=!h,h&&(p=-p)),(g-f)%Math.PI!==0&&(j.x+=0>p?e:-e),n.x+=0>p?e:-e):0===p&&((g-f)%Math.PI===0&&(g-f)%(2*Math.PI)!==0&&(i=!i,i&&(o=-o)),f&&(g-f)%Math.PI===0||(j.y-=0>o?e:-e),n.y-=0>o?e:-e),f=g,j=n}}},_getPointAngleDegree:function(a,b,c,d){var e=c-a,f=d-b,g=Math.atan2(f,e);return g=g/Math.PI*180,g=parseInt(g)+180,g%=360}};Hb.link=wc;var xc={findMoveToBottomDatas:function(a,b,c){for(var d=0;d<c.size();d++){var e=c.get(d);a.contains(e)&&b.add(e)}for(d=0;d<c.size();d++)e=c.get(d),xc.findMoveToBottomDatas(a,b,e.getChildren())},findMoveToTopDatas:function(a,b,c){for(var d=0;d<c.size();d++){var e=c.get(c.size()-1-d);a.contains(e)&&b.add(e)}for(d=0;d<c.size();d++)e=c.get(d),xc.findMoveToTopDatas(a,b,e.getChildren())},findMoveUpDatas:function(a,b,c){for(var d=!1,e=0;e<c.size();e++){var f=c.get(e);a.contains(f)?d&&b.add(f):d=!0}for(e=0;e<c.size();e++)f=c.get(e),xc.findMoveUpDatas(a,b,f.getChildren())},findMoveDownDatas:function(a,b,c){for(var d=!1,e=0;e<c.size();e++){var f=c.get(c.size()-1-e);a.contains(f)?d&&b.add(f):d=!0}for(e=0;e<c.size();e++)f=c.get(e),xc.findMoveDownDatas(a,b,f.getChildren())},doLayout:function(a,b){b=b||{},b.type=b.type||"round",b.animate=b.animate||!0,b.elements=b.elements||new Gb.List,b.repulsion=b.repulsion||1,b.expandGroup=b.expandGroup||!1;var c=new Gb.layout.AutoLayouter(a.getElementBox());c.getElements=function(){}}};Hb.box=xc;var yc={scrollLeft:function(){return yc._filterResults(window.pageXOffset?window.pageXOffset:0,Mb.documentElement?Mb.documentElement.scrollLeft:0,Mb.body?Mb.body.scrollLeft:0)},scrollTop:function(){return yc._filterResults(window.pageYOffset?window.pageYOffset:0,Mb.documentElement?Mb.documentElement.scrollTop:0,Mb.body?Mb.body.scrollTop:0)},_filterResults:function(a,b,c){var d=a?a:0;return b&&(!d||d>b)&&(d=b),c&&(!d||d>c)?c:d},isSingleTouch:function(a){return a.touches&&1==a.touches.length},isMultiTouch:function(a){return a.touches&&a.touches.length>1},getDistance:function(a){if(!yc.isMultiTouch(a))return 0;var b=a.touches[0],c=a.touches[1];return Math.sqrt(Math.pow(b.clientX-c.clientX,2)+Math.pow(b.clientY-c.clientY,2))},getCenterLocation:function(a){if(!yc.isMultiTouch(a))return 0;var b=a.touches[0],c=a.touches[1];return{x:(b.clientX+c.clientX)/2,y:(b.clientY+c.clientY)/2}}};Hb.touch=yc;var zc={_string:function(a,b,c,d){var e=c._stringPool.get();e.style.whiteSpace="nowrap",e.style.verticalAlign="middle",e.style.padding="0px 2px",Hb.setText(e,a,d),e.setAttribute("title",a),b.appendChild(e)},_boolean:function(a,b,c){var d=c._booleanPool.get();b._editInfo?(d._editInfo=b._editInfo,delete b._editInfo,d.disabled=!1):d.disabled=!0,d.keepDefault=!0,d.type="checkbox",d.style.margin="0px 2px",d.style.verticalAlign="middle",d.checked=a,b.appendChild(d),""===b.style.textAlign&&(b.style.textAlign="center")},_color:function(a,b,c){var d=c._colorPool.get();d.style.width="100%",d.style.height="100%",d.style.backgroundColor=a,d.setAttribute("title",a),b.appendChild(d)},_listPoints:function(a,b,c,d){var e=c._stringPool.get();e.style.whiteSpace="nowrap",e.style.verticalAlign="middle",e.style.padding="0px 2px";var f=a._as||a,g="";f.forEach(function(a,b){g+=b==f.length-1?"["+a.x+","+a.y+"]":"["+a.x+","+a.y+"],"}),a=g,Hb.setText(e,a,d),e.setAttribute("title",a),b.appendChild(e)},render:function(a,b,c,d,e){if(null!=b){var f=zc["_"+a];f?f(b,c,d,e):"boolean"==typeof b?zc._boolean(b,c,d,e):b instanceof Gb.List?zc._listPoints(b,c,d,e):zc._string(b,c,d,e)}}};Hb.render=zc;var Ac={toolTipDiv:null,getToolTipDiv:function(){if(!Ac.toolTipDiv){Ac.toolTipDiv=Mb.createElement("div");var a=Dd,b=Ac.toolTipDiv.style;b.position="absolute",b.color=a.TOOLTIP_COLOR,b.background=a.TOOLTIP_BACKGROUND,b.fontSize=a.TOOLTIP_FONT_SIZE,b.padding=a.TOOLTIP_PADDING,b.border=a.TOOLTIP_BORDER,b.borderRadius=a.TOOLTIP_BORDER_RADIUS,b.boxShadow=a.TOOLTIP_BOX_SHADOW,b.zIndex=a.TOOLTIP_ZINDEX,b.setProperty&&b.setProperty("-webkit-box-shadow",a.TOOLTIP_BOX_SHADOW,null)}return Ac.toolTipDiv},isToolTipVisible:function(){return Ac.getToolTipDiv().parentNode?!0:!1},hideToolTip:function(){if(Ac._clearTimeout(),Ac._clearDismiss(),Ac.isToolTipVisible()){var a=Ac.getToolTipDiv();a.parentNode&&a.parentNode.removeChild(a)}},showToolTip:function(a,b,c){return a&&b?void(Ac.isToolTipVisible()||Ac._reshow_timeout?Ac._showToolTip(a,b,c):(Ac._clearTimeout(),Ac._show_timeout=setTimeout(function(){Ac._showToolTip(a,b,c)},Dd.TOOLTIP_INITIAL_DELAY))):void Ac.hideToolTip()},_showToolTip:function(a,b,c){var d,e,f;if(a.target?(d=a.clientX,e=a.clientY):(d=a.x,e=a.y),f=Ac.getToolTipDiv(),Ub.clear(f),b instanceof Element){var g=b.cloneNode(!0);f.appendChild(g)}else f.innerHTML=b;f.style.left=d+Dd.TOOLTIP_XOFFSET+"px",f.style.top=e+Dd.TOOLTIP_YOFFSET+"px",f.parentNode||Mb.body.appendChild(f),c&&c(f),Ac._clearDismiss(),Ac._dismiss_timeout=setTimeout(Ac.hideToolTip,Dd.TOOLTIP_DISMISS_DELAY),Ac._clearReshow(),Ac._reshow_timeout=setTimeout(Ac._clearReshow,Dd.TOOLTIP_RESHOW_DELAY)},_clearDismiss:function(){Ac._dismiss_timeout&&(clearTimeout(Ac._dismiss_timeout),Ac._dismiss_timeout=null)},_clearReshow:function(){Ac._reshow_timeout&&(clearTimeout(Ac._reshow_timeout),Ac._reshow_timeout=null)},_clearTimeout:function(){Ac._show_timeout&&(clearTimeout(Ac._show_timeout),Ac._show_timeout=null)},resetToolTip:function(){Ac.hideToolTip(),Ac.toolTipDiv=null}};Hb.popup=Ac;var Bc={handleClicked:function(a,b,c){if(!a.isSelectingElement()&&(Ob.isTouchable||0===b.button))if(c){var d=Cc(c);d&&d.onClick&&d.onClick(c,a),a.onClickElement(c,b),a.fireInteractionEvent({kind:"clickElement",event:b,element:c})}else a.onClickBackground(b),a.fireInteractionEvent({kind:"clickBackground",event:b})},handleDoubleClicked:function(a,b,c){if((Ob.isTouchable||0===b.button)&&!a.isEditingElement()){if(c){var d=Cc(c);d&&d.onDoubleClick&&d.onDoubleClick(c,a),a.onDoubleClickElement(c,b),a.fireInteractionEvent({kind:"doubleClickElement",event:b,element:c})}else a.onDoubleClickBackground(b),a.fireInteractionEvent({kind:"doubleClickBackground",event:b});c?c instanceof Gb.Link&&a.isDoubleClickToLinkBundle()?c.ISubNetwork&&a.isDoubleClickToSubNetwork()&&!Hb.isCtrlDown(b)?(a.isDoubleClickToEmptySubNetwork()||c.getChildrenSize()>0)&&a.setCurrentSubNetwork(c,a.isSubNetworkAnimate(),function(){a.fireInteractionEvent({kind:"enterSubNetwork",event:b,element:c})}):c.reverseBundleExpanded()&&a.fireInteractionEvent({kind:"bundleLink",event:b,element:c}):c.ISubNetwork&&a.isDoubleClickToSubNetwork()?(a.isDoubleClickToEmptySubNetwork()||c.getChildrenSize()>0)&&a.setCurrentSubNetwork(c,a.isSubNetworkAnimate(),function(){a.fireInteractionEvent({kind:"enterSubNetwork",event:b,element:c})}):c instanceof Nd&&a.isDoubleClickToGroupExpand()&&(c.reverseExpanded(),a.fireInteractionEvent({kind:"expandGroup",event:b,element:c})):a.isDoubleClickToUpSubNetwork()&&a.upSubNetwork(a.isSubNetworkAnimate(),function(){a.fireInteractionEvent({kind:"upSubNetwork",event:b})})}},handleKeyDown:function(a,b){Hb.isCtrlDown(b)&&65==b.keyCode?(a.isKeyboardSelectEnabled()&&a.selectAll().size()>0&&a.fireInteractionEvent({kind:"selectAll"}),Ub.preventDefault(b)):46==b.keyCode?(a.isKeyboardRemoveEnabled()&&a.removeSelection()&&a.fireInteractionEvent({kind:"removeElement"}),Ub.preventDefault(b)):Hb.showVersion(b)},handleLongClicked:function(a,b,c){if(Ob.isTouchable||0===b.button)if(c){var d=Cc(c);d&&d.onLongClick&&d.onLongClick(c,a),a.onLongClickElement(c,b),a.fireInteractionEvent({kind:"longClickElement",event:b,element:c})}else a.onLongClickBackground(b),a.fireInteractionEvent({kind:"longClickBackground",event:b})}},Cc=function(a){if(a&&a._image){if("object"==typeof a._image)return a._image;var b=Hb.getImageAsset(a._image);if(b)return b._image}return null};Hb.interaction=Bc;var Dc=function(a){return a.trim()[0].match(/[mlhvcsqta]/i)?Jc(a):Fc(a)},Ec={},Fc=function(a){var b=Ec[a];return b?b:(Ec[a]=b=[],a.trim().split(" ").forEach(function(a){a=a.split(","),b.push(2===a.length?{x:parseFloat(a[0]),y:parseFloat(a[1])}:a[0])}),b)},Gc={},Hc=/[mlhvcsqtaz][\d.,\-\s]*/gi,Ic=/-?(\d)+(\.(\d)+)?/g,Jc=function(a){var b,c=Gc[a];return c?c:(b=a.trim().match(Hc),Gc[a]=c=[],b&&b.forEach(function(a){var b,d=a[0],e=a.match(Ic),f=e&&e.length;if(c.push(a={c:d}),f)switch(e.forEach(function(a,b){e[b]=parseFloat(a)}),d){case"M":case"m":case"L":case"l":for(b=0;f>b;b+=2)0!==b&&c.push(a={c:"M"===d||"L"===d?"L":"l"}),a.x=e[b],a.y=e[b+1];break;case"H":case"h":for(b=0;f>b;b++)0!==b&&c.push(a={c:d}),a.x=e[b];break;case"V":case"v":for(b=0;f>b;b++)0!==b&&c.push(a={c:d}),a.y=e[b];break;case"C":case"c":for(b=0;f>b;b+=6)0!==b&&c.push(a={c:d}),a.x1=e[b],a.y1=e[b+1],a.x2=e[b+2],a.y2=e[b+3],a.x=e[b+4],a.y=e[b+5];break;case"S":case"s":for(b=0;f>b;b+=4)0!==b&&c.push(a={c:d}),a.x2=e[b],a.y2=e[b+1],a.x=e[b+2],a.y=e[b+3];break;case"Q":case"q":for(b=0;f>b;b+=4)0!==b&&c.push(a={c:d}),a.x1=e[b],a.y1=e[b+1],a.x=e[b+2],a.y=e[b+3];break;case"T":case"t":for(b=0;f>b;b+=2)0!==b&&c.push(a={c:d}),a.x=e[b],a.y=e[b+1]}}),c)},Kc=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o=a.transform&&Lc(a.transform);return o&&o.length&&(c=Qb.identity(),o.forEach(function(a){var b=a[0];"matrix"===b?c.multiply(new Qb(a[1],a[2],a[3],a[4],a[5],a[6])):"translate"===b?c.translate(a[1]||0,a[2]||0):"scale"===b?c.scale(a[1]||1,a[2]||a[1]||1):"rotate"===b?c.rotate(a[1]||0,a[2]||0,a[3]||0):"skewX"===b?c.skew(a[1]||0,0):"skewY"===b&&c.skew(0,a[1]||0)})),"linear"===a.type?(f=a.x1||0,g=a.y1||0,h=a.x2||0,i=a.y2||0,c&&(d=c.transform(f,g),f=d.x,g=d.y,d=c.transform(h,i),h=d.x,i=d.y),e=b.createLinearGradient(f,g,h,i)):"radial"===a.type&&(j=a.fx||0,k=a.fy||0,l=a.cx||0,m=a.cy||0,n=a.r||0,null==a.fx&&(j=l),null==a.fy&&(k=m),c&&(d=c.transform(j,k),j=d.x,k=d.y,d=c.transform(l,m),l=d.x,m=d.y,n=Math.max(c._m11,c._m22)*n),e=b.createRadialGradient(j,k,0,l,m,n)),e&&a.stop&&a.stop.length&&a.stop.forEach(function(a){e.addColorStop(parseFloat(a.offset),sd(a.color,b._color))}),e},Lc=function(a){return a.replace(/[\s\r\t\n]+/gm," ").trim().replace(/\)(\s?,\s?)/g,") ").split(/\s(?=[a-z])/).map(function(a){return a.replace(")","").trim().split(/\s*\(\s*|\s+,?\s*|,\s*/).map(function(a,b){return 0===b?a:parseFloat(a)})})},Mc=Gb.Util.drawImage=function(a,b,c,d,e,f,g){var h,i,j,k,l=1;"object"!=typeof b&&(i=b,h=Hb.images[b],b=h&&h.getImage()),bd(b)?a.drawImage(h?h.getImage(c,d.width,d.height):b,d.x,d.y,d.width,d.height):b&&"object"==typeof b&&(a._data=e,a._view=f,i?(j=d.width/(b.w&&Xc(e,b,b,"w")||e.getWidth()),k=d.height/(b.h&&Xc(e,b,b,"h")||e.getHeight()),f&&(l=f.getSizeZoom?f.getSizeZoom()*f.getGraphicsZoom():f.getZoom()),!h._cache||Math.max(j*l,k*l)>1?Nc(a,b,c,d,e,f,g):a.drawImage(c?h.getImage(c,d.width,d.height):h._cache,d.x,d.y,d.width,d.height)):Nc(a,b,c,d,e,f,g),a._data=null,a._view=null)},Nc=function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=e&&e.getStyle("image.state");if(p=a._vector,w=a._color,q=a._fill,r=a._pattern,s=a._lineWidth,t=a._alpha,u=a._sx,v=a._sy,m=b,Xc(e,m,m,"visible",f)!==!1){for(a._color=c,h=Xc(e,m,m,"v",f),i=h&&h.length,y=m.w&&Xc(e,m,m,"w")||e.getWidth(),z=m.h&&Xc(e,m,m,"h")||e.getHeight(),n=d.width/y,o=d.height/z,g===!0?(a._fill=null,a._pattern=null,a._lineWidth=null,a._alpha=null):(a._sx=n,a._sy=o),a.save(),a.translate(d.x+d.width/2,d.y+d.height/2),(1!==n||1!==o)&&a.scale(n,o),m.origin&&a.translate((m.origin.x-.5)*y,(m.origin.y-.5)*z),a._vector=m,m.clip&&(a.beginPath(),m.clip===!0?a.rect(-(m.origin?m.origin.x:.5)*y,-(m.origin?m.origin.y:.5)*z,y,z):m.clip.length?m.clip.forEach(function(b){a.drawShape(b)}):a.drawShape(m.clip),a.clip()),Sc(e,m,m,a,f),j=0,i=h.length;i>j;j++)l=h[j],a._shapeData=l,f&&(f._shapeDataIndex=j,l.animate&&ub(l,m,e,f)),x=Xc(e,m,l,"state",f),Xc(e,m,l,"visible",f)===!1||x&&!(Array.isArray(x)?x.indexOf(A)>=0:x===A)||(k=Pc[l.shape],k&&(a.save(),"vector"===l.shape||"g"===l.shape?k(a,l,e,f):Sc(e,m,l,a,f,function(){k(a,l,e,f)}),a.restore())),f&&(f._shapeDataIndex=null),a._shapeData=null;a.restore(),a._vector=p,a._shapeData=null,a._color=w,a._fill=q,a._pattern=r,a._lineWidth=s,a._alpha=t,a._sx=u,a._sy=v}},Oc=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o=a._vector,p=o.origin,q=o.w&&Xc(d,o,o,"w")||d.getWidth(),r=o.h&&Xc(d,o,o,"h")||d.getHeight();if("string"==typeof b?(n=Hb.images[b],n&&(h=n.getWidth(),i=n.getHeight())):(h=b.w&&Xc(d,b,b,"w"),i=b.h&&Xc(d,b,b,"h")),h&&i&&c)for(j=c.w/h*a._sx,k=c.h/i*a._sy,f=c.x-q/2*(a._sx-1),g=c.y-r/2*(a._sy-1),p&&(f-=(p.x-.5)*q*(a._sx-1),g-=(p.y-.5)*r*(a._sy-1)),(1!==a._sx||1!==a._sy)&&(a.scale(1/a._sx,1/a._sy),f+=((p?p.x:.5)*q+c.x)*(a._sx-1),g+=((p?p.x:.5)*r+c.y)*(a._sy-1)),c={x:0,y:0,width:h,height:i},l=0;j>l;l++)for(m=0;k>m;m++)c.x=l*h+f,c.y=m*i+g,Mc(a,b,null,c,d,e,!0)},Pc={line:function(a,b,c,d){var e,f,g,h,i=Xc(c,a._vector,b,"p1",d),j=Xc(c,a._vector,b,"p2",d);i?(e=Yc(i.length?i[0]:i.x,a),f=Zc(i.length?i[1]:i.y,a)):(e=Xc(c,a._vector,b,"x1",d,!0),f=Xc(c,a._vector,b,"y1",d,!1)),j?(g=Yc(j.length?j[0]:j.x,a),h=Zc(j.length?j[1]:j.y,a)):(g=Xc(c,a._vector,b,"x2",d,!0),h=Xc(c,a._vector,b,"y2",d,!1)),a.moveTo(e,f),a.lineTo(g,h)},rect:function(a,b,c,d){var e,f,g,h,i=Xc(c,a._vector,b,"rect",d),j=Xc(c,a._vector,b,"r",d);i?(Array.isArray(i)?(e=i[0],f=i[1],g=i[2],h=i[3]):(e=i.x,f=i.y,g=i.w,h=i.h),e=Yc(e,a),f=Zc(f,a),g=Yc(g,a),h=Zc(h,a)):(e=Xc(c,a._vector,b,"x",d,!0),f=Xc(c,a._vector,b,"y",d,!1),g=Xc(c,a._vector,b,"w",d,!0),h=Xc(c,a._vector,b,"h",d,!1)),a.drawRoundRect(e,f,g,h,j),(a._gradientFunc||a._pattern)&&(a._rect={x:e,y:f,w:g,h:h})},circle:function(a,b,c,d){var e=Xc(c,a._vector,b,"cx",d,!0),f=Xc(c,a._vector,b,"cy",d,!1),g=a._vector.w&&Xc(c,a._vector,a._vector,"w")||c.getWidth(),h=a._vector.h&&Xc(c,a._vector,a._vector,"h")||c.getHeight(),i=$c(Xc(c,a._vector,b,"r",d),Math.min(g,h),b,a._vector),j=Xc(c,a._vector,b,"startAngle",d),k=Xc(c,a._vector,b,"endAngle",d),l=Xc(c,a._vector,b,"anticlockwise",d),m=Xc(c,a._vector,b,"close",d);null==j&&(j=0),null==k&&(k=360),null==l&&(l=!1),m&&a.moveTo(e,f),a.arc(e,f,i,j/180*Math.PI,k/180*Math.PI,l),m&&a.closePath(),(a._gradientFunc||a._pattern)&&(a._rect={x:e-i,y:f-i,w:2*i,h:2*i})},ellipse:function(a,b,c,d){var e=Xc(c,a._vector,b,"cx",d,!0),f=Xc(c,a._vector,b,"cy",d,!1),g=Xc(c,a._vector,b,"rx",d,!0),h=Xc(c,a._vector,b,"ry",d,!1),i=Xc(c,a._vector,b,"startAngle",d),j=Xc(c,a._vector,b,"endAngle",d),k=Xc(c,a._vector,b,"anticlockwise",d),l=Xc(c,a._vector,b,"close",d);

null==i&&(i=0),null==j&&(j=360),null==k&&(k=!1),l&&a.moveTo(e,f),a.ellipse(e,f,g,h,0,i/180*Math.PI,j/180*Math.PI,k),l&&a.closePath(),(a._gradientFunc||a._pattern)&&(a._rect={x:e-g,y:f-h,w:2*g,h:2*h})},path:function(a,b,c,d){var e=Xc(c,a._vector,b,"data",d);a.drawPath(e)},text:function(a,b,c,d){var e=Xc(c,a._vector,b,"text",d),f=Xc(c,a._vector,b,"x",d,!0),g=Xc(c,a._vector,b,"y",d,!1),h=Xc(c,a._vector,b,"w",d,!0);if(null!=e){e=String(e);var i=e.split("\n"),j=2*a.measureText("e").width,k=tb(a,e,h);g-=(k.h/j-1)/2*j,i.forEach(function(b){if(h){var c,d,e,i,k,l=b.split(" "),m=l.length,n="";for(e=0;m>e;e++)if(c=l[e]+(e===m-1?"":" "),d=n+c,i=a.measureText(d).width,h>i)n=d;else if(i==h)a.fillText(n,f,g),n="",g+=j;else{for(k=0;k<c.length;k++)if(d=n+c.substr(0,k+1),a.measureText(d).width>h){a.fillText(d.substring(0,d.length-1),f,g),n=c.substring(k,c.length),g+=j;break}for(;n.length>0&&a.measureText(n).width>h;)for(k=0;k<n.length;k++)if(d=n.substr(0,k+1),a.measureText(d).width>h){a.fillText(n.substr(0,k),f,g),n=n.substring(k,n.length),g+=j;break}}a.fillText(n,f,g)}else a.fillText(b,f,g);g+=j})}},draw:function(a,b,c,d){var e,f,g=b.draw;"string"==typeof g&&((e=g.match(Vc))?(f="with(data) { "+e[1]+" }",g=Gb.Util.newFunction("g","data","view",f)):g=cd[g]),"function"==typeof g&&g.call(a._vector,a,c,d)},vector:function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r=a._vector,s=Xc(c,r,b,"name",d),t=Xc(c,r,b,"x",d,!0),u=Xc(c,r,b,"y",d,!1),v=Xc(c,r,b,"w",d),w=Xc(c,r,b,"h",d);if("string"==typeof s?(l=Hb.images[s],k=l&&l._image):k=s,k)if(bd(k))null!=v&&null!=w?a.drawImage(k,t,u,Yc(v,a),Zc(w,a)):a.drawImage(k,t,u);else{for(m=Xc(c,k,k,"v",d),n=m&&m.length,o=k.w&&Xc(c,k,k,"w"),p=k.h&&Xc(c,k,k,"h"),null!=v&&null!=w?(v=Yc(v,a),w=Zc(w,a)):(v=o,w=p),a.save(),h=a._lineWidth,i=a._fill,j=a._alpha,Sc(c,k,k,a,d),Sc(c,r,b,a,d),a.translate(t,u),a.scale(v/o,w/p),k.origin&&a.translate((k.origin.x-.5)*o,(k.origin.y-.5)*p),k.clip&&(a.beginPath(),k.clip===!0?a.rect(-(k.origin?k.origin.x:.5)*o,-(k.origin?k.origin.y:.5)*p,o,p):k.clip.length?k.clip.forEach(function(b){a.drawShape(b)}):a.drawShape(k.clip),a.clip()),q=a._shapeData,a._vector=k,e=0;n>e;e++)f=m[e],a._shapeData=f,d&&(d._shapeDataIndex.length?d._shapeDataIndex.push(e):d._shapeDataIndex=[d._shapeDataIndex,e],f.animate&&ub(f,r,c,d)),Xc(c,k,f,"visible",d)!==!1&&(g=Pc[f.shape],g&&(a.save(),"vector"===f.shape||"g"===f.shape?g(a,f,c,d):Sc(c,k,f,a,d,function(){g(a,f,c,d)}),a.restore())),d&&d._shapeDataIndex.pop();a._vector=r,a._shapeData=q,a._lineWidth=h,a._fill=i,a._alpha=j,a.restore()}},g:function(a,b,c,d){var e,f,g,h,i,j=Xc(c,a._vector,b,"v",d);j&&j.length&&(a.save(),f=a._lineWidth,g=a._fill,h=a._alpha,i=a._shapeData,Sc(c,a._vector,b,a,d),j.forEach(function(b){Xc(c,a._vector,b,"visible",d)!==!1&&(e=Pc[b.shape],e&&(a.save(),a._shapeData=b,"vector"===b.shape||"g"===b.shape?e(a,b,c,d):Sc(c,a._vector,b,a,d,function(){e(a,b,c,d)}),a.restore()))}),a._lineWidth=f,a._fill=g,a._alpha=h,a._shapeData=i,a.restore())}};Pc.image=Pc.vector;var Qc=Object.keys(Pc),Rc={M:function(a,b){return a.moveTo(b.x,b.y),a._path_start=b,a._rect&&ad(a._rect,b.x,b.y),b},m:function(a,b,c){return c&&(b={x:c.x+b.x,y:c.y+b.y}),a.moveTo(b.x,b.y),a._path_start=b,a._rect&&ad(a._rect,b.x,b.y),b},Z:function(a){return a.closePath(),a._path_start},z:function(a){return a.closePath(),a._path_start},L:function(a,b){return a.lineTo(b.x,b.y),a._rect&&ad(a._rect,b.x,b.y),b},l:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y};return a.lineTo(d.x,d.y),a._rect&&ad(a._rect,d.x,d.y),d},H:function(a,b,c){var d={x:b.x,y:c.y};return a.lineTo(d.x,d.y),a._rect&&ad(a._rect,d.x,d.y),d},h:function(a,b,c){var d={x:c.x+b.x,y:c.y};return a.lineTo(d.x,d.y),a._rect&&ad(a._rect,d.x,d.y),d},V:function(a,b,c){var d={x:c.x,y:b.y};return a.lineTo(d.x,d.y),a._rect&&ad(a._rect,d.x,d.y),d},v:function(a,b,c){var d={x:c.x,y:c.y+b.y};return a.lineTo(d.x,d.y),a._rect&&ad(a._rect,d.x,d.y),d},Q:function(a,b){return a._preQ_x=b.x1,a._preQ_y=b.y1,a.quadraticCurveTo(b.x1,b.y1,b.x,b.y),a._rect&&(ad(a._rect,b.x1,b.y1),ad(a._rect,b.x,b.y)),b},q:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y},e=a._preQ_x=c.x+b.x1,f=a._preQ_y=c.y+b.y1;return a.quadraticCurveTo(e,f,d.x,d.y),a._rect&&(ad(a._rect,e,f),ad(a._rect,d.x,d.y)),d},T:function(a,b,c){var d=a._preQ_x=2*c.x-a._preQ_x,e=a._preQ_y=2*c.y-a._preQ_y;return a.quadraticCurveTo(d,e,b.x,b.y),a._rect&&(ad(a._rect,d,e),ad(a._rect,b.x,b.y)),b},t:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y},e=a._preQ_x=2*c.x-a._preQ_x,f=a._preQ_y=2*c.y-a._preQ_y;return a.quadraticCurveTo(e,f,d.x,d.y),a._rect&&(ad(a._rect,e,f),ad(a._rect,d.x,d.y)),d},C:function(a,b){return a._preC_x=b.x2,a._preC_y=b.y2,a.bezierCurveTo(b.x1,b.y1,b.x2,b.y2,b.x,b.y),a._rect&&(ad(a._rect,b.x1,b.y1),ad(a._rect,b.x2,b.y2),ad(a._rect,b.x,b.y)),b},c:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y},e=c.x+b.x1,f=c.y+b.y1,g=a._preC_x=c.x+b.x2,h=a._preC_y=c.y+b.y2;return a.bezierCurveTo(e,f,g,h,d.x,d.y),a._rect&&(ad(a._rect,e,f),ad(a._rect,g,h),ad(a._rect,d.x,d.y)),d},S:function(a,b,c){var d=2*c.x-a._preC_x,e=2*c.y-a._preC_y;return a._preC_x=b.x2,a._preC_y=b.y2,a.bezierCurveTo(d,e,b.x2,b.y2,b.x,b.y),a._rect&&(ad(a._rect,d,e),ad(a._rect,b.x2,b.y2),ad(a._rect,b.x,b.y)),b},s:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y},e=2*c.x-a._preC_x,f=2*c.y-a._preC_y,g=a._preC_x=c.x+b.x2,h=a._preC_y=c.y+b.y2;return a.bezierCurveTo(e,f,g,h,d.x,d.y),a._rect&&(ad(a._rect,e,f),ad(a._rect,g,h),ad(a._rect,d.x,d.y)),d}},Sc=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t=Xc(a,b,c,"line",e),u=Xc(a,b,c,"fill",e),v=Xc(a,b,c,"fillRule",e)||"nonzero",w=Xc(a,b,c,"gradient",e),x=Xc(a,b,c,"gradientColor",e),y=Xc(a,b,c,"pattern",e),z=Xc(a,b,c,"font",e),A=Xc(a,b,c,"textAlign",e)||"center",B=Xc(a,b,c,"textBaseline",e)||"middle",C=Xc(a,b,c,"translate",e),D=Xc(a,b,c,"rotate",e),E=Xc(a,b,c,"rotateOrigin",e),F=Xc(a,b,c,"scale",e),G=Xc(a,b,c,"transform",e),H=Xc(a,b,c,"alpha",e),I=d._lineWidth,J=d._fill,K=d._pattern,L=d._alpha,M=d._gradientFunc;if(t?(g=t.color,h=t.width,i=t.cap,j=t.join,k=t.miterLimit,l=t.dash,m=t.dashOffset):(g=Xc(a,b,c,"lineColor",e),h=Xc(a,b,c,"lineWidth",e),i=Xc(a,b,c,"lineCap",e),j=Xc(a,b,c,"lineJoin",e),k=Xc(a,b,c,"miterLimit",e),l=Xc(a,b,c,"lineDash",e),m=Xc(a,b,c,"lineDashOffset",e)),null!=g&&(d.strokeStyle=sd(g,d._color)),null!=h&&(d.lineWidth=d._lineWidth=e&&e.getSizeZoom&&!e.zoomManager.sizeChange?h/e.getSizeZoom():h),null!=i&&(d.lineCap=i),null!=j&&(d.lineJoin=j),null!=k&&(d.miterLimit=k),null!=l&&(d.lineDash=l,d.setLineDash(l)),null!=m&&(d.lineDashOffset=m),y?d._pattern=y:(u&&(d.fillStyle=d._fill=sd(u,d._color)),w&&("string"==typeof w?o=Wb[w]:(o=Wb[w.type],w.color&&(x=w.color),o||(w=Kc(w,d))),d._gradientFunc=o)),null!=z&&(d.font=z),null!=A&&(d.textAlign=A),null!=B&&(d.textBaseline=B),Tc(a,b,c,d,e),null!=G)"string"==typeof G&&(G=Lc(G)),G.length&&G.forEach(function(a){var b=a[0];"matrix"===b?d.transform(a[1],a[2],a[3],a[4],a[5],a[6]):"translate"===b?d.translate(a[1]||0,a[2]||0):"scale"===b?d.scale(a[1]||1,a[2]||a[1]||1):"rotate"===b?a.length>2?(d.translate(a[2],a[3]),d.rotate(a[1]),d.translate(-a[2],-a[3])):d.rotate(a[1]):"skewX"===b?d.transform(1,0,Math.tan(a[1]*Math.PI/180),1,0,0):"skewY"===b&&d.transform(1,Math.tan(a[1]*Math.PI/180),0,1,0,0)});else{if(null!=C&&(Array.isArray(C)?(r=C[0],s=C[1]):"object"==typeof C?(r=C.x,s=C.y):(r=C,s=0),r=Yc(r,d),s=Zc(s,d),(0!==r||0!==s)&&d.translate(r,s)),null!=D&&D%360!==0){var N,O;E&&(Array.isArray(E)?(N=E[0],O=E[1]):"object"==typeof E?(N=E.x,O=E.y):N=O=E,N=Yc(N,d),O=Zc(O,d),(0!==N||0!==O)&&d.translate(N,O)),d.rotate(D*Math.PI/180),E&&(0!==N||0!==O)&&d.translate(-N,-O)}null!=F&&(Array.isArray(F)?(p=F[0],q=F[1]):"object"==typeof F?(p=F.x,q=F.y):p=q=F,(1!==p||1!==q)&&d.scale(p,q))}null!=H&&(d.globalAlpha=d._alpha=null!=L?L*H:H),f&&(d.beginPath(),f(),n=d._rect||c.rect,d._pattern?(d._lineWidth>0&&d.stroke(),d.clip(),Oc(d,d._pattern,n,a,e)):(o&&n&&(w=o(d,sd(u||"#000000",d._color),sd(x||"#FFFFFF",d._color),n.x,n.y,n.w,n.h)),w&&(d.fillStyle=d._fill=w),d._fill&&d.fill(v),d._lineWidth>0&&d.stroke()),d._lineWidth=I,d._fill=J,d._pattern=K,d._alpha=L,d._gradientFunc=M,d._rect=null)},Tc=function(a,b,c,d,e){var f,g,h,i,j=Xc(a,b,c,"shadow",e);j?(f=j.offsetX,g=j.offsetY,h=j.blur,i=j.color):(f=Xc(a,b,c,"shadowOffsetX",e),g=Xc(a,b,c,"shadowOffsetY",e),h=Xc(a,b,c,"shadowBlur",e),i=Xc(a,b,c,"shadowColor",e)),null!=f&&(d.shadowOffsetX=f),null!=g&&(d.shadowOffsetY=g),null!=h&&(d.shadowBlur=h),null!=i&&(d.shadowColor=i)},Uc=/<%=([\s\S]+?)%>/,Vc=/<%([\s\S]+?)%>/,Wc=new RegExp([Uc.source,Vc.source].join("|")),Xc=function(a,b,c,d,e,f,g){var h,i,j,k,l,m=c[d],n=typeof m;if("string"===n&&(h=m.match(Wc))?(i="with(data) { "+(h[1]?"return "+h[1]:h[2])+" }",j=Gb.Util.newFunction("data","view",i),m=j.call(b,a,e)):"function"===n&&(m=m.call(b,a,e)),f===!0?(k=b.w&&Xc(a,b,b,"w")||a.getWidth(),(c.rel===!0||void 0===c.rel&&b.rel)&&1>=m&&m>=-1?m*=k:"string"==typeof m&&(m=parseInt(m)/100*k),m=m||0):f===!1&&(l=b.h&&Xc(a,b,b,"h")||a.getHeight(),(c.rel===!0||void 0===c.rel&&b.rel)&&1>=m&&m>=-1?m*=l:"string"==typeof m&&(m=parseInt(m)/100*l),m=m||0),g!==!1&&e&&a&&c.animate&&a._animates){var o,p=a._animates,q=e._shapeDataIndex;if(q.length)for(var r=0;r<q.length;r++)o=q[r],p=p[o];else o=q;var s=p[o],t=s[d];if(t)if(Array.isArray(t))for(var r=t.length-1;r>=0;r--){var u=t[r];if((u.stopped||u.time>0)&&u.started)return Fb(u,m)}else if(t.started)return Fb(t,m)}return m},Yc=function(a,b){if(!a)return 0;var c=b._vector.w&&Xc(b._data,b._vector,b._vector,"w")||b._data.getWidth();return(b._shapeData&&b._shapeData.rel===!0||(!b._shapeData||void 0===b._shapeData.rel)&&b._vector.rel)&&1>=a&&a>=-1?a*c:"string"==typeof a?parseInt(a)/100*c:a},Zc=function(a,b){if(!a)return 0;var c=b._vector.h&&Xc(b._data,b._vector,b._vector,"h")||b._data.getHeight();return(b._shapeData&&b._shapeData.rel===!0||(!b._shapeData||void 0===b._shapeData.rel)&&b._vector.rel)&&1>=a&&a>=-1?a*c:"string"==typeof a?parseInt(a)/100*c:a},$c=function(a,b,c,d){return a?(c.rel===!0||void 0===c.rel&&d.rel)&&1>=a&&a>=-1?a*b:"string"==typeof a?parseInt(a)/100*b:a:0},_c=(window.CanvasRenderingContext2D||Jb.Context2d).prototype;_c.drawShape=function(a){var b=this,c=b._vector,d=b._shapeData,e=b._data,f=b._view,g=Pc[a.shape];g&&(b.save(),b._shapeData=a,"vector"===a.shape||"g"===a.shape?g(b,a,e,f):Sc(e,c,a,b,f,function(){g(b,a,e,f)}),b._shapeData=d,b.restore())},_c.drawPath=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=this;if("string"==typeof a&&(a=Dc(a)),j=a?a.length:0,!(1>=j)){if((n._gradientFunc||n._pattern)&&(n._rect=k={x:0,y:0,w:0,h:0}),b=a&&a[0]&&a[0].c,b||(c=a&&a[0]&&null!=a[0].x,d="z"===a[j-1]||"Z"===a[j-1],d&&j--),b){for(e=0;j>e;e++)g=a[e],h=Rc[g.c],h&&(f=h(n,g,f));n._path_start=null,n._preC_x=null,n._preC_y=null,n._preQ_x=null,n._preQ_y=null}else if(c){for(i=a[0],l=Yc(i.x,n),m=Zc(i.y,n),n.moveTo(l,m),k&&ad(k,l,m),e=1;j>e;e++)i=a[e],l=Yc(i.x,n),m=Zc(i.y,n),n.lineTo(l,m),k&&ad(k,l,m);d&&n.closePath()}else{for(l=Yc(a[0],n),m=Zc(a[1],n),n.moveTo(l,m),k&&ad(k,l,m),e=2;j>e;e+=2)l=Yc(a[e],n),m=Zc(a[e+1],n),n.lineTo(l,m),k&&ad(k,l,m);d&&n.closePath()}return a}};var ad=function(a,b,c){var d=Math.min(a.x,b),e=Math.max(a.x+a.w,b),f=Math.min(a.y,c),g=Math.max(a.y+a.h,c);a.x=d,a.y=f,a.w=e-d,a.h=g-f};_c._fillPath=function(a,b){var c=this;c.beginPath(),c.fillStyle=a,c.drawPath(b),c.fill()},_c._fillRect=function(a,b,c,d,e){var f=this;f.beginPath(),f.fillStyle=a,f.rect(b,c,d,e),f.fill()},_c.ellipse||(_c.ellipse=function(a,b,c,d){var e=this,f=.5522848,g=c*f,h=d*f,i=a+c,j=b+d,k=a-c,l=b-d;e.moveTo(k,b),e.bezierCurveTo(k,b-h,a-g,l,a,l),e.bezierCurveTo(a+g,l,i,b-h,i,b),e.bezierCurveTo(i,b+h,a+g,j,a,j),e.bezierCurveTo(a-g,j,k,b+h,k,b)}),_c.drawRoundRect=function(a,b,c,d,e){var f=this;if(!e)return void f.rect(a,b,c,d);var g,h,i,j;if(Array.isArray(e))if(1===e.length)g=h=i=j=e[0];else if(2===e.length)g=h=e[0],i=j=e[1];else{if(4!==e.length)return void f.rect(a,b,c,d);g=e[0],h=e[1],i=e[2],j=e[3]}else g=h=i=j=e;var k=a+c,l=b+d,m=d>c?2*c:2*d;g=m>g?g:m,h=m>h?h:m,i=m>i?i:m,j=m>j?j:m;var n=.292893218813453*j,o=.585786437626905*j;f.moveTo(k,l-j),f.quadraticCurveTo(k,l-o,k-n,l-n),f.quadraticCurveTo(k-o,l,k-j,l),n=.292893218813453*i,o=.585786437626905*i,f.lineTo(a+i,l),f.quadraticCurveTo(a+o,l,a+n,l-n),f.quadraticCurveTo(a,l-o,a,l-i),n=.292893218813453*g,o=.585786437626905*g,f.lineTo(a,b+g),f.quadraticCurveTo(a,b+o,a+n,b+n),f.quadraticCurveTo(a+o,b,a+g,b),n=.292893218813453*h,o=.585786437626905*h,f.lineTo(k-h,b),f.quadraticCurveTo(k-o,b,k-n,b+n),f.quadraticCurveTo(k,b+o,k,b+h),f.lineTo(k,l-j)};var bd=function(a){return Jb?a instanceof Jb||a instanceof Nb:a instanceof HTMLImageElement||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement},cd={},dd=function(a,b){"function"==typeof b&&(cd[a]=b)},ed=function(a,b){"function"==typeof b&&Qc.indexOf(a)<0&&(Pc[a]=b)};!function(){for(var a=["webkit","moz"],b=0;b<a.length&&!window.requestAnimationFrame;++b){var c=a[b];window.requestAnimationFrame=window[c+"RequestAnimationFrame"],window.cancelAnimationFrame=window[c+"CancelAnimationFrame"]||window[c+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var d=0;window.requestAnimationFrame=function(a){var b=Date.now(),c=Math.max(d+16,b);return setTimeout(function(){a(d=c)},c-b)},window.cancelAnimationFrame=clearTimeout}}();var fd=Gb.Animate=function(a){var b=this;b.type=null==a.type?"number":a.type,b.delay=null==a.delay?0:a.delay,b.dur=null==a.dur?1e3:a.dur,b.interval=null==a.interval?0:a.interval,b.finish=null==a.finish?b.delay+b.dur+b.interval:a.finish,null==a.finish?b.finish=b.delay+b.dur+b.interval:(b.finish=a.finish,b.interval=b.finish-b.delay-b.dur),b.repeat=null==a.repeat?1:a.repeat,b.reverse=null==a.reverse?!0:a.reverse,b.easing=null==a.easing?"easeNone":a.easing,b.onUpdate=a.onUpdate,b.onDone=a.onDone,b.onStop=a.onStop,b.onPlay=a.onPlay,b.attr=a.attr,b.source=a.source,b.filter=a.filter,b.from=a.from,b.to=a.to,b.start=null,b.time=0,b.total=0,b.count=0,b.started=!1,b.stopped=!1,b.paused=!1,b.pausedTime=null,b.pausedTotal=0,b._speed=1,b._oldSpeed=null,b._speedTotal=0,b._speedTime=null,b._percent=0,b._percentSet=null,b._percentDiff=0,b.id=hd++};Hb.ext("twaver.Animate",Object,{play:function(){return wb(this)},stop:function(a){return xb(this,a)},pause:function(){this.stopped||(this.paused=!0)},resume:function(){this.paused&&(this.paused=!1,id=!0)},isPaused:function(){return this.paused},percent:function(a){return null==a?this._percentSet||this._percent:(this._percentSet=0>a?0:a>100?100:a,this.paused&&(id=!0),this.started||(this.play(),this.pause()),this)},speed:function(a){return null==a?this._speed:(a=0>a?1:a,a!==this.speed&&(this.stopped||(this._oldSpeed=this._speed),this._speed=a),this)},clone:function(){return new fd(this)},chain:function(a){var b,c=this;return c.next=a,a.pre=c,c.onDone?(b=c.onDone,c.onDone=function(){b.call(c),a.play()}):c.onDone=function(){a.play()},c}});var gd={},hd=1,id=!1;!function Nf(a){Gb.animateLoopId=requestAnimationFrame(Nf),id&&(id=!1,Bb(a))}(0);var jd={easeNone:function(a,b,c,d){return c*a/d+b},easeIn:function(a,b,c,d){return c*(a/=d)*a+b},easeOut:function(a,b,c,d){return-c*(a/=d)*(a-2)+b},easeBoth:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},easeInStrong:function(a,b,c,d){return c*(a/=d)*a*a*a+b},easeOutStrong:function(a,b,c,d){return-c*((a=a/d-1)*a*a*a-1)+b},easeBothStrong:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a*a+b:-c/2*((a-=2)*a*a*a-2)+b},elasticIn:function(a,b,c,d,e,f){var g;return 0===a?b:1===(a/=d)?b+c:(f||(f=.3*d),!e||e<Math.abs(c)?(e=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/e),-(e*Math.pow(2,10*(a-=1))*Math.sin(2*(a*d-g)*Math.PI/f))+b)},elasticOut:function(a,b,c,d,e,f){var g;return 0===a?b:1===(a/=d)?b+c:(f||(f=.3*d),!e||e<Math.abs(c)?(e=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/e),e*Math.pow(2,-10*a)*Math.sin(2*(a*d-g)*Math.PI/f)+c+b)},elasticBoth:function(a,b,c,d,e,f){var g;return 0===a?b:2===(a/=d/2)?b+c:(f||(f=.3*d*1.5),!e||e<Math.abs(c)?(e=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/e),1>a?-.5*e*Math.pow(2,10*(a-=1))*Math.sin(2*(a*d-g)*Math.PI/f)+b:e*Math.pow(2,-10*(a-=1))*Math.sin(2*(a*d-g)*Math.PI/f)*.5+c+b)},backIn:function(a,b,c,d,e){return void 0===e&&(e=1.70158),a===d&&(a-=.001),c*(a/=d)*a*((e+1)*a-e)+b},backOut:function(a,b,c,d,e){return"undefined"==typeof e&&(e=1.70158),c*((a=a/d-1)*a*((e+1)*a+e)+1)+b},backBoth:function(a,b,c,d,e){return"undefined"==typeof e&&(e=5.70158),(a/=d/2)<1?c/2*a*a*(((e*=1.525)+1)*a-e)+b:c/2*((a-=2)*a*(((e*=1.525)+1)*a+e)+2)+b},bounceIn:function(a,b,c,d){return c-jd.bounceOut(d-a,0,c,d)+b},bounceOut:function(a,b,c,d){return(a/=d)<1/2.75?7.5625*c*a*a+b:2/2.75>a?c*(7.5625*(a-=1.5/2.75)*a+.75)+b:2.5/2.75>a?c*(7.5625*(a-=2.25/2.75)*a+.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+.984375)+b},bounceBoth:function(a,b,c,d){return d/2>a?.5*jd.bounceIn(2*a,0,c,d)+b:.5*jd.bounceOut(2*a-d,0,c,d)+.5*c+b}},kd={draw:function(a,b){var c=null==b.getCurrentSubNetwork()?b.getElementBox():b.getCurrentSubNetwork(),d=c.getStyle("background.type");"image"==d?this.drawImage(a,c,b):"vector"==d?this.drawVector(a,c,b):"image.vector"==d?(this.drawImage(a,c,b),this.drawVector(a,c,b)):"vector.image"==d&&(this.drawVector(a,c,b),this.drawImage(a,c,b))},drawImage:function(a,b,c){var d=b.getStyle("background.image"),e=Hb.getImageAsset(d),f=c.getGraphicsZoom?c.getGraphicsZoom():c.getZoom();if(null!=e){var g=b.getStyle("background.image.scope"),h=c.getScopeRect(g),i=c._dragToPan?0:-h.x/f,j=c._dragToPan?0:-h.y/f;("rootcanvas"==g||"viewport"==g)&&(h.x=i,h.y=j),"rootcanvas"==g&&(h.width=Math.max(e.getWidth(),h.width/f),h.height=Math.max(e.getHeight(),h.height/f)),"none"==b.getStyle("background.image.stretch")&&(h.width=e.getWidth(),h.height=e.getHeight());var k=b.getStyle("background.image.padding");if(k&&Rb.grow(h,k,k),"tile"==b.getStyle("background.image.stretch")){if(bd(e.getImage()))for(var l=0;l<h.width;l+=e.getWidth())for(var m=0;m<h.height;m+=e.getHeight())a.drawImage(e.getImage(),l,m)}else("fill"==b.getStyle("background.image.stretch")||"none"==b.getStyle("background.image.stretch"))&&Mc(a,e.getImage(),null,h,b,c)}},drawVector:function(a,b,c){var d=b.getStyle("background.vector.scope"),e=c.getScopeRect(d),f=c.getGraphicsZoom?c.getGraphicsZoom():c.getZoom(),g=c._dragToPan?0:-e.x/f,h=c._dragToPan?0:-e.y/f;("rootcanvas"==d||"viewport"==d)&&(e.x=g,e.y=h),"rootcanvas"==d&&(e.width=e.width/f,e.height=e.height/f);var i=b.getStyle("background.outline.width"),j=(b.getStyle("background.outline.color"),b.getStyle("background.vector.fill")),k=b.getStyle("background.vector.fill.color"),l=b.getStyle("background.vector.padding"),m=b.getStyle("background.vector.shape"),n=b.getStyle("background.vector.pattern");l&&Rb.grow(e,l,l);var o=b.getStyle("background.vector.gradient");j&&(o?Vb.fill(a,k,o,b.getStyle("background.vector.gradient.color"),e):a.fillStyle=k,Vb.drawVector(a,m,n,e),a.fill()),i>0&&(a.lineWidth=i,a.strokeStyle=b.getStyle("background.outline.color"),Vb.drawVector(a,m,n,e),a.stroke())}},ld=Gb.UndoManager=function(a){var b=this;b._list=[],b._cursor=-1,b._suspended=!1,b._dispatcher=new Gb.EventDispatcher,b._box=a,b._enabled=!1,b._limit=100};ld._IGNORE_PROPERTIES={alarmState:1,propagateSeverity:1,enablePropagation:1,children:1,fromAgent:1,toAgent:1,bundleLinks:1},Hb.ext("twaver.UndoManager",Object,{setEnabled:function(a){var b=this,c=b._box;b._enabled!=a&&(a?(c.addDataBoxChangeListener(b._handleDataBoxChange,b,!0),c.addDataPropertyChangeListener(b._handleDataPropertyChange,b,!0)):(c.removeDataBoxChangeListener(b._handleDataBoxChange,b),c.removeDataPropertyChangeListener(b._handleDataPropertyChange,b))),b._enabled=a},isEnabled:function(){return this._enabled},undo:function(){var a,b,c,d=this,e=d._list;if(d.canUndo()){if(a=e[d._cursor--],d._suspended=!0,a.length)for(c=a.length,b=c-1;b>=0;b--)a[b].undo();else a.undo();d._suspended=!1,d._fire({kind:"undo",action:a})}},redo:function(){var a,b=this,c=b._list;b.canRedo()&&(a=c[++b._cursor],b._suspended=!0,a.length?a.forEach(function(a){a.redo()}):a.redo(),b._suspended=!1,b._fire({kind:"redo",action:a}))},canUndo:function(){return this._cursor>=0},canRedo:function(){return this._cursor<this._list.length-1},_add:function(a){var b=this,c=b._batch,d=b._list;c?c.push(a):(b._cursor!==d.length-1&&d.splice(b._cursor+1,d.length),0!==b._limit&&d.length===b._limit&&d.splice(0,1),d.push(a),b._cursor=d.length-1,b._fire({kind:"add",action:a}))},_handleDataBoxChange:function(a){if(!this._suspended){var b=this,c=b._box,d=a.kind,e=a.data;"add"===d?b._add({undo:function(){var a=this;a.parent=e.getParent(),a.host=e.getHost&&e.getHost(),e.getFromNode&&(a.fromNode=e.getFromNode(),a.toNode=e.getToNode()),c.remove(e)},redo:function(){var a=this;a.parent&&e.setParent(a.parent),e.getHost&&a.host&&e.setHost(a.host),e.getFromNode&&(a.fromNode&&e.setFromNode(a.fromNode),a.toNode&&e.setToNode(a.toNode)),c.add(e)}}):"remove"===d&&b._add({undo:function(){c.add(e)},redo:function(){c.remove(e)}})}},_handleDataPropertyChange:function(a){if(!this._suspended){var b=this,c=a.property,d=c.substr(0,2),e=a.source,f=a.oldValue,g=a.newValue;"C:"===d?(c=c.substr(2),b._add({undo:function(){e.setClient(c,f)},redo:function(){e.setClient(c,g)}})):"S:"===d?(c=c.substr(2),b._add({undo:function(){e.setStyle(c,f)},redo:function(){e.setStyle(c,g)}})):ld._IGNORE_PROPERTIES[c]||b._add({undo:function(){e[Hb.setter(c)](f)},redo:function(){e[Hb.setter(c)](g)}})}},size:function(){return this._list.length},getCursor:function(){return this._cursor},_fire:function(a){this._dispatcher.fire(a)},on:function(a,b,c){this._dispatcher.add(a,b,c)},off:function(a,b){this._dispatcher.remove(a,b)},isSuspended:function(){return this._suspended},setSuspended:function(a){this._suspended=a},getLimit:function(){return this._limit},setLimit:function(a){var b,c,d=this,e=d._list;return 0>a&&(a=0),a!==d._limit&&(b=e.length-a,a>0&&b>0&&(c=d._cursor+1,d._cursor-=b,d._cursor<-1&&(d._cursor=-1),c>0&&e.splice(0,c),b-=c,b>0&&e.splice(e.length-b,b)),d._limit=a,d._fire({kind:"change"})),d},clear:function(){var a=this;return a._list=[],a._cursor=-1,a._fire({kind:"clear"}),a},batch:function(a,b){var c=this;return c.startBatch(),a.call(b),c.endBatch(),c},startBatch:function(){var a=this;return a._batch||(a._batch=[]),a},endBatch:function(){var a,b=this;return b._batch&&(a=b._batch,b._batch=null,a.length&&b._add(a)),b}}),Gb.Pool=function(a,b){this.func="string"==typeof a?function(){return Mb.createElement(a)}:a,this.tagName=a,null!=b&&(this.redundancy=b)},Hb.ext("twaver.Pool",Object,{redundancy:2,currentIndex:-1,get:function(){if(this.currentIndex++,this.currentIndex===this.size()){var a=this.func();return a._pool=this,a.style.margin="0px",a.style.padding="0px",this.list||(this.list=new md),this.list.add(a),a}return this.list.get(this.currentIndex)},release:function(a){this.list&&this.list.remove(a)>=0&&(delete a._selectData,delete a._expandData,delete a._checkData,delete a._editInfo,delete a.keepDefault,a.style.margin="0px",a.style.padding="0px",a.style.backgroundColor="",a.removeAttribute("title"),"img"===this.tagName&&a.removeAttribute&&(a.removeAttribute("width"),a.removeAttribute("height"),a.removeAttribute("src")),this.list.add(a),this.currentIndex--)},reset:function(){this.currentIndex=-1},clear:function(){if(this.list)for(;this.redundancy+this.currentIndex<this.list.size()-1;)delete this.list.removeAt(this.list.size()-1)._pool},size:function(){return this.list?this.list.size():0}});var md=function(){if(this._as=[],1===arguments.length){var a=arguments[0];if(a instanceof md&&(a=a._as),a instanceof Array)for(var b=a.length,c=0;b>c;c++)this._as.push(a[c]);else a===!1?(this._duplicatable=!1,this._map={}):null!=a&&this._as.push(a)}else if(arguments.length>1)for(b=arguments.length,c=0;b>c;c++)this._as.push(arguments[c])};Gb.List=md,Hb.ext("twaver.List",Object,{_duplicatable:!0,size:function(){return this._as.length},isEmpty:function(){return 0===this._as.length},add:function(a,b){if(!this._duplicatable){if(this._map[a._id])return;this._map[a._id]=!0}return void 0===b?this._as.push(a):this._as.splice(b,0,a)},addAll:function(a){if(a instanceof md&&(a=a._as),a instanceof Array)for(var b=a.length,c=0;b>c;c++)this.add(a[c]);else this.add(a)},get:function(a){return this._as[a]},remove:function(a){if(!this._duplicatable&&!this._map[a&&a._id])return-1;var b=this._as.indexOf(a);return b>=0&&b<this._as.length&&this.removeAt(b),b},removeAt:function(a){var b=this._as.splice(a,1)[0];return!this._duplicatable&&b&&delete this._map[b._id],b},set:function(a,b){var c=this._as[a];if(c===b)return b;if(!this._duplicatable){if(this._map[b._id])throw"duplicate item:"+b;delete this._map[c._id],this._map[b._id]=!0}return this._as[a]=b,c},clear:function(){return this._duplicatable||(this._map={}),this._as.splice(0,this._as.length)},contains:function(a){return this._duplicatable?this.indexOf(a)>=0:!!this._map[a&&a._id]},indexOf:function(a){return this._as.indexOf(a)},forEach:function(a,b){for(var c=this._as.length,d=0;c>d;d++){var e=this._as[d];b?a.call(b,e):a(e)}},forEachReverse:function(a,b){for(var c=this._as.length,d=c-1;d>=0;d--){var e=this._as[d];b?a.call(b,e):a(e)}},toArray:function(a,b){if(a){for(var c=[],d=this._as.length,e=0;d>e;e++){var f=this._as[e];b?a.call(b,f)&&c.push(f):a(f)&&c.push(f)}return c}return this._as.concat()},toList:function(a,b){if(a){for(var c=new md,d=this._as.length,e=0;d>e;e++){var f=this._as[e];b?a.call(b,f)&&c.add(f):a(f)&&c.add(f)}return c}return new md(this)},sort:function(a){return a?this._as.sort(a):this._as.sort(),this},toString:function(){return this._as.toString()}});var nd={shapeMap:{},init:function(){nd.register("arrow.standard",nd.createStandardArrow()),nd.register("arrow.delta",nd.createDeltaArrow()),nd.register("arrow.diamond",nd.createDiamondArrow()),nd.register("arrow.short",nd.createShortArrow()),nd.register("arrow.slant",nd.createSlantArrow()),nd.register("arrow.doubledelta",nd.createDoubleDeltaArrow()),nd.register("arrow.tee",nd.createTeeArrow()),nd.register("arrow.box",nd.createBoxArrow()),nd.register("arrow.dot",nd.createDotArrow()),nd.register("arrow.tail",nd.createTailArrow())},createStandardArrow:function(){var a=new md;return a.add({x:-1,y:-5/9}),a.add({x:-0.75,y:0}),a.add({x:-1,y:5/9}),a.add({x:0,y:0}),a.add({x:-1,y:-5/9}),{points:a}},createDeltaArrow:function(){var a=new md;return a.add({x:-1,y:-5/9}),a.add({x:-1,y:5/9}),a.add({x:0,y:0}),a.add({x:-1,y:-5/9}),{points:a}},createDoubleDeltaArrow:function(){var a=new md;return a.add({x:-1,y:-5/9}),a.add({x:-1,y:5/9}),a.add({x:-0.5,y:0}),a.add({x:-0.5,y:-5/9}),a.add({x:0,y:0}),a.add({x:-0.5,y:5/9}),a.add({x:-0.5,y:0}),a.add({x:-1,y:-5/9}),{points:a}},createTeeArrow:function(){var a=new md;return a.add({x:-1/9,y:-5/9}),a.add({x:-1/9,y:5/9}),a.add({x:0,y:5/9}),a.add({x:0,y:-5/9}),a.add({x:-1/9,y:-5/9}),{points:a}},createBoxArrow:function(){var a=new md;return a.add({x:-10/9,y:-5/9}),a.add({x:-10/9,y:5/9}),a.add({x:0,y:5/9}),a.add({x:0,y:-5/9}),a.add({x:-10/9,y:-5/9}),{points:a}},createDotArrow:function(){var a={},b=new Gb.List;return b.add({x:-0.5,y:0}),a.points=b,a.draw=function(a,b){if(a&&b&&b.points&&!(b.points.size()<=0)){var c=b.points._as,d=c[0],e=Math.min(b.width,b.height)/2;a.save(),a.beginPath(),a.arc(d.x,d.y,e,0,2*Math.PI,!1),a.closePath(),a.restore()}},a},createTailArrow:function(){for(var a={},b=new Gb.List,c=30,d=-c/2;c/2>d;d++)b.add({x:-d/9,y:0});return a.points=b,a.draw=function(a,b){if(a&&b&&b.points&&!(b.points.size()<=0))for(var c=b.points._as,d=b.shadow,e=b.shadowColor,f=b.shadowXOffset,g=b.shadowYOffset,h=b.shadowBlur,e=b.shadowColor,i=c.length-4,j=Math.min(b.width,b.height)/2,k=0;i>k;k++){var l=k/i,m=c[k],n=.4*j;a.save(),a.restore(),a.beginPath(),a.globalAlpha=l*l,d&&(a.shadowOffsetX=f,a.shadowOffsetY=g,a.shadowBlur=h,a.shadowColor=e),a.arc(m.x,m.y,n,0,2*Math.PI,!1),a.closePath(),a.fill()}},a},createDiamondArrow:function(){var a=new md;return a.add({x:-7/12,y:5/9}),a.add({x:-14/12,y:0}),a.add({x:-7/12,y:-5/9}),a.add({x:0,y:0}),a.add({x:-7/12,y:5/9}),{points:a}},createShortArrow:function(){var a=new md;return a.add({x:-8/12,y:6/9}),a.add({x:-5/12,y:0}),a.add({x:-8/12,y:-6/9}),a.add({x:0,y:0}),a.add({x:-8/12,y:6/9}),{points:a}},createSlantArrow:function(){var a=new md;return a.add({x:-1,y:-5/9}),a.add({x:-6.5/12,y:0}),a.add({x:-0.75,y:4/9}),a.add({x:0,y:0}),a.add({x:-1,y:-5/9}),{points:a}},register:function(a,b){nd.shapeMap[a]=b},getShape:function(a){if(a)return nd.shapeMap[a];throw"shape type can't be null"},getArrowRect:function(a,b,c,d,e,f,g,h,i){var j=nd.getShape(d);if(j&&j.points&&!(j.points&&j.points.size()<=0)){if(g>0&&1>g){var k;k=a.getLineLength?a.getLineLength():a._element.getLineLength(),g*=k}else a.getLineLength&&(g+=nd.calculateArrowXOffsetAtEdge(b,a,c,i));var l,m,n,o=Rb.calculatePointInfoAlongLine(b,c,g,h),p=o.point,q=o.angle,r=j.points._as,s=r.length,t=new md;for(n=new Qb(e,0,0,f,p.x,p.y),l=0;s>l;l++)t.add(n.transform(r[l]));for(n=Rb.createMatrix(q+Math.PI,p.x,p.y),l=0;s>l;l++)m=t.get(l),m instanceof md&&(m=m._as),m instanceof Array?(m[0]=n.transform(m[0]),m[1]=n.transform(m[1])):t.set(l,n.transform(m));return Rb.getLineRect(t)}},drawArrow:function(a,b,c,d,e,f,g,h,i,j,k,l,m){i=i||0,j=j||0,k=k||0;var n=m._element.getStyle("arrow.from.shadow"),o=m._element.getStyle("arrow.from.shadow.color"),p=m._element.getStyle("arrow.from.shadow.xoffset"),q=m._element.getStyle("arrow.from.shadow.yoffset"),r=m._element.getStyle("arrow.from.shadow.blur"),s=k>=0&&l;if(g||s){var t=nd.getShape(f);if(t&&t.points&&!(t.points&&t.points.size()<=0)){var u=Rb.calculatePointInfoAlongLine(d,e,i,j),v=u.point,w=u.angle;g&&(a.fillStyle=h),a.beginPath(),s&&(a.lineWidth=k,a.strokeStyle=l),nd._drawArrow(a,t,w,v,b,c,l,o,n,p,q,r),n&&(a.shadowOffsetX=p,a.shadowOffsetY=q,a.shadowBlur=r,a.shadowColor=o),g&&a.fill(),s&&a.stroke()}}},_drawArrow:function(a,b,c,d,e,f,g,h,i,j,k,l){if(b.draw){for(var m=new Gb.List,n=0;n<b.points._as.length;n++)m.add(b.points.get(n));m.add({x:-1,y:-0.5}),m.add({x:-1,y:.5}),m.add({x:0,y:.5}),m.add({x:0,y:-0.5}),m=m._as;var n,o,p,q=m.length,r=new md;p=new Qb(e,0,0,f,d.x,d.y);for(var n=0;q>n;n++)r.add(p.transform(m[n]));r=r._as,p=Rb.createMatrix(c+Math.PI,d.x,d.y);for(var s=new md,n=0;q>n;n++)s.add(p.transform(r[n]));b.draw&&b.draw(a,{points:s,width:e,height:f,shadowColor:h,shadow:i,shadowXOffset:j,shadowYOffset:k,shadowBlur:l})}else{var n,o,p,m=b.points._as,q=m.length,r=new md;for(p=new Qb(e,0,0,f,d.x,d.y),n=0;q>n;n++)r.add(p.transform(m[n]));r=r._as,p=Rb.createMatrix(c+Math.PI,d.x,d.y);var t=r[0];for(t=p.transform(t),a.moveTo(t.x,t.y),n=1;q>n;n++)o=r[n],o instanceof md&&(o=o._as),o instanceof Array?(o[0]=p.transform(o[0]),o[1]=p.transform(o[1]),a.quadraticCurveTo(o[0].x,o[0].y,o[1].x,o[1].y)):(o=p.transform(o),a.lineTo(o.x,o.y))}},drawLinkArrow:function(a,b,c,d){if(!(c.size()<2)){var e=a._element.isBundleAgent?a._element.isBundleAgent():!1;a._element.getStyle(e?"arrow.agent.from":"arrow.from")&&nd._drawFromArrow(a,b,c,d),a._element.getStyle(e?"arrow.agent.to":"arrow.to")&&nd._drawToArrow(a,b,c,d)}},_drawFromArrow:function(a,b,c,d){{var e=a._element,f=e.isBundleAgent?e.isBundleAgent():!1,g=e.getStyle(f?"arrow.agent.from.fill":"arrow.from.fill"),h=e.getStyle(f?"arrow.agent.from.outline.width":"arrow.from.outline.width");e.getStyle(f?"arrow.agent.from.shadow.color":"arrow.from.shadow.color")}if(g||h>=0){var i=e.getStyle(f?"arrow.agent.from.width":"arrow.from.width"),j=e.getStyle(f?"arrow.agent.from.height":"arrow.from.height"),k=e.getStyle(f?"arrow.agent.from.xoffset":"arrow.from.xoffset");if(k>0&&1>k){var l;l=a.getLineLength?a.getLineLength():a._element.getLineLength(),k*=l}else a.getLineLength&&(k+=nd.calculateArrowXOffsetAtEdge(c,a,!0,d));var m=e.getStyle(f?"arrow.agent.from.yoffset":"arrow.from.yoffset"),n=e.getStyle(f?"arrow.agent.from.shape":"arrow.from.shape");nd.drawArrow(b,i,j,c,!0,n,g,e.getStyle(f?"arrow.agent.from.color":"arrow.from.color"),k,m,h,e.getStyle(f?"arrow.agent.from.outline.color":"arrow.from.outline.color"),a)}},_drawToArrow:function(a,b,c,d){var e=a._element,f=e.isBundleAgent?e.isBundleAgent():!1,g=e.getStyle(f?"arrow.agent.to.fill":"arrow.to.fill"),h=e.getStyle(f?"arrow.agent.to.outline.width":"arrow.to.outline.width");

if(g||h>=0){var i=e.getStyle(f?"arrow.agent.to.width":"arrow.to.width"),j=e.getStyle(f?"arrow.agent.to.height":"arrow.to.height"),k=e.getStyle(f?"arrow.agent.to.xoffset":"arrow.to.xoffset");if(k>0&&1>k){var l;l=a.getLineLength?a.getLineLength():a._element.getLineLength(),k*=l}else a.getLineLength&&(k+=nd.calculateArrowXOffsetAtEdge(c,a,!1,d));var m=e.getStyle(f?"arrow.agent.to.yoffset":"arrow.to.yoffset"),n=e.getStyle(f?"arrow.agent.to.shape":"arrow.to.shape");nd.drawArrow(b,i,j,c,!1,n,g,e.getStyle(f?"arrow.agent.to.color":"arrow.to.color"),k,m,h,e.getStyle(f?"arrow.agent.to.outline.color":"arrow.to.outline.color"),a)}},calculateArrowXOffsetAtEdge:function(a,b,c,d){if(null==a||a.size()<2)return 0;var e=b._element,f=e.getStyle(c?"arrow.from.at.edge":"arrow.to.at.edge");if(!f)return 0;var g=b._network.getElementUI(c?e.getFromAgent():e.getToAgent());if(!g)return 0;if(d)var h=g.getZoomBodyRect();else var h=g._bodyRect;if(null==h)return 0;for(var i=Rb._getPoint(a.get(c?0:a.size()-1)),j=0,k=b.getLineLength();nd._containsByInt(h,Math.floor(i.x),Math.floor(i.y),!1)&&k>j;)i=Rb.calculatePointInfoAlongLine(a,c,j++).point;return j},_containsByInt:function(a,b,c,d){return d=void 0===d?!0:d,d?b>=Math.floor(a.x)&&b<=Math.floor(a.x+a.width)&&c>=Math.floor(a.y)&&c<=Math.floor(a.y+a.height):b>Math.floor(a.x)&&b<Math.floor(a.x+a.width)&&c>Math.floor(a.y)&&c<Math.floor(a.y+a.height)}};nd.init(),Hb.arrow=nd,Gb.EventDispatcher=function(){this._f=0},Hb.ext("twaver.EventDispatcher",null,{contains:function(a,b){if(this._ls)for(var c,d=0,e=this._ls.size();e>d;d++)if(c=this._ls.get(d),a===c.l&&b===c.s)return!0;return!1},add:function(a,b,c){var d={l:a,s:b,a:c};this._ls||(this._ls=new md),this._f?(this._addPendings||(this._addPendings=new md),this._addPendings.add(d)):d.a?this._ls.add(d,0):this._ls.add(d)},remove:function(a,b){this._ls&&(this._f?(this._removePendings||(this._removePendings=new md),this._removePendings.add({l:a,s:b})):this._remove(a,b))},_remove:function(a,b){for(var c,d=0,e=this._ls.size();e>d;d++)if(c=this._ls.get(d),c.l===a&&c.s===b)return void this._ls.removeAt(d)},fire:function(a){if(this._ls){var b,c,d=this._ls.size();for(this._f++,b=0;d>b;b++)c=this._ls.get(b),c.s?c.l.call(c.s,a):c.l(a);if(this._f--,!this._f){if(this._removePendings){for(d=this._removePendings.size(),b=0;d>b;b++)c=this._removePendings.get(b),this._remove(c.l,c.s);delete this._removePendings}if(this._addPendings){for(d=this._addPendings.size(),b=0;d>b;b++)c=this._addPendings.get(b),c.a?this._ls.add(c,0):this._ls.add(c);delete this._addPendings}}}}}),Gb.ImageAsset=function(a,b,c,d,e){this._name=a,this._width=c,this._height=d,this._svg=e,this._edgeData,"string"==typeof b?this._src=b:"function"==typeof b?this._func=b:bd(b)?this._image=b:"object"==typeof b&&(this._image=b,this._width=b.w||b.width,this._height=b.h||b.height,b.cache!==!1&&yd(b)&&(wd(a,b),this._cache=Bd(b)))},Hb.ext("twaver.ImageAsset",Object,{getName:function(){return this._name},getSrc:function(){return this._src},isSvg:function(){return this._svg},getImage:function(a,b,c){if(!a||!this._image)return this._image;this._map||(this._map={});var d;d=this._svg&&3===arguments.length?a+","+b+","+c:a;var e=this._map[d];return e?e:(e=td(this._cache||this._image,rd(a),this._svg?b||this.getWidth():this.getWidth(),this._svg?c||this.getHeight():this.getHeight()),this._map[d]=e,e)},getWidth:function(){return this._width},getHeight:function(){return this._height},getFunction:function(){return this._func},_createEdgeData:function(a,b,c){var d=300,e=d/b;b>c&&(e=d/c);var f=Math.floor(b*e),g=Math.floor(c*e);this.tempCanvas||(this.tempCanvas=Mb.createElement("canvas"),this.ctx=this.tempCanvas.getContext("2d")),this.tempCanvas.width=f,this.tempCanvas.height=g,this.ctx.clearRect(0,0,f,g),this.ctx.drawImage(a,0,0,f,g);for(var h=this.ctx.getImageData(0,0,f,g),i=!0,j=[],k=0,b=f,c=g;c>k;k++)for(var l=0;b>l;l++){var m=4*(k*b+l),n=this._isTransparentPoint(h.data,m),o=i!=n||!n&&(0==l||l==b-1);if(o){var p=n?1:0;j.push({x:l-p,y:k})}i=n}i=!0;for(var l=0,b=f,c=g;b>l;l++)for(var k=0;c>k;k++){var m=4*(k*b+l),n=this._isTransparentPoint(h.data,m),o=i!=n||!n&&(0==k||k==c-1);if(o){var p=n?1:0;j.push({x:l,y:k-p})}i=n}for(var q=b/2,r=c/2,s=[],t=0;360>t;t++)s.push({x:q,y:r,dist:0});for(var t=0,u=j.length;u>t;t++){var v=j[t],w=this._getPointAngleDegree(v.x,v.y,q,r),x=this._getPointDist(v.x,v.y,q,r);s[w].dist<x&&(s[w]={x:v.x,y:v.y,dist:x})}for(var t=0,u=s.length;u>t;t++){var o=s[t];o.x=o.x/e,o.y=o.y/e,delete o.dist}return s},_isTransparentPoint:function(a,b){return a[b]+a[b+1]+a[b+2]+a[b+3]==0},_getPointAngleDegree:function(a,b,c,d){var e=c-a,f=d-b,g=Math.atan2(f,e);return g=g/Math.PI*180,g=parseInt(g)+180,g%=360},_getPointDist:function(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(e*e+f*f)}});var od={},pd=Ub.createCanvas();pd.width=1,pd.height=1;var qd=pd.getContext("2d"),rd=function(a){a=a||"black";var b,c=od[a];return c||(qd.clearRect(0,0,1,1),qd.fillStyle=a,qd.fillRect(0,0,1,1),b=qd.getImageData(0,0,1,1).data,c=od[a]={r:b[0],g:b[1],b:b[2],a:b[3]}),c},sd=function(a,b){if(!b)return a;if(b=rd(b),a=rd(a),Dd.PIXEL_FILTER_FUNCTION){var c=Dd.PIXEL_FILTER_FUNCTION(a,b);return"rgba("+c.r+","+c.g+","+c.b+","+a.a+")"}return null},td=function(a,b,c,d){var e=Ub.createCanvas(c,d),f=e.getContext("2d");f.drawImage(a,0,0,c,d);try{for(var g=f.getImageData(0,0,c,d),h=g.data,i=0,j=h.length;j>i;i+=4){var k={r:h[i+0],g:h[i+1],b:h[i+2]},l=Dd.PIXEL_FILTER_FUNCTION(k,b);h[i+0]=l.r,h[i+1]=l.g,h[i+2]=l.b}f.putImageData(g,0,0)}catch(m){return a}return e},ud={},vd=function(a,b){if(a){var c=typeof a;"string"===c&&(a.match(Wc)||Hb.images[a]||(ud[a]||(ud[a]=[])).push(b))}},wd=function(a,b){b.pattern&&vd(b.pattern,a),b.v&&b.v.forEach(function(b){b.pattern&&vd(b.pattern,a)})},xd=function(a){var b=ud[a];b&&(b.forEach(function(a){var b=Hb.images[a];b._cache=Bd(b._image)}),delete ud[a])},yd=function(a){return a.w&&a.h?zd(a):!1},zd=function(a){return!Object.keys(a).some(function(b){if(/^on/.test(b))return!1;var c=a[b],d=Ad(c);return d||"v"!==b||(d=c.some(function(a){if("draw"===a.shape)return!0;if("vector"===a.shape){var b=Hb.images[a.name];if(b&&!b._cache)return!0}var c=Object.keys(a).some(function(b){return"state"===b||"animate"===b?!0:Ad(a[b])});return c?!0:"g"===a.shape&&a.v&&a.v.length?!zd(a):!1})),d})},Ad=function(a){var b=typeof a;return"string"===b&&a.match(Wc)||"function"===b},Bd=function(a){var b=Ub.createCanvas(a.w,a.h),c=b.getContext("2d");return Gb.Util.makeHighRes(b),Nc(c,a,null,{x:0,y:0,width:a.w,height:a.h}),b},Cd=Gb.imageUtil={IMAGE_LOAD_COMPLETED:"IMAGE_LOAD_COMPLETED",_dispatcher:new Gb.EventDispatcher,addEventListener:function(a,b,c){Cd._dispatcher.add(a,b,c)},removeEventListener:function(a,b){Cd._dispatcher.remove(a,b)},images:{},registerImageByUrl:function(a,b,c){if(b=b||Cd.getImageType(a),c=c||Cd.getImageName(a),!Cd.images[c]){Cd.images[c]=a;var d=new Nb;d.src=a,d.onload=function(){Hb.registerImage(c,d,d.width,d.height,b===!0),d.onload=null,delete Cd.images[c];var e={type:Cd.IMAGE_LOAD_COMPLETED,url:a,svg:b,name:c};Cd._dispatcher.fire(e)}}},getImageName:function(a){if("string"!=typeof a)return null;var b=a.lastIndexOf("/"),c=a;return b>=0&&(c=a.substring(b+1)),b=c.lastIndexOf("."),b>=0&&(c=c.substring(0,b)),c},getImageType:function(a){if("string"!=typeof a)return null;var b=a.lastIndexOf("/"),c=a;return b>=0&&(c=a.substring(b+1)),b=c.lastIndexOf("."),b>=0&&(c=c.substring(b+1)),c}},Dd={COLORS:["#6495ED","#FFFF00","#00FFFF","#FF0000","#7FFF00","#E0A580","#5FC0CB","#FA00F0","#A1BC50","#FFD700","#4169E1","#E5A5F5","#1E90FF","#696969","#FF6347","#00BFEF","#FFD700","#80E090","#5F9EA0","#A000FF","#7FAF00","#228BA2","#FF00FF","#7FFFD4","#800000","#0000CD","#20B2AA","#D2691E","#6495BD","#DC143C","#F0A8AF","#008B8B","#800080","#B8860B","#4B0082","#00FF00","#FFA500","#FF4500","#FFFF00","#9ACD32","#00008B","#FF1493","#ADFF2F","#4682B4","#00C0B1"],CALL_LATER_DELAY:17,SCROLL_BAR_WIDTH:17,SELECT_COLOR:"#C2CFF1",FOCUS_ON_CLICK:!0,VIEW_POSITION:"absolute",VIEW_FONT_SIZE:"12px",VIEW_FONT_FAMILY:"arial, tahoma, helvetica, sans-serif",TOOLTIP_BACKGROUND:"lightyellow",TOOLTIP_FONT_SIZE:"12px",TOOLTIP_COLOR:"black",TOOLTIP_PADDING:"4px 8px",TOOLTIP_BORDER:"1px solid gray",TOOLTIP_BORDER_RADIUS:"6px",TOOLTIP_XOFFSET:12,TOOLTIP_YOFFSET:12,TOOLTIP_BOX_SHADOW:"0px 0px 3px #AAA",TOOLTIP_ZINDEX:1e5,TOOLTIP_INITIAL_DELAY:750,TOOLTIP_RESHOW_DELAY:500,TOOLTIP_DISMISS_DELAY:4e3,ZOOM_MAX:5,ZOOM_MIN:.1,ZOOM_INCREMENT:1.3,ZOOM_ANIMATE:!0,COLUMN_INNER_TEXT:!0,COLUMN_WIDTH:80,COLUMN_HORIZONTAL_ALIGN:"",COLUMN_PROPERTY_TYPE:"accessor",COLUMN_VALUE_TYPE:"string",COLUMN_EDITABLE:!1,COLUMN_SORTABLE:!0,COLUMN_VISIBLE:!0,COLUMN_RESIZABLE:!0,COLUMN_MOVABLE:!0,COLUMN_RENDER_CELL:null,COLUMN_RENDER_HEADER:null,COLUMN_RENDER_EDITOR:null,PROPERTY_INNER_TEXT:!0,PROPERTY_HORIZONTAL_ALIGN:"",PROPERTY_PROPERTY_TYPE:"accessor",PROPERTY_VALUE_TYPE:"string",PROPERTY_EDITABLE:!1,PROPERTY_CATEGORY_NAME:null,PROPERTY_RENDER_NAME:null,PROPERTY_RENDER_VALUE:null,PROPERTY_RENDER_EDITOR:null,TAB_WIDTH:100,TAB_CLOSABLE:!1,TAB_RESIZABLE:!0,TAB_MOVABLE:!0,TAB_DISABLED:!1,TAB_VISIBLE:!0,ACCORDION_EXPAND_ICON:"expand_icon",ACCORDION_COLLAPSE_ICON:"collapse_icon",ACCORDION_TITLE_HEIGHT:20,ACCORDION_TITLE_BACKGROUND:"#EBEBEB",ACCORDION_BORDER_BOTTOM_COLOR:"lightgray",ACCORDION_ICON_POSITION:"left",TITLEPANE_TITLE_HEIGHT:20,TITLEPANE_TITLE_BACKGROUND:"#DDD",TITLEPANE_TITLE_HORIZONTAL_ALIGN:"left",BORDERPANE_HGAP:0,BORDERPANE_VGAP:0,CHARTPANE_TITLE_HEIGHT:20,CHARTPANE_TITLE_HORIZONTAL_ALIGN:"center",CHARTPANE_LEGEND_ORIENTATION:"bottom",CHARTPANE_LEGEND_WIDTH:80,LEGENDPANE_ICON_WIDTH:10,LEGENDPANE_ICON_HEIGHT:10,LEGENDPANE_ICON_RADIUS:0,LEGENDPANE_ROW_HEIGHT:20,LEGENDPANE_ORIENTATION:"horizontal",LEGENDPANE_HIDDEN_COLOR:"#BABBBC",LEGENDPANE_SELECT_BACKGROUND_COLOR:"#00007D",LEGENDPANE_SELECT_FOREGROUND_COLOR:"#FFFFFF",CHART_TOOLTIP_ENABLED:!0,CHART_SELECT_TOLERANCE:0,CHART_XGAP:6,CHART_YGAP:6,CHART_XZOOM_ENABLED:!0,CHART_YZOOM_ENABLED:!0,CHART_XTRANSLATE_ENABLED:!0,CHART_YTRANSLATE_ENABLED:!0,CHART_DOUBLE_CLICK_TO_RESET:!0,CHART_VALUE_VISIBLE:!0,CHART_VALUE_FONT:null,CHART_BACKGROUND_VISIBLE:!1,CHART_BACKGROUND_FILL:!0,CHART_BACKGROUND_FILL_COLOR:"rgba(50,50,50,0.11)",CHART_BACKGROUND_OUTLINE_WIDTH:1,CHART_BACKGROUND_OUTLINE_COLOR:"rgba(50,50,50,0.11)",CHART_BACKGROUND_GRADIENT:"linear.north",CHART_BACKGROUND_GRADIENT_COLOR:"#FFFFFF",PIECHART_TYPE:"oval",PIECHART_START_ANGLE:0,PIECHART_SELECT_OFFSET:5,PIECHART_SHADOW_OFFSET:1,PIECHART_SHADOW_COLOR:"#C2CFF1",PIECHART_LINE_RATE:.5,PIECHART_DONUT_RATE:.5,PIECHART_VALUE_POSITION:.5,BARCHART_TYPE:"default",BARCHART_UPPER_LIMIT:null,BARCHART_LOWER_LIMIT:0,BARCHART_XAXIS_LINE_COLOR:"#808080",BARCHART_XAXIS_LINE_WIDTH:1,BARCHART_XAXIS_TEXT_COLOR:"#000000",BARCHART_XAXIS_TEXT_FONT:null,BARCHART_YAXIS_LINE_COLOR:"#808080",BARCHART_YAXIS_LINE_WIDTH:1,BARCHART_YAXIS_TEXT_COLOR:"#000000",BARCHART_YAXIS_TEXT_FONT:null,BARCHART_XSCALE_TEXT_FONT:null,BARCHART_XSCALE_TEXT_COLOR:"#000000",BARCHART_XSCALE_TEXT_ORIENTATION:"horizontal",BARCHART_YSCALE_TEXT_VISIBLE:!0,BARCHART_YSCALE_TEXT_COLOR:"#000000",BARCHART_YSCALE_TEXT_FONT:null,BARCHART_YSCALE_LINE_COLOR:"#808080",BARCHART_YSCALE_LINE_WIDTH:.3,BARCHART_YSCALE_VALUE_GAP:0,BARCHART_YSCALE_PIXEL_GAP:20,BARCHART_YSCALE_MIN_TEXT_VISIBLE:!1,LINECHART_INTERRUPTABLE:!0,LINECHART_UPPER_LIMIT:null,LINECHART_LOWER_LIMIT:null,LINECHART_XAXIS_LINE_COLOR:"#808080",LINECHART_XAXIS_LINE_WIDTH:1,LINECHART_XAXIS_TEXT_COLOR:"#000000",LINECHART_XAXIS_TEXT_FONT:null,LINECHART_YAXIS_LINE_COLOR:"#808080",LINECHART_YAXIS_LINE_WIDTH:1,LINECHART_YAXIS_TEXT_COLOR:"#000000",LINECHART_YAXIS_TEXT_FONT:null,LINECHART_XSCALE_TEXT_FONT:null,LINECHART_XSCALE_TEXT_COLOR:"#000000",LINECHART_XSCALE_TEXT_ORIENTATION:"horizontal",LINECHART_XSCALE_LINE_COLOR:"#808080",LINECHART_XSCALE_LINE_WIDTH:.3,LINECHART_YSCALE_TEXT_VISIBLE:!0,LINECHART_YSCALE_TEXT_COLOR:"#000000",LINECHART_YSCALE_TEXT_FONT:null,LINECHART_YSCALE_LINE_COLOR:"#808080",LINECHART_YSCALE_LINE_WIDTH:.3,LINECHART_YSCALE_VALUE_GAP:0,LINECHART_YSCALE_PIXEL_GAP:20,LINECHART_YSCALE_MIN_TEXT_VISIBLE:!1,LINECHART_VALUESPANCOUNT:1,BUBBLECHART_UPPER_LIMIT:null,BUBBLECHART_LOWER_LIMIT:null,BUBBLECHART_XAXIS_UPPER_LIMIT:null,BUBBLECHART_XAXIS_LOWER_LIMIT:null,BUBBLECHART_XAXIS_LINE_COLOR:"#808080",BUBBLECHART_XAXIS_LINE_WIDTH:1,BUBBLECHART_XAXIS_TEXT_COLOR:"#000000",BUBBLECHART_XAXIS_TEXT_FONT:null,BUBBLECHART_YAXIS_LINE_COLOR:"#808080",BUBBLECHART_YAXIS_LINE_WIDTH:1,BUBBLECHART_YAXIS_TEXT_COLOR:"#000000",BUBBLECHART_YAXIS_TEXT_FONT:null,BUBBLECHART_XSCALE_TEXT_FONT:null,BUBBLECHART_XSCALE_TEXT_COLOR:"#000000",BUBBLECHART_XSCALE_TEXT_ORIENTATION:"horizontal",BUBBLECHART_XSCALE_LINE_COLOR:"#808080",BUBBLECHART_XSCALE_LINE_WIDTH:.3,BUBBLECHART_YSCALE_TEXT_VISIBLE:!0,BUBBLECHART_YSCALE_TEXT_COLOR:"#000000",BUBBLECHART_YSCALE_TEXT_FONT:null,BUBBLECHART_YSCALE_LINE_COLOR:"#808080",BUBBLECHART_YSCALE_LINE_WIDTH:.3,BUBBLECHART_YSCALE_VALUE_GAP:0,BUBBLECHART_YSCALE_PIXEL_GAP:20,BUBBLECHART_YSCALE_MIN_TEXT_VISIBLE:!1,BUBBLECHART_SELECT_SHADOW_COLOR:"#000000",BUBBLECHART_SELECT_SHADOW_OFFSET:3,RADARCHART_AXIS_TEXT_FONT:null,RADARCHART_AXIS_TEXT_COLOR:"#000000",RADARCHART_AXIS_TEXT_VISIBLE:!0,RADARCHART_SCALE_TEXT_FONT:null,RADARCHART_SCALE_TEXT_COLOR:"#000000",RADARCHART_SCALE_TEXT_VISIBLE:!0,RADARCHART_AXIS_VISIBLE:!0,RADARCHART_AXIS_LINE_COLOR:"#808080",RADARCHART_AXIS_LINE_WIDTH:3,RADARCHART_AXIS_START_ANGLE:0,RADARCHART_RING_VISIBLE:!0,RADARCHART_RING_TYPE:"line",RADARCHART_RING_LINE_COLOR:"#808080",RADARCHART_RING_LINE_WIDTH:1,RADARCHART_SCALE_COUNT:5,RADARCHART_SCALE_MAXVALUE:1,RADARCHART_SCALE_MINVALUE:0,RADARCHART_ANCHOR_VISIBLE:!0,RADARCHART_AREA_FILL:!0,RADARCHART_AREA_FILL_ALPHA:.2,RADARCHART_AREA_SELECT_FILL_ALPHA:.5,DIALCHART_UPPER_LIMIT:100,DIALCHART_LOWER_LIMIT:0,DIALCHART_START_ANGLE:0,DIALCHART_END_ANGLE:360,DIALCHART_INNER_RADIUS:.8,DIALCHART_COLOR_RANGE_FILL_COLOR:"#808080",DIALCHART_OUTLINE_WIDTH:0,DIALCHART_OUTLINE_COLOR:"#808080",DIALCHART_SCALE_INSIDE:!0,DIALCHART_MAJOR_SCALE_COUNT:11,DIALCHART_MAJOR_SCALE_LINE_WIDTH:2,DIALCHART_MAJOR_SCALE_LINE_LENGTH:8,DIALCHART_MAJOR_SCALE_LINE_COLOR:"#000000",DIALCHART_MINOR_SCALE_COUNT:4,DIALCHART_MINOR_SCALE_LINE_WIDTH:1,DIALCHART_MINOR_SCALE_LINE_LENGTH:4,DIALCHART_MINOR_SCALE_LINE_COLOR:"#000000",DIALCHART_SCALE_TEXT_VISIBLE:!0,DIALCHART_SCALE_UPPER_LIMIT_TEXT_VISIBLE:!0,DIALCHART_SCALE_LOWER_LIMIT_TEXT_VISIBLE:!0,DIALCHART_SCALE_TEXT_FONT:null,DIALCHART_SCALE_TEXT_COLOR:"#000000",DIALCHART_PIVOT_RADIUS:10,DIALCHART_PIVOT_FILL:!0,DIALCHART_PIVOT_FILL_COLOR:"#808080",DIALCHART_PIVOT_OUTLINE_WIDTH:0,DIALCHART_PIVOT_OUTLINE_COLOR:"#808080",DIALCHART_VALUE_POSITION:.5,DIALCHART_INNER_DARKER_RADIUS:10,DIALCHART_OUTER_BRIGHTER_RADIUS:10,DIALCHART_SELECT_SHADOW_COLOR:"#000000",DIALCHART_SELECT_SHADOW_OFFSET:3,TABPANE_TAB_GAP:1,TABPANE_TAB_RADIUS:0,TABPANE_TAB_HEIGHT:24,TABPANE_TAB_ORIENTATION:"top",TABPANE_RESIZE_TOLERANCE:3,TABPANE_TAB_BACKGROUND:"#EBEBEB",TABPANE_DISABLED_COLOR:"#BABBBC",TABPANE_SELECT_BACKGROUND:"white",TABPANE_MOVE_BACKGROUND:"rgba(184,211,240,0.7)",TABPANE_INSERT_BACKGROUND:"orange",TABPANE_HORIZONTAL_ALIGN:"center",TABPANE_CLOSE_ICON:"close_icon",TABPANE_SELECT_NEXT_ON_CLOSE:!0,TABPANE_SELECT_NEXT_ON_INVISIBLE:!0,LISTBASE_INNER_TEXT:!0,LIST_ROW_HEIGHT:19,LIST_INDENT:2,LIST_ROW_LINE_WIDTH:0,LIST_ROW_LINE_COLOR:"#DDD",LIST_MAKE_VISIBLE_ON_SELECTED:!0,LIST_KEYBOARD_REMOVE_ENABLED:!0,LIST_KEYBOARD_SELECT_ENABLED:!0,TREE_ROW_HEIGHT:19,TREE_INDENT:16,TREE_ROW_LINE_WIDTH:0,TREE_ROW_LINE_COLOR:"#DDD",TREE_MAKE_VISIBLE_ON_SELECTED:!0,TREE_KEYBOARD_REMOVE_ENABLED:!0,TREE_KEYBOARD_SELECT_ENABLED:!0,TREE_EXPAND_ICON:"expand_icon",TREE_COLLAPSE_ICON:"collapse_icon",TREE_LINE_TYPE:"none",TREE_LINE_THICKNESS:2,TREE_LINE_COLOR:"#000000",TREE_LINE_ALPHA:1,TREE_LINE_DASH:[4,2],TABLE_ROW_HEIGHT:19,TABLE_ROW_LINE_WIDTH:1,TABLE_ROW_LINE_COLOR:"#DDD",TABLE_COLUMN_LINE_WIDTH:1,TABLE_COLUMN_LINE_COLOR:"#DDD",TABLE_MAKE_VISIBLE_ON_SELECTED:!0,TABLE_KEYBOARD_REMOVE_ENABLED:!0,TABLE_KEYBOARD_SELECT_ENABLED:!0,TABLE_EDITABLE:!1,TABLEHEADER_HEIGHT:24,TABLEHEADER_RESIZE_TOLERANCE:3,TABLEHEADER_BACKGROUND:"#EBEBEB",TABLEHEADER_MOVE_BACKGROUND:"rgba(184,211,240,0.7)",TABLEHEADER_INSERT_BACKGROUND:"orange",TABLEHEADER_COLUMN_LINE_COLOR:"#DDD",TABLEHEADER_SORT_DESC_ICON:"sort_desc",TABLEHEADER_SORT_ASC_ICON:"sort_asc",TABLEHEADER_SORT_ICON_POSITION:"98% 50%",TREETABLE_ROW_HEIGHT:19,TREETABLE_INDENT:16,TREETABLE_ROW_LINE_WIDTH:1,TREETABLE_ROW_LINE_COLOR:"#DDD",TREETABLE_COLUMN_LINE_WIDTH:1,TREETABLE_COLUMN_LINE_COLOR:"#DDD",TREETABLE_MAKE_VISIBLE_ON_SELECTED:!0,TREETABLE_KEYBOARD_REMOVE_ENABLED:!0,TREETABLE_KEYBOARD_SELECT_ENABLED:!0,TREETABLE_EXPAND_ICON:"expand_icon",TREETABLE_COLLAPSE_ICON:"collapse_icon",TREETABLE_EDITABLE:!1,PROPERTYSHEET_AUTO_ADJUSTABLE:!0,PROPERTYSHEET_INDENT:16,PROPERTYSHEET_ROW_HEIGHT:19,PROPERTYSHEET_ROW_LINE_WIDTH:1,PROPERTYSHEET_COLUMN_LINE_WIDTH:1,PROPERTYSHEET_BORDER_COLOR:"#EBEBEB",PROPERTYSHEET_EXPAND_ICON:"expand_icon",PROPERTYSHEET_COLLAPSE_ICON:"collapse_icon",PROPERTYSHEET_PROPERTY_NAME_WIDTH:100,PROPERTYSHEET_PROPERTY_NAME_HORIZONTAL_ALIGN:"",PROPERTYSHEET_SUM_WIDTH:200,PROPERTYSHEET_RESIZE_TOLERANCE:3,PROPERTYSHEET_EDITABLE:!1,PROPERTYSHEET_CATEGORIZABLE:!0,PROPERTYSHEET_EXPAND_CATEGORY:!0,POPUPMENU_SUBNENU_ENABLE_ICON:"submenu_enable_icon",POPUPMENU_SUBNENU_DISABLE_ICON:"submenu_disable_icon",POPUPMENU_CHECKBOX_SELECTED_ICON:"checkbox_selected_icon",POPUPMENU_CHECKBOX_UNSELECTED_ICON:"checkbox_unselected_icon",POPUPMENU_RADIOBUTTON_SELECTED_ICON:"radiobutton_selected_icon",POPUPMENU_RADIOBUTTON_UNSELECTED_ICON:"radiobutton_unselected_icon",SPLITPANE_ORIENTATION:"horizontal",SPLITPANE_POSITION:.5,SPLITPANE_DIVIDER_WIDTH:6,SPLITPANE_DIVIDER_BACKGROUND:"#CCCCFF",SPLITPANE_DIVIDER_OPACITY:.5,SPLITPANE_MASK_BACKGROUND:"",SPLITPANE_UP_EXPAND_ICON:"up_expand_icon",SPLITPANE_DOWN_EXPAND_ICON:"down_expand_icon",SPLITPANE_LEFT_EXPAND_ICON:"left_expand_icon",SPLITPANE_RIGHT_EXPAND_ICON:"right_expand_icon",NODE_WIDTH:50,NODE_HEIGHT:50,IMAGE_NODE:"node_image",IMAGE_GROUP:"group_image",IMAGE_SUBNETWORK:"subnetwork_image",ICON_DATABOX:"databox_icon",ICON_DATA:"data_icon",ICON_NODE:"node_icon",ICON_LINK:"link_icon",ICON_GROUP:"group_icon",ICON_SUBNETWORK:"subnetwork_icon",ICON_GRID:"grid_icon",ICON_BUS:"bus_icon",ICON_SHAPENODE:"shapenode_icon",ICON_SHAPELINK:"shapelink_icon",ICON_LINKSUBNETWORK:"linksubnetwork_icon",ICON_SHAPESUBNETWORK:"shapesubnetwork_icon",LAYER_DEFAULT_ID:"default",LAYER_DEFAULT_NAME:"default",ATTACHMENT_POINTER_LENGTH:10,ATTACHMENT_POINTER_WIDTH:8,ATTACHMENT_CORNER_RADIUS:5,ATTACHMENT_CONTENT_WIDTH:30,ATTACHMENT_CONTENT_HEIGHT:20,ATTACHMENT_POSITION:"topright.topright",ATTACHMENT_XOFFSET:0,ATTACHMENT_YOFFSET:0,ATTACHMENT_PADDING:0,ATTACHMENT_PADDING_LEFT:0,ATTACHMENT_PADDING_RIGHT:0,ATTACHMENT_PADDING_TOP:0,ATTACHMENT_PADDING_BOTTOM:0,ATTACHMENT_DIRECTION:"right",ATTACHMENT_FILL:!1,ATTACHMENT_FILL_COLOR:"#000000",ATTACHMENT_GRADIENT:null,ATTACHMENT_GRADIENT_COLOR:"#FFFFFF",ATTACHMENT_OUTLINE_WIDTH:-1,ATTACHMENT_OUTLINE_COLOR:"#000000",ATTACHMENT_CAP:"butt",ATTACHMENT_JOIN:"miter",ATTACHMENT_SHADOWABLE:!0,NETWORK_TOOLTIP_ENABLED:!0,NETWORK_SELECT_MODE:"mix",NETWORK_MAKE_VISIBLE_ON_SELECTED:!0,NETWORK_NO_AGENT_LINK_VISIBLE:!1,NETWORK_REMOVE_ELEMENTUI_ON_INVISIBLE:!1,NETWORK_SUBNETWORK_ANIMATE:!0,NETWORK_SENDTOTOP_ON_SELECTED:!0,NETWORK_KEYBOARD_REMOVE_ENABLED:!0,NETWORK_KEYBOARD_SELECT_ENABLED:!0,NETWORK_RECT_SELECT_ENABLED:!0,NETWORK_DOUBLECLICK_TO_SUBNETWORK:!0,NETWORK_DOUBLECLICK_TO_UPSUBNETWORK:!0,NETWORK_DOUBLECLICK_TO_EMPTYSUBNETWORK:!0,NETWORK_DOUBLECLICK_TO_LINKBUNDLE:!0,NETWORK_DOUBLECLICK_TO_GROUPEXPAND:!0,NETWORK_SELECT_OUTLINE_COLOR:"#2877A8",NETWORK_SELECT_OUTLINE_WIDTH:1,NETWORK_SELECT_FILL_COLOR:"rgba(184,211,240,0.4)",NETWORK_LAZYMOVE_OUTLINE_COLOR:"#2877A8",NETWORK_LAZYMOVE_OUTLINE_WIDTH:1,NETWORK_LAZYMOVE_FILL_COLOR:"rgba(184,211,240,0.4)",NETWORK_LAZYMOVE_FILL:!0,NETWORK_LAZYMOVE_ANIMATE:!0,NETWORK_RESIZE_POINT_SIZE:3,NETWORK_RESIZE_POINT_FILL_COLOR:"#FFFFFF",NETWORK_RESIZE_POINT_OUTLINE_COLOR:"#000000",NETWORK_RESIZE_POINT_OUTLINE_WIDTH:1,NETWORK_RESIZE_LINE_COLOR:"#000000",NETWORK_RESIZE_LINE_WIDTH:1,NETWORK_RESIZE_ANIMATE:!0,NETWORK_EDIT_POINT_SIZE:3,NETWORK_EDIT_POINT_FILL_COLOR:"#FFFF00",NETWORK_EDIT_POINT_OUTLINE_COLOR:"#000000",NETWORK_EDIT_POINT_OUTLINE_WIDTH:1,NETWORK_EDIT_LINE_COLOR:"rgba(184,211,240,0.7)",NETWORK_EDIT_LINE_WIDTH:2,NETWORK_ROTATE_POINT_SIZE:5,NETWORK_ROTATE_POINT_FILL_COLOR:"#FFFF00",NETWORK_ROTATE_POINT_OFFSET:15,NETWORK_ROTATE_POINT_OUTLINE_WIDTH:1,NETWORK_ROTATE_POINT_OUTLINE_COLOR:"rgba(0,0,0,1)",NETWORK_ROTATE_SCALE_FILL_COLOR:"rgb(227,166,103)",NETWORK_ROTATE_SCALE_FONT_COLOR:"#FFFFFF",NETWORK_ROTATE_SCALE_WIDTH:30,NETWORK_ROTATE_SCALE_HEIGHT:20,NETWORK_LIMIT_ELEMENT_INPOSITIVE_LOCATION:!0,NETWORK_LINK_FLOW_STEPPING:3,NETWORK_LINK_FLOW_COLOR:"#FF0000",NETWORK_LINK_FLOW_INTERVAL:600,NETWORK_SELECTION_TOLERANCE:2,NETWORK_TRANSPARENT_SELECTION_ENABLE:!1,SHOW_ALARM_IN_ATTACHMENT_DIV:!0,SHOW_LABEL_IN_ATTACHMENT_DIV:!1,SHOW_LABEL2_IN_ATTACHMENT_DIV:!1,SHOW_ICON_IN_ATTACHMENT_DIV:!1,SHOW_EDIT_IN_ATTACHMENT_DIV:!1,OVERVIEW_FILL_COLOR:"rgba(184,211,240,0.4)",OVERVIEW_OUTLINE_COLOR:"#B8D3F0",OVERVIEW_OUTLINE_WIDTH:1,OVERVIEW_SELECT_COLOR:"#0000FF",OVERVIEW_SELECT_WIDTH:1,OVERVIEW_PADDING:1,OVERVIEW_ANIMATE:!0,OVERVIEW_MAX_PACKING_WIDTH:-1,OVERVIEW_MAX_PACKING_HEIGHT:-1,TOUCH_MOVE_THRESHOLD:5,TOUCH_RECT_SELECT_THRESHOLD:20,TOUCH_ZOOM_THRESHOLD:30,LINK_BUNDLE_AGENT_FUNCTION:null,IS_LINK_ADJUSTED_TO_BOTTOM:!1,GROUP_EXPAND_ALIGN:"center",ELEMENTUI_FUNCTION:function(a,b){var c=b.getElementUIClass();return c?new c(a,b):null},CANVASUI_FUNCTION:function(a,b){var c=b.getCanvasUIClass();return c?new c(a,b):null},VECTORUI_FUNCTION:function(a,b){var c=b.getVectorUIClass();return c?new c(a,b):null},KEEP_DEFAULT_FUNCTION:function(a){return a.target.keepDefault||a.target.getAttribute("keepDefault")?!0:a.target.parentNode&&(a.target.parentNode.keepDefault||a.target.parentNode.getAttribute("keepDefault"))?!0:a.shiftKey?!0:!1},SORT_FUNCTION:function(a,b){if(a===b)return 0;if(null==a&&null!=b)return 1;if(null!=a&&null==b)return-1;if(null==a&&null==b)return 0;var c,d=typeof a,e=typeof b;return"string"===d&&"string"===e&&(c=a.localeCompare(b)),"number"===d&&"number"===e&&(c=a-b),void 0===c&&(c=(""+a).localeCompare(""+b)),c>0?1:0>c?-1:0},CENTER_LOCATION:!1,PIXEL_FILTER_FUNCTION:function(a,b){if(!b)return a;var c=.3*a.r+.59*a.g+.11*a.b;return{r:Math.floor(b.r*c/255),g:Math.floor(b.g*c/255),b:Math.floor(b.b*c/255)}}};!function(){var a=Dd;if(window.OverrideTWaverDefaults)for(var b in OverrideTWaverDefaults)a[b]=OverrideTWaverDefaults[b];a.FONT=a.VIEW_FONT_SIZE&&a.VIEW_FONT_FAMILY?a.VIEW_FONT_SIZE+" "+a.VIEW_FONT_FAMILY:Mb.createElement("canvas").getContext("2d").font,a.CHART_VALUE_FONT||(a.CHART_VALUE_FONT="10px "+a.VIEW_FONT_FAMILY),a.BARCHART_XSCALE_TEXT_FONT||(a.BARCHART_XSCALE_TEXT_FONT="10px "+a.VIEW_FONT_FAMILY),a.BARCHART_YSCALE_TEXT_FONT||(a.BARCHART_YSCALE_TEXT_FONT="10px "+a.VIEW_FONT_FAMILY),a.BARCHART_XAXIS_TEXT_FONT||(a.BARCHART_XAXIS_TEXT_FONT="12px "+a.VIEW_FONT_FAMILY),a.BARCHART_YAXIS_TEXT_FONT||(a.BARCHART_YAXIS_TEXT_FONT="12px "+a.VIEW_FONT_FAMILY),a.LINECHART_XSCALE_TEXT_FONT||(a.LINECHART_XSCALE_TEXT_FONT="10px "+a.VIEW_FONT_FAMILY),a.LINECHART_YSCALE_TEXT_FONT||(a.LINECHART_YSCALE_TEXT_FONT="10px "+a.VIEW_FONT_FAMILY),a.LINECHART_XAXIS_TEXT_FONT||(a.LINECHART_XAXIS_TEXT_FONT="12px "+a.VIEW_FONT_FAMILY),a.LINECHART_YAXIS_TEXT_FONT||(a.LINECHART_YAXIS_TEXT_FONT="12px "+a.VIEW_FONT_FAMILY),a.BUBBLECHART_XAXIS_TEXT_FONT||(a.BUBBLECHART_XAXIS_TEXT_FONT="12px "+a.VIEW_FONT_FAMILY),a.BUBBLECHART_YAXIS_TEXT_FONT||(a.BUBBLECHART_YAXIS_TEXT_FONT="12px "+a.VIEW_FONT_FAMILY),a.BUBBLECHART_XSCALE_TEXT_FONT||(a.BUBBLECHART_XSCALE_TEXT_FONT="10px "+a.VIEW_FONT_FAMILY),a.BUBBLECHART_YSCALE_TEXT_FONT||(a.BUBBLECHART_YSCALE_TEXT_FONT="10px "+a.VIEW_FONT_FAMILY),a.RADARCHART_AXIS_TEXT_FONT||(a.RADARCHART_AXIS_TEXT_FONT="12px "+a.VIEW_FONT_FAMILY),a.RADARCHART_SCALE_TEXT_FONT||(a.RADARCHART_SCALE_TEXT_FONT="10px "+a.VIEW_FONT_FAMILY),a.DIALCHART_SCALE_TEXT_FONT||(a.DIALCHART_SCALE_TEXT_FONT="10px "+a.VIEW_FONT_FAMILY)}(),Gb.Defaults=Dd,Hb.ext("twaver.Defaults",Object,{}),Gb.Colors={orange:"#EC6C00",orange_light:"#EF8200",orange_dark:"#EA5404",gray_light:"#666666",gray_dark:"#242424",green_light:"#57AB9A",green_dark:"#238475",blue_light:"#61B6D8",blue_dark:"#0089C1"},Gb.SerializationSettings=function(){var a=Gb.SerializationSettings;this.isDataBoxSerializable=a.isDataBoxSerializable,this.isLayerBoxSerializable=a.isLayerBoxSerializable,this.isStyleSerializable=a.isStyleSerializable,this.isClientSerializable=a.isClientSerializable,this.isImageSerializable=a.isImageSerializable,this._pm=Hb.clone(a._pm),this._sm=Hb.clone(a._sm),this._cm=Hb.clone(a._cm)},function(){var a=Gb.SerializationSettings;a.isDataBoxSerializable=!0,a.isLayerBoxSerializable=!0,a.isStyleSerializable=!0,a.isClientSerializable=!0,a.isImageSerializable=!0,a._pm={},a._sm={},a._cm={},a.setPropertyType=function(b,c){a._pm[b]=c},a.getPropertyType=function(b){return a._pm[b]},a.setStyleType=function(b,c){a._sm[b]=c},a.getStyleType=function(b){return a._sm[b]},a.setClientType=function(b,c){a._cm[b]=c},a.getClientType=function(b){return a._cm[b]}}(),Hb.ext("twaver.SerializationSettings",Object,{setPropertyType:function(a,b){this._pm[a]=b},getPropertyType:function(a){return this._pm[a]},setStyleType:function(a,b){this._sm[a]=b},getStyleType:function(a){return this._sm[a]},setClientType:function(a,b){this._cm[a]=b},getClientType:function(a){return this._cm[a]}});var Ed=Gb.Styles={_m:{},setStyle:function(a,b){null==b?delete Ed._m[a]:Ed._m[a]=b},getStyle:function(a){return Ed._m[a]},getStyleProperties:function(){return Hb.keys(Gb.Styles._m)}};!function(){var a=function(a,b){Gb.SerializationSettings.setPropertyType(a,b)};a("name","cdata"),a("name2","cdata"),a("icon","string"),a("toolTip","cdata"),a("parent","data"),a("layerId","string"),a("alarmState","alarmstate"),a("image","string"),a("imageUrl","string"),a("location","point"),a("width","number"),a("height","number"),a("expanded","boolean"),a("host","data"),a("fromNode","data"),a("toNode","data"),a("points","list.point"),a("segments","list.string"),a("angle","number"),a("visible","boolean"),a=function(a,b,c){null==c&&(c=null!=b?typeof b:"string"),Gb.Styles.setStyle(a,b),Gb.SerializationSettings.setStyleType(a,c)},a("chart.color",null),a("chart.value",0),a("chart.values",null,"list.number"),a("chart.value.color","#000000"),a("chart.value.font",null),a("chart.line.width",2),a("chart.marker.size",6),a("chart.marker.shape","circle"),a("chart.bubble.shape","circle"),a("chart.names",null,"list.string"),a("chart.xaxis.values",null,"list.number"),a("chart.yaxis.values",null,"list.number"),a("dialchart.rear.extension",0),a("dialchart.base.width",5),a("dialchart.top.width",0),a("dialchart.radius",.8),a("inner.color",null),a("outer.shape","rectangle"),a("outer.color",null),a("outer.width",2),a("outer.padding",1),a("outer.padding.left",0),a("outer.padding.right",0),a("outer.padding.top",0),a("outer.padding.bottom",0),a("outer.cap","butt"),a("outer.join","miter"),a("outer.style","border"),a("shadow.color",null),a("shadow.xoffset",3),a("shadow.yoffset",3),a("shadow.blur",6),a("select.style","shadow"),a("select.color","rgba(0, 0, 0, 0.7)"),a("select.shape","rectangle"),a("select.width",2),a("select.padding",2),a("select.padding.left",0),a("select.padding.right",0),a("select.padding.top",0),a("select.padding.bottom",0),a("select.cap","butt"),a("select.join","miter"),a("whole.alpha",1),a("body.type","default"),a("network.label",null,"cdata"),a("image.padding",0),a("image.padding.left",0),a("image.padding.right",0),a("image.padding.top",0),a("image.padding.bottom",0),a("image.state",null),a("vector.shape","rectangle"),a("vector.fill",!0),a("vector.fill.color","#CCCCFF"),a("vector.outline.width",-1),a("vector.outline.pattern",null,"array.number"),a("vector.outline.color","#5B5B5B"),a("vector.gradient","none"),a("vector.gradient.color","#FFFFFF"),a("vector.padding",0),a("vector.padding.left",0),a("vector.padding.right",0),a("vector.padding.top",0),a("vector.padding.bottom",0),a("vector.cap","butt"),a("vector.join","miter"),a("vector.deep",0),a("group.shape","rectangle"),a("group.fill",!0),a("group.fill.color","#CCCCFF"),a("group.outline.width",-1),a("group.outline.color","#5B5B5B"),a("group.gradient","none"),a("group.gradient.color","#FFFFFF"),a("group.padding",5),a("group.padding.left",0),a("group.padding.right",0),a("group.padding.top",0),a("group.padding.bottom",0),a("group.cap","butt"),a("group.join","miter"),a("group.deep",1),a("group.shape.roundrect.radius",-1),a("group.expend.image",null),a("group.expend.image.vector",!1),a("label.alpha",1),a("label.color","#000000"),a("label.font",null),a("label.position","bottom.bottom"),a("label.direction","below"),a("label.corner.radius",0),a("label.pointer.length",0),a("label.pointer.width",8),a("label.xoffset",0),a("label.yoffset",2),a("label.padding",0),a("label.padding.left",0),a("label.padding.right",0),a("label.padding.top",0),a("label.padding.bottom",0),a("label.fill",!1),a("label.fill.color","#C0C0C0"),a("label.gradient","none"),a("label.gradient.color","#FFFFFF"),a("label.outline.width",-1),a("label.outline.color","#000000"),a("label.cap","butt"),a("label.join","miter"),a("label.shadowable",!0),a("label.align","center"),a("label.rotate.angle",0),a("label.maxlength",0),a("link.label.rotatable",!1),a("label2.alpha",1),a("label2.color","#000000"),a("label2.font",null),a("label2.position","top.top"),a("label2.direction","below"),a("label2.corner.radius",0),a("label2.pointer.length",0),a("label2.pointer.width",8),a("label2.xoffset",0),a("label2.yoffset",-2),a("label2.padding",0),a("label2.padding.left",0),a("label2.padding.right",0),a("label2.padding.top",0),a("label2.padding.bottom",0),a("label2.fill",!1),a("label2.fill.color","#C0C0C0"),a("label2.gradient","none"),a("label2.gradient.color","#FFFFFF"),a("label2.outline.width",-1),a("label2.outline.color","#000000"),a("label2.cap","butt"),a("label2.join","miter"),a("label2.shadowable",!0),a("label2.align","center"),a("label2.rotate.angle",0),a("label2.maxlength",0),a("link.label2.rotatable",!1),a("icons.names",null,"array.string"),a("icons.colors",null,"array.string"),a("icons.position",null,"array.string"),a("icons.orientation",null,"array.string"),a("icons.xoffset",[0],"array.number"),a("icons.yoffset",[0],"array.number"),a("icons.xgap",[1],"array.number"),a("icons.ygap",[1],"array.number"),a("alarm.alpha",1),a("alarm.color","#000000"),a("alarm.font",null),a("alarm.position","hotspot"),a("alarm.direction","aboveright"),a("alarm.corner.radius",5),a("alarm.pointer.length",10),a("alarm.pointer.width",8),a("alarm.xoffset",0),a("alarm.yoffset",0),a("alarm.padding",0),a("alarm.padding.left",0),a("alarm.padding.right",0),a("alarm.padding.top",0),a("alarm.padding.bottom",0),a("alarm.gradient","none"),a("alarm.gradient.color","#FFFFFF"),a("alarm.outline.width",-1),a("alarm.outline.color","#000000"),a("alarm.cap","butt"),a("alarm.join","miter"),a("alarm.shadowable",!0),a("link.color","#658DC1"),a("link.width",3),a("link.cap","butt"),a("link.join","miter"),a("link.type","arc"),a("link.pattern",null,"array.number"),a("link.extend",20),a("link.control.point",null,"point"),a("link.bundle.id",0),a("link.bundle.enable",!0),a("link.bundle.expanded",!0),a("link.bundle.independent",!1),a("link.bundle.offset",20),a("link.bundle.gap",12),a("link.bundle.group.gap",0),a("link.looped.gap",6),a("link.looped.direction","northwest"),a("link.looped.type","arc"),a("link.from.position","center"),a("link.from.xoffset",0),a("link.from.yoffset",0),a("link.from.percent",null),a("link.from.at.edge",!0),a("link.to.position","center"),a("link.to.xoffset",0),a("link.to.yoffset",0),a("link.to.percent",null),a("link.to.at.edge",!0),a("link.split.by.percent",!0),a("link.split.percent",.5),a("link.split.value",20),a("link.corner","round"),a("link.xradius",8),a("link.yradius",8),a("link.flow",!1),a("link.flow.converse",!1),a("link.flow.offset",0),
a("link.handler.alpha",1),a("link.handler.color","#000000"),a("link.handler.font",null),a("link.handler.position","topleft.topleft"),a("link.handler.direction","below"),a("link.handler.corner.radius",0),a("link.handler.pointer.length",0),a("link.handler.pointer.width",8),a("link.handler.xoffset",0),a("link.handler.yoffset",0),a("link.handler.padding",0),a("link.handler.padding.left",0),a("link.handler.padding.right",0),a("link.handler.padding.top",0),a("link.handler.padding.bottom",0),a("link.handler.fill",!1),a("link.handler.fill.color","#C0C0C0"),a("link.handler.gradient","none"),a("link.handler.gradient.color","#FFFFFF"),a("link.handler.outline.width",-1),a("link.handler.outline.color","#000000"),a("link.handler.cap","butt"),a("link.handler.join","miter"),a("link.handler.shadowable",!0),a("link.agent",!1),a("link.agent.color","#658DC1"),a("link.agent.width",3),a("link.agent.cap","butt"),a("link.agent.join","miter"),a("link.agent.type","arc"),a("link.agent.pattern",null,"array.number"),a("link.agent.extend",20),a("link.agent.control.point",null,"point"),a("link.agent.from.position","center"),a("link.agent.from.xoffset",0),a("link.agent.from.yoffset",0),a("link.agent.from.percent",null),a("link.agent.from.at.edge",!0),a("link.agent.to.position","center"),a("link.agent.to.xoffset",0),a("link.agent.to.yoffset",0),a("link.agent.to.percent",null),a("link.agent.to.at.edge",!0),a("link.agent.split.by.percent",!0),a("link.agent.split.percent",.5),a("link.agent.split.value",20),a("link.agent.corner","round"),a("link.agent.xradius",8),a("link.agent.yradius",8),a("link.agent.flow",!1),a("link.agent.flow.converse",!1),a("link.agent.flow.offset",0),a("follower.row.index",0),a("follower.column.index",0),a("follower.row.span",1),a("follower.column.span",1),a("follower.padding",0),a("follower.padding.left",0),a("follower.padding.right",0),a("follower.padding.top",0),a("follower.padding.bottom",0),a("follower.fill.cell",!0),a("follower.cell.position","center"),a("glow.blur",20),a("grid.row.count",1),a("grid.column.count",1),a("grid.row.percents",null,"array.number"),a("grid.column.percents",null,"array.number"),a("grid.border",1),a("grid.border.left",0),a("grid.border.right",0),a("grid.border.top",0),a("grid.border.bottom",0),a("grid.padding",1),a("grid.padding.left",0),a("grid.padding.right",0),a("grid.padding.top",0),a("grid.padding.bottom",0),a("grid.fill",!0),a("grid.fill.color","#C0C0C0"),a("grid.deep",1),a("grid.cell.deep",-1),a("shapelink.type","lineto"),a("shapenode.closed",!1),a("shapenode.pattern",null,"array.number"),a("bus.style","nearby"),a("arrow.from",!1),a("arrow.from.fill",!0),a("arrow.from.shape","arrow.standard"),a("arrow.from.color","#000000"),a("arrow.from.xoffset",0),a("arrow.from.yoffset",0),a("arrow.from.width",12),a("arrow.from.height",9),a("arrow.from.outline.color","#000000"),a("arrow.from.outline.width",-1),a("arrow.from.at.edge",!0),a("arrow.from.shadow",!1),a("arrow.from.shadow.color","#000000"),a("arrow.from.shadow.xoffset",0),a("arrow.from.shadow.yoffset",0),a("arrow.from.shadow.blur",16),a("arrow.to",!1),a("arrow.to.fill",!0),a("arrow.to.shape","arrow.standard"),a("arrow.to.color","#000000"),a("arrow.to.xoffset",0),a("arrow.to.yoffset",0),a("arrow.to.width",12),a("arrow.to.height",9),a("arrow.to.outline.color","#000000"),a("arrow.to.outline.width",-1),a("arrow.to.at.edge",!0),a("arrow.agent.from",!1),a("arrow.agent.from.fill",!0),a("arrow.agent.from.shape","arrow.standard"),a("arrow.agent.from.color","#000000"),a("arrow.agent.from.xoffset",0),a("arrow.agent.from.yoffset",0),a("arrow.agent.from.width",12),a("arrow.agent.from.height",9),a("arrow.agent.from.outline.color","#000000"),a("arrow.agent.from.outline.width",-1),a("arrow.agent.from.at.edge",!0),a("arrow.agent.from.shadow",!1),a("arrow.agent.from.shadow.color","#000000"),a("arrow.agent.from.shadow.xoffset",0),a("arrow.agent.from.shadow.yoffset",0),a("arrow.agent.from.shadow.blur",16),a("arrow.agent.to",!1),a("arrow.agent.to.fill",!0),a("arrow.agent.to.shape","arrow.standard"),a("arrow.agent.to.color","#000000"),a("arrow.agent.to.xoffset",0),a("arrow.agent.to.yoffset",0),a("arrow.agent.to.width",12),a("arrow.agent.to.height",9),a("arrow.agent.to.outline.color","#000000"),a("arrow.agent.to.outline.width",-1),a("arrow.agent.to.at.edge",!0),a("background.image",null),a("background.image.scope","viewport"),a("background.type","none"),a("background.outline.width",-1),a("background.outline.color",null),a("background.vector.padding",0),a("background.image.padding",0),a("background.image.stretch","fill"),a("background.vector.scope","viewport"),a("background.vector.fill",null),a("background.vector.fill.color",null),a("background.vector.gradient",!1),a("background.vector.gradient.color",null),a("background.vector.shape","rectangle"),a("background.outline.pattern",null,"array.number"),a("attachment.label.style","html"),a("attachment.label2.style","html"),a("attachment.alarm.style","html"),a("attachment.htmllabel.hyperlink",!1),a("attachment.htmllabel2.hyperlink",!1)}(),Hb.ext("twaver.Styles",Object,{}),Gb.PropertyChangeDispatcher=function(){this._dispatcher=new Gb.EventDispatcher},Hb.ext("twaver.PropertyChangeDispatcher",Object,{addPropertyChangeListener:function(a,b,c){this._dispatcher.add(a,b,c)},removePropertyChangeListener:function(a,b){this._dispatcher.remove(a,b)},firePropertyChange:function(a,b,c){if(b==c)return!1;var d={property:a,oldValue:b,newValue:c,source:this};return this._dispatcher.fire(d),this.onPropertyChanged(d),!0},onPropertyChanged:function(a){}}),Gb.animate.Animate=function(){},Hb.ext("twaver.animate.Animate",Object,{current:0,step:8,delay:4,finishFunction:null,shouldBeFinished:!1,getCurrentDelay:function(){return this.delay*this.current+1},action:function(a){}}),Gb.animate.AnimateProperty=function(a,b,c){this.objects=a,this.newValues=b,this.finishFunction=c,this.oldValues=new md;for(var d=this.objects.size(),e=0;d>e;e++){var f=this.objects.get(e);this.oldValues.add(this.getPropertyValue(f))}},Hb.ext("twaver.animate.AnimateProperty",Gb.animate.Animate,{action:function(a){for(var b=this.objects.size(),c=0;b>c;c++){var d=this.objects.get(c),e=this.oldValues.get(c),f=this.newValues.get(c);this.currentAction(d,e,f,a)}},getPropertyValue:function(a){},currentAction:function(a,b,c,d){}}),Gb.animate.AnimateBounds=function(a,b,c){this.node=a,this.newBounds=b,this.oldBounds=a.getRect(),this.finishFunction=c},Hb.ext("twaver.animate.AnimateBounds",Gb.animate.Animate,{shouldBeFinished:!0,action:function(a){var b=this.oldBounds,c=this.newBounds;this.node.setLocation(b.x+(c.x-b.x)*a,b.y+(c.y-b.y)*a),this.node.setSize(b.width+(c.width-b.width)*a,b.height+(c.height-b.height)*a)}}),Gb.animate.AnimateCenterLocation=function(a,b,c){Gb.animate.AnimateCenterLocation.superClass.constructor.call(this,a,b,c)},Hb.ext("twaver.animate.AnimateCenterLocation",Gb.animate.AnimateProperty,{getPropertyValue:function(a){return a.getCenterLocation()},currentAction:function(a,b,c,d){var e=b.x+(c.x-b.x)*d,f=b.y+(c.y-b.y)*d;a.setCenterLocation(e,f)}}),Gb.animate.AnimateLocation=function(a,b,c){Gb.animate.AnimateLocation.superClass.constructor.call(this,a,b,c)},Hb.ext("twaver.animate.AnimateLocation",Gb.animate.AnimateProperty,{getPropertyValue:function(a){return a.getLocation()},currentAction:function(a,b,c,d){var e=b.x+(c.x-b.x)*d,f=b.y+(c.y-b.y)*d;a.setLocation(e,f)}}),Gb.animate.AnimateScrollPosition=function(a,b,c){this.view=a,this.oldHorizontalOffset=a.scrollLeft,this.oldVerticalOffset=a.scrollTop,this.newHorizontalOffset=b,this.newVerticalOffset=c},Hb.ext("twaver.animate.AnimateScrollPosition",Gb.animate.Animate,{action:function(a){this.view.scrollLeft=this.oldHorizontalOffset+(this.newHorizontalOffset-this.oldHorizontalOffset)*a,this.view.scrollTop=this.oldVerticalOffset+(this.newVerticalOffset-this.oldVerticalOffset)*a}}),Gb.animate.AnimateZoom=function(a,b,c){this.view=a,this.oldZoom=a.getZoom(),this.newZoom=b,this.finishFunction=c},Hb.ext("twaver.animate.AnimateZoom",Gb.animate.Animate,{shouldBeFinished:!0,action:function(a){this.view.setZoom(this.oldZoom+(this.newZoom-this.oldZoom)*a,!1)}}),Gb.animate.AnimateXZoom=function(a,b,c){this.view=a,this.oldXZoom=a.getXZoom(),this.newXZoom=b,this.finishFunction=c},Hb.ext("twaver.animate.AnimateXZoom",Gb.animate.Animate,{shouldBeFinished:!0,action:function(a){this.view.setXZoom(this.oldXZoom+(this.newXZoom-this.oldXZoom)*a,!1)}}),Gb.animate.AnimateYZoom=function(a,b,c){this.view=a,this.oldYZoom=a.getYZoom(),this.newYZoom=b,this.finishFunction=c},Hb.ext("twaver.animate.AnimateYZoom",Gb.animate.Animate,{shouldBeFinished:!0,action:function(a){this.view.setYZoom(this.oldYZoom+(this.newYZoom-this.oldYZoom)*a,!1)}}),Gb.animate.AnimateXYZoom=function(a,b,c,d){this.view=a,this.oldXZoom=a.getXZoom(),this.newXZoom=b,this.oldYZoom=a.getYZoom(),this.newYZoom=c,this.finishFunction=d},Hb.ext("twaver.animate.AnimateXYZoom",Gb.animate.Animate,{shouldBeFinished:!0,action:function(a){this.view.setXZoom(this.oldXZoom+(this.newXZoom-this.oldXZoom)*a,!1),this.view.setYZoom(this.oldYZoom+(this.newYZoom-this.oldYZoom)*a,!1)}}),Gb.animate.AnimateSubNetwork=function(a,b,c){this.network=a,this.subNetwork=b,this.finishFunction=c},Hb.ext("twaver.animate.AnimateSubNetwork",Gb.animate.Animate,{shouldBeFinished:!0,action:function(a){a>.5?(this.network.getView().style.opacity=2*a-1,this.network._setCurrentSubNetwork(this.subNetwork)):this.network.getView().style.opacity=1-2*a}}),Gb.animate.AnimateManager={timer:null,animate:null,start:function(a,b){var c=Gb.animate.AnimateManager;a.current<0&&(a.current=0),b?Hb.callLater(c.startImpl,null,[a],b):c.startImpl(a)},startImpl:function(a){var b=Gb.animate.AnimateManager;b.animate&&b.endAnimate(),b.animate=a,b.timer=setTimeout(b.tick,a.getCurrentDelay())},tick:function(){var a=Gb.animate.AnimateManager,b=a.animate;if(b){if(b.current<0)return void b.current++;b.current<b.step&&(b.current++,b.action(b.current/b.step),a.timer=setTimeout(a.tick,b.getCurrentDelay())),b.current>=b.step&&a.endAnimate()}},endAnimate:function(){var a=Gb.animate.AnimateManager;if(a.animate){a.animate.shouldBeFinished&&a.animate.current<a.animate.step&&(a.animate.current=a.animate.step,a.animate.action(a.animate.current/a.animate.step));var b=a.animate.finishFunction;a.animate=null,a.timer&&(clearTimeout(a.timer),a.timer=null),b&&b()}else a.timer&&(clearTimeout(a.timer),a.timer=null)}},Gb.DataBox=function(a){Gb.DataBox.superClass.constructor.apply(this,arguments),1===arguments.length&&(this._name=a),this._dataList=new md,this._dataMap={},this._rootList=new md,this._rootMap={},this._clientMap={},this._dataBoxChangeDispatcher=new Gb.EventDispatcher,this._dataPropertyChangeDispatcher=new Gb.EventDispatcher,this._hierarchyChangeDispatcher=new Gb.EventDispatcher,this._selectionModel=new Gb.SelectionModel(this)},Hb.ext("twaver.DataBox",Gb.PropertyChangeDispatcher,{IClient:!0,__client:1,__new:1,_limit:-1,_name:"DataBox",_icon:Dd.ICON_DATABOX,__accessor:["name","icon","toolTip"],getSelectionModel:function(){return this._selectionModel},size:function(){return this._dataList.size()},isEmpty:function(){return this._dataList.isEmpty()},getLimit:function(){return this._limit},setLimit:function(a){var b=this._limit;this._limit=a,this.firePropertyChange("limit",b,a),this._checkLimit()},_checkLimit:function(){this._limit>=0&&this.size()>this._limit&&this.removeFirst(this.size()-this._limit)},removeFirst:function(a){for(0===arguments.length&&(a=1);a>0&&this._dataList.size()>0;){var b=this._dataList.get(0);this.remove(b),a--}},getSiblings:function(a){if(!this.contains(a))throw a+" dosen't belong to this dataBox";var b=a.getParent();return b?b.getChildren():this._rootList},getRoots:function(){return this._rootList},getSiblingIndex:function(a){return a.getParent()?a.getParent().getChildren().indexOf(a):this._rootList.indexOf(a)},getDatas:function(){return this._dataList},getDataAt:function(a){return this._dataList.get(a)},toDatas:function(a,b){return this._dataList.toList(a,b)},forEach:function(a,b){this._dataList.forEach(a,b)},forEachReverse:function(a,b){this._dataList.forEachReverse(a,b)},forEachByDepthFirst:function(a,b,c){if(b)this._depthFirst(a,b,c);else for(var d=this._rootList.size(),e=0;d>e;e++){var f=this._rootList.get(e);if(this._depthFirst(a,f,c)===!1)return}},_depthFirst:function(a,b,c){for(var d=b.getChildrenSize(),e=0;d>e;e++){var f=b.getChildAt(e);if(this._depthFirst(a,f,c)===!1)return!1}if(c){if(a.call(c,b)===!1)return!1}else if(a(b)===!1)return!1},forEachByBreadthFirst:function(a,b,c){var d=new md;for(b?d.add(b):this._rootList.forEach(d.add,d);d.size()>0;)if(b=d.removeAt(0),b.getChildren().forEach(d.add,d),c){if(a.call(c,b)===!1)return}else if(a(b)===!1)return},add:function(a,b){if(a){1===arguments.length&&(b=-1);var c=a.getId();if(this._dataMap.hasOwnProperty(c))throw"Data with ID '"+c+"' already exists";this._dataBoxChangeDispatcher.fire({kind:"preAdd",data:a}),this._dataMap[c]=a,this._dataList.add(a),a.getParent()||(this._rootMap[c]=a,b>=0?this._rootList.add(a,b):this._rootList.add(a)),a.addPropertyChangeListener(this.handleDataPropertyChange,this,!0),this._dataBoxChangeDispatcher.fire({kind:"add",data:a}),this._checkLimit()}},addByDescendant:function(a){this.add(a),a.getChildren().size()>0&&a.getChildren().forEach(function(a){this.addByDescendant(a)},this)},remove:function(a){this.removeById(a.getId())},removeSelection:function(){this._selectionModel.toSelection().forEach(function(a){this.remove(a)},this)},removeById:function(a){var b=this.getDataById(a);b&&(this._dataBoxChangeDispatcher.fire({kind:"preRemove",data:b}),b instanceof Gb.Link&&(b.setFromNode(null),b.setToNode(null)),b instanceof Ld&&b.getLinks()&&b.getLinks().toList().forEach(function(a){this.remove(a)},this),b instanceof Ld&&b.getFollowers()&&b.getFollowers().toList().forEach(function(a){a.setHost(null)}),b instanceof Gb.Follower&&b.getHost()&&b.setHost(null),b.toChildren().forEach(function(a){this.remove(a)},this),b.getParent()&&b.getParent().removeChild(b),this._dataList.remove(b),delete this._dataMap[a],this._rootMap[a]&&(delete this._rootMap[a],this._rootList.remove(b)),this._dataBoxChangeDispatcher.fire({kind:"remove",data:b}),b.removePropertyChangeListener(this.handleDataPropertyChange,this))},clear:function(){if(this._dataList.size()>0){this._dataList.forEach(function(a){a.removePropertyChangeListener(this.handleDataPropertyChange,this)},this);var a=this._dataList.toList();this._dataList.clear(),this._dataMap={},this._rootList.clear(),this._rootMap={},this._dataBoxChangeDispatcher.fire({kind:"clear",datas:a})}},getDataById:function(a){return this._dataMap[a]},containsById:function(a){return this._dataMap.hasOwnProperty(a)},contains:function(a){return a?this._dataMap[a._id]===a:!1},moveTo:function(a,b){if(!this.contains(a))throw a+" dosen't belong to this dataBox";var c=this.getSiblings(a),d=c.indexOf(a);d===b||0>d||b>=0&&b<=c.size()&&(c.remove(a),b>c.size()&&b--,c.add(a,b),this._hierarchyChangeDispatcher.fire({data:a,oldIndex:d,newIndex:b}))},moveUp:function(a){var b=this.getSiblings(a);this.moveTo(a,b.indexOf(a)-1)},moveDown:function(a){var b=this.getSiblings(a);this.moveTo(a,b.indexOf(a)+1)},moveToTop:function(a){this.moveTo(a,0)},moveToBottom:function(a){var b=this.getSiblings(a);this.moveTo(a,b.size())},moveSelectionUp:function(a){a||(a=this._selectionModel);var b=new md;xc.findMoveUpDatas(a,b,this._rootList),b.forEach(this.moveUp,this)},moveSelectionDown:function(a){a||(a=this._selectionModel);var b=new md;xc.findMoveDownDatas(a,b,this._rootList),b.forEach(this.moveDown,this)},moveSelectionToTop:function(a){a||(a=this._selectionModel);var b=new md;xc.findMoveToTopDatas(a,b,this._rootList),b.forEach(this.moveToTop,this)},moveSelectionToBottom:function(a){a||(a=this._selectionModel);var b=new md;xc.findMoveToBottomDatas(a,b,this._rootList),b.forEach(this.moveToBottom,this)},handleDataPropertyChange:function(a){var b=a.source;if("parent"===a.property){var c=b.getId();b.getParent()?this._rootMap[c]&&(delete this._rootMap[c],this._rootList.remove(b)):this._rootMap[c]||(this._rootMap[c]=b,this._rootList.add(b))}this.onDataPropertyChanged(b,a),this._dataPropertyChangeDispatcher.fire(a)},onDataPropertyChanged:function(a,b){},addDataBoxChangeListener:function(a,b,c){this._dataBoxChangeDispatcher.add(a,b,c)},removeDataBoxChangeListener:function(a,b){this._dataBoxChangeDispatcher.remove(a,b)},addDataPropertyChangeListener:function(a,b,c){this._dataPropertyChangeDispatcher.add(a,b,c)},removeDataPropertyChangeListener:function(a,b){this._dataPropertyChangeDispatcher.remove(a,b)},addHierarchyChangeListener:function(a,b,c){this._hierarchyChangeDispatcher.add(a,b,c)},removeHierarchyChangeListener:function(a,b){this._hierarchyChangeDispatcher.remove(a,b)},getRandomData:function(a){if(a){for(var b=new Gb.List,c=0;c<this._dataList.size()-1;c++){var d=this._dataList.get(c);d instanceof a&&b.add(d)}if(0==b.size())return null}var e=a?b.get(parseInt(Gb.Util.random()*b.size())):this._dataList.get(parseInt(Gb.Util.random()*this._dataList.size()));return e}}),Gb.ElementBox=function(a){Gb.ElementBox.superClass.constructor.apply(this,arguments),this._styleMap={},this._alarmBox=new Gb.AlarmBox(this),this._layerBox=new Gb.LayerBox(this),this._alarmStatePropagator=new Gb.AlarmStatePropagator(this),this._alarmStatePropagator.setEnable(!0),this._indexChangeDispatcher=new Gb.EventDispatcher,this._undoManager=new Gb.UndoManager(this)},Gb.ElementBox.IS_INTERESTED_ADJUSTELEMENTINDEX_PROPERTY={fromAgent:1,toAgent:1,expanded:1,parent:1,host:1},Hb.ext("twaver.ElementBox",Gb.DataBox,{IStyle:!0,__style:1,_name:"ElementBox",add:function(a,b){if(a){if(!a.IElement)throw"Only IElement can be added into ElementBox";Gb.ElementBox.superClass.add.apply(this,arguments),this.adjustElementIndex(a)}},onDataPropertyChanged:function(a,b){Gb.ElementBox.IS_INTERESTED_ADJUSTELEMENTINDEX_PROPERTY[b.property]&&this.adjustElementIndex(a),Gb.ElementBox.superClass.onDataPropertyChanged.apply(this,arguments)},addIndexChangeListener:function(a,b,c){this._indexChangeDispatcher.add(a,b,c)},removeIndexChangeListener:function(a,b){this._indexChangeDispatcher.remove(a,b)},sendToTop:function(a){if(this.contains(a)){if(a!==this.getDatas().get(this.size()-1)){var b=this.getDatas().indexOf(a);this.getDatas().removeAt(b),this.getDatas().add(a),this._indexChangeDispatcher.fire({element:a,oldIndex:b,newIndex:this.size()-1})}a instanceof Gb.Link&&(a.getFromAgent()&&!a.getFromAgent().isAdjustedToBottom()&&this.sendToTop(a.getFromAgent()),a.getToAgent()&&!a.getToAgent().isAdjustedToBottom()&&this.sendToTop(a.getToAgent())),a instanceof Ld&&a.getFollowers()&&a.getFollowers().forEach(function(b){b.isRelatedTo(a)||a instanceof Gb.Follower&&b.isLoopedHostOn(a)||this.sendToTop(b)},this),a.ISubNetwork||a instanceof Nd&&!a.isExpanded()||a.getChildren().forEach(function(a){a instanceof Gb.Link||this.sendToTop(a)},this)}},sendToBottom:function(a,b){if(a!==b&&this.contains(a)&&(!b||this.contains(b))){var c=this.getDatas().remove(a),d=0;b&&(d=this.getDatas().indexOf(b)),this.getDatas().add(a,d),c!=d&&(this._indexChangeDispatcher.fire({element:a,oldIndex:c,newIndex:d}),!a.getParent()||a.getParent().ISubNetwork||a.getParent()instanceof Gb.Link||this.sendToBottom(a.getParent(),a))}},fireIndexChange:function(a,b,c){this._indexChangeDispatcher.fire({element:a,oldIndex:b,newIndex:c})},adjustElementIndex:function(a){this.contains(a)&&(a.isAdjustedToBottom()?(this.sendToBottom(a),a.getChildren().forEach(this.adjustElementIndex,this)):this.sendToTop(a))},forEachByLayer:function(a,b,c){var d=this.size(),e=this.getDatas();if(b)for(var f=0;d>f;f++){var g=e.get(f);if(this._layerBox.getLayerByElement(g)===b)if(c){if(a.call(c,g)===!1)return}else if(a(g)===!1)return}else this._layerBox.forEachByDepthFirst(function(b){for(var f=0;d>f;f++){var g=e.get(f);if(this._layerBox.getLayerByElement(g)===b)if(c){if(a.call(c,g)===!1)return}else if(a(g)===!1)return}},null,this)},forEachByLayerReverse:function(a,b,c){var d=new md;this.forEachByLayer(function(a){d.add(a,0)},b),d.forEach(a,c)},getLayerBox:function(){return this._layerBox},getAlarmBox:function(){return this._alarmBox},getAlarmStatePropagator:function(){return this._alarmStatePropagator},startBatch:function(a,b){Gb._isInitializing=!0,Gb._bundleLinks={},Gb._links={},a.call(b);var c,d;for(var e in Gb._links)c=Gb._links[e],c._checkAgentNodeImpl();for(var e in Gb._bundleLinks)d=Gb._bundleLinks[e],uc.resetBundleLinks(d[0],d[1]);Gb._bundleLinks=null,Gb._links=null,Gb._isInitializing=!1},getUndoManager:function(){return this._undoManager}}),Gb.SelectionModel=function(a){Gb.SelectionModel.superClass.constructor.apply(this,arguments),this._selectionMode="multipleSelection",this._selectionList=new md,this._selectionChangeDispatcher=new Gb.EventDispatcher,this._selectionMap={},this._setDataBox(a)},Hb.ext("twaver.SelectionModel",Gb.PropertyChangeDispatcher,{getSelectionMode:function(){return this._selectionMode},setSelectionMode:function(a){if(this._selectionMode!==a&&("noneSelection"===a||"singleSelection"===a||"multipleSelection"===a)){this.clearSelection();var b=this._selectionMode;this._selectionMode=a,this.firePropertyChange("selectionMode",b,this._selectionMode)}},getDataBox:function(){return this._dataBox},_setDataBox:function(a){if(!a)throw"dataBox can not be null";if(this._dataBox!==a){this._dataBox&&(this.clearSelection(),this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this));var b=this._dataBox;this._dataBox=a,this._dataBox.addDataBoxChangeListener(this.handleDataBoxChange,this,!0),this.firePropertyChange("dataBox",b,this._dataBox)}},dispose:function(){this.clearSelection(),this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this)},handleDataBoxChange:function(a){if("remove"===a.kind){var b=a.data;this.contains(b)&&(this._selectionList.remove(b),delete this._selectionMap[b.getId()],this.fireSelectionChange("remove",new md(b)))}else"clear"===a.kind&&this.clearSelection()},getFilterFunction:function(){return this._filterFunction},setFilterFunction:function(a){if(this._filterFunction!==a){this.clearSelection();var b=this._filterFunction;this._filterFunction=a,this.firePropertyChange("filterFunction",b,this._filterFunction)}},fireSelectionChange:function(a,b,c){c&&(this._selectionList.forEach(function(a){c.contains(a)?c.remove(a):c.add(a)}),b=c.toList()),this._selectionChangeDispatcher.fire({kind:a,datas:new md(b)})},addSelectionChangeListener:function(a,b,c){this._selectionChangeDispatcher.add(a,b,c)},removeSelectionChangeListener:function(a,b){this._selectionChangeDispatcher.remove(a,b)},_filterList:function(a,b){for(var c=new md(a),d=0;d<c.size();d++){var e=c.get(d);(this._filterFunction&&!this._filterFunction(e)||b&&this.contains(e)||!b&&!this.contains(e)||!this._dataBox.contains(e))&&(c.removeAt(d),d--)}return c},appendSelection:function(a){if("noneSelection"!==this._selectionMode){var b=this._filterList(a,!0);if(!b.isEmpty()){var c=null;"singleSelection"===this._selectionMode&&(c=new md(this._selectionList),this._selectionList.clear(),this._selectionMap={},b=new md(b.get(b.size()-1)));for(var d=0;d<b.size();d++){var e=b.get(d);this._selectionList.add(e),this._selectionMap[e.getId()]=e}this.fireSelectionChange("append",b,c)}}},removeSelection:function(a){var b=this._filterList(a);if(0!==b.size()){for(var c=0;c<b.size();c++){var d=b.get(c);this._selectionList.remove(d),delete this._selectionMap[d.getId()]}this.fireSelectionChange("remove",b)}},toSelection:function(a,b){return this._selectionList.toList(a,b)},getSelection:function(){return this._selectionList},setSelection:function(a){if("noneSelection"!==this._selectionMode&&(0!==this._selectionList.size()||null!=a)){var b=new md(this._selectionList);this._selectionList.clear(),this._selectionMap={};var c=this._filterList(a,!0);"singleSelection"===this._selectionMode&&c.size()>1&&(c=new md(c.get(c.size()-1)));for(var d=0;d<c.size();d++){var e=c.get(d);this._selectionList.add(e),this._selectionMap[e.getId()]=e}this.fireSelectionChange("set",null,b)}},clearSelection:function(){if(this._selectionList.size()>0){var a=this._selectionList.toList();this._selectionList.clear(),this._selectionMap={},this.fireSelectionChange("clear",a)}},selectAll:function(){if("noneSelection"!==this._selectionMode){var a=this._dataBox.toDatas(),b=0,c=null;if(this._filterFunction)for(b=0;b<a.size();b++)c=a.get(b),this._filterFunction(c)||(a.removeAt(b),b--);var d=new md(this._selectionList);for(this._selectionList.clear(),this._selectionMap={},"singleSelection"===this._selectionMode&&a.size()>1&&(a=new md(a.get(a.size()-1))),b=0;b<a.size();b++)c=a.get(b),this._selectionList.add(c),this._selectionMap[c.getId()]=c;this.fireSelectionChange("all",null,d)}},size:function(){return this._selectionList.size()},contains:function(a){return a?null!=this._selectionMap[a.getId()]:!1},getLastData:function(){return this._selectionList.size()>0?this._selectionList.get(this._selectionList.size()-1):null},getFirstData:function(){return this._selectionList.size()>0?this._selectionList.get(0):null},isSelectable:function(a){return a?"noneSelection"===this._selectionMode?!1:this._filterFunction&&!this._filterFunction(a)?!1:!0:!1}}),Gb.QuickFinder=function(a,b,c,d,e){if(this._map={},!a)throw"dataBox can not be null";if(!b)throw"propertyName can not be null";this._dataBox=a,this._propertyName=b,this._propertyType=c||"accessor","accessor"===this._propertyType&&(this._getter=Hb.getter(b)),this._valueFunction=d||this.getValue,this._filterFunction=e||this.isInterested,this._dataBox.forEach(this._addData,this),this._dataBox.addDataBoxChangeListener(this.handleDataBoxChange,this,!0),this._dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this,!0)},Hb.ext("twaver.QuickFinder",Object,{_NULL_:"twaver-null-key",getValueFunction:function(){return this._valueFunction},getFilterFunction:function(){return this._filterFunction},handleDataBoxChange:function(a){"add"===a.kind?this._addData(a.data):"remove"===a.kind?this._removeData(a.data):"clear"===a.kind&&(this._map={})},handleDataPropertyChange:function(a){if(this._filterFunction.call(this,a.source)){if("accessor"===this._propertyType&&this._propertyName===a.property);else if("style"===this._propertyType&&a.source.IStyle&&"S:"+this._propertyName===a.property);else if("client"!==this._propertyType||"C:"+this._propertyName!==a.property)return;var b=this._getMap(a.oldValue);b&&b.remove(a.source),this._addData(a.source)}},_getMap:function(a){return a=null==a?this._NULL_:a,this._map[a]},find:function(a){var b=this._getMap(a);return b?b.toList():new md},findFirst:function(a){var b=this._getMap(a);return!b||b.isEmpty()?null:b.get(0)},_addData:function(a){if(this._filterFunction.call(this,a)){var b=this._valueFunction.call(this,a),c=this._getMap(b);c||(c=new md,b=null==b?this._NULL_:b,this._map[b]=c),c.add(a)}},_removeData:function(a){if(this._filterFunction.call(this,a)){var b=this._valueFunction.call(this,a),c=this._getMap(b);c&&(c.remove(a),c.isEmpty()&&(b=null==b?this._NULL_:b,delete this._map[b]))}},dispose:function(){this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this),this._dataBox.removeDataPropertyChangeListener(this.handleDataPropertyChange,this),delete this._dataBox},getDataBox:function(){return this._dataBox},getPropertyType:function(){return this._propertyType},getPropertyName:function(){return this._propertyName},isInterested:function(a){return("style"!==this._propertyType||a.IStyle)&&("accessor"!==this._propertyType||this._valueFunction!==this.getValue||a[this._getter])?!0:!1},getValue:function(a){return"accessor"===this._propertyType?a[this._getter]():"style"===this._propertyType&&a.getStyle?a.getStyle(this._propertyName):"client"===this._propertyType&&a.getClient?a.getClient(this._propertyName):null}}),Gb.PropertyPropagator=function(a,b,c){if(!a)throw"dataBox can not be null";if(!b)throw"propertyName can not be null";this._dataBox=a,this._propertyName=b,this._propertyType=c||"accessor","accessor"===this._propertyType&&(this._getter=Hb.getter(b),this._setter=Hb.setter(b)),this._enable=!1,this._isPropagating=!1},Hb.ext("twaver.PropertyPropagator",Object,{getDataBox:function(){return this._dataBox},getPropertyType:function(){return this._propertyType},getPropertyName:function(){return this._propertyName},isEnable:function(){return this._enable},setEnable:function(a){this._enable!==a&&(this._enable=a,this._enable?(this._dataBox.addDataBoxChangeListener(this.handleDataBoxChange,this),this._dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this),this._dataBox.forEach(function(a){this.propagate(a)},this)):(this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this),this._dataBox.removeDataPropertyChangeListener(this.handleDataPropertyChange,this)))},handleDataBoxChange:function(a){a.data&&this.propagate(a.data)},handleDataPropertyChange:function(a){if(this.isInterestedProperty(a))this.propagate(a.source);else if("parent"===a.property){var b=a.oldValue;b&&this.propagate(b),this.propagate(a.source)}},isInterestedProperty:function(a){return"accessor"===this._propertyType&&this._propertyName===a.property?!0:"style"===this._propertyType&&a.IElement&&"S:"+this._propertyName===a.property?!0:"client"===this._propertyType&&"C:"+this._propertyName===a.property?!0:!1},propagate:function(a){a&&!this._isPropagating&&(this._isPropagating=!0,this.propagateToTop(a),this._isPropagating=!1)},propagateToTop:function(a){for(this.propagateToParent(null,a);a&&a.getParent();)this.propagateToParent(a,a.getParent()),a=a.getParent()},propagateToParent:function(a,b){}}),Gb.AlarmStatePropagator=function(a){Gb.AlarmStatePropagator.superClass.constructor.call(this,a,"alarmState")},Hb.ext("twaver.AlarmStatePropagator",Gb.PropertyPropagator,{handleDataPropertyChange:function(a){"enablePropagation"===a.property?this.propagate(a.source):Gb.AlarmStatePropagator.superClass.handleDataPropertyChange.call(this,a)},propagateToParent:function(a,b){var c=null;b.getChildren().forEach(function(a){var b=a.getAlarmState().getHighestOverallAlarmSeverity();Gb.AlarmSeverity.compare(b,c)>0&&(c=b)}),b.getAlarmState().setPropagateSeverity(c)}}),Gb.AlarmSeverity=function(a,b,c,d,e){this.value=a,this.name=b,this.nickName=c,this.color=d,this.displayName=e},Hb.ext("twaver.AlarmSeverity",Object,{toString:function(){return this.displayName?this.displayName:this.name}}),function(){var a=Gb.AlarmSeverity;a.severities=new md,a._vm={},a._nm={},a._cp=function(a,b){if(a&&b){var c=a.value-b.value;return c>0?1:0>c?-1:0}return a&&!b?1:!a&&b?-1:0},a.forEach=function(b,c){a.severities.forEach(b,c)},a.getSortFunction=function(){return a._cp},a.setSortFunction=function(b){a._cp=b,a.severities.sort(b)},a.add=function(b,c,d,e,f){var g=new a(b,c,d,e,f);return a._vm[b]=g,a._nm[c]=g,a.severities.add(g),a.severities.sort(a._cp),g},a.remove=function(b){var c=a._nm[b];return c&&(delete a._nm[b],delete a._vm[c.value],a.severities.remove(c)),c},a.CRITICAL=a.add(500,"Critical","C","#FF0000"),a.MAJOR=a.add(400,"Major","M","#FFA000"),a.MINOR=a.add(300,"Minor","m","#FFFF00"),a.WARNING=a.add(200,"Warning","W","#00FFFF"),a.INDETERMINATE=a.add(100,"Indeterminate","N","#C800FF"),a.CLEARED=a.add(0,"Cleared","R","#00FF00"),a.isClearedAlarmSeverity=function(a){return a?0===a.value:!1},a.getByName=function(b){return a._nm[b]},a.getByValue=function(b){return a._vm[b]},a.clear=function(){a.severities.clear(),a._vm={},a._nm={}},a.compare=function(b,c){return a._cp(b,c)}}(),Gb.AlarmState=function(a){this._e=a,this._nm={},this._am={},this._ps=null,this._haa=null,this._hna=null,this._hoa=null,this._hta=null,this._hls=!1,this._aac=0,this._nac=0},Hb.ext("twaver.AlarmState",Object,{_ep:!0,_f:function(){this._c1(),this._c2(),this._c3(),this._c4(),this._c5(),this._c6(),this._c7(),this._e.firePropertyChange("alarmState",null,this)},getHighestAcknowledgedAlarmSeverity:function(){return this._haa},getHighestNewAlarmSeverity:function(){return this._hna},getHighestOverallAlarmSeverity:function(){return this._hoa},getHighestNativeAlarmSeverity:function(){
return this._hta},hasLessSevereNewAlarms:function(){return this._hls},_c1:function(){var a=null;for(var b in this._am)b=Gb.AlarmSeverity.getByName(b),Gb.AlarmSeverity.isClearedAlarmSeverity(b)||0!==this.getAcknowledgedAlarmCount(b)&&(a=a&&Gb.AlarmSeverity.compare(a,b)>0?a:b);this._haa=a},_c2:function(){var a=null;for(var b in this._nm)b=Gb.AlarmSeverity.getByName(b),Gb.AlarmSeverity.isClearedAlarmSeverity(b)||0!==this.getNewAlarmCount(b)&&(a=a&&Gb.AlarmSeverity.compare(a,b)>0?a:b);this._hna=a},_c3:function(){if(!this._hna)return void(this._hls=!1);for(var a in this._nm)if(a=Gb.AlarmSeverity.getByName(a),!Gb.AlarmSeverity.isClearedAlarmSeverity(a)&&0!==this.getNewAlarmCount(a)&&Gb.AlarmSeverity.compare(this._hna,a)>0)return void(this._hls=!0);this._hls=!1},_c4:function(){var a=this._haa,b=this._hna,c=this._ps;this._hoa=a,Gb.AlarmSeverity.compare(b,this._hoa)>0&&(this._hoa=b),Gb.AlarmSeverity.compare(c,this._hoa)>0&&(this._hoa=c)},_c5:function(){var a=this._haa,b=this._hna;this._hta=a,Gb.AlarmSeverity.compare(b,this._hta)>0&&(this._hta=b)},increaseAcknowledgedAlarm:function(a,b){if(null==b&&(b=1),0!==b){var c=this._am[a.name];null==c&&(c=0),c+=b,this._am[a.name]=c,this._f()}},increaseNewAlarm:function(a,b){if(null==b&&(b=1),0!==b){var c=this._nm[a.name];null==c&&(c=0),c+=b,this._nm[a.name]=c,this._f()}},decreaseAcknowledgedAlarm:function(a,b){if(null==b&&(b=1),0!==b){var c=this._am[a.name];if(null==c&&(c=0),c-=b,0>c)throw"Alarm count can not be negative";this._am[a.name]=c,this._f()}},decreaseNewAlarm:function(a,b){if(null==b&&(b=1),0!==b){var c=this._nm[a.name];if(null==c&&(c=0),c-=b,0>c)throw"Alarm count can not be negative";this._nm[a.name]=c,this._f()}},acknowledgeAlarm:function(a){this.decreaseNewAlarm(a,1),this.increaseAcknowledgedAlarm(a,1)},acknowledgeAllAlarms:function(a){if(a){var b=this.getNewAlarmCount(a);this.decreaseNewAlarm(a,b),this.increaseAcknowledgedAlarm(a,b)}else for(var c in this._nm)this.acknowledgeAllAlarms(Gb.AlarmSeverity.getByName(c))},_c6:function(){this._aac=0;for(var a in this._am)a=Gb.AlarmSeverity.getByName(a),this._aac+=this.getAcknowledgedAlarmCount(a)},getAcknowledgedAlarmCount:function(a){if(a){var b=this._am[a.name];return null==b?0:b}return this._aac},getAlarmCount:function(a){return this.getAcknowledgedAlarmCount(a)+this.getNewAlarmCount(a)},_c7:function(){this._nac=0;for(var a in this._nm)a=Gb.AlarmSeverity.getByName(a),this._nac+=this.getNewAlarmCount(a)},getNewAlarmCount:function(a){if(a){var b=this._nm[a.name];return null==b?0:b}return this._nac},setNewAlarmCount:function(a,b){this._nm[a.name]=b,this._f()},removeAllNewAlarms:function(a){a?delete this._nm[a]:this._nm={},this._f()},setAcknowledgedAlarmCount:function(a,b){this._am[a.name]=b,this._f()},removeAllAcknowledgedAlarms:function(a){a?delete this._am[a.name]:this._am={},this._f()},isEmpty:function(){return null==this._hoa},clear:function(){this._am={},this._nm={},this._f()},getPropagateSeverity:function(){return this._ps},setPropagateSeverity:function(a){if(this._ep||(a=null),this._ps!==a){var b=this._ps;this._ps=a,this._f(),this._e.firePropertyChange("propagateSeverity",b,a)}},isEnablePropagation:function(){return this._ep},setEnablePropagation:function(a){var b=this._ep;this._ep=a,this._e.firePropertyChange("enablePropagation",b,a)&&(a||this.setPropagateSeverity(null))}}),Gb.AlarmBox=function(a){if(!a)throw"elementBox can not be null.";Gb.AlarmBox.superClass.constructor.call(this),this._elementBox=a,this._alarmElementMapping=new Gb.AlarmElementMapping(this,a),this._elementBox.addDataBoxChangeListener(this.handleElementBoxChange,this,!0),this.addDataBoxChangeListener(this.handleAlarmBoxChange,this,!0),this.addDataPropertyChangeListener(this.handleAlarmPropertyChange,this,!0)},Hb.ext("twaver.AlarmBox",Gb.DataBox,{__accessor:["removeAlarmWhenElementIsRemoved"],_name:"AlarmBox",_removeAlarmWhenAlarmIsCleared:!1,_removeAlarmWhenElementIsRemoved:!0,getElementBox:function(){return this._elementBox},isRemoveAlarmWhenAlarmIsCleared:function(){return this._removeAlarmWhenAlarmIsCleared},setRemoveAlarmWhenAlarmIsCleared:function(a){var b=this._removeAlarmWhenAlarmIsCleared;this._removeAlarmWhenAlarmIsCleared=a,this.firePropertyChange("removeAlarmWhenAlarmIsCleared",b,a),a&&this.toDatas(function(a){return a.isCleared()}).forEach(this.remove,this)},getAlarmElementMapping:function(){return this._alarmElementMapping},setAlarmElementMapping:function(a){if(!a)throw"alarmElementMapping can not be null";if(this._alarmElementMapping!==a){var b=this._alarmElementMapping;this.getDatas().forEach(this._decreaseAlarmState,this),this._alarmElementMapping=a,this.getDatas().forEach(this._increaseAlarmState,this),this.firePropertyChange("alarmElementMapping",b,a)}},handleElementBoxChange:function(a){"add"===a.kind?this.handleElementAdded(a.data):"remove"===a.kind?(this.handleElementRemoved(a.data),this._removeAlarmWhenElementIsRemoved&&this.removeAlarmsByElement(a.data)):"clear"===a.kind&&(a.datas.forEach(this.handleElementRemoved,this),this._removeAlarmWhenElementIsRemoved&&this.clear())},handleAlarmBoxChange:function(a){"add"===a.kind?this._increaseAlarmState(a.data):"remove"===a.kind?this._decreaseAlarmState(a.data):"clear"===a.kind&&a.datas.forEach(this._decreaseAlarmState,this)},handleAlarmPropertyChange:function(a){var b=a.source;b.isCleared()||("alarmSeverity"===a.property?this.handleAlarmSeverityChange(b,a):"acked"===a.property&&this.handleAckedChange(b,a)),"cleared"===a.property&&(b.isCleared()?(this._decreaseAlarmState(b,!0),this._removeAlarmWhenAlarmIsCleared&&this.remove(b)):this._increaseAlarmState(b,!0))},handleAckedChange:function(a,b){if(a.getAlarmSeverity()){var c=this.getCorrespondingElements(a);if(c)for(var d=0;d<c.size();d++){var e=c.get(d);b.oldValue?e.getAlarmState().decreaseAcknowledgedAlarm(a.getAlarmSeverity()):e.getAlarmState().decreaseNewAlarm(a.getAlarmSeverity()),b.newValue?e.getAlarmState().increaseAcknowledgedAlarm(a.getAlarmSeverity()):e.getAlarmState().increaseNewAlarm(a.getAlarmSeverity())}}},handleAlarmSeverityChange:function(a,b){var c=b.oldValue,d=b.newValue,e=this.getCorrespondingElements(a);if(e)for(var f=0;f<e.size();f++){var g=e.get(f);c&&(a.isAcked()?g.getAlarmState().decreaseAcknowledgedAlarm(c):g.getAlarmState().decreaseNewAlarm(c)),d&&(a.isAcked()?g.getAlarmState().increaseAcknowledgedAlarm(d):g.getAlarmState().increaseNewAlarm(d))}},getCorrespondingAlarms:function(a){return this._alarmElementMapping.getCorrespondingAlarms(a)},getCorrespondingElements:function(a){return this._alarmElementMapping.getCorrespondingElements(a)},handleElementAdded:function(a){var b=this.getCorrespondingAlarms(a);if(b)for(var c=0;c<b.size();c++){var d=b.get(c);if(!d.isCleared()){var e=d.getAlarmSeverity();e&&(d.isAcked()?a.getAlarmState().increaseAcknowledgedAlarm(e):a.getAlarmState().increaseNewAlarm(e))}}},_increaseAlarmState:function(a,b){if(!a.isCleared()||b){var c=a.getAlarmSeverity();if(c){var d=this.getCorrespondingElements(a);if(d)for(var e=0;e<d.size();e++){var f=d.get(e);a.isAcked()?f.getAlarmState().increaseAcknowledgedAlarm(c):f.getAlarmState().increaseNewAlarm(c)}}}},_decreaseAlarmState:function(a,b){if(!a.isCleared()||b){var c=a.getAlarmSeverity();if(c){var d=this.getCorrespondingElements(a);if(d)for(var e=0;e<d.size();e++){var f=d.get(e);a.isAcked()?f.getAlarmState().decreaseAcknowledgedAlarm(c):f.getAlarmState().decreaseNewAlarm(c)}}}},handleElementRemoved:function(a){var b=this.getCorrespondingAlarms(a);b&&b.forEach(function(b){!b.isCleared()&&b.getAlarmSeverity()&&(b.isAcked()?a.getAlarmState().decreaseAcknowledgedAlarm(b.getAlarmSeverity()):a.getAlarmState().decreaseNewAlarm(b.getAlarmSeverity()))})},removeAlarmsByElement:function(a){var b=this.getCorrespondingAlarms(a);b&&b.forEach(this.remove,this)},add:function(a,b){if(!a.IAlarm)throw"Only IAlarm can be added into AlarmBox";this._removeAlarmWhenAlarmIsCleared&&a.isCleared()||Gb.AlarmBox.superClass.add.apply(this,arguments)}}),Gb.AlarmElementMapping=function(a,b){if(!b)throw"ElementBox can not be null";if(!a)throw"AlarmBox can not be null";this._elementBox=b,this._alarmBox=a,this._alarmsFinder=new Gb.QuickFinder(a,"elementId")},Hb.ext("twaver.AlarmElementMapping",Object,{getCorrespondingAlarms:function(a){return this._alarmsFinder.find(a.getId())},getCorrespondingElements:function(a){var b=this._elementBox.getDataById(a.getElementId());return new md(b)},dispose:function(){this._alarmsFinder.dispose(),delete this._elementBox,delete this._alarmBox,delete this._alarmsFinder}}),Gb.AlarmStateStatistics=function(a){Gb.AlarmStateStatistics.superClass.constructor.apply(this,arguments),this.sumNew=0,this.sumAcked=0,this.sumTotal=0,this.severtiyMap={},this.elementMap={},this.setElementBox(a)},Hb.ext("twaver.AlarmStateStatistics",Gb.PropertyChangeDispatcher,{getElementBox:function(){return this._elementBox},setElementBox:function(a){if(!a)throw"ElementBox can not be null";if(this._elementBox!==a){var b=this._elementBox;b&&(b.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),b.removeDataBoxChangeListener(this.handleElementBoxChange,this),this.severtiyMap={},this.elementMap={}),this._elementBox=a,this.reset(),a.addDataPropertyChangeListener(this.handleElementPropertyChange,this),a.addDataBoxChangeListener(this.handleElementBoxChange,this),this.firePropertyChange("elementBox",b,a)}},dispose:function(){this._elementBox.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),this._elementBox.removeDataBoxChangeListener(this.handleElementBoxChange,this),delete this._elementBox},handleElementPropertyChange:function(a){"alarmState"===a.property&&(this.increase(a.source),this.fireAlarmStateChange())},handleElementBoxChange:function(a){"add"===a.kind?(this.increase(a.data),this.fireAlarmStateChange()):"remove"===a.kind?(this.decrease(a.data),this.fireAlarmStateChange()):"clear"===a.kind&&(this.severtiyMap={},this.elementMap={},this.fireAlarmStateChange())},fireAlarmStateChange:function(){this.sumAcked=0,this.sumNew=0,this.sumTotal=0,Gb.AlarmSeverity.forEach(function(a){var b=this.getSumInfo(a);this.sumAcked+=b.ackedCount,this.sumNew+=b.newCount,this.sumTotal+=b.totalCount},this),this.firePropertyChange("alarmState",!1,!0)},getNewAlarmCount:function(a){if(!a)return this.sumNew;var b=this.getSumInfo(a);return b.newCount},getAcknowledgedAlarmCount:function(a){if(!a)return this.sumAcked;var b=this.getSumInfo(a);return b.ackedCount},getTotalAlarmCount:function(a){if(!a)return this.sumTotal;var b=this.getSumInfo(a);return b.totalCount},getSumInfo:function(a){var b=this.severtiyMap[a.name];return b||(b={},b.newCount=0,b.ackedCount=0,b.totalCount=0,this.severtiyMap[a.name]=b),b},decrease:function(a){var b=this.elementMap[a.getId()];b&&(delete this.elementMap[a.getId()],Gb.AlarmSeverity.forEach(function(a){var c=b[a.name],d=this.getSumInfo(a);d.newCount=d.newCount-c.newCount,d.ackedCount=d.ackedCount-c.ackedCount,d.totalCount=d.totalCount-c.totalCount},this))},increase:function(a){if(this.decrease(a),!this._filterFunction||this._filterFunction(a)){var b={};this.elementMap[a.getId()]=b,Gb.AlarmSeverity.forEach(function(c){var d={};d.newCount=a.getAlarmState().getNewAlarmCount(c),d.ackedCount=a.getAlarmState().getAcknowledgedAlarmCount(c),d.totalCount=a.getAlarmState().getAlarmCount(c),b[c.name]=d;var e=this.getSumInfo(c);e.newCount=e.newCount+d.newCount,e.ackedCount=e.ackedCount+d.ackedCount,e.totalCount=e.totalCount+d.totalCount},this)}},reset:function(){this.severtiyMap={},this.elementMap={},this._elementBox.forEach(this.increase,this),this.fireAlarmStateChange()},setFilterFunction:function(a){var b=this._filterFunction;this._filterFunction=a,this.reset(),this.firePropertyChange("filterFunction",b,a)},getFilterFunction:function(){return _filterFunction}}),Gb.LayerBox=function(a){Gb.LayerBox.superClass.constructor.call(this),this._elementBox=a,this._defaultLayer=new Gb.Layer(Dd.LAYER_DEFAULT_ID,Dd.LAYER_DEFAULT_NAME),this.add(this._defaultLayer)},Hb.ext("twaver.LayerBox",Gb.DataBox,{_name:"LayerBox",getElementBox:function(){return this._elementBox},getDefaultLayer:function(){return this._defaultLayer},add:function(a,b){if(!a.ILayer)throw"Only ILayer can be added into LayerBox";Gb.LayerBox.superClass.add.apply(this,arguments)},removeById:function(a){if(a===this._defaultLayer.getId())throw"Cannot remove default layer";Gb.LayerBox.superClass.removeById.call(this,a)},getLayerByElement:function(a){if(!a)return null;if(a._layerId===Dd.LAYER_DEFAULT_ID)return this._defaultLayer;var b=this.getDataById(a.getLayerId());return b?b:this._defaultLayer},clear:function(){this.toDatas().forEach(function(a){a!=this._defaultLayer&&this.removeById(a.getId())},this)}}),Gb.BundleLinks=function(a,b){this._links=a,this._siblings=b;var c,d,e=Ed._m["link.bundle.expanded"];for(c=0;c<a.size();c++){d=a.get(c);var f=d.getStyle("link.bundle.expanded");if(null!=f){e=f;break}}if(null==e&&(e=!0),Dd.LINK_BUNDLE_AGENT_FUNCTION){var g=Dd.LINK_BUNDLE_AGENT_FUNCTION(a);null==g?g=a.get(0):g!=a.get(0)&&(a.remove(g),a.add(g,0))}for(c=0;c<a.size();c++)a.get(c).setStyle("link.bundle.expanded",e)},Hb.ext("twaver.BundleLinks",Object,{getLinks:function(){return this._links},getSiblings:function(){return this._siblings},forEachSiblingLink:function(a,b){this._siblings.forEach(function(c){c.getLinks().forEach(a,b)})}});var Fd={bitsToNum:function(a){return a.reduce(function(a,b){return 2*a+b},0)},byteToBitArr:function(a){for(var b=[],c=7;c>=0;c--)b.push(!!(a&1<<c));return b},lzwDecode:function(a,b){for(var c,d,e=0,f=function(a){for(var c=0,d=0;a>d;d++)b.charCodeAt(e>>3)&1<<(7&e)&&(c|=1<<d),e++;return c},g=[],h=1<<a,i=h+1,j=a+1,k=[],l=function(){k=[],j=a+1;for(var b=0;h>b;b++)k[b]=[b];k[h]=[],k[i]=null};;)if(d=c,c=f(j),c!==h){if(c===i)break;if(c<k.length)d!==h&&k.push(k[d].concat(k[c][0]));else{if(c!==k.length)throw new Error("Invalid LZW code.");k.push(k[d].concat(k[d][0]))}g.push.apply(g,k[c]),k.length===1<<j&&12>j&&j++}else l();return g}},Gd=function(a){this.data=a,this.len=this.data.length,this.pos=0};Hb.ext(Gd,Object,{readByte:function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return 255&this.data.charCodeAt(this.pos++)},readBytes:function(a){for(var b=[],c=0;a>c;c++)b.push(this.readByte());return b},read:function(a){for(var b="",c=0;a>c;c++)b+=String.fromCharCode(this.readByte());return b},readUnsigned:function(){var a=this.readBytes(2);return(a[1]<<8)+a[0]}});var Hd=function(a){var b,c=a,d=null,e=null,f=null,g=0,h=null,i=null,j=null;this.frames=[],this.size={};var k=this,l=Mb.createElement("canvas");this.loaded=!1;var m=function(){d=null,e=null,h=f,f=null,i=null};this.doParse=function(){Id(c,t)};var n=function(a){b=a,k.size.width=b.width,k.size.height=b.height},o=function(a){p(),m(),d=a.transparencyGiven?a.transparencyIndex:null,e=a.delayTime,f=a.disposalMethod},p=function(){i&&k.frames.push({data:i.getImageData(0,0,b.width,b.height),delay:e})},q=function(a){i||(i=l.getContext("2d"));var c=k.frames.length,e=a.lctFlag?a.lct:b.gct;c>0&&(3===h?i.putImageData(k.frames[g].data,0,0):g=c-1,2===h&&(j||i.clearRect(j.leftPos,j.topPos,j.width,j.height)));var f=i.getImageData(a.leftPos,a.topPos,a.width,a.height);a.pixels.forEach(function(a,b){a!==d&&(f.data[4*b+0]=e[a][0],f.data[4*b+1]=e[a][1],f.data[4*b+2]=e[a][2],f.data[4*b+3]=255)}),i.putImageData(f,a.leftPos,a.topPos),j=a},r=function(){},s=function(a){return function(b){a(b)}},t={hdr:s(n),gce:s(o),com:s(r),app:{NETSCAPE:s(r)},img:s(q),eof:function(a){p(),k.loaded=!0}}},Id=function(a,b){b||(b={});var c=function(b){for(var c=[],d=0;b>d;d++)c.push(a.readBytes(3));return c},d=function(){var b,c;c="";do b=a.readByte(),c+=a.read(b);while(0!==b);return c},e=function(){var d={};if(d.sig=a.read(3),d.ver=a.read(3),"GIF"!==d.sig)throw new Error("Not a GIF file.");d.width=a.readUnsigned(),d.height=a.readUnsigned();var e=Fd.byteToBitArr(a.readByte());d.gctFlag=e.shift(),d.colorRes=Fd.bitsToNum(e.splice(0,3)),d.sorted=e.shift(),d.gctSize=Fd.bitsToNum(e.splice(0,3)),d.bgColor=a.readByte(),d.pixelAspectRatio=a.readByte(),d.gctFlag&&(d.gct=c(1<<d.gctSize+1)),b.hdr&&b.hdr(d)},f=function(c){var e=function(c){var d=(a.readByte(),Fd.byteToBitArr(a.readByte()));c.reserved=d.splice(0,3),c.disposalMethod=Fd.bitsToNum(d.splice(0,3)),c.userInput=d.shift(),c.transparencyGiven=d.shift(),c.delayTime=a.readUnsigned(),c.transparencyIndex=a.readByte(),c.terminator=a.readByte(),b.gce&&b.gce(c)},f=function(a){a.comment=d(),b.com&&b.com(a)},g=function(c){a.readByte();c.ptHeader=a.readBytes(12),c.ptData=d(),b.pte&&b.pte(c)},h=function(c){{var e=function(c){a.readByte();c.unknown=a.readByte(),c.iterations=a.readUnsigned(),c.terminator=a.readByte(),b.app&&b.app.NETSCAPE&&b.app.NETSCAPE(c)},f=function(a){a.appData=d(),b.app&&b.app[a.identifier]&&b.app[a.identifier](a)};a.readByte()}switch(c.identifier=a.read(8),c.authCode=a.read(3),c.identifier){case"NETSCAPE":e(c);break;default:f(c)}},i=function(a){a.data=d(),b.unknown&&b.unknown(a)};switch(c.label=a.readByte(),c.label){case 249:c.extType="gce",e(c);break;case 254:c.extType="com",f(c);break;case 1:c.extType="pte",g(c);break;case 255:c.extType="app",h(c);break;default:c.extType="unknown",i(c)}},g=function(e){var f=function(a,b){for(var c=new Array(a.length),d=a.length/b,e=function(d,e){var f=a.slice(e*b,(e+1)*b);c.splice.apply(c,[d*b,b].concat(f))},f=[0,4,2,1],g=[8,8,4,2],h=0,i=0;4>i;i++)for(var j=f[i];d>j;j+=g[i])e(j,h),h++;return c};e.leftPos=a.readUnsigned(),e.topPos=a.readUnsigned(),e.width=a.readUnsigned(),e.height=a.readUnsigned();var g=Fd.byteToBitArr(a.readByte());e.lctFlag=g.shift(),e.interlaced=g.shift(),e.sorted=g.shift(),e.reserved=g.splice(0,2),e.lctSize=Fd.bitsToNum(g.splice(0,3)),e.lctFlag&&(e.lct=c(1<<e.lctSize+1)),e.lzwMinCodeSize=a.readByte();var h=d();e.pixels=Fd.lzwDecode(e.lzwMinCodeSize,h),e.interlaced&&(e.pixels=f(e.pixels,e.width)),b.img&&b.img(e)},h=function(){var c={};switch(c.sentinel=a.readByte(),String.fromCharCode(c.sentinel)){case"!":c.type="ext",f(c);break;case",":c.type="img",g(c);break;case";":c.type="eof",b.eof&&b.eof(c);break;default:throw new Error("Unknown block: 0x"+c.sentinel.toString(16))}"eof"!==c.type&&setTimeout(h,0)},i=function(){e(),setTimeout(h,0)};i()},Jd=function(a,b,c){var d=Mb.createElement("canvas");return Kd(d,b.width,b.height),d.getContext("2d").clearRect(0,0,b.width,b.height),d.getContext("2d").putImageData(a[c].data,0,0),d},Kd=function(a,b,c){a.width=b,a.height=c,a.style.width=b+"px",a.style.height=c+"px"};Gb.Data=function(a){if(Gb.Data.superClass.constructor.apply(this,arguments),this._childList=new md,this._childMap={},this._clientMap={},void 0===a||null===a)this._id=Hb.id();else if("string"==typeof a||"number"==typeof a||"boolean"==typeof a)this._id=a;else{for(var b in a)if("clients"===b)for(var c in a.clients)this._clientMap[c]=a.clients[c];else if("styles"===b)for(var d in a.styles)this._styleMap[d]=a.styles[d];else null!=a[b]&&("id"===b?this._id=a[b]:this[Hb.setter(b)]&&this[Hb.setter(b)](a[b]));null==this._id&&(this._id=Hb.id())}},Hb.ext("twaver.Data",Gb.PropertyChangeDispatcher,{IData:!0,IClient:!0,__client:1,__new:1,_parent:null,__accessor:["name","name2","icon","toolTip"],_icon:Dd.ICON_DATA,_dragBoundsFunc:null,getId:function(){return this._id},getChildren:function(){return this._childList},getChildrenSize:function(){return this._childList.size()},toChildren:function(a,b){return this._childList.toList(a,b)},addChild:function(a,b){return void 0===b&&(b=this._childList.size()),a&&a!==this?this._childMap[a.getId()]?!1:this.isDescendantOf(a)?!1:(a.getParent()&&a.getParent().removeChild(a),(0>b||b>this._childList.size())&&(b=this._childList.size()),this._childList.add(a,b),this._childMap[a._id]=a,a.setParent(this),this.firePropertyChange("children",null,a),this.onChildAdded(a,b),!0):!1},onChildAdded:function(a,b){},removeChild:function(a){if(!a)return!1;if(!this._childMap[a._id])return!1;var b=this._childList.remove(a);return delete this._childMap[a._id],this.firePropertyChange("children",a,null),a.setParent(null),this.onChildRemoved(a,b),!0},onChildRemoved:function(a,b){},getChildAt:function(a){return this._childList.get(a)},clearChildren:function(){if(0===this._childList.size())return!1;for(var a=this._childList.toArray(),b=a.length,c=0;b>c;c++)this.removeChild(a[c]);return this.onChildrenCleared(a),!0},onChildrenCleared:function(a){},getParent:function(){return this._parent},setParent:function(a){if(!(this._isUpdatingParent||this._parent===a||this===a||a&&a.isDescendantOf(this))){var b=this._parent;this._parent=a,this._isUpdatingParent=!0,b&&b.removeChild(this),a&&a.addChild(this),delete this._isUpdatingParent,this.firePropertyChange("parent",b,a),this.onParentChanged(b,a)}},onParentChanged:function(a,b){},hasChildren:function(){return this._childList.size()>0},isRelatedTo:function(a){return a?this.isDescendantOf(a)||a.isDescendantOf(this):!1},isParentOf:function(a){return a?null!=this._childMap[a._id]:!1},isDescendantOf:function(a){if(!a)return!1;if(!a.hasChildren())return!1;for(var b=this._parent;b;){if(a===b)return!0;b=b.getParent()}return!1},getDragBoundsFunc:function(){return this._dragBoundsFunc},setDragBoundsFunc:function(a){this._dragBoundsFunc=a},toString:function(){return this.getName()?this.getName():this._id}}),Gb.Alarm=function(a,b,c,d,e){Gb.Alarm.superClass.constructor.call(this,a),this._elementId=b,this._alarmSeverity=c,this._acked=d||!1,this._cleared=e||!1},Hb.ext("twaver.Alarm",Gb.Data,{IAlarm:!0,getElementId:function(){return this._elementId},__accessor:["acked","cleared","alarmSeverity"]}),Gb.Layer=function(a){Gb.Layer.superClass.constructor.call(this,a)},Hb.ext("twaver.Layer",Gb.Data,{ILayer:!0,__accessor:["visible","movable","editable","rotatable"],_visible:!0,_movable:!0,_editable:!0,_rotatable:!0,_name:"Default"}),Gb.Element=function(a){this._styleMap=this._styleMap||{},this._alarmState=new Gb.AlarmState(this),Gb.Element.superClass.constructor.call(this,a)},Hb.ext("twaver.Element",Gb.Data,{IElement:!0,IStyle:!0,__accessor:["layerId"],__bool:["visible","movable"],__style:1,_layerId:Dd.LAYER_DEFAULT_ID,_visible:!0,_movable:!0,getAlarmState:function(){return this._alarmState},isAdjustedToBottom:function(){return!1},getElementUIClass:function(){return null},getCanvasUIClass:function(){return null},getVectorUIClass:function(){return null},s:function(a,b){return void 0===b?this.getStyle(a):(this.setStyle(a,b),this)},c:function(a,b){return void 0===b?this.getClient(a):(this.setClient(a,b),this)}}),Gb.Dummy=function(a){Gb.Dummy.superClass.constructor.call(this,a)},Hb.ext("twaver.Dummy",Gb.Element,{IDummy:!0});var Ld=function(a){this._location={x:0,y:0},Ld.superClass.constructor.call(this,a)};Gb.Node=Ld,Ld.IS_INTERESTED_NODE_PROPERTY={location:1,width:1,height:1,expanded:1},Hb.ext("twaver.Node",Gb.Element,{_icon:Dd.ICON_NODE,_image:Dd.IMAGE_NODE,_imageUrl:null,_angle:0,getLoopedLinks:function(){return this._loopedLinks},getLinks:function(){return this._links},getAgentLinks:function(){return this._agentLinks},getFollowers:function(){return this._followers},_addFollower:function(a){this._followers||(this._followers=new md),this._followers.add(a)},_removeFollower:function(a){this._followers.remove(a),this._followers.isEmpty()&&delete this._followers},getFromLinks:function(){return this._fromLinks},getToLinks:function(){return this._toLinks},_addFromLink:function(a){this._links||(this._links=new md(!1)),this._fromLinks||(this._fromLinks=new md(!1)),this._links.add(a),this._toLinks&&this._toLinks.contains(a)&&(this._loopedLinks||(this._loopedLinks=new md(!1)),this._loopedLinks.add(a)),this._fromLinks.add(a)},_addToLink:function(a){this._links||(this._links=new md(!1)),this._toLinks||(this._toLinks=new md(!1)),this._links.add(a),this._fromLinks&&this._fromLinks.contains(a)&&(this._loopedLinks||(this._loopedLinks=new md(!1)),this._loopedLinks.add(a)),this._toLinks.add(a)},_removeFromLink:function(a){this._links&&this._links.remove(a),this._fromLinks&&this._fromLinks.remove(a),this._loopedLinks&&this._loopedLinks.remove(a)},_removeToLink:function(a){this._links&&this._links.remove(a),this._toLinks&&this._toLinks.remove(a),this._loopedLinks&&this._loopedLinks.remove(a)},hasAgentLinks:function(){return null!=this._agentLinks&&!this._agentLinks.isEmpty()},getFromAgentLinks:function(){return this._fromAgentLinks},getToAgentLinks:function(){return this._toAgentLinks},_addFromAgentLink:function(a){this._fromAgentLinks||(this._fromAgentLinks=new md(!1)),this._agentLinks||(this._agentLinks=new md(!1)),this._fromAgentLinks.add(a),this._agentLinks.add(a)},_addToAgentLink:function(a){this._toAgentLinks||(this._toAgentLinks=new md(!1)),this._agentLinks||(this._agentLinks=new md(!1)),this._toAgentLinks.add(a),this._agentLinks.add(a)},_removeFromAgentLink:function(a){this._fromAgentLinks&&this._fromAgentLinks.remove(a),this._agentLinks&&this._agentLinks.remove(a)},_removeToAgentLink:function(a){this._toAgentLinks&&this._toAgentLinks.remove(a),this._agentLinks&&this._agentLinks.remove(a)},getImage:function(){return this._image},setImage:function(a){var b=this._image,c=this.getWidth(),d=this.getHeight();this._image=a,this.firePropertyChange("image",b,a),this.firePropertyChange("width",c,this.getWidth()),this.firePropertyChange("height",d,this.getHeight())},getImageUrl:function(){return this._imageUrl},setImageUrl:function(a){if(this._imageUrl!=a){var b=this._imageUrl;this._imageUrl=a,Cd.images[a]||Gb.imageUtil.registerImageByUrl(a,"svg"===Gb.imageUtil.getImageType(a),a),this.setImage(a),this.firePropertyChange("imageUrl",b,a)}},getX:function(){return this._location.x},getY:function(){return this._location.y},setX:function(a){this.setLocation(a,this._location.y)},setY:function(a){this.setLocation(this._location.x,a)},getLocation:function(){return this._location},setLocation:function(a,b){var c;if(c=2===arguments.length?{x:arguments[0],y:arguments[1]}:arguments[0],Hb.num(c.x)&&Hb.num(c.y)&&(c.x!==this._location.x||c.y!==this._location.y)){this._dragBoundsFunc&&(c=this._dragBoundsFunc(c));var d=this._location;this._location=c,this.firePropertyChange("location",d,c)}},getCenterLocation:function(){return Dd.CENTER_LOCATION?this._location:{x:this.getX()+this.getWidth()/2,y:this.getY()+this.getHeight()/2}},setCenterLocation:function(a,b){var c;c=2===arguments.length?{x:arguments[0],y:arguments[1]}:Hb.clone(arguments[0]),Hb.num(c.x)&&Hb.num(c.y)&&(Dd.CENTER_LOCATION||(c.x-=this.getWidth()/2,c.y-=this.getHeight()/2),this.setLocation(c))},translate:function(a,b){this.setLocation(this.getX()+a,this.getY()+b)},getWidth:function(){if(Hb.num(this._width)&&this._width>=0)return this._width;if("object"!=typeof this._image){var a=Hb.getImageAsset(this._image);if(a){var b=a.getWidth();return Hb.num(b)&&b>=0?b:(a=a._image,Xc(this,a,a,"w"))}}else if(this._image)return this._image.w;return Dd.NODE_WIDTH},setWidth:function(a){var b=this._width;this._width=a,this.firePropertyChange("width",b,a)},getHeight:function(){if(Hb.num(this._height)&&this._height>=0)return this._height;if("object"!=typeof this._image){var a=Hb.getImageAsset(this._image);if(a){var b=a.getHeight();return Hb.num(b)&&b>=0?b:(a=a._image,Xc(this,a,a,"h"))}}else if(this._image)return this._image.h;return Dd.NODE_HEIGHT},setHeight:function(a){var b=this._height;this._height=a,this.firePropertyChange("height",b,a)},setSize:function(){2===arguments.length?(this.setWidth(arguments[0]),this.setHeight(arguments[1])):(this.setWidth(arguments[0].width),this.setHeight(arguments[0].height))},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getRect:function(){var a=this.getOriginalRect();if(0===this._angle)return a;for(var b=Rb.createMatrix(this._angle*Math.PI/180,a.x+a.width/2,a.y+a.height/2),c=[{x:a.x,y:a.y},{x:a.x+a.width,y:a.y},{x:a.x+a.width,y:a.y+a.height},{x:a.x,y:a.y+a.height}],d=0,e=c.length;e>d;d++)c[d]=b.transform(c[d]);var f=Rb.getRect(c);return f},getOriginalRect:function(){var a=this,b=a.getWidth(),c=a.getHeight();return Dd.CENTER_LOCATION?{x:a._location.x-b/2,y:a._location.y-c/2,width:b,height:c}:{x:a.getX(),y:a.getY(),width:b,height:c}},getAngle:function(){return this._angle},setAngle:function(a){var b=this._angle;this._angle=a%360,this.firePropertyChange("angle",b,this._angle)},onParentChanged:function(a,b){Ld.superClass.onParentChanged.call(this,a,b),this._checkLinkAgent()},_checkLinkAgent:function(){if(Gb._isInitializing){if(this._links)for(var a=this._links.size(),b=0;a>b;b++)this._links.get(b)._checkAgentNode()}else Gb.ElementBox.prototype.startBatch(function(){if(this._links)for(var a=this._links.size(),b=0;a>b;b++)this._links.get(b)._checkAgentNode()},this)},onPropertyChanged:function(a){if(Ld.superClass.onPropertyChanged.call(this,a),this._followers)for(var b=this._followers.toList(),c=b.size(),d=0;c>d;d++)b.get(d).handleHostPropertyChange(a);this.getParent()instanceof Nd&&Ld.IS_INTERESTED_NODE_PROPERTY[a.property]&&this.getParent().updateLocationFromChildren()},getElementUIClass:function(){return Gb.network.NodeUI},getCanvasUIClass:function(){return Gb.canvas.NodeUI},getVectorUIClass:function(){return Gb.vector.NodeUI}});var Md=function(a){Md.superClass.constructor.call(this,a)};Gb.HTMLNode=Md,Hb.ext("twaver.HTMLNode",Gb.Node,{getElementUIClass:function(){return Gb.network.HTMLNodeUI},getCanvasUIClass:function(){return Gb.canvas.HTMLNodeUI},getVectorUIClass:function(){return Gb.vector.HTMLNodeUI}}),Gb.Link=function(a,b,c){Gb.Link.superClass.constructor.call(this,a instanceof Ld?null:a),a instanceof Ld&&(c=b,b=a),b&&this.setFromNode(b),c&&this.setToNode(c)},Gb.Link.IS_INTERESTED_BUNDLE_STYLE={"link.bundle.enable":1,"link.bundle.id":1,"link.bundle.independent":1},Hb.ext("twaver.Link",Gb.Element,{_fromNode:null,_toNode:null,_fromAgent:null,_toAgent:null,_icon:Dd.ICON_LINK,getFromNode:function(){return this._fromNode},getToNode:function(){return this._toNode},getFromAgent:function(){return this._fromAgent},getToAgent:function(){return this._toAgent},setFromNode:function(a){if(this._fromNode!==a){var b=this._fromNode;this._fromNode=a,b&&b._removeFromLink(this),this._fromNode&&this._fromNode._addFromLink(this),this._checkAgentNode(),this.firePropertyChange("fromNode",b,a)}},setToNode:function(a){if(this._toNode!==a){var b=this._toNode;this._toNode=a,b&&b._removeToLink(this),this._toNode&&this._toNode._addToLink(this),this._checkAgentNode(),this.firePropertyChange("toNode",b,a)}},isLooped:function(){return this._fromNode===this._toNode&&null!=this._fromNode&&null!=this._toNode},_checkAgentNode:function(){Gb._isInitializing?Gb._links[this._id]||(Gb._links[this._id]=this):this._checkAgentNodeImpl()},_checkAgentNodeImpl:function(){var a,b,c=uc.figureFromAgent(this),d=this;this._fromAgent!=c&&(a=this._fromAgent,this._fromAgent&&this._fromAgent._removeFromAgentLink(this),this._fromAgent=c,this._fromAgent&&this._fromAgent._addFromAgentLink(this),this.firePropertyChange("fromAgent",a,this._fromAgent),Gb._isInitializing?(a&&this._toAgent&&(b=a._id+":"+this._toAgent._id,Gb._bundleLinks[b]||(Gb._bundleLinks[b]=[a,this._toAgent])),this._fromAgent&&this._toAgent&&(b=this._fromAgent._id+":"+this._toAgent._id,Gb._bundleLinks[b]||(Gb._bundleLinks[b]=[this._fromAgent,this._toAgent]))):(uc.resetBundleLinks(a,d._toAgent),uc.resetBundleLinks(d._fromAgent,d._toAgent)));var e=uc.figureToAgent(this);this._toAgent!=e&&(a=this._toAgent,this._toAgent&&this._toAgent._removeToAgentLink(this),this._toAgent=e,this._toAgent&&this._toAgent._addToAgentLink(this),this.firePropertyChange("toAgent",a,this._toAgent),Gb._isInitializing?(a&&this._fromAgent&&(b=a._id+":"+this._fromAgent._id,Gb._bundleLinks[b]||(Gb._bundleLinks[b]=[a,this._fromAgent])),this._toAgent&&this._fromAgent&&(b=this._toAgent._id+":"+this._fromAgent._id,Gb._bundleLinks[b]||(Gb._bundleLinks[b]=[this._toAgent,this._fromAgent]))):(uc.resetBundleLinks(a,d._fromAgent),uc.resetBundleLinks(d._toAgent,d._fromAgent)))},_setBundleLinks:function(a){this._bundleLinks=a,this.firePropertyChange("bundleLinks",!0,!1)},getBundleLinks:function(){return this._bundleLinks},getBundleCount:function(){return this._bundleLinks?this._bundleLinks.getLinks().size():1;

},getBundleIndex:function(){return this._bundleLinks?this._bundleLinks.getLinks().indexOf(this):0},reverseBundleExpanded:function(){if(this._bundleLinks&&this._bundleLinks.getLinks().size()>0){var a,b,c=this._bundleLinks.getLinks(),d=!this.getStyle("link.bundle.expanded");for(a=0;a<c.size();a++)b=c.get(a),b.setStyle("link.bundle.expanded",d);var e=this._bundleLinks.getSiblings();for(a=0;a<e.size();a++){var f=e.get(a);if(f!=this._bundleLinks){c=f.getLinks();for(var g=0;g<c.size();g++)b=c.get(g),b.firePropertyChange("bundleLinks",null,f)}}return!0}return!1},isBundleAgent:function(){return null!=this._bundleLinks&&this._bundleLinks.getLinks().size()>1&&this===this._bundleLinks.getLinks().get(0)&&!this.getStyle("link.bundle.expanded")},onStyleChanged:function(a,b,c){Gb.Link.superClass.onStyleChanged.call(this,a,b,c),Gb.Link.IS_INTERESTED_BUNDLE_STYLE[a]&&uc.resetBundleLinks(this._toAgent,this._fromAgent)},getElementUIClass:function(){return Gb.network.LinkUI},getCanvasUIClass:function(){return Gb.canvas.LinkUI},getVectorUIClass:function(){return Gb.vector.LinkUI},isAdjustedToBottom:function(){return Dd.IS_LINK_ADJUSTED_TO_BOTTOM}}),Gb.HTMLLink=function(a,b,c){Gb.HTMLLink.superClass.constructor.call(this,a,b,c)},Gb.Util.ext("twaver.HTMLLink",Gb.Link,{getElementUIClass:function(){return Gb.network.HTMLLinkUI},getCanvasUIClass:function(){return Gb.canvas.HTMLLinkUI},getVectorUIClass:function(){return Gb.vector.HTMLLinkUI}}),Gb.Follower=function(a){this._isUpdatingFollower=!1,this._isUpdatingLocation=!1,Gb.Follower.superClass.constructor.call(this,a)},Gb.Follower.IS_INTERESTED_HOST_GRID_PROPERTY={location:1,width:1,height:1,"S:grid.row.count":1,"S:grid.column.count":1,"S:grid.row.percents":1,"S:grid.column.percents":1,"S:grid.border":1,"S:grid.border.left":1,"S:grid.border.right":1,"S:grid.border.top":1,"S:grid.border.bottom":1,"S:grid.padding":1,"S:grid.padding.left":1,"S:grid.padding.right":1,"S:grid.padding.top":1,"S:grid.padding.bottom":1},Gb.Follower.IS_INTERESTED_FOLLOWER_STYLE={"follower.row.index":1,"follower.column.index":1,"follower.row.span":1,"follower.column.span":1,"follower.padding":1,"follower.padding.left":1,"follower.padding.right":1,"follower.padding.top":1,"follower.padding.bottom":1},Hb.ext("twaver.Follower",Ld,{_host:null,getHost:function(){return this._host},setHost:function(a){if(this!==a&&this._host!==a){var b=this._host;b&&b._removeFollower(this),this._host=a,this._host&&this._host._addFollower(this),this.firePropertyChange("host",b,a),this.onHostChanged(b,a)}},onStyleChanged:function(a,b,c){Gb.Follower.superClass.onStyleChanged.call(this,a,b,c),Gb.Follower.IS_INTERESTED_FOLLOWER_STYLE[a]&&this.updateFollower(null)},setLocation:function(){this._isUpdatingLocation||(this._isUpdatingLocation=!0,Gb.Follower.superClass.setLocation.apply(this,arguments),this._isUpdatingLocation=!1)},onHostChanged:function(a,b){this.updateFollower(null)},handleHostPropertyChange:function(a){this.updateFollower(a)},updateFollower:function(a){this._isUpdatingFollower||Hb.isDeserializing||(this._isUpdatingFollower=!0,this.updateFollowerImpl(a),this._isUpdatingFollower=!1)},updateFollowerImpl:function(a){var b=this.getHost();if(b instanceof Gb.Grid){if(!a||Gb.Follower.IS_INTERESTED_HOST_GRID_PROPERTY[a.property]){var c=this.getStyle("follower.row.index"),d=this.getStyle("follower.column.index"),e=b.getCellRect(c,d);if(!e)return;var f=this.getStyle("follower.row.span"),g=this.getStyle("follower.column.span");if(1!=f||1!=g){var h=b.getCellRect(c+f-1,d+g-1);h&&(e=Rb.unionRect(e,h))}if(Rb.addPadding(e,this,"follower.padding"),this.getStyle("follower.fill.cell"))this.setLocation(e.x,e.y),this.setWidth(e.width),this.setHeight(e.height);else{var i=this.getStyle("follower.cell.position");e=Tb.get(i,e,this.getRect()),this.setLocation(e.x,e.y)}}}else if(null!=a&&"location"===a.property){var j=a.oldValue,k=a.newValue,l=this.getLocation();this.setLocation(l.x+(k.x-j.x),l.y+(k.y-j.y))}},isHostOn:function(a){if(!a)return!1;for(var b={},c=this._host;c&&c!=this&&!b[c.getId()];){if(c===a)return!0;b[c.getId()]=c,c=c instanceof Gb.Follower?c.getHost():null}return!1},isLoopedHostOn:function(a){return this.isHostOn(a)&&a.isHostOn(this)}});var Nd=function(a){this._isUpdatingLocationFromChildren=!1,this._isAdjusting=!1,this._expanded=!1,Nd.superClass.constructor.call(this,a)};Gb.Group=Nd,Hb.ext("twaver.Group",Gb.Follower,{_image:Dd.IMAGE_GROUP,_icon:Dd.ICON_GROUP,isAdjustedToBottom:function(){return this.isExpanded()&&uc.hasAgentLinks(this)},onChildAdded:function(a,b){Nd.superClass.onChildAdded.apply(this,arguments),this.updateLocationFromChildren()},onChildRemoved:function(a,b){Nd.superClass.onChildRemoved.apply(this,arguments),this.updateLocationFromChildren()},updateLocationFromChildren:function(){if(!this._isAdjusting&&!Hb.isDeserializing){for(var a,b,c=0,d=this.getChildrenSize();d>c;c++)b=this.getChildAt(c),b instanceof Ld&&(a=Rb.unionRect(a,this.getChildRect(b)));a&&(this._isUpdatingLocationFromChildren=!0,"lefttop"===Dd.GROUP_EXPAND_ALIGN?this.setLocation(a.x-this.getWidth()/2,a.y-this.getHeight()/2):this.setLocation(a.x+a.width/2-this.getWidth()/2,a.y+a.height/2-this.getHeight()/2),this._isUpdatingLocationFromChildren=!1)}},getChildRect:function(a){var b;return a instanceof Ld&&(a instanceof Nd?(a.isExpanded()&&a.getChildren().forEach(function(c){b=Rb.unionRect(b,a.getChildRect(c))}),b||(b=a.getRect())):b=a.getRect()),b},setLocation:function(){if(!this._isAdjusting){var a;if(a=2===arguments.length?{x:arguments[0],y:arguments[1]}:arguments[0],!Hb.isDeserializing&&!this._isUpdatingLocationFromChildren){this._isAdjusting=!0;var b=a.x-this.getX(),c=a.y-this.getY();uc.moveElements(this.getChildren(),b,c),this._isAdjusting=!1}Nd.superClass.setLocation.call(this,a)}},reverseExpanded:function(){this.setExpanded(!this.isExpanded())},isExpanded:function(){return this._expanded},setExpanded:function(a){if(this._expanded!==a){var b=this._expanded;this._expanded=a,this.firePropertyChange("expanded",b,this._expanded),this._checkLinkAgent()}},_checkLinkAgent:function(){Nd.superClass._checkLinkAgent.call(this);for(var a=this.getChildrenSize(),b=0;a>b;b++){var c=this.getChildAt(b);c instanceof Ld&&c._checkLinkAgent()}},getElementUIClass:function(){return Gb.network.GroupUI},getCanvasUIClass:function(){return Gb.canvas.GroupUI},getVectorUIClass:function(){return Gb.vector.GroupUI}}),Gb.SubNetwork=function(a){Gb.SubNetwork.superClass.constructor.call(this,a)},Hb.ext("twaver.SubNetwork",Gb.Follower,{ISubNetwork:!0,_image:Dd.IMAGE_SUBNETWORK,_icon:Dd.ICON_SUBNETWORK,_checkLinkAgent:function(){Gb.SubNetwork.superClass._checkLinkAgent.call(this);for(var a=this.getChildrenSize(),b=0;a>b;b++){var c=this.getChildAt(b);c instanceof Ld&&c._checkLinkAgent()}}}),Gb.Grid=function(a){Gb.Grid.superClass.constructor.call(this,a)},Hb.ext("twaver.Grid",Gb.Follower,{_icon:Dd.ICON_GRID,_image:null,getCellObject:function(a,b){1===arguments.length&&(b=a.y,a=a.x);for(var c=this.getStyle("grid.row.count"),d=this.getStyle("grid.column.count"),e=0;c>e;e++)for(var f=0;d>f;f++){var g=this.getCellRect(e,f);if(Rb.containsPoint(g,a,b))return{rowIndex:e,columnIndex:f,rect:g}}return null},getCellRect:function(a,b){var c=this.getStyle("grid.row.count"),d=this.getStyle("grid.column.count");if(0>=c||0>=d)return null;if(0>a||a>=c)return null;if(0>b||b>=d)return null;var e=this.getRect();Rb.addPadding(e,this,"grid.border");var f=0,g=this.getStyle("grid.row.percents"),h=this.getStyle("grid.column.percents");if(g&&g.length===c){var i=0;for(f=0;a>f;f++)i+=e.height*g[f];e.y+=i,e.height=e.height*g[a]}else e.height=e.height/c,e.y+=e.height*a;if(h&&h.length===d){var j=0;for(f=0;b>f;f++)j+=e.width*h[f];e.x+=j,e.width=e.width*h[b]}else e.width=e.width/d,e.x+=e.width*b;return Rb.addPadding(e,this,"grid.padding"),e},getElementUIClass:function(){return Gb.network.GridUI},getCanvasUIClass:function(){return Gb.canvas.GridUI},getVectorUIClass:function(){return Gb.vector.GridUI}}),Gb.ShapeNode=function(a){this._isUpdatingShapeNode=!1,this._points=new md,Gb.ShapeNode.superClass.constructor.call(this,a)},Hb.ext("twaver.ShapeNode",Gb.Follower,{_icon:Dd.ICON_SHAPENODE,__accessor:["segments"],getElementUIClass:function(){return Gb.network.ShapeNodeUI},getCanvasUIClass:function(){return Gb.canvas.ShapeNodeUI},getVectorUIClass:function(){return Gb.vector.ShapeNodeUI},getPoints:function(){return this._points},setPoints:function(a){a||(a=new md);var b=new md(this._points);this._points=a,this.firePointsChange(b,this._points)},getSegments:function(){return this._segments},setSegments:function(a){a||(a=new md);var b=new md(this._segments);this._segments=a,this._reCalculateLineLength(),this.firePropertyChange("segments",b,this._segments)},addPoint:function(a,b){var c=new md(this._points);this._points.add(a,b),this.firePointsChange(c,this._points)},setPoint:function(a,b){var c=new md(this._points);this._points.set(a,b),this.firePointsChange(c,this._points)},removePoint:function(a){var b=new md(this._points);this._points.remove(a),this.firePointsChange(b,this._points)},removeAt:function(a){var b=new md(this._points);this._points.removeAt(a),this.firePointsChange(b,this._points)},setWidth:function(a){if(1>a&&(a=1),!this._isUpdatingShapeNode&&!Hb.isDeserializing){this._isUpdatingShapeNode=!0;for(var b=new md(this._points),c=0;c<this._points.size();c++){var d=this._points.get(c);d.x=(d.x-this.getX())*a/this.getWidth()+this.getX()}this.firePointsChange(b,this._points),this._isUpdatingShapeNode=!1}Gb.ShapeNode.superClass.setWidth.apply(this,arguments)},setHeight:function(a){if(1>a&&(a=1),!this._isUpdatingShapeNode&&!Hb.isDeserializing){this._isUpdatingShapeNode=!0;for(var b=new md(this._points),c=0;c<this._points.size();c++){var d=this._points.get(c);d.y=(d.y-this.getY())*a/this.getHeight()+this.getY()}this.firePointsChange(b,this._points),this._isUpdatingShapeNode=!1}Gb.ShapeNode.superClass.setHeight.apply(this,arguments)},setLocation:function(){if(!this._isUpdatingShapeNode&&!Hb.isDeserializing){var a;if(a=2===arguments.length?{x:arguments[0],y:arguments[1]}:arguments[0],!Hb.num(a.x)||!Hb.num(a.y))return;var b=a.x-this.getX(),c=a.y-this.getY();if(0===b&&0===c)return;this._isUpdatingShapeNode=!0;for(var d=new md(this._points),e=0;e<this._points.size();e++){var f=this._points.get(e);f.x+=b,f.y+=c}this.firePointsChange(d,this._points),this._isUpdatingShapeNode=!1}Gb.ShapeNode.superClass.setLocation.apply(this,arguments)},firePointsChange:function(a,b){if(!this._isUpdatingShapeNode&&!Hb.isDeserializing){var c=Rb.getRect(b);c?(this._isUpdatingShapeNode=!0,Dd.CENTER_LOCATION?this.setLocation(c.x+c.width/2,c.y+c.height/2):this.setLocation(c.x,c.y),this.setWidth(c.width),this.setHeight(c.height),this._isUpdatingShapeNode=!1):(this._isUpdatingShapeNode=!0,this.setWidth(0),this.setHeight(0),this._isUpdatingShapeNode=!1)}this._reCalculateLineLength(),this.firePropertyChange("points",a,b)},_reCalculateLineLength:function(){this._lineLength=null!=this._points&&this._points.size()>0?Rb.calculateLineLength(this._points,this._segments):0},getLineLength:function(){return this._lineLength}}),Gb.Bus=function(a){this._styleMap={},this._styleMap["vector.fill"]=!1,this._styleMap["shapenode.closed"]=!1,Gb.Bus.superClass.constructor.call(this,a)},Hb.ext("twaver.Bus",Gb.ShapeNode,{_icon:Dd.ICON_BUS,firePointsChange:function(a,b){var c=b.size();if(!Hb.isDeserializing&&c>=2)for(var d=b.get(0),e=1;c>e;e++){var f=b.get(e);Math.abs(f.x-d.x)>Math.abs(f.y-d.y)?f.y=d.y:f.x=d.x,d=f}Gb.Bus.superClass.firePointsChange.apply(this,arguments)}}),Gb.ShapeLink=function(a,b,c){this._points=new md,this._styleMap={},this._styleMap["link.bundle.enable"]=!1,Gb.ShapeLink.superClass.constructor.call(this,a,b,c)},Hb.ext("twaver.ShapeLink",Gb.Link,{_icon:Dd.ICON_SHAPELINK,getElementUIClass:function(){return Gb.network.ShapeLinkUI},getCanvasUIClass:function(){return Gb.canvas.ShapeLinkUI},getVectorUIClass:function(){return Gb.vector.ShapeLinkUI},getPoints:function(){return this._points},setPoints:function(a){a||(a=new md);var b=new md(this._points);this._points=a,this.firePointsChange(b,this._points)},addPoint:function(a,b){var c=new md(this._points);this._points.add(a,b),this.firePointsChange(c,this._points)},setPoint:function(a,b){var c=new md(this._points);this._points.set(a,b),this.firePointsChange(c,this._points)},removePoint:function(a){var b=new md(this._points);this._points.remove(a),this.firePointsChange(b,this._points)},removeAt:function(a){var b=new md(this._points);this._points.removeAt(a),this.firePointsChange(b,this._points)},firePointsChange:function(a,b){this.firePropertyChange("points",a,b)}}),Gb.ShapeSubNetwork=function(a){Gb.ShapeSubNetwork.superClass.constructor.call(this,a)},Hb.ext("twaver.ShapeSubNetwork",Gb.ShapeNode,{ISubNetwork:!0,_icon:Dd.ICON_SHAPESUBNETWORK,_checkLinkAgent:function(){Gb.ShapeSubNetwork.superClass._checkLinkAgent.call(this);for(var a=this.getChildrenSize(),b=0;a>b;b++){var c=this.getChildAt(b);c instanceof Ld&&c._checkLinkAgent()}}}),Gb.LinkSubNetwork=function(){Gb.LinkSubNetwork.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.LinkSubNetwork",Gb.Link,{ISubNetwork:!0,_icon:Dd.ICON_LINKSUBNETWORK}),Gb.ShapeLinkSubNetwork=function(){Gb.ShapeLinkSubNetwork.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.ShapeLinkSubNetwork",Gb.ShapeLink,{ISubNetwork:!0,_icon:Dd.ICON_LINKSUBNETWORK}),Gb.RotatableNode=function(a){Gb.RotatableNode.superClass.constructor.call(this,a)},Hb.ext("twaver.RotatableNode",Gb.Follower,{getWidth:function(){return 0==this._angle?this._getOrignalWidth():this._getRotateRect().width},setWidth:function(a){},getHeight:function(){return 0==this._angle?this._getOrignalHeight():this._getRotateRect().height},setHeight:function(a){},getElementUIClass:function(){return Gb.network.RotatableNodeUI},getCanvasUIClass:function(){return Gb.canvas.RotatableNodeUI},getVectorUIClass:function(){return Gb.vector.RotatableNodeUI},_getRotateRect:function(){for(var a=this._getOrignalWidth(),b=this._getOrignalHeight(),c=Rb.createMatrix(this._angle*Math.PI/180,a/2,b/2),d=[{x:0,y:0},{x:a,y:0},{x:a,y:b},{x:0,y:b}],e=0,f=d.length;f>e;e++)d[e]=c.transform(d[e]);return Rb.getRect(d)},_getOrignalWidth:function(){return Gb.RotatableNode.superClass.getWidth.call(this)},_getOrignalHeight:function(){return Gb.RotatableNode.superClass.getHeight.call(this)}}),Gb.controls.ControlBase=function(){Gb.controls.ControlBase.superClass.constructor.apply(this,arguments),this._pools=new md},Hb.ext("twaver.controls.ControlBase",Gb.PropertyChangeDispatcher,{_autoAdjustBounds:!1,addPool:function(a){this._pools.contains(a)||this._pools.add(a)},removePool:function(a){this._pools.remove(a)},adjustBounds:function(a){var b=this._view.style;b.position="absolute",b.left=a.x+"px",b.top=a.y+"px",b.width=a.width+"px",b.height=a.height+"px",this._autoAdjustBounds===!0&&(b.left="0px",b.top="0px",b.right="0px",b.bottom="0px"),this.invalidate&&this.invalidate()},setAutoAdjustBounds:function(a){a===!0?Ub.addEventListener("resize","_handleResize",window,this):Ub.removeEventListener("resize",window,this),this._autoAdjustBounds=a},isAutoAdjustBounds:function(){return this._autoAdjustBounds},_handleResize:function(a){this.adjustBounds({x:0,y:0,width:Mb.documentElement.clientWidth,height:Mb.documentElement.clientHeight})},getView:function(){return this._view},invalidate:function(a){this._invalidate||(this._invalidate=!0,Hb.callLater(this.validate,this,null,a))},validate:function(){this._invalidate&&(this._invalidate=!1,0===this._view.offsetWidth&&0===this._view.offsetHeight&&null!==this._reinvalidateCount?(void 0===this._reinvalidateCount&&(this._reinvalidateCount=100),this._reinvalidateCount>0?this._reinvalidateCount--:this._reinvalidateCount=null,this.invalidate()):this.validateImpl())},validateImpl:function(){}}),Gb.controls.ViewBase=function(){Gb.controls.ViewBase.superClass.constructor.apply(this,arguments),this._interactionDispatcher=new Gb.EventDispatcher,this._viewDispatcher=new Gb.EventDispatcher},Hb.ext("twaver.controls.ViewBase",Gb.controls.ControlBase,{__bool:["focusOnClick"],_focusOnClick:Dd.FOCUS_ON_CLICK,getSelectionModel:function(){return this._selectionModel?this._selectionModel:this._box.getSelectionModel()},isShareSelectionModel:function(){return null==this._selectionModel},setShareSelectionModel:function(a){var b=null==this._selectionModel;b!==a&&(a?(this._box.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this._selectionModel.removeSelectionChangeListener(this.handleSelectionChange,this),this._selectionModel.dispose(),this._selectionModel=null):(this._box.getSelectionModel().removeSelectionChangeListener(this.handleSelectionChange,this),this._selectionModel=new Gb.SelectionModel(this._box),this._selectionModel.addSelectionChangeListener(this.handleSelectionChange,this)),this.onShareSelectionModelChanged(),this.firePropertyChange("shareSelectionModel",b,a))},onShareSelectionModelChanged:function(){},removeSelection:function(){if(0===this.getSelectionModel().size())return null;var a=this.getSelectionModel().toSelection();return this._box._undoManager._enabled&&this._box._undoManager.startBatch(),a.forEach(function(a){this._box.remove(a)},this),this._box._undoManager._enabled&&this._box._undoManager.endBatch(),a},selectAll:function(){var a=new md;return this._box.forEach(function(b){this.isVisible(b)&&a.add(b)},this),this.getSelectionModel().setSelection(a),a},isSelected:function(a){return this.getSelectionModel().contains(a)},isSelectable:function(a){return this.getSelectionModel().isSelectable(a)},getLabel:function(a){return a.getName()},getToolTip:function(a){return a.getToolTip()},getIcon:function(a){return a.getIcon()},getSelectColor:function(a){return Dd.SELECT_COLOR},addViewListener:function(a,b,c){this._viewDispatcher.add(a,b,c)},removeViewListener:function(a,b){this._viewDispatcher.remove(a,b)},fireViewEvent:function(a){this._viewDispatcher.fire(a)},addInteractionListener:function(a,b,c){this._interactionDispatcher.add(a,b,c)},removeInteractionListener:function(a,b){this._interactionDispatcher.remove(a,b)},fireInteractionEvent:function(a){this._interactionDispatcher.fire(a)},invalidate:function(a){this._invalidate||(this._invalidate=!0,this.fireViewEvent({kind:"invalidate"}),Hb.callLater(this.validate,this,null,a))},validate:function(){this._invalidate&&(this._invalidate=!1,Kb||0!==this._view.offsetWidth||0!==this._view.offsetHeight||null===this._reinvalidateCount?(this._isValidating=!0,this.fireViewEvent({kind:"validateStart"}),this.validateImpl(),this.fireViewEvent({kind:"validateEnd"}),delete this._isValidating):(void 0===this._reinvalidateCount&&(this._reinvalidateCount=100),this._reinvalidateCount>0?this._reinvalidateCount--:this._reinvalidateCount=null,this.invalidate()))}}),Gb.controls.View=function(){Gb.controls.View.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.controls.View",Gb.controls.ViewBase,{_zoom:1,_maxZoom:Dd.ZOOM_MAX,_minZoom:Dd.ZOOM_MIN,getRootDiv:function(){return this._rootDiv},isValidEvent:function(a){return Ub.isValidEvent(this._view,a)},getAlarmFillColor:function(a){if(a.IElement){var b=a.getAlarmState().getHighestNewAlarmSeverity();if(b)return b.color}return null},getInnerColor:function(a){if(a.IElement){var b=a.getAlarmState().getHighestNativeAlarmSeverity();return b?b.color:a.getStyle("inner.color")}return null},getOuterColor:function(a){if(a.IElement){var b=a.getAlarmState().getPropagateSeverity();return b?b.color:a.getStyle("outer.color")}return null},zoomOverview:function(a){var b=Math.min(this._view.clientWidth/this._viewRect.width,this._view.clientHeight/this._viewRect.height);this.setZoom(b,a)},getLogicalPoint:function(a){return Ub.getLogicalPoint(this._view,a,this.getZoom(),this._rootDiv)},centerByLogicalPoint:function(a,b,c){c&&Gb.animate.AnimateManager.endAnimate();var d=this._view.scrollWidth-this._view.clientWidth,e=this._view.scrollHeight-this._view.clientHeight,f=(a-this._view.clientWidth/this._zoom/2)*this._zoom,g=(b-this._view.clientHeight/this._zoom/2)*this._zoom;0>f&&(f=0),0>g&&(g=0),f>d&&(f=d),g>e&&(g=e),c?Gb.animate.AnimateManager.start(new Gb.animate.AnimateScrollPosition(this._view,f,g)):(this._view.scrollLeft=f,this._view.scrollTop=g)},panByOffset:function(a,b){a*=this.getZoom(),b*=this.getZoom();var c=this._view.scrollLeft+a,d=this._view.scrollTop+b,e=this._view.scrollWidth-this._view.clientWidth,f=this._view.scrollHeight-this._view.clientHeight;0>c&&(c=0),c>e&&(c=e),0>d&&(d=0),d>f&&(d=f);var g={x:(c-this._view.scrollLeft)/this.getZoom(),y:(d-this._view.scrollTop)/this.getZoom()};return this._view.scrollLeft=c,this._view.scrollTop=d,g},getMaxZoom:function(){return this._maxZoom},setMaxZoom:function(a){if(!(0>a)){var b=this._maxZoom;this._maxZoom=a,this.firePropertyChange("maxZoom",b,a),this.getZoom()>a&&this.setZoom(a)}},getMinZoom:function(){return this._minZoom},setMinZoom:function(a){if(!(0>a)){var b=this._minZoom;this._minZoom=a,this.firePropertyChange("minZoom",b,a),this.getZoom()<a&&this.setZoom(a,!1)}},getZoom:function(){return this._zoom},onZoomChanged:function(a,b){},zoomIn:function(a){this.setZoom(this._zoom*Dd.ZOOM_INCREMENT,a)},zoomOut:function(a){this.setZoom(this._zoom/Dd.ZOOM_INCREMENT,a)},zoomReset:function(a){this.setZoom(1,a)},checkZoom:function(a){return a<this._minZoom&&(a=this._minZoom),a>this._maxZoom&&(a=this._maxZoom),a},setZoom:function(a,b){if(Hb.num(a)&&!(0>=a)&&(a=this.checkZoom(a),a!==this._zoom))if(null==b&&(b=Dd.ZOOM_ANIMATE),b)Gb.animate.AnimateManager.start(new Gb.animate.AnimateZoom(this,a));else{var c=(this._view.scrollLeft+this._view.clientWidth/2)/this._zoom,d=(this._view.scrollTop+this._view.clientHeight/2)/this._zoom,e=this._zoom;this._zoom=a,Ub.setZoom(this._rootDiv,a),this.firePropertyChange("zoom",e,a),this.onZoomChanged(e,a),this.centerByLogicalPoint(c,d,!1)}},setTouchZoom:function(a){this.setZoom(a,!1)}}),function(){var a=function(a,b,c,d){var e=new Nb;e.src=d,Gb.Util.registerImage(a,e,b,c)};a("subnetwork_image",64,46,"data:image/png;base64,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"),a("bus_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAINJREFUeNqkU0EOgCAMo2Y/1P8Y/6NvnBADwTnGzHYiGetKW8DMKVJLChbVAwCNCrrzp5/Zg/4MaH0JMBOEh08o6OtxtgvXvkFuV/vFBeGEm0WZo8GgF+QlIkI2OrZq5WLAFjuy4DvVWXHl2VodyElMjkxAJNFm4EjmFGAqLKLf+RZgAKkFNRwzv7gHAAAAAElFTkSuQmCC"),a("data_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAMZJREFUeNqkU8ENwjAM9KEwWwaAKVA3iMQDtRtUTAEDdLZWMkkhIUljU4n7RInP9p3dgoiYBAzDgHAyfykA1rtzbr2bmpDDk5uBvu+ROO98pvs4FqRL10nCogokBS3UBaXCZg9JQ7JQY5qmZoK1trCQCuQJnoS9CsQZHKsNcOyWvS1ehdGqz8xyZ0BXEHG+PTdvj+uJkFsASsusdN5sQSKHGWgWfDxY1GcQfEIYIn4p+HuN+SqXRtL8+ZAOinwm5V+P8ZcAAwC0T1T5kpEqewAAAABJRU5ErkJggg=="),a("databox_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAJpJREFUeNpi/P//PwMjI+N/BiIBUD0jMp8FpDm4cQ2DvYEiw8EL9/FqBqkBqUc3BGT7/0kbz/6HsXHhS/eewtWBXA7CYAMOX75PlCEgA9ANYYQaADbJVleRAShJ0Csw7+T5G2MaQCpgQReAuQAWqPhokAuYGCgEowZQwwBQuiYn/mGAEZaeYTkSlA6IBeCUCDMA2RBSsjZAgAEAOyp6/CYHWkwAAAAASUVORK5CYII="),a("grid_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAFdJREFUeNpi/P//PwMlgImBQsACIhgZGUl2BtDljCguAHkFhIMb1xBkU9ULjCATQV4A2UAsWFsfAvcCzEn/YQBoEEE2VD1Y76gXhpcXyM0LjJRmZ4AAAwCoyOJjz29PsAAAAABJRU5ErkJggg=="),a("group_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAOFJREFUeNqUUwsOwjAILa67i2fwEMbEnUej55mJO4Rn8DBtglAh6YfOSdJkBfregwEgottiHiAlQuZjh68TQRJzI5L07nSbC//zOrUAmkxAJXBP2VgxRjpDK818z06gZIwrfSACF0iVVZrLiab7ownOl7PTV0QESsRgWqoHt80oD0fpy/BVhuZfsOpkC8LYxAkBw4YedOdDhuRny1UyZEPE334NvbZ6kBYeJGFPKFgp4HsUAqtI9u1AYipJgfQ+GjtQlPvPMkGlBHrLdFjeBeHruE+hYAxSo6C3jb4zyh8BBgBVL19PZ27iaAAAAABJRU5ErkJggg=="),a("group_image",32,29,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAdCAYAAADLnm6HAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABHNJREFUeNqsV1ts21QY/uy4zc1ZnZY2bdbSLMlKxUWkaBJMgJY9gARIax/2NokVofLARWjiBYRY2QMdCGlI440H1ok3btsQ0wAxNdvKpnYdyyYK7UZHVK1L2rRZLo3j2InDOaZD60psp+WXrDjO93/nO7/PfwkDAwu0Nh8jH30wZwc6/f43X9jVJ5gBn/zueJozgaNkUXLtMwLyLt4XDG4Vtj+/B8lMQRf7QLsb079PCpzJnaVnEsmIEeiZgD/Mu5yYT4uYiWd1sW1NTlCsWQGmzC00gOd5lFQVkqLoYiuViobVBNzf3BRaCfUaUyuV2AomXI1sNrmkRUeUZBRlBXJJRVFRdQUoZVXDclvbvUeImn6j3VmAqpjg5ra0xcL2nDwdwW1JQeP2HJLLki7frVQOo+OXwNnttv5fp65vKPSvvLhHmBgf77fV10XqWBaLZPGEgYC0KIFiOYfdBoY8OH72D8QS6ZoX3x1+CFarFZSnxS1gk9OBeUJ+00BAimAolnM6nQDDEDVAHVOpWQBD/Ow2GyhPoyDHWKjYkr+GVrv+GWBmE6BYIsChRYCz0Kt2AWR92GxWUJ7TFy7GWltb9l368ZteM77lcukE53A4tC91VAC7jggwVIANd3h+OHM+Qlj2ktvQv9U0EIAkSZibm7vbNUpcIxxPQsfQV2BhwDHrE2C320F5qPnaPCMkdVel9EdDQ8iLeex/5+27H4dYljnGnRo5B1EUMT1fwI2lUs0CHs9JOD9xGeNjY9i7u9dXkKTovZgvv/j8H+y2njX+3FxiHmKhgHiGhCir1CwgKxawsLgEynP06xO0aO2sxV+rhAopm9migrRUuwCJVDMS8nXXEE2ALMtIF2UskVJaqxWIgIqqrl8ATUGFkNDaLKu174RGjzYWykO9A17P+6pa2WEqhVnmDOfmnUgmk+gN2vBsZ33NAng1DxspIpTH1+H1Pdrz2OCHn34GpaQfFYe1Dm+9+nKY62jzpIcG3xU20gukXAZtzU0Rkoo+mo6/TMZxI6E/Dzz9sFdLXc7jad6pSIW+jQho2OSKjl2djOyiAwmdB8jrLMj6Ka3emQd+Gh2jeUvTp7/aTGBgwyv+cJNm5HLx2plQSmX9AkYuiuXqOUuorKoj1RZ/7fU34PcHMLj/PSwv5/4LMsgy7EtKuTz887kLyMoq7CERi/miroD5TB4Xr/wGrsPT8omqqlV3PjAwgIYGAd9/+xVmrledG46QjhiZjs0iSYtSehk3M6KugAUigGK5rqA/rAc89MEBOJy81qq7u4LVJyYL27eYSkV50hkXxCLmDCKQIhiK5do3e3VL59TUNdrZ0N3dddTgLMQ89zX5XKQtP+m14kGB1QVv4VVMrIwCRn9M6PkAGctN1fjnwk9ddjc2hcxgb6eWov/rWE7tVGS0ZyWjfEYRoxlkVoBAIhE2gYst5vKDpVJ51QR96PBhxONxfHzw4Oo+wFl2mBFAJ1W6+IgR0OGwD2/zda4Z32/99ScpTiU80fPIvT/1/y3AAMOmtJl1Hv9IAAAAAElFTkSuQmCC"),a("link_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHVJREFUeNqkkwEOgCAIRaEr6nlqdR49I4XTzcqUn39jE5xP1C+LCPkjCl0Kq2NC5fYgRXlMSCw0K6Xozhqaol3ckj+QVwGFNIsI5HPCCunSLZDhGUcQ0033IOb3riE1CLJty/bTVubUBqDyc+Pm01oY8NQpwAAbUwhLBQIWcAAAAABJRU5ErkJggg=="),a("linksubnetwork_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAU5JREFUeNqUUi1Tw0AQ3cukEY0AwdlDM8XRD41ARAAi/RHoCmQ7/QNofkTQFQh8W9kOOtgiQIBImTnuXbs3udAvduZms5t9b/fdrUiHGW2z0cOdLsdJ71GU46yfUrgL/PWx8HLxsUTOI3EE98mp9ZdXie0K8HgydYXtVtN6znHsTQAwdy2DOcY/TMFytkqogqskLIf6qQhYL7q/PI8cOIoiiuO69bvIRf3o5M/YANVqIZ03GjSbz2m5/KGiKDxgp90irbUINzEz2BSQEMKSwJiEwfgONmlFR4AAhg2yV0talWNfAbfJN4s7KHcCCcBPgy7WhobdM7q9uXbd3TPyhvEOwL4/30kpRVJKwrYySZ7nWABlzpsthM49R5lzYUhAruERr/P7CdZNPJJVakUiuOgAw9jSXOyUX8f4ZkCHGzQvAGIw4v9M4E0CMEh/BRgAwM37IYxGnbkAAAAASUVORK5CYII="),a("node_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAGBJREFUeNpiZGBg+M9AJvj//z8jC5RBsmZGRkYwzQITCGlaS7TmNXXBcDYTA4Vg1IDBYAAjJB2Rl5DgKRGWqshyATm2o3uBgcwMBbacBZdmZJfh8CJIASMLodxGCAAEGACTAB0gDBYjygAAAABJRU5ErkJggg=="),a("node_image",30,32,"data:image/png;base64,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"),
a("shapelink_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAIJJREFUeNqkUwsOgCAIxeYN5Ty1Og+ekUarzRwQ5tsYDpTPExIzgwY86uWgtSTwIAF6KTvxg/sMliwwCy27mEVr2Xu7+TjaWm4JqxvKpW/iWowQprX2i8RXhS0xXv+WL0xiKIAVxKssa/0hEMuPiB4epNFxnh7lZG1jdCPdABGcAgwAc06H0rgwLSIAAAAASUVORK5CYII="),a("shapenode_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAI9JREFUeNq0UtsNgDAILI0jdZN2Ho3O027SnRA+MNb0QTWS8EPuLncAIKL5UvY5CEdC7h7pjrEtEABgqwucRCBFk7aAfo9uZJtwmXhQCLDyLJlrkSxaMuGgu8QZ8hVhYD8LVgZx9fMO1H9QKXbm+EJvBYwsuSYyFaEmUvyBUkQWCYUDfg5NV8/49xW6dQowAIJydCoPajIHAAAAAElFTkSuQmCC"),a("shapesubnetwork_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAATBJREFUeNpiDG5cw4ALbO/L+I/M9yyawYjMX1MXzMCCT/PXD69RxLgFREFiKIbADSjzlAfTjq6eYFtBmk+dPgNXaGZqAqZhYjA+igtAmmG2ImuG8UFyIFfAvIPTC+ia0Q2BeYehLpiRCeZfkO37d2/HqRmX4Yxc/CJwZ9+6fYeBEPjw4QOYNjczZfj//z8j3AuMjIjAvXnrNoomdTVVFDkonxEjEIEmgg1C1oAuhw5YQKEZGhHzH9kVbcuPoiiqirSGy5UUF8FtBwFwIK5esYQRaIMfyE/Y/A0yEGbopk2b/FACEeQ0mO1Ati+UvQndFciuAVkG5W5GMQDqV1+QAci2oxuAFC5+4MCBGQIzAEKBBbFimBxILc7MhOQiPzTxTcixwYhsOxLwRWJvxicHEGAAkPKxzyGuYWgAAAAASUVORK5CYII="),a("subnetwork_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAOJJREFUeNqkUjsOwjAMzavSBQYY4FDM7SGYOUARHICZQ5SBiUPBAAMLIJk8aFASkoDgSVFlu/68Z6NatCqF3Woqrj2ZreHabVMpnUs+H/eerz8c0+cV0amuTK6XG69bDEWsa5hM0KafU/DZeJRCmBwWsXRUUwEU0Y5tRFLfgHRMARYDeoPRSyy383Zee0nsgO5rcROBzo19FUlOoYG0Bp/0IAW7y4LHQT5GB/UL4F6ie3mX0yFLoTQUTByQxE8lQ51wMRHx1Chd4FtkReQUj3VFktj97ZSDNYkK9h6L/03hLsAAjRx4oMVjqkMAAAAASUVORK5CYII="),a=function(a,b,c,d){Gb.Util.registerImage(a,d,b,c)},a("expand_icon",16,18,"data:image/gif;base64,R0lGODlhEAASAIcAADFKY0L/QpSlvZylvZytxqW11qm92r3GxrnK5MbGxsbW69jh8efv9+vz/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAMAAAEALAAAAAAQABIAAAhfAAMIHEiwoMGDCBMqXMjQ4AICEAcMECDgwEECDjJmbMAAwEWNDjgi8GgQ40YGCwyQLDjAAYCXL1UeFBAS5QIFBVYSFMBxwU0EOWcyUIDAQIGjOgcegMnUYsOnUKMiDAgAOw=="),a("collapse_icon",16,18,"data:image/gif;base64,R0lGODlhEAASAIcAADFKY0L/QpSlvZylvZytxqW11qm92r3GxrXI48bGxsbS59Te8efv9+vz/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAMAAAEALAAAAAAQABIAAAhhAAMIHEiwoMGDCBMqXMjQ4AICEAcMECDgwEECDjJmbMAAwEWNADgq8GgQY0YADBYYIFlwgAMAMGGuPCjAAUcACxQUYElQAMcFABQg2EmTgVADBZLyHHggplOLDaNKnYowIAA7"),a("close_icon",11,11,"data:image/gif;base64,R0lGODlhCwALAIcAAHd3d319fUD/QIODg4iIiI6Ojq6urri4uNnZ2eHh4eTk5Ofn5/Dw8PT09Pj4+Pn5+fz8/P39/f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAMAAAIALAAAAAALAAsAAAhdAAUIOECw4AGBAyUoXCjh4AEJDBA4mIiAQcMDERAUKOBgI4IIBCE0IECSZAMIBB8wYDCg5coHBBkkCECTZgIGMQ0AAKBgpwGcBxgsMLCgKFGcA1cqXXlQoMGCAgMCADs="),a("sort_desc",9,5,"data:image/gif;base64,R0lGODlhCQAFAJECAImJiezs7P///wAAACH5BAEAAAIALAAAAAAJAAUAAAIMDI4QYrnC0INxUnYLADs="),a("sort_asc",9,5,"data:image/gif;base64,R0lGODlhCQAFAJECAImJiezs7P///wAAACH5BAEAAAIALAAAAAAJAAUAAAIMlAWnwIrcDJwi2HsLADs="),a("submenu_enable_icon",8,8,"data:image/png;base64,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"),a("submenu_disable_icon",8,8,"data:image/png;base64,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"),a("checkbox_selected_icon",16,16,"data:image/png;base64,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"),a("checkbox_unselected_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAiUlEQVR42qXM3QYFIRiF4d3dJpIhI5FKJCOSSHe7f9gn4ztZo3Wwzt6HvTbHfhdCeD8Nvw27Ad57OI4xUsA5BwMpJQpYa2Eg50wBYwwMlFIocJ4nDFzXRQGtNQzUWilwHAcMtNYooJSCgd47BaSUMDDGoIAQAgbmnBTgnMPAWosCcP3fDdjZNvABvRhVEQglsV8AAAAASUVORK5CYII="),a("radiobutton_selected_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAXFJREFUeNrUUz9rwkAUv0syBVxMm01L2lIdilOg4BcQ7eKcIV/AqZAxo1/B2a/QoSSTH6AQCoFMJUSig5C0EiPEv8G+Z604eJNTHxz37vf73Y977+7obrcjlwRHLoyLDYTThWmav6AgKDA9wrg6UF8wvO12O8RFt9s9bwACwvP8U6lUajWbzbYsy/eIR1Hk27b9GgSBlef5O7OEzWZzC5ufNU17gc01gEQcmCOGHGqYJaxWq1qj0WhzHFfwfZ84jrPHVVUliqIUkPM87wOg4KzBcrm8liTpbr1ek8FgQNI03eOz2Yzouk6QQw3zBFmWUewDxnQ6JUmSHHsDRz9qmD0A8ns8HgcortfrRxxzxJBDDfMEi8XC7ff7b4Zh3FSr1UKlUtnjlFI0mCOHGqZBHMd+GIbWZDIROp1OCxqH74HA9Q17vZ7luq4liqJ/uoee/oVyufxX/wPctwqpfKAieB9OsVj8xMVoNDpv8D8/048AAwDskrF8QGeJUgAAAABJRU5ErkJggg=="),a("radiobutton_unselected_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAATVJREFUeNrUU71qhEAQ9q8S0mhip3C5kCpcFcgjiJfmal/BKr2lr2DtK1wR9BkCaYRUQTzUQtDE5sB/MTOJAQs3jVUGhp2Z75vPnV2XHseRWmMMtdJWC3DzxDTNnyLHbWC5A7+coA/wt77vT5hYlrUsAASKZdkHWZb3mqYdJEm6wXqWZYHneccwDN1hGF6II3Rddw3Nj7quP0HzDko8OsZYQww5RIGmaXaqqh4YhrnA3cwda4ghh3gGdV1fiaK4bdt28cAQQw5RoCxLGr/2lyGHOAKAn0mShDAnteSIIYcoUFWV7zjOM5DPuJPfxik+I4Yc4gh5ngdRFLlpmnKGYew3YFiH6zvZtu36vu/yPB/Me+j5W1AU5XstiuIW7vseQmmCMvg/XgVBeMckjuNlgf/5mL4EGAAhHbltcqEYDQAAAABJRU5ErkJggg=="),a("right_expand_icon",6,11,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAALCAYAAABcUvyWAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6N0ZBRTFFQjJGQjA1MTFFNUE5M0NCMDAwMTJBRUZCNjkiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6N0ZBRTFFQjNGQjA1MTFFNUE5M0NCMDAwMTJBRUZCNjkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpCMzYzQTE5MUZBRkYxMUU1QTkzQ0IwMDAxMkFFRkI2OSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpCMzYzQTE5MkZBRkYxMUU1QTkzQ0IwMDAxMkFFRkI2OSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqPQWR4AAABJSURBVHjaYvT08vrPwMAgCsQM27ZufcMABUxQ+jWI8PL2FkGXwJBElkCRRJeAS2KTAEvikhDFJiGKzSi4f5iwCSLrwPA5QIABAAmgFhOOHdKvAAAAAElFTkSuQmCC"),a("left_expand_icon",6,11,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAALCAYAAABcUvyWAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6N0ZBRTFFQjZGQjA1MTFFNUE5M0NCMDAwMTJBRUZCNjkiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6N0ZBRTFFQjdGQjA1MTFFNUE5M0NCMDAwMTJBRUZCNjkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo3RkFFMUVCNEZCMDUxMUU1QTkzQ0IwMDAxMkFFRkI2OSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo3RkFFMUVCNUZCMDUxMUU1QTkzQ0IwMDAxMkFFRkI2OSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PmpWGHAAAABISURBVHjaYvz//z8DDHh5e4tAma+ZsAmCCCZsgiDAfOr0aQxBuA50QZgEhiBMQhSXBAM2SaZtW7e+wSYJ1oFNEu5BdEmAAAMAvV8Xc/cw3YgAAAAASUVORK5CYII="),a("up_expand_icon",11,6,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QjM2M0ExOEZGQUZGMTFFNUE5M0NCMDAwMTJBRUZCNjkiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QjM2M0ExOTBGQUZGMTFFNUE5M0NCMDAwMTJBRUZCNjkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpCMzYzQTE4REZBRkYxMUU1QTkzQ0IwMDAxMkFFRkI2OSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpCMzYzQTE4RUZBRkYxMUU1QTkzQ0IwMDAxMkFFRkI2OSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PnCNygcAAABGSURBVHjaYvz//z8DDHh5e4tAma+BWBTE2LZ16xuYPBMOhXAaSRyiGItCBmwaGD29vHApRAaiyM7ApxAuz0SEQrgGgAADALOxFSETkKKwAAAAAElFTkSuQmCC"),a("down_expand_icon",11,6,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA0xpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QjM2M0ExOENGQUZGMTFFNUE5M0NCMDAwMTJBRUZCNjkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QjM2M0ExOEJGQUZGMTFFNUE5M0NCMDAwMTJBRUZCNjkiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjQ5ZTRmZmE2LTQzNmYtMTE3OS04NThhLTk1ZGZjOWRiNmNiOCIgc3RSZWY6ZG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjQ5ZTRmZmE2LTQzNmYtMTE3OS04NThhLTk1ZGZjOWRiNmNiOCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PtPgXX8AAAA7SURBVHjaYvH08vrPQCRgAmJRItWKMsEYhBSCTd62desbAhrA4iB1TDAGDg2iyPIwZ2DTIIomzgAQYAAmahUFv1Iq6AAAAABJRU5ErkJggg==")}(),Pb.__tree=function(a,b){a._rootVisible=!0,a._initTree=function(a){this._rootData=null,this._expandMap={},this._levelMap={}},a.validateModel=function(){this._rowDatas.clear(),this._levelMap={},this._dataRowMap={},this._currentLevel=0,this._rootData?this._rootVisible?this.isVisible(this._rootData)&&this._buildData(this._rootData):this._buildChildren(this._rootData):this._buildChildren(),delete this._currentLevel},a._buildData=function(a){this._dataRowMap[a.getId()]=this._rowDatas.size(),this._rowDatas.add(a),this._levelMap[a.getId()]=this._currentLevel,this.isExpanded(a)&&(this._currentLevel++,this._buildChildren(a),this._currentLevel--)},a._buildChildren=function(a){var b=a?a.getChildren():this._box.getRoots(),c=this.getCurrentSortFunction();c&&this.isChildrenSortable(a)?b.toList(this.isVisible,this).sort(c).forEach(function(a){this._buildData(a)},this):b.forEach(function(a){this.isVisible(a)&&this._buildData(a)},this)},a.getLevel=function(a){return this._levelMap[a.getId()]},a.getToggleImage=function(a){return a.getChildrenSize()>0?this.isExpanded(a)?this._expandIcon:this._collapseIcon:null},a.isCheckable=function(a){return this.isCheckMode()},a.isCheckMode=function(){return 1===Pb.__tree._checkMap[this._checkMode]},a.isChildrenSortable=function(a){return!0},a.handleDataBoxChange=function(a){"remove"===a.kind?delete this._expandMap[a.data.getId()]:"clear"===a.kind&&(this._expandMap={}),this.invalidateModel()},a.isExpanded=function(a){return 1===this._expandMap[a.getId()]},a.expand=function(a){if(!this.isExpanded(a)){for(var b=a.getParent();null!=b&&b!==this._rootData;)this._expandMap[b.getId()]=1,b=b.getParent();this._expandMap[a.getId()]=1,this.invalidateModel()}},a.collapse=function(a){this.isExpanded(a)&&(delete this._expandMap[a.getId()],this.invalidateModel())},a.expandAll=function(){this._box.forEach(function(a){this._expandMap[a.getId()]=1},this),this.invalidateModel()},a.collapseAll=function(){this._expandMap={},this.invalidateModel()},a._handleClick=function(a){if(this.isFocusOnClick()&&Gb.Util.setFocus(this._view),!this._isValidating){var b;if(a.target._expandData&&!a.target.ableExpand)b=a.target._expandData,this.isExpanded(b)?(this.collapse(b),this.fireInteractionEvent({kind:"collapse",data:b})):(this.expand(b),this.fireInteractionEvent({kind:"expand",data:b}));else if(a.target._selectData||a.target.parentNode._selectData){if(this._handlePressSelection(a.target._selectData||a.target.parentNode._selectData,a),this.isCheckMode()){var c=this.getRowIndexAt(a);c>=0&&this.__handleClick(a)}}else this._treeColumn?(b=this.getDataAt(a),b&&(this.isCheckMode()?a.target._checkData||this.__handleClick(a):this._handlePressSelection(b,a))):this.isCheckMode()&&!a.target._checkData&&this.__handleClick(a);if(this._currentEditor&&!this._isCommitting&&(this._isCommitting=!0,this.commitEditValue(this._currentEditor._editInfo,this._currentEditor)),this.updateCurrentEditor){var d=this;setTimeout(function(){d.updateCurrentEditor(a)},0)}}},a.__handleClick=function(a){var b=this.getDataAt(a);if(b){var c=this.getRowIndexByData(b);if(this._focusedRow!==c){var d=this._rowDatas.get(this._focusedRow);this._focusedRow=c,d&&this.invalidateData(d),this.invalidateData(b)}}},a._handleDoubleClick=function(a){if(this.isFocusOnClick()&&Gb.Util.setFocus(this._view),!this._isValidating){var b;a.target.ableExpand&&a.target._expandData&&(b=a.target._expandData,this.isExpanded(b)?(this.collapse(b),this.fireInteractionEvent({kind:"collapse",data:b})):(this.expand(b),this.fireInteractionEvent({kind:"expand",data:b})))}},a.handleChange=function(a){if(!(this._isCommitting||this._isCanceling||this._isValidating)){var b=a.target._checkData;if(b){var c,d=this.isSelected(b),e=this.getSelectionModel();if("default"===this._checkMode)d?e.removeSelection(b):e.appendSelection(b);else if("children"===this._checkMode)c=new md(b),c.addAll(b.getChildren());else if("descendant"===this._checkMode)c=new md,Hb.fillDescendant(b,c);else if("descendantAncestor"===this._checkMode&&(c=new md,Hb.fillDescendant(b,c),!d))for(var f=b.getParent();f;)c.add(f),f=f.getParent();d?e.removeSelection(c):e.appendSelection(c)}a.target._editInfo&&this.commitEditValue&&(this._isCommitting=!0,this.commitEditValue(a.target._editInfo,a.target))}},a.onLabelRendered=function(a,b,c,d,e,f){},a.onToggleImageRendered=function(a){},a._renderTree=function(a,b,c,d){var e=this._levelMap[b.getId()],f=this.getToggleImage(b),g=this.getLineType(),h=this._indent,i=this.__spanPool.get();i.style.display="inline-block",i.style.position="relative",i.style.verticalAlign="top",i.style.margin="0px 1px 0px 1px",i.style.width=(e+1)*h+"px",a.appendChild(i);var j=b,k=j.getParent(),l=0;if("dotted"===g||"solid"===g){if(null==k){var m=this.getIcon(b);this._addLine(i,b,m,!0)}for(;null!==k;){var n=k.getChildren(),o=j===n.get(n.size()-1),m=this.getIcon(j);j.setClient("isLast",o),0==l&&this._addLine(i,b,m,o),l++,j=k,k=k.getParent()}}if(f){var p=this.__imagePool.get();p.setAttribute("src",Hb.getImageSrc(f)),p.style.verticalAlign="middle",p._expandData=b,p.style.position="absolute",p.style.right="0px";var q=this;p.onload=function(){p.style.top=q.getRowHeight()/2-p.height/2+"px"},i.appendChild(p),this.onToggleImageRendered(p)}var r=this.isCheckable(b),s="disabled"===this.getUncheckableStyle();if(r||s){var t=this._addCheckBox(a,b,d);t.disabled=!r}var m=this.getIcon(b);if(m){var u=this.isCheckMode()||this._treeColumn?null:b;this._addIcon(a,b,m,u)}var v=this.getLabel(b);v&&(i=this.__textPool.get(),i.style.whiteSpace="nowrap",i.style.verticalAlign="middle",i.style.padding="1px 2px 1px 2px",Hb.setText(i,v,this._treeColumn?this._treeColumn.isInnerText():this._innerText),f&&(i._expandData=b,i.ableExpand=!0),this.isCheckMode()||this._treeColumn?this._focusedRow===c&&(i.style.backgroundColor=this.getSelectColor(b)):(i._selectData=b,i.style.backgroundColor=d?this.getSelectColor(b):""),this.onLabelRendered(i,b,v,c,e,d),a.appendChild(i),a.title=this.getToolTip(b))}},Pb.__tree._checkMap={"default":1,children:1,descendant:1,descendantAncestor:1},Gb.Column=function(a){Gb.Column.superClass.constructor.call(this,a)},Hb.ext("twaver.Column",Gb.Data,{IColumn:!0,__property:1,__accessor:["width","horizontalAlign","valueType","propertyType","propertyName","editable","visible","sortable","resizable","movable","sortDirection","sortFunction","enumInfo"],__bool:["innerText"],_innerText:Dd.COLUMN_INNER_TEXT,_width:Dd.COLUMN_WIDTH,_horizontalAlign:Dd.COLUMN_HORIZONTAL_ALIGN,_propertyName:null,_propertyType:Dd.COLUMN_PROPERTY_TYPE,_valueType:Dd.COLUMN_VALUE_TYPE,_editable:Dd.COLUMN_EDITABLE,_sortable:Dd.COLUMN_SORTABLE,_visible:Dd.COLUMN_VISIBLE,_resizable:Dd.COLUMN_RESIZABLE,_movable:Dd.COLUMN_MOVABLE,_sortDirection:"asc",_sortFunction:Dd.SORT_FUNCTION,_enumInfo:null,renderCell:Dd.COLUMN_RENDER_CELL,renderHeader:Dd.COLUMN_RENDER_HEADER,renderEditor:Dd.COLUMN_RENDER_EDITOR,setParent:function(a){throw"parent not supported"},getEnumInfo:function(){return"object"==typeof this._enumInfo?this._enumInfo:"function"==typeof this._enumInfo?1===arguments.length?this._enumInfo(arguments[0]):this._enumInfo():void 0;

}}),Gb.ColumnBox=function(a){Gb.ColumnBox.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.ColumnBox",Gb.DataBox,{_name:"ColumnBox",add:function(a,b){if(!a.IColumn)throw"Only IColumn can be added into ColumnBox";Gb.ColumnBox.superClass.add.apply(this,arguments)}}),Gb.Property=function(a){Gb.Property.superClass.constructor.call(this,a)},Hb.ext("twaver.Property",Gb.Data,{IProperty:!0,__property:1,__accessor:["horizontalAlign","valueType","editable","propertyType","propertyName","categoryName","enumInfo"],__bool:["innerText"],_innerText:Dd.PROPERTY_INNER_TEXT,_horizontalAlign:Dd.PROPERTY_HORIZONTAL_ALIGN,_propertyName:null,_propertyType:Dd.PROPERTY_PROPERTY_TYPE,_valueType:Dd.PROPERTY_VALUE_TYPE,_editable:Dd.PROPERTY_EDITABLE,_categoryName:Dd.PROPERTY_CATEGORY_NAME,_enumInfo:null,renderName:Dd.PROPERTY_RENDER_NAME,renderValue:Dd.PROPERTY_RENDER_VALUE,isVisible:null,renderEditor:Dd.PROPERTY_RENDER_EDITOR,setParent:function(a){throw"parent not supported"},setPropertyName:function(a){var b=this._propertyName;this._propertyName=a,this.firePropertyChange("propertyName",b,a)},setPropertyType:function(a){var b=this._propertyType;this._propertyType=a,this.firePropertyChange("propertyType",b,a)},getEnumInfo:function(){return"object"==typeof this._enumInfo?this._enumInfo:"function"==typeof this._enumInfo?1===arguments.length?this._enumInfo(arguments[0]):this._enumInfo():void 0}}),Gb.PropertyBox=function(a){Gb.PropertyBox.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.PropertyBox",Gb.DataBox,{_name:"PropertyBox",add:function(a,b){if(!a.IProperty)throw"Only IProperty can be added into PropertyBox";Gb.PropertyBox.superClass.add.apply(this,arguments)}}),Gb.Tab=function(a){Gb.Tab.superClass.constructor.call(this,a)},Hb.ext("twaver.Tab",Gb.Data,{ITab:!0,__accessor:["view","width","closable","resizable","movable","disabled","visible"],_icon:null,_width:Dd.TAB_WIDTH,_closable:Dd.TAB_CLOSABLE,_resizable:Dd.TAB_RESIZABLE,_movable:Dd.TAB_MOVABLE,_disabled:Dd.TAB_DISABLED,_visible:Dd.TAB_VISIBLE,setParent:function(a){throw"parent not supported"}}),Gb.TabBox=function(a){Gb.TabBox.superClass.constructor.apply(this,arguments),this.getSelectionModel().setSelectionMode("singleSelection")},Hb.ext("twaver.TabBox",Gb.DataBox,{_name:"TabBox",add:function(a,b){if(!a.ITab)throw"Only ITab can be added into TabBox";Gb.TabBox.superClass.add.apply(this,arguments)}}),Gb.controls.ListBase=function(a){Gb.controls.ListBase.superClass.constructor.apply(this,arguments),this._invalidate=!1,this._invalidateModel=!1,this._invalidateDisplay=!1,this._invalidateDatas=null,this._rowDatas=new md,this._startRowIndex=0,this._endRowIndex=0,this._renderMap={},this._dataRowMap={},this.__divPool=new Gb.Pool("div",20),this.__imagePool=new Gb.Pool("img",20),this.__canvasPool=new Gb.Pool("canvas",20),this.__spanPool=new Gb.Pool("span",20),this.__textPool=new Gb.Pool("span",20),this.__checkBoxPool=new Gb.Pool("input",20),this.__linePool=new Gb.Pool("canvas",20),this._pools.add(this.__divPool),this._pools.add(this.__linePool),this._pools.add(this.__imagePool),this._pools.add(this.__canvasPool),this._pools.add(this.__spanPool),this._pools.add(this.__textPool),this._pools.add(this.__checkBoxPool),this._view=Ub.createView("auto",!0),this._rootDiv=Ub.createDiv(),this._dataDiv=Ub.createDiv(),this._dataDiv.style.width="1px",this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._dataDiv),this.setDataBox(a?a:new Gb.DataBox);var b=this;b.handleChange&&b._view.addEventListener("change",function(a){b.handleChange(a)},!1),Ob.isTouchable?Ob.isMSTouchable?new Gb.controls.ListBaseMSTouchInteraction(this):(new Gb.controls.ListBaseTouchInteraction(this),new Gb.controls.ListBaseInteraction(this)):new Gb.controls.ListBaseInteraction(this)},Hb.ext("twaver.controls.ListBase",Gb.controls.View,{__bool:["innerText"],_innerText:Dd.LISTBASE_INNER_TEXT,getDataDiv:function(){return this._dataDiv},getStartRowIndex:function(){return this._startRowIndex},getEndRowIndex:function(){return this._endRowIndex},getRowDatas:function(){return this._rowDatas},getRowIndexByData:function(a){return this._dataRowMap[a.getId()]},getRowIndexById:function(a){return this._dataRowMap[a]},getRowSize:function(){return this._rowDatas.size()},getDataBox:function(){return this._box},setDataBox:function(a){if(!a)throw"DataBox can not be null";if(this._box!==a){var b=this._box;b&&(b.removeDataBoxChangeListener(this.handleDataBoxChange,this),b.removeDataPropertyChangeListener(this.handlePropertyChange,this),b.removeHierarchyChangeListener(this.handleHierarchyChange,this),this._selectionModel||b.getSelectionModel().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addDataBoxChangeListener(this.handleDataBoxChange,this),this._box.addDataPropertyChangeListener(this.handlePropertyChange,this),this._box.addHierarchyChangeListener(this.handleHierarchyChange,this),this._selectionModel?this._selectionModel._setDataBox(a):this._box.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this.invalidateModel(),this.firePropertyChange("dataBox",b,this._box)}},onPropertyChanged:function(a){"zoom"===a.property?this.invalidate():this.invalidateModel()},invalidateModel:function(){this._invalidateModel||(this._invalidateModel=!0,this._invalidateDisplay=!0,this._invalidateDatas=null,this.invalidate())},invalidateDisplay:function(){this._invalidateDisplay||(this._invalidateDisplay=!0,this._invalidateDatas=null,this.invalidate())},invalidateData:function(a){this._invalidateDisplay||(this._invalidateDatas||(this._invalidateDatas={}),this._invalidateDatas[a.getId()]=a,this.invalidate())},validateImpl:function(){var a=this._view.scrollLeft,b=this._view.scrollTop;this._invalidateModel&&(this._invalidateModel=!1,this.validateModel()),this._invalidateDisplay&&(this._invalidateDisplay=!1,this._renderMap={},Ub.release(this._dataDiv),this._dataDiv.style.height=this.getRowSize()*this._rowHeight+"px");var c;if(this._invalidateDatas){for(c in this._invalidateDatas){var d=this._renderMap[c];d&&(Ub.release(d),this._dataDiv.removeChild(d),delete this._renderMap[c])}this._invalidateDatas=null}var e=this._view.scrollTop/this._zoom,f=this._view.clientHeight/this._zoom;this._startRowIndex=Math.floor(e/this._rowHeight)-2,this._endRowIndex=Math.ceil((e+f)/this._rowHeight)+2,this._startRowIndex<0&&(this._startRowIndex=0),this._endRowIndex>this._rowDatas.size()&&(this._endRowIndex=this._rowDatas.size());for(var g=this._rowHeight-this._rowLineWidth-2+"px",h=this._rowLineWidth+"px",i=this._startRowIndex;i<this._endRowIndex;i++){var j=this._rowDatas.get(i);c=j.getId();var k=this._renderMap[c];if(!k){k=this.__divPool.get();var l=k.style;l.position="absolute",l.whiteSpace="nowrap",l.lineHeight=g,l.top=i*this._rowHeight+"px",l.borderStyle="solid",l.borderWidth="0px",l.borderBottomWidth=h,l.borderBottomColor=this._rowLineColor,l.opacity=j.getStyle?j.getStyle("whole.alpha"):1,this._dataDiv.appendChild(k),this._renderMap[c]=k;var m=this.isSelected(j);this.renderData(k,j,i,m),this.onDataRendered(k,j,i,m)}}this._dataDiv.style.width=this.calculateSumWidth()+"px","0px"===this._dataDiv.style.height&&(this._dataDiv.style.height="1px"),Hb.keys(this._renderMap).forEach(function(a){var b=this.getRowIndexById(a);if(b<this._startRowIndex||b>=this._endRowIndex){var c=this._renderMap[a];Ub.release(c),this._dataDiv.removeChild(c),delete this._renderMap[a]}},this),this._pools.forEach(function(a){a.clear()}),this._view.scrollLeft!==a&&(this._view.scrollLeft=a),this._view.scrollTop!==b&&(this._view.scrollTop=b),this.adjustRowSize(),this.onValidated()},adjustRowSize:function(){var a,b,c=this._rowHeight-this._rowLineWidth+"px",d=Math.floor((this._view.scrollLeft+this._view.clientWidth)/this._zoom)+"px";for(a in this._renderMap)b=this._renderMap[a],b.style.height=c,b.style.width=d},onValidated:function(){},onDataRendered:function(a,b,c,d){},calculateSumWidth:function(){return 0},_addCheckBox:function(a,b,c){var d=this.__checkBoxPool.get();return d.keepDefault=!0,d.type="checkbox",d.style.margin="0px 2px",d.style.verticalAlign="middle",d._checkData=b,d.checked=c,d.disabled=!1,a.appendChild(d),d},_addIcon:function(a,b,c,d){var e,f=Hb.getImageAsset(c),g=this.getInnerColor(b),h=this.getOuterColor(b),i=this.getAlarmFillColor(b);if(f&&f.getImage()){var j=f.getWidth(),k=f.getHeight();e=this.__canvasPool.get(),e.style.verticalAlign="middle",e.setAttribute("width",j),e.setAttribute("height",k);var l=e.getContext("2d");l.clearRect(0,0,j,k);var m={x:0,y:0,width:j,height:k};Mc(l,c,g,m,b,this),h&&(l.lineWidth=2,l.strokeStyle=h,l.beginPath(),l.rect(0,0,j,k),l.closePath(),l.stroke()),i&&(l.fillStyle=Vb.createRadialGradient(l,i,"white",1,k-9,8,8,.75,.25),l.beginPath(),l.arc(5,k-5,4,0,2*Math.PI,!0),l.closePath(),l.fill())}else e=this.__imagePool.get(),e.style.verticalAlign="middle",e.setAttribute("src",Hb.getImageSrc(c));e.style.margin="0px 1px 0px 1px",e._selectData=d,a.appendChild(e)},_addLine:function(a,b,c,d){{var e,f,g=this.__linePool.get(),h=Hb.getImageAsset(c),i=this.getToggleImage(b),j=this._levelMap[b.getId()],k=this._indent,l=k,m=k,n=0;this.isCheckable(b),"disabled"===this.getUncheckableStyle()}n=2,h&&(l=h.getWidth(),m=h.getHeight()),e=(j+n-1)*k+l,f=this.getRowHeight(),a.style.width=(j+n-1)*k+l+"px",a.style.height=f+m+"px";{var o=this.getLineType(),p=this.getLineColor(),q=this.getLineAlpha(),r=this.getLineThickness(),s=this.getLineDash();Hb.getImageSrc(i)}g.style.verticalAlign="top",g.style.margin="0px 0px 0px 0px",g.style.zIndex=-1,g.setAttribute("width",e),g.setAttribute("height",f);var t=g.getContext("2d");t.lineWidth=r,t.strokeStyle=p,t.globalAlpha=q,"dotted"===o&&t.setLineDash(s);var u=2*(j+n);if(d){var v=b,w=v.getParent();t.clearRect(0,0,e,f);null===w&&0!==b.getChildrenSize()&&this.isExpanded(b)&&(t.moveTo((j+n+1)*e/u,f/2+m/2),t.lineTo((j+n+1)*e/u,f),t.stroke());for(var x=2*j-1;x>=1;x-=2){if(v.getClient("isLast")){if(v=w,w=v.getParent(),(x+1)/2!=j)continue}else v=w,w=v.getParent();x==2*j-1?(t.moveTo((x+n)*e/u,0),t.lineTo((x+n)*e/u,f/2),t.stroke(),t.moveTo((x+n)*e/u,f/2),t.lineTo((x+n+1)*e/u,f/2),t.stroke(),0!==b.getChildrenSize()&&this.isExpanded(b)&&(t.moveTo((x+n+2)*e/u,f/2+m/2),t.lineTo((x+n+2)*e/u,f),t.stroke())):(t.moveTo((x+n)*e/u,0),t.lineTo((x+n)*e/u,f),t.stroke())}}else{var v=b,w=v.getParent();t.clearRect(0,0,e,f);for(var x=2*j-1;x>=1;x-=2){if(v.getClient("isLast")){if(v=w,w=v.getParent(),(x+1)/2!=j)continue}else v=w,w=v.getParent();t.moveTo((x+n)*e/u,0),t.lineTo((x+n)*e/u,f),t.stroke(),x==2*j-1&&(t.moveTo((x+n)*e/u,f/2),t.lineTo((x+n+1)*e/u,f/2),t.stroke(),0!==b.getChildrenSize()&&this.isExpanded(b)&&(t.moveTo((x+n+2)*e/u,f/2+m/2),t.lineTo((x+n+2)*e/u,f),t.stroke()))}}return a.appendChild(g),g},isVisible:function(a){return this._box.contains(a)?this._visibleFunction?this._visibleFunction(a):!0:!1},handleDataBoxChange:function(a){this.invalidateModel()},handlePropertyChange:function(a){"parent"===a.property?this.invalidateModel():this.invalidateData(a.source)},handleHierarchyChange:function(a){this.invalidateModel()},handleSelectionChange:function(a){a.datas.forEach(function(a){this.invalidateData(a)},this),this.onSelectionChanged(a)},getRowIndexAt:function(a){var b=this.getLogicalPoint(a);if(!b)return-1;var c=parseInt(b.y/this._rowHeight);return c>=0&&c<this._rowDatas.size()?c:-1},getDataAt:function(a){var b=this.getRowIndexAt(a);return b>=0?this._rowDatas.get(b):null},getCurrentSortFunction:function(){return this._sortFunction},validateModel:function(){this._rowDatas.clear(),this._dataRowMap={},this._buildChildren(this._box.getRoots()),this._rowDatas=this._rowDatas.toList(this.isVisible,this);var a=this.getCurrentSortFunction();a&&this._rowDatas.sort(a);for(var b=this._rowDatas.size(),c=0;b>c;c++)this._dataRowMap[this._rowDatas.get(c).getId()]=c},_buildChildren:function(a){a.forEach(function(a){this._rowDatas.add(a),this._buildChildren(a.getChildren())},this)},_handlePressSelection:function(a,b){var c=this.getSelectionModel();if(Hb.isCtrlDown(b))c.contains(a)?c.removeSelection(a):c.appendSelection(a);else if(b.shiftKey&&c.getLastData()){var d=c.getLastData(),e=this.getRowIndexByData(d),f=this.getRowIndexByData(a),g=new md;for(g.add(this.getRowDatas().get(e));e!==f;)e+=f>e?1:-1,g.add(this.getRowDatas().get(e));c.setSelection(g)}else 1===c.size()&&c.contains(a)||c.setSelection(a);this.fireInteractionEvent({kind:2===b.detail?"doubleClick":"click",data:a})},_handleDoubleClick:function(a){var b=this.getDataAt(a);this.fireInteractionEvent({kind:2===a.detail?"doubleClick":"click",data:b})},_handleClick:function(a){this.isFocusOnClick()&&Gb.Util.setFocus(this._view);var b=this.getDataAt(a);if(b){if(this.isCheckMode()&&!a.target._checkData){var c=this.getRowIndexByData(b);if(this._focusedRow!==c){var d=this._rowDatas.get(this._focusedRow);this._focusedRow=c,d&&this.invalidateData(d),this.invalidateData(b)}}this.isCheckMode()||this._handlePressSelection(b,a)}if(this._currentEditor&&this.commitEditValue(this._currentEditor._editInfo,this._currentEditor),this.updateCurrentEditor){var e=this;setTimeout(function(){e.updateCurrentEditor(a)},0)}},handleChange:function(a){if(!this._isCanceling&&!this._isValidating){var b=a.target._checkData;if(b){var c=this.isSelected(b),d=this.getSelectionModel();c?d.removeSelection(b):d.appendSelection(b)}a.target._editInfo&&this.commitEditValue&&this.commitEditValue(a.target._editInfo,a.target)}},scrollToData:function(a){if(a){var b=this.getRowIndexById(a.getId());if(!(0>b)){var c=b*this._rowHeight*this._zoom,d=c+this._rowHeight*this._zoom,e=this._view.scrollTop;this._view.scrollTop>c&&(e=c),this._view.scrollTop+this._view.clientHeight<d&&(e=d-this._view.clientHeight),this._view.scrollTop!=e&&(this._view.scrollTop=e,this.invalidate())}}},makeVisible:function(a){this.isVisible(a)&&(this.expand&&this.expand(a),Hb.callLater(this.scrollToData,this,[a],2*Dd.CALL_LATER_DELAY))},onSelectionChanged:function(a){this._makeVisibleOnSelected&&("append"===a.kind||"set"===a.kind||"all"===a.kind)&&(this.expand&&this.getSelectionModel().getSelection().forEach(function(a){a.getParent()&&this.expand(a.getParent())},this),Hb.callLater(this.scrollToData,this,[this.getSelectionModel().getLastData()],2*Dd.CALL_LATER_DELAY))},onShareSelectionModelChanged:function(){this.invalidateModel()}}),Gb.controls.TableBase=function(a){this._columnBox=new Gb.ColumnBox,this._columnBox.addDataBoxChangeListener(this.handleColumnBoxChange,this),this._columnBox.addDataPropertyChangeListener(this.handleColumnPropertyChange,this),this._columnBox.addHierarchyChangeListener(this.handleColumnHierarchyChange,this),Gb.controls.TableBase.superClass.constructor.apply(this,arguments),this._cellPool=new Gb.Pool("div",20),this._stringPool=new Gb.Pool("span",20),this._booleanPool=new Gb.Pool("input",20),this._colorPool=new Gb.Pool("div",20),this._pools.add(this._cellPool),this._pools.add(this._stringPool),this._pools.add(this._booleanPool),this._pools.add(this._colorPool)},Hb.ext("twaver.controls.TableBase",Gb.controls.ListBase,{getColumnBox:function(){return this._columnBox},handleColumnBoxChange:function(a){this.invalidateDisplay()},handleColumnPropertyChange:function(a){a.source!==this._sortColumn||"sortDirection"!==a.property&&"sortFunction"!==a.property&&"sortable"!==a.property?this.invalidateDisplay():this.invalidateModel()},handleColumnHierarchyChange:function(a){this.invalidateDisplay()},renderData:function(a,b,c,d){for(var e,f=this._columnBox.getRoots(),g=f.size(),h=0,i=this._rowHeight-this._rowLineWidth+"px",j=0;g>j;j++){var k=f.get(j),l=k.getWidth();0>l&&(l=0);var m=Math.min(this._columnLineWidth,l);if(k.isVisible()){var n=this._cellPool.get();e=n.style,e.position="absolute",e.whiteSpace="nowrap",e.verticalAlign="middle",e.textAlign=k.getHorizontalAlign(),e.overflow="hidden",e.textOverflow="ellipsis",e.left=h+"px",e.width=l-m+"px",e.height=i,e.borderStyle="solid",e.borderWidth="0px",e.borderRightWidth=m+"px",e.borderRightColor=this._columnLineColor,0===j?(e.borderLeftWidth=m+"px",e.borderLeftColor=this._columnLineColor):e.borderLeftWidth="0px",a.appendChild(n);var o={data:b,value:this.getValue(b,k),div:n,view:this,column:k,rowIndex:c,selected:d};this.renderCell(o),this.onCellRendered(o),h+=l}}e=a.style,e.width=h+"px",e.height=i,e.backgroundColor=this.isCheckMode()&&this._focusedRow===c||!this.isCheckMode()&&d?this.getSelectColor(b):""},adjustRowSize:function(){},onCellRendered:function(a){},calculateSumWidth:function(){for(var a=this._columnBox.getRoots(),b=a.size(),c=0,d=0;b>d;d++){var e=a.get(d),f=e.getWidth();0>f&&(f=0),c+=f}return c},getCurrentSortFunction:function(){var a=this._sortColumn;if(a){var b=a.getSortFunction();if(b){var c=this,d="asc"===a.getSortDirection()?1:-1;return function(e,f){var g=c.getValue(e,a),h=c.getValue(f,a);return b.call(c,g,h,e,f)*d}}}return this._sortFunction},renderCell:function(a){var b=a.column;if(b.renderCell)return void b.renderCell(a);var c=a.value,d=b.getEnumInfo(a.rowIndex);d&&!Array.isArray(d)&&(c=d.map[c]),a.view.isCellEditable(a.data,b)&&(a.enumInfo=d,a.div._editInfo=a),zc.render(b.getValueType(),c,a.div,a.view,b.isInnerText())},getValue:function(a,b){return b.getValue(a,this)},setValue:function(a,b,c){b.setValue(a,c,this)},getColumnAt:function(a){var b=this.getLogicalPoint(a);if(!b)return null;for(var c=this._columnBox.getRoots(),d=0,e=c.size(),f=0;e>d;d++){var g=c.get(d),h=g.getWidth();if(0>h&&(h=0),b.x>f&&b.x<f+h)return g;f+=h}return null},isCellEditable:function(a,b){return this.isEditable()&&b.isEditable()},commitEditValue:function(a,b){if(!this._isCanceling){var c;c="checkbox"===b.type?b.checked:b.value;var d=a.column,e=d.getValueType();if("int"===e&&"string"==typeof c)c=parseInt(c);else if("number"===e&&"string"==typeof c)c=parseFloat(c);else if("list.points"===e){for(var f=c.replace(/\]/g,"").replace(/\[/g,"").split(","),g=new Gb.List,h=0;h<f.length;h+=2)h+1>=f.length||g.add({x:parseInt(f[h]),y:parseInt(f[h+1])});c=g}if(this.setValue(a.data,d,c),this._currentEditor){var i=this._currentEditor.parentNode,j=this._currentEditor;delete this._currentEditor,i&&i.removeChild(j),Gb.Util.setFocus(this._view)}delete this._isCommitting}},cancelEditing:function(){if(this._currentEditor){this._isCanceling=!0;var a=this._currentEditor.parentNode,b=this._currentEditor;delete this._currentEditor,a&&a.removeChild(b),Gb.Util.setFocus(this._view),delete this._isCanceling}},renderEditor:function(a){},onEditorRendered:function(a){},getEditorValue:function(a){var b=a.column.getValueType(),c=a.value,d="";if("list.points"===b){var e=c._as?c._as:c;e.forEach(function(a,b){d+=b==e.length-1?"["+a.x+","+a.y+"]":"["+a.x+","+a.y+"],"})}else d=c;return d},updateCurrentEditor:function(a){var b=a.target;if(b!==this._currentEditor&&b.parentNode!==this._currentEditor){for(var c;b&&b!==this._view&&!(c=b._editInfo);)b=b.parentNode;if(c&&b===c.div){var d=this.renderEditor&&this.renderEditor(c);d?(this._currentEditor=d.view,null!=c.value&&(this._currentEditor.value=this.getEditorValue(c))):c.enumInfo?this._currentEditor=Ub.createSelect(c.enumInfo,c.value):(this._currentEditor=Mb.createElement("input"),null!=c.value&&(this._currentEditor.value=this.getEditorValue(c)));var e=this;if(c.column&&c.column.renderEditor){var d="function"==typeof c.column.renderEditor?c.column.renderEditor(e,c):c.column.renderEditor;d&&(e._currentEditor=d)}if(this._currentEditor){if(d&&d.onKeyDown){var f=d.onKeyDown;f&&Array.isArray(f)&&e._currentEditor.addEventListener("keydown",function(a){for(var b=0;b<f.length;b++)if(f[b].combKey){var c=null;switch(f[b].combKey){case"ctrlKey":c=a.ctrlKey;break;case"shiftKey":c=a.shiftKey;break;case"altKey":c=a.altKey}a.keyCode===f[b].keyCode&&c&&f[b].handlerEvent&&f[b].handlerEvent(a)}else a.keyCode===f[b].keyCode&&f[b].handlerEvent&&f[b].handlerEvent(a)})}else this._currentEditor.addEventListener("keydown",function(a){var b=a.target._editInfo.view;13===a.keyCode&&a.shiftKey||(13===a.keyCode?b.commitEditValue(a.target._editInfo,a.target):27===a.keyCode&&b.cancelEditing())},!1);if(this._currentEditor.addEventListener("blur",function(a){var b=a.target._editInfo.view;b._isCanceling||b.commitEditValue(a.target._editInfo,a.target)},!1),this._currentEditor.keepDefault=!0,this._currentEditor._editInfo=c,!this._currentEditor.parentNode){var g=this._currentEditor.style;g.position="absolute",g.margin="0px",g.border="0px",g.padding="0px",g.left=c.div.style.left,g.top=c.div.parentNode.style.top,g.width=c.div.style.width,g.height=c.div.style.height,this._rootDiv.appendChild(this._currentEditor)}Gb.Util.setFocus(this._currentEditor)}}}},onColumnSorted:function(a){},getCurrentEditor:function(){return this._currentEditor}}),Gb.controls.List=function(a){Gb.controls.List.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.controls.List",Gb.controls.ListBase,{__accessor:["rowHeight","indent","rowLineWidth","rowLineColor","sortFunction","visibleFunction"],__bool:["makeVisibleOnSelected","keyboardRemoveEnabled","keyboardSelectEnabled"],_checkMode:!1,_rowHeight:Dd.LIST_ROW_HEIGHT,_indent:Dd.LIST_INDENT,_rowLineWidth:Dd.LIST_ROW_LINE_WIDTH,_rowLineColor:Dd.LIST_ROW_LINE_COLOR,_makeVisibleOnSelected:Dd.LIST_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Dd.LIST_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Dd.LIST_KEYBOARD_SELECT_ENABLED,isCheckMode:function(){return this._checkMode},setCheckMode:function(a){delete this._focusedRow;var b=this._checkMode;this._checkMode=a,this.firePropertyChange("checkMode",b,a)},isCheckable:function(a){return this._checkMode===!0},renderData:function(a,b,c,d){var e;this._indent>0&&(e=this.__spanPool.get(),e.style.width=this._indent+"px",e.style.display="inline-block",a.appendChild(e));var f=this.isCheckable(b);f&&this._addCheckBox(a,b,d);var g=this.getIcon(b);g&&this._addIcon(a,b,g);var h=this.getLabel(b);if(h){e=this.__textPool.get();var i=e.style;i.whiteSpace="nowrap",i.verticalAlign="middle",i.padding="1px 2px 1px 2px",i.display="inline-block",Hb.setText(e,h,this._innerText),this.onLabelRendered(e,b,h,c,d),a.appendChild(e)}a.style.backgroundColor=this.isCheckMode()?this._focusedRow===c?this.getSelectColor(b):"":d?this.getSelectColor(b):""},onLabelRendered:function(a,b,c,d,e){}}),Gb.controls.ListBaseInteraction=function(a){this.listBase=a,this.view=a._view,this.clickTimer=0,this.doubleClickInterval=300;var b=this;this.view.addEventListener("scroll",function(a){b.handleScroll(a)},!1),this.view.addEventListener("mouseup",function(a){b.handleMouseUp(a)},!1),this.view.addEventListener("keydown",function(a){b.handleKeyDown(a)},!1)},Hb.ext("twaver.controls.ListBaseInteraction",Object,{handleMouseUp:function(a){var b=this.listBase,c=this;a.target!==b._currentEditor&&a.target.parentNode!==b._currentEditor&&(c.clickTimer?(clearTimeout(c.clickTimer),c.clickTimer=0,b._handleDoubleClick(a)):(b._handleClick(a),c.clickTimer=setTimeout(function(){clearTimeout(c.clickTimer),c.clickTimer=0},300)))},handleKeyDown:function(a){var b=this.listBase;if(!b._currentEditor)if(Hb.isCtrlDown(a)&&65==a.keyCode)b.isKeyboardSelectEnabled()&&b.selectAll().size()>0&&b.fireInteractionEvent({kind:"selectAll"}),Ub.preventDefault(a);else if(46==a.keyCode)b.isKeyboardRemoveEnabled()&&b.removeSelection()&&b.fireInteractionEvent({kind:"removeElement"}),Ub.preventDefault(a);else if(b.isCheckMode()||38!==a.keyCode&&40!==a.keyCode&&37!==a.keyCode&&39!==a.keyCode)Hb.showVersion(a);else{var c=b.getSelectionModel().getLastData();if(c)if(38===a.keyCode||40===a.keyCode){var d=b.getRowDatas(),e=b.getRowIndexByData(c);e>=0&&(38===a.keyCode?0!==e&&(c=d.get(e-1),b.getSelectionModel().setSelection(c)):e!==d.size()-1&&(c=d.get(e+1),b.getSelectionModel().setSelection(c)))}else!b.expand||37!==a.keyCode&&39!==a.keyCode||c.hasChildren()&&(37===a.keyCode?b.collapse(c):b.expand(c));else b.getRowDatas().size()>0&&(c=b.getRowDatas().get(0),b.getSelectionModel().setSelection(c))}},handleScroll:function(a){this.listBase.invalidate()}}),Gb.controls.ListBaseTouchInteraction=function(a){this.listBase=a,this.view=a._view,Ub.addEventListener("touchstart","handleTouchstart",this.view,this)},Hb.ext("twaver.controls.ListBaseTouchInteraction",Object,{handleTouchstart:function(a){Ub.preventDefault(a),this.startPoint=this.lastPoint=this.listBase.getLogicalPoint(a),Ub.addEventListener("touchmove","handleTouchmove",this.view,this),Ub.addEventListener("touchend","handleTouchend",this.view,this),yc.isMultiTouch(a)&&(this.distance=yc.getDistance(a),this.zoom=this.listBase._zoom)},handleTouchmove:function(a){Ub.preventDefault(a);var b=this.listBase.getLogicalPoint(a);if(!(Rb.getDistance(this.startPoint,b)<20))if(this.moved||(this.moved=!0),yc.isSingleTouch(a)){if(this.lastPoint){var c=this.lastPoint.x-b.x,d=this.lastPoint.y-b.y,e=this.listBase.panByOffset(c,d);this.listBase.invalidate(),this.lastPoint.x-=c-e.x,this.lastPoint.y-=d-e.y}}else if(this.distance){var f=yc.getDistance(a)/this.distance;this.listBase.setZoom(this.zoom*f,!1)}},handleTouchend:function(a){Ub.preventDefault(a),this.moved||a.target===this.listBase._currentEditor||a.target.parentNode===this.listBase._currentEditor||this.listBase._handleClick(a),delete this.startPoint,delete this.lastPoint,delete this.moved,delete this.distance,delete this.zoom,Ub.removeEventListener("touchmove",this.view,this),Ub.removeEventListener("touchend",this.view,this)}}),Gb.controls.ListBaseMSTouchInteraction=function(a){Gb.controls.ListBaseMSTouchInteraction.superClass.constructor.apply(this,arguments),this._pointerMap={},this._pointerIdArray=[],Ub.addEventListener("MSPointerDown","handleTouchstart",this.view,this),Ub.addEventListener("MSPointerMove","handleTouchmove",this.view,this),Ub.addEventListener("MSPointerUp","handleTouchend",this.view,this),Ub.addEventListener("MSPointerCancel","handleTouchend",this.view,this),this.superHandleMouseDown=Gb.controls.ListBaseMSTouchInteraction.superClass.handleMouseDown},Hb.ext("twaver.controls.ListBaseMSTouchInteraction",Gb.controls.ListBaseInteraction,{handleMouseDown:function(a){},handleTouchstart:function(a){a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),this._pointerMap[a.pointerId]||null==this.listBase.getLogicalPoint(a)||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length&&a.pointerType==a.MSPOINTER_TYPE_MOUSE&&this.superHandleMouseDown(a),1==this._pointerIdArray.length?(this._startTouchPoint=this.listBase.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.listBase.getZoom())},handleTouchmove:function(a){if(null!=this._startTouchPoint&&0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Rb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.listBase.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&a.pointerType!=a.MSPOINTER_TYPE_MOUSE&&this._startTouchPoint){var c=this.listBase.getLogicalPoint(a);if(null==c)return;var d=this._startTouchPoint.x-c.x,e=this._startTouchPoint.y-c.y,f=this.listBase.panByOffset(d,e);this.listBase.invalidate(),this._startTouchPoint.x-=d-f.x,this._startTouchPoint.y-=e-f.y}},handleTouchend:function(a){if(this._startTouchPoint&&1==this._pointerIdArray.length&&a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.listBase.getLogicalPoint(a);if(b){var c=new Date;c.getTime()-this._startTouchTime.getTime()<=500&&Rb.getDistance(this._startTouchPoint,b)<=20&&this.superHandleMouseDown(a)}}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Rb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Gb.controls.Tree=function(a){this._interactionDispatcher=new Gb.EventDispatcher,this._initTree(a),Gb.controls.Tree.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.controls.Tree",Gb.controls.ListBase,{__tree:1,__accessor:["rootData","sortFunction","visibleFunction","indent","rowHeight","rowLineWidth","rowLineColor","expandIcon","collapseIcon","uncheckableStyle","lineType","lineColor","lineThickness","lineAlpha","lineDash"],__bool:["rootVisible","makeVisibleOnSelected","keyboardRemoveEnabled","keyboardSelectEnabled"],_checkMode:!1,_indent:Dd.TREE_INDENT,_rowHeight:Dd.TREE_ROW_HEIGHT,_rowLineWidth:Dd.TREE_ROW_LINE_WIDTH,_rowLineColor:Dd.TREE_ROW_LINE_COLOR,_makeVisibleOnSelected:Dd.TREE_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Dd.TREE_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Dd.TREE_KEYBOARD_SELECT_ENABLED,_expandIcon:Dd.TREE_EXPAND_ICON,_collapseIcon:Dd.TREE_COLLAPSE_ICON,_uncheckableStyle:"none",_lineType:Dd.TREE_LINE_TYPE,_lineColor:Dd.TREE_LINE_COLOR,_lineThickness:Dd.TREE_LINE_THICKNESS,_lineAlpha:Dd.TREE_LINE_ALPHA,_lineDash:Dd.TREE_LINE_DASH,getCheckMode:function(){return this._checkMode},setCheckMode:function(a){delete this._focusedRow;var b=this._checkMode;this._checkMode=a,this.firePropertyChange("checkMode",b,a)},renderData:function(a,b,c,d){this._renderTree(a,b,c,d)},getToolTip:function(a){return a.getToolTip()||a.getName()}}),Gb.controls.Table=function(a){this._checkColumn=new Gb.Column,this._checkColumn.setName("check"),this._checkColumn.setEditable(!0),this._checkColumn.setWidth(40),this._checkColumn.setHorizontalAlign("center"),this._checkColumn.renderCell=this.renderCheckCell;var b=this;this._checkColumn.getValue=function(a,c){return b.isSelected(a)},Gb.controls.Table.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.controls.Table",Gb.controls.TableBase,{__accessor:["rowHeight","rowLineWidth","rowLineColor","columnLineWidth","columnLineColor","sortFunction","visibleFunction","sortColumn"],__bool:["editable","makeVisibleOnSelected","keyboardRemoveEnabled","keyboardSelectEnabled"],_editable:Dd.TABLE_EDITABLE,_rowHeight:Dd.TABLE_ROW_HEIGHT,_rowLineWidth:Dd.TABLE_ROW_LINE_WIDTH,_rowLineColor:Dd.TABLE_ROW_LINE_COLOR,_columnLineWidth:Dd.TABLE_COLUMN_LINE_WIDTH,_columnLineColor:Dd.TABLE_COLUMN_LINE_COLOR,_makeVisibleOnSelected:Dd.TABLE_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Dd.TABLE_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Dd.TABLE_KEYBOARD_SELECT_ENABLED,getCheckColumn:function(){return this._checkColumn},isCheckMode:function(){return this._columnBox.contains(this._checkColumn)},setCheckMode:function(a){a!==this.isCheckMode()&&(delete this._focusedRow,a?this._columnBox.add(this._checkColumn,0):this._columnBox.remove(this._checkColumn),this.firePropertyChange("checkMode",!a,a))},renderCheckCell:function(a){var b=a.view._booleanPool.get();b.disabled=!1,b.type="checkbox",b.style.margin="0px 2px",b.style.verticalAlign="middle",b.checked=a.selected;var c=a.div;c.appendChild(b),""===c.style.textAlign&&(c.style.textAlign="center"),b._checkData=a.data}}),Gb.controls.TableHeader=function(a){Gb.controls.TableHeader.superClass.constructor.apply(this,arguments),this._invalidateScroll=!1,this._invalidateDisplay=!1,this._divPool=new Gb.Pool("div"),this._imagePool=new Gb.Pool("img"),this._textPool=new Gb.Pool("span"),this._resizePool=new Gb.Pool("div"),this._pools.add(this._divPool),this._pools.add(this._imagePool),this._pools.add(this._textPool),this._pools.add(this._resizePool),this._table=a,this._tableView=a.getView(),this._columnBox=a.getColumnBox(),this._columnBox.addDataBoxChangeListener(this.handleColumnBoxChange,this),this._columnBox.addDataPropertyChangeListener(this.handleColumnPropertyChange,this),this._columnBox.addHierarchyChangeListener(this.handleColumnHierarchyChange,this);var b=this;a.getView().addEventListener("scroll",function(a){b.invalidateScroll()},!1),a.addPropertyChangeListener(function(a){b.invalidateDisplay()},this),this._view=Ub.createView("hidden"),this._view.tabIndex=-1,this._view.style.background=Dd.TABLEHEADER_BACKGROUND,this._rootDiv=Ub.createDiv(),this._view.appendChild(this._rootDiv),
this.invalidateDisplay(),Ob.isTouchable&&new Gb.controls.TableHeaderTouchInteraction(this),new Gb.controls.TableHeaderInteraction(this)},Hb.ext("twaver.controls.TableHeader",Gb.controls.ControlBase,{__accessor:["height","moveBackground","insertBackground","columnLineColor","resizeTolerance","sortDescIcon","sortAscIcon","sortIconPosition"],_height:Dd.TABLEHEADER_HEIGHT,_moveBackground:Dd.TABLEHEADER_MOVE_BACKGROUND,_insertBackground:Dd.TABLEHEADER_INSERT_BACKGROUND,_columnLineColor:Dd.TABLEHEADER_COLUMN_LINE_COLOR,_resizeTolerance:Dd.TABLEHEADER_RESIZE_TOLERANCE,_sortDescIcon:Dd.TABLEHEADER_SORT_DESC_ICON,_sortAscIcon:Dd.TABLEHEADER_SORT_ASC_ICON,_sortIconPosition:Dd.TABLEHEADER_SORT_ICON_POSITION,getRootDiv:function(){return this._rootDiv},handleColumnBoxChange:function(a){this.invalidateDisplay()},handleColumnPropertyChange:function(a){this.invalidateDisplay()},handleColumnHierarchyChange:function(a){this.invalidateDisplay()},onPropertyChanged:function(a){this.invalidateDisplay()},invalidateScroll:function(){this._invalidateScroll||(this._invalidateScroll=!0,this.invalidate())},invalidateDisplay:function(){this._invalidateDisplay||(this._invalidateDisplay=!0,this._invalidateScroll=!0,this.invalidate())},validate:function(){this._invalidate&&(this._invalidate=!1,this._invalidateDisplay&&(this._invalidateDisplay=!1,this.validateDisplay()),this._invalidateScroll&&(this._invalidateScroll=!1,this._rootDiv.style.left=-this._tableView.scrollLeft+"px"))},validateDisplay:function(){Ub.release(this._rootDiv);for(var a=this._table.getZoom(),b=this.getHeight()+"px",c=this.getHeight()-2+"px",d=this._table.getColumnBox().getRoots(),e=d.size(),f=0,g=this._table._columnLineWidth*a,h=0;e>h;h++){var i=d.get(h);if(i.isVisible()){var j=i.getWidth()*a;0>j&&(j=0);var k=Math.min(g,j),l=this._divPool.get();l._column=i;var m=l.style;m.position="absolute",m.whiteSpace="nowrap",m.lineHeight=c,m.overflow="hidden",m.textOverflow="ellipsis",m.backgroundPosition=this._sortIconPosition?this._sortIconPosition:"",m.backgroundRepeat="no-repeat",m.backgroundImage="",m.textAlign=i.getHorizontalAlign(),m.borderStyle="solid",m.borderWidth="0px",m.borderRightWidth=k+"px",m.borderRightColor=this._columnLineColor,0===h?(m.borderLeftWidth=k+"px",m.borderLeftColor=this._columnLineColor):m.borderLeftWidth="0px",m.left=f+"px",m.width=j-k+"px",m.height=b,l._x=f,l._width=j-k,this._rootDiv.insertBefore(l,this._rootDiv.firstChild),this.renderColumn(l,i),this.onColumnRendered(l,i),f+=j,i.isResizable()&&(l=this._resizePool.get(),l._resizeColumn=i,m=l.style,m.position="absolute",m.backgroundColor="white",m.opacity=0,m.left=f-k-this._resizeTolerance+"px",m.width=k+2*this._resizeTolerance+"px",m.height=b,this._rootDiv.appendChild(l))}}this._pools.forEach(function(a){a.clear()}),this._rootDiv.style.width=f+"px",this._rootDiv.style.height=b},renderColumn:function(a,b){if(b.renderHeader)b.renderHeader(a);else{var c=this._textPool.get();if(c.style.whiteSpace="nowrap",c.style.verticalAlign="middle",c.style.padding="1px 2px 1px 2px",c.innerHTML=b.getName()?b.getName():b.getPropertyName(),c.setAttribute("title",c.innerHTML),a.appendChild(c),Ob.isOpera){var d=a.cloneNode(!1);d.style.left="0px",d.style.top="0px",d.style.opacity=0,a.appendChild(d)}}if(this._table.getSortColumn()===b&&b.isSortable()){var e="asc"===b.getSortDirection()?this._sortAscIcon:this._sortDescIcon,f=Hb.getImageSrc(e);if(this._sortIconPosition&&""!==this._sortIconPosition)a.style.backgroundImage="url("+f+")";else{var g=this._imagePool.get();g.setAttribute("src",f),g.style.verticalAlign="middle",a.appendChild(g)}}},onColumnRendered:function(a,b){}}),Gb.controls.TableHeaderInteraction=function(a){this.header=a,this.table=a._table,this.view=a._view;var b=this;this.view.addEventListener("mousedown",function(a){b.handleMouseDown(a)},!1),this.view.addEventListener("mousemove",function(a){b.handleMouseMove(a)},!1)},Hb.ext("twaver.controls.TableHeaderInteraction",Object,{handleMouseDown:function(a){if(0===a.button){if(this.movableDiv)return void this.handleMouseUp(a);this.resizeColumn=a.target._resizeColumn,this.resizeColumn||(this.movableDiv=this.getMovableDivAt(a)),this.changeCursor(a),this._startClient=Ub.getClientPoint(a),this.lastX=this.getX(a),this._startLogicalX=this.lastX,Ub.handle_mousedown(this,a)}},changeCursor:function(a){var b="";if(a.target._resizeColumn)b="ew-resize";else{var c=this.getColumnAt(a);c&&(c.isMovable()||c.isSortable())&&(b="pointer")}this.view.style.cursor=b},handleMouseMove:function(a){if(null==this.lastX)return void this.changeCursor(a);if(Ub.target===this){var b=this._startLogicalX+a.clientX-this._startClient.x;if(this.resizeColumn){if(null!=this.stopX){if(b<this.stopX)return;delete this.stopX}var c=this.resizeColumn.getWidth()+(b-this.lastX)/this.table.getZoom();10>c&&(c=10,this.stopX=b),this.resizeColumn.setWidth(c),this.lastX=b}else if(this.movableDiv){var d=b-this.lastX;if(!this.cloneDiv){if(Math.abs(d)<3)return;this.cloneDiv=this.movableDiv.cloneNode(!0),this.cloneDiv._x=this.movableDiv._x,this.cloneDiv.style.background=this.header.getMoveBackground(),this.insertDiv=Ub.createDiv(),this.insertDiv.style.width="1px",this.insertDiv.style.height=this.cloneDiv.style.height,this.insertDiv.style.background=this.header.getInsertBackground(),this.movableDiv.parentNode.appendChild(this.cloneDiv),this.movableDiv.parentNode.appendChild(this.insertDiv)}var e=this.cloneDiv._x+d;this.cloneDiv.style.left=e+"px",this.cloneDiv._x=e,this.lastX=b,this.columnInfo=this.getColumnInfoAt(a),this.columnInfo&&(this.insertDiv.style.left=this.columnInfo.position)}}},handleMouseUp:function(a){if(0===a.button){var b;if(this.resizeColumn);else if(this.movableDiv&&this.columnInfo){b=this.movableDiv._column;var c=this.columnInfo.index;this.table.getColumnBox().moveTo(b,c)}else if(b=this.getColumnAt(a),b&&b.isSortable()){var d=b.getSortDirection();this.table.getSortColumn()===b?("desc"===d&&this.table.setSortColumn(null),b.setSortDirection("asc"===d?"desc":"asc")):this.table.setSortColumn(b),this.table.onColumnSorted(this.table.getSortColumn())}this.clear()}},clear:function(){this.view.style.cursor="",this.cloneDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.cloneDiv),this.insertDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.insertDiv),delete this.movableDiv,delete this.columnInfo,delete this.insertDiv,delete this.cloneDiv,delete this.resizeColumn,delete this.stopX,delete this.lastX,delete this._startClient,delete this._startLogicalX},getColumnAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._column);)a=a.parentNode;return b},getMovableDivAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._column);)a=a.parentNode;return b&&b.isMovable()?a:null},getX:function(a){var b=Ub.getLogicalPoint(this.view,a);return b?b.x:null},getColumnInfoAt:function(a){for(var b=this._startLogicalX+a.clientX-this._startClient.x+this.table.getView().scrollLeft,c=this.table.getColumnBox().getRoots(),d=c.size(),e=this.table.getZoom(),f=0,g=!1,h=0;d>h;h++){var i=c.get(h);if(i===this.movableDiv._column&&(g=!0),i.isVisible()){var j=i.getWidth()*e;if(0>=j)continue;if(b>=f&&f+j>=b){var k=f+j/2>b;!g||i===this.movableDiv._column&&k||h--;var l=k?Math.max(0,h):Math.min(h+1,d),m=k?f:f+j;return m=Math.max(0,m-1),{index:l,column:i,position:m+"px"}}f+=j}}return this.columnInfo}}),Gb.controls.TableHeaderTouchInteraction=function(a){this.header=a,this.table=a._table,this.view=a._view,Ub.addEventListener("touchstart","handleTouchstart",this.view,this)},Hb.ext("twaver.controls.TableHeaderTouchInteraction",Object,{handleTouchstart:function(a){return Ub.preventDefault(a),this.movableDiv?void this.handleTouchend(a):(this.resizeColumn=a.target._resizeColumn,this.resizeColumn||(this.movableDiv=this.getMovableDivAt(a)),this.lastX=this.getX(a),Ub.addEventListener("touchmove","handleTouchmove",this.view,this),void Ub.addEventListener("touchend","handleTouchend",this.view,this))},handleTouchmove:function(a){if(Ub.preventDefault(a),null!=this.lastX){var b;if(this.resizeColumn){if(b=this.getX(a),null!=this.stopX){if(b<this.stopX)return;delete this.stopX}var c=this.resizeColumn.getWidth()+(b-this.lastX)/this.table.getZoom();0>c&&(c=0,this.stopX=b),this.resizeColumn.setWidth(c),this.lastX=b}else if(this.movableDiv){b=this.getX(a);var d=b-this.lastX;if(!this.cloneDiv){if(Math.abs(d)<3)return;this.cloneDiv=this.movableDiv.cloneNode(!0),this.cloneDiv._x=this.movableDiv._x,this.cloneDiv.style.background=this.header.getMoveBackground(),this.insertDiv=Ub.createDiv(),this.insertDiv.style.width="1px",this.insertDiv.style.height=this.cloneDiv.style.height,this.insertDiv.style.background=this.header.getInsertBackground(),this.movableDiv.parentNode.appendChild(this.cloneDiv),this.movableDiv.parentNode.appendChild(this.insertDiv)}var e=this.cloneDiv._x+d;this.cloneDiv.style.left=e+"px",this.cloneDiv._x=e,this.lastX=b,this.columnInfo=this.getColumnInfoAt(a),this.columnInfo&&(this.insertDiv.style.left=this.columnInfo.position)}}},handleTouchend:function(a){Ub.preventDefault(a);var b;if(this.resizeColumn);else if(this.movableDiv&&this.columnInfo){b=this.movableDiv._column;var c=this.columnInfo.index;this.table.getColumnBox().moveTo(b,c)}else if(b=this.getColumnAt(a),b&&b.isSortable()){var d=b.getSortDirection();this.table.getSortColumn()===b?("desc"===d&&this.table.setSortColumn(null),b.setSortDirection("asc"===d?"desc":"asc")):this.table.setSortColumn(b)}this.clear(),Ub.removeEventListener("touchmove",this.view,this),Ub.removeEventListener("touchend",this.view,this)},clear:function(){this.cloneDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.cloneDiv),this.insertDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.insertDiv),delete this.movableDiv,delete this.columnInfo,delete this.insertDiv,delete this.cloneDiv,delete this.resizeColumn,delete this.stopX,delete this.lastX},getColumnAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._column);)a=a.parentNode;return b},getMovableDivAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._column);)a=a.parentNode;return b&&b.isMovable()?a:null},getX:function(a){var b=Ub.getLogicalPoint(this.view,a);return b?b.x:null},getColumnInfoAt:function(a){for(var b=this.getX(a)+this.table.getView().scrollLeft,c=this.table.getColumnBox().getRoots(),d=c.size(),e=this.table.getZoom(),f=0,g=!1,h=0;d>h;h++){var i=c.get(h);if(i===this.movableDiv._column&&(g=!0),i.isVisible()){var j=i.getWidth()*e;if(0>=j)continue;if(b>=f&&f+j>=b){var k=f+j/2>b;!g||i===this.movableDiv._column&&k||h--;var l=k?Math.max(0,h):Math.min(h+1,d),m=k?f:f+j;return m=Math.max(0,m-1),{index:l,column:i,position:m+"px"}}f+=j}}return this.columnInfo}}),Gb.controls.TablePane=function(a,b){Gb.controls.TablePane.superClass.constructor.apply(this,arguments),this.invalidate(),this._table=a,this._tableHeader=b?b:new Gb.controls.TableHeader(a),this._view=Ub.createView("hidden",!0),this._view.tabIndex=-1,this._view.appendChild(this._tableHeader.getView()),this._view.appendChild(this._table.getView());var c=this;this._tableHeader.addPropertyChangeListener(function(a){"height"===a.property&&c.invalidate()})},Hb.ext("twaver.controls.TablePane",Gb.controls.ControlBase,{onPropertyChanged:function(a){this.invalidate()},getTable:function(){return this._table},getTableHeader:function(){return this._tableHeader},validateImpl:function(){var a=this._view.offsetWidth,b=this._view.offsetHeight,c=this._tableHeader.getHeight();this._tableHeader.adjustBounds({x:0,y:0,width:a,height:c}),this._table.adjustBounds({x:0,y:c,width:a,height:Math.max(0,b-c)})}}),Gb.controls.TreeTable=function(a){this._treeColumn=new Gb.Column,this._treeColumn.setName("tree"),this._treeColumn.setWidth(120),this._treeColumn.renderCell=this.renderTreeCell,this._treeColumn.getValue=this.getTreeValue,this._treeColumn.setValue=this.setTreeValue,this._initTree(a),Gb.controls.TreeTable.superClass.constructor.apply(this,arguments),this._columnBox.add(this._treeColumn)},Hb.ext("twaver.controls.TreeTable",Gb.controls.TableBase,{__tree:1,__accessor:["sortFunction","visibleFunction","checkMode","rootData","sortColumn","indent","rowHeight","rowLineWidth","rowLineColor","columnLineWidth","columnLineColor","expandIcon","collapseIcon","uncheckableStyle","lineType","lineColor","lineThickness","lineAlpha","lineDash"],__bool:["editable","rootVisible","makeVisibleOnSelected","keyboardRemoveEnabled","keyboardSelectEnabled"],_editable:Dd.TREETABLE_EDITABLE,_indent:Dd.TREETABLE_INDENT,_rowHeight:Dd.TREETABLE_ROW_HEIGHT,_rowLineWidth:Dd.TREETABLE_ROW_LINE_WIDTH,_rowLineColor:Dd.TREETABLE_ROW_LINE_COLOR,_columnLineWidth:Dd.TREETABLE_COLUMN_LINE_WIDTH,_columnLineColor:Dd.TREETABLE_COLUMN_LINE_COLOR,_makeVisibleOnSelected:Dd.TREETABLE_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Dd.TREETABLE_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Dd.TREETABLE_KEYBOARD_SELECT_ENABLED,_expandIcon:Dd.TREETABLE_EXPAND_ICON,_collapseIcon:Dd.TREETABLE_COLLAPSE_ICON,_lineType:Dd.TREE_LINE_TYPE,_lineColor:Dd.TREE_LINE_COLOR,_lineThickness:Dd.TREE_LINE_THICKNESS,_lineAlpha:Dd.TREE_LINE_ALPHA,_lineDash:Dd.TREE_LINE_DASH,getTreeColumn:function(){return this._treeColumn},renderTreeCell:function(a){a.view._renderTree(a.div,a.data,a.rowIndex,a.selected)},getTreeValue:function(a,b){return b.getLabel(a)},setTreeValue:function(a,b,c){a.setName(b)}}),Gb.controls.PropertySheet=function(a){Gb.controls.PropertySheet.superClass.constructor.apply(this,arguments),this._currentRowIndex=-1,this._currentEditor=null,this._currentData=null,this._invalidate=!1,this._resizeDiv=Ub.createDiv(),this._resizeDiv.style.backgroundColor="white",this._resizeDiv.style.opacity=0,this._resizeDiv.style.top="0px",this._categoryList=new md,this._categoryMap={},this._rowList=new md,this._propertyBox=new Gb.PropertyBox,this._propertyBox.addDataBoxChangeListener(this.invalidatePropertyBox,this),this._propertyBox.addDataPropertyChangeListener(this.invalidatePropertyBox,this),this._propertyBox.addHierarchyChangeListener(this.invalidatePropertyBox,this),this.__divPool=new Gb.Pool("div",2),this.__cellPool=new Gb.Pool("div",2),this.__imagePool=new Gb.Pool("img",2),this.__textPool=new Gb.Pool("span",2),this._stringPool=new Gb.Pool("span",2),this._booleanPool=new Gb.Pool("input",2),this._colorPool=new Gb.Pool("div",2),this._pools.add(this.__divPool),this._pools.add(this.__cellPool),this._pools.add(this.__imagePool),this._pools.add(this.__textPool),this._pools.add(this._stringPool),this._pools.add(this._booleanPool),this._pools.add(this._colorPool),this._view=Ub.createView("auto"),this._rootDiv=Ub.createDiv(),this._dataDiv=Ub.createDiv(),this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._dataDiv),this.setDataBox(a?a:new Gb.DataBox);var b=this;this._view.addEventListener("change",function(a){b.handleChange(a)},!1),Ob.isTouchable?Ob.isMSTouchable?new Gb.controls.PropertySheetMSTouchInteraction(this):(new Gb.controls.PropertySheetTouchInteraction(this),new Gb.controls.PropertySheetInteraction(this)):new Gb.controls.PropertySheetInteraction(this)},Hb.ext("twaver.controls.PropertySheet",Gb.controls.View,{__accessor:["indent","rowHeight","sumWidth","propertyNameWidth","propertyNameHorizontalAlign","autoAdjustable","rowLineWidth","columnLineWidth","borderColor","categorizable","resizeTolerance","editable","selectColor","expandIcon","collapseIcon","sortFunction","visibleFunction"],_autoAdjustable:Dd.PROPERTYSHEET_AUTO_ADJUSTABLE,_selectColor:Dd.SELECT_COLOR,_categorizable:Dd.PROPERTYSHEET_CATEGORIZABLE,_editable:Dd.PROPERTYSHEET_EDITABLE,_propertyNameWidth:Dd.PROPERTYSHEET_PROPERTY_NAME_WIDTH,_propertyNameHorizontalAlign:Dd.PROPERTYSHEET_PROPERTY_NAME_HORIZONTAL_ALIGN,_sumWidth:Dd.PROPERTYSHEET_SUM_WIDTH,_indent:Dd.PROPERTYSHEET_INDENT,_rowHeight:Dd.PROPERTYSHEET_ROW_HEIGHT,_rowLineWidth:Dd.PROPERTYSHEET_ROW_LINE_WIDTH,_columnLineWidth:Dd.PROPERTYSHEET_COLUMN_LINE_WIDTH,_borderColor:Dd.PROPERTYSHEET_BORDER_COLOR,_expandIcon:Dd.PROPERTYSHEET_EXPAND_ICON,_collapseIcon:Dd.PROPERTYSHEET_COLLAPSE_ICON,_resizeTolerance:Dd.PROPERTYSHEET_RESIZE_TOLERANCE,getPropertyBox:function(){return this._propertyBox},getCurrentData:function(){return this._currentData},getDataDiv:function(){return this._dataDiv},getDataBox:function(){return this._box},setDataBox:function(a){if(!a)throw"DataBox can not be null";if(this._box!==a){var b=this._box;b&&(b.removeDataPropertyChangeListener(this.handlePropertyChange,this),this._selectionModel||b.getSelectionModel().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addDataPropertyChangeListener(this.handlePropertyChange,this),this._selectionModel?this._selectionModel._setDataBox(a):this._box.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this.invalidate(),this.firePropertyChange("dataBox",b,this._box)}},invalidatePropertyBox:function(){this._isValidating||this.invalidate()},onPropertyChanged:function(a){"zoom"!==a.property&&this.invalidate()},isVisible:function(a){return a.isVisible&&!a.isVisible(this._currentData,this)?!1:this._visibleFunction?this._visibleFunction(a):!0},handlePropertyChange:function(a){this._currentData===a.source&&this.invalidate()},handleSelectionChange:function(a){this._currentData!==this.getSelectionModel().getLastData()&&(this._currentRowIndex=-1,this.invalidate())},isExpanded:function(a){if(!a)return!0;var b=this._categoryMap[a];return b?b.isExpanded:Dd.PROPERTYSHEET_EXPAND_CATEGORY},expand:function(a){if(a){var b=this._categoryMap[a];b&&!b.isExpanded&&(b.isExpanded=!0,this.invalidate())}},expandAll:function(){for(var a in this._categoryMap){var b=this._categoryMap[a];b&&(b.isExpanded=!0)}this.invalidate()},collapse:function(a){if(a){var b=this._categoryMap[a];b&&b.isExpanded&&(b.isExpanded=!1,this.invalidate())}},collapseAll:function(){for(var a in this._categoryMap){var b=this._categoryMap[a];b&&(b.isExpanded=!1)}this.invalidate()},getCategoryName:function(a){if(!this.isCategorizable())return"null";var b=a.getCategoryName();return b?b:"null"},validateModel:function(){this._rowList.clear(),this._categoryList.clear();var a,b,c,d,e,f={},g=new md,h=this._currentData?this._propertyBox.getRoots():new md;for(d=h.size(),a=0;d>a;a++)e=h.get(a),this.isVisible(e)&&(g.add(e),c=this.getCategoryName(e),f[c]||(this._categoryList.add(c),f[c]={isExpanded:this.isExpanded(c),properties:new md}));for(this._sortFunction&&g.sort(this._sortFunction),this._categoryMap=f,d=g.size(),a=0;a<this._categoryList.size();a++){c=this._categoryList.get(a),"null"!==c&&this._rowList.add(c);var i=f[c];if(i.isExpanded)for(b=0;d>b;b++)e=g.get(b),this.getCategoryName(e)===c&&(i.properties.add(e),this._rowList.add({view:this,data:this._currentData,property:e,value:this._currentData?this.getValue(this._currentData,e):null}))}},adjustWidth:function(){var a=this._view.offsetWidth,b=this._view.offsetHeight;a<=this._indent||0>=b||(a-=this._indent,this._rowList.size()*this._rowHeight>b&&(a-=Dd.SCROLL_BAR_WIDTH,0>=a)||(this._propertyNameWidth=0===this._sumWidth||this._propertyNameWidth>this._sumWidth?a/2:a*(this._propertyNameWidth/this._sumWidth),this._sumWidth=a,this._view.style.overflowX="hidden",this._view.style.overflowY="auto"))},validateDisplay:function(){var a=this._rowList.size(),b=this._borderColor,c=this._indent,d=this._rowHeight,e=this._propertyNameWidth,f=Math.max(0,this._sumWidth-e),g=this._rowLineWidth,h=this._columnLineWidth,i=d-g+"px",j=d-g-2+"px",k=c+"px",l=e-h+"px",m=f-h+"px",n=e+f+"px",o=g+"px",p=h+"px",q=e+"px",r=this._dataDiv,s=r.style;s.height=a*d+"px",s.width=c+e+f+"px";var t=this.__divPool.get();s=t.style,s.position="absolute",s.left="0px",s.top="0px",s.width=k,s.height=r.style.height,s.borderWidth="0px",s.backgroundColor=b,r.appendChild(t);for(var u=0;a>u;u++){var v=this._rowList.get(u),w=u*d+"px",x=this.__divPool.get();if(v.rowDiv=x,s=x.style,s.position="absolute",s.whiteSpace="nowrap",s.overflow="hidden",s.textOverflow="ellipsis",s.left=k,s.top=w,s.width=n,s.height=i,s.lineHeight=j,s.borderStyle="solid",s.borderWidth="0px",s.borderBottomWidth=o,s.borderBottomColor=b,r.appendChild(x),"string"==typeof v){s.backgroundColor=b,t=this.__divPool.get(),s=t.style,s.position="absolute",s.left="0px",s.top=w,s.width=k,s.height=i,s.lineHeight=j,s.borderWidth="0px",r.appendChild(t);var y=this.__imagePool.get(),z=this.isExpanded(v)?this._expandIcon:this._collapseIcon;y.setAttribute("src",Hb.getImageSrc(z)),s=y.style,s.verticalAlign="middle",y._expandData=v,t.appendChild(y),this.renderCategory(x,v),this.onCategoryRendered(x,v)}else{var A=v.property,B=this.__cellPool.get();v.nameRender=B,s=B.style,this._currentRowIndex===u&&(s.backgroundColor=this.getSelectColor()),s.position="absolute",s.verticalAlign="middle",s.textAlign=this._propertyNameHorizontalAlign,s.overflow="hidden",s.textOverflow="ellipsis",s.whiteSpace="nowrap",s.left="0px",s.top="0px",s.width=l,s.height=i,s.borderStyle="solid",s.borderWidth="0px",s.borderRightWidth=p,s.borderRightColor=b,x.appendChild(B),this.renderName(v),this.onNameRendered(v),B=this.__cellPool.get(),v.valueRender=B,s=B.style,s.position="absolute",s.verticalAlign="middle",s.textAlign=A.getHorizontalAlign(),s.whiteSpace="nowrap",s.overflow="hidden",s.textOverflow="ellipsis",s.left=q,s.top="0px",s.width=m,s.height=i,s.borderStyle="solid",s.borderWidth="0px",s.borderRightWidth=p,s.borderRightColor=b,x.appendChild(B),this.renderValue(v),this.onValueRendered(v)}}s=this._resizeDiv.style,s.left=c+e-h-this._resizeTolerance+"px",s.width=h+2*this._resizeTolerance+"px",s.height=r.style.height,r.appendChild(this._resizeDiv)},renderCategory:function(a,b){var c=this.__textPool.get(),d=c.style;d.fontWeight="bold",d.whiteSpace="nowrap",d.overflow="hidden",d.textOverflow="ellipsis",d.verticalAlign="middle",d.padding="1px 2px 1px 2px",c.innerHTML=b,c.setAttribute("title",b),a.appendChild(c)},onCategoryRendered:function(a,b){},renderName:function(a){if(a.property.renderName)return void a.property.renderName(a);var b=this.__textPool.get(),c=b.style;c.fontWeight="",c.whiteSpace="nowrap",c.verticalAlign="middle",c.padding="1px 2px 1px 2px";var d=a.property.getName();d||(d=a.property.getPropertyName()),b.innerHTML=d,b.setAttribute("title",d),a.nameRender.appendChild(b)},onNameRendered:function(a){},renderValue:function(a){var b=a.property;if(b.renderValue)return void b.renderValue(a);var c=a.value,d=b.getEnumInfo(this._currentData);d&&!Array.isArray(d)&&(c=d.map[c]),a.view.isCellEditable(a.data,b)&&(a.enumInfo=d,a.valueRender._editInfo=a),a.valueRender.innerHTML="",zc.render(b.getValueType(),c,a.valueRender,a.view,b.isInnerText())},onValueRendered:function(a){},renderEditor:function(a){},onEditorRendered:function(a){},updateCurrentData:function(){this._currentData=this.getSelectionModel().getLastData()},validateImpl:function(){var a=this._view.scrollLeft,b=this._view.scrollTop;Ub.release(this._dataDiv),this.updateCurrentData(),this.validateModel(),this.isAutoAdjustable()&&this.adjustWidth(),this.validateDisplay(),this._pools.forEach(function(a){a.clear()}),this._view.scrollLeft!==a&&(this._view.scrollLeft=a),this._view.scrollTop!==b&&(this._view.scrollTop=b)},getValue:function(a,b){return a?b.getValue(a,this):null},setValue:function(a,b,c){a&&b.setValue(a,c,this)},isCellEditable:function(a,b){return a?this.isEditable()&&b.isEditable():!1},getRowIndexAt:function(a){var b=this.getLogicalPoint(a);if(!b)return-1;var c=parseInt(b.y/this._rowHeight);return c>=0&&c<this._rowList.size()?c:-1},handleChange:function(a){this._isCommitting||this._isCanceling||this._isValidating||a.target._editInfo&&this.commitEditValue&&this.commitEditValue(a.target._editInfo,a.target)},commitEditValue:function(a,b){var c;c="checkbox"===b.type?b.checked:b.value;var d=a.property,e=d.getValueType();if("int"===e&&"string"==typeof c)c=parseInt(c);else if("number"===e&&"string"==typeof c)c=parseFloat(c);else if("array.string"===e)c=c.split(",");else if("array.number"===e){c=c.split(",");for(var f=0,g=c.length;g>f;f++)c[f]=parseFloat(c[f])}else if("list.points"===e){for(var h=c.replace(/\]/g,"").replace(/\[/g,"").split(","),i=new Gb.List,f=0;f<h.length;f+=2)f+1>=h.length||i.add({x:parseInt(h[f]),y:parseInt(h[f+1])});c=i}if(b._rowInfo&&(b._rowInfo.value=c,this.renderValue(b._rowInfo)),this.setValue(a.data,d,c),Gb.Util.setFocus(this._view),this._currentEditor){var j=this._currentEditor.parentNode;j&&j.removeChild(this._currentEditor),delete this._currentEditor}delete this._isCommitting},cancelEditing:function(){if(this._currentEditor){var a=this._currentEditor.parentNode;a&&a.removeChild(this._currentEditor),delete this._currentEditor,delete this._isCanceling}},getEditorValue:function(a){var b=a.valueRender._editInfo,c=b.property.getValueType(),d=a.valueRender._editInfo.value,e="";if("list.points"===c){var f=d._as?d._as:d;f.forEach(function(a,b){e+=b==f.length-1?"["+a.x+","+a.y+"]":"["+a.x+","+a.y+"],"})}else e=d;return e},updateCurrentRowIndex:function(a){var b=this._rowList.size();(0>a||a>=b)&&(a=-1);var c,d=this._currentRowIndex;if(a!==d&&(d>=0&&b>d&&(c=this._rowList.get(d),c.nameRender&&(c.nameRender.style.backgroundColor="")),this._currentRowIndex=a),a>=0&&(c=this._rowList.get(a),c.nameRender&&(c.nameRender.style.backgroundColor=this.getSelectColor(),!this._currentEditor&&c.valueRender&&c.valueRender._editInfo))){var e=c.valueRender._editInfo,f=this.renderEditor&&this.renderEditor(c);f?(this._currentEditor=f.view,null!=e.value&&(this._currentEditor.value=this.getEditorValue(c))):e.enumInfo?this._currentEditor=Ub.createSelect(e.enumInfo,e.value):(this._currentEditor=Mb.createElement("input"),null!=e.value&&(this._currentEditor.value=this.getEditorValue(c)));var g=this;if(c.property&&c.property.renderEditor){var f="function"==typeof c.property.renderEditor?c.property.renderEditor(g,c):c.property.renderEditor;f&&(g._currentEditor=f)}if(this._currentEditor){if(f&&f.onKeyDown){var h=f.onKeyDown;h&&Array.isArray(h)&&g._currentEditor.addEventListener("keydown",function(a){for(var b=0;b<h.length;b++)if(h[b].combKey){var c=null;switch(h[b].combKey){case"ctrlKey":c=a.ctrlKey;break;case"shiftKey":c=a.shiftKey;break;case"altKey":c=a.altKey}a.keyCode===h[b].keyCode&&c&&h[b].handlerEvent&&h[b].handlerEvent(a)}else a.keyCode===h[b].keyCode&&h[b].handlerEvent&&h[b].handlerEvent(a)})}else this._currentEditor.addEventListener("keydown",function(a){var b=a.target._editInfo.view;if(13!==a.keyCode||!a.shiftKey)if(13===a.keyCode){if(b._isCommitting)return;b._isCommitting=!0,b.commitEditValue(a.target._editInfo,a.target)}else 27===a.keyCode&&(b._isCanceling=!0,b.cancelEditing())},!1);if(this._currentEditor.addEventListener("blur",function(a){var b=a.target._editInfo.view;b._isCommitting||b._isCanceling||(b._isCommitting=!0,b.commitEditValue(a.target._editInfo,a.target))},!1),this._currentEditor.keepDefault=!0,this._currentEditor._rowInfo=c,this._currentEditor._editInfo=e,!this._currentEditor.parentNode){var i=this._currentEditor.style;i.position="absolute",i.margin="0px",i.border="0px",i.padding="0px",i.left=this._indent+this._propertyNameWidth+"px",i.top=c.rowDiv.style.top,i.width=c.valueRender.style.width,i.height=c.valueRender.style.height,this._rootDiv.appendChild(this._currentEditor)}Gb.Util.setFocus(this._currentEditor),this.onEditorRendered&&this.onEditorRendered(c)}}}}),Gb.controls.PropertySheetInteraction=function(a){this.sheet=a,this.view=a._view,this.resizeDiv=a._resizeDiv;var b=this;this.view.addEventListener("mousedown",function(a){0===a.button&&b.handleMouseDown(a)},!1),this.view.addEventListener("mousemove",function(a){b.handleMouseMove(a)},!1)},Hb.ext("twaver.controls.PropertySheetInteraction",Object,{minGap:10,handleMouseDown:function(a){if(a.target!==this.sheet._currentEditor&&a.target.parentNode!==this.sheet._currentEditor&&(this.sheet.isFocusOnClick()&&Gb.Util.setFocus(this.view),!this.sheet._isValidating))if(a.target._expandData){var b=a.target._expandData;this.sheet.isExpanded(b)?this.sheet.collapse(b):this.sheet.expand(b)}else if(a.target===this.resizeDiv)this.lastX=this.getX(a),Ub.handle_mousedown(this,a);else{this.sheet._currentEditor&&!this.sheet._isCommitting&&(this.sheet._isCommitting=!0,this.sheet.commitEditValue(this.sheet._currentEditor._editInfo,this.sheet._currentEditor));var c=this.sheet.getRowIndexAt(a);this.sheet.updateCurrentRowIndex(c)}},handleMouseMove:function(a){if(null==this.lastX&&!Ub.target)return void this.changeCursor(a);if(Ub.target===this&&null!=this.lastX){var b=this.getX(a);if(null!=this.stopLeft){if(b<this.stopLeft)return;delete this.stopLeft}if(null!=this.stopRight){if(b>this.stopRight)return;delete this.stopRight}var c=this.sheet.getPropertyNameWidth()+(b-this.lastX);c<this.minGap?(c=this.minGap,this.stopLeft=b):c>this.sheet.getSumWidth()-this.minGap&&(c=this.sheet.getSumWidth()-this.minGap,this.stopRight=b),this.sheet.setPropertyNameWidth(c),this.lastX=b}},handleMouseUp:function(a){0===a.button&&(this.view.style.cursor="default",delete this.stopLeft,delete this.stopRight,delete this.lastX)},changeCursor:function(a){this.view.style.cursor=a.target===this.resizeDiv?"ew-resize":"default"},getX:function(a){return a.clientX/this.sheet.getZoom()}}),Gb.controls.PropertySheetTouchInteraction=function(a){this.sheet=a,this.view=a._view,this.resizeDiv=a._resizeDiv,Ub.addEventListener("touchstart","handleTouchstart",this.view,this)},Hb.ext("twaver.controls.PropertySheetTouchInteraction",Object,{minGap:10,handleTouchstart:function(a){Ub.preventDefault(a),a.target!==this.sheet._currentEditor&&a.target.parentNode!==this.sheet._currentEditor&&(this.sheet.isFocusOnClick()&&Gb.Util.setFocus(this.view),this.sheet._isValidating||(a.target===this.resizeDiv&&(this.lastX=this.getX(a)),this.lastPoint=this.sheet.getLogicalPoint(a),yc.isMultiTouch(a)&&(this.distance=yc.getDistance(a),this.zoom=this.sheet.getZoom()),Ub.addEventListener("touchmove","handleTouchmove",this.view,this),Ub.addEventListener("touchend","handleTouchend",this.view,this)))},handleTouchmove:function(a){if(Ub.preventDefault(a),this.moved||(this.moved=!0),null!=this.lastX){var b=this.getX(a);if(null!=this.stopLeft){if(b<this.stopLeft)return;delete this.stopLeft}if(null!=this.stopRight){if(b>this.stopRight)return;delete this.stopRight}var c=this.sheet.getPropertyNameWidth()+(b-this.lastX);c<this.minGap?(c=this.minGap,this.stopLeft=b):c>this.sheet.getSumWidth()-this.minGap&&(c=this.sheet.getSumWidth()-this.minGap,this.stopRight=b),this.sheet.setPropertyNameWidth(c),this.lastX=b}else if(yc.isSingleTouch(a)){if(this.lastPoint){var d=this.sheet.getLogicalPoint(a),e=this.lastPoint.x-d.x,f=this.lastPoint.y-d.y,g=this.sheet.panByOffset(e,f);this.lastPoint.x-=e-g.x,this.lastPoint.y-=f-g.y}}else if(this.distance){var h=yc.getDistance(a)/this.distance;this.sheet.setZoom(this.zoom*h,!1)}},handleTouchend:function(a){if(Ub.preventDefault(a),!this.moved)if(a.target._expandData){var b=a.target._expandData;this.sheet.isExpanded(b)?this.sheet.collapse(b):this.sheet.expand(b)}else if(a.target===this.resizeDiv);else{var c=this.sheet.getRowIndexAt(a);this.sheet.updateCurrentRowIndex(c)}delete this.stopLeft,delete this.stopRight,delete this.lastX,delete this.lastPoint,delete this.distance,delete this.zoom,delete this.moved,Ub.removeEventListener("touchmove",this.view,this),Ub.removeEventListener("touchend",this.view,this)},getX:function(a){var b=a.changedTouches[0];return b.clientX}}),Gb.controls.PropertySheetMSTouchInteraction=function(a){this.sheet=a,this.view=a._view,this.resizeDiv=a._resizeDiv,this._pointerMap={},this._pointerIdArray=[],Ub.addEventListener("MSPointerDown","handleTouchstart",this.view,this),Ub.addEventListener("MSPointerMove","handleTouchmove",this.view,this),Ub.addEventListener("MSPointerUp","handleTouchend",this.view,this),Ub.addEventListener("MSPointerCancel","handleTouchend",this.view,this),this.superHandleMouseDown=Gb.controls.PropertySheetMSTouchInteraction.superClass.handleMouseDown},Hb.ext("twaver.controls.PropertySheetMSTouchInteraction",Gb.controls.PropertySheetInteraction,{handleMouseDown:function(a){},handleTouchstart:function(a){a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},
this._pointerIdArray=[]),this._pointerMap[a.pointerId]||null==this.sheet.getLogicalPoint(a)||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length&&a.pointerType==a.MSPOINTER_TYPE_MOUSE&&this.superHandleMouseDown(a),1==this._pointerIdArray.length?(this._startTouchPoint=this.sheet.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.sheet.getZoom())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Rb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.sheet.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&a.pointerType!=a.MSPOINTER_TYPE_MOUSE&&this._startTouchPoint){var c=this.sheet.getLogicalPoint(a);if(null==c)return;var d=this._startTouchPoint.x-c.x,e=this._startTouchPoint.y-c.y,f=this.sheet.panByOffset(d,e);this._startTouchPoint.x-=d-f.x,this._startTouchPoint.y-=e-f.y}},handleTouchend:function(a){if(1==this._pointerIdArray.length&&a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.sheet.getLogicalPoint(a),c=new Date;c.getTime()-this._startTouchTime.getTime()<=500&&Rb.getDistance(this._startTouchPoint,b)<=20&&this.superHandleMouseDown(a)}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Rb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Gb.controls.SplitPane=function(a,b,c,d){Gb.controls.SplitPane.superClass.constructor.apply(this,arguments),this._view=Ub.createView("hidden",!0),this._view.tabIndex=-1,this._dividerDiv=Ub.createDiv(),this._dividerDiv.tabIndex=-1,this._isPercentPosition=!0,this._view.appendChild(this._dividerDiv),a&&this.setFirstView(a),b&&this.setNextView(b),c&&this.setOrientation(c),d>1&&(this._isPercentPosition=!1),null!=d&&this.setPosition(d,this._isPercentPosition),this.setDividerDraggable(!0),this.setExpandable(!1),this.invalidate(),Ob.isTouchable&&new Gb.controls.SplitPaneTouchInteraction(this),new Gb.controls.SplitPaneInteraction(this)},Hb.ext("twaver.controls.SplitPane",Gb.controls.ControlBase,{__accessor:["orientation","dividerWidth","dividerBackground","dividerOpacity","maskBackground","upExpandIcon","downExpandIcon","leftExpandIcon","rightExpandIcon"],__bool:["dividerDraggable","expandable"],_position:Dd.SPLITPANE_POSITION,_orientation:Dd.SPLITPANE_ORIENTATION,_dividerWidth:Dd.SPLITPANE_DIVIDER_WIDTH,_dividerBackground:Dd.SPLITPANE_DIVIDER_BACKGROUND,_dividerOpacity:Dd.SPLITPANE_DIVIDER_OPACITY,_maskBackground:Dd.SPLITPANE_MASK_BACKGROUND,_upExpandIcon:Dd.SPLITPANE_UP_EXPAND_ICON,_downExpandIcon:Dd.SPLITPANE_DOWN_EXPAND_ICON,_leftExpandIcon:Dd.SPLITPANE_LEFT_EXPAND_ICON,_rightExpandIcon:Dd.SPLITPANE_RIGHT_EXPAND_ICON,onPropertyChanged:function(a){this.invalidate()},getDividerDiv:function(){return this._dividerDiv},getPosition:function(){return this._position},setPosition:function(a,b){if(b&&0>a&&(a=0),a!==this._position){var c=this._position;this._position=a,this.firePropertyChange("position",c,a),null==this.lastDividerLocation&&(this.lastDividerLocation=a)}},setFirstView:function(a){if(this._firstView!==a){var b=this._firstView;b&&this._view.removeChild(b.getView?b.getView():b),this._firstView=a,a&&(a.getView?this._view.insertBefore(a.getView(),this._dividerDiv):this._view.insertBefore(a,this._dividerDiv)),this.firePropertyChange("firstView",b,a)}},getFirstView:function(){return this._firstView},setNextView:function(a){if(this._nextView!==a){var b=this._nextView;b&&this._view.removeChild(b.getView?b.getView():b),this._nextView=a,a&&(a.getView?this._view.insertBefore(a.getView(),this._dividerDiv):this._view.insertBefore(a,this._dividerDiv)),this.firePropertyChange("nextView",b,a)}},getNextView:function(){return this._nextView},validateImpl:function(){var a,b=this._position,c=this._view.offsetWidth,d=this._view.offsetHeight,e=this._dividerWidth;if(e>=8||0===e?this._coverDiv&&(this._dividerDiv.removeChild(this._coverDiv),delete this._coverDiv):this._coverDiv||(this._coverDiv=Ub.createDiv(),this._coverDiv.tabIndex=-1,this._dividerDiv.appendChild(this._coverDiv)),"horizontal"===this._orientation){if(e>c&&(e=c),this._isPercentPosition)var f=(c-e)*b;else var f=b;var g=c-e-f+1;Hb.setViewBounds(this._firstView,{x:0,y:0,width:f,height:d}),Hb.setViewBounds(this._nextView,{x:f+e,y:0,width:g,height:d}),Hb.setViewBounds(this._dividerDiv,{x:f,y:0,width:e,height:d}),this._dividerDiv.position=f,this._coverDiv&&Hb.setViewBounds(this._coverDiv,{x:e/2-4,y:0,width:8,height:d}),this._expandable&&(this._expandCvs1||(a=Hb.html.createDiv(),a.tabIndex=-1,Hb.setViewBounds(a,{x:0,y:0,width:e,height:11}),this._expandCvs1=Hb.html.createImg(Hb.getImageSrc(this._leftExpandIcon)),this._expandCvs1.style.left=e/2-3+"px",a.appendChild(this._expandCvs1),this._dividerDiv.appendChild(a)),this._expandCvs2||(a=Hb.html.createDiv(),a.tabIndex=-1,Hb.setViewBounds(a,{x:0,y:15,width:e,height:11}),this._expandCvs2=Hb.html.createImg(Hb.getImageSrc(this._rightExpandIcon)),this._expandCvs2.style.left=e/2-3+"px",a.appendChild(this._expandCvs2),this._dividerDiv.appendChild(a)))}else{if(e>d&&(e=d),this._isPercentPosition)var h=(d-e)*b;else var h=b;var i=d-e-h;Hb.setViewBounds(this._firstView,{x:0,y:0,width:c,height:h}),Hb.setViewBounds(this._nextView,{x:0,y:h+e,width:c,height:i}),Hb.setViewBounds(this._dividerDiv,{x:0,y:h,width:c,height:e}),this._dividerDiv.position=h,this._coverDiv&&Hb.setViewBounds(this._coverDiv,{x:0,y:e/2-4,width:c,height:8}),this._expandable&&(this._expandCvs1||(a=Hb.html.createDiv(),a.tabIndex=-1,Hb.setViewBounds(a,{x:0,y:0,width:11,height:e}),this._expandCvs1=Hb.html.createImg(Hb.getImageSrc(this._upExpandIcon)),this._expandCvs1.style.top=e/2-3+"px",a.appendChild(this._expandCvs1),this._dividerDiv.appendChild(a)),this._expandCvs2||(a=Hb.html.createDiv(),a.tabIndex=-1,Hb.setViewBounds(a,{x:15,y:0,width:11,height:e}),this._expandCvs2=Hb.html.createImg(Hb.getImageSrc(this._downExpandIcon)),this._expandCvs2.style.top=e/2-3+"px",a.appendChild(this._expandCvs2),this._dividerDiv.appendChild(a)))}var j=this._dividerDiv.style;j.background=this._dividerBackground}}),Gb.controls.SplitPaneInteraction=function(a){this.splitPane=a,this.view=a._view,this.dividerDiv=a._dividerDiv,this.isPercentPosition=a._isPercentPosition;var b=this;this.view.addEventListener("mousedown",function(a){0===a.button&&b.handleMouseDown(a)},!1),this.view.addEventListener("mousemove",function(a){b.handleMouseMove(a)},!1)},Hb.ext("twaver.controls.SplitPaneInteraction",Object,{handleMouseDown:function(a){if(this.splitPane.isExpandable()){var b,c,d=this.splitPane._dividerWidth;if(a.target===this.splitPane._expandCvs1)return void("horizontal"===this.splitPane._orientation?(b=this.view.clientWidth,d>b&&(d=b),this.splitPane.lastDividerLocation===this.splitPane.getPosition()?this.splitPane.setPosition(0):this.splitPane.lastDividerLocation<this.splitPane.getPosition()&&(this.splitPane.setPosition(this.splitPane.lastDividerLocation),this.splitPane.lastDividerLocation=this.splitPane.getPosition())):(c=this.view.clientHeight,d>c&&(d=c),this.splitPane.lastDividerLocation===this.splitPane.getPosition()?this.splitPane.setPosition(0):this.splitPane.lastDividerLocation<this.splitPane.getPosition()&&(this.splitPane.setPosition(this.splitPane.lastDividerLocation),this.splitPane.lastDividerLocation=this.splitPane.getPosition())));if(a.target===this.splitPane._expandCvs2)return void("horizontal"===this.splitPane._orientation?(b=this.view.clientWidth,d>b&&(d=b),this.splitPane.lastDividerLocation===this.splitPane.getPosition()?this.splitPane.setPosition(1):this.splitPane.lastDividerLocation>this.splitPane.getPosition()&&(this.splitPane.setPosition(this.splitPane.lastDividerLocation),this.splitPane.lastDividerLocation=this.splitPane.getPosition())):(c=this.view.clientHeight,d>c&&(d=c),this.splitPane.lastDividerLocation===this.splitPane.getPosition()?this.splitPane.setPosition(1):this.splitPane.lastDividerLocation>this.splitPane.getPosition()&&(this.splitPane.setPosition(this.splitPane.lastDividerLocation),this.splitPane.lastDividerLocation=this.splitPane.getPosition())))}if(this.splitPane.isDividerDraggable())if(this.resizeDiv)this.clear(a);else if(a.target===this.dividerDiv||a.target===this.splitPane._coverDiv){this.resizeDiv=Ub.createDiv();var e=this.resizeDiv.style;e.left=this.dividerDiv.style.left,e.top=this.dividerDiv.style.top,e.width=this.dividerDiv.style.width,e.height=this.dividerDiv.style.height,e.opacity=this.splitPane.getDividerOpacity(),e.background=this.splitPane.getDividerBackground(),this.resizeDiv.lastPosition="horizontal"===this.splitPane._orientation?a.clientX:a.clientY,this.resizeDiv.maskDiv=Ub.createDiv(),e=this.resizeDiv.maskDiv.style,e.left="0px",e.top="0px",e.width=this.view.clientWidth+"px",e.height=this.view.clientHeight+"px",e.background=this.splitPane.getMaskBackground(),this.view.appendChild(this.resizeDiv.maskDiv),this.view.appendChild(this.resizeDiv),Ub.handle_mousedown(this,a),a.preventDefault()}},handleMouseMove:function(a){if((!this.splitPane.isExpandable()||a.target!==this.splitPane._expandCvs1&&a.target!==this.splitPane._expandCvs2)&&this.splitPane.isDividerDraggable())if(this.resizeDiv||Ub.target)this.resizeDiv&&Ub.target===this&&("horizontal"===this.splitPane._orientation?this.resizeDiv.style.left=this.dividerDiv.position+a.clientX-this.resizeDiv.lastPosition+"px":this.resizeDiv.style.top=this.dividerDiv.position+a.clientY-this.resizeDiv.lastPosition+"px");else{var b="horizontal"===this.splitPane._orientation?"ew-resize":"ns-resize";this.view.style.cursor=a.target===this.dividerDiv||a.target===this.splitPane._coverDiv?b:"default"}},handleMouseUp:function(a){(!this.splitPane.isExpandable()||a.target!==this.splitPane._expandCvs1&&a.target!==this.splitPane._expandCvs2)&&this.splitPane.isDividerDraggable()&&0===a.button&&this.clear(a)},clear:function(a){if(this.resizeDiv){var b,c=this.splitPane._dividerWidth;if("horizontal"===this.splitPane._orientation){var d=this.view.clientWidth;c>d&&(c=d),b=this.dividerDiv.position+a.clientX-this.resizeDiv.lastPosition,this.splitPane.setPosition(this.isPercentPosition?b/(d-c):b)}else{var e=this.view.clientHeight;c>e&&(c=e),b=this.dividerDiv.position+a.clientY-this.resizeDiv.lastPosition,this.splitPane.setPosition(this.isPercentPosition?b/(e-c):b)}this.splitPane.lastDividerLocation=this.splitPane.getPosition(),this.view.removeChild(this.resizeDiv.maskDiv),this.view.removeChild(this.resizeDiv),delete this.resizeDiv}}}),Gb.controls.SplitPaneTouchInteraction=function(a){this.splitPane=a,this.view=a._view,this.dividerDiv=a._dividerDiv,this.isPercentPosition=a._isPercentPosition,Ub.addEventListener("touchstart","handleTouchstart",this.view,this)},Hb.ext("twaver.controls.SplitPaneTouchInteraction",Object,{handleTouchstart:function(a){if(Ub.preventDefault(a),this.splitPane.isExpandable()){var b,c,d=this.splitPane._dividerWidth;if(a.target===this.splitPane._expandCvs1)return void("horizontal"===this.splitPane._orientation?(b=this.view.clientWidth,d>b&&(d=b),this.splitPane.lastDividerLocation===this.splitPane.getPosition()?this.splitPane.setPosition(0):this.splitPane.lastDividerLocation<this.splitPane.getPosition()&&(this.splitPane.setPosition(this.splitPane.lastDividerLocation),this.splitPane.lastDividerLocation=this.splitPane.getPosition())):(c=this.view.clientHeight,d>c&&(d=c),this.splitPane.lastDividerLocation===this.splitPane.getPosition()?this.splitPane.setPosition(0):this.splitPane.lastDividerLocation<this.splitPane.getPosition()&&(this.splitPane.setPosition(this.splitPane.lastDividerLocation),this.splitPane.lastDividerLocation=this.splitPane.getPosition())));if(a.target===this.splitPane._expandCvs2)return void("horizontal"===this.splitPane._orientation?(b=this.view.clientWidth,d>b&&(d=b),this.splitPane.lastDividerLocation===this.splitPane.getPosition()?this.splitPane.setPosition(1):this.splitPane.lastDividerLocation>this.splitPane.getPosition()&&(this.splitPane.setPosition(this.splitPane.lastDividerLocation),this.splitPane.lastDividerLocation=this.splitPane.getPosition())):(c=this.view.clientHeight,d>c&&(d=c),this.splitPane.lastDividerLocation===this.splitPane.getPosition()?this.splitPane.setPosition(1):this.splitPane.lastDividerLocation>this.splitPane.getPosition()&&(this.splitPane.setPosition(this.splitPane.lastDividerLocation),this.splitPane.lastDividerLocation=this.splitPane.getPosition())))}if(this.resizeDiv)this.clear(a);else if(a.target===this.dividerDiv||a.target===this.splitPane._coverDiv){this.resizeDiv=Ub.createDiv();var e=this.resizeDiv.style;e.left=this.dividerDiv.style.left,e.top=this.dividerDiv.style.top,e.width=this.dividerDiv.style.width,e.height=this.dividerDiv.style.height,e.opacity=this.splitPane.getDividerOpacity(),e.background=this.splitPane.getDividerBackground();var f=a.changedTouches[0];this.resizeDiv.lastPosition="horizontal"===this.splitPane._orientation?f.clientX:f.clientY,this.resizeDiv.maskDiv=Ub.createDiv();var e=this.resizeDiv.maskDiv.style;e.left="0px",e.top="0px",e.width=this.view.clientWidth+"px",e.height=this.view.clientHeight+"px",e.background=this.splitPane.getMaskBackground(),this.view.appendChild(this.resizeDiv.maskDiv),this.view.appendChild(this.resizeDiv)}Ub.addEventListener("touchmove","handleTouchmove",this.view,this),Ub.addEventListener("touchend","handleTouchend",this.view,this)},handleTouchmove:function(a){if(Ub.preventDefault(a),!this.splitPane.isExpandable()||a.target!==this.splitPane._expandCvs1&&a.target!==this.splitPane._expandCvs2)if(this.resizeDiv){var b=a.changedTouches[0];"horizontal"===this.splitPane._orientation?this.resizeDiv.style.left=this.dividerDiv.position+b.clientX-this.resizeDiv.lastPosition+"px":this.resizeDiv.style.top=this.dividerDiv.position+b.clientY-this.resizeDiv.lastPosition+"px"}else;},handleTouchend:function(a){(!this.splitPane.isExpandable()||a.target!==this.splitPane._expandCvs1&&a.target!==this.splitPane._expandCvs2)&&(Ub.removeEventListener("touchmove",this.view,this),Ub.removeEventListener("touchend",this.view,this),this.clear(a))},clear:function(a){var b=a.changedTouches[0];if(this.resizeDiv){var c=this.splitPane._dividerWidth;if("horizontal"===this.splitPane._orientation){var d=this.view.clientWidth;c>d&&(c=d);var e=this.dividerDiv.position+b.clientX-this.resizeDiv.lastPosition;this.splitPane.setPosition(this.isPercentPosition?e/(d-c):e)}else{var f=this.view.clientHeight;c>f&&(c=f);var e=this.dividerDiv.position+b.clientY-this.resizeDiv.lastPosition;this.splitPane.setPosition(this.isPercentPosition?e/(f-c):e)}this.splitPane.lastDividerLocation=this.splitPane.getPosition(),this.view.removeChild(this.resizeDiv.maskDiv),this.view.removeChild(this.resizeDiv),delete this.resizeDiv}}}),Gb.controls.TabPane=function(){Gb.controls.TabPane.superClass.constructor.apply(this,arguments),this._tabBox=new Gb.TabBox,this._tabBox.addDataBoxChangeListener(this.handleTabChange,this),this._tabBox.addDataPropertyChangeListener(this.handleTabChange,this),this._tabBox.addHierarchyChangeListener(this.handleTabChange,this),this._tabBox.getSelectionModel().addSelectionChangeListener(this.handleTabChange,this),this._view=Ub.createView("hidden",!0),this._tabDiv=Ub.createDiv(),this._tabDiv.onmousedown=Ub.preventDefault,this._tabDiv.onkeydown=Ub.preventDefault,this._contentDiv=Ub.createDiv(),this._view.appendChild(this._tabDiv),this._view.appendChild(this._contentDiv),this._divPool=new Gb.Pool("div"),this._iconPool=new Gb.Pool("img"),this._closePool=new Gb.Pool("img"),this._textPool=new Gb.Pool("span"),this._resizePool=new Gb.Pool("div"),this._pools.add(this._divPool),this._pools.add(this._iconPool),this._pools.add(this._closePool),this._pools.add(this._textPool),this._pools.add(this._resizePool),this.invalidateTab(),Ob.isTouchable&&new Gb.controls.TabPaneTouchInteraction(this),new Gb.controls.TabPaneInteraction(this)},Hb.ext("twaver.controls.TabPane",Gb.controls.ControlBase,{__accessor:["tabGap","tabRadius","tabHeight","horizontalAlign","tabOrientation","resizeTolerance","tabBackground","selectBackground","moveBackground","insertBackground","closeIcon","disabledColor"],__bool:["selectNextOnClose","selectNextOnInVisible"],_tabGap:Dd.TABPANE_TAB_GAP,_tabRadius:Dd.TABPANE_TAB_RADIUS,_tabHeight:Dd.TABPANE_TAB_HEIGHT,_resizeTolerance:Dd.TABPANE_RESIZE_TOLERANCE,_tabOrientation:Dd.TABPANE_TAB_ORIENTATION,_tabBackground:Dd.TABPANE_TAB_BACKGROUND,_disabledColor:Dd.TABPANE_DISABLED_COLOR,_selectBackground:Dd.TABPANE_SELECT_BACKGROUND,_moveBackground:Dd.TABPANE_MOVE_BACKGROUND,_insertBackground:Dd.TABPANE_INSERT_BACKGROUND,_horizontalAlign:Dd.TABPANE_HORIZONTAL_ALIGN,_closeIcon:Dd.TABPANE_CLOSE_ICON,_selectNextOnClose:Dd.TABPANE_SELECT_NEXT_ON_CLOSE,_selectNextOnInVisible:Dd.TABPANE_SELECT_NEXT_ON_INVISIBLE,onPropertyChanged:function(a){this.invalidateTab()},getTabBox:function(){return this._tabBox},getTabDiv:function(){return this._tabDiv},getContentDiv:function(){return this._contentDiv},handleTabChange:function(a){if(this._selectNextOnInVisible&&"visible"===a.property&&!a.newValue&&this._tabBox.getSelectionModel().contains(a.source)){for(var b,c,d=a.source,e=this._tabBox.getRoots().indexOf(d),f=this._tabBox.getRoots(),g=f.size(),h=e;g-1>h;)if(b=f.get(++h),b.isVisible()&&!b.isDisabled()){c=b;break}if(!c)for(h=e;h>0;)if(b=f.get(--h),b.isVisible()&&!b.isDisabled()){c=b;break}this._tabBox.getSelectionModel().setSelection(c)}this.invalidateTab()},invalidateTab:function(a){this._invalidateTab||(this._invalidateTab=!0,this.invalidate(a))},validateImpl:function(){this._invalidateTab&&(this._invalidateTab=!1,this.validateTab());var a,b=this._view.offsetWidth,c=this._view.offsetHeight;"top"===this._tabOrientation?(this._tabDiv.style.top="0px",a={x:0,y:this._tabHeight,width:b,height:Math.max(0,c-this._tabHeight)}):(this._tabDiv.style.top=c-this._tabHeight+"px",a={x:0,y:0,width:b,height:Math.max(0,c-this._tabHeight)}),this._currentView&&Hb.setViewBounds(this._currentView,a)},getCurrentTab:function(){return this._currentTab},getCurrentView:function(){return this._currentView},onViewRemoved:function(a){},onViewAdded:function(a){},validateTab:function(){this._currentTab=this._tabBox.getSelectionModel().getLastData();var a=this._currentTab?this._currentTab.getView():null;if(a!==this._currentView){var b,c;this._currentView&&(b=this._currentView.getView?this._currentView.getView():this._currentView,b.style.visibility="hidden",this.onViewRemoved(this._currentView)),a&&(c=a.getView?a.getView():a,c.style.visibility="inherit",c.parentNode||this._contentDiv.appendChild(c),this.onViewAdded(a)),this._currentView=a}Ub.release(this._tabDiv);for(var d=this._tabBox.getRoots(),e=this._tabHeight+"px",f=this._tabHeight-2+"px",g=this._tabRadius+"px",h=d.size(),i=0,j=0;h>j;j++){var k=d.get(j);if(k.isVisible()){var l=this._currentTab===k,m=k.getWidth();0>m&&(m=0);var n=Math.min(this._tabGap,m),o=this._divPool.get();o._tab=k;var p=o.style;p.position="absolute",p.whiteSpace="nowrap",p.lineHeight=f,p.overflow="hidden",p.textOverflow="ellipsis",p.background=l?this._selectBackground:this._tabBackground,p.textAlign=this._horizontalAlign,"top"===this._tabOrientation?(p.borderTopLeftRadius=g,p.borderTopRightRadius=g,p.borderBottomLeftRadius="0px",p.borderBottomRightRadius="0px"):(p.borderTopLeftRadius="0px",p.borderTopRightRadius="0px",p.borderBottomLeftRadius=g,p.borderBottomRightRadius=g),p.left=i+"px",p.width=m-n+"px",p.height=e,o._x=i,o._width=m-n,this.renderTab(o,k),this.onTabRendered(o,k),this._tabDiv.insertBefore(o,this._tabDiv.firstChild),i+=m,k.isResizable()&&(o=this._resizePool.get(),o._resizeTab=k,p=o.style,p.position="absolute",p.backgroundColor="white",p.opacity=0,p.left=i-n-this._resizeTolerance+"px",p.width=n+2*this._resizeTolerance+"px",p.height=e,this._tabDiv.appendChild(o))}}this._tabDiv.style.left="0px",this._tabDiv.style.width=i+"px",this._tabDiv.style.height=this._tabHeight+"px",this._pools.forEach(function(a){a.clear()})},renderTab:function(a,b){if(b.renderTab)b.renderTab(a);else{var c=b.getIcon();if(c){var d=this._iconPool.get();d.setAttribute("src",Hb.getImageSrc(c)),d.style.paddingLeft="4px",d.style.verticalAlign="middle",a.appendChild(d)}var e=b.getName();if(e){var f=this._textPool.get();f.style.whiteSpace="nowrap",f.style.verticalAlign="middle",f.style.padding="2px 4px",f.innerHTML=e,a.appendChild(f)}if(Ob.isOpera){var g=a.cloneNode(!1);g.style.left="0px",g.style.top="0px",g.style.opacity=0,a.appendChild(g)}}if(b.isClosable()){var h=this._tabRadius/4+2,d=this._closePool.get();d._closeTab=b,d.setAttribute("src",Hb.getImageSrc(this._closeIcon)),d.style.position="absolute",d.style.top=h+"px",d.style.right=h+"px",a.appendChild(d)}a.style.color=b.isDisabled()?this.getDisabledColor():""},onTabRendered:function(a,b){}}),Gb.controls.TabPaneInteraction=function(a){this.tabPane=a,this.view=a.getTabDiv();var b=this;this.view.addEventListener("mousedown",function(a){b.handleMouseDown(a)},!1),this.view.addEventListener("mousemove",function(a){b.handleMouseMove(a)},!1)},Hb.ext("twaver.controls.TabPaneInteraction",Object,{handleMouseDown:function(a){if(0===a.button){if(this.movableDiv)return void this.handleMouseUp(a);this.resizeTab=a.target._resizeTab,this.resizeTab||(this.movableDiv=this.getMovableDivAt(a)),this.changeCursor(a),this.lastX=this.getX(a),this._startClient=Ub.getClientPoint(a),this._startLogicalX=this.lastX,Ub.handle_mousedown(this,a)}},changeCursor:function(a){var b="";if(a.target._resizeTab)b="ew-resize";else{var c=this.getTabAt(a);!c||c.isDisabled()&&!c.isMovable()||(b="pointer")}this.view.style.cursor=b},handleMouseMove:function(a){if(null==this.lastX)return void this.changeCursor(a);if(Ub.target===this){var b=this._startLogicalX+a.clientX-this._startClient.x;if(this.resizeTab){if(null!=this.stopX){if(b<this.stopX)return;delete this.stopX}var c=this.resizeTab.getWidth()+(b-this.lastX);10>c&&(c=10,this.stopX=b),this.resizeTab.setWidth(c),this.lastX=b}else if(this.movableDiv){var d=b-this.lastX;if(!this.cloneDiv){if(Math.abs(d)<3)return;this.cloneDiv=this.movableDiv.cloneNode(!0),this.cloneDiv._x=this.movableDiv._x,this.cloneDiv.style.background=this.tabPane.getMoveBackground(),this.insertDiv=Ub.createDiv(),this.insertDiv.style.width="1px",this.insertDiv.style.height=this.cloneDiv.style.height,this.insertDiv.style.background=this.tabPane.getInsertBackground(),this.movableDiv.parentNode.appendChild(this.cloneDiv),this.movableDiv.parentNode.appendChild(this.insertDiv)}var e=this.cloneDiv._x+d;this.cloneDiv.style.left=e+"px",this.cloneDiv._x=e,this.lastX=b,this.tabInfo=this.getTabInfoAt(a),this.tabInfo&&(this.insertDiv.style.left=this.tabInfo.position)}}},handleMouseUp:function(a){if(0===a.button){if(this.resizeTab);else if(this.movableDiv&&this.tabInfo){var b=this.movableDiv._tab,c=this.tabInfo.index;this.tabPane.getTabBox().moveTo(b,c)}else{var d=this.tabPane.getTabBox(),b=a.target._closeTab;if(b)if(this.tabPane.isSelectNextOnClose()&&this.tabPane.getCurrentTab()===b){var e=d.getRoots(),c=e.indexOf(b);d.remove(b),e.size()>0&&(c>=e.size()&&(c=e.size()-1),d.getSelectionModel().setSelection(e.get(c)))}else d.remove(b);else{var b=this.getTabAt(a);b&&!b.isDisabled()&&d.getSelectionModel().setSelection(b)}}this.clear()}},clear:function(){this.view.style.cursor="",this.cloneDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.cloneDiv),this.insertDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.insertDiv),delete this.movableDiv,delete this.tabInfo,delete this.insertDiv,delete this.cloneDiv,delete this.resizeTab,delete this.stopX,delete this.lastX,delete this._startLogicalX,delete this._startClient},getTabAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._tab);)a=a.parentNode;return b},getMovableDivAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._tab);)a=a.parentNode;return b&&b.isMovable()?a:null},getX:function(a){var b=Ub.getLogicalPoint(this.view,a);return b?b.x:null},getTabInfoAt:function(a){for(var b=this._startLogicalX+a.clientX-this._startClient.x,c=this.tabPane.getTabBox().getRoots(),d=c.size(),e=0,f=!1,g=0;d>g;g++){var h=c.get(g);if(h===this.movableDiv._tab&&(f=!0),h.isVisible()){var i=h.getWidth();if(0>=i)continue;if(b>=e&&e+i>=b){var j=e+i/2>b;!f||h===this.movableDiv._tab&&j||g--;var k=j?Math.max(0,g):Math.min(g+1,d),l=j?e:e+i;return l=Math.max(0,l-1),{index:k,tab:h,position:l+"px"}}e+=i}}return this.tabInfo}}),Gb.controls.TabPaneTouchInteraction=function(a){this.tabPane=a,this.view=a.getTabDiv(),Ub.addEventListener("touchstart","handleTouchstart",this.view,this)},Hb.ext("twaver.controls.TabPaneTouchInteraction",Object,{handleTouchstart:function(a){return Ub.preventDefault(a),this.movableDiv?void this.handleTouchend(a):(this.resizeTab=a.target._resizeTab,this.resizeTab||(this.movableDiv=this.getMovableDivAt(a)),this.lastX=this.getX(a),Ub.addEventListener("touchmove","handleTouchmove",this.view,this),void Ub.addEventListener("touchend","handleTouchend",this.view,this))},handleTouchmove:function(a){if(null!=this.lastX)if(this.resizeTab){var b=this.getX(a);if(null!=this.stopX){if(b<this.stopX)return;delete this.stopX}var c=this.resizeTab.getWidth()+(b-this.lastX);0>c&&(c=0,this.stopX=b),this.resizeTab.setWidth(c),this.lastX=b}else if(this.movableDiv){var b=this.getX(a),d=b-this.lastX;if(!this.cloneDiv){if(Math.abs(d)<3)return;this.cloneDiv=this.movableDiv.cloneNode(!0),this.cloneDiv._x=this.movableDiv._x,this.cloneDiv.style.background=this.tabPane.getMoveBackground(),this.insertDiv=Ub.createDiv(),this.insertDiv.style.width="1px",this.insertDiv.style.height=this.cloneDiv.style.height,this.insertDiv.style.background=this.tabPane.getInsertBackground(),this.movableDiv.parentNode.appendChild(this.cloneDiv),this.movableDiv.parentNode.appendChild(this.insertDiv)}var e=this.cloneDiv._x+d;this.cloneDiv.style.left=e+"px",this.cloneDiv._x=e,this.lastX=b,this.tabInfo=this.getTabInfoAt(a),this.tabInfo&&(this.insertDiv.style.left=this.tabInfo.position)}},handleTouchend:function(a){if(this.resizeTab);else if(this.movableDiv&&this.tabInfo){var b=this.movableDiv._tab,c=this.tabInfo.index;this.tabPane.getTabBox().moveTo(b,c)}else{var d=this.tabPane.getTabBox(),b=a.target._closeTab;if(b)if(this.tabPane.isSelectNextOnClose()&&this.tabPane.getCurrentTab()===b){var e=d.getRoots(),c=e.indexOf(b);d.remove(b),e.size()>0&&(c>=e.size()&&(c=e.size()-1),d.getSelectionModel().setSelection(e.get(c)))}else d.remove(b);else{var b=this.getTabAt(a);b&&!b.isDisabled()&&d.getSelectionModel().setSelection(b)}}this.clear(),Ub.removeEventListener("touchmove",this.view,this),Ub.removeEventListener("touchend",this.view,this)},clear:function(){this.cloneDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.cloneDiv),this.insertDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.insertDiv),delete this.movableDiv,delete this.tabInfo,delete this.insertDiv,delete this.cloneDiv,delete this.resizeTab,delete this.stopX,delete this.lastX},getTabAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._tab);)a=a.parentNode;return b},getMovableDivAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._tab);)a=a.parentNode;return b&&b.isMovable()?a:null},getX:function(a){var b=Ub.getLogicalPoint(this.view,a);return b?b.x:null},getTabInfoAt:function(a){for(var b=this.getX(a),c=this.tabPane.getTabBox().getRoots(),d=c.size(),e=0,f=!1,g=0;d>g;g++){var h=c.get(g);if(h===this.movableDiv._tab&&(f=!0),h.isVisible()){var i=h.getWidth();if(0>=i)continue;if(b>=e&&e+i>=b){var j=e+i/2>b;!f||h===this.movableDiv._tab&&j||g--;var k=j?Math.max(0,g):Math.min(g+1,d),l=j?e:e+i;return l=Math.max(0,l-1),{index:k,tab:h,position:l+"px"}}e+=i}}return this.tabInfo}}),Gb.controls.TitlePane=function(a,b,c){Gb.controls.TitlePane.superClass.constructor.apply(this,arguments),this.invalidate(),this._titleDiv=Ub.createDiv(),this._titleDiv.tabIndex=-1,this._titleDiv.style.verticalAlign="middle",this._titleDiv.style.fontWeight="bold",this._titleDiv.style.textOverflow="ellipsis",this._titleDiv.style.overflow="hidden",this._titleDiv.style.whiteSpace="nowrap",this._titleDiv.onmousedown=Ub.preventDefault,this._span=Mb.createElement("span"),this._span.style.verticalAlign="middle",this._span.style.paddingLeft="4px",this._span.style.paddingRight="4px",this._img=Mb.createElement("img"),this._img.style.verticalAlign="middle",this._img.style.paddingLeft="4px",this._view=Ub.createView("hidden",!0),this._view.tabIndex=-1,this._view.appendChild(this._titleDiv),b&&this.setTitle(b),a&&this.setContent(a),c&&this.setIcon(c)},Hb.ext("twaver.controls.TitlePane",Gb.controls.ControlBase,{__accessor:["icon","title","titleHeight","titleHorizontalAlign","titleBackground"],_titleHeight:Dd.TITLEPANE_TITLE_HEIGHT,_titleBackground:Dd.TITLEPANE_TITLE_BACKGROUND,_titleHorizontalAlign:Dd.TITLEPANE_TITLE_HORIZONTAL_ALIGN,onPropertyChanged:function(a){this.invalidate()},getTitleDiv:function(){return this._titleDiv},getContent:function(){return this._content},setContent:function(a){if(this._content!==a){var b=this._content;b&&this._view.removeChild(b.getView?b.getView():b),this._content=a,a&&this._view.appendChild(a.getView?a.getView():a),this.firePropertyChange("content",b,a)}},validateImpl:function(){var a=this._view.offsetWidth,b=this._view.offsetHeight,c=this._titleDiv.style;c.textAlign=this._titleHorizontalAlign,c.lineHeight=this._titleHeight-2+"px",c.background=this._titleBackground,Ub.clear(this._titleDiv),this._icon&&(this._img.setAttribute("src",Hb.getImageSrc(this._icon)),this._titleDiv.appendChild(this._img)),this._title&&(this._span.innerHTML=this._title,this._span.setAttribute("title",this._title),this._titleDiv.appendChild(this._span));var c=this._titleDiv.style;c.left="0px",c.top="0px",c.width=a+"px",c.height=this._titleHeight+"px",Hb.setViewBounds(this._content,{x:0,y:this._titleHeight,width:a,height:Math.max(b-this._titleHeight,0)})}}),Gb.controls.Accordion=function(){Gb.controls.Accordion.superClass.constructor.apply(this,arguments),this._titleMap={},this._titleList=new md,this._currentTitle=null,this._currentView=null,this._view=Ub.createView("hidden",!0),this.invalidate();var a=this;this._view.addEventListener("mousedown",function(b){a.handleMouseDown(b)},!1)},Hb.ext("twaver.controls.Accordion",Gb.controls.ControlBase,{__accessor:["expandIcon","collapseIcon","titleHeight","titleBackground","borderBottomColor","iconPosition"],_expandIcon:Dd.ACCORDION_EXPAND_ICON,_collapseIcon:Dd.ACCORDION_COLLAPSE_ICON,_titleHeight:Dd.ACCORDION_TITLE_HEIGHT,_titleBackground:Dd.ACCORDION_TITLE_BACKGROUND,_borderBottomColor:Dd.ACCORDION_BORDER_BOTTOM_COLOR,_iconPosition:Dd.ACCORDION_ICON_POSITION,onPropertyChanged:function(a){this.invalidate()},handleMouseDown:function(a){if(0===a.button){var b=a.target._title;b||(b=a.target.parentNode._title),b&&(this._currentTitle===b?this.collapse():this.expand(b))}},getTitles:function(){return this._titleList},getCurrentTitle:function(){return this._currentTitle},add:function(a,b){if(this._titleMap[a])throw"Title ' + title + ' already exists";var c=Ub.createDiv();c._title=a,c.onmousedown=Ub.preventDefault,c.style.cursor="pointer",c.style.textAlign="left",c.style.textOverflow="ellipsis",c.style.whiteSpace="nowrap",c.style.overflow="hidden",c.style.borderBottomWidth="1px",c.style.borderBottomStyle="solid";var d=Mb.createElement("img");d.style.verticalAlign="middle",d.style.paddingLeft="4px";var e=Mb.createElement("span");if(e.style.verticalAlign="middle",e.style.paddingLeft="4px",e.innerHTML=a,e.setAttribute("title",a),this._view.appendChild(c),c.appendChild(d),c.appendChild(e),"right"==this._iconPosition){var f=d.style,g=(this._titleHeight-8)/2;f.marginTop=g+"px",f.right="15px",f.position="absolute"}this._titleMap[a]={content:b,titleDiv:c,span:e,img:d},this._titleList.add(a),this.invalidate();

},remove:function(a){var b=this._titleMap[a];b&&this._view.removeChild(b.titleDiv),delete this._titleMap[a],this._titleList.remove(a),this.invalidate()},clear:function(){var a=this;Object.keys(a._titleMap).forEach(function(b){a._view.removeChild(a._titleMap[b].titleDiv)}),a._titleMap={},a._titleList.clear(),a.invalidate()},expand:function(a){this._titleMap[a]&&this._currentTitle!==a&&(this._currentTitle=a,this.onExpanded(a),this.invalidate())},onExpanded:function(a){},collapse:function(){this._currentTitle&&(this.onCollapsed(this._currentTitle),this._currentTitle=null,this.invalidate())},onCollapsed:function(a){},validateImpl:function(){var a=this._currentView;this._currentView=null;for(var b=this._view.offsetWidth,c=this._view.offsetHeight,d=this._titleList.size(),e=0,f=0;d>f;f++){var g=this._titleList.get(f),h=this._titleMap[g],i=h.titleDiv.style;i.lineHeight=this._titleHeight-3+"px",i.background=this._titleBackground,i.borderBottomColor=this._borderBottomColor,i.left="0px",i.top=e+"px",i.width=b+"px",i.height=this._titleHeight-1+"px";var j=this._currentTitle===g,k=j?this._expandIcon:this._collapseIcon;if(h.img.setAttribute("src",Hb.getImageSrc(k)),j){var l=Math.max(0,c-d*this._titleHeight);h.content&&(this._currentView=h.content.getView?h.content.getView():h.content,Hb.setViewBounds(h.content,{x:0,y:e+this._titleHeight,width:b,height:l}),h.content.style.overflowY="auto"),e+=this._titleHeight+l}else e+=this._titleHeight}this._currentView&&this._currentView!==a&&this._view.appendChild(this._currentView),a&&a!==this._currentView&&this._view.removeChild(a)}}),Gb.controls.BorderPane=function(a,b,c,d,e){Gb.controls.BorderPane.superClass.constructor.apply(this,arguments),this.invalidate(),this._view=Ub.createView("hidden",!0),this._view.tabIndex=-1,a&&this.setCenter(a),b&&this.setTop(b),c&&this.setRight(c),d&&this.setBottom(d),e&&this.setLeft(e)},Hb.ext("twaver.controls.BorderPane",Gb.controls.ControlBase,{__accessor:["hGap","vGap","topHeight","bottomHeight","leftWidth","rightWidth"],_hGap:Dd.BORDERPANE_HGAP,_vGap:Dd.BORDERPANE_VGAP,_topHeight:0,_bottomHeight:0,_leftWidth:0,_rightWidth:0,onPropertyChanged:function(a){this.invalidate()},getCenter:function(){return this._center},setCenter:function(a){this._setContent("center",a)},getTop:function(){return this._top},setTop:function(a){this._setContent("top",a)},getRight:function(){return this._right},setRight:function(a){this._setContent("right",a)},getBottom:function(){return this._bottom},setBottom:function(a){this._setContent("bottom",a)},getLeft:function(){return this._left},setLeft:function(a){this._setContent("left",a)},_setContent:function(a,b){var c=this["_"+a];if(c!==b){if(c){var d=c.getView?c.getView():c;this._view.contains(d)&&this._view.removeChild(d)}this["_"+a]=b,b&&this._view.appendChild(b.getView?b.getView():b),this.firePropertyChange(a,c,b)}},validateImpl:function(){var a=this._view.offsetWidth,b=this._view.offsetHeight,c=0,d=0,e=a,f=b,g=0,h=0,i=0,j=0;this._top&&(g=this._topHeight||(this._top.getView?this._top.getView().offsetHeight:this._top.offsetHeight),d=g+this._vGap),this._bottom&&(h=this._bottomHeight||(this._bottom.getView?this._bottom.getView().offsetHeight:this._bottom.offsetHeight),f=b-h-this._vGap),this._left&&(i=this._leftWidth||(this._left.getView?this._left.getView().offsetWidth:this._left.offsetWidth),c=i+this._hGap),this._right&&(j=this._rightWidth||(this._right.getView?this._right.getView().offsetWidth:this._right.offsetWidth),e=a-j-this._hGap);var k=Math.max(0,e-c),l=Math.max(0,f-d);this._top&&Hb.setViewBounds(this._top,{x:0,y:0,width:a,height:g}),this._bottom&&Hb.setViewBounds(this._bottom,{x:0,y:f,width:a,height:h}),this._left&&Hb.setViewBounds(this._left,{x:0,y:d,width:i,height:l}),this._right&&Hb.setViewBounds(this._right,{x:e,y:d,width:j,height:l}),this._center&&Hb.setViewBounds(this._center,{x:c,y:d,width:k,height:l})}}),Gb.controls.PopupMenu=function(a){this._view=Ub.createDiv(),this._view.style.zIndex=100001,this._items=[],this._itemsMap={},this.setContextView(a);var b=this._view,c=this;b.addEventListener("mouseover",function(a){c._mouseOver=!0},!1),b.addEventListener("mouseout",function(a){c._mouseOver=!1},!1),b.oncontextmenu=function(a){a.preventDefault()},Ub.addEventListener("mousedown","_handleClick",b,this)},Hb.ext("twaver.controls.PopupMenu",Object,{_width:200,_xOffset:0,_yOffset:0,_menuItemHeight:25,_background:"#F9F9F9",_border:"2px outset white",_disabledColor:"#BABBBC",_focusColor:"white",_focusBackground:"#C2CFF1",_color:"black",_subMenuEnableIcon:Dd.POPUPMENU_SUBNENU_ENABLE_ICON,_subMenuDisableIcon:Dd.POPUPMENU_SUBNENU_DISABLE_ICON,_checkboxSelectedIcon:Dd.POPUPMENU_CHECKBOX_SELECTED_ICON,_checkboxUnselectedIcon:Dd.POPUPMENU_CHECKBOX_UNSELECTED_ICON,_radiobuttonSelectedIcon:Dd.POPUPMENU_RADIOBUTTON_SELECTED_ICON,_radiobuttonUnselectedIcon:Dd.POPUPMENU_RADIOBUTTON_UNSELECTED_ICON,getView:function(){return this._view},getContextView:function(){return this._contextView},setContextView:function(a){if(this._removeContextmenuListener(),this._contextView=a,a){var b=a.getView?a.getView():a;Ob.isTouchable?(b.addEventListener("touchstart",this._getTouchStartListener(),!1),b.addEventListener("touchmove",this._getTouchMoveListener(),!1),b.addEventListener("touchend",this._getTouchEndListener(),!1),Ub.addEventListener("contextmenu","_handleContextmenu",b,this)):Ub.addEventListener("contextmenu","_handleContextmenu",b,this)}},getMenuItems:function(){return this._items},setMenuItems:function(a){if(this._items=[],this._itemsMap={},a)for(var b=0,c=a.length;c>b;b++)this.addMenuItem(a[b])},addMenuItem:function(a){a.separator!==!0&&(this._itemsMap[a.id||a.label]=a),this._items.push(a)},getMenuItem:function(a){return this._itemsMap[a]},addSeparator:function(){this.addMenuItem({separator:!0})},getMenuItemById:function(a){return this._itemsMap[a]},isVisible:function(a){return a.visible!==!1},isEnabled:function(a){return a.enabled!==!1},show:function(a){this.hide();var b,c,d=this._view,e=this._view.style;if(Ob.isTouchable?(b=a.changedTouches&&a.changedTouches[0].clientX||a.clientX,c=a.changedTouches&&a.changedTouches[0].clientY||a.clientY):(b=a.clientX,c=a.clientY),Ub.clear(d),this.renderMenu(d,this._items),0!==this._height){Ob.isTouchable&&Ub.addEventListener("touchstart","_handleBodyClicked",Mb.body,this),Ub.addEventListener("mousedown","_handleBodyClicked",Mb.body,this);var f=Ub.windowWidth()-this._width-10,g=Ub.windowHeight()-this._height-10;b=b>f?f:b,c=c>g?g:c,b=0>b?0:b,c=0>c?0:c,e.left=b+yc.scrollLeft()+this._xOffset+"px",e.top=c+yc.scrollTop()+this._yOffset+"px",Mb.body.appendChild(d)}},_showMenuItem:function(a,b){this._hideMenuItem(b);var c=Mb.createElement("div");b.menuItem.childrenDiv=c;var d=c.style;d.color="#000000",d.position="absolute";var e=this._width,f=b.offsetTop,g=b.menuItem.items;if(this._itemsShow=!0,b._itemsShow=!0,Ub.clear(c),this.renderMenu(c,g),0!==this._height){var h=Ub.windowWidth()-this._width-10,i=Ub.windowHeight()-10,j=this._getPosition(this._view);e=j.left+this._width>h?-this._width:e,f=j.top+f+g.length*this._menuItemHeight>i?f-(g.length-1)*this._menuItemHeight:f,d.left=e+"px",d.top=f+"px",b.appendChild(c)}},hide:function(){Mb.body.contains(this._view)&&Mb.body.removeChild(this._view),delete this._mouseOver,delete this._itemsShow,Ob.isTouchable&&Ub.removeEventListener("touchstart",Mb.body,this),Ub.removeEventListener("mousedown",Mb.body,this)},_hideMenuItem:function(a){var b=a.menuItem.childrenDiv;b&&a.contains(b)&&a.removeChild(b),this._itemsShow=!1,a._itemsShow=!1},dispose:function(){this._removeContextmenuListener(),this.hide()},onMenuShowing:function(a){return!0},onAction:function(a){},renderMenu:function(a,b){var c=a.style;c.background=this._background,c.border=this._border,c.width=this._width+"px",this._height=0,delete this._separator,a.menuItems=b;for(var d,e=0,f=b.length;f>e;e++)if(d=b[e],this.isVisible(d))if(d.separator===!0)this._separator=!0;else{var g=Mb.createElement("div");this.isEnabled(d)&&this._addMouseoverListener(g,d),g._itemsShow=!1,g.menuItem=d,a.appendChild(g),this.renderMenuItem(g,d),this.onMenuItemRendered(g,d),this._separator=!1,this._height+=this._menuItemHeight}},renderMenuItem:function(a,b){var c=a.style;c.height=this._menuItemHeight+"px",this._separator&&(c.borderTop="1px solid gray"),this.isEnabled(b)||(c.color=this._disabledColor);var d=Mb.createElement("span");c=d.style,c.position="absolute",c.width="25px",c.height=this._menuItemHeight+"px",c.lineHeight=this._menuItemHeight+"px",c.textAlign="center",a.appendChild(d);var e;if("check"===b.type?e=b.selected?this._checkboxSelectedIcon:this._checkboxUnselectedIcon:"radio"===b.type?e=b.selected?this._radiobuttonSelectedIcon:this._radiobuttonUnselectedIcon:b.icon&&(e=b.icon),e){var f=new Nb;f.src=Hb.getImageSrc(e),f.style.verticalAlign="middle",d.appendChild(f)}var g=Mb.createElement("label");if(Hb.setText(g,b.label,!0),c=g.style,c.position="absolute",c.height=this._menuItemHeight+"px",c.lineHeight=this._menuItemHeight+"px",c.left="25px",a.appendChild(g),b.items&&a.parentNode){var h=Mb.createElement("img");c=h.style,this.isEnabled(b)?h.setAttribute("src",Hb.getImageSrc(this._subMenuEnableIcon)):h.setAttribute("src",Hb.getImageSrc(this._subMenuDisableIcon));var i=(this._menuItemHeight-8)/2;c.marginTop=i+"px",c.right="5px",c.position="absolute",a.appendChild(h)}},onMenuItemRendered:function(a,b){},_addMouseoverListener:function(a,b){{var c=this;this._contextView}Ob.isTouchable&&(a.addEventListener("touchstart",function(d){a.style.background=c._focusBackground,a.style.color=c._focusColor,this===d.relatedTarget||this.contains(d.relatedTarget)||b.items&&!c._itemsShow&&a.parentNode==c._view&&c._showMenuItem(d,a)},!1),a.addEventListener("touchend",function(d){if(a.style.background=c._background,a.style.color=c._color,this!==d.relatedTarget&&!this.contains(d.relatedTarget)&&b.items&&a.parentNode===c._view){var e=d.clientX,f=d.clientY,g=b.childrenDiv,h=c._getPosition(g);(e<h.left+2||e>h.left+g.offsetWidth-2||f<h.top+2||f>h.top+g.offsetHeight-2)&&c._hideMenuItem(a)}},!1)),a.addEventListener("mouseenter",function(d){a.style.background=c._focusBackground,a.style.color=c._focusColor,this===d.relatedTarget||this.contains(d.relatedTarget)||b.items&&!this._itemsShow&&this.parentNode&&c._showMenuItem(d,this)},!1),a.addEventListener("mouseleave",function(a){if(this.style.background=c._background,this.style.color=c._color,this!==a.relatedTarget&&!this.contains(a.relatedTarget)&&b.items&&this.parentNode){var d=a.clientX,e=a.clientY,f=b.childrenDiv,g=c._getPosition(f);(d<g.left+2||d>g.left+f.offsetWidth-2||e<g.top+2||e>g.top+f.offsetHeight-2)&&c._hideMenuItem(this)}},!1)},_getPosition:function(a){for(var b=0,c=0;a;)c+=a.offsetLeft,b+=a.offsetTop,a=a.offsetParent;return{left:c,top:b}},_removeContextmenuListener:function(){var a=this._contextView;a&&(a=a.getView?a.getView():a,Ob.isTouchable?(a.removeEventListener("touchstart",this._getTouchStartListener(),!1),a.removeEventListener("touchmove",this._getTouchMoveListener(),!1),a.removeEventListener("touchend",this._getTouchEndListener(),!1),Ub.removeEventListener("contextmenu",a,this)):Ub.removeEventListener("contextmenu",a,this))},_handleContextmenu:function(a){this.onMenuShowing(a)===!0&&this.show(a),a.preventDefault()},_handleBodyClicked:function(a){if(Ob.isTouchable){for(var b=a.target;b&&b!==this._view;)b=b.parentElement;b!==this._view&&this.hide()}else this._mouseOver||this.hide()},_handleClick:function(a){if(0===a.button){for(var b=a.target;!b.menuItem&&b.parentElement;)b=b.parentElement;var c=b?b.menuItem:null;c&&this.isEnabled(c)&&("check"===c.type&&(c.selected=!c.selected),"radio"===c.type&&(c.groupName?(c.selected=!0,this._items.forEach(function(a){c!==a&&a.groupName===c.groupName&&(a.selected=!1),a.items&&a.items.forEach(function(a){c!==a&&a.groupName===c.groupName&&(a.selected=!1)})})):c.selected=!c.selected),c.action&&c.action(c),this.onAction(c),c.items&&c.items.length>0||this.hide())}},_getTouchStartListener:function(){if(!this._touchStartListener){var a=this;this._touchStartListener=function(b){a._touchMoved=!1,a._lastTouch=new Date}}return this._touchStartListener},_getTouchMoveListener:function(){if(!this._touchMoveListener){var a=this;this._touchMoveListener=function(b){a._touchMoved=!0}}return this._touchMoveListener},_getTouchEndListener:function(){if(!this._touchEndListener){var a=this;this._touchEndListener=function(b){!a._touchMoved&&(new Date).getTime()-a._lastTouch.getTime()>1e3&&a._handleContextmenu(b)}}return this._touchEndListener},getWidth:function(){return this._width},setWidth:function(a){this._width=a},getMenuItemHeight:function(){return this._menuItemHeight},setMenuItemHeight:function(a){this._menuItemHeight=a},getBackground:function(){return this._background},setBackground:function(a){this._background=a},getBorder:function(){return this._border},setBorder:function(a){this._border=a},getDisabledColor:function(){return this._disabledColor},setDisabledColor:function(a){this._disabledColor=a},getFocusColor:function(){return this._focusColor},setFocusColor:function(a){this._focusColor=a},getFocusBackground:function(){return this._focusBackground},setFocusBackground:function(a){this._focusBackground=a},getColor:function(){return this._color},setColor:function(a){this._color=a},getSubMenuEnableIcon:function(){return this._subMenuEnableIcon},setSubMenuEnableIcon:function(a){this._subMenuEnableIcon=a},getSubMenuDisableIcon:function(){return this._subMenuDisableIcon},setSubMenuDisableIcon:function(a){this._subMenuDisableIcon=a},getCheckboxSelectedIcon:function(){return this._checkboxSelectedIcon},setCheckboxSelectedIcon:function(a){this._checkboxSelectedIcon=a},getCheckboxUnselectedIcon:function(){return this._checkboxUnselectedIcon},setCheckboxUnselectedIcon:function(a){this._checkboxUnselectedIcon=a},getRadiobuttonSelectedIcon:function(){return this._radiobuttonSelectedIcon},setRadiobuttonSelectedIcon:function(a){this._radiobuttonSelectedIcon=a},getRadiobuttonUnselectedIcon:function(){return this._radiobuttonUnselectedIcon},setRadiobuttonUnselectedIcon:function(a){this._radiobuttonUnselectedIcon=a},getXOffset:function(){return this._xOffset},setXOffset:function(a){this._xOffset=a},getYOffset:function(){return this._yOffset},setYOffset:function(a){this._yOffset=a}}),Gb.charts.IS_INVALIDATE_PROPERTY={xZoom:1,xTranslate:1,yZoom:1,yTranslate:1},Gb.charts.ChartBase=function(a){Gb.charts.ChartBase.superClass.constructor.apply(this,arguments),this._uniqueColors={},this._nonDataColors={},this._publishedDatas=new md,this._view=Ub.createView("hidden"),this._canvas=Ub.createCanvas(),this._view.appendChild(this._canvas),this.setDataBox(a?a:new Gb.ElementBox),this.invalidate(),Ob.isTouchable?Ob.isMSTouchable?new Gb.charts.ChartMSTouchInteraction(this):(new Gb.charts.ChartTouchInteraction(this),new Gb.charts.ChartInteraction(this)):new Gb.charts.ChartInteraction(this),this.setToolTipEnabled(Dd.CHART_TOOLTIP_ENABLED)},Hb.ext("twaver.charts.ChartBase",Gb.controls.ViewBase,{__accessor:["xGap","yGap","xTranslate","yTranslate","valueVisible","sortFunction","visibleFunction","xTranslateEnabled","yTranslateEnabled","xZoomEnabled","yZoomEnabled","selectTolerance","backgroundVisible","backgroundFill","backgroundFillColor","backgroundOutlineWidth","backgroundOutlineColor","backgroundGradient","backgroundGradientColor","outerZoom"],__bool:["doubleClickToReset","focusOnClick"],_backgroundVisible:Dd.CHART_BACKGROUND_VISIBLE,_backgroundFill:Dd.CHART_BACKGROUND_FILL,_backgroundFillColor:Dd.CHART_BACKGROUND_FILL_COLOR,_backgroundOutlineWidth:Dd.CHART_BACKGROUND_OUTLINE_WIDTH,_backgroundOutlineColor:Dd.CHART_BACKGROUND_OUTLINE_COLOR,_backgroundGradient:Dd.CHART_BACKGROUND_GRADIENT,_backgroundGradientColor:Dd.CHART_BACKGROUND_GRADIENT_COLOR,_selectTolerance:Dd.CHART_SELECT_TOLERANCE,_doubleClickToReset:Dd.CHART_DOUBLE_CLICK_TO_RESET,_focusOnClick:Dd.FOCUS_ON_CLICK,_sortFunction:null,_visibleFunction:null,_canvasWidth:0,_canvasHeight:0,_outerZoomL:1,_xGap:Dd.CHART_XGAP,_yGap:Dd.CHART_YGAP,_xTranslate:0,_yTranslate:0,_xTranslateEnabled:Dd.CHART_XTRANSLATE_ENABLED,_yTranslateEnabled:Dd.CHART_YTRANSLATE_ENABLED,_xZoom:1,_yZoom:1,_maxZoom:Dd.ZOOM_MAX,_minZoom:Dd.ZOOM_MIN,_xZoomEnabled:Dd.CHART_XZOOM_ENABLED,_yZoomEnabled:Dd.CHART_YZOOM_ENABLED,_valueVisible:Dd.CHART_VALUE_VISIBLE,_valueFont:Dd.CHART_VALUE_FONT,isToolTipEnabled:function(){return this._toolTipListener?!0:!1},setToolTipEnabled:function(a){if(a){if(!this._toolTipListener){var b=this;this._toolTipListener=function(a){Ac.showToolTip(a,b.getToolTip(a))},this._canvas.addEventListener("mousemove",this._toolTipListener,!0),this.firePropertyChange("toolTipEnabled",!1,!0)}}else this._toolTipListener&&(Ac.hideToolTip(),this._canvas.removeEventListener("mousemove",this._toolTipListener,!0),delete this._toolTipListener,this.firePropertyChange("toolTipEnabled",!0,!1))},getToolTip:function(a){if(this._toolTipInfos){var b=this.getLogicalPoint(a);b.x-=this._xTranslate,b.y-=this._yTranslate;for(var c=this._toolTipInfos.size(),d=c-1;d>=0;d--){var e=this._toolTipInfos.get(d);if(e.rect&&Rb.containsPoint(e.rect,b))return this.getToolTipByData(e.data,e)}}else{var f=this.tryGetDataAt(a);if(f)return this.getToolTipByData(f,{value:this.getValue(f)})}return null},getToolTipByData:function(a,b){return void 0!==b.value?this.formatValueText(b.value,a):null},addToolTipInfo:function(a,b,c,d,e,f,g){this._toolTipInfos&&this._toolTipInfos.add({data:f,rect:{x:a,y:b,width:c,height:d},value:e,index:g})},getLogicalPoint:function(a){return Ub.getLogicalPoint(this._canvas,a,this._outerZoom)},getTextSize:function(a,b){var c=Vb.getTextSize(a,b);return c.width&&(c.width+=4),c},getUniqueColor:function(a,b){if(null==a)return null;var c;if(!b&&(c=this._nonDataColors[a]))return c;var d=Vb.getColorArray(a);if(!b)return c=255!=d[3]?a:"rgba("+d[0]+","+d[1]+","+d[2]+",0.99)",this._nonDataColors[a]=c,c;var e="rgb("+d[0]+","+d[1]+","+d[2]+")";if(void 0===this._uniqueColors[e]||this._uniqueColors[e]===b);else{var f=1,g=-1,h=1;for(Ob.isOpera&&(d=[d[0],d[1],d[2]]);;){if(d[0]+=f,d[0]>=255?(d[0]=255,f=-1):d[0]<=0&&(d[0]=0,f=1),e="rgb("+d[0]+","+d[1]+","+d[2]+")",void 0===this._uniqueColors[e]||this._uniqueColors[e]===b)break;if(d[1]+=g,d[1]>=255?(d[1]=255,g=-1):d[1]<=0&&(d[1]=0,g=1),e="rgb("+d[0]+","+d[1]+","+d[2]+")",void 0===this._uniqueColors[e]||this._uniqueColors[e]===b)break;if(d[2]+=h,d[2]>=255?(d[2]=255,h=-1):d[2]<=0&&(d[2]=0,h=1),e="rgb("+d[0]+","+d[1]+","+d[2]+")",void 0===this._uniqueColors[e]||this._uniqueColors[e]===b)break}}return this._uniqueColors[e]=b,e},tryGetDataAt:function(a,b){if((null==b||0>b)&&(b=this._selectTolerance),a.target&&(a=Ub.getLogicalPoint(this._canvas,arguments[0],this._outerZoom)),!a)return null;var c=a.x-b,d=a.y-b,e=2*b+1,f=2*b+1;try{for(var g=this._canvas.getContext("2d").getImageData(c,d,e,f).data,h=0,i=g.length;i>h;h+=4)if(255===g[h+3]){var j="rgb("+g[h]+","+g[h+1]+","+g[h+2]+")",k=this._uniqueColors[j];if(k)return k}}catch(l){}return null},_getPoint:function(){var a,b;if(2===arguments.length)a=arguments[0],b=arguments[1];else if(arguments[0].target){var c=Ub.getLogicalPoint(this._canvas,arguments[0],this._outerZoom);if(!c)return null;a=c.x,b=c.y}else a=arguments[0].x,b=arguments[0].y;return{x:a,y:b}},getDataAt:function(){var a=this._getPoint.apply(this,arguments),b=a.x,c=a.y;if(0>b||0>c||b>this._canvasWidth||c>this._canvasHeight)return null;try{var d=this._canvas.getContext("2d").getImageData(b,c,1,1).data;if(255===d[3]){var e="rgb("+d[0]+","+d[1]+","+d[2]+")",f=this._uniqueColors[e];if(f)return f}}catch(g){}return null},getBackgroundRect:function(){return this._backgroundRect},drawBackground:function(a,b){this._backgroundRect=Hb.clone(b),null!=b&&b.width>0&&b.height>0&&this._backgroundVisible&&(this._backgroundFill&&Vb.fill(a,this.getUniqueColor(this._backgroundFillColor),this._backgroundGradient,this.getUniqueColor(this._backgroundGradientColor),b),this._backgroundOutlineWidth>0&&(a.lineWidth=this._backgroundOutlineWidth,a.strokeStyle=this._backgroundOutlineColor),a.beginPath(),a.rect(b.x,b.y,b.width,b.height),a.closePath(),this._backgroundFill&&a.fill(),this._backgroundOutlineWidth>0&&a.stroke())},getName:function(a){return a.getName()},getColor:function(a){return a.getStyle?a.getStyle("chart.color"):a.getClient("chart.color")},getValue:function(a){return a.getStyle?a.getStyle("chart.value"):0},getValueColor:function(a){return a.getStyle?a.getStyle("chart.value.color"):Gb.Styles.getStyle("chart.value.color")},setValueFont:function(a){if(a!==this._valueFont){var b=a;this._valueFont=a,this.firePropertyChange("valueFont",b,a)}},getValueFont:function(a){if(a){var b=a.getStyle?a.getStyle("chart.value.font"):Gb.Styles.getStyle("chart.value.font");if(b)return b}return this._valueFont},formatValueText:function(a,b){return a},getCanvasWidth:function(){return this._canvasWidth},getCanvasHeight:function(){return this.canvasHeight},getCanvas:function(){return this._canvas},isVisible:function(a){return this._internalVisibleFunction&&!this._internalVisibleFunction(a)?!1:this._visibleFunction?this._visibleFunction(a):!0},onPropertyChanged:function(a){Gb.charts.IS_INVALIDATE_PROPERTY[a.property]?this.invalidate():this.invalidateModel()},getDataBox:function(){return this._box},setDataBox:function(a){if(!a)throw"DataBox can not be null";if(this._box!==a){var b=this._box;b&&(b.removeDataBoxChangeListener(this.handleDataBoxChange,this),b.removeDataPropertyChangeListener(this.handlePropertyChange,this),b.removeHierarchyChangeListener(this.handleHierarchyChange,this),this._selectionModel||b.getSelectionModel().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addDataBoxChangeListener(this.handleDataBoxChange,this),this._box.addDataPropertyChangeListener(this.handlePropertyChange,this),this._box.addHierarchyChangeListener(this.handleHierarchyChange,this),this._selectionModel?this._selectionModel._setDataBox(a):this._box.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this.invalidateModel(),this.firePropertyChange("dataBox",b,this._box)}},handleDataBoxChange:function(a){this.invalidateModel()},handlePropertyChange:function(a){this.invalidateModel()},handleHierarchyChange:function(a){this.invalidateModel()},handleSelectionChange:function(a){this.invalidateModel()},getUnfilteredDatas:function(){return this._unfilteredDatas?this._unfilteredDatas:this._publishedDatas},getPublishedDatas:function(){return this._publishedDatas},createPublishedDatas:function(){return this._unfilteredDatas=new md,this._buildChildren(this._box.getRoots(),this._unfilteredDatas),this._sortFunction&&this._unfilteredDatas.sort(this._sortFunction),this._unfilteredDatas.toList(this.isVisible,this)},_buildChildren:function(a,b){a.forEach(function(a){b.add(a),this._buildChildren(a.getChildren(),b)},this)},invalidateModel:function(){this._invalidateModel||(this._invalidateModel=!0,this.invalidate())},validateImpl:function(){this._invalidateModel&&(this._invalidateModel=!1,this._uniqueColors={},this._nonDataColors={},this._publishedDatas=this.createPublishedDatas(),this._publishedDatas.forEach(function(a){a.IStyle?a.getStyle("chart.color")||a.setStyle("chart.color",Hb.nextColor()):a.getClient("chart.color")||a.setClient("chart.color",Hb.nextColor())}),this.validateModel());var a=this._canvas.getContext("2d");this._canvasWidth=this._view.clientWidth,this._canvasHeight=this._view.clientHeight,this._canvas.setAttribute("width",this._canvasWidth),this._canvas.setAttribute("height",this._canvasHeight),a.clearRect(0,0,this._canvasWidth,this._canvasHeight),Gb.Util.makeHighRes(this._canvas),this._canvasWidth>0&&this._canvasHeight>0&&(a.translate(this._xTranslate,this._yTranslate),this._valueTexts=this._valueVisible?new md:null,this.validateDisplay(a,this._canvasWidth*this._xZoom,this._canvasHeight*this._yZoom),delete this._valueTexts,a.translate(-this._xTranslate,-this._yTranslate))},adjustBounds:function(a){Gb.charts.ChartBase.superClass.adjustBounds.apply(this,arguments)},validateModel:function(){},validateDisplay:function(a,b,c){},drawLine:function(a,b,c,d,e,f,g){c>0&&(a.lineWidth=c,a.strokeStyle=this.getUniqueColor(b),a.beginPath(),a.moveTo(d,e),a.lineTo(f,g),a.stroke())},drawValueTexts:function(a){this._valueTexts&&this._valueTexts.forEach(function(b){Vb.drawText(a,b.text,b,b.font,b.color)})},drawVerticalText:function(a,b,c,d,e){e=this.getUniqueColor(e),a.translate(c.x,c.y),a.rotate(-Math.PI/2),Vb.drawText(a,b,null,d,e),a.rotate(Math.PI/2),a.translate(-c.x,-c.y)},_getValueTextInfo:function(a,b){if(this._valueTexts){var c=this.formatValueText(b,a);if(c&&""!==c){var d=this.getValueColor(a),e={text:c,font:this.getValueFont(a),color:this.getUniqueColor(d,a)};return this._valueTexts.add(e),e}}return null},getMaxZoom:function(){return this._maxZoom},setMaxZoom:function(a){if(!(0>a)){var b=this._maxZoom;this._maxZoom=a,this.firePropertyChange("maxZoom",b,a),this.getXZoom()>a&&this.setXZoom(a,!1),this.getYZoom()>a&&this.setYZoom(a,!1)}},getMinZoom:function(){return this._minZoom},setMinZoom:function(a){if(!(0>a)){var b=this._minZoom;this._minZoom=a,this.firePropertyChange("minZoom",b,a),this.getXZoom()<a&&this.setXZoom(a),this.getYZoom()<a&&this.setYZoom(a)}},zoomIn:function(a){null==a&&(a=Dd.ZOOM_ANIMATE),a?Gb.animate.AnimateManager.start(new Gb.animate.AnimateXYZoom(this,this._xZoom*Dd.ZOOM_INCREMENT,this._yZoom*Dd.ZOOM_INCREMENT)):(this.xZoomIn(!1),this.yZoomIn(!1))},zoomOut:function(a){null==a&&(a=Dd.ZOOM_ANIMATE),a?Gb.animate.AnimateManager.start(new Gb.animate.AnimateXYZoom(this,this._xZoom/Dd.ZOOM_INCREMENT,this._yZoom/Dd.ZOOM_INCREMENT)):(this.xZoomOut(!1),this.yZoomOut(!1))},zoomReset:function(a){null==a&&(a=Dd.ZOOM_ANIMATE),a?Gb.animate.AnimateManager.start(new Gb.animate.AnimateXYZoom(this,1,1)):(this.xZoomReset(!1),this.yZoomReset(!1))},getXZoom:function(){return this._xZoom},onXZoomChanged:function(a,b){},xZoomIn:function(a){this.setXZoom(this._xZoom*Dd.ZOOM_INCREMENT,a)},xZoomOut:function(a){this.setXZoom(this._xZoom/Dd.ZOOM_INCREMENT,a)},xZoomReset:function(a){this.setXZoom(1,a)},setXZoom:function(a,b){if(Hb.num(a)&&!(0>=a)&&(a<this._minZoom&&(a=this._minZoom),a>this._maxZoom&&(a=this._maxZoom),a!==this.xZoom))if(null==b&&(b=Dd.ZOOM_ANIMATE),b)Gb.animate.AnimateManager.start(new Gb.animate.AnimateXZoom(this,a));else{var c=this._xZoom,d=this._xTranslate-(this._canvasWidth/2-this._xTranslate)/c*(a-c);this._xZoom=a,this.firePropertyChange("xZoom",c,a),this.onXZoomChanged(c,a),this.setXTranslate(d)}},getYZoom:function(){return this._yZoom},onYZoomChanged:function(a,b){},yZoomIn:function(a){this.setYZoom(this._yZoom*Dd.ZOOM_INCREMENT,a)},yZoomOut:function(a){this.setYZoom(this._yZoom/Dd.ZOOM_INCREMENT,a)},yZoomReset:function(a){this.setYZoom(1,a)},setYZoom:function(a,b){if(Hb.num(a)&&!(0>=a)&&(a<this._minZoom&&(a=this._minZoom),a>this._maxZoom&&(a=this._maxZoom),a!==this.YZoom))if(null==b&&(b=Dd.ZOOM_ANIMATE),b)Gb.animate.AnimateManager.start(new Gb.animate.AnimateYZoom(this,a));else{var c=this._yZoom,d=this._yTranslate-(this._canvasHeight/2-this._yTranslate)/c*(a-c);this._yZoom=a,this.firePropertyChange("yZoom",c,a),this.onYZoomChanged(c,a),this.setYTranslate(d)}}}),Gb.charts.ScaleChart=function(a){Gb.charts.ScaleChart.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.charts.ScaleChart",Gb.charts.ChartBase,{__accessor:["upperLimit","lowerLimit","xAxisText","xAxisLineColor","xAxisLineWidth","xAxisTextColor","xAxisTextFont","yAxisText","yAxisLineColor","yAxisLineWidth","yAxisTextColor","yAxisTextFont","xScaleTexts","xScaleTextFont","xScaleTextColor","xScaleTextOrientation","yScaleTextVisible","yScaleTextColor","yScaleTextFont","yScaleLineColor","yScaleLineWidth","yScaleValueGap","yScalePixelGap","yScaleMinTextVisible","valueSpanCount"],_reset:function(){this._map={},this._max=0,this._min=0,this._columnCount=this._xScaleTexts?this._xScaleTexts.size():0,null!=this._upperLimit&&(this._max=this._upperLimit),null!=this._lowerLimit&&(this._min=this._lowerLimit)},getMin:function(){return this._min},getMax:function(){return this._max},getRange:function(){return this._range},getColumnCount:function(){return this._columnCount},getColumnWidth:function(){return this._columnWidth},getValues:function(a){return a.getStyle?a.getStyle("chart.values"):null},formatYScaleText:function(a){return a.toFixed(2)},_initRange:function(){null==this._lowerLimit&&(this._min>=this._max&&(this._min=this._max-.1*Math.abs(this._max)),this._min=this._min-.1*(this._max-this._min)),this._range=this._max-this._min},_initValuesProportion:function(){this._publishedDatas.forEach(function(a){var b=this._map[a.getId()];b.values.forEach(function(a){b.proportions.add(null==a?null:0==this._range?0:a/this._range)},this)},this)},_commonValidateModel:function(){this._publishedDatas.forEach(function(a){var b=new md(this.getValues(a));b.size()>this._columnCount&&(this._columnCount=b.size());var c={data:a,values:b,proportions:new md,color:this.getUniqueColor(this.getColor(a),a)};this._initInfo&&this._initInfo(a,c),this._map[a.getId()]=c,(null==this._upperLimit||null==this._lowerLimit)&&b.forEach(function(a){null!=a&&(null==this._upperLimit&&a>this._max&&(this._max=a),null==this._lowerLimit&&a<this._min&&(this._min=a))},this)},this),this._initRange(),this._initValuesProportion()},validateDisplay:function(a,b,c){var d=0;this._xAxisText&&(d=this.getTextSize(this._xAxisTextFont,this._xAxisText).height);var e=0;this._xScaleTexts&&this._xScaleTexts.forEach(function(a){var b=this.getTextSize(this._xScaleTextFont,a),c="vertical"===this._xScaleTextOrientation?b.width:b.height;c>e&&(e=c)},this);var f=c-this._yGap-d-e,g=f-this._yGap,h=null==this._upperLimit?.9*g:g,i=0;this._yAxisText&&(i=this.getTextSize(this._yAxisTextFont,this._yAxisText).height);var j,k;this._yScaleValueGap>0?(j=Math.max(this._yScaleValueGap/this._range*h,1),k=this._yScaleValueGap):(j=Math.max(this._yScalePixelGap,1),k=this._range*(j/h));var l,m,n=0,o=new md;if(this._yScaleTextVisible){l=this._yScaleMinTextVisible?0:j;for(var p=this._min+(this._yScaleMinTextVisible?0:k);g+1>=l;){if(m=this.formatYScaleText(p)){var q=this.getTextSize(this._yScaleTextFont,m);q.width>n&&(n=q.width),o.add({text:m,size:q,cursor:l})}l+=j,p+=k}}var r={x:this._xGap+i+n,y:this._yGap,width:b-this._xGap-i-n-this._xGap,height:c-this._yGap-e-d-this._yGap};if(this.drawBackground(a,r),this._columnWidth=this._columnCount>0?r.width/(3*this._columnCount+1)*2:r.width/2,0===this._columnWidth&&(this._columnWidth=1),this._yScaleLineWidth>0)for(l=0;g+1>=l;)this.drawLine(a,this._yScaleLineColor,this._yScaleLineWidth,r.x,f-l,r.x+r.width,f-l),l+=j;this._xAxisText&&Vb.drawText(a,this._xAxisText,{x:r.x+r.width/2,y:f+e+d/2},this._xAxisTextFont,this.getUniqueColor(this._xAxisTextColor)),this._yAxisText&&this.drawVerticalText(a,this._yAxisText,{x:this._xGap+i/2,y:g/2+this._yGap},this._yAxisTextFont,this.getUniqueColor(this._yAxisTextColor)),this.drawLine(a,this._yAxisLineColor,this._yAxisLineWidth,r.x,r.y+r.height,r.x,r.y);var s=this.getUniqueColor(this._yScaleTextColor);o.forEach(function(b){var c={x:this._xGap+i+n-b.size.width/2,y:f-b.cursor};Vb.drawText(a,b.text,c,this._yScaleTextFont,s)},this);var t=r.y+r.height+e/2;s=this.getUniqueColor(this._xScaleTextColor);for(var u=this._xScaleLineWidth>0?this.getUniqueColor(this._xScaleLineColor):null,v=0;v<this._columnCount;v++){var w=r.x+this._columnWidth*(1+1.5*v);if(this._xScaleTexts&&v<this._xScaleTexts.size()&&(m=this._xScaleTexts.get(v))){var x={x:w,y:t};"vertical"===this._xScaleTextOrientation?this.drawVerticalText(a,m,x,this._yScaleTextFont,s):this._valueSpanCount?v%this._valueSpanCount==0&&Vb.drawText(a,m,x,this._xScaleTextFont,s):Vb.drawText(a,m,x,this._xScaleTextFont,s)}"default"!==this._type&&u&&(this._valueSpanCount?v%this._valueSpanCount==0&&this.drawLine(a,u,this._xScaleLineWidth,w,r.y+r.height,w,r.y):this.drawLine(a,u,this._xScaleLineWidth,w,r.y+r.height,w,r.y))}var y=f+this._min/k*j;this._publishedDatas.size()>0&&this._columnCount>0&&this.drawContent(a,r,h,y),this.drawLine(a,this._xAxisLineColor,this._xAxisLineWidth,r.x,r.y+r.height,r.x+r.width,r.y+r.height);

}}),Gb.charts.PieChart=function(a){this._sum=0,this._map={},Gb.charts.PieChart.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.charts.PieChart",Gb.charts.ChartBase,{__accessor:["type","selectOffset","startAngle","shadowColor","shadowOffset","lineRate","donutRate","valuePosition"],_type:Dd.PIECHART_TYPE,_lineRate:Dd.PIECHART_LINE_RATE,_donutRate:Dd.PIECHART_DONUT_RATE,_startAngle:Dd.PIECHART_START_ANGLE,_shadowColor:Dd.PIECHART_SHADOW_COLOR,_shadowOffset:Dd.PIECHART_SHADOW_OFFSET,_selectOffset:Dd.PIECHART_SELECT_OFFSET,_valuePosition:Dd.PIECHART_VALUE_POSITION,getSum:function(){return this._sum},validateModel:function(){this._sum=0,this._map={},this._publishedDatas.forEach(function(a){var b=this.getValue(a);this._map[a.getId()]={data:a,value:b,color:this.getUniqueColor(this.getColor(a),a)},this._sum+=b},this);var a=this._startAngle;this._publishedDatas.forEach(function(b){var c=this._map[b.getId()];c.proportion=0===this._sum?0:c.value/this._sum,"line"!==this._type&&(c.startAngle=a,c.arc=c.proportion*Math.PI*2,a+=c.arc)},this)},validateDisplay:function(a,b,c){var d={x:this._xGap,y:this._yGap,width:b-2*this._xGap,height:c-2*this._yGap};if(this.drawBackground(a,d),Rb.grow(d,-4,-4),!(d.width<=0||d.height<=0)){var e=this._shadowOffset;if(e>0&&(a.shadowOffsetX=e,a.shadowOffsetY=e,a.shadowBlur=1.5*e,a.shadowColor=this._shadowColor),"oval"===this._type||"circle"===this._type){var f=d.x+d.width/2,g=d.y+d.height/2,h=d.width/2,i=d.height/2;"circle"===this._type&&(h=i=Math.min(h,i)),this._publishedDatas.forEach(function(b){var c=this._map[b.getId()];if(0!==c.arc){var d=0,e=0;if(this.isSelected(b)){var j=c.startAngle+c.arc/2;d=Math.cos(j)*this._selectOffset,e=Math.sin(j)*this._selectOffset*i/h}a.fillStyle=c.color,a.beginPath(),a.moveTo(f+d,g-e),Vb.drawArc(a,f+d,g-e,c.startAngle,c.arc,h,i,!0),a.closePath(),a.fill();var k=this._getValueTextInfo(b,c.value);if(k){var j=c.startAngle+c.arc/2;k.x=f+d+Math.cos(j)*h*this._valuePosition,k.y=g-e-Math.sin(j)*i*this._valuePosition}}},this)}else if("donut"===this._type||"ovalDonut"===this._type){var f=d.x+d.width/2,g=d.y+d.height/2,h=d.width/2,i=d.height/2;"donut"===this._type&&(h=i=Math.min(h,i)),this._publishedDatas.forEach(function(b){var c=this._map[b.getId()];if(0!==c.arc){var d=0,e=0;if(this.isSelected(b)){var j=c.startAngle+c.arc/2;d=Math.cos(j)*this._selectOffset,e=Math.sin(j)*this._selectOffset*i/h}var k=f+Math.cos(c.startAngle)*h*this._donutRate,l=g-Math.sin(c.startAngle)*i*this._donutRate,m=f+Math.cos(c.startAngle+c.arc)*h*this._donutRate,n=g-Math.sin(c.startAngle+c.arc)*i*this._donutRate;a.fillStyle=c.color,a.beginPath(),a.moveTo(k+d,l-e),Vb.drawArc(a,f+d,g-e,c.startAngle,c.arc,h,i,!0),a.lineTo(m+d,n-e),Vb.drawArc(a,f+d,g-e,c.startAngle+c.arc,-c.arc,h*this._donutRate,i*this._donutRate,!0),a.closePath(),a.fill();var o=this._getValueTextInfo(b,c.value);if(o){var j=c.startAngle+c.arc/2,p=this._donutRate+(1-this._donutRate)*this._valuePosition;o.x=f+d+Math.cos(j)*h*p,o.y=g-e-Math.sin(j)*i*p}}},this)}else if("line"===this._type){var j=d.height*this._lineRate;d.y=d.y+d.height/2-j/2,d.height=j;var k=d.x;this._publishedDatas.forEach(function(b){var c=this._map[b.getId()],e=d.width*c.proportion;if(0!==e){a.beginPath(),a.fillStyle=c.color;var f=this.isSelected(b)?-this._selectOffset:0;a.rect(k,d.y+f,e,d.height),a.closePath(),a.fill();var g=this._getValueTextInfo(b,c.value);g&&(g.x=k+e/2,g.y=d.y+d.height+f-d.height*this._valuePosition),k+=e}},this)}this._shadowOffset>0&&(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0),this.drawValueTexts(a)}}}),Gb.charts.BarChart=function(a){Gb.charts.BarChart.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.charts.BarChart",Gb.charts.ScaleChart,{__accessor:["type"],_upperLimit:Dd.BARCHART_UPPER_LIMIT,_lowerLimit:Dd.BARCHART_LOWER_LIMIT,_type:Dd.BARCHART_TYPE,_xAxisText:null,_xAxisTextColor:Dd.BARCHART_XAXIS_TEXT_COLOR,_xAxisTextFont:Dd.BARCHART_XAXIS_TEXT_FONT,_xAxisLineColor:Dd.BARCHART_XAXIS_LINE_COLOR,_xAxisLineWidth:Dd.BARCHART_XAXIS_LINE_WIDTH,_yAxisText:null,_yAxisTextColor:Dd.BARCHART_YAXIS_TEXT_COLOR,_yAxisTextFont:Dd.BARCHART_YAXIS_TEXT_FONT,_yAxisLineColor:Dd.BARCHART_YAXIS_LINE_COLOR,_yAxisLineWidth:Dd.BARCHART_YAXIS_LINE_WIDTH,_xScaleTexts:null,_xScaleTextFont:Dd.BARCHART_XSCALE_TEXT_FONT,_xScaleTextColor:Dd.BARCHART_XSCALE_TEXT_COLOR,_xScaleTextOrientation:Dd.BARCHART_XSCALE_TEXT_ORIENTATION,_yScaleTextVisible:Dd.BARCHART_YSCALE_TEXT_VISIBLE,_yScaleTextColor:Dd.BARCHART_YSCALE_TEXT_COLOR,_yScaleTextFont:Dd.BARCHART_YSCALE_TEXT_FONT,_yScaleLineColor:Dd.BARCHART_YSCALE_LINE_COLOR,_yScaleLineWidth:Dd.BARCHART_YSCALE_LINE_WIDTH,_yScaleValueGap:Dd.BARCHART_YSCALE_VALUE_GAP,_yScalePixelGap:Dd.BARCHART_YSCALE_PIXEL_GAP,_yScaleMinTextVisible:Dd.BARCHART_YSCALE_MIN_TEXT_VISIBLE,validateModel:function(){var a=this._type+"ValidateModel";this[a]&&(this._reset(),this[a]())},defaultValidateModel:function(){this._columnCount=this._publishedDatas.size(),this._publishedDatas.forEach(function(a){var b=this.getValue(a);null==this._upperLimit&&b>this._max&&(this._max=b),null==this._lowerLimit&&b<this._min&&(this._min=b),this._map[a.getId()]={data:a,value:b,color:this.getUniqueColor(this.getColor(a),a)}},this),this._initRange(),this._publishedDatas.forEach(function(a){var b=this._map[a.getId()];b.proportion=0==this._range?0:b.value/this._range},this)},layerValidateModel:function(){this._commonValidateModel()},groupValidateModel:function(){this._commonValidateModel()},stackValidateModel:function(){if(this._publishedDatas.forEach(function(a){var b=new md(this.getValues(a));b.size()>this._columnCount&&(this._columnCount=b.size());var c={data:a,values:b,proportions:new md,color:this.getUniqueColor(this.getColor(a),a)};this._map[a.getId()]=c},this),null==this._upperLimit||null==this._lowerLimit)for(var a=0;a<this._columnCount;a++){var b=0,c=0;this._publishedDatas.forEach(function(d){var e=this._map[d.getId()];if(e.values.size()>a){var f=e.values.get(a);null!=f&&(f>=0?b+=f:c+=f)}},this),null==this._upperLimit&&b>this._max&&(this._max=b),null==this._lowerLimit&&c<this._min&&(this._min=c)}this._initRange(),this._initValuesProportion()},percentValidateModel:function(){this._publishedDatas.forEach(function(a){var b=new md(this.getValues(a));b.size()>this._columnCount&&(this._columnCount=b.size());var c={data:a,values:b,proportions:new md,color:this.getUniqueColor(this.getColor(a),a)};this._map[a.getId()]=c},this);for(var a=new md,b=0;b<this._columnCount;b++){var c=0;this._publishedDatas.forEach(function(a){var d=this._map[a.getId()];if(d.values.size()>b){var e=d.values.get(b);null!=e&&(c+=e)}},this),a.add(c)}for(var b=0;b<this._columnCount;b++)this._publishedDatas.forEach(function(c){var d=this._map[c.getId()],e=a.get(b);if(0!==e&&d.values.size()>b){var f=d.values.get(b);if(null!=f)return void d.proportions.add(f/e)}d.proportions.add(null)},this);this._min=0,this._max=1,this._range=1},drawRect:function(a,b,c,d,e,f,g){a.fillStyle=b,c&&this._selectInfos.add({x:d,y:e,w:f,h:g,color:this.getUniqueColor(Vb.darker(b))}),a.beginPath(),a.rect(d,e,f,g),a.closePath(),a.fill()},drawContent:function(a,b,c,d){this._selectInfos=new md,this._toolTipInfos=this.isToolTipEnabled()?new md:null,"default"===this._type?this.drawDefaultContent(a,b,c,d):"group"===this._type?this.drawGroupContent(a,b,c,d):"percent"===this._type?this.drawPercentContent(a,b,c,d):"stack"===this._type?this.drawStackContent(a,b,c,d):"layer"===this._type&&this.drawLayerContent(a,b,c,d),this.drawValueTexts(a),this._selectInfos.forEach(function(b){a.lineWidth=2,a.strokeStyle=b.color,a.beginPath(),a.rect(b.x,b.y,b.w,b.h),a.closePath(),a.stroke()},this),delete this._selectInfos},drawDefaultContent:function(a,b,c,d){for(var e=this._publishedDatas.size(),f=this._columnWidth,g=0;e>g;g++){var h=this._publishedDatas.get(g),i=this._map[h.getId()],j=b.x+f*(.5+1.5*g),k=Math.abs(c*i.proportion),l=i.proportion>0?d-k:d;this.drawRect(a,i.color,this.isSelected(h),j,l,f,k),this.addToolTipInfo(j,l,f,k,i.value,h);var m=this._getValueTextInfo(h,i.value);if(m){var n=this.getTextSize(m.font,m.text);m.x=j+f/2,m.y=l-n.height/2+1}}},drawPercentContent:function(a,b,c,d){this.drawStackContent(a,b,c,d)},drawStackContent:function(a,b,c,d){for(var e=this._columnCount,f=this._columnWidth,g=0;e>g;g++){var h=d,i=b.x+f*(.5+1.5*g);this._publishedDatas.forEach(function(b){var d=this._map[b.getId()];if(g<d.proportions.size()){var e=d.proportions.get(g);if(null!=e){var j=c*e;h-=j,this.drawRect(a,d.color,this.isSelected(b),i,h,f,j),this.addToolTipInfo(i,h,f,j,d.values.get(g),b);var k=this._getValueTextInfo(b,d.values.get(g));k&&(k.x=i+f/2,k.y=h+j/2)}}},this)}},drawLayerContent:function(a,b,c,d){for(var e=this._publishedDatas.size(),f=this._columnCount,g=this._columnWidth,h=3*g/8/e,i=0;f>i;i++){var j=b.x+g*(.5+1.5*i),k=0;this._publishedDatas.forEach(function(b){var f=this._map[b.getId()];if(i<f.proportions.size()){var l=f.proportions.get(i);if(null!=l){var m=c*l,n=d-m,o=j+g/2-g/8-h*(e-k),p=2*(g/8+h*(e-k));this.drawRect(a,f.color,this.isSelected(b),o,n,p,m),this.addToolTipInfo(o,n,p,m,f.values.get(i),b);var q=this._getValueTextInfo(b,f.values.get(i));if(q){var r=this.getTextSize(q.font,q.text);q.x=o+p/2,q.y=n-r.height/2+1}}}k++},this)}},drawGroupContent:function(a,b,c,d){for(var e=this._publishedDatas.size(),f=this._columnCount,g=this._columnWidth,h=g/e,i=0;f>i;i++){var j=b.x+g*(.5+1.5*i),k=0;this._publishedDatas.forEach(function(b){var e=this._map[b.getId()];if(i<e.proportions.size()){var f=e.proportions.get(i);if(null!=f){var g=c*f,l=d-g;this.drawRect(a,e.color,this.isSelected(b),j+h*k,l,h,g),this.addToolTipInfo(j+h*k,l,h,g,e.values.get(i),b);var m=this._getValueTextInfo(b,e.values.get(i));if(m){var n=this.getTextSize(m.font,m.text);m.x=j+h*k+h/2,m.y=l-n.height/2+1}}}k++},this)}}}),Gb.charts.LineChart=function(a){Gb.charts.LineChart.superClass.constructor.apply(this,arguments),this._selectTolerance=2},Hb.ext("twaver.charts.LineChart",Gb.charts.ScaleChart,{__accessor:["xScaleLineColor","xScaleLineWidth","interruptable"],_interruptable:Dd.LINECHART_INTERRUPTABLE,_upperLimit:Dd.LINECHART_UPPER_LIMIT,_lowerLimit:Dd.LINECHART_LOWER_LIMIT,_xAxisText:null,_xAxisTextColor:Dd.LINECHART_XAXIS_TEXT_COLOR,_xAxisTextFont:Dd.LINECHART_XAXIS_TEXT_FONT,_xAxisLineColor:Dd.LINECHART_XAXIS_LINE_COLOR,_xAxisLineWidth:Dd.LINECHART_XAXIS_LINE_WIDTH,_yAxisText:null,_yAxisTextColor:Dd.LINECHART_YAXIS_TEXT_COLOR,_yAxisTextFont:Dd.LINECHART_YAXIS_TEXT_FONT,_yAxisLineColor:Dd.LINECHART_YAXIS_LINE_COLOR,_yAxisLineWidth:Dd.LINECHART_YAXIS_LINE_WIDTH,_xScaleTexts:null,_xScaleTextFont:Dd.LINECHART_XSCALE_TEXT_FONT,_xScaleTextColor:Dd.LINECHART_XSCALE_TEXT_COLOR,_xScaleTextOrientation:Dd.LINECHART_XSCALE_TEXT_ORIENTATION,_xScaleLineColor:Dd.LINECHART_XSCALE_LINE_COLOR,_xScaleLineWidth:Dd.LINECHART_XSCALE_LINE_WIDTH,_valueSpanCount:Dd.LINECHART_VALUESPANCOUNT,_yScaleTextVisible:Dd.LINECHART_YSCALE_TEXT_VISIBLE,_yScaleTextColor:Dd.LINECHART_YSCALE_TEXT_COLOR,_yScaleTextFont:Dd.LINECHART_YSCALE_TEXT_FONT,_yScaleLineColor:Dd.LINECHART_YSCALE_LINE_COLOR,_yScaleLineWidth:Dd.LINECHART_YSCALE_LINE_WIDTH,_yScaleValueGap:Dd.LINECHART_YSCALE_VALUE_GAP,_yScalePixelGap:Dd.LINECHART_YSCALE_PIXEL_GAP,_yScaleMinTextVisible:Dd.LINECHART_YSCALE_MIN_TEXT_VISIBLE,getLineWidth:function(a){return a.getStyle?a.getStyle("chart.line.width"):Gb.Styles.getStyle("chart.line.width")},getMarkerShape:function(a){return a.getStyle?a.getStyle("chart.marker.shape"):Gb.Styles.getStyle("chart.marker.shape")},getMarkerSize:function(a){return a.getStyle?a.getStyle("chart.marker.size"):Gb.Styles.getStyle("chart.marker.size")},_initInfo:function(a,b){b.markerShape=this.getMarkerShape(a),b.markerSize=this.getMarkerSize(a),b.lineWidth=this.getLineWidth(a),this.isSelected(a)&&(b.lineWidth+=2)},validateModel:function(){this._reset(),this._commonValidateModel()},getPointIndexAt:function(){var a=this._getPoint.apply(this,arguments),b=this.tryGetDataAt(a);if(!b)return-1;for(var c,d=this._map[b.getId()],e=d.points,f=d.markerSize,g=0,h=e.size();h>g;g++)if(c=e.get(g),c&&Rb.getDistance(a,c)<=f)return g;return-1},drawContent:function(a,b,c,d){this._toolTipInfos=this.isToolTipEnabled()?new md:null,this._publishedDatas.forEach(function(e){var f=this._map[e.getId()],g=f.markerSize>0?new md:null;a.strokeStyle=f.color,a.lineWidth=f.lineWidth,a.beginPath();var h=f.proportions,i=null,j=h.size(),k=new md;f.points=k;for(var l=0;j>l;l++){var m=h.get(l);if(null!=m){var n={x:b.x+this._columnWidth*(1+1.5*l),y:d-c*m};k.add(n),null==i?a.moveTo(n.x,n.y):a.lineTo(n.x,n.y);var o=f.values.get(l),p=this._getValueTextInfo(e,o);if(p){var q=this.getTextSize(p.font,p.text);p.x=n.x,p.y=n.y-q.height/2+2}g&&g.add({point:n,value:o,data:e,index:l}),i=n}else this._interruptable&&(i=null,k.add(null))}if(a.stroke(),g){var r=f.markerSize/2;g.forEach(function(b){a.fillStyle=f.color;var c=b.point.x-r,d=b.point.y-r,e=f.markerSize,g=f.markerSize;Vb.drawVector(a,f.markerShape,null,c,d,e,g),a.fill(),this.addToolTipInfo(c,d,e,g,b.value,b.data,b.index)},this)}},this),this.drawValueTexts(a)}}),Gb.charts.BubbleChart=function(a){Gb.charts.BubbleChart.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.charts.BubbleChart",Gb.charts.ScaleChart,{__accessor:["xAxisUpperLimit","xAxisLowerLimit","xScaleLineColor","xScaleLineWidth","selectShadowColor","selectShadowOffset"],_upperLimit:Dd.BUBBLECHART_UPPER_LIMIT,_lowerLimit:Dd.BUBBLECHART_LOWER_LIMIT,_xAxisUpperLimit:Dd.BUBBLECHART_XAXIS_UPPER_LIMIT,_xAxisLowerLimit:Dd.BUBBLECHART_XAXIS_LOWER_LIMIT,_xAxisText:null,_xAxisTextColor:Dd.BUBBLECHART_XAXIS_TEXT_COLOR,_xAxisTextFont:Dd.BUBBLECHART_XAXIS_TEXT_FONT,_xAxisLineColor:Dd.BUBBLECHART_XAXIS_LINE_COLOR,_xAxisLineWidth:Dd.BUBBLECHART_XAXIS_LINE_WIDTH,_yAxisText:null,_yAxisTextColor:Dd.BUBBLECHART_YAXIS_TEXT_COLOR,_yAxisTextFont:Dd.BUBBLECHART_YAXIS_TEXT_FONT,_yAxisLineColor:Dd.BUBBLECHART_YAXIS_LINE_COLOR,_yAxisLineWidth:Dd.BUBBLECHART_YAXIS_LINE_WIDTH,_xScaleTexts:null,_xScaleTextFont:Dd.BUBBLECHART_XSCALE_TEXT_FONT,_xScaleTextColor:Dd.BUBBLECHART_XSCALE_TEXT_COLOR,_xScaleTextOrientation:Dd.BUBBLECHART_XSCALE_TEXT_ORIENTATION,_xScaleLineColor:Dd.BUBBLECHART_XSCALE_LINE_COLOR,_xScaleLineWidth:Dd.BUBBLECHART_XSCALE_LINE_WIDTH,_yScaleTextVisible:Dd.BUBBLECHART_YSCALE_TEXT_VISIBLE,_yScaleTextColor:Dd.BUBBLECHART_YSCALE_TEXT_COLOR,_yScaleTextFont:Dd.BUBBLECHART_YSCALE_TEXT_FONT,_yScaleLineColor:Dd.BUBBLECHART_YSCALE_LINE_COLOR,_yScaleLineWidth:Dd.BUBBLECHART_YSCALE_LINE_WIDTH,_yScaleValueGap:Dd.BUBBLECHART_YSCALE_VALUE_GAP,_yScalePixelGap:Dd.BUBBLECHART_YSCALE_PIXEL_GAP,_yScaleMinTextVisible:Dd.BUBBLECHART_YSCALE_MIN_TEXT_VISIBLE,_selectShadowColor:Dd.BUBBLECHART_SELECT_SHADOW_COLOR,_selectShadowOffset:Dd.BUBBLECHART_SELECT_SHADOW_OFFSET,_resetX:function(){this._xMax=0,this._xMin=0,null!=this._xAxisUpperLimit&&(this._xMax=this._xAxisUpperLimit),null!=this._xAxisLowerLimit&&(this._xMin=this._xAxisLowerLimit)},getXMin:function(){return this._xMin},getXMax:function(){return this._xMax},getXRange:function(){return this._xRange},getShape:function(a){return a.getStyle?a.getStyle("chart.bubble.shape"):Gb.Styles.getStyle("chart.bubble.shape")},getSize:function(a,b){return b},getNames:function(a){return a.getStyle?a.getStyle("chart.names"):Gb.Styles.getStyle("chart.names")},getXAxisValues:function(a){return a.getStyle?a.getStyle("chart.xaxis.values"):Gb.Styles.getStyle("chart.xaxis.values")},getYAxisValues:function(a){return a.getStyle?a.getStyle("chart.yaxis.values"):Gb.Styles.getStyle("chart.yaxis.values")},_initXRange:function(){null==this._xAxisLowerLimit&&(this._xMin>=this._xMax&&(this._xMin=this._xMax-.1*Math.abs(this._xMax)),this._xMin=this._xMin-.1*(this._xMax-this._xMin)),this._xRange=this._xMax-this._xMin},_initXYValuesProportion:function(){this._publishedDatas.forEach(function(a){var b=this._map[a.getId()];b.xAxisValues.forEach(function(a){b.xAxisProportions.add(null==a?null:0==this._xRange?0:a/this._xRange)},this),b.yAxisValues.forEach(function(a){b.yAxisProportions.add(null==a?null:0==this._range?0:a/this._range)},this)},this)},validateModel:function(){this._reset(),this._resetX(),this._columnCount=null==this._xScaleTexts?0:this._xScaleTexts.size(),this._publishedDatas.forEach(function(a){var b=new md(this.getYAxisValues(a)),c=new md(this.getXAxisValues(a)),d=new md(this.getValues(a));d.size()>this._columnCount&&(this._columnCount=d.size());var e={data:a,values:d,yAxisValues:b,xAxisValues:c,yAxisProportions:new md,xAxisProportions:new md,color:this.getUniqueColor(this.getColor(a),a),anchorShape:this.getShape(a)};this._map[a.getId()]=e,(null==this._upperLimit||null==this._lowerLimit)&&b.forEach(function(a){null!=a&&(null==this._upperLimit&&a>this._max&&(this._max=a),null==this._lowerLimit&&a<this._min&&(this._min=a))},this),(null==this._upperLimit||null==this._lowerLimit)&&c.forEach(function(a){null!=a&&(null==this._xAxisUpperLimit&&a>this._xMax&&(this._xMax=a),null==this._xAxisLowerLimit&&a<this._xMin&&(this._xMin=a))},this)},this),this._initRange(),this._initXRange(),this._initXYValuesProportion()},drawContent:function(a,b,c,d){this._toolTipInfos=this.isToolTipEnabled()?new md:null,this._publishedDatas.forEach(function(e){var f=this._map[e.getId()],g=f.yAxisProportions,h=f.xAxisProportions,i=f.values,j=f.yAxisProportions.size(),k=this._selectShadowOffset;this.isSelected(e)&&k>0?(a.shadowOffsetX=k,a.shadowOffsetY=k,a.shadowBlur=2*k,a.shadowColor=this._selectShadowColor):(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.shadowColor=f.color),a.fillStyle=f.color;for(var l=0;j>l;l++){var m=g.get(l),n=h.get(l);if(null!=m){var o={x:b.x+b.width*n,y:d-c*m},p=i.get(l),q=this.getSize(e,p),k=q/2,r=o.x-k,s=o.y-k,t=q,u=q;Vb.drawVector(a,f.anchorShape,null,r,s,t,u),a.fill(),this.addToolTipInfo(r,s,t,u,p,e,l);var v=this._getValueTextInfo(e,p);if(v){var q=this.getTextSize(v.font,v.text);v.x=o.x,v.y=o.y}}}},this),this.drawValueTexts(a)}}),Gb.charts.DialChart=function(a){Gb.charts.DialChart.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.charts.DialChart",Gb.charts.ChartBase,{__accessor:["upperLimit","lowerLimit","startAngle","endAngle","innerRadius","colorRangeFillColor","outlineWidth","outlineColor","majorScaleCount","majorScaleLineWidth","majorScaleLineLength","majorScaleLineColor","minorScaleCount","minorScaleLineWidth","minorScaleLineLength","minorScaleLineColor","scaleTextVisible","scaleUpperLimitTextVisible","scaleLowerLimitTextVisible","scaleTextFont","scaleTextColor","pivotRadius","pivotFillColor","pivotOutlineWidth","pivotOutlineColor","pivotGradient","pivotGradientColor","valuePosition","colorRangeList","innerDarkerRadius","outerBrighterRadius","selectShadowColor","selectShadowOffset"],__bool:["scaleInside","pivotFill"],_upperLimit:Dd.DIALCHART_UPPER_LIMIT,_lowerLimit:Dd.DIALCHART_LOWER_LIMIT,_startAngle:Dd.DIALCHART_START_ANGLE,_endAngle:Dd.DIALCHART_END_ANGLE,_innerRadius:Dd.DIALCHART_INNER_RADIUS,_colorRangeFillColor:Dd.DIALCHART_COLOR_RANGE_FILL_COLOR,_outlineWidth:Dd.DIALCHART_OUTLINE_WIDTH,_outlineColor:Dd.DIALCHART_OUTLINE_COLOR,_scaleInside:Dd.DIALCHART_SCALE_INSIDE,_majorScaleCount:Dd.DIALCHART_MAJOR_SCALE_COUNT,_majorScaleLineWidth:Dd.DIALCHART_MAJOR_SCALE_LINE_WIDTH,_majorScaleLineLength:Dd.DIALCHART_MAJOR_SCALE_LINE_LENGTH,_majorScaleLineColor:Dd.DIALCHART_MAJOR_SCALE_LINE_COLOR,_minorScaleCount:Dd.DIALCHART_MINOR_SCALE_COUNT,_minorScaleLineWidth:Dd.DIALCHART_MINOR_SCALE_LINE_WIDTH,_minorScaleLineLength:Dd.DIALCHART_MINOR_SCALE_LINE_LENGTH,_minorScaleLineColor:Dd.DIALCHART_MINOR_SCALE_LINE_COLOR,_scaleTextVisible:Dd.DIALCHART_SCALE_TEXT_VISIBLE,_scaleUpperLimitTextVisible:Dd.DIALCHART_SCALE_UPPER_LIMIT_TEXT_VISIBLE,_scaleLowerLimitTextVisible:Dd.DIALCHART_SCALE_LOWER_LIMIT_TEXT_VISIBLE,_scaleTextFont:Dd.DIALCHART_SCALE_TEXT_FONT,_scaleTextColor:Dd.DIALCHART_SCALE_TEXT_COLOR,_pivotRadius:Dd.DIALCHART_PIVOT_RADIUS,_pivotFill:Dd.DIALCHART_PIVOT_FILL,_pivotFillColor:Dd.DIALCHART_PIVOT_FILL_COLOR,_pivotOutlineWidth:Dd.DIALCHART_PIVOT_OUTLINE_WIDTH,_pivotOutlineColor:Dd.DIALCHART_PIVOT_OUTLINE_COLOR,_pivotGradient:Dd.DIALCHART_PIVOT_GRADIENT,_pivotGradientColor:Dd.DIALCHART_PIVOT_GRADIENT_COLOR,_valuePosition:Dd.DIALCHART_VALUE_POSITION,_innerDarkerRadius:Dd.DIALCHART_INNER_DARKER_RADIUS,_outerBrighterRadius:Dd.DIALCHART_OUTER_BRIGHTER_RADIUS,_selectShadowColor:Dd.DIALCHART_SELECT_SHADOW_COLOR,_selectShadowOffset:Dd.DIALCHART_SELECT_SHADOW_OFFSET,formatScaleText:function(a){return a.toFixed(2)},validateModel:function(){this._map={},this._valueRange=this._upperLimit-this._lowerLimit;var a=this._startAngle;0!=a&&(a=(a%360+360)%360,0==a&&(a=360)),this._positiveStartAngle=a;var b=this._endAngle;0!=b&&(b=(b%360+360)%360,0==b&&(b=360)),this._positiveEndAngle=b,this._whole=360==Math.abs(a-b),this._startAngleByRadian=a*Math.PI/180,this._endAngleByRadian=b*Math.PI/180,this._clockwise=this._startAngleByRadian>this._endAngleByRadian,this._angleRange=Math.abs(this._startAngleByRadian-this._endAngleByRadian),this._publishedDatas.forEach(function(a){var b=this.getValue(a);this._map[a.getId()]={data:a,value:b,color:this.getUniqueColor(this.getColor(a),a),angle:this._startAngleByRadian+(this._clockwise?-1:1)*b/this._valueRange*this._angleRange}},this)},validateDisplay:function(a,b,c){var d={x:this._xGap,y:this._yGap,width:b-2*this._xGap,height:c-2*this._yGap};if(this.drawBackground(a,d),this._startAngleByRadian!=this._endAngleByRadian){var e,f,g=this._lowerLimit,h=this._majorScaleCount>1?this._valueRange/(this._majorScaleCount-1):0,i=0,j=0,k=null,l=null;if(this._scaleTextVisible)for(k=new md,e=0;e<this._majorScaleCount;e++)0==e&&!this._scaleLowerLimitTextVisible||e==this._majorScaleCount-1&&!this._scaleUpperLimitTextVisible?(f=null,k.add({text:"",size:{width:0,height:0}})):(l=this.formatScaleText(g),f=this.getTextSize(this._scaleTextFont,l),k.add({text:l,size:f})),this._scaleInside||null==f||(f.width>i&&(i=f.width),f.height>j&&(j=f.height)),g+=h;if(this._angleRange<=Math.PI&&(i=Math.max(i,this._pivotRadius),j=Math.max(j,this._pivotRadius)),Rb.grow(d,-i,-j),this._calcluateCenterAndRadius(d),a.lineWidth=0,null==this._colorRangeList||0==this._colorRangeList.size())this._drawArcGroup(a,this._startAngleByRadian,this._endAngleByRadian,this.getUniqueColor(this._colorRangeFillColor)),this._drawArcOutLine(a,this._startAngleByRadian,this._endAngleByRadian,!0,!0);else{var m=this._angleRange/this._colorRangeList.size(),n=this._startAngleByRadian;for(e=0;e<this._colorRangeList.size();e++){var o=this.getUniqueColor(this._colorRangeList.get(e)),p=n+(this._clockwise?-1:1)*m;this._drawArcGroup(a,n,p,o),this._drawArcOutLine(a,n,n+(this._clockwise?-1:1)*m,0==e,e==this._colorRangeList.size()-1),n+=(this._clockwise?-1:1)*m}}var q,r,s,t,u,v,w,x,y=this._startAngleByRadian,z=this._majorScaleCount>1?this._angleRange/(this._majorScaleCount-1):0;for(v=this._scaleInside?this._innerRadiusByPixel:this._outerRadius,w=v+this._majorScaleLineLength*(this._scaleInside?1:-1),x=v+this._minorScaleLineLength*(this._scaleInside?1:-1),e=0;e<this._majorScaleCount;e++){if(r=this._center.x+Math.cos(y)*v,s=this._center.y+Math.sin(-y)*v,t=this._center.x+Math.cos(y)*w,u=this._center.y+Math.sin(-y)*w,a.lineWidth=this._majorScaleLineWidth,a.strokeStyle=this.getUniqueColor(this._majorScaleLineColor),a.beginPath(),a.moveTo(r,s),a.lineTo(t,u),a.closePath(),a.stroke(),this._scaleTextVisible)if(0==e&&!this._scaleLowerLimitTextVisible||e==this._majorScaleCount-1&&!this._scaleUpperLimitTextVisible);else{var A=k.get(e);if(A){var B=this.getScaleTextPosition(y/Math.PI*180,r,s,A.size.width,A.size.height);A.x=B.x,A.y=B.y}}if(this._whole||!this._whole&&e<this._majorScaleCount-1){var C=y,D=this._minorScaleCount>0?z/(this._minorScaleCount+1):0;for(q=0;q<this._minorScaleCount;q++)C+=(this._clockwise?-1:1)*D,r=this._center.x+Math.cos(C)*v,s=this._center.y+Math.sin(-C)*v,t=this._center.x+Math.cos(C)*x,u=this._center.y+Math.sin(-C)*x,a.lineWidth=this._minorScaleLineWidth,a.strokeStyle=this.getUniqueColor(this._minorScaleLineColor),a.beginPath(),a.moveTo(r,s),a.lineTo(t,u),a.closePath(),a.stroke()}y+=(this._clockwise?-1:1)*z}this._pivotFill&&Vb.fill(a,this.getUniqueColor(this._pivotFillColor),this._pivotGradient,this._pivotGradientColor,this._center.x-this._pivotRadius,this._center.y-this._pivotRadius,2*this._pivotRadius,2*this._pivotRadius),a.lineWidth=this._pivotOutlineWidth,a.strokeStyle=this.getUniqueColor(this._pivotOutlineColor),a.beginPath(),a.arc(this._center.x,this._center.y,this._pivotRadius,0,2*Math.PI,!0),a.closePath(),this._pivotFill&&a.fill(),k&&k.forEach(function(b){b&&Vb.drawText(a,b.text,b,this._scaleTextFont,this._scaleTextColor)},this),this._publishedDatas.forEach(function(b){var c=this._map[b.getId()],d=this._getDataStyle("dialchart.rear.extension",b),e=this._getDataStyle("dialchart.base.width",b),f=this._getDataStyle("dialchart.top.width",b),g=this._getDataStyle("dialchart.radius",b);g>=-1&&1>=g&&(g*=this._innerRadiusByPixel),a.fillStyle=c.color,a.lineWidth=0;var h=Rb.createMatrix(-c.angle,this._center.x,this._center.y),i=h.transform(this._center.x+g,this._center.y+f/2),j=h.transform(this._center.x+g,this._center.y-f/2),k=h.transform(this._center.x-d,this._center.y-e/2),l=h.transform(this._center.x-d,this._center.y+e/2),m=this._selectShadowOffset;this.isSelected(b)&&m>0?(a.shadowOffsetX=m,a.shadowOffsetY=m,a.shadowBlur=2*m,a.shadowColor=this._selectShadowColor):(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.shadowColor=c.color),a.beginPath(),a.moveTo(i.x,i.y),a.lineTo(j.x,j.y),a.lineTo(k.x,k.y),a.lineTo(l.x,l.y),a.lineTo(i.x,i.y),a.closePath(),a.fill();var n=this._getValueTextInfo(b,c.value);if(n){var o=h.transform(this._center.x+g*this._valuePosition,this._center.y);n.x=o.x,n.y=o.y}},this),this.drawValueTexts(a)}},_getDataStyle:function(a,b){return b.getStyle?b.getStyle(a):b.getClient(a)},_calcluateCenterAndRadius:function(a){{var b=this._clockwise?this._positiveEndAngle:this._positiveStartAngle,c=this._clockwise?this._positiveStartAngle:this._positiveEndAngle;Math.abs(this._positiveEndAngle-this._positiveStartAngle)}b>=0&&90>b?c>=0&&90>=c?(this._outerRadius=Math.min(a.width,a.height),this._center={x:a.x+(a.width-this._outerRadius)/2,y:a.y+(a.height+this._outerRadius)/2}):c>90&&180>=c?(this._outerRadius=Math.min(a.width/2,a.height),this._center={x:a.x+a.width/2,y:a.y+(a.height+this._outerRadius)/2}):(this._center={x:a.x+a.width/2,y:a.y+a.height/2},this._outerRadius=Math.min(a.width,a.height)/2):b>=90&&180>b?c>=90&&180>=c?(this._outerRadius=Math.min(a.width,a.height),this._center={x:a.x+(a.width+this._outerRadius)/2,y:a.y+(a.height+this._outerRadius)/2}):c>180&&270>=c?(this._outerRadius=Math.min(a.width,a.height/2),this._center={x:a.x+(a.width+this._outerRadius)/2,y:a.y+a.height/2}):(this._center={x:a.x+a.width/2,y:a.y+a.height/2},this._outerRadius=Math.min(a.width,a.height)/2):b>=180&&270>b?c>=180&&270>=c?(this._outerRadius=Math.min(a.width,a.height),this._center={x:a.x+(a.width+this._outerRadius)/2,y:a.y+(a.height-this._outerRadius)/2}):(this._outerRadius=Math.min(a.width/2,a.height),this._center={x:a.x+a.width/2,y:a.y+(a.height-this._outerRadius)/2}):(this._outerRadius=Math.min(a.width,a.height),this._center={x:a.x+(a.width-this._outerRadius)/2,y:a.y+(a.height-this._outerRadius)/2}),this._innerRadiusByPixel=this._innerRadius>1?this._innerRadius:this._outerRadius*this._innerRadius,this._innerDarkerRadiusByPixel=this._innerDarkerRadius>1?this._innerDarkerRadius:this._outerRadius*this._innerDarkerRadius,this._outerBrighterRadiusByPixel=this._outerBrighterRadius>1?this._outerBrighterRadius:this._outerRadius*this._outerBrighterRadius},_drawArcOutLine:function(a,b,c,d,e){if(!(this._outlineWidth<=0)){var f=Math.abs(b-c),g=this._center.x+Math.cos(b)*this._innerRadiusByPixel,h=this._center.y+Math.sin(-b)*this._innerRadiusByPixel,i=this._center.x+Math.cos(b)*this._outerRadius,j=this._center.y+Math.sin(-b)*this._outerRadius,k=this._center.x+Math.cos(c)*this._innerRadiusByPixel,l=this._center.y+Math.sin(-c)*this._innerRadiusByPixel,m=this._center.x+Math.cos(c)*this._outerRadius,n=this._center.y+Math.sin(-c)*this._outerRadius;this._clockwise?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor),a.beginPath(),a.moveTo(this._center.x,this._center.y),Vb.drawArc(a,this._center.x,this._center.y,c,f,this._outerRadius,this._outerRadius,!1),a.stroke(),!this._whole&&d?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor)):a.lineWidth=0,a.lineTo(g,h),a.stroke(),a.beginPath(),a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor),a.moveTo(this._center.x,this._center.y),Vb.drawArc(a,this._center.x,this._center.y,b,-f,this._innerRadiusByPixel,this._innerRadiusByPixel,!1),a.stroke(),!this._whole&&e?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor)):a.lineWidth=0,a.lineTo(m,n),a.stroke()):(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor),a.beginPath(),a.moveTo(this._center.x,this._center.y),Vb.drawArc(a,this._center.x,this._center.y,b,f,this._outerRadius,this._outerRadius,!1),a.stroke(),!this._whole&&e?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor)):a.lineWidth=0,a.lineTo(k,l),a.stroke(),a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor),a.beginPath(),a.moveTo(this._center.x,this._center.y),Vb.drawArc(a,this._center.x,this._center.y,c,-f,this._innerRadiusByPixel,this._innerRadiusByPixel,!1),a.stroke(),!this._whole&&d?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor)):a.lineWidth=0,a.lineTo(i,j),a.stroke())}},_drawArcGroup:function(a,b,c,d){0!=this._outerBrighterRadiusByPixel&&this._drawArc(a,b,c,this._outerRadius-this._outerBrighterRadiusByPixel,this._outerRadius,Vb.brighter(d)),this._drawArc(a,b,c,this._innerRadiusByPixel+this._innerDarkerRadiusByPixel,this._outerRadius-this._outerBrighterRadiusByPixel,d),0!=this._innerDarkerRadiusByPixel&&this._drawArc(a,b,c,this._innerRadiusByPixel,this._innerRadiusByPixel+this._innerDarkerRadiusByPixel,Vb.darker(d,20))},_drawArc:function(a,b,c,d,e,f){var g=Math.abs(b-c);a.lineWidth=0,a.fillStyle=f;{var h=this._center.x+Math.cos(b)*d,i=this._center.y+Math.sin(-b)*d,j=(this._center.x+Math.cos(b)*e,this._center.y+Math.sin(-b)*e,this._center.x+Math.cos(c)*d),k=this._center.y+Math.sin(-c)*d;this._center.x+Math.cos(c)*e,this._center.y+Math.sin(-c)*e}a.beginPath(),this._clockwise?(a.moveTo(j,k),Vb.drawArc(a,this._center.x,this._center.y,c,g,e,e,!0),a.lineTo(h,i),Vb.drawArc(a,this._center.x,this._center.y,b,-g,d,d,!0),a.closePath()):(a.moveTo(h,i),Vb.drawArc(a,this._center.x,this._center.y,b,g,e,e,!0),a.lineTo(j,k),Vb.drawArc(a,this._center.x,this._center.y,c,-g,d,d,!0),a.closePath()),a.fill()},getScaleTextPosition:function(a,b,c,d,e){a=(a%360+360)%360;var f={x:b,y:c};return 0==a&&(f=this._scaleInside?{x:b-d/2,y:c}:{x:b+d/2,y:c}),180==a&&(f=this._scaleInside?{x:b+d/2,y:c}:{x:b-d/2,y:c}),90==a&&(f=this._scaleInside?{x:b,y:c+e/2}:{x:b,y:c-e/2}),270==a&&(f=this._scaleInside?{x:b,y:c-e/2}:{x:b,y:c+e/2}),a>270&&360>a&&(f=this._scaleInside?{x:b-d/2,y:c-e/2}:{x:b+d/2,y:c+e/2}),a>180&&270>a&&(f=this._scaleInside?{x:b+d/2,y:c-e/2}:{x:b-d/2,y:c+e/2}),a>90&&180>a&&(f=this._scaleInside?{x:b+d/2,y:c+e/2}:{x:b-d/2,y:c-e/2}),a>0&&90>a&&(f=this._scaleInside?{x:b-d/2,y:c+e/2}:{x:b+d/2,y:c-e/2}),f}}),Gb.charts.RadarChart=function(a){Gb.charts.RadarChart.superClass.constructor.apply(this,arguments),this._selectTolerance=2},Hb.ext("twaver.charts.RadarChart",Gb.charts.ChartBase,{__accessor:["axisTextVisible","axisTextFont","axisTextColor","scaleTextVisible","scaleTextFont","scaleTextColor","axisVisible","axisLineColor","axisLineWidth","axisStartAngle","ringVisible","ringType","ringLineColor","ringLineWidth","scaleCount","scaleMaxValue","scaleMinValue","anchorVisible","areaFillAlpha","areaSelectFillAlpha","axisList"],__bool:["areaFill"],_axisTextVisible:Dd.RADARCHART_AXIS_TEXT_VISIBLE,_axisTextFont:Dd.RADARCHART_AXIS_TEXT_FONT,_axisTextColor:Dd.RADARCHART_AXIS_TEXT_COLOR,_scaleTextVisible:Dd.RADARCHART_SCALE_TEXT_VISIBLE,
_scaleTextFont:Dd.RADARCHART_SCALE_TEXT_FONT,_scaleTextColor:Dd.RADARCHART_SCALE_TEXT_COLOR,_axisVisible:Dd.RADARCHART_AXIS_VISIBLE,_axisLineColor:Dd.RADARCHART_AXIS_LINE_COLOR,_axisLineWidth:Dd.RADARCHART_AXIS_LINE_WIDTH,_axisStartAngle:Dd.RADARCHART_AXIS_START_ANGLE,_ringVisible:Dd.RADARCHART_RING_VISIBLE,_ringType:Dd.RADARCHART_RING_TYPE,_ringLineColor:Dd.RADARCHART_RING_LINE_COLOR,_ringLineWidth:Dd.RADARCHART_RING_LINE_WIDTH,_scaleCount:Dd.RADARCHART_SCALE_COUNT,_scaleMaxValue:Dd.RADARCHART_SCALE_MAXVALUE,_scaleMinValue:Dd.RADARCHART_SCALE_MINVALUE,_anchorVisible:Dd.RADARCHART_ANCHOR_VISIBLE,_areaFill:Dd.RADARCHART_AREA_FILL,_areaFillAlpha:Dd.RADARCHART_AREA_FILL_ALPHA,_areaSelectFillAlpha:Dd.RADARCHART_AREA_SELECT_FILL_ALPHA,getAxisCount:function(){return this._axisCount},formatScaleText:function(a,b){return a.toFixed(2)},getAnchorSize:function(a){return a.getStyle?a.getStyle("chart.marker.size"):Gb.Styles.getStyle("chart.marker.size")},getAnchorShape:function(a){return a.getStyle?a.getStyle("chart.marker.shape"):Gb.Styles.getStyle("chart.marker.shape")},getLineWidth:function(a){return a.getStyle?a.getStyle("chart.line.width"):Gb.Styles.getStyle("chart.line.width")},getValues:function(a){return a.getStyle?a.getStyle("chart.values"):null},tryGetDataAt:function(a,b){if((null==b||0>b)&&(b=this._selectTolerance),a.target&&(a=Ub.getLogicalPoint(this._canvas,arguments[0],1)),!a)return null;if(!this._areaFill){var c=a.x-b,d=a.y-b,e=2*b+1,f=2*b+1;try{for(var g=this._canvas.getContext("2d").getImageData(c,d,e,f).data,h=0,i=g.length;i>h;h+=4)if(255===g[h+3]){var j="rgb("+g[h]+","+g[h+1]+","+g[h+2]+")",k=this._uniqueColors[j];if(k)return k}}catch(l){}return null}if(!this._center)return null;a={x:a.x-this._xTranslate,y:a.y-this._yTranslate};for(var h=this._publishedDatas.size()-1;h>=0;h--){var k=this._publishedDatas.get(h),m=this._map[k.getId()],n=Rb.isPointInPolygon(m.points,a);if(n)return k}return null},getDataAt:function(){var a,b;if(2===arguments.length)a=arguments[0],b=arguments[1];else if(arguments[0].target){var c=Ub.getLogicalPoint(this._canvas,arguments[0],1);if(!c)return;a=c.x,b=c.y}else a=arguments[0].x,b=arguments[0].y;if(0>a||0>b||a>this._canvasWidth||b>this._canvasHeight)return null;if(!this._areaFill){try{var d=this._canvas.getContext("2d").getImageData(a,b,1,1).data;if(255===d[3]){var e="rgb("+d[0]+","+d[1]+","+d[2]+")",f=this._uniqueColors[e];if(f)return f}}catch(g){}return null}for(var h=this._publishedDatas.size()-1;h>=0;h--){var f=this._publishedDatas.get(h),i=this._map[f.getId()],j=Rb.isPointInPolygon(i.points,{x:a-this._xTranslate,y:b-this._yTranslate});if(j)return f}return null},validateModel:function(){if(this._map={},this._axisTexts=new md,this._axisMaxValues=new md,this._axisMinValues=new md,this._axisRangeValues=new md,this._axisCount=null==this._axisList?0:this._axisList.size(),0!=this._axisCount){this._averageAngleByRadian=2*Math.PI/this._axisCount,this._averageAngle=360/this._axisCount,this._axisList.forEach(function(a){if("string"==typeof a)this._axisTexts.add(a),this._axisMaxValues.add(this._scaleMaxValue),this._axisMinValues.add(this._scaleMinValue),this._axisRangeValues.add(this._scaleMaxValue-this._scaleMinValue);else{this._axisTexts.add(a.text);var b=isNaN(a.max)?this._scaleMaxValue:a.max,c=isNaN(a.min)?this._scaleMinValue:a.min;this._axisMaxValues.add(b),this._axisMinValues.add(c),this._axisRangeValues.add(b-c)}},this),this._publishedDatas.forEach(function(a){var b=new md(this.getValues(a)),c={data:a,values:b,proportions:new md,color:this.getUniqueColor(this.getColor(a),a),anchorShape:this.getAnchorShape(a),anchorSize:this.getAnchorSize(a),lineWidth:this.getLineWidth(a),points:new md};this.isSelected(a)&&(c.lineWidth+=2),this._map[a.getId()]=c},this);for(var a=0;a<this._axisCount;a++)this._publishedDatas.forEach(function(b){var c=this._map[b.getId()],d=0;if(c.values.size()>a){var e=c.values.get(a),f=this._axisMinValues.get(a),g=this._axisRangeValues.get(a);g>0&&(d=(e-f)/g)}c.proportions.add(d)},this)}},validateDisplay:function(a,b,c){var d={x:this._xGap,y:this._yGap,width:b-2*this._xGap,height:c-2*this._yGap};if(this.drawBackground(a,d),!(d.width<=0||d.height<=0||this._axisCount<3)){var e=0,f=0,g=0,h=null,i=null,j=null,k=null;if(this._axisTextVisible)for(k=new md,g=0;g<this._axisCount;g++)j=this._axisTexts.get(g),h=this.getTextSize(this._axisTextFont,j),k.add({text:j,size:h}),h.width>e&&(e=h.width),h.height>f&&(f=h.height);var l=d.width/2-e>d.height/2-f?d.height/2-2*f:d.width/2-e,m={x:d.x+d.width/2,y:d.y+d.height/2};this._center={x:m.x+this._xTranslate,y:m.y+this._yTranslate};var n=null;this._scaleTextVisible&&(n=new md);var o=this._axisStartAngle/180*Math.PI;for(g=0;g<this._axisCount;g++){var p=180*o/Math.PI,q=m.x+Math.cos(o)*l,r=m.y+Math.sin(-o)*l,s=null;n&&(s=new md,n.add(s)),this._ringVisible&&this._ringLineWidth>0&&(a.lineWidth=this._ringLineWidth,a.strokeStyle=this._ringLineColor);for(var t=1;t<=this._scaleCount;t++){var u=t/this._scaleCount,v=l*u,w=m.x+Math.cos(o)*v,x=m.y+Math.sin(-o)*v;if(this._ringVisible&&this._ringLineWidth>0){var y=m.x+Math.cos(o+this._averageAngleByRadian)*v,z=m.y+Math.sin(-o-this._averageAngleByRadian)*v;"line"==this._ringType?this.drawLine(a,this._ringLineColor,this._ringLineWidth,w,x,y,z):"arc"==this._ringType&&(a.beginPath(),a.moveTo(m.x,m.y),Vb.drawArc(a,m.x,m.y,o,this._averageAngleByRadian,v,v,!0),a.closePath(),a.stroke())}s&&(j=this.formatScaleText(this._axisMinValues.get(g)+this._axisRangeValues.get(g)*u,g),h=this.getTextSize(this._scaleTextFont,j),i=this.getScaleTextPosition(p,w,x,h.width,h.height),s.add({text:j,x:i.x,y:i.y}))}if(this._axisVisible&&this.drawLine(a,this._axisLineColor,this._axisLineWidth,m.x,m.y,q,r),k){var A=k.get(g);i=this.getAxisTextPosition(p,q,r,A.size.width,A.size.height),A.x=i.x,A.y=i.y}o+=this._averageAngleByRadian}this._publishedDatas.forEach(function(b){var c=this._map[b.getId()];c.points.clear();var d=c.anchorSize>0?new md:null,e=c.proportions;if(a.lineWidth=0,a.globalAlpha=this.isSelected(b)?this._areaSelectFillAlpha:this._areaFillAlpha,this._areaFill&&(a.fillStyle=c.color),this._drawItem(a,e,m,l,d,c),this._areaFill&&a.fill(),a.lineWidth=c.lineWidth,a.strokeStyle=c.color,a.globalAlpha=1,this._drawItem(a,e,m,l),a.lineWidth=0,null!=d&&d.size()>0){var f=c.anchorSize/2;d.forEach(function(b){a.fillStyle=c.color,Vb.drawVector(a,c.anchorShape,null,b.x-f,b.y-f,c.anchorSize,c.anchorSize),a.fill()})}},this),n&&n.forEach(function(b){b.forEach(function(b){Vb.drawText(a,b.text,b,this._scaleTextFont,this._scaleTextColor)},this)},this),k&&k.forEach(function(b){Vb.drawText(a,b.text,b,this._axisTextFont,this._axisTextColor)},this)}},_drawItem:function(a,b,c,d,e,f){var g=this._axisStartAngle/180*Math.PI,h=null;a.beginPath();for(var i=0;i<this._axisCount;i++){var j=b.get(i),k={x:c.x+Math.cos(g)*d*j,y:c.y+Math.sin(-g)*d*j};null==h?a.moveTo(k.x,k.y):a.lineTo(k.x,k.y),null!=e&&this._anchorVisible&&e.add(k),f&&f.points.add(k),0==i&&(h=k),g+=this._averageAngleByRadian}null!=h&&a.lineTo(h.x,h.y),a.closePath(),a.stroke()},getAxisTextPosition:function(a,b,c,d,e){a=(a%360+360)%360;var f={x:b,y:c};return 0==a&&(f={x:b+d/2,y:c}),180==a&&(f={x:b-d/2,y:c}),90==a&&(f={x:b,y:c-e/2}),270==a&&(f={x:b,y:c+e/2}),a>270&&360>a&&(f={x:b+d/2,y:c+e/2}),a>180&&270>a&&(f={x:b-d/2,y:c+e/2}),a>90&&180>a&&(f={x:b-d/2,y:c-e/2}),a>0&&90>a&&(f={x:b+d/2,y:c-e/2}),f},getScaleTextPosition:function(a,b,c,d,e){a=(a%360+360)%360;var f={x:b,y:c};return 0==a&&(f={x:b,y:c+e/2}),180==a&&(f={x:b-d/2,y:c+e/2}),90==a&&(f={x:b+d/2,y:c}),270==a&&(f={x:b+d/2,y:c}),a>270&&360>a&&(f={x:b+d/2,y:c-e/2}),a>180&&270>a&&(f={x:b-d/2,y:c-e/2}),a>90&&180>a&&(f={x:b-d/2,y:c+e/2}),a>0&&90>a&&(f={x:b+d/2,y:c+e/2}),f}}),Gb.charts.LegendPane=function(a){Gb.charts.LegendPane.superClass.constructor.apply(this,arguments),this._divPool=new Gb.Pool("div"),this._iconPool=new Gb.Pool("div"),this._textPool=new Gb.Pool("span"),this._pools.add(this._divPool),this._pools.add(this._iconPool),this._pools.add(this._textPool),this._chart=a,this._chart.addViewListener(this.handleViewChange,this),this._view=Ub.createView("hidden"),this._view.style.verticalAlign="middle",this._legendDiv=Ub.createDiv(),this._legendDiv.style.whiteSpace="nowrap",this._legendDiv.style.verticalAlign="middle",this._legendDiv.style.position="",this._view.appendChild(this._legendDiv),this._hiddenMap={};var b=this;this._chart._internalVisibleFunction=function(a){return!b.isHidden(a)},Ob.isTouchable&&new Gb.charts.LegendPaneTouchInteraction(this),new Gb.charts.LegendPaneInteraction(this)},Hb.ext("twaver.charts.LegendPane",Gb.controls.ControlBase,{__accessor:["iconWidth","iconHeight","iconRadius","rowHeight","orientation","hiddenColor","selectBackgroundColor","selectForegroundColor"],_iconWidth:Dd.LEGENDPANE_ICON_WIDTH,_iconHeight:Dd.LEGENDPANE_ICON_HEIGHT,_iconRadius:Dd.LEGENDPANE_ICON_RADIUS,_rowHeight:Dd.LEGENDPANE_ROW_HEIGHT,_orientation:Dd.LEGENDPANE_ORIENTATION,_hiddenColor:Dd.LEGENDPANE_HIDDEN_COLOR,_selectBackgroundColor:Dd.LEGENDPANE_SELECT_BACKGROUND_COLOR,_selectForegroundColor:Dd.LEGENDPANE_SELECT_FOREGROUND_COLOR,onPropertyChanged:function(a){this.invalidate()},getChart:function(){return this._chart},isHidden:function(a){return null!=this._hiddenMap[a.getId()]},handleViewChange:function(a){"validateEnd"===a.kind&&(this._invalidate=!0,this.validate())},validate:function(){if(this._invalidate){this._invalidate=!1,Ub.release(this._legendDiv),Hb.keys(this._hiddenMap).forEach(function(a){this._chart.getDataBox().containsById(a)||delete this._hiddenMap[a]},this);for(var a=new md(this._chart.getUnfilteredDatas()),b=0;b<a.size();b++){var c=a.get(b);this._chart.isVisible(c)||this.isHidden(c)||(a.removeAt(b),b--)}var d=a.size(),e=this._view.style,f="horizontal"===this._orientation;for(f?(e.textAlign="center",e.height=this._rowHeight+"px"):(e.textAlign="",e.height=this._rowHeight*d+"px"),e.lineHeight=this._rowHeight-2+"px",b=0;d>b;b++){var c=a.get(b),g=this._divPool.get();g._data=c,g.style.cursor="pointer",g.style.height=this._rowHeight+"px",g.style.display=f?"inline-block":"block",this._legendDiv.appendChild(g),this.renderLegend(g,c),this.onLegendRendered(g,c)}this._pools.forEach(function(a){a.clear()})}},renderLegend:function(a,b){var c=!this.isHidden(b),d=this._chart.isSelected(b),e=this._iconPool.get(),f=e.style;f.display="inline-block",f.verticalAlign="middle",f.marginLeft="4px",f.width=this.getIconWidth()+"px",f.height=this.getIconHeight()+"px",f.backgroundColor=c?this._chart.getColor(b):this.getHiddenColor(),a.appendChild(e);var g=this._textPool.get();f=g.style,f.paddingLeft="2px",f.paddingRight="4px",f.display="inline-block",f.verticalAlign="middle",f.color=c?d?this._selectForegroundColor:"":this.getHiddenColor(),g.innerHTML=this._chart.getName(b),a.appendChild(g),a.style.backgroundColor=c&&d?this._selectBackgroundColor:""},onLegendRendered:function(a,b){}}),Gb.charts.ChartPane=function(a,b,c,d){Gb.charts.ChartPane.superClass.constructor.apply(this,arguments),this.invalidate(),this._chart=a,this._legendPane=new Gb.charts.LegendPane(a),this._titleDiv=Ub.createDiv(),this._titleDiv.style.verticalAlign="middle",this._titleDiv.style.whiteSpace="nowrap",this._view=Ub.createView("hidden"),this._view.appendChild(this._titleDiv),this._view.appendChild(this._legendPane.getView()),this._view.appendChild(this._chart.getView());var e=this;this._legendPane.addPropertyChangeListener(function(a){("rowHeight"===a.property||"orientation"===a.porperty)&&e.invalidate()}),arguments.length>1&&this.setTitle(b),arguments.length>2&&this.setLegendOrientation(c),arguments.length>3&&this.setLegendWidth(d)},Hb.ext("twaver.charts.ChartPane",Gb.controls.ControlBase,{__accessor:["title","titleHorizontalAlign","titleHeight","legendWidth"],_title:null,_titleHeight:Dd.CHARTPANE_TITLE_HEIGHT,_titleHorizontalAlign:Dd.CHARTPANE_TITLE_HORIZONTAL_ALIGN,_legendOrientation:Dd.CHARTPANE_LEGEND_ORIENTATION,_legendWidth:Dd.CHARTPANE_LEGEND_WIDTH,getLegendOrientation:function(){return this._legendOrientation},setLegendOrientation:function(a){if(this._legendOrientation!==a){var b=this._legendOrientation;this._legendOrientation=a,this.firePropertyChange("orientation",b,a),this._adjustLegendOrientation()}},_adjustLegendOrientation:function(){this._legendPane.setOrientation("left"===this._legendOrientation||"right"===this._legendOrientation?"vertical":"horizontal")},onPropertyChanged:function(a){this.invalidate()},getTitleDiv:function(){return this._titleDiv},getChart:function(){return this._chart},getLegendPane:function(){return this._legendPane},validateImpl:function(){this._adjustLegendOrientation();var a,b=this._view.offsetWidth,c=this._view.offsetHeight,d=this._legendPane.getRowHeight();this._title&&""!==this._title?(a=this._titleHeight,this._titleDiv.innerHTML=this._title):(a=0,this._titleDiv.innerHTML=""),this._titleDiv.innerHTML=this._title?this._title:"",this._titleDiv.style.textAlign=this._titleHorizontalAlign,this._titleDiv.style.lineHeight=this._titleHeight-2+"px";var e=this._titleDiv.style;e.left="0px",e.top="0px",e.width=b+"px",e.height=a+"px";var f,g;"bottom"===this._legendOrientation?(f={x:0,y:a,width:b,height:Math.max(c-a-d,0)},g={x:0,y:Math.max(c-d,0),width:b,height:d}):"right"===this._legendOrientation?(f={x:0,y:a,width:Math.max(b-this._legendWidth,0),height:Math.max(c-a,0)},g={x:Math.max(b-this._legendWidth,0),y:a,width:this._legendWidth,height:Math.max(c-a,0)}):"top"===this._legendOrientation?(f={x:0,y:a+d,width:b,height:Math.max(c-a-d,0)},g={x:0,y:a,width:b,height:d}):"left"===this._legendOrientation&&(f={x:this._legendWidth,y:a,width:Math.max(b-this._legendWidth,0),height:Math.max(c-a,0)},g={x:0,y:a,width:this._legendWidth,height:Math.max(c-a,0)}),f&&this._chart.adjustBounds(f),g&&this._legendPane.adjustBounds(g)}}),Gb.charts.ChartInteraction=function(a){this.chart=a,this.canvas=a._canvas;var b=this;this.canvas.addEventListener("mousedown",function(a){0===a.button&&b.handleMouseDown(a),a.preventDefault()},!1);var c=Ob.isFirefox?"DOMMouseScroll":"mousewheel";this.canvas.addEventListener(c,function(a){b.handleMouseWheel(a)},!1)},Hb.ext("twaver.charts.ChartInteraction",Object,{handleMouseDown:function(a){this.chart.isFocusOnClick()&&Gb.Util.setFocus(this.canvas),this.lastPoint=this.chart.getLogicalPoint(a);var b=this.chart.tryGetDataAt(a);2===a.detail&&null==b?this.chart.isDoubleClickToReset()&&(this.chart.zoomReset(!1),this.chart.setXTranslate(0),this.chart.setYTranslate(0)):(this._startLogical=this.lastPoint,this._startClient=Ub.getClientPoint(a),Ub.handle_mousedown(this,a))},handleMouseMove:function(a){if(this.lastPoint){var b={x:this._startLogical.x+a.clientX-this._startClient.x,y:this._startLogical.y+a.clientY-this._startClient.y};!this.startPan&&Rb.getDistance(this.lastPoint,b)>3&&(this.startPan=!0,this.lastPoint=b),this.startPan&&(this.chart.isXTranslateEnabled()&&this.chart.setXTranslate(this.chart.getXTranslate()+b.x-this.lastPoint.x),this.chart.isYTranslateEnabled()&&this.chart.setYTranslate(this.chart.getYTranslate()+b.y-this.lastPoint.y),this.lastPoint=b)}},handleMouseUp:function(a){if(!this.startPan&&1===a.detail){var b=this.chart.tryGetDataAt(a),c=this.chart.getSelectionModel();b?Hb.isCtrlDown(a)?c.contains(b)?c.removeSelection(b):c.appendSelection(b):c.contains(b)||c.setSelection(b):Hb.isCtrlDown(a)||c.clearSelection()}delete this.lastPoint,delete this.startPan,delete this._startClient,delete this._startLogical},handleMouseWheel:function(a){Ub.preventDefault(a);var b=Ob.isFirefox?-a.detail:a.wheelDelta;b>0?(this.chart.isXZoomEnabled()&&this.chart.setXZoom(1.1*this.chart.getXZoom(),!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(1.1*this.chart.getYZoom(),!1)):0>b&&(this.chart.isXZoomEnabled()&&this.chart.setXZoom(this.chart.getXZoom()/1.1,!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(this.chart.getYZoom()/1.1,!1))}}),Gb.charts.ChartTouchInteraction=function(a){this.chart=a,this.canvas=a._canvas,Ub.addEventListener("touchstart","handleTouchstart",this.canvas,this)},Hb.ext("twaver.charts.ChartTouchInteraction",Object,{handleTouchstart:function(a){Ub.preventDefault(a),this.chart.isFocusOnClick()&&Gb.Util.setFocus(this.canvas),this.endPoint=this.chart.getLogicalPoint(a),yc.isMultiTouch(a)&&(this.distance=yc.getDistance(a),this.xZoom=this.chart.getXZoom(),this.yZoom=this.chart.getYZoom()),Ub.addEventListener("touchmove","handleTouchmove",this.canvas,this),Ub.addEventListener("touchend","handleTouchend",this.canvas,this)},handleTouchmove:function(a){if(Ub.preventDefault(a),this.endPoint){var b=this.chart.getLogicalPoint(a);if(!this.moved&&Rb.getDistance(this.endPoint,b)>10&&(this.moved=!0,this.lastPoint=b),this.moved)if(yc.isSingleTouch(a))this.endPoint&&(this.chart.isXTranslateEnabled()&&this.chart.setXTranslate(this.chart.getXTranslate()+b.x-this.endPoint.x),this.chart.isYTranslateEnabled()&&this.chart.setYTranslate(this.chart.getYTranslate()+b.y-this.endPoint.y),this.endPoint=b);else if(this.distance){var c=yc.getDistance(a)/this.distance,d=this.xZoom*c,e=this.yZoom*c;this.chart.isXZoomEnabled()&&this.chart.setXZoom(d,!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(e,!1)}}},handleTouchend:function(a){if(Ub.preventDefault(a),!this.moved){this.endPoint=this.chart.getLogicalPoint(a);var b=this.lastPoint&&this.lastTouchStartTime&&(new Date).getTime()-this.lastTouchStartTime.getTime()<=300&&Math.abs(this.endPoint.x-this.lastPoint.x)<=10&&Math.abs(this.endPoint.y-this.lastPoint.y)<=10;b?(this.lastPoint=null,this.lastTouchStartTime=null):(this.lastPoint=this.endPoint,this.lastTouchStartTime=new Date);var c=this.chart.tryGetDataAt(a);if(b&&null==c)this.chart.isDoubleClickToReset()&&(this.chart.zoomReset(!1),this.chart.setXTranslate(0),this.chart.setYTranslate(0));else{var d=this.chart.getSelectionModel();c?d.contains(c)||d.setSelection(c):d.clearSelection()}}delete this.endPoint,delete this.distance,delete this.xZoom,delete this.yZoom,delete this.moved,Ub.removeEventListener("touchmove",this.canvas,this),Ub.removeEventListener("touchend",this.canvas,this)}}),Gb.charts.ChartMSTouchInteraction=function(a){this.chart=a,this.canvas=a._canvas,this._pointerMap={},this._pointerIdArray=[],Ub.addEventListener("MSPointerDown","handleTouchstart",this.canvas,this),Ub.addEventListener("MSPointerMove","handleTouchmove",this.canvas,this),Ub.addEventListener("MSPointerUp","handleTouchend",this.canvas,this),Ub.addEventListener("MSPointerCancel","handleTouchend",this.canvas,this);var b=Ob.isFirefox?"DOMMouseScroll":"mousewheel";this.canvas.addEventListener(b,function(a){self.handleMouseWheel(a)},!1)},Hb.ext("twaver.charts.ChartMSTouchInteraction",Object,{handleTouchstart:function(a){this.chart.isFocusOnClick()&&Gb.Util.setFocus(this.canvas);var b=this.chart.getLogicalPoint(a);a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),!this._pointerMap[a.pointerId]&&b&&(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a);var c=this.chart.tryGetDataAt(a);if(1==this._pointerIdArray.length&&b){var d=this._startTouchPoint&&this._startTouchTime&&(new Date).getTime()-this._startTouchTime.getTime()<=500&&Rb.getDistance(this._startTouchPoint,b)<=10;d&&null==c?this.chart.isDoubleClickToReset()&&(this.chart.zoomReset(!1),this.chart.setXTranslate(0),this.chart.setYTranslate(0),this._startTouchPoint=null,this._startTouchTime=null,this._startClientPoint=null):(this._startTouchPoint=b,this._startTouchTime=new Date,this._startClientPoint={x:a.clientX,y:a.clientY},Ub.handle_mousedown(this,a))}else 2==this._pointerIdArray.length&&(this.xZoom=this.chart.getXZoom(),this.yZoom=this.chart.getYZoom(),this._distance=this._getDistance())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Rb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=3)&&(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length)){var b=this._getDistance()/this._distance,c=this.xZoom*b,d=this.yZoom*b;this.chart.isXZoomEnabled()&&this.chart.setXZoom(c,!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(d,!1)}},handleTouchend:function(a){var b=this.chart.getLogicalPoint(a);if(1==this._pointerIdArray.length&&b&&!this.moved){var c=this.chart.tryGetDataAt(a),d=this._startTouchPoint&&this._startTouchTime&&(new Date).getTime()-this._startTouchTime.getTime()<=500&&Rb.getDistance(this._startTouchPoint,b)<=10,e=this.chart.getSelectionModel();c&&d?Hb.isCtrlDown(a)?e.contains(c)?e.removeSelection(c):e.appendSelection(c):e.contains(c)||e.setSelection(c):Hb.isCtrlDown(a)||e.clearSelection()}this.moved=!1,this._pointerMap={},this._pointerIdArray=[]},handleMouseWheel:function(a){Ub.preventDefault(a);var b=Ob.isFirefox?-a.detail:a.wheelDelta;b>0?(this.chart.isXZoomEnabled()&&this.chart.setXZoom(1.1*this.chart.getXZoom(),!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(1.1*this.chart.getYZoom(),!1)):0>b&&(this.chart.isXZoomEnabled()&&this.chart.setXZoom(this.chart.getXZoom()/1.1,!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(this.chart.getYZoom()/1.1,!1))},handle_mousemove:function(a){if(1==this._pointerIdArray.length&&this._startTouchPoint&&this._startClientPoint){var b={x:this._startTouchPoint.x+(a.clientX-this._startClientPoint.x)/this.chart.getXZoom(),y:this._startTouchPoint.y+(a.clientY-this._startClientPoint.y)/this.chart.getYZoom()};Rb.getDistance(this._startTouchPoint,b)>3&&(this.moved=!0,this.chart.isXTranslateEnabled()&&this.chart.setXTranslate(this.chart.getXTranslate()+b.x-this._startTouchPoint.x),this.chart.isYTranslateEnabled()&&this.chart.setYTranslate(this.chart.getYTranslate()+b.y-this._startTouchPoint.y),this._startClientPoint.x=a.clientX,this._startClientPoint.y=a.clientY)}},handle_mouseup:function(a){this.handleTouchend(a)},_getDistance:function(){return Rb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Gb.charts.LegendPaneInteraction=function(a){this.legendPane=a;var b=this;this.legendPane._legendDiv.addEventListener("mousedown",function(a){b.handleMouseDown(a)},!1)},Hb.ext("twaver.charts.LegendPaneInteraction",Object,{handleMouseDown:function(a){if(0===a.button){var b=a.target._data;b||(b=a.target.parentNode._data),b&&(this.legendPane._hiddenMap[b.getId()]?delete this.legendPane._hiddenMap[b.getId()]:this.legendPane._hiddenMap[b.getId()]=b,this.legendPane._chart.invalidateModel())}}}),Gb.charts.LegendPaneTouchInteraction=function(a){this.legendPane=a,Ub.addEventListener("touchstart","handleTouchstart",this.legendPane._legendDiv,this)},Hb.ext("twaver.charts.LegendPaneTouchInteraction",Object,{handleTouchstart:function(a){Ub.preventDefault(a);var b=a.target._data;b||(b=a.target.parentNode._data),b&&(this.legendPane._hiddenMap[b.getId()]?delete this.legendPane._hiddenMap[b.getId()]:this.legendPane._hiddenMap[b.getId()]=b,this.legendPane._chart.invalidateModel())}}),Gb.network.Network=function(a){Gb.network.Network.superClass.constructor.apply(this,arguments),this._elementUIMap={},this._layerMap={},this._layerList=new md,this._view=Ub.createView("auto"),this._rootDiv=Ub.createDiv(),this._topDiv=Ub.createDiv(),this._attachmentDiv=Ub.createDiv(),this._layersDiv=Ub.createDiv(),this._bottomDiv=Ub.createDiv(),this._rootDiv.appendChild(this._bottomDiv),this._rootDiv.appendChild(this._layersDiv),this._rootDiv.appendChild(this._attachmentDiv),this._rootDiv.appendChild(this._topDiv),this._view.appendChild(this._rootDiv),this.setElementBox(a?a:new Gb.ElementBox),Ob.isTouchable?Ob.isMSTouchable?this.setMSTouchInteractions():this.setTouchInteractions():this.setDefaultInteractions(!1);var b=this;this._flowLink=function(){if(!(b.isMovingElement()||b.isSelectingElement()||b.isEditingElement()||b._box._layoutMovingElements)){b._flowLinkQuickFinder||(b._flowLinkQuickFinder=new Gb.QuickFinder(b._box,"link.flow","style"));var a=b._flowLinkQuickFinder.find(!0);a.forEach(function(a){a._styleMap["link.flow.offset"]=b.getLinkFlowOffset(a);var c=b.getElementUI(a);c.drawBody()})}},this.setToolTipEnabled(Dd.NETWORK_TOOLTIP_ENABLED),this._view.addEventListener("scroll",function(a){mc.twm(b)}),this.addPropertyChangeListener(function(a){"zoom"===a.property&&mc.twm(b)}),Gb.imageUtil.addEventListener(this.invalidateElementUIs,this)},Hb.ext("twaver.network.Network",Gb.controls.View,{__accessor:["selectMode","makeVisibleOnSelected","movableFunction","editPointSize","editPointFillColor","editPointOutlineWidth","editPointOutlineColor","editLineColor","editLineWidth","resizePointSize","resizePointFillColor","resizePointOutlineWidth","resizePointOutlineColor","resizeLineColor","resizeLineWidth","rotatePointSize","rotatePointFillColor","rotatePointOffset","rotatePointOutlineWidth","rotatePointOutlineColor","rotateScaleFillColor","rotateScaleFontColor","rotateScaleWidth","rotateScaleHeight","selectOutlineColor","selectOutlineWidth","selectFillColor","lazyMoveOutlineColor","lazyMoveOutlineWidth","lazyMoveFillColor","rectSelectFilter","selectionTolerance"],__bool:["doubleClickToUpSubNetwork","doubleClickToSubNetwork","doubleClickToEmptySubNetwork","doubleClickToLinkBundle","doubleClickToGroupExpand","subNetworkAnimate","lazyMoveAnimate","resizeAnimate","noAgentLinkVisible","keyboardRemoveEnabled","keyboardSelectEnabled","sendToTopOnSelected","lazyMoveFill","editingElement","rotatingElement","movingElement","selectingElement","rectSelectEnabled","limitElementInPositiveLocation","showRotateScale","transparentSelectionEnable"],_viewRect:{x:0,y:0,width:0,height:0},_currentSubNetwork:null,_selectMode:Dd.NETWORK_SELECT_MODE,_noAgentLinkVisible:Dd.NETWORK_NO_AGENT_LINK_VISIBLE,_makeVisibleOnSelected:Dd.NETWORK_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Dd.NETWORK_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Dd.NETWORK_KEYBOARD_SELECT_ENABLED,_rectSelectEnabled:Dd.NETWORK_RECT_SELECT_ENABLED,_rectSelectFilter:null,_subNetworkAnimate:Dd.NETWORK_SUBNETWORK_ANIMATE,_transparentSelectable:Dd.NETWORK_TRANSPARENT_SELECTABLE,_removeElementUIOnInvisible:Dd.NETWORK_REMOVE_ELEMENTUI_ON_INVISIBLE,_elementUIFunction:Dd.ELEMENTUI_FUNCTION,_doubleClickToUpSubNetwork:Dd.NETWORK_DOUBLECLICK_TO_UPSUBNETWORK,_doubleClickToSubNetwork:Dd.NETWORK_DOUBLECLICK_TO_SUBNETWORK,_doubleClickToEmptySubNetwork:Dd.NETWORK_DOUBLECLICK_TO_EMPTYSUBNETWORK,_doubleClickToLinkBundle:Dd.NETWORK_DOUBLECLICK_TO_LINKBUNDLE,_doubleClickToGroupExpand:Dd.NETWORK_DOUBLECLICK_TO_GROUPEXPAND,_sendToTopOnSelected:Dd.NETWORK_SENDTOTOP_ON_SELECTED,_selectOutlineColor:Dd.NETWORK_SELECT_OUTLINE_COLOR,_selectOutlineWidth:Dd.NETWORK_SELECT_OUTLINE_WIDTH,_selectFillColor:Dd.NETWORK_SELECT_FILL_COLOR,_lazyMoveOutlineColor:Dd.NETWORK_LAZYMOVE_OUTLINE_COLOR,_lazyMoveOutlineWidth:Dd.NETWORK_LAZYMOVE_OUTLINE_WIDTH,_lazyMoveFillColor:Dd.NETWORK_LAZYMOVE_FILL_COLOR,_lazyMoveFill:Dd.NETWORK_LAZYMOVE_FILL,_lazyMoveAnimate:Dd.NETWORK_LAZYMOVE_ANIMATE,_editPointSize:Dd.NETWORK_EDIT_POINT_SIZE,_editPointFillColor:Dd.NETWORK_EDIT_POINT_FILL_COLOR,_editPointOutlineColor:Dd.NETWORK_EDIT_POINT_OUTLINE_COLOR,_editPointOutlineWidth:Dd.NETWORK_EDIT_POINT_OUTLINE_WIDTH,_editLineColor:Dd.NETWORK_EDIT_LINE_COLOR,_editLineWidth:Dd.NETWORK_EDIT_LINE_WIDTH,_resizePointSize:Dd.NETWORK_RESIZE_POINT_SIZE,_resizePointFillColor:Dd.NETWORK_RESIZE_POINT_FILL_COLOR,_resizePointOutlineColor:Dd.NETWORK_RESIZE_POINT_OUTLINE_COLOR,_resizePointOutlineWidth:Dd.NETWORK_RESIZE_POINT_OUTLINE_WIDTH,_resizeLineColor:Dd.NETWORK_RESIZE_LINE_COLOR,_resizeLineWidth:Dd.NETWORK_RESIZE_LINE_WIDTH,_resizeAnimate:Dd.NETWORK_RESIZE_ANIMATE,_rotatePointSize:Dd.NETWORK_ROTATE_POINT_SIZE,_rotatePointFillColor:Dd.NETWORK_ROTATE_POINT_FILL_COLOR,_rotatePointOffset:Dd.NETWORK_ROTATE_POINT_OFFSET,_rotatePointOutlineWidth:Dd.NETWORK_ROTATE_POINT_OUTLINE_WIDTH,_rotatePointOutlineColor:Dd.NETWORK_ROTATE_POINT_OUTLINE_COLOR,_rotateScaleWidth:Dd.NETWORK_ROTATE_SCALE_WIDTH,_rotateScaleHeight:Dd.NETWORK_ROTATE_SCALE_HEIGHT,_rotateScaleFillColor:Dd.NETWORK_ROTATE_SCALE_FILL_COLOR,_rotateScaleFontColor:Dd.NETWORK_ROTATE_SCALE_FONT_COLOR,_limitElementInPositiveLocation:Dd.NETWORK_LIMIT_ELEMENT_INPOSITIVE_LOCATION,_linkFlowInterval:Dd.NETWORK_LINK_FLOW_INTERVAL,_selectionTolerance:Dd.NETWORK_SELECTION_TOLERANCE,_invalidate:!1,_invalidateElementVisibility:!1,_invalidateElementIndex:!1,_isEditingElement:!1,_isRotatingElement:!1,_isMovingElement:!1,_isSelectingElement:!1,_hasEditInteraction:!1,_showRotateScale:!0,_transparentSelectionEnable:Gb.Defaults.NETWORK_TRANSPARENT_SELECTION_ENABLE,getLabel:function(a){return a.getStyle("network.label")||a.getName()},isToolTipEnabled:function(){return this._toolTipEnabled?!0:!1},setToolTipEnabled:function(a){if(this._toolTipEnabled=a,a){if(!this._toolTipListener){var b=this;this._toolTipListener=function(a){var c=b.getElementAt(a);if(b._preElement!==c)if(b._preElement=c,c){var d=b.getToolTip(c);Ac.showToolTip({x:a.pageX,y:a.pageY},d);var e=Ac.getToolTipDiv();if(e.children.length>0){var f=b._view.getBoundingClientRect(),g=e.getBoundingClientRect();g.width+g.left>f.width+f.left&&(e.style.left=f.width+f.left-g.width+(Mb.documentElement.scrollLeft||Mb.body.scrollLeft)+"px"),g.height+g.top>f.height+f.top&&(e.style.top=f.height+f.top-g.height+(Mb.documentElement.scrollTop||Mb.body.scrollTop)+"px")}}else Ac.hideToolTip()},this._view.addEventListener("mousemove",this._toolTipListener,!0),this.firePropertyChange("toolTipEnabled",!1,!0)}}else this._toolTipListener&&(Ac.hideToolTip(),this._view.removeEventListener("mousemove",this._toolTipListener,!0),delete this._toolTipListener,this.firePropertyChange("toolTipEnabled",!0,!1))},isLinkFlowEnabled:function(){return this._linkFlowEnabled?!0:!1},setLinkFlowEnabled:function(a){a?(this._linkFlowEnabled||(this._linkFlowEnabled=!0,this.firePropertyChange("linkFlowEnabled",!1,!0)),clearInterval(this._linkFlowTimerId),this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval)):(this._linkFlowEnabled&&(this._linkFlowEnabled=!1,this.firePropertyChange("linkFlowEnabled",!0,!1)),clearInterval(this._linkFlowTimerId),delete this._linkFlowTimerId)},getLinkFlowInterval:function(){return this._linkFlowInterval},setLinkFlowInterval:function(a){var b=this._linkFlowInterval;this._linkFlowInterval=a,this.firePropertyChange("linkFlowInterval",b,a),clearInterval(this._linkFlowTimerId),this.isLinkFlowEnabled()&&(this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval))},getTopDiv:function(){return this._topDiv},getAttachmentDiv:function(){return this._attachmentDiv},getLayersDiv:function(){return this._layersDiv},getBottomDiv:function(){return this._bottomDiv},validateImpl:function(){if(mc.twm(this),this.__lics__){var a=0,b=null,c=null,d=null,e=this._invalidateElementVisibility;if(this._invalidateElementVisibility&&(this._invalidateElementVisibility=!1,this._removeElementUIOnInvisible&&(this._invalidateElementIndex=!0),this.forEachElementUI(function(e){e.validate();var f=e.getElement();if(e.setVisible(this.isVisible(f)),this._removeElementUIOnInvisible){if(b=this.getLayerDivByElement(f),e.isVisible()){if(e.getView().parentNode!==b)for(b.appendChild(e.getView()),c=e.getAttachments(),a=0;a<c.size();a++)d=c.get(a),d.isShowInAttachmentDiv()&&this._attachmentDiv.appendChild(d.getView())}else if(e.getView().parentNode===b)for(b.removeChild(e.getView()),c=e.getAttachments(),a=0;a<c.size();a++)d=c.get(a),d.isShowInAttachmentDiv()&&this._attachmentDiv.removeChild(d.getView())}else if(!e.getView().parentNode)for(b=this.getLayerDivByElement(f),b.appendChild(e.getView()),c=e.getAttachments(),a=0;a<c.size();a++)d=c.get(a),d.isShowInAttachmentDiv()&&this._attachmentDiv.appendChild(d.getView())},null,this)),this._invalidateElementIndex){this._invalidateElementIndex=!1;var f,g=this;this._box.getLayerBox().forEachByDepthFirst(function(a){var b,c=g._layerMap[a.getId()];g._box.forEachByLayer(function(a){var d=g._elementUIMap[a.getId()];if(d&&d.getView().parentNode===c){b=Ub.insertAfter(d.getView(),b);for(var e=d.getAttachments(),h=0;h<e.size();h++){
var i=e.get(h);i.getView().parentNode===g._attachmentDiv&&(f=Ub.insertAfter(i.getView(),f))}}},a)})}if(e&&!this._invalidateElementVisibility){var h;for(var i in this._elementUIMap){var j=this._elementUIMap[i];j.isVisible()&&(h=Rb.unionRect(h,j.getViewRect()))}if(h=h?{x:0,y:0,width:h.x+h.width,height:h.y+h.height}:{x:0,y:0,width:0,height:0},h.x!==this._viewRect.x||h.y!==this._viewRect.y||h.width!==this._viewRect.width||h.height!==this._viewRect.height){var k=this._viewRect;this._viewRect=h,this._rootDiv.style.left="0px",this._rootDiv.style.top="0px",this._rootDiv.style.width=h.width+"px",this._rootDiv.style.height=h.height+"px",this.firePropertyChange("viewRect",k,h)}}}},setInteractions:function(a){var b=this._interactions;b&&b.forEach(function(a){a.tearDown()}),this._interactions=a,a&&a.forEach(function(a){a.setUp()}),this.invalidateSelectedElementUIs(!0),this.firePropertyChange("interactions",b,a)},getInteractions:function(){return this._interactions},upSubNetwork:function(a,b){this._currentSubNetwork&&this.setCurrentSubNetwork(uc.getSubNetwork(this._currentSubNetwork),a,b)},sendToTop:function(a){if(this.isVisible(a)){for(var b=a;this.isVisible(b.getParent())&&(b=b.getParent()););b!==a&&this._box.adjustElementIndex(b),this._box.adjustElementIndex(a)}},invalidateElementIndex:function(){this._invalidateElementIndex||(this._invalidateElementIndex=!0,this.invalidate())},invalidateElementVisibility:function(){this._invalidateElementVisibility||(this._invalidateElementVisibility=!0,this.invalidate())},updateLayers:function(){Ub.clear(this._layersDiv),Ub.clear(this._attachmentDiv),this._layerMap={},this._layerList.clear();var a=this;this._box.getLayerBox().forEachByDepthFirst(function(b){var c=Ub.createDiv();Ub.setVisible(c,b.isVisible()),a._layerMap[b.getId()]=c,a._layersDiv.appendChild(c),a._layerList.add(b)}),this._box.forEach(this.createElementUI,this)},getCurrentSubNetwork:function(){return this._currentSubNetwork},setCurrentSubNetwork:function(a,b,c){var d=Gb.animate.AnimateManager;if(d.endAnimate(),b){if(this._currentSubNetwork===a)return;if(a&&!this._box.contains(a))throw a+" is not contained in this network's elementBox";d.start(new Gb.animate.AnimateSubNetwork(this,a,c))}else this._setCurrentSubNetwork(a),c&&c()},_setCurrentSubNetwork:function(a){if(this._currentSubNetwork!==a){if(a&&!this._box.contains(a))throw a+" is not contained in this network's elementBox";var b=this._currentSubNetwork;this._currentSubNetwork=a,this.firePropertyChange("currentSubNetwork",b,a),this.invalidateElementVisibility()}},isVisible:function(a){if(!this._box.contains(a))return!1;if(!a.isVisible())return!1;if(this._visibleFunction&&!this._visibleFunction(a))return!1;if(!this._box.getLayerBox().getLayerByElement(a).isVisible())return!1;if(uc.getSubNetwork(a)!==this._currentSubNetwork)return!1;if(a instanceof Gb.Link){if(!this.isNoAgentLinkVisible()){if(!a.getFromAgent()||!a.getToAgent())return!1;if(!this.isVisible(a.getFromAgent())||!this.isVisible(a.getToAgent()))return!1}if(a.getBundleIndex()>0&&a.getBundleCount()>1&&!a.getStyle("link.bundle.expanded"))return!1}else for(var b=a.getParent();b&&!b.ISubNetwork;){if(b instanceof Nd&&(!b.isExpanded()||!this.isVisible(b)))return!1;b=b.getParent()}return a.IDummy?!1:!0},isMovable:function(a){return this._box.contains(a)?a instanceof Gb.Link?!1:this._movableFunction&&!this._movableFunction(a)?!1:this._box.getLayerBox().getLayerByElement(a).isMovable():!1},isEditable:function(a){return this._box.contains(a)?this._editableFunction&&!this._editableFunction(a)?!1:this._box.getLayerBox().getLayerByElement(a).isEditable():!1},isRotatable:function(a){return this._rotatableFunction&&!this._rotatableFunction(a)?!1:!0},getVisibleFunction:function(){return this._visibleFunction},setVisibleFunction:function(a){var b=this._visibleFunction;this._visibleFunction=a,this.firePropertyChange("visibleFunction",b,a),this.invalidateElementVisibility()},getEditableFunction:function(){return this._editableFunction},setEditableFunction:function(a){var b=this._editableFunction;this._editableFunction=a,this.firePropertyChange("editableFunction",b,a),this.invalidateSelectedElementUIs(!0)},getRotatableFunction:function(){return this._rotatableFunction},setRotatableFunction:function(a){var b=this._rotatableFunction;this._rotatableFunction=a,this.firePropertyChange("rotatableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isLinkable:function(a){return null==this._linkableFunction||this._linkableFunction(a)},getLinkableFunction:function(){return this._linkableFunction},setLinkableFunction:function(a){var b=this._linkableFunction;this._linkableFunction=a,this.firePropertyChange("linkableFunction",b,a),this.invalidateSelectedElementUIs(!0)},onShareSelectionModelChanged:function(){this.invalidateElementUIs()},getElementBox:function(){return this._box},setElementBox:function(a){if(!a)throw"ElementBox can not be null";if(this._box!==a){var b=this._box;b&&(b.removeDataBoxChangeListener(this.handleElementBoxChange,this),b.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),b.removePropertyChangeListener(this.handleElementBoxPropertyChange,this),b.removeIndexChangeListener(this.handleIndexChange,this),b.getLayerBox().removeDataBoxChangeListener(this.handleLayerBoxChange,this),b.getLayerBox().removeDataPropertyChangeListener(this.handleLayerPropertyChange,this),b.getLayerBox().removeHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._selectionModel||b.getSelectionModel().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addDataBoxChangeListener(this.handleElementBoxChange,this),this._box.addDataPropertyChangeListener(this.handleElementPropertyChange,this),this._box.addPropertyChangeListener(this.handleElementBoxPropertyChange,this),this._box.addIndexChangeListener(this.handleIndexChange,this),this._box.getLayerBox().addDataBoxChangeListener(this.handleLayerBoxChange,this),this._box.getLayerBox().addDataPropertyChangeListener(this.handleLayerPropertyChange,this),this._box.getLayerBox().addHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._flowLinkQuickFinder&&(this._flowLinkQuickFinder.dispose(),this._flowLinkQuickFinder=new Gb.QuickFinder(this._box,"link.flow","style")),this._selectionModel?this._selectionModel._setDataBox(a):this._box.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this._elementUIMap={},this.updateLayers(),this.invalidateElementVisibility(),this.firePropertyChange("elementBox",b,this._box)}},invalidateElementUI:function(a,b){var c=this.getElementUI(a);c&&c.invalidate(b)},invalidateElementUIs:function(a){for(var b in this._elementUIMap){var c=this._elementUIMap[b];c.invalidate(a)}},invalidateSelectedElementUIs:function(a){this.getSelectionModel().getSelection().forEach(function(b){this.invalidateElementUI(b,a)},this)},getElementUI:function(a){return a?this._elementUIMap[a.getId()]:null},getLayerDivByElement:function(a){var b=this._box.getLayerBox().getLayerByElement(a);return b?this._layerMap[b.getId()]:null},createElementUI:function(a){var b=this._elementUIMap[a.getId()];if(b||(b=this._elementUIFunction(this,a),b&&(this._elementUIMap[a.getId()]=b)),b){var c=this.getLayerDivByElement(a);b.getView().parentNode!==c&&(c.appendChild(b.getView()),b.getAttachments().forEach(function(a){a.isShowInAttachmentDiv()&&a.getView().parentNode!==this._attachmentDiv&&this._attachmentDiv.appendChild(a.getView())},this)),this.invalidateElementIndex()}},invalidateBundleLink:function(a){if(a instanceof Gb.Link&&a._bundleLinks){var b=this._elementUIMap;a._bundleLinks.forEachSiblingLink(function(c){if(c!==a){var d=b[c._id];d&&d.invalidate(!1)}},this)}},handleLayerBoxChange:function(a){this.updateLayers(),this.invalidateElementVisibility()},handleLayerPropertyChange:function(a){var b=a.source;if("visible"===a.property){var c=this._layerMap[b.getId()];Ub.setVisible(c,b.isVisible())}else"editable"===a.property&&this.invalidateSelectedElementUIs(!0);this.invalidateElementVisibility()},handleLayerHierarchyChange:function(a){var b;this._layerList.clear(),this._box.getLayerBox().forEachByDepthFirst(function(a){var c=this._layerMap[a.getId()];b=Ub.insertAfter(c,b),this._layerList.add(a)},null,this),this.invalidateElementVisibility()},handleSelectionChange:function(a){a.datas.forEach(function(b){var c=this.getElementUI(b);c&&c.handleSelectionChange(a)},this),this.invalidateElementVisibility();var b=this.getSelectionModel().getLastData();b&&("append"===a.kind||"set"===a.kind)&&(this.isMakeVisibleOnSelected()&&this.makeVisible(b),this.isSendToTopOnSelected()&&this.sendToTop(b))},makeVisible:function(a){var b=this.getElementUI(a);if(b){var c=uc.getSubNetwork(a);if(c!==this._currentSubNetwork){var d=this;return void this.setCurrentSubNetwork(c,this.isSubNetworkAnimate(),function(){Hb.callLater(d.makeVisible,d,[a])})}for(var e=a;(e=e.getParent())&&e!==c;)e instanceof Nd&&e.setExpanded(!0);var f=b.getUnionBodyBounds();if(f){var g={x:this._view.scrollLeft/this._zoom,y:this._view.scrollTop/this._zoom,width:this._view.clientWidth/this._zoom,height:this._view.clientHeight/this._zoom};Rb.intersects(g,f)||this.isVisible(a)&&Hb.callLater(this.centerByLogicalPoint,this,[f.x+f.width/2,f.y+f.height/2])}}},handleElementBoxChange:function(a){var b=a.data;if("add"===a.kind)this.createElementUI(b),this.invalidateBundleLink(b);else if("remove"===a.kind){var c=this.getElementUI(b);if(c){var d=this._box.getLayerBox().getLayerByElement(b),e=this._layerMap[d.getId()];c.getView().parentNode===e&&e.removeChild(c.getView()),c.dispose(),delete this._elementUIMap[b.getId()]}b===this._currentSubNetwork&&null!=this._currentSubNetwork&&this._setCurrentSubNetwork(null)}else"clear"===a.kind&&(this.forEachElementUI(function(a){a.dispose()}),this._elementUIMap={},this.updateLayers(),null!=this._currentSubNetwork&&this._setCurrentSubNetwork(null));this.invalidateElementVisibility()},handleElementPropertyChange:function(a){var b=a.source,c=this.getElementUI(b);if(c&&(c.handlePropertyChange(a),"layerId"===a.property)){var d=this._box.getLayerBox().getLayerByElement(b),e=this._layerMap[d.getId()];c.getView().parentNode!==e&&(e.appendChild(c.getView()),this.invalidateElementIndex())}this.invalidateBundleLink(b),this.invalidateElementVisibility()},handleElementBoxPropertyChange:function(a){this.invalidateElementVisibility()},handleIndexChange:function(a){this.invalidateElementIndex()},getElementUIFunction:function(){return this._elementUIFunction},setElementUIFunction:function(a){if(!a)throw"ElementUIFunction can not be null";if(this._elementUIFunction!==a){var b=this._elementUIFunction;this._elementUIFunction=a,this.firePropertyChange("elementUIFunction",b,a),this._box.isEmpty()||this.updateLayers()}},getIconsNames:function(a){return a.getStyle("icons.names")},getIconsColors:function(a){return a.getStyle("icons.colors")},getLinkHandlerLabel:function(a){return a.isBundleAgent()?"+("+a.getBundleCount()+")":null},getSelectColor:function(a){return a.getStyle("select.color")},getShadowColor:function(a){var b=a.getStyle("shadow.color");return!b&&this.isSelected(a)&&"shadow"===a.getStyle("select.style")?a.getStyle("select.color"):b},getAlarmLabel:function(a){var b=a.getAlarmState().getHighestNewAlarmSeverity();if(b){var c=a.getAlarmState().getNewAlarmCount(b)+b.nickName;return a.getAlarmState().hasLessSevereNewAlarms()&&(c+="+"),c}return null},isRemoveElementUIOnInvisible:function(){return this._removeElementUIOnInvisible},setRemoveElementUIOnInvisible:function(a){var b=this._removeElementUIOnInvisible;this._removeElementUIOnInvisible=a,this.firePropertyChange("removeElementUIOnInvisible",b,a),this.invalidateElementVisibility()},setDefaultInteractions:function(a,b){var c=[new Gb.network.interaction.SelectInteraction(this),new Gb.network.interaction.MoveInteraction(this,a),new Gb.network.interaction.DefaultInteraction(this)];b&&c.push(new Gb.network.interaction.MoveLinkInteraction(this,a)),this.setInteractions(c)},setPanInteractions:function(){this.setInteractions([new Gb.network.interaction.PanInteraction(this),new Gb.network.interaction.DefaultInteraction(this)])},setEditInteractions:function(a,b){var c=[new Gb.network.interaction.SelectInteraction(this),new Gb.network.interaction.EditInteraction(this,a),new Gb.network.interaction.MoveInteraction(this,a),new Gb.network.interaction.DefaultInteraction(this)];b&&c.push(new Gb.network.interaction.MoveLinkInteraction(this,a)),this.setInteractions(c)},setCreateElementInteractions:function(a){this.setInteractions([new Gb.network.interaction.CreateElementInteraction(this,a),new Gb.network.interaction.DefaultInteraction(this)])},setCreateLinkInteractions:function(a){this.setInteractions([new Gb.network.interaction.CreateLinkInteraction(this,a),new Gb.network.interaction.DefaultInteraction(this)])},setCreateShapeLinkInteractions:function(a){this.setInteractions([new Gb.network.interaction.CreateShapeLinkInteraction(this,a),new Gb.network.interaction.DefaultInteraction(this)])},setCreateShapeNodeInteractions:function(a){this.setInteractions([new Gb.network.interaction.CreateShapeNodeInteraction(this,a),new Gb.network.interaction.DefaultInteraction(this)])},setTouchInteractions:function(){var a=[new Gb.network.interaction.SelectInteraction(this),new Gb.network.interaction.MoveInteraction(this,!1),new Gb.network.interaction.DefaultInteraction(this),new Gb.network.interaction.TouchInteraction(this)];this.setInteractions(a)},setMSTouchInteractions:function(){this.setInteractions([new Gb.network.interaction.MSTouchInteraction(this)])},setMagnifyInteractions:function(){this.setInteractions([new Gb.network.interaction.SelectInteraction(this),new Gb.network.interaction.MoveInteraction(this),new Gb.network.interaction.DefaultInteraction(this),new Gb.network.interaction.MagnifyInteraction(this)])},hasEditInteraction:function(){return this._hasEditInteraction},setHasEditInteraction:function(a){var b=this._hasEditInteraction;this._hasEditInteraction=a,this.firePropertyChange("hasEditInteraction",b,a)},moveSelectedElements:function(a,b,c,d){if(0!==a||0!==b){var e=this.getMovableSelectedElementsRect();null!=e&&(this._limitElementInPositiveLocation&&(e.x+a<0&&(a=-e.x),e.y+b<0&&(b=-e.y)),Gb.Util.moveElements(this.getMovableSelectedElements(),a,b,c,d,this))}},getMovableSelectedElements:function(){return this.getSelectionModel().toSelection(function(a){return this.isMovable(a)},this)},hasMovableSelectedElements:function(){for(var a=this.getSelectionModel().getSelection(),b=0;b<a.size();b++){var c=a.get(b);if(this.isMovable(c))return!0}return!1},getMovableSelectedElementsRect:function(){var a=this.getMovableSelectedElements();if(0===a.size())return null;for(var b=null,c=0,d=a.size();d>c;c++){var e=a.get(c);if(e instanceof Ld){var f=this.getElementUI(e);f&&(b=Rb.unionRect(b,f.getViewRect()))}}return b},getLayerByElement:function(a){return this._box.getLayerBox().getLayerByElement(a)},getPosition:function(a,b,c,d,e){var f,g=b instanceof Gb.network.ElementUI?b:this.getElementUI(b);if(g)if("from"===a||"to"===a){if(g.getFromPosition&&(f="from"===a?g.getFromPosition(d,e):g.getToPosition(d,e)))return{x:f.x-c.width/2,y:f.y-c.height/2}}else f="hotspot"===a?g.getHotSpot():Tb.get(a,g.getBodyRect(),c);if(!f&&b.getRect&&(f=Tb.get(a,b.getRect(),c)),f)return{x:f.x+d,y:f.y+e};throw"position '"+a+"' object '"+b+"'"},getViewRect:function(){return this._viewRect?Hb.clone(this._viewRect):{x:0,y:0,width:0,height:0}},forEachElementUI:function(a,b,c){b?this._box.forEachReverse(function(d){if(this.getLayerByElement(d)===b){var e=this.getElementUI(d);e&&(c?a.call(c,e):a(e))}},this):this._layerList.forEachReverse(function(b){this.forEachElementUI(a,b,c)},this)},findFirstElement:function(a,b){for(var c=this._layerList.size()-1,d=this._box.size()-1,e=c;e>=0;e--)for(var f=this._layerList.get(e),g=d;g>=0;g--){var h=this._box.getDataAt(g);if(this.getLayerByElement(h)===f)if(b){if(a.call(b,h)===!0)return h}else if(a(h)===!0)return h}return null},getElementAt:function(a,b){if(1===arguments.length&&(b=!0),!this.isValidEvent(a))return null;a=this._getPoint(a),a||console.log("null");var c=a.x,d=a.y,e=this._selectionTolerance;if(e&&e>0){var f={x:c,y:d,width:0,height:0};Rb.grow(f,e,e)}return this.findFirstElement(function(a){if(b&&!this.isSelectable(a))return!1;var e=this.getElementUI(a);return e?f?!!e.intersectsTest(f):!!e.hitTest(c,d):!1},this)},_getPoint:function(a){return a?a.target?this.getLogicalPoint(a):a:null},getElementsAtRect:function(a,b,c,d){var e=new md;return d=void 0===d?!0:d,this.forEachElementUI(function(f){f.isVisible()&&(!c||c(f._element))&&(d&&this.isSelectable(f._element)||!d)&&(b?f.intersectsTest(a)&&e.add(f._element):Rb.contains(a,f.getViewRect())&&e.add(f._element))},null,this),e},hitTest:function(a){var b=this.getElementAt(a);if(!b)return null;var c=this.getElementUI(b);return c?(a=this._getPoint(a),c.hitTest(a.x,a.y)):null},addElementByInteraction:function(a){a.getParent()||a.setParent(this._currentSubNetwork),this._box.add(a),this.getSelectionModel().setSelection(a),this.fireInteractionEvent({kind:"createElement",element:a})},getLinkFlowStepping:function(a){var b=parseInt(a.getStyle("link.flow.stepping"));return b||(b=Dd.NETWORK_LINK_FLOW_STEPPING),b},getLinkFlowOffset:function(a){var b=a.getStyle("link.flow.offset");return isNaN(b)&&(b=0),b+this.getLinkFlowStepping(a)},toCanvas:function(a,b,c){c||(c=Ub.createCanvas()),c.setAttribute("width",a),c.setAttribute("height",b),c._viewRect?(c._viewRect.width=a,c._viewRect.height=b):c._viewRect={x:0,y:0,width:a,height:b};var d=c.getContext("2d");if(d.clearRect(0,0,a,b),0===this._view.clientWidth||0===this._view.clientHeight)return c;var e=a/this._view.scrollWidth*this._zoom,f=b/this._view.scrollHeight*this._zoom;return d.scale(e,f),Ub.forEach(this._view,function(a){if(("CANVAS"===a.tagName||"IMG"===a.tagName)&&!a._isIgnored){var b=a._viewRect;if(b)try{d.drawImage(a,b.x,b.y,b.width,b.height)}catch(a){}}}),c},toCanvasByRegion:function(a,b,c){c||(c=Ub.createCanvas());var d=a.width*b,e=a.height*b;c.setAttribute("width",d),c.setAttribute("height",e);var f=c.getContext("2d");return f.clearRect(0,0,d,e),0===this._view.clientWidth||0===this._view.clientHeight?c:(f.save(),f.scale(b,b),Ub.forEach(this._view,function(b){if(("CANVAS"===b.tagName||"IMG"===b.tagName)&&!b._isIgnored){var c=b._viewRect;if(c&&Rb.intersects(c,a))try{f.drawImage(b,c.x-a.x,c.y-a.y,c.width,c.height)}catch(b){}}}),f.restore(),c)},getGroupChildrenRects:function(a){var b=new md;return a.getChildren().forEach(function(a){if(a instanceof Ld){var c=this.getElementUI(a);if(c){var d=c.getViewRect();d&&b.add(d)}}},this),b},getLinkPathFunction:function(){return this._linkPathFunction},setLinkPathFunction:function(a){var b=this._linkPathFunction;this._linkPathFunction=a,this.firePropertyChange("linkPathFunction",b,a),this.invalidateElementUIs()},onClickElement:function(a,b){},onClickBackground:function(a){},onDoubleClickElement:function(a,b){},onDoubleClickBackground:function(a){},onLongClickElement:function(a,b){},onLongClickBackground:function(a){},onMouseMove:function(a,b){},onMouseEnter:function(a,b){},onMouseLeave:function(a,b){},setMovingElement:function(a){if(a!=this._movingElement){var b=this._movingElement;this._movingElement=a,this.firePropertyChange("movingElement",b,a),this._box._undoManager._enabled&&(a?this._box._undoManager.startBatch():this._box._undoManager.endBatch())}},setEditingElement:function(a){if(a!=this._editingElement){var b=this._editingElement;this._editingElement=a,this.firePropertyChange("editingElement",b,a),this._box._undoManager._enabled&&(a?this._box._undoManager.startBatch():this._box._undoManager.endBatch())}},dispose:function(){Gb.imageUtil.removeEventListener(this.invalidateElementUIs,this)}}),Gb.network.Overview=function(a){Gb.network.Overview.superClass.constructor.apply(this,arguments),this._view=Ub.createView(),this._rootDiv=Ub.createDiv(),this._imageCanvas=Ub.createCanvas(),this._imageDiv=Ub.createDiv(),this._maskCanvas=Ub.createCanvas(),this._selectDiv=Ub.createDiv(),this._isNetworkDirty=!1,this._isMaskDirty=!1,Ub.setVisible(this._selectDiv,!1),this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._imageDiv),this._rootDiv.appendChild(this._maskCanvas),this._rootDiv.appendChild(this._selectDiv),this._imageDiv.appendChild(this._imageCanvas),this.setNetwork(a),Ob.isTouchable?Ob.isMSTouchable?new Gb.network.OverviewMSTouchInteraction(this):(new Gb.network.OverviewTouchInteraction(this),new Gb.network.OverviewInteraction(this)):new Gb.network.OverviewInteraction(this)},Hb.ext("twaver.network.Overview",Gb.controls.ControlBase,{__accessor:["fillColor","outlineColor","outlineWidth","selectColor","selectWidth","padding","maxPackingWidth","maxPackingHeight"],__bool:["animate"],_fillColor:Dd.OVERVIEW_FILL_COLOR,_outlineColor:Dd.OVERVIEW_OUTLINE_COLOR,_outlineWidth:Dd.OVERVIEW_OUTLINE_WIDTH,_selectColor:Dd.OVERVIEW_SELECT_COLOR,_selectWidth:Dd.OVERVIEW_SELECT_WIDTH,_padding:Dd.OVERVIEW_PADDING,_animate:Dd.OVERVIEW_ANIMATE,_maxPackingWidth:Dd.OVERVIEW_MAX_PACKING_WIDTH,_maxPackingHeight:Dd.OVERVIEW_MAX_PACKING_HEIGHT,getNetwork:function(){return this._network},onPropertyChanged:function(a){this._invalidateMask()},setNetwork:function(a){a!==this._network&&(this._network&&(this._network.removePropertyChangeListener(this._handleNetworkPropertyChange,this),this._network.removeViewListener(this._handleNetworkViewChange,this),Ub.removeEventListener("scroll","_handleScrollChange",this._network.getView(),this)),this._network=a,this._network&&(this._network.addPropertyChangeListener(this._handleNetworkPropertyChange,this),this._network.addViewListener(this._handleNetworkViewChange,this),Ub.addEventListener("scroll","_handleScrollChange",this._network.getView(),this)),this.invalidate())},_handleNetworkPropertyChange:function(a){("zoom"===a.property||"currentSubNetwork"===a.property||"elementBox"===a.property||"dataBox"===a.property)&&this.invalidate()},_handleNetworkViewChange:function(a){"validateEnd"===a.kind&&this.invalidate()},_handleScrollChange:function(){this._invalidateMask()},invalidate:function(a){this._isNetworkDirty&&this._isMaskDirty||(this._isNetworkDirty||(this._isNetworkDirty=!0),this._isMaskDirty||(this._isMaskDirty=!0),Hb.callLater(this.validate,this,null,a))},_invalidateMask:function(){this._isMaskDirty||(this._isMaskDirty=!0,Hb.callLater(this.validate,this,[],100))},validate:function(){if((this._isMaskDirty||this._isNetworkDirty)&&this._network&&(this._maxPackingWidth>0&&this._maxPackingHeight>0||this._view.clientWidth>0&&this._view.clientHeight>0)&&0!==this._network._view.clientWidth&&0!==this._network._view.clientHeight){var a,b=this._maxPackingWidth>0&&this._maxPackingHeight>0;a=b?{x:0,y:0,width:this._maxPackingWidth,height:this._maxPackingHeight}:{x:0,y:0,width:this._view.clientWidth,height:this._view.clientHeight},Rb.grow(a,-this._padding,-this._padding);var c=Math.min(a.width/this._network._view.scrollWidth,a.height/this._network._view.scrollHeight);b&&(Ub.setDiv(this._view,{x:0,y:0,width:this._imageDiv._viewRect.width,height:this._imageDiv._viewRect.height},null,0,null),a.width=this._imageDiv._viewRect.width,a.height=this._imageDiv._viewRect.height);var d=this._network._view.scrollWidth*c,e=this._network._view.scrollHeight*c,f=a.x+(a.width-d)/2,g=a.y+(a.height-e)/2;if(this._isNetworkDirty){var h={x:f,y:g,width:d,height:e};this._network.toCanvas(h.width,h.height,this._imageCanvas),Ub.setDiv(this._imageDiv,h,null,0,null),this._network.getElementBox&&(this._imageDiv.style.backgroundColor=(this._network.getCurrentSubNetwork()||this._network.getElementBox()).getStyle("background.color")||""),this._isNetworkDirty=!1}if(this._isMaskDirty){var i={x:this._network._view.scrollLeft*c,y:this._network._view.scrollTop*c,width:d*this._network._view.clientWidth/this._network._view.scrollWidth,height:e*this._network._view.clientHeight/this._network._view.scrollHeight},j=Ub.setCanvas(this._maskCanvas,f,g,d,e);j.lineWidth=0,j.fillStyle=this._fillColor,j.beginPath(),Vb.drawVector(j,"rectangle",null,f,g,d,e),j.fill(),j.clearRect(f+i.x,g+i.y,i.width,i.height);var k=this._outlineWidth<0?0:this._outlineWidth;j.lineWidth=k,j.strokeStyle=this._outlineColor,j.beginPath(),Vb.drawVector(j,"rectangle",null,f+i.x+k,g+i.y+k,i.width-2*k,i.height-2*k),k>=0&&j.stroke(),this._isMaskDirty=!1}}else this._isNetworkDirty=!1,this._isMaskDirty=!1},getLogicalPoint:function(a){return Ub.getLogicalPoint(this._view,a,1,this._rootDiv)},centerNetwork:function(a,b){var c=this._imageDiv._viewRect;Rb.containsPoint(c,a)&&(this._network.centerByLogicalPoint((a.x-c.x)/c.width*this._network._view.scrollWidth/this._network.getZoom(),(a.y-c.y)/c.height*this._network._view.scrollHeight/this._network.getZoom(),b),this._invalidateMask())}}),Gb.network.OverviewTouchInteraction=function(a){this.overview=a,this.network=a.getNetwork(),this.view=a._view,Ub.addEventListener("touchstart","handleTouchstart",this.view,this)},Hb.ext("twaver.network.OverviewTouchInteraction",Object,{handleTouchstart:function(a){Ub.preventDefault(a),this.clear(),this.endPoint=this.overview.getLogicalPoint(a),yc.isMultiTouch(a)&&(this.distance=yc.getDistance(a),this.zoom=this.network.getZoom()),Ub.addEventListener("touchmove","handleTouchmove",this.view,this),Ub.addEventListener("touchend","handleTouchend",this.view,this)},handleTouchmove:function(a){if(Ub.preventDefault(a),this.moved||(this.moved=!0),this.endPoint=this.overview.getLogicalPoint(a),yc.isSingleTouch(a))this.overview.centerNetwork(this.endPoint,!1);else if(this.distance){var b=yc.getDistance(a)/this.distance;this.network.setZoom(this.zoom*b,!1)}},handleTouchend:function(a){if(!this.moved){this.endPoint=this.overview.getLogicalPoint(a);var b=this.lastPoint&&this.lastTouchStartTime&&(new Date).getTime()-this.lastTouchStartTime.getTime()<=300&&Math.abs(this.endPoint.x-this.lastPoint.x)<=10&&Math.abs(this.endPoint.y-this.lastPoint.y)<=10;b?(this.lastPoint=null,this.lastTouchStartTime=null):(this.lastPoint=this.endPoint,this.lastTouchStartTime=new Date),b?Hb.callLater(this.network.zoomReset,this.network,[this.overview._animate]):this.overview.centerNetwork(this.endPoint,this.overview._animate)}this.clear()},clear:function(){this.endPoint&&(this.endPoint=null,Ub.removeEventListener("touchmove",this.view,this),Ub.removeEventListener("touchend",this.view,this)),this.moved=!1}}),Gb.network.OverviewInteraction=function(a){this.overview=a,this.network=a.getNetwork(),this.view=a._view,Ub.addEventListener("mousedown","handleMousedown",this.view,this)},Hb.ext("twaver.network.OverviewInteraction",Object,{handleMousedown:function(a){0===a.button&&(this.clear(),this.endPoint=this.overview.getLogicalPoint(a),Hb.isCtrlDown(a)&&(this.startPoint=this.endPoint,Ub.setVisible(this.overview._selectDiv,!0)),Ub.addEventListener("mousemove","handleMousemove",this.view,this),Ub.addEventListener("mouseup","handleMouseup",this.view,this))},handleMouseup:function(a){if(this.endPoint=this.overview.getLogicalPoint(a),"detail"in a&&2===a.detail)Hb.callLater(this.network.zoomReset,this.network,[this.overview._animate]);else if(Ub.isVisible(this.overview._selectDiv)&&this.startPoint){var b=this.overview._imageDiv._viewRect,c=this.overview._selectDiv._viewRect.x,d=this.overview._selectDiv._viewRect.y,e=b.width/this.overview._selectDiv._viewRect.width,f=b.height/this.overview._selectDiv._viewRect.height,g=Math.min(e,f),h=this.network._view.scrollWidth/this.network.getZoom()*((c-b.x+this.overview._selectDiv._viewRect.width/2)/b.width),i=this.network._view.scrollHeight/this.network.getZoom()*((d-b.y+this.overview._selectDiv._viewRect.height/2)/b.height);this.network.setZoom(g*Math.min(this.network._view.clientWidth/this.network._view.scrollWidth,this.network._view.clientHeight/this.network._view.scrollHeight)*this.network.getZoom(),!1),Hb.callLater(this.network.centerByLogicalPoint,this.network,[h,i,this.overview._animate]),Ub.setVisible(this.overview._selectDiv,!1),Ub.setDiv(this.overview._selectDiv,{x:0,y:0,width:0,height:0},null,0,null),this.startPoint=null}else this.overview.centerNetwork(this.endPoint,this.overview._animate);this.clear()},handleMousemove:function(a){var b=this.overview.getLogicalPoint(a);if(this.endPoint=b,Ub.isVisible(this.overview._selectDiv)&&this.startPoint){var c=b.x>this.startPoint.x?this.startPoint.x:b.x,d=b.x>this.startPoint.x?this.startPoint.y:b.y;b.x>this.startPoint.x&&b.y<this.startPoint.y&&(d=b.y),b.x<this.startPoint.x&&b.y>this.startPoint.y&&(d=this.startPoint.y);var e=this.overview._imageDiv._viewRect;c<e.x&&(c=e.x),c>e.x+e.width&&(c=e.x+e.width),d<e.y&&(d=e.y),d>e.y+e.height&&(d=e.y+e.height);var f=Math.abs(b.x-this.startPoint.x),g=Math.abs(b.y-this.startPoint.y);c+f>e.x+e.width&&(f=e.x+e.width-c),d+g>e.y+e.height&&(g=e.y+e.height-d),Ub.setDiv(this.overview._selectDiv,{x:c,y:d,width:f,height:g},null,this.overview._selectWidth,this.overview._selectColor)}else this.overview.centerNetwork(b,!1)},clear:function(){this.endPoint&&(this.endPoint=null,Ub.removeEventListener("mousemove",this.view,this),Ub.removeEventListener("mouseup",this.view,this))}}),Gb.network.OverviewMSTouchInteraction=function(a){this.overview=a,this.network=a.getNetwork(),this.view=a._view,this._pointerMap={},this._pointerIdArray=[],Ub.addEventListener("MSPointerDown","handleTouchstart",this.view,this),Ub.addEventListener("MSPointerMove","handleTouchmove",this.view,this),Ub.addEventListener("MSPointerUp","handleTouchend",this.view,this),Ub.addEventListener("MSPointerCancel","handleTouchend",this.view,this)},Hb.ext("twaver.network.OverviewMSTouchInteraction",Object,{handleTouchstart:function(a){Ub.preventDefault(a),a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),!this._pointerMap[a.pointerId]&&this.overview.getLogicalPoint(a)&&(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length?(this._startTouchPoint=this.overview.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.network.getZoom())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Rb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.network.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&this._startTouchPoint){var c=this.overview.getLogicalPoint(a);if(null==c)return;this._startTouchPoint=c,this.overview.centerNetwork(this._startTouchPoint,!1)}},handleTouchend:function(a){var b=this.overview.getLogicalPoint(a);if(1==this._pointerIdArray.length&&b){var c=this._endTouchPoint&&this._endTouchTime&&(new Date).getTime()-this._endTouchTime.getTime()<=500&&Rb.getDistance(this._endTouchPoint,b)<=10;c?(this._endTouchPoint=null,this._endTouchTime=null):(this._endTouchPoint=b,this._endTouchTime=new Date),c?Hb.callLater(this.network.zoomReset,this.network,[this.overview._animate]):this.overview.centerNetwork(this._endTouchPoint,this.overview._animate)}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Rb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Gb.network.ElementUI=function(a,b){this._view=Ub.createDiv(),this._bodyView=Ub.createDiv(),this._view.appendChild(this._bodyView),this._network=a,this._element=b,this._attachments=new md,this._bodyBounds=new md,this.invalidate(!0)},Hb.ext("twaver.network.ElementUI",Object,{_invalidateFlag:!1,_invalidateAttachmentsFlag:!1,getElement:function(){return this._element},getNetwork:function(){return this._network},getAttachments:function(){return this._attachments},getStyle:function(a){return this._element.getStyle(a)},getFont:function(a){var b=this._element.getStyle(a);

return b?b:Dd.FONT},getDyeColor:function(a){return this._innerColor?this._innerColor:this.getStyle(a)},getInnerColor:function(){return this._innerColor},getOuterColor:function(){return this._outerColor},getShadowColor:function(){return this._shadowColor},getLabelAttachment:function(){return this._labelAttachment},getAlarmAttachment:function(){return this._alarmAttachment},getIconsAttachment:function(){return this._iconsAttachment},getEditAttachment:function(){return this._editAttachment},getHotSpot:function(){return this._hotSpot?Hb.clone(this._hotSpot):{x:0,y:0}},setHotSpot:function(a){this._hotSpot=a},getUnionBodyBounds:function(){return Hb.clone(this._unionBodyBounds)},getBodyRect:function(){return this._bodyRect||(this._bodyRect=this.createBodyRect()),Hb.clone(this._bodyRect)},invalidate:function(a){void 0===a&&(a=!0),a&&(this._invalidateAttachmentsFlag=!0),this._invalidateFlag||(this._bodyRect=null,this._invalidateFlag=!0,this._network.invalidateElementVisibility())},updateMeasure:function(){},validate:function(){if(this._invalidateFlag){this._invalidateAttachmentsFlag&&(this._invalidateAttachmentsFlag=!1,this.checkAttachments()),this._invalidateFlag=!1,this._bodyBounds.clear(),Ub.clear(this._bodyView),this._innerColor=this._network.getInnerColor(this._element),this._outerColor=this._network.getOuterColor(this._element),this._shadowColor=this._network.getShadowColor(this._element),this._shadowXOffset=this._element.getStyle("shadow.xoffset"),this._shadowYOffset=this._element.getStyle("shadow.yoffset"),this._shadowBlur=this._element.getStyle("shadow.blur"),this.updateMeasure();var a=this._element.getStyle("whole.alpha");this._view.style.opacity=a,this._attachments.forEach(function(b){b.updateMeasure();var c=b.getAlpha();b._view.style.opacity=b.isShowInAttachmentDiv()?c*a:c});var b;this._bodyBounds.forEach(function(a){b=Rb.unionRect(b,a)}),this._unionBodyBounds=Hb.clone(b),this._attachments.forEach(function(a){b=Rb.unionRect(b,a.getViewRect())}),this._viewRect=b}},cleanUp:function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c],e=this[d];e&&!e.parentNode&&(this[d]=null)}},setVisible:function(a){this.isVisible()!==a&&(Ub.setVisible(this._view,a),this._attachments.forEach(function(b){b.isShowInAttachmentDiv()&&Ub.setVisible(b._view,a)}),this.invalidate(!0))},isVisible:function(){return Ub.isVisible(this._view)},checkAttachments:function(){this.checkLabelAttachment(),this.checkAlarmAttachment(),this.checkIconsAttachment(),this.checkEditAttachment()},checkLabelAttachment:function(){var a=this._network.getLabel(this._element);null!=a&&""!==a?this._labelAttachment||(this._labelAttachment=new Gb.network.LabelAttachment(this,Dd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._network.getAlarmLabel(this._element);null!=a&&""!==a?this._alarmAttachment||(this._alarmAttachment=new Gb.network.AlarmAttachment(this,Dd.SHOW_ALARM_IN_ATTACHMENT_DIV),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},checkIconsAttachment:function(){var a=this._network.getIconsNames(this._element);a&&a.length>0?this._iconsAttachment||(this._iconsAttachment=new Gb.network.IconsAttachment(this),this.addAttachment(this._iconsAttachment)):this._iconsAttachment&&(this.removeAttachment(this._iconsAttachment),this._iconsAttachment=null)},checkEditAttachment:function(){this.isEditable()&&this._network.hasEditInteraction()&&this._network.isSelected(this._element)&&this._network.isEditable(this._element)?this._editAttachment||(this._editAttachment=new Gb.network.EditAttachment(this),this.addAttachment(this._editAttachment)):this._editAttachment&&(this.removeAttachment(this._editAttachment),this._editAttachment=null)},isEditable:function(){return!0},handlePropertyChange:function(a){this.invalidate(!0)},handleSelectionChange:function(a){this.invalidate(!0)},dispose:function(){this._attachments.forEach(function(a){a.getView().parentNode&&a.getView().parentNode.removeChild(a.getView()),a.dispose()}),this._attachments.clear()},addAttachment:function(a){this._attachments.add(a),a.isShowInAttachmentDiv()?this._network.getAttachmentDiv().appendChild(a.getView()):this._view.appendChild(a.getView()),this.invalidate(!1)},removeAttachment:function(a){this._attachments.remove(a),a.getView().parentNode&&a.getView().parentNode.removeChild(a.getView()),a.dispose(),this.invalidate(!1)},addBodyBounds:function(a){a&&this._bodyBounds.add(a)},addComponent:function(a){this._bodyView.appendChild(a)},getBodyView:function(){return this._bodyView},getView:function(){return this._view},getViewRect:function(){return Hb.clone(this._viewRect)},setShadow:function(a,b,c){var d=a.isShadowable()&&this._shadowColor&&!this._editAttachment;d&&(this._shadowXOffset>0?c.width+=this._shadowXOffset:(c.x+=this._shadowXOffset,c.width+=-this._shadowXOffset),this._shadowYOffset>0?c.height+=this._shadowYOffset:(c.y+=this._shadowYOffset,c.height+=-this._shadowYOffset),Rb.grow(c,this._shadowBlur,this._shadowBlur));var e=Ub.setCanvas(b,c);return d&&(e.shadowOffsetX=this._shadowXOffset,e.shadowOffsetY=this._shadowYOffset,e.shadowBlur=this._shadowBlur,e.shadowColor=this._shadowColor),e},isShadowable:function(){return this._shadowColor&&this._network.isSelected(this._element)&&"shadow"===this._element.getStyle("select.style")?!0:!1},hit:function(a,b){return!1},hitCanvas:function(a,b,c){for(var d=c.length,e=0;d>e;e++){var f=c[e],g=this[f];if(Vb.hit(g,a,b,this._network.getSelectionTolerance()))return!0}return!1},hitComponent:function(a,b,c){for(var d=c.length,e=0;d>e;e++){var f=c[e],g=this[f];if(g&&Rb.containsPoint(g._viewRect,a,b))return!0}return!1},hitTest:function(a,b){if(!this.isVisible()||!Rb.containsPoint(this._viewRect,a,b))return null;var c,d,e=this._attachments.size();for(c=e-1;c>=0;c--)if(d=this._attachments.get(c),d.isShowInAttachmentDiv()&&d.hit(a,b))return d;for(c=e-1;c>=0;c--)if(d=this._attachments.get(c),!d.isShowInAttachmentDiv()&&d.hit(a,b))return d;return Rb.containsPoint(this._unionBodyBounds,a,b)&&this.hit(a,b)?this:null},intersects:function(a){return!1},intersectsComponent:function(a,b){for(var c=b.length,d=0;c>d;d++){var e=b[d],f=this[e];if(f&&Rb.intersects(f._viewRect,a))return!0}return!1},intersectsCanvas:function(a,b){for(var c=b.length,d=0;c>d;d++){var e=b[d],f=this[e];if(Vb.intersects(f,a))return!0}return!1},intersectsTest:function(a){if(!this.isVisible()||!Rb.intersects(this._viewRect,a))return null;var b,c,d=this._attachments.size();for(b=d-1;b>=0;b--)if(c=this._attachments.get(b),c.isShowInAttachmentDiv()&&c.intersects(a))return c;for(b=d-1;b>=0;b--)if(c=this._attachments.get(b),!c.isShowInAttachmentDiv()&&c.intersects(a))return c;return Rb.intersects(this._unionBodyBounds,a)&&this.intersects(a)?this:null}}),Gb.network.Attachment=function(a,b){this._view=Ub.createDiv(),this._ui=a,this._element=this._ui.getElement(),this._network=a.getNetwork(),this._isShowInAttachmentDiv=b===!0,this._isShowInAttachmentDiv&&Ub.setVisible(this._view,a.isVisible())},Hb.ext("twaver.network.Attachment",Object,{getElement:function(){return this._element},getElementUI:function(){return this._ui},getNetwork:function(){return this._network},getStyle:function(a){return this._ui.getStyle(a)},getFont:function(a){return this._ui.getFont(a)},isShowInAttachmentDiv:function(){return this._isShowInAttachmentDiv},getView:function(){return this._view},getViewRect:function(){return Hb.clone(this._viewRect)},getAlpha:function(){return 1},updateMeasure:function(){},dispose:function(){},hit:function(a,b){return Rb.containsPoint(this._viewRect,a,b)},intersects:function(a){return Rb.intersects(this._viewRect,a)}}),Gb.network.BasicAttachment=function(a,b){Gb.network.BasicAttachment.superClass.constructor.call(this,a,b),this._roundRect={x:0,y:0,width:0,height:0},this._contentRect={x:0,y:0,width:0,height:0},this._attachmentCanvas=Ub.createCanvas(),this._view.insertBefore(this._attachmentCanvas,this._view.firstChild)},Hb.ext("twaver.network.BasicAttachment",Gb.network.Attachment,{calculateMeasure:function(){var a=this.getContentWidth(),b=this.getContentHeight(),c=this.getCornerRadius(),d=this.getPointerLength(),e=this.getPointerWidth(),f=this.getPosition(),g=this.getXOffset(),h=this.getYOffset(),i=this._roundRect;i.width=a+2*c,i.height=b;var j;if(d>0){var k=this.getDirection();j=this._network.getPosition(f,this._ui,null,g,h);var l;if("aboveleft"===k)i.y=j.y-d-i.height,i.x=j.x-(i.width-c),l=Math.max(j.x-e,i.x+c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:l,y:j.y-d}];else if("aboveright"===k)i.y=j.y-d-i.height,i.x=j.x-c,l=Math.min(j.x+e,i.x+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:l,y:j.y-d}];else if("belowleft"===k)i.y=j.y+d,i.x=j.x-(i.width-c),l=Math.max(j.x-e,i.x+c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:l,y:j.y+d}];else if("belowright"===k)i.y=j.y+d,i.x=j.x-c,l=Math.min(j.x+e,i.x+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:l,y:j.y+d}];else if("leftabove"===k)i.y=j.y+c-i.height,i.x=j.x-d-i.width,l=Math.max(j.y-e,i.y+c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:l}];else if("leftbelow"===k)i.y=j.y-c,i.x=j.x-d-i.width,l=Math.min(j.y+e,i.y+i.height-c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:l}];else if("rightabove"===k)i.y=j.y+c-i.height,i.x=j.x+d,l=Math.max(j.y-e,i.y+c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:l}];else if("rightbelow"===k)i.y=j.y-c,i.x=j.x+d,l=Math.min(j.y+e,i.y+i.height-c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:l}];else if("above"===k)i.y=j.y-d-i.height,i.x=j.x-i.width/2,l=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-l,y:j.y-d},{x:j.x+l,y:j.y-d}];else if("below"===k)i.y=j.y+d,i.x=j.x-i.width/2,l=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-l,y:j.y+d},{x:j.x+l,y:j.y+d}];else if("left"===k)i.y=j.y-i.height/2,i.x=j.x-d-i.width,l=Math.min(b/2,e/2),this._pointers=[j,{x:j.x-d,y:j.y+l},{x:j.x-d,y:j.y-l}];else{if("right"!==k)throw"Can not resolve '"+k+"' attachment direction";i.y=j.y-i.height/2,i.x=j.x+d,l=Math.min(b/2,e/2),this._pointers=[j,{x:j.x+d,y:j.y+l},{x:j.x+d,y:j.y-l}]}}else j=this._network.getPosition(f,this._ui,{width:i.width,height:i.height},g,h),i.x=j.x,i.y=j.y,this._pointers=null;this._contentRect.x=i.x+(i.width-a)/2,this._contentRect.y=i.y+(i.height-b)/2,this._contentRect.width=a,this._contentRect.height=b;var m=this.getPadding();0!=m&&Rb.grow(i,m,m),m=this.getPaddingLeft(),0!=m&&(i.x-=m,i.width+=m),m=this.getPaddingRight(),0!=m&&(i.width+=m),m=this.getPaddingTop(),0!=m&&(i.y-=m,i.height+=m),m=this.getPaddingBottom(),0!=m&&(i.height+=m),i.width<0&&(i.width=i.width,i.x-=i.width),i.height<0&&(i.height=-i.height,i.y-=i.height)},updateMeasure:function(){Gb.network.BasicAttachment.superClass.updateMeasure.call(this),this.calculateMeasure();var a=this.isFill(),b=this.getOutlineWidth();this._viewRect=Rb.getRect(this._pointers),this._viewRect=Rb.unionRect(this._viewRect,this._roundRect),b>0&&Rb.grow(this._viewRect,b/2,b/2);var c=this._ui.setShadow(this,this._attachmentCanvas,this._viewRect);if((b>0||a)&&(c.beginPath(),Vb.drawRoundRect(c,this._roundRect.x,this._roundRect.y,this._roundRect.width,this._roundRect.height,this.getCornerRadius()),this._pointers&&(c.moveTo(this._pointers[0].x,this._pointers[0].y),c.lineTo(this._pointers[1].x,this._pointers[1].y),c.lineTo(this._pointers[2].x,this._pointers[2].y)),c.closePath(),b>0&&(c.lineWidth=b,c.strokeStyle=this.getOutlineColor(),c.lineCap=this.getCap(),c.lineJoin=this.getJoin(),c.stroke()),a)){var d=this.getFillColor(),e=this.getGradient();e?Vb.fill(c,d,e,this.getGradientColor(),this._viewRect):c.fillStyle=d,c.fill()}return c},getRoundRect:function(){return Hb.clone(this._roundRect)},getContentRect:function(){return Hb.clone(this._contentRect)},getContent:function(){return this._content},setContent:function(a){this._content!==a&&(this._content&&this._view.removeChild(this._content),this._content=a,a&&this._view.appendChild(a))},getContentWidth:function(){return Dd.ATTACHMENT_CONTENT_WIDTH},getContentHeight:function(){return Dd.ATTACHMENT_CONTENT_HEIGHT},getCornerRadius:function(){return Dd.ATTACHMENT_CORNER_RADIUS},getPointerLength:function(){return Dd.ATTACHMENT_POINTER_LENGTH},getPointerWidth:function(){return Dd.ATTACHMENT_POINTER_WIDTH},getPosition:function(){return Dd.ATTACHMENT_POSITION},getXOffset:function(){return Dd.ATTACHMENT_XOFFSET},getYOffset:function(){return Dd.ATTACHMENT_YOFFSET},getPadding:function(){return Dd.ATTACHMENT_PADDING},getPaddingLeft:function(){return Dd.ATTACHMENT_PADDING_LEFT},getPaddingRight:function(){return Dd.ATTACHMENT_PADDING_RIGHT},getPaddingTop:function(){return Dd.ATTACHMENT_PADDING_TOP},getPaddingBottom:function(){return Dd.ATTACHMENT_PADDING_BOTTOM},getDirection:function(){return Dd.ATTACHMENT_DIRECTION},isFill:function(){return Dd.ATTACHMENT_FILL},getFillColor:function(){return Dd.ATTACHMENT_FILL_COLOR},getGradient:function(){return Dd.ATTACHMENT_GRADIENT},getGradientColor:function(){return Dd.ATTACHMENT_GRADIENT_COLOR},getOutlineWidth:function(){return Dd.ATTACHMENT_OUTLINE_WIDTH},getOutlineColor:function(){return Dd.ATTACHMENT_OUTLINE_COLOR},getCap:function(){return Dd.ATTACHMENT_CAP},getJoin:function(){return Dd.ATTACHMENT_JOIN},isShadowable:function(){return Dd.ATTACHMENT_SHADOWABLE},hit:function(a,b){return Rb.containsPoint(this._viewRect,a,b)?Rb.containsPoint(this._contentRect,a,b)?!0:Vb.hit(this._attachmentCanvas,a,b):!1},intersects:function(a){return Rb.intersects(this._viewRect,a)?Rb.intersects(this._contentRect,a)?!0:Vb.intersects(this._attachmentCanvas,a):!1}}),Gb.network.LabelAttachment=function(a,b){Gb.network.LabelAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.LabelAttachment",Gb.network.BasicAttachment,{updateMeasure:function(){var a,b=this.getFont("label.font"),c=this.getLabel(),d=Hb.g.getTextSize(b,c),e=this.getMaxLength();0!==e&&d.width>e?(a=Hb.g.getCollapseTextInLength(b,c,e),this._textSize=Hb.g.getTextSize(b,a)):(a=c,this._textSize=d);var f=Gb.network.LabelAttachment.superClass.updateMeasure.call(this),g=this._element.getStyle("label.align");Vb.drawText(f,a,this._contentRect,b,this.getStyle("label.color"),g)},getLabel:function(){return this._network.getLabel(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("label.corner.radius")},getPointerLength:function(){return this.getStyle("label.pointer.length")},getPointerWidth:function(){return this.getStyle("label.pointer.width")},getPosition:function(){return this.getStyle("label.position")},getXOffset:function(){return this.getStyle("label.xoffset")},getYOffset:function(){return this.getStyle("label.yoffset")},getPadding:function(){return this.getStyle("label.padding")},getPaddingLeft:function(){return this.getStyle("label.padding.left")},getPaddingRight:function(){return this.getStyle("label.padding.right")},getPaddingTop:function(){return this.getStyle("label.padding.top")},getPaddingBottom:function(){return this.getStyle("label.padding.bottom")},getDirection:function(){return this.getStyle("label.direction")},isFill:function(){return this.getStyle("label.fill")},getFillColor:function(){return this.getStyle("label.fill.color")},getGradient:function(){return this.getStyle("label.gradient")},getGradientColor:function(){return this.getStyle("label.gradient.color")},getOutlineWidth:function(){return this.getStyle("label.outline.width")},getOutlineColor:function(){return this.getStyle("label.outline.color")},getCap:function(){return this.getStyle("label.cap")},getJoin:function(){return this.getStyle("label.join")},getAlpha:function(){return this.getStyle("label.alpha")},getMaxLength:function(){return this.getStyle("label.maxlength")},isShadowable:function(){return this.getStyle("label.shadowable")}}),Gb.network.AlarmAttachment=function(a,b){Gb.network.AlarmAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.AlarmAttachment",Gb.network.BasicAttachment,{updateMeasure:function(){var a=this.getFont("alarm.font"),b=this._network.getAlarmLabel(this._element);this._textSize=Vb.getTextSize(a,b),this._fillColor=this._network.getAlarmFillColor(this._element);var c=Gb.network.AlarmAttachment.superClass.updateMeasure.call(this);Vb.drawText(c,b,this._contentRect,a,this.getStyle("alarm.color"))},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("alarm.corner.radius")},getPointerLength:function(){return this.getStyle("alarm.pointer.length")},getPointerWidth:function(){return this.getStyle("alarm.pointer.width")},getPosition:function(){return this.getStyle("alarm.position")},getXOffset:function(){return this.getStyle("alarm.xoffset")},getYOffset:function(){return this.getStyle("alarm.yoffset")},getPadding:function(){return this.getStyle("alarm.padding")},getPaddingLeft:function(){return this.getStyle("alarm.padding.left")},getPaddingRight:function(){return this.getStyle("alarm.padding.right")},getPaddingTop:function(){return this.getStyle("alarm.padding.top")},getPaddingBottom:function(){return this.getStyle("alarm.padding.bottom")},getDirection:function(){return this.getStyle("alarm.direction")},isFill:function(){return null!=this._fillColor},getFillColor:function(){return this._fillColor},getGradient:function(){return this.getStyle("alarm.gradient")},getGradientColor:function(){return this.getStyle("alarm.gradient.color")},getOutlineWidth:function(){return this.getStyle("alarm.outline.width")},getOutlineColor:function(){return this.getStyle("alarm.outline.color")},getCap:function(){return this.getStyle("alarm.cap")},getJoin:function(){return this.getStyle("alarm.join")},getAlpha:function(){return this.getStyle("alarm.alpha")},isShadowable:function(){return this.getStyle("alarm.shadowable")}}),Gb.network.LinkHandlerAttachment=function(a,b){Gb.network.LinkHandlerAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.LinkHandlerAttachment",Gb.network.BasicAttachment,{updateMeasure:function(){var a=this.getFont("link.handler.font"),b=this._network.getLinkHandlerLabel(this._element);this._textSize=Vb.getTextSize(a,b);var c=Gb.network.LabelAttachment.superClass.updateMeasure.call(this);Vb.drawText(c,b,this._contentRect,a,this.getStyle("link.handler.color"))},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("link.handler.corner.radius")},getPointerLength:function(){return this.getStyle("link.handler.pointer.length")},getPointerWidth:function(){return this.getStyle("link.handler.pointer.width")},getPosition:function(){return this.getStyle("link.handler.position")},getXOffset:function(){return this.getStyle("link.handler.xoffset")},getYOffset:function(){return this.getStyle("link.handler.yoffset")},getPadding:function(){return this.getStyle("link.handler.padding")},getPaddingLeft:function(){return this.getStyle("link.handler.padding.left")},getPaddingRight:function(){return this.getStyle("link.handler.padding.right")},getPaddingTop:function(){return this.getStyle("link.handler.padding.top")},getPaddingBottom:function(){return this.getStyle("link.handler.padding.bottom")},getDirection:function(){return this.getStyle("link.handler.direction")},isFill:function(){return this.getStyle("link.handler.fill")},getFillColor:function(){return this.getStyle("link.handler.fill.color")},getGradient:function(){return this.getStyle("link.handler.gradient")},getGradientColor:function(){return this.getStyle("link.handler.gradient.color")},getOutlineWidth:function(){return this.getStyle("link.handler.outline.width")},getOutlineColor:function(){return this.getStyle("link.handler.outline.color")},getCap:function(){return this.getStyle("link.handler.cap")},getJoin:function(){return this.getStyle("link.handler.join")},getAlpha:function(){return this.getStyle("link.handler.alpha")},isShadowable:function(){return this.getStyle("link.handler.shadowable")}}),Gb.network.EditAttachment=function(a,b){Gb.network.EditAttachment.superClass.constructor.call(this,a,b),this._attachmentDiv=Ub.createDiv(),this._view.appendChild(this._attachmentDiv)},Hb.ext("twaver.network.EditAttachment",Gb.network.Attachment,{updateMeasure:function(){Gb.network.EditAttachment.superClass.updateMeasure.call(this),this._viewRect=null,this._element instanceof Ld&&this._addResizingPoint(this._element),!(this._network.isRotatable(this._element)&&this._element instanceof Ld)||this._element instanceof Gb.ShapeNode||this._element instanceof Gb.Grid||this._element instanceof Gb.Group||this._addRotatePoint(this._element),this._element instanceof Gb.ShapeNode&&(this._addResizingPoint(this._element),this._addShapeNodePoint(this._element)),this._ui instanceof Gb.network.ShapeLinkUI&&this._addShapeLinkPoints(this._ui),this._ui instanceof Gb.network.LinkUI&&this._addLinkControlPoint(this._ui)},_addRotatePoint:function(a){var b=this._network.getRotatePointSize();if(!(0>=b)){var c=a.getOriginalRect();if(!this._rotateDiv){var d=Ub.createDiv();this._attachmentDiv.appendChild(d),this._rotateDiv=d}var e,f=this._network.getRotatePointOutlineWidth(),g=this._network.getRotatePointOutlineColor(),h=this._network.getRotatePointFillColor(),b=this._network.getRotatePointSize(),i=2*b,j={x:c.x+c.width/2-b,y:c.y-this._network.getRotatePointOffset()-i,width:i,height:i};e=0==a.angle?j:this._getRotateRect(j,a.getAngle(),{x:c.x+c.width/2,y:c.y+c.height/2});var k=Rb.unionRect(a.getRect(),e);this._viewRect=Rb.unionRect(k,this._viewRect),Ub.setDiv(this._rotateDiv,j,h,f,g),this._rotateDiv._viewRect=e,Ub.setBorderRaidus(this._rotateDiv,i+"px"),this._rotateAttachments(this._rotateDiv,i/2,f)}},_addResizingPoint:function(a){var b=this._network.getResizePointSize();if(!(0>=b)){var c=a.getOriginalRect(),d=new md([{x:c.x,y:c.y},{x:c.x+c.width/2,y:c.y},{x:c.x+c.width,y:c.y},{x:c.x,y:c.y+c.height/2},{x:c.x+c.width,y:c.y+c.height/2},{x:c.x,y:c.y+c.height},{x:c.x+c.width/2,y:c.y+c.height},{x:c.x+c.width,y:c.y+c.height}]);if(!this._resizeDivs){this._resizeDivs=new Array;for(var e=0;8>e;e++){var f=Ub.createDiv();this._attachmentDiv.appendChild(f),this._resizeDivs[e]=f}}if(this._resizeDivs){this._resizeRects=new Array;for(var e=0;8>e;e++){var g,h=d.get(e),i={x:h.x-b,y:h.y-b,width:2*b,height:2*b};g=0==a.getAngle()?i:this._getRotateRect(i,a.getAngle(),{x:c.x+c.width/2,y:c.y+c.height/2}),this._resizeRects[e]=g}}var j=this._network.getResizePointOutlineWidth(),k=this._network.getResizePointOutlineColor(),l=this._network.getResizePointFillColor();this._addPoints(a.getRect(),d,j,k,l,!0)}},_addPoints:function(a,b,c,d,e,f){var g=f?this._network.getResizePointSize():this._network.getEditPointSize();if(!(0>=g)){var h=g+c;Rb.grow(a,h,h),this._viewRect=Rb.unionRect(a,this._viewRect);var i,j,k,l,m=2*g,n=new md;for(i=0,j=b.size();j>i;i++)k=b.get(i),l={x:k.x-g,y:k.y-g,width:m,height:m},n.add(l);var o;if(f)o=this._resizeDivs;else{if(this._controlDivs||(this._controlDivs=new Array),this._controlDivs.length<j)for(i=this._controlDivs.length;j>i;i++){var p=Ub.createDiv();this._attachmentDiv.appendChild(p),this._controlDivs[i]=p}else if(this._controlDivs.length>j){for(i=j;i<this._controlDivs.length;i++)this._attachmentDiv.removeChild(this._controlDivs[i]);this._controlDivs.splice(j)}o=this._controlDivs}for(i=0,j=n.size();j>i;i++)l=n.get(i),Ub.setDiv(o[i],l,e,c,d),Ub.setBorderRaidus(o[i],(f?"0":m)+"px"),this._rotateAttachments(o[i],m/2,c,b.get(i))}},_rotateAttachments:function(a,b,c,d){if(this._element instanceof Ld){var e=this._element.getAngle();if(0==e)return;{var f=this._element.getOriginalRect(),g=a.style.left.split("px")[0],h=a.style.top.split("px")[0];f.x+f.width/2,f.y+f.height/2}d||(d={x:parseFloat(g)+b+c,y:parseFloat(h)+b+c});var i=Rb.createMatrix(e*Math.PI/180,f.x+f.width/2,f.y+f.height/2),j=i.transform(d);a.style.webkitTransform="rotate("+e+"deg)",a.style.mozTransform="rotate("+e+"deg)",a.style.OTransform="rotate("+e+"deg)",a.style.msTransform="rotate("+e+"deg)",a.style.transform="rotate("+e+"deg)",a.style.left=j.x-b-c+"px",a.style.top=j.y-b-c+"px"}},_addShapeLinkPoints:function(a){this._addEditPoints(a._element.getPoints())},_addShapeNodePoint:function(a){this._addEditPoints(a.getPoints())},_addLinkControlPoint:function(a){if(wc.isOrthogonalLink(a._element)){var b=a.getControlPoint();if(b){var c=new md;c.add(b),this._addEditPoints(c)}}},_addEditPoints:function(a){var b=Rb.getRect(a);if(b){var c=this._network.getEditPointOutlineWidth(),d=this._network.getEditPointOutlineColor(),e=this._network.getEditPointFillColor();this._addPoints(b,a,c,d,e,!1)}},hit:function(a,b){if(!Rb.containsPoint(this._viewRect,a,b))return!1;var c;if(this._resizeDivs)for(c=this._resizeDivs.length-1;c>=0;c--)if(Rb.containsPoint(this._resizeRects[c],a,b))return!0;if(this._rotateDiv&&Rb.containsPoint(this._rotateDiv._viewRect,a,b))return!0;if(this._controlDivs)for(c=this._controlDivs.length-1;c>=0;c--)if(Rb.containsPoint(this._controlDivs[c]._viewRect,a,b))return!0;return!1},intersects:function(a){if(!Rb.intersects(this._viewRect,a))return!1;var b;if(this._resizeDivs)for(b=this._resizeDivs.length-1;b>=0;b--)if(Rb.intersects(this._resizeRects[b],a))return!0;if(this._rotateDiv&&Rb.containsPoint(this._rotateDiv._viewRect,a))return!0;if(this._controlDivs)for(b=this._controlDivs.length-1;b>=0;b--)if(Rb.intersects(this._controlDivs[b]._viewRect,a))return!0;return Rb.intersects(this._viewRect,a)?!1:!1},_getRotateRect:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x,c.y),e={x:a.x+a.width/2,y:a.y+a.height/2},f=d.transform(e),g=new Gb.List([{x:f.x-a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y+a.height/2},{x:f.x-a.width/2,y:f.y+a.height/2}]);return Rb.getRect(g)}}),Gb.network.IconsAttachment=function(a,b){Gb.network.IconsAttachment.superClass.constructor.call(this,a,b),this._iconsCanvas=null},Hb.ext("twaver.network.IconsAttachment",Gb.network.Attachment,{isShadowable:function(){return Dd.ATTACHMENT_SHADOWABLE},updateMeasure:function(){Gb.network.IconsAttachment.superClass.updateMeasure.call(this);var a=this._network.getIconsNames(this._element);if(a&&0!=a.length){var b=this._network.getIconsColors(this._element),c=this._element.getStyle("icons.orientation"),d=this._element.getStyle("icons.position"),e=this._element.getStyle("icons.xoffset");e=e instanceof Array?e[0]:e;var f=this._element.getStyle("icons.yoffset");f=f instanceof Array?f[0]:f;var g=this._element.getStyle("icons.xgap");g=g instanceof Array?g[0]:g;var h=this._element.getStyle("icons.ygap");h=h instanceof Array?h[0]:h;var i=this._getIconsSize(a,c,g,h);if(i){var j=this._network.getPosition(d,this._ui,i,e,f);this._viewRect={x:j.x,y:j.y,width:i.width,height:i.height},"top"===c?j.y+=i.height:"left"===c&&(j.x+=i.width),this._iconsCanvas||(this._iconsCanvas=Ub.createCanvas(),this._view.appendChild(this._iconsCanvas));var k=this._ui.setShadow(this,this._iconsCanvas,Hb.clone(this._viewRect)),l=j.x,m=j.y,n=0;for(var o in a){var p=null,q=null;b&&b.length>n&&(q=b[n++]);var r=Hb.getImageAsset(a[o]);if(null!=r){if("right"===c)p={x:l,y:m,width:r.getWidth(),height:r.getHeight()},l+=p.width+g;else if("left"===c)p={x:l-r.getWidth(),y:m,width:r.getWidth(),height:r.getHeight()},l-=p.width+g;else if("top"===c)p={x:l,y:m-r.getHeight(),width:r.getWidth(),height:r.getHeight()},m-=p.height+h;else{if("bottom"!==c)throw"Can not resolve '"+c+"' orientation";p={x:l,y:m,width:r.getWidth(),height:r.getHeight()},m+=p.height+h}Mc(k,r.getImage(q,p.width,p.height),q,p,this._element,this._network)}}}}},_getIconsSize:function(a,b,c,d){var e=0,f=0,g=null,h=null,i=null;for(var j in a)if(h=Hb.getImageAsset(a[j])){if("right"===b)g={x:e,y:f,width:h.getWidth(),height:h.getHeight()},e+=g.width+c;else if("left"===b)g={x:e-h.getWidth(),y:f,width:h.getWidth(),height:h.getHeight()},e-=g.width+c;else if("top"===b)g={x:e,y:f-h.getHeight(),width:h.getWidth(),height:h.getHeight()},f-=g.height+d;else{if("bottom"!==b)throw"Can not resolve '"+b+"' orientation";g={x:e,y:f,width:h.getWidth(),height:h.getHeight()},f+=g.height+d}i=null==i?Hb.clone(g):Rb.unionRect(i,g)}return i?{width:Math.abs(i.width),height:Math.abs(i.height)}:null}}),Gb.network.HTMLBasicAttachment=function(a,b){function c(a,b,c,d,e,f,g){c||(c=this._origin.x),d||(d=this._origin.y),e||(e=this._location.x),f||(f=this._location.y),a=a-c-e,b=b-d-f;var h=Gb.Util.transformPoint({x:c+e,y:d+f},g?this._radian:-this._radian,a,b).point;return h}Gb.network.HTMLBasicAttachment.superClass.constructor.call(this,a,b),this._roundRect={x:0,y:0,width:0,height:0},this._contentRect={x:0,y:0,width:0,height:0},this._triangleDiv=Gb.Util.createDiv(),this._roundDiv=Gb.Util.createDiv(),this._contentDiv=Gb.Util.createDiv(),Gb.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Gb.Util.setCSSStyle(this._contentDiv,"white-space","nowrap");var d=this;this.hit=function(a,b){if(this._radian&&this._origin){var e=c.call(d,a,b);a=e.x,b=e.y}return Gb.Util.containsPoint(this._roundRect,a,b)||Gb.Util.containsPoint(this._pointerRect,a,b)},this.intersects=function(a){var b={x:a.x,y:a.y},e={x:a.x+a.width,y:a.y},f={x:a.x,y:a.y+a.height},g={x:a.x+a.width,y:a.y+a.height};if(this._radian&&this._origin){if(a.width*a.height>50)return!1;b=c.call(d,b.x,b.y),e=c.call(d,e.x,e.y),f=c.call(d,f.x,f.y),g=c.call(d,g.x,g.y)}return a=Gb.Util.getRect([b,e,f,g]),Gb.Util.intersects(this._roundRect,a)||Gb.Util.intersects(this._pointerRect,a)},this.getContentWidth=function(){return this._contentDiv.scrollWidth||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},this.getContentHeight=function(){return this._contentDiv.scrollHeight||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},this._view.appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Gb.Util.ext("twaver.network.HTMLBasicAttachment",Gb.network.BasicAttachment,{calculateMeasure:function(){var a=this.getContentWidth(),b=this.getContentHeight(),c=Math.min(this.getCornerRadius(),b/2),d=this.getPointerLength(),e=this.getPointerWidth(),f=this.getPosition(),g=this.getXOffset(),h=this.getYOffset();this._contentRect.width=a,this._contentRect.height=b,this._contentRect.x=c;var i=this._roundRect;i.width=a+2*c,i.height=b;var j;if(d>0){var k=this.getDirection();j=this._network.getPosition(f,this._ui,null,g,h);if("aboveleft"===k){i.y=j.y-d-i.height,i.x=j.x-(i.width-c),this._pointers=[j,{x:j.x,y:j.y-d},{x:j.x-Math.min(e,a),y:j.y-d}];var l=d/2,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle=n+" "+n+" transparent transparent",this._triangleDivLocation=this._pointers[2]}else if("aboveright"===k){i.y=j.y-d-i.height,i.x=j.x-c,this._pointers=[j,{x:j.x,y:j.y-d},{x:j.x+Math.min(e,a),y:j.y-d}];var l=d/2,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle=n+" transparent transparent "+n,this._triangleDivLocation=this._pointers[1]}else if("belowleft"===k){i.y=j.y+d,i.x=j.x-(i.width-c),this._pointers=[j,{x:j.x,y:j.y+d},{x:j.x-Math.min(e,a),y:j.y+d}];var l=d/2,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle=" transparent "+n+" "+n+" transparent",this._triangleDivLocation={x:this._pointers[2].x,y:j.y}}else if("belowright"===k){i.y=j.y+d,i.x=j.x-c,this._pointers=[j,{x:j.x,y:j.y+d},{x:j.x+Math.min(e,a),y:j.y+d}];var l=d/2,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle="transparent transparent "+n+" "+n,this._triangleDivLocation=this._pointers[0]}else if("above"===k){i.y=j.y-d-i.height,i.x=j.x-i.width/2,this._pointers=[j,{x:j.x-Math.min(e,a)/2,
y:j.y-d},{x:j.x+Math.min(e,a)/2,y:j.y-d}];var l=d,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px 0px "+m+"px",this._triangleBorderColorStyle=n+" transparent transparent transparent",this._triangleDivLocation=this._pointers[1]}else if("below"===k){i.y=j.y+d,i.x=j.x-i.width/2,this._pointers=[j,{x:j.x-Math.min(e,a)/2,y:j.y+d},{x:j.x+Math.min(e,a)/2,y:j.y+d}];var l=d,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle="0px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle="transparent transparent "+n+" transparent ",this._triangleDivLocation={x:this._pointers[1].x,y:j.y}}else if("left"===k){i.y=j.y-i.height/2,i.x=j.x-i.width-d,this._pointers=[j,{x:j.x-d,y:j.y-Math.min(e,b)/2},{x:j.x-d,y:j.y+Math.min(e,b)/2}];var l=Math.min(e,b)/2,m=d,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px 0px "+l+"px "+m+"px",this._triangleBorderColorStyle="transparent transparent  transparent "+n,this._triangleDivLocation=this._pointers[1]}else{if("right"!==k)throw"Can not resolve '"+k+"' attachment direction";i.y=j.y-i.height/2,i.x=j.x+d,this._pointers=[j,{x:j.x+d,y:j.y-Math.min(e,b)/2},{x:j.x+d,y:j.y+Math.min(e,b)/2}];var l=Math.min(e,b)/2,m=d,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px 0px",this._triangleBorderColorStyle="transparent "+n+" transparent  transparent ",this._triangleDivLocation={x:j.x,y:this._pointers[1].y}}}else j=this._network.getPosition(f,this._ui,{width:i.width,height:i.height},g,h),i.x=j.x,i.y=j.y,this._pointers=null;this._location=j},updateMeasure:function(){if(this.calculateMeasure(),this._ui.isShadowable()&&this.isShadowable()?Gb.Util.setCSSStyle(this._roundDiv,"text-shadow",this._ui._shadowXOffset+"px "+this._ui._shadowYOffset+"px "+this._ui._shadowBlur+"px "+this._ui._shadowColor):Gb.Util.removeCSSStyle(this._roundDiv,"text-shadow"),this._pointerRect=Gb.Util.getRect(this._pointers),this._viewRect=Gb.Util.unionRect(this._pointerRect,this._roundRect),Gb.Util.setCSSStyle(this._contentDiv,"left",this._contentRect.x+"px"),Gb.Util.setCSSStyle(this._contentDiv,"top",this._contentRect.y+"px"),Gb.Util.setCSSStyle(this._roundDiv,"left",this._roundRect.x+"px"),Gb.Util.setCSSStyle(this._roundDiv,"top",this._roundRect.y+"px"),Gb.Util.setCSSStyle(this._roundDiv,"width",this._roundRect.width+"px"),Gb.Util.setCSSStyle(this._roundDiv,"height",this._roundRect.height+"px"),Gb.Util.setCSSStyle(this._roundDiv,"background",this.isFill()?this.getFillColor():null),Gb.Util.setCSSStyle(this._roundDiv,"-webkit-border-radius",this.getCornerRadius()+"px"),Gb.Util.setCSSStyle(this._roundDiv,"-moz-border-radius",this.getCornerRadius()+"px"),Gb.Util.setCSSStyle(this._roundDiv,"border-radius",this.getCornerRadius()+"px"),this._pointers?(Gb.Util.setCSSStyle(this._triangleDiv,"left",this._triangleDivLocation.x+"px"),Gb.Util.setCSSStyle(this._triangleDiv,"top",this._triangleDivLocation.y+"px"),Gb.Util.setCSSStyle(this._triangleDiv,"border-width",this._triangleBorderWidthStyle),Gb.Util.setCSSStyle(this._triangleDiv,"border-color",this._triangleBorderColorStyle),this._view.appendChild(this._triangleDiv)):this._triangleDiv.parentNode==this._view&&this._view.removeChild(this._triangleDiv),this._element.getStyle("label.rotatable")&&this.label){var a=this._ui.getFromPoint(),b=this._ui.getToPoint(),c=this._ui.getLinkPoints();c.size()%2==0&&(a=c.get(c.size()/2-1),b=c.get(c.size()/2)),this._radian=a.x>b.x?Gb.Util.getRadiansBetweenLines(b,a):Gb.Util.getRadiansBetweenLines(a,b),this._origin={x:this._contentRect.width/2,y:0};var d="rotate("+Gb.Util.toDegrees(this._radian)+"deg)",e=this._origin.x+"px "+this._origin.y+"px";Gb.Util.isChrome||Gb.Util.isSafari?(Gb.Util.setCSSStyle(this._roundDiv,"-webkit-transform",d),Gb.Util.setCSSStyle(this._roundDiv,"-webkit-transform-origin",e)):Gb.Util.isIE?(Gb.Util.setCSSStyle(this._roundDiv,"-ms-transform",d),Gb.Util.setCSSStyle(this._roundDiv,"-ms-transform-origin",e)):(Gb.Util.setCSSStyle(this._roundDiv,"transform",d),Gb.Util.setCSSStyle(this._roundDiv,"transform-origin",e))}else Gb.Util.removeCSSStyle(this._roundDiv,"-webkit-transform"),Gb.Util.removeCSSStyle(this._roundDiv,"-webkit-transform-origin"),Gb.Util.removeCSSStyle(this._roundDiv,"-ms-transform"),Gb.Util.removeCSSStyle(this._roundDiv,"-ms-transform-origin"),Gb.Util.removeCSSStyle(this._roundDiv,"transform"),Gb.Util.removeCSSStyle(this._roundDiv,"transform-origin"),delete this._origin,delete this._radian}}),Gb.network.HTMLLabelAttachment=function(a,b){Gb.network.HTMLBasicAttachment.call(this,a,b),this.label=!0},Gb.Util.ext("twaver.network.HTMLLabelAttachment",Gb.network.LabelAttachment,{updateMeasure:function(){var a=this.getFont("label.font"),b=this.getLabel();this._contentDiv.innerHTML=b,Gb.Util.setCSSStyle(this._contentDiv,"font",a),Gb.network.HTMLBasicAttachment.prototype.updateMeasure.call(this),Gb.Util.removeCSSStyle(this._contentDiv,"font")},calculateMeasure:Gb.network.HTMLBasicAttachment.prototype.calculateMeasure}),Gb.network.HTMLAlarmAttachment=function(a,b){Gb.network.HTMLBasicAttachment.call(this,a,b),this.alarm=!0},Gb.Util.ext("twaver.network.HTMLAlarmAttachment",Gb.network.AlarmAttachment,{updateMeasure:function(){var a=this.getFont("alarm.font");this._contentDiv.innerHTML=this._network.getAlarmLabel(this._element),Gb.Util.setCSSStyle(this._contentDiv,"font",a),this._fillColor=this._network.getAlarmFillColor(this._element),Gb.network.HTMLBasicAttachment.prototype.updateMeasure.call(this),Gb.Util.removeCSSStyle(this._contentDiv,"font")},calculateMeasure:Gb.network.HTMLBasicAttachment.prototype.calculateMeasure}),Gb.network.NodeUI=function(a,b){Gb.network.NodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.NodeUI",Gb.network.ElementUI,{createBodyRect:function(){return this._element.getRect()},invalidate:function(a){Gb.network.NodeUI.superClass.invalidate.call(this,a);var b=this._element.getAgentLinks();b&&b.forEach(function(a){this._network.invalidateElementUI(a,!1)},this)},updateMeasure:function(){Gb.network.NodeUI.superClass.updateMeasure.call(this);var a=this.getStyle("vector.shape"),b=this.getBodyRect();this._hotSpot=Rb.getHotSpot(b.x,b.y,b.width,b.height,a),this.drawBody(),this._outerColor&&this.drawOuterBorder(),!this._editAttachment&&"border"===this.getStyle("select.style")&&this._network.isSelected(this._element)&&this.drawSelectBorder(),this.cleanUp(["_selectCanvas","_nodeCanvas","_nodeImage","_nodeComponent","_vectorCanvas","_outerCanvas"]);var c=this._element.getParent();c instanceof Nd&&this._network.invalidateElementUI(c,!1)},drawBody:function(){var a=this.getStyle("body.type");"default"===a?this.drawDefaultBody():"vector"===a?this.drawVectorBody():"default.vector"===a?(this.drawVectorBody(),this.drawDefaultBody()):"vector.default"===a?(this.drawDefaultBody(),this.drawVectorBody()):this.addBodyBounds({x:this._element.getX(),y:this._element.getY(),width:0,height:0})},drawOuterBorder:function(){var a=this._element,b=a.getStyle("outer.width");if(b>0){var c=this.getBodyRect();Rb.addPadding(c,a,"outer.padding",1),this._outerCanvas||(this._outerCanvas=Ub.createCanvas());var d=Hb.clone(c);Rb.grow(d,b/2,b/2);var e=Ub.setCanvas(this._outerCanvas,d);e.lineWidth=b,e.lineCap=a.getStyle("outer.cap"),e.lineJoin=a.getStyle("outer.join"),e.strokeStyle=this._outerColor,Vb.drawVector(e,a.getStyle("outer.shape"),null,c),e.stroke(),this.addComponent(this._outerCanvas),this.addBodyBounds(d)}},drawSelectBorder:function(){var a=this._element,b=a.getStyle("select.width");if(b>0){var c=this.getBodyRect();c=Hb.clone(c);var d=a.getStyle("select.physicalZoom")?1:this._network.getGraphicsZoom();Rb.addPadding(c,a,"select.padding",1/d),this._selectCanvas||(this._selectCanvas=Ub.createCanvas()),Rb.grow(c,b/2/d,b/2/d);var e=Ub.setCanvas(this._selectCanvas,bounds);e.lineWidth=b/d,e.lineCap=a.getStyle("select.cap"),e.lineJoin=a.getStyle("select.join"),e.strokeStyle=a.getStyle("select.color"),Vb.drawVector(e,a.getStyle("select.shape"),null,c),e.stroke(),this.addComponent(this._selectCanvas),this.addBodyBounds(bounds)}},drawDefaultBody:function(){var a=this._element,b=Hb.getImageAsset(a.getImage()),c=this.getBodyRect();if(!b)return this.addBodyBounds(c),void(this._currentImageAsset=null);if(Rb.addPadding(c,this._element,"image.padding",1),b.getImage()){this._nodeCanvas||(this._nodeCanvas=Ub.createCanvas());var d=Hb.clone(c),e=this.setShadow(this,this._nodeCanvas,d);0!=a.getAngle()&&(c=a.getOriginalRect(),Gb.Util.rotateCanvas(e,c,a.getAngle())),Mc(e,a.getImage(),this.getInnerColor(),c,a,this._network),c=d,this.addComponent(this._nodeCanvas)}else if(b.getSrc())this._nodeImage||(this._nodeImage=Ub.createImg()),Ub.setImg(this._nodeImage,b.getSrc(),c),this.addComponent(this._nodeImage);else{if(!b.getFunction())throw"ImageAsset '"+a.getImage()+" ' is empty";this._nodeComponent=this._currentImageAsset!==b?b.getFunction()(this,c):b.getFunction()(this,c,this._nodeComponent),this.addComponent(this._nodeComponent),this._nodeComponent._viewRect=Hb.clone(c)}this.addBodyBounds(c),this._currentImageAsset=b},hit:function(a,b){if(this._network._transparentSelectionEnable){var c=this.getBodyRect();if(Hb.math.containsPoint(c,a,b))return!0}return this.hitCanvas(a,b,["_nodeCanvas","_outerCanvas","_vectorCanvas"])?!0:this.hitComponent(a,b,["_nodeImage","_nodeComponent"])},intersects:function(a){if(this._network._transparentSelectionEnable){var b=this.getBodyRect();if(Hb.math.intersects(b,a))return!0}return this.intersectsCanvas(a,["_nodeCanvas","_outerCanvas","_vectorCanvas"])?!0:this.intersectsComponent(a,["_nodeImage","_nodeComponent"])},drawVectorBody:function(){this._vectorCanvas||(this._vectorCanvas=Ub.createCanvas());var a=Vb.drawPath(this,this._vectorCanvas,"vector",!0,this._element.getStyle("vector.outline.pattern")),b=this.getStyle("vector.deep"),c=this._vectorCanvas.getContext("2d"),d=this.getBodyRect(),e=this.getStyle("vector.fill.color");if(0!==b&&e){var f=this._element.getAngle();0!=f&&(d=this._element.getOriginalRect(),Gb.Util.rotateCanvas(c,d,-f),Gb.Util.rotateCanvas(c,d,f)),"rectangle"===this.getStyle("vector.shape")&&Vb.draw3DRect(c,e,b,d)}this.addBodyBounds(a),this.addComponent(this._vectorCanvas)}}),Gb.network.LinkUI=function(a,b){Gb.network.LinkUI.superClass.constructor.call(this,a,b),this._linkCanvas=Ub.createCanvas()},Hb.ext("twaver.network.LinkUI",Gb.network.ElementUI,{isEditable:function(){return wc.isOrthogonalLink(this._element)&&this.getControlPoint()?!0:!1},createBodyRect:function(){var a=this.getHotSpot();return a?{x:a.x-1,y:a.y-1,width:2,height:2}:null},hit:function(a,b){return this.hitCanvas(a,b,["_linkCanvas"])},intersects:function(a){return this.intersectsCanvas(a,["_linkCanvas"])},checkAttachments:function(){Gb.network.LinkUI.superClass.checkAttachments.call(this),this.checkLinkHandlerAttachment()},checkLinkHandlerAttachment:function(){var a=this._network.getLinkHandlerLabel(this._element);null!=a&&""!==a?this._linkHandlerAttachment||(this._linkHandlerAttachment=new Gb.network.LinkHandlerAttachment(this),this.addAttachment(this._linkHandlerAttachment)):this._linkHandlerAttachment&&(this.removeAttachment(this._linkHandlerAttachment),this._linkHandlerAttachment=null)},getLinkHandlerAttachment:function(){return this._linkHandlerAttachment},getLinkPoints:function(){return this._linkPoints||(this._linkPoints=this.createLinkPoints(),this._lineLength=Rb.calculateLineLength(this._linkPoints)),this._linkPoints},invalidate:function(a){this._linkPoints=null,this._fromPoint=null,this._toPoint=null,Gb.network.LinkUI.superClass.invalidate.call(this,a)},getFromPosition:function(a,b){var c=this.getFromPoint();return c?{x:c.x+a,y:c.y+b}:null},getToPosition:function(a,b){var c=this.getToPoint();return c?{x:c.x+a,y:c.y+b}:null},getFromPoint:function(){return this._fromPoint||(this._fromPoint=wc.createFromPoint(this)),this._fromPoint},getToPoint:function(){return this._toPoint||(this._toPoint=wc.createToPoint(this)),this._toPoint},updateMeasure:function(){Gb.network.LinkUI.superClass.updateMeasure.call(this),this.drawBody()},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=this.getStyle("link.type"),d=new md;if(wc.isOrthogonalOrFlexionalLink(this._element))d=wc.orthogonalAndFlexional(this,c);else if(this._element.isLooped()){var e=this._network.getElementUI(this._element.getFromAgent());null!=e&&(this._hotSpot=wc.fillLoopedPoints(this,e.getBodyRect(),d))}else{if("arc"!==c&&"triangle"!==c&&"parallel"!==c)throw"Can not resolve link type '"+c+"'";this._hotSpot=wc.fillBundlePoints(this,c,a,b,d)}if(this._network._linkPathFunction){var f=this._network._linkPathFunction(this,d);f&&(d=f)}return d},drawLinePoints:function(a,b,c,d,e){if(a.lineWidth=c,a.strokeStyle=d,this._element.getStyle("link.flow")===!0&&e&&e.length>1){var f=new tc(a,e[0],e[1]),g=this._element.getStyle("link.flow.offset");this._element.getStyle("link.flow.converse")?g<e[0]?f.overflow=e[0]-g:g>=e[0]&&g<=e[0]+e[1]?(f.overflow=e[1]-(g-e[0]),f.overflow&&(f.isLine=!1)):(g-=e[0]+e[1],f.overflow=e[0]-g):g<=e[1]?(f.overflow=g,g&&(f.isLine=!1)):g>e[1]&&g<=e[0]+e[1]?f.overflow=g-e[1]:(g-=e[0]+e[1],g&&(f.isLine=!1),f.overflow=g),this._element._styleMap["link.flow.offset"]=g,a.beginPath(),Vb._drawLine(b,a),a.stroke(),a.shadowColor="transparent",a.beginPath();var h=this._element.getStyle("link.flow.color");h=h?h:Dd.NETWORK_LINK_FLOW_COLOR,a.strokeStyle=h,Vb._drawLine(b,f),a.stroke(),a.shadowColor=this._shadowColor}else a.beginPath(),Vb.drawLinePoints(a,b,e),a.stroke()},drawBody:function(){var a=this.getLinkPoints();if(a&&!(a.size()<2)){var b=this._element,c=Rb.getLineRect(a),d=b.getStyle("link.width"),e=d;if(this._outerColor){var f=b.getStyle("outer.width");e+=2*f}var g=!this._editAttachment&&"border"===b.getStyle("select.style")&&this._network.isSelected(this._element);if(g){var h=b.getStyle("select.width");e+=2*h}Rb.grow(c,e/2,e/2),b.getStyle("arrow.from")&&(c=Rb.unionRect(c,nd.getArrowRect(a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset")))),b.getStyle("arrow.to")&&(c=Rb.unionRect(c,nd.getArrowRect(a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset"))));var i=this.setShadow(this,this._linkCanvas,c);i.lineCap=b.getStyle("link.cap"),i.lineJoin=b.getStyle("link.join");var j=b.getStyle("link.pattern");g&&this.drawLinePoints(i,a,e,b.getStyle("select.color"),j),this._outerColor&&this.drawLinePoints(i,a,d+2*f,this._outerColor,j),this.drawLinePoints(i,a,d,this._innerColor||b.getStyle("link.color"),j),this.addBodyBounds(c),this.addComponent(this._linkCanvas),nd.drawLinkArrow(this,i,a)}},getControlPoint:function(){return wc.getControlPoint(this._element,this)},setControlPoint:function(a){if(a){var b=this.getStyle("link.type");if(wc.hasControlPoint(b)){var c=wc.getLinkSourceBounds(this),d=wc.getLinkTargetBounds(this);wc.setParamsByControlPoint(a,c,d,b,this._element)}}},getLineLength:function(){return this._lineLength}}),Gb.network.HTMLLinkUI=function(a,b){Gb.network.HTMLLinkUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.HTMLLinkUI",Gb.network.LinkUI,{checkAttachments:function(){Gb.network.LinkUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Gb.network.HTMLLinkUI.superClass.checkLabelAttachment.call(this);var b=this._network.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Gb.network.HTMLLabelAttachment(this),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Gb.network.HTMLLinkUI.superClass.checkAlarmAttachment.call(this);var b=this._network.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Gb.network.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)}}),Gb.network.GroupUI=function(a,b){Gb.network.GroupUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.GroupUI",Gb.network.NodeUI,{isEditable:function(){return!this._element.isExpanded()},drawBody:function(){this.getBodyRect();this._shapeRect?this.drawExpandedGroup():Gb.network.GroupUI.superClass.drawBody.call(this)},drawExpandedGroup:function(){this._nodeCanvas||(this._nodeCanvas=Ub.createCanvas());var a=Vb.drawPath(this,this._nodeCanvas,"group",!1,this._element.getStyle("vector.outline.pattern")),b=this.getStyle("group.deep"),c=this.getStyle("group.fill.color");0!==b&&c&&"rectangle"===this.getStyle("group.shape")&&Vb.draw3DRect(this._nodeCanvas.getContext("2d"),c,b,this._bodyRect),this.addBodyBounds(a),this.addComponent(this._nodeCanvas)},getChildrenRects:function(){return this._network.getGroupChildrenRects(this._element)},createBodyRect:function(){this._shapeRect=null;var a=this._element;if(a.isExpanded()){var b=this.getChildrenRects();if(!b.isEmpty()){var c=a.getStyle("group.shape"),d=Sb[c];if(!d)throw"Can not resolve group shape '"+c+"'";this._shapeRect=d(b)}}return this._shapeRect?(Rb.addPadding(this._shapeRect,a,"group.padding",1),this._shapeRect):Gb.network.GroupUI.superClass.createBodyRect.call(this)}}),Gb.network.GridUI=function(a,b){Gb.network.GridUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.GridUI",Gb.network.NodeUI,{drawDefaultBody:function(){this._element.getImage()?Gb.network.GridUI.superClass.drawDefaultBody.call(this):this.drawGridBody()},drawGridBody:function(){var a=this.getStyle("grid.fill"),b=this.getStyle("grid.deep"),c=this.getStyle("grid.cell.deep");if(a||0!==b||0!==c){var d=this.getBodyRect(),e=this.getDyeColor("grid.fill.color");this._nodeCanvas||(this._nodeCanvas=Ub.createCanvas());var f=Hb.clone(d),g=this.setShadow(this,this._nodeCanvas,f);if(g.rect(d.x,d.y,d.width,d.height),this.addComponent(this._nodeCanvas),a&&(g.fillStyle=e,g.fill()),0!=b&&Vb.draw3DRect(g,e,b,d.x,d.y,d.width,d.height),0!=c)for(var h=this.getStyle("grid.row.count"),i=this.getStyle("grid.column.count"),j=0;h>j;j++)for(var k=0;i>k;k++){var l=this._element.getCellRect(j,k);null!=l&&Vb.draw3DRect(g,e,c,l.x,l.y,l.width,l.height)}this.addBodyBounds(f)}}}),Gb.network.ShapeNodeUI=function(a,b){Gb.network.ShapeNodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.ShapeNodeUI",Gb.network.NodeUI,{drawDefaultBody:function(){if(this._element._points.size()<2)return void this.addBodyBounds({x:this._element.getX(),y:this._element.getY(),width:0,height:0});this._nodeCanvas||(this._nodeCanvas=Ub.createCanvas());var a=Vb.drawPath(this,this._nodeCanvas,"vector",!0,this._element.getStyle("vector.outline.pattern"),this._element._points,this._element._segments,this._element.getStyle("shapenode.closed"));this.addBodyBounds(a),this.addComponent(this._nodeCanvas),nd.drawLinkArrow(this,this._nodeCanvas.getContext("2d"),Rb.getPointObject(this._element._points,this._element._segments))},drawSelectBorder:function(){var a=this._element,b=a.getStyle("select.width");if(b>0){var c=this.getBodyRect();c=Hb.clone(c);var d=a.getStyle("select.physicalZoom")?1:this._network.getGraphicsZoom();Rb.addPadding(c,a,"select.padding",1/d);var e=a.getStyle("vector.outline.width");e>0&&Rb.grow(c,e/2,e/2),this._selectCanvas||(this._selectCanvas=Ub.createCanvas()),Rb.grow(c,b/2/d,b/2/d);var f=Ub.setCanvas(this._selectCanvas,c);f.lineWidth=b/d,f.lineCap=a.getStyle("select.cap"),f.lineJoin=a.getStyle("select.join"),f.strokeStyle=a.getStyle("select.color"),Vb.drawVector(f,a.getStyle("select.shape"),null,c),f.stroke(),this.addComponent(this._selectCanvas),this.addBodyBounds(bounds)}}}),Gb.network.ShapeLinkUI=function(a,b){Gb.network.ShapeLinkUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.ShapeLinkUI",Gb.network.LinkUI,{isEditable:function(){return!0},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=new md,d=this.getStyle("shapelink.type");c.add(a),null!=this._element._points&&c.addAll(this._element._points),c.add(b);var e=c.size(),f=Math.floor(e/2);if(e%2===0){var g=c.get(f),h=c.get(f-1);this._hotSpot={x:(g.x+h.x)/2,y:(g.y+h.y)/2}}else this._hotSpot=Hb.clone(c.get(f));var i,j,k;if("lineto"===d);else if("quadto"===d){for(i=new md(c.get(0)),j=1,e=c.size();e>j;j++)i.add(e-1>j?new md([c.get(j++),c.get(j)]):c.get(j));c=i}else if("cubicto"===d){for(i=new md(c.get(0)),j=1,e=c.size();e>j;j++)i.add(e-2>j?new md([c.get(j++),c.get(j++),c.get(j)]):e-1>j?new md([c.get(j++),c.get(j)]):c.get(j));c=i}else{if("orthogonalto"!==d)throw"Can not resolve shapelink type '"+d+"'";for(k=c.get(0),i=new md(k),j=1,e=c.size();e>j;j++)if(e-1>j){var l=Hb.clone(c.get(j)),m=l.x,n=l.y,o=m-k.x,p=n-k.y;Math.abs(o)>Math.abs(p)?(l.x=m,l.y=k.y):(l.x=k.x,l.y=n),k=l,i.add(k)}else i.add(c.get(j));c=i}return c}}),Gb.network.RotatableNodeUI=function(a,b){Gb.network.RotatableNodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.network.RotatableNodeUI",Gb.network.NodeUI,{isEditable:function(){return!1},drawDefaultBody:function(){var a=this._element,b=Hb.getImageAsset(a.getImage()),c=this.getBodyRect();if(!b)return this.addBodyBounds(c),void(this._currentImageAsset=null);if(Rb.addPadding(c,this._element,"image.padding",1),b.getImage()){this._nodeCanvas||(this._nodeCanvas=Ub.createCanvas());var d=Hb.clone(c),e=this.setShadow(this,this._nodeCanvas,d),f=this._element._getOrignalWidth(),g=this._element._getOrignalHeight(),h=this._element._getRotateRect();e.save(),e.translate(c.x-h.x+f/2,c.y-h.y+g/2),e.rotate(this._element._angle*Math.PI/180);var c={x:-f/2,y:-g/2,width:f,height:g};Mc(e,b.getImage(this._innerColor,c.width,c.height),this._innerColor,c,a,this._network),e.restore(),this.addComponent(this._nodeCanvas)}else if(b.getSrc());else if(!b.getFunction())throw"ImageAsset '"+a.getImage()+" ' is empty";this.addBodyBounds(c),this._currentImageAsset=b}}),Gb.network.HTMLNodeUI=function(a,b){Gb.network.HTMLNodeUI.superClass.constructor.call(this,a,b)},Gb.Util.ext("twaver.network.HTMLNodeUI",Gb.network.NodeUI,{checkAttachments:function(){Gb.network.NodeUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Gb.network.HTMLNodeUI.superClass.checkLabelAttachment.call(this);var b=this._network.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Gb.network.HTMLLabelAttachment(this,Dd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Gb.network.HTMLNodeUI.superClass.checkAlarmAttachment.call(this);var b=this._network.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Gb.network.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)}}),Gb.network.interaction.BaseInteraction=function(a){this.network=a},Hb.ext("twaver.network.interaction.BaseInteraction",Object,{setUp:function(){},tearDown:function(){},addListener:function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];Ub.addEventListener(b,"handle_"+b,this.network.getView(),this)}},removeListener:function(){for(var a=0;a<arguments.length;a++)Ub.removeEventListener(arguments[a],this.network.getView(),this)},_handle_mousedown:function(a){0===a.button&&(this._startLogical=this.network.getLogicalPoint(a),this._startClient=Ub.getClientPoint(a),this._startLogical&&Ub.handle_mousedown(this,a))},_handle_mousemove:function(a){this._endLogical={x:this._startLogical.x+(a.clientX-this._startClient.x)/this.network.getZoom(),y:this._startLogical.y+(a.clientY-this._startClient.y)/this.network.getZoom()}},_handle_mouseup:function(a){delete this._startClient,delete this._startLogical,delete this._endLogical}}),Gb.network.interaction.SelectInteraction=function(a){Gb.network.interaction.SelectInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.network.interaction.SelectInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown"),this.end()},handle_mousedown:function(a){if(this._button=a.button,this.network.isValidEvent(a)&&!this.network.isMovingElement()&&!this.network.isEditingElement()&&!a.shiftKey){var b=this.network.getElementAt(a),c=this.network.getSelectionModel();b?Hb.isCtrlDown(a)?c.contains(b)?c.removeSelection(b):c.appendSelection(b):c.contains(b)||c.setSelection(b):(Hb.isCtrlDown(a)||c.clearSelection(),this.end(a),this.network.getLogicalPoint(a)&&this.network.isRectSelectEnabled()&&this._handle_mousedown(a))}},handle_mouseup:function(a){this.end(a)},handle_mousemove:function(a){if(0!==this._button||this.network.isMovingElement()||this.network.isEditingElement())return void this.end(a);this._handle_mousemove(a),this.mark?this.network.fireInteractionEvent({kind:"selectBetween",event:a}):(this.mark=Ub.createDiv(),this.network.getTopDiv().appendChild(this.mark),this.network.setSelectingElement(!0),this.network.fireInteractionEvent({kind:"selectStart",event:a}));var b=Rb.getRect([this._startLogical,this._endLogical]);Ub.setDiv(this.mark,b,this.getIntersectMode()?this.network.getSelectFillColor():null,this.network.getSelectOutlineWidth(),this.network.getSelectOutlineColor())},end:function(a){if(this._startLogical){if(this.mark){if(this._endLogical&&this._startLogical.x!==this._endLogical.x&&this._startLogical.y!==this._endLogical.y){var b=this.network.getElementsAtRect(this.mark._viewRect,this.getIntersectMode(),this.network.getRectSelectFilter());if(b&&b.size()>0){var c=this.network.getSelectionModel(),d=c.toSelection();b.forEach(function(a){c.contains(a)?d.remove(a):d.add(a)},this),c.setSelection(d)}this.network.fireInteractionEvent({kind:"selectEnd",event:a})}var e=this;setTimeout(function(){e.mark&&(e.network.getTopDiv().removeChild(e.mark),e.mark=null)},0),this.network.setSelectingElement(!1)}this._handle_mouseup(a)}},getIntersectMode:function(){return"intersect"===this.network.getSelectMode()?!0:"contain"===this.network.getSelectMode()?!1:this._startLogical.x>this._endLogical.x&&this._startLogical.y>this._endLogical.y}}),Gb.network.interaction.MoveInteraction=function(a,b){this.lazyMode=b,this.xoffset=0,this.yoffset=0,Gb.network.interaction.MoveInteraction.superClass.constructor.call(this,a),this.currentKeyEvent=null},Hb.ext("twaver.network.interaction.MoveInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","keydown","mouseleave")},tearDown:function(){this.removeListener("mousedown","keydown","mouseleave"),this.end()},handle_keydown:function(a){this.currentKeyEvent=a,this.addListener("keyup")},handle_keyup:function(a){this.currentKeyEvent=null,this.removeListener("keyup")},handle_mouseleave:function(a){this.end(a)},isParenting:function(){return this._startLogical&&null!=this.currentKeyEvent&&80===this.currentKeyEvent.keyCode},parentProcess:function(a,b){var c=null;null!=this.parent&&(c=this.network.getElementUI(this.parent).getViewRect(),this.parent=null);var d=this;if(a=this.network.getLogicalPoint(a),!b&&this.isParenting()){var e={};e.x=a.x-1,e.y=a.y-1,e.width=2,e.height=2;var f=this.network.getElementsAtRect(e,!0);if(f&&f.size()>0)for(var g=f.size(),h=0;g>h;h++){var i=f.get(h);if(!d.network.getElementBox().getSelectionModel().contains(i)){d.parent=i;break}}}null!=this.parent&&(c=this.network.getElementUI(this.parent).getViewRect()),null==c||b?this.parentMark&&(this.network.getTopDiv().removeChild(this.parentMark),this.parentMark=null):(this.parentMark||(this.parentMark=Hb.html.createDiv(),this.network.getTopDiv().appendChild(this.parentMark)),Hb.html.setDiv(this.parentMark,c,this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,this.network.getLazyMoveOutlineWidth(),this.network.getLazyMoveOutlineColor()))},handle_mousedown:function(a){if(0===a.button&&!this.network.isSelectingElement()&&!this.network.isEditingElement()){var b=this.network.getElementAt(a);this.network.isMovable(b)&&(this.end(a),this._handle_mousedown(a))}},handle_mouseup:function(a){this.end(a)},handle_mousemove:function(a){if(this.network.isSelectingElement()||this.network.isEditingElement()||!this.network.hasMovableSelectedElements()||!this._startLogical)return void this.end(a);if(this._handle_mousemove(a),this.xoffset=this._endLogical.x-this._startLogical.x,this.yoffset=this._endLogical.y-this._startLogical.y,this.lazyMode){if(this.mark)this.network.fireInteractionEvent({kind:"lazyMoveBetween",event:a});else{this.mark=Ub.createDiv();var b;this.network.getMovableSelectedElements().forEach(function(a){var c=this.getElementUI(a);c&&(b=Rb.unionRect(b,c.getViewRect()))},this.network),this.network.getTopDiv().appendChild(this.mark),this.network.setMovingElement(!0),Ub.setDiv(this.mark,b,this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,this.network.getLazyMoveOutlineWidth(),this.network.getLazyMoveOutlineColor()),this.network.fireInteractionEvent({kind:"lazyMoveStart",event:a})}this.mark.style.left=this.xoffset+this.mark._viewRect.x+"px",this.mark.style.top=this.yoffset+this.mark._viewRect.y+"px"}else this._startLogical=this._endLogical,this._startClient=Ub.getClientPoint(a),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a})),this.network.moveSelectedElements(this.xoffset,this.yoffset);this.parentProcess(a,!1)},end:function(a){if(this._startLogical){if(this.lazyMode){if(this.mark){var b=this,c=function(){b.network.fireInteractionEvent({kind:"lazyMoveEnd",event:a}),b.mark&&(b.network.getTopDiv().removeChild(b.mark),b.mark=null,b.network.setMovingElement(!1))};this.network.moveSelectedElements(this.xoffset,this.yoffset,this.network.isLazyMoveAnimate(),c)}}else this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a}));if(this.isParenting()){null==this.parent&&(this.parent=this.network.getCurrentSubNetwork());var b=this;this.network.getMovableSelectedElements().forEach(function(a){a.setParent(b.parent)},this.network)}this.parentProcess(a,!0),this._handle_mouseup(a)}}}),Gb.network.interaction.DefaultInteraction=function(a){Gb.network.interaction.DefaultInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.network.interaction.DefaultInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove","keydown")},tearDown:function(){this.removeListener("mousedown","mousemove","keydown")},handle_mousedown:function(a){if(this.network.isValidEvent(a)){this.network.isFocusOnClick()&&Gb.Util.setFocus(this.network.getView());var b=this.network.getElementAt(a);2===a.detail?this.handleDoubleClicked(a,b):this.handleClicked(a,b)}},handleClicked:function(a,b){Bc.handleClicked(this.network,a,b)},handleDoubleClicked:function(a,b){Bc.handleDoubleClicked(this.network,a,b)},handle_keydown:function(a){Bc.handleKeyDown(this.network,a)},handle_mousemove:function(a){var b=this.network.getElementAt(a),c=this._preElement,d=Cc(c),e=Cc(b);c!==b&&(c&&(d&&d.onMouseLeave&&d.onMouseLeave(c,this.network),this.network.onMouseLeave(c,a)),b&&(e&&e.onMouseEnter&&e.onMouseEnter(b,this.network),this.network.onMouseEnter(b,a))),b&&e&&e.onMouseMove&&e.onMouseMove(b,this.network),this.network.onMouseMove(b,a),this._preElement=b}}),Gb.network.interaction.PanInteraction=function(a){Gb.network.interaction.PanInteraction.superClass.constructor.call(this,a);

},Hb.ext("twaver.network.interaction.PanInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown"),this._oldCursor=this.network.getView().style.cursor},tearDown:function(){this.removeListener("mousedown")},handle_mousedown:function(a){this._startLogical=this.network.getLogicalPoint(a),this._startLogical&&(this._handle_mousedown(a),this.network.getView().style.cursor="pointer")},handle_mouseup:function(a){this._clear()},handle_mousemove:function(a){if(this._startLogical){this._handle_mousemove(a);{var b=this._startLogical.x-this._endLogical.x,c=this._startLogical.y-this._endLogical.y;this.network.panByOffset(b,c)}this._startLogical=this._endLogical,this._startClient=Ub.getClientPoint(a)}},_clear:function(a){this._startLogical&&(this._handle_mouseup(a),this.network.getView().style.cursor=this._oldCursor)}}),Gb.network.interaction.EditInteraction=function(a,b){this.lazyMode=b,this.pointIndex=-1,Gb.network.interaction.EditInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.network.interaction.EditInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.oldCursor=this.network.getView().style.cursor,this.network.setHasEditInteraction(!0)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.network.getView().style.cursor=this.oldCursor,this.network.setHasEditInteraction(!1),this.clear()},clear:function(){this.network.setEditingElement(!1),this.network.setRotatingElement(!1),this.isStart=!1,this.isStartRotate=!1,this.node=null,this.shapeNode=null,this.shapeLink=null,this.linkUI=null,this.resizingRect=null,this.resizeDirection=null,this.pointIndex=-1,this._removeCursor(),this.oldCursor=null,this.mouseMoved=!1,this.horizontal=!1,this.vertical=!1,this.mark&&(this.network.getTopDiv().removeChild(this.mark),this.mark=null),this.rotateScale&&this.network.getTopDiv().contains(this.rotateScale)&&(this.network.getTopDiv().removeChild(this.rotateScale),this.rotateScale=null)},_removeCursor:function(){this.cursorID&&(this.network.getView().style.cursor=this.oldCursor||"default",this.cursorID=null),this.resizeDirection=null,this.isCrossCursor=!1},_setCrossCursor:function(){this.isCrossCursor||(this._removeCursor(),this._setCursor("crosshair"),this.isCrossCursor=!0)},_setCursor:function(a){this.cursorID=a,this.network.getView().style.cursor!==this.cursorID&&(this.network.getView().style.cursor=this.cursorID)},handle_mousedown:function(a){if(0===a.button)if(!Hb.isAltDown(a)||this.network.isEditingElement())!this.network.isEditingElement()||this.isStart||this.isStartRotate||(this.node&&this.resizeDirection?(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:this.lazyMode?"lazyResizeStart":"liveResizeStart",event:a,element:this.node,resizeDirection:this.resizeDirection})):this.shapeNode&&this.pointIndex>=0?Hb.isAltDown(a)?(this.shapeNode.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeNode})):(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:this.lazyMode?"lazyMovePointStart":"liveMovePointStart",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink&&this.pointIndex>=0?Hb.isAltDown(a)?(this.shapeLink.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeLink})):(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:this.lazyMode?"lazyMovePointStart":"liveMovePointStart",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI?(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:this.lazyMode?"lazyMovePointStart":"liveMovePointStart",event:a,element:this.linkUI._element})):this.node&&(this.isStartRotate=!0,this._handle_mousedown(a)));else{var b=this.network.getElementAt(a),c=this.network.getLogicalPoint(a);if(b instanceof Gb.ShapeNode){var d=this.getPointIndex(b.getPoints(),c,!0);d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeNode=b,b.addPoint(c,d),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}if(b instanceof Gb.ShapeLink){var e=new Gb.List(b.getPoints()),f=this.network.getElementUI(b);e.add(f.getFromPoint(),0),e.add(f.getToPoint());var d=this.getPointIndex(e,c)-1;d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeLink=b,b.addPoint(c,d),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.network.fireInteractionEvent({kind:this.lazyMode?"lazeMovePointStart":"liveMovePointStart",event:a,element:b,pointIndex:d}))}}},handle_mouseup:function(a){if(this.isStart){var b=Hb.clone(this._endLogical);if(this.resizingRect)if(this.lazyMode)if(this.network.isResizeAnimate()){var c=this,d=new Gb.animate.AnimateBounds(this.node,this.resizingRect,function(){c.network.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:c.node,resizeDirection:c.resizeDirection}),c.clear()});Gb.animate.AnimateManager.start(d)}else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"liveResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else if(this.shapeNode&&this.pointIndex>=0&&b){var e=this.shapeNode.getPoints().get(this.pointIndex);this.horizontal&&(b.y=e.y),this.vertical&&(b.x=e.x),this.shapeNode.setPoint(this.pointIndex,b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeNode,pointIndex:this.pointIndex})}else if(this.shapeLink&&this.pointIndex>=0&&b){var e=this.shapeLink.getPoints().get(this.pointIndex);this.horizontal&&(b.y=e.y),this.vertical&&(b.x=e.x),this.shapeLink.setPoint(this.pointIndex,b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeLink,pointIndex:this.pointIndex})}else this.linkUI&&b&&(this.linkUI.setControlPoint(b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.linkUI._element}))}this._handle_mouseup(a),this.lazyMode||this.clear()},handle_mousemove:function(a){if(this.isStartRotate&&this.node)return this._handleRotateElement(a,this.node),void(this.network.isShowRotateScale()&&this.showRotateScale());if(this.isStart){if(this.shapeNode&&this.pointIndex>=0)return void this._handleMovingShapeNodePoint(a);if(this.shapeLink&&this.pointIndex>=0)return void this._handleMovingShapeLinkPoint(a);if(this.node&&this.resizeDirection)return void this._handleResizing(a);if(this.linkUI)return void this._handleMovingLinkControlPoint(a)}else if(this.network.isValidEvent(a)){if(this.network.isSelectingElement()||this.network.isMovingElement()||0===this.network.getSelectionModel().size())return void this.clear();var b=this.network.getElementAt(a),c=this.network.getElementUI(b);if(!c||!c.getEditAttachment())return void this.clear();var d=this.network.getLogicalPoint(a);if(b instanceof Ld){if(this.node=b,this._isEditingShapeNode(d)||this._isResizingNode(d))return void this.network.setEditingElement(!0);if(this._isRotatingElement(d))return this.network.setRotatingElement(!0),void this.network.setEditingElement(!0)}else if(b instanceof Gb.ShapeLink){if(this.shapeLink=b,this._isEditingShapeLink(d))return void this.network.setEditingElement(!0)}else if(c instanceof Gb.network.LinkUI){var e=this.network.getEditPointSize();if(wc.isOrthogonalLink(c._element)){this.linkUI=c;var f=this.linkUI.getControlPoint();return void(f&&this._contains(d,f,e)&&(this._setCrossCursor(),this.network.setEditingElement(!0)))}}this.clear()}},_isRotatingElement:function(a){var b=this.network.getRotatePointSize();if(0>=b)return!1;var c=this.node.getOriginalRect(),d=this.node.getAngle();return this._isRotating(a,"crosshair",c,d)},_isRotating:function(a,b,c,d){var e=this.network.getRotatePointSize(),f={x:c.x+c.width/2,y:c.y-this.network.getRotatePointOffset()-e},g=this._rotatePoint(f,d,c),h={x:g.x-e,y:g.y-e,width:2*e,height:2*e};return Rb.containsPoint(h,a)?(this._removeCursor(),this._setCursor(b),!0):!1},_handleRotateElement:function(a,b){this._handle_mousemove(a);var c=this._calculateAngle(this.network.getLogicalPoint(a),b);b.setAngle(c)},_calculateAngle:function(a,b){var c=b.getCenterLocation();return Math.round(180*Math.atan2(c.x-a.x,a.y-c.y)/Math.PI+180)},_handleMovingShapeNodePoint:function(a){if(this._handle_mousemove(a),!this.mouseMoved&&Hb.isCtrlDown(a)){var b=this._endLogical.x-this._startLogical.x,c=this._endLogical.y-this._startLogical.y;this.horizontal=Math.abs(b)>=Math.abs(c),this.vertical=!this.horizontal,this.mouseMoved=!0}var d=this.shapeNode.getPoints().get(this.pointIndex),e=Hb.clone(this._endLogical);this.horizontal&&(e.y=d.y),this.vertical&&(e.x=d.x),this.shapeNode.setPoint(this.pointIndex,e),this.network.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeNode,pointIndex:this.pointIndex})},_handleMovingShapeLinkPoint:function(a){if(this._handle_mousemove(a),!this.mouseMoved&&Hb.isCtrlDown(a)){var b=this._endLogical.x-this._startLogical.x,c=this._endLogical.y-this._startLogical.y;this.horizontal=Math.abs(b)>=Math.abs(c),this.vertical=!this.horizontal,this.mouseMoved=!0}var d=this.shapeLink.getPoints().get(this.pointIndex),e=Hb.clone(this._endLogical);this.horizontal&&(e.y=d.y),this.vertical&&(e.x=d.x),this.shapeLink.setPoint(this.pointIndex,e),this.network.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeLink,pointIndex:this.pointIndex})},_handleMovingLinkControlPoint:function(a){this._handle_mousemove(a),this.linkUI.setControlPoint(Hb.clone(this._endLogical)),this.network.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.linkUI._element})},_handleResizing:function(a){this._handle_mousemove(a);var b=this.node.getAngle(),c=this.node.getLocation(),d=this.node.getWidth()/2,e=this.node.getHeight()/2,f={x:c.x+d,y:c.y+e},g={x:-d,y:-e},h={x:-d,y:e},i={x:d,y:e},j={x:d,y:-e},k={x:0,y:-e},l={x:d,y:0},m={x:0,y:e},n={x:-d,y:0};if("northwest"===this.resizeDirection&&(this._transformPoint(i,f,b),g.x=this._endLogical.x,g.y=this._endLogical.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),"north"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),k.y=o.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}if("northeast"===this.resizeDirection&&(this._transformPoint(h,f,b),j.x=this._endLogical.x,j.y=this._endLogical.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"west"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),n.x=o.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("east"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),l.x=o.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("southwest"===this.resizeDirection&&(this._transformPoint(j,f,b),h.x=this._endLogical.x,h.y=this._endLogical.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"south"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),m.y=o.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}"southeast"===this.resizeDirection&&(this._transformPoint(g,f,b),i.x=this._endLogical.x,i.y=this._endLogical.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),this.lazyMode?(this.mark||(this.mark=Ub.createDiv(),this.mark.style.webkitTransform="rotate("+b+"deg)",this.mark.style.mozTransform="rotate("+b+"deg)",this.mark.style.OTransform="rotate("+b+"deg)",this.mark.style.msTransform="rotate("+b+"deg)",this.mark.style.transform="rotate("+b+"deg)",this.network.getTopDiv().appendChild(this.mark)),Ub.setDiv(this.mark,this.resizingRect,null,this.network.getResizeLineWidth(),this.network.getResizeLineColor()),this.network.fireInteractionEvent({kind:"lazyResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection})):(this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.network.fireInteractionEvent({kind:"liveResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection}))},_isEditingShapeNode:function(a){var b=this.network.getEditPointSize();if(this.node instanceof Gb.ShapeNode){this.shapeNode=this.node;for(var c=this.shapeNode.getPoints(),d=0,e=c.size();e>d;d++){var f=c.get(d);if(this._contains(a,f,b))return this._setCrossCursor(),this.pointIndex=d,!0}}return this.pointIndex=-1,!1},_isEditingShapeLink:function(a){for(var b=this.shapeLink.getPoints(),c=this.network.getEditPointSize(),d=0,e=b.size();e>d;d++){var f=b.get(d);if(this._contains(a,f,c))return this._setCrossCursor(),this.pointIndex=d,!0}return this.pointIndex=-1,!1},_isResizingNode:function(a){var b=this.network.getResizePointSize();if(0>=b)return!1;var c=this.node.getOriginalRect(),d=this.node.getAngle(),e={x:c.x,y:c.y},f=this._rotatePoint(e,d,c);return this._isResizing(a,f.x,f.y,"northwest","nwse-resize")?!0:(e={x:c.x+c.width/2,y:c.y},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"north","ns-resize")?!0:(e={x:c.x+c.width,y:c.y},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"northeast","nesw-resize")?!0:(e={x:c.x,y:c.y+c.height/2},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"west","ew-resize")?!0:(e={x:c.x+c.width,y:c.y+c.height/2},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"east","ew-resize")?!0:(e={x:c.x,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"southwest","nesw-resize")?!0:(e={x:c.x+c.width/2,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"south","ns-resize")?!0:(e={x:c.x+c.width,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"southeast","nwse-resize")?!0:!1)))))))},_rotatePoint:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_isResizing:function(a,b,c,d,e){var f=this.network.getResizePointSize();return this._contains(a,{x:b,y:c},f)?(this.resizeDirection!==d&&(this._removeCursor(),e=this._changeCursorWithAngle(d,this.node.getAngle()),this._setCursor(e),this.resizeDirection=d),!0):!1},_getRect:function(a,b,c,d){var e=c>a?a:c,f=d>b?b:d,g=Math.abs(a-c),h=Math.abs(b-d);return{x:e,y:f,width:g,height:h}},_contains:function(a,b,c){var d={x:b.x-c,y:b.y-c,width:2*c,height:2*c};return Rb.containsPoint(d,a)},getPointIndex:function(a,b,c){if(a.size()<2)return 0;for(var d,e=a.get(0),f=1;f<a.size();f++){if(d=a.get(f),this.isPointOnLine(b,e,d,6))return f;e=d}return e=a.get(0),c&&this.isPointOnLine(b,e,d,6)?a.size():0},showRotateScale:function(){this.rotateScale||(this.rotateScale=Hb.html.createCanvas());var a,b,c,d,e,f=(new Gb.List,this.network.getRotateScaleWidth()),g=this.network.getRotateScaleHeight(),h=this.network.getRotatePointSize(),i=this.node.getAngle(),j=this.node.getOriginalRect(),k={x:j.x+j.width/2,y:j.y-this.network.getRotatePointOffset()-h},l=this._rotatePoint(k,i,j),m="13px Arial",n=i+"°";this.node.getAngle()>=0&&this.node.getAngle()<=180?(b={x:l.x+h,y:l.y},c={x:b.x+f,y:b.y},d={x:c.x,y:c.y-g},e={x:b.x,y:d.y}):this.node.getAngle()>180&&this.node.getAngle()<=360&&(b={x:l.x-h,y:l.y},c={x:b.x-f,y:b.y},d={x:c.x,y:c.y-g},e={x:b.x,y:d.y});var o=new Gb.List([b,c,d,e]),a=Hb.math.getRect(o),p=Hb.html.setCanvas(this.rotateScale,a);p.fillStyle=this.network.getRotateScaleFillColor(),p.fillRect(a.x,a.y,a.width,a.height),p.fillStyle=this.network.getRotateScaleFontColor(),p.textBaseline="middle",p.textAlign="center",p.font=m,p.fillText(n,a.x+a.width/2,a.y+a.height/2),this.network.getTopDiv().appendChild(this.rotateScale)},isPointOnLine:function(a,b,c,d){0>d&&(d=0);var e=this.getDistanceFromPointToLine(a,b,c);return d>=e&&a.x>=Math.min(b.x,c.x)-d&&a.x<=Math.max(b.x,c.x)+d&&a.y>=Math.min(b.y,c.y)-d&&a.y<=Math.max(b.y,c.y)+d},getDistanceFromPointToLine:function(a,b,c){if(b.x===c.x)return Math.abs(a.x-b.x);var d=(c.y-b.y)/(c.x-b.x),e=(c.x*b.y-b.x*c.y)/(c.x-b.x);return Math.abs(d*a.x-a.y+e)/Math.sqrt(d*d+1)},_transformPoint:function(a,b,c){var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x,g=a.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_reversPoint:function(a,b,c){c*=-1;var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x-b.x,g=a.y-b.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_changeCursorWithAngle:function(a,b){var c,d=["auto","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"];switch(a){case"northwest":c=1;break;case"north":c=2;break;case"northeast":c=3;break;case"east":c=4;break;case"southeast":c=5;break;case"south":c=6;break;case"southwest":c=7;break;case"west":c=8;break;default:c=0}return(b>=360||-360>=b)&&(b%=360),b>22.5&&67.5>=b&&(c+=1),-22.5>b&&b>=-67.5&&(c-=1),b>67.5&&112.5>=b&&(c+=2),-67.5>b&&b>=-112.5&&(c-=2),b>112.5&&157.5>=b&&(c+=3),-112.5>b&&b>=-157.5&&(c-=3),b>157.5&&202.5>=b&&(c+=4),-157.5>b&&b>=-202.5&&(c-=4),b>202.5&&247.5>=b&&(c+=5),-202.5>b&&b>=-247.5&&(c-=5),b>247.5&&292.5>=b&&(c+=6),-247.5>b&&b>=-292.5&&(c-=6),b>292.5&&337.5>=b&&(c+=7),-292.5>b&&b>=-337.5&&(c-=7),c>8&&(c-=8),0>=c&&(c+=8),d[c]}}),Gb.network.interaction.MoveLinkInteraction=function(a,b){Gb.network.interaction.MoveLinkInteraction.superClass.constructor.call(this,a),this.xoffset=0,this.yoffset=0},Hb.ext("twaver.network.interaction.MoveLinkInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown"),this.oldCursor=this.network.getView().style.cursor},tearDown:function(){this.removeListener("mousedown"),this.network.getView().style.cursor=this.oldCursor,this.end()},handle_mousedown:function(a){if(0===a.button&&!this.network.isSelectingElement()&&!this.network.isEditingElement()){var b=this.network.getElementAt(a);b instanceof Gb.Link&&(this.element=b,this.end(a),this._handle_mousedown(a))}},handle_mouseup:function(a){this.end(a)},handle_mousemove:function(a){if(!this._startLogical||this.network.isSelectingElement()||this.network.isEditingElement())return void this.end(a);if(this._handle_mousemove(a),this.xoffset=this._endLogical.x-this._startLogical.x,this.yoffset=this._endLogical.y-this._startLogical.y,this.lazyMode){if(this.mark)this.network.fireInteractionEvent({kind:"lazyMoveBetween",event:a,element:this.element});else{this.mark=Ub.createCanvas();var b;this.network.getMovableSelectedElements().forEach(function(a){var c=this.getElementUI(a);c&&(b=Rb.unionRect(b,c.getViewRect()))},this.network),this.network.getTopDiv().appendChild(this.mark),this.network.setMovingElement(!0),Ub.setDiv(this.mark,b,this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,this.network.getLazyMoveOutlineWidth(),this.network.getLazyMoveOutlineColor()),this.network.fireInteractionEvent({kind:"lazyMoveStart",event:a,element:this.element})}this.mark.style.left=this.xoffset+this.mark._viewRect.x+"px",this.mark.style.top=this.yoffset+this.mark._viewRect.y+"px"}else{var c=new Gb.List([this.element.getFromNode(),this.element.getToNode()]);Gb.Util.moveElements(c,this.xoffset,this.yoffset),this._startLogical=this._endLogical,this._startClient=Ub.getClientPoint(a),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a,element:this.element}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a,element:this.element}))}},end:function(a){if(this._startLogical){if(this.lazyMode){if(this.mark){var b=this,c=function(){b.network.fireInteractionEvent({kind:"lazyMoveEnd",event:a,element:this.element}),b.mark&&(b.network.getTopDiv().removeChild(b.mark),b.mark=null,b.network.setMovingElement(!1))},d=new Gb.List([this.element.getFromNode(),this.element.getToNode()]);Gb.Util.moveElements(d,this.xoffset,this.yoffset,this.network.isLazyMoveAnimate(),c)}}else this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a,element:this.element}));this._handle_mouseup(a),delete this.element}}}),Gb.network.interaction.CreateElementInteraction=function(a,b){b||(b=Ld),this.elementFunction=Gb.Util.isTypeOf(b,Ld)?function(a){var c=new b;return c instanceof Ld&&c.setCenterLocation(a),c}:b,Gb.network.interaction.CreateElementInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.network.interaction.CreateElementInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown")},handle_mousedown:function(a){var b=this.network.getLogicalPoint(a);if(b){var c=this.elementFunction(b);c&&this.network.addElementByInteraction(c)}}}),Gb.network.interaction.CreateLinkInteraction=function(a,b){b||(b=Gb.Link),this.linkFunction=Gb.Util.isTypeOf(b,Gb.Link)?function(a,c){var d=new b;return d instanceof Gb.Link&&(d.setFromNode(a),d.setToNode(c)),d}:b,Gb.network.interaction.CreateLinkInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.network.interaction.CreateLinkInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove")},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear()},clear:function(){var a=this;setTimeout(function(){a._fromRectangle&&(a.network.getTopDiv().removeChild(a._fromRectangle),a._fromRectangle=null),a._currentRectangle&&(a.network.getTopDiv().removeChild(a._currentRectangle),a._currentRectangle=null),a._line&&(a.network.getTopDiv().removeChild(a._line),a._line=null)}),this.currentPoint=null,this.currentNode=null,this.fromNode=null,this.toNode=null},createLink:function(){return this.linkFunction(this.fromNode,this.toNode)},handle_mousedown:function(a){if(this.network.isValidEvent(a))if(this.fromNode){if(this.toNode=this.currentNode,this.toNode){var b=this.createLink();b&&this.network.addElementByInteraction(b)}this.clear()}else this.fromNode=this.currentNode,this.currentNode=null,this.currentPoint=null,this.updateMark()},handle_mousemove:function(a){var b=this.network.getLogicalPoint(a);if(b){if(this.network.isMovingElement()||this.network.isEditingElement())return void this.clear();var c=null;this.fromNode?(this.currentNode=this.getToNode(a),this.currentPoint=b,this.updateMark()):(c=this.getFromNode(a),this.currentNode!==c&&(this.currentNode=c,this.updateMark()))}},getFromNode:function(a){return this.getNode(a)},getToNode:function(a){return this.getNode(a)},getNode:function(a){var b=this.network.getElementAt(a);return b instanceof Ld&&this.network.isLinkable(b)?b:null},updateMark:function(){var a;this.fromNode&&!this._fromRectangle&&this._currentRectangle&&(this._fromRectangle=this._currentRectangle,this._currentRectangle=null),!this.fromNode&&this._fromRectangle&&(this.network.getTopDiv().removeChild(this._fromRectangle),this._fromRectangle=null),this.currentNode&&!this._currentRectangle&&(a=this.network.getElementUI(this.currentNode),this._currentRectangle=Ub.createDiv(),this.network.getTopDiv().appendChild(this._currentRectangle),Ub.setDiv(this._currentRectangle,a._viewRect,null,this.network.getEditLineWidth(),this.network.getEditLineColor())),!this.currentNode&&this._currentRectangle&&(this.network.getTopDiv().removeChild(this._currentRectangle),this._currentRectangle=null),this.updateLine()},updateLine:function(){if(this.currentPoint){var a=this.fromNode.getCenterLocation(),b=a.x,c=a.y,d=this.currentPoint.x,e=this.currentPoint.y;this._line||(this._line=Ub.createCanvas(),this.network.getTopDiv().appendChild(this._line));var f=Ub.setCanvas(this._line,Math.min(b,d),Math.min(c,e),Math.abs(b-d),Math.abs(c-e));f.lineWidth=this.network.getEditLineWidth(),f.strokeStyle=this.network.getEditLineColor(),f.beginPath(),f.moveTo(b,c),f.lineTo(d,e),f.stroke()}else this._line&&(this.network.getTopDiv().removeChild(this._line),this._line=null)}}),Gb.network.interaction.CreateShapeNodeInteraction=function(a,b){b||(b=Gb.ShapeNode),this.shapeNodeFunction=Gb.Util.isTypeOf(b,Gb.ShapeNode)?function(a){var c=new b;return c instanceof Gb.ShapeNode&&a&&c.setPoints(a),c}:b,Gb.network.interaction.CreateShapeNodeInteraction.superClass.constructor.call(this,a),this.timeStamp=-1},Hb.ext("twaver.network.interaction.CreateShapeNodeInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove")},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear()},clear:function(){this.network.setEditingElement(!1),this.points=null,this.currentPoint=null,this.lastPoint=null,this.horizontal=!1,this.vertical=!1,this.mark&&(this.network.getTopDiv().removeChild(this.mark),this.mark=null)},handle_mousedown:function(a){if(0===a.button){var b=this.network.getLogicalPoint(a);if(b){if(2===a.detail||a.timeStamp-this.timeStamp<300){if(this.points){var c=this.shapeNodeFunction(this.points);this.network.addElementByInteraction(c),this.clear();var d=this;setTimeout(function(){d.network.setEditingElement(!1)},0)}}else{if(this.network.isEditingElement()||this.network.setEditingElement(!0),this.points||(this.points=new md),this.points.size()>0){var e=this.points.get(this.points.size()-1);if(e.x===b.x&&e.y===b.y)return}this._handle_mousedown(a),this.points.size()>0&&Hb.isCtrlDown(a)&&(this.horizontal&&(b.y=e.y),this.vertical&&(b.x=e.x),this.horizontal=!1,this.vertical=!1),this.lastPoint=b,this.points.add(b),this.updateMark()}this.timeStamp=a.timeStamp}}},handle_mousemove:function(a){if(this.points){if(this.currentPoint=this.network.getLogicalPoint(a),Hb.isCtrlDown(a)){var b=this.currentPoint.x-this.lastPoint.x,c=this.currentPoint.y-this.lastPoint.y;this.horizontal=Math.abs(b)>=Math.abs(c),this.vertical=!this.horizontal}else this.horizontal=!1,this.vertical=!1;this.horizontal&&(this.currentPoint.y=this.lastPoint.y),this.vertical&&(this.currentPoint.x=this.lastPoint.x),this.updateMark()}},updateMark:function(a){if(this.points&&this.points.size()>0&&this.currentPoint){this.mark||(this.mark=Ub.createCanvas(),this.network.getTopDiv().appendChild(this.mark));var b=new md(this.points);b.add(this.currentPoint);var c=Rb.getRect(b),d=this.network.getEditLineWidth();Hb.math.grow(c,d,d);var e=Ub.setCanvas(this.mark,c);e.lineWidth=d,e.strokeStyle=this.network.getEditLineColor(),e.beginPath(),Vb.drawLinePoints(e,b),e.stroke()}}}),Gb.network.interaction.CreateShapeLinkInteraction=function(a,b){Gb.network.interaction.CreateShapeLinkInteraction.superClass.constructor.call(this,a),b||(b=Gb.ShapeLink),this.linkFunction=Gb.Util.isTypeOf(b,Gb.ShapeLink)?function(a,c,d){var e=new b;return e instanceof Gb.ShapeLink&&(e.setFromNode(a),e.setToNode(c),d&&e.setPoints(d)),e}:b},Hb.ext("twaver.network.interaction.CreateShapeLinkInteraction",Gb.network.interaction.CreateLinkInteraction,{clear:function(){this.network.setEditingElement(!1),this.points=null,this.polyline&&(this.network.getTopDiv().removeChild(this.polyline),this.polyline=null),Gb.network.interaction.CreateShapeLinkInteraction.superClass.clear.call(this)},createLink:function(){return this.linkFunction(this.fromNode,this.toNode,this.points)},handle_mousedown:function(a){if(0===a.button){var b=this.network.getLogicalPoint(a);if(b)if(this.fromNode)if(this.toNode=this.currentNode,this.toNode){var c=this.createLink();c&&this.network.addElementByInteraction(c),this.clear()}else{if(this.points||(this.points=new md),this.points.size()>0){var d=this.points.get(this.points.size()-1);if(d.x===b.x&&d.y===b.y)return}this.points.add(b),this.updateMark()}else this.fromNode=this.currentNode,this.fromNode&&(this.polyline||(this.polyline=Ub.createCanvas(),this.network.getTopDiv().appendChild(this.polyline))),this.points=null,this.currentNode=null,this.currentPoint=null,this.updateMark()}},updateLine:function(){if(this.currentPoint&&this.polyline){var a=new md(this.points);a.add(this.fromNode.getCenterLocation(),0),a.add(this.currentPoint);var b=Rb.getRect(a),c=Ub.setCanvas(this.polyline,b);c.lineWidth=this.network.getEditLineWidth(),c.strokeStyle=this.network.getEditLineColor(),c.beginPath(),Vb.drawLinePoints(c,a),c.stroke()}}}),Gb.network.interaction.CreateOrthogonalLinkInteraction=function(a,b,c,d,e,f){Gb.network.interaction.CreateOrthogonalLinkInteraction.superClass.constructor.call(this,a,b),this.linkType=c||"orthogonal",this.isByControlPoint=d,this.splitPercent=e,this.isSplitByPercent=f,this.link=new Gb.Link,this.link.setStyle("link.type",this.linkType),this.link.setStyle("link.split.by.percent",this.isSplitByPercent),wc.isFlexionalTypeLink(this.linkType)||wc.isExtendTypeLink(this.linkType)?(this.splitPercent<0&&(this.splitPercent=Gb.Styles.getStyle("link.extend")),this.link.setStyle("link.extend",this.splitPercent)):wc.isSplitTypeLink(this.linkType)&&(this.splitPercent<0&&(this.splitPercent=Gb.Styles.getStyle(this.isSplitByPercent?"link.split.percent":"link.split.value")),this.isSplitByPercent?this.link.setStyle("link.split.percent",this.splitPercent):this.link.setStyle("link.split.value",this.splitPercent))},Hb.ext("twaver.network.interaction.CreateOrthogonalLinkInteraction",Gb.network.interaction.CreateLinkInteraction,{clear:function(){this.path&&(this.network.getTopDiv().removeChild(this.path),this.path=null),Gb.network.interaction.CreateOrthogonalLinkInteraction.superClass.clear.call(this)},createLink:function(){var a=Gb.network.interaction.CreateOrthogonalLinkInteraction.superClass.createLink.call(this);if(a.setStyle("link.type",this.linkType),a.setStyle("link.split.by.percent",this.isSplitByPercent),this.isByControlPoint){var b=wc.getControlPoint(a);if(b)return a.SetStyle("link.control.point",b),a}else wc.isFlexionalTypeLink(this.linkType)||wc.isExtendTypeLink(this.linkType)?(this.splitPercent<0&&(this.splitPercent=Gb.Styles.getStyle("link.extend")),a.setStyle("link.extend",this.splitPercent)):wc.isSplitTypeLink(this.linkType)&&(this.splitPercent<0&&(this.splitPercent=Gb.Styles.getStyle(this.isSplitByPercent?"link.split.percent":"link.split.value")),this.isSplitByPercent?a.setStyle("link.split.percent",this.splitPercent):a.setStyle("link.split.value",this.splitPercent));return a},updateLine:function(){if(this.currentPoint){if(!this.fromNode||this.currentNode===this.fromNode)return;var a,b=this.network.getElementUI(this.fromNode);if(!b)return;if(a=b.getBodyRect(),null==a)return;var c;if(this.currentNode&&this.currentNode!==this.fromNode){var d=this.network.getElementUI(this.currentNode);if(!d)return;c=d.getBodyRect()}else c={
x:this.currentPoint.x,y:this.currentPoint.y,width:1,height:1};if(!c)return;var e=wc.calculateOrthogonalAndFlexionalLinkPoints(this.linkType,a,c,this.link);if(wc.drawCorner(e,this.link),e.size()<2)return;this.line||(this.line=Ub.createCanvas(),this.network.getTopDiv().appendChild(this.line));var f=Ub.setCanvas(this.line,Rb.getLineRect(e));f.lineWidth=this.network.getEditLineWidth(),f.strokeStyle=this.network.getEditLineColor(),f.beginPath(),Vb.drawLinePoints(f,e),f.stroke()}else this.line&&(this.network.getTopDiv().removeChild(this.line),this.line=null)}}),Gb.network.interaction.MagnifyInteraction=function(a,b,c,d,e){Gb.network.interaction.MagnifyInteraction.superClass.constructor.call(this,a),this.zoom=b||2,this.xRadius=c||100,this.yRadius=d||100,this.shape=e||"circle",this.borderColor="black",this.borderWidth=1,this.backgroundColor="white",this.markCanvas=Ub.createCanvas(),this.markCanvas._isIgnored=!0},Hb.ext("twaver.network.interaction.MagnifyInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){this.addListener("mousemove")},tearDown:function(){this.removeListener("mousemove"),this._clear()},handle_mousemove:function(a){var b=this.network.getLogicalPoint(a);b&&(this.lastPoint||this.network.getView().appendChild(this.markCanvas),this.lastPoint=b,this.updateMark())},updateMark:function(){var a,b=this.network._zoom,c=this.zoom*b,d=this.lastPoint.x*b-this.xRadius,e=this.lastPoint.y*b-this.yRadius,f=2*this.xRadius,g=2*this.yRadius,h={x:this.lastPoint.x-this.xRadius/c,y:this.lastPoint.y-this.yRadius/c,width:f/c,height:g/c},i=this.borderWidth,j=Ub.createCanvas();j.width=f,j.height=g,this.network.toCanvasByRegion(h,c,j),Ub.setCanvas(this.markCanvas,d,e,f,g),a=this.markCanvas.getContext("2d"),a.save(),a.beginPath(),Vb.drawVector(a,this.shape,null,d,e,f,g),a.clip(),a.fillStyle=this.backgroundColor,a.beginPath(),a.rect(d,e,f,g),a.fill(),a.drawImage(j,d,e),a.restore(),a.beginPath(),a.lineWidth=i,Vb.drawVector(a,this.shape,null,d+i/2,e+i/2,f-i,g-i),a.strokeStyle=this.borderColor,a.stroke()},_clear:function(a){this.lastPoint&&(this.network.getView().removeChild(this.markCanvas),this.lastPoint=null)},getZoom:function(){return this.zoom},setZoom:function(a){this.zoom=a,this.updateMark()},getShape:function(){return this.shape},setShape:function(a){this.shape=a,this.updateMark()},getXRadius:function(){return this.xRadius},setXRadius:function(a){this.xRadius=a,this.updateMark()},getYRadius:function(){return this.yRadius},setYRadius:function(a){this.yRadius=a,this.updateMark()},getBorderColor:function(){return this.borderColor},setBorderColor:function(a){this.borderColor=a,this.updateMark()},getBorderWidth:function(){return this.borderWidth},setBorderWidth:function(a){this.borderWidth=a,this.updateMark()},getBackgroundColor:function(){return this.backgroundColor},setBackgroundColor:function(a){this.backgroundColor=a,this.updateMark()}}),Gb.network.interaction.TouchInteraction=function(a){Gb.network.interaction.TouchInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.network.interaction.TouchInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){var a=this.network.getView();Ub.addEventListener("touchstart","handleTouchstart",a,this),Ub.addEventListener("touchmove","handleTouchmove",a,this),Ub.addEventListener("touchend","handleTouchend",a,this),Ub.addEventListener("touchcancel","handleTouchend",a,this)},tearDown:function(){var a=this.network.getView();Ub.removeEventListener("touchstart",a,this),Ub.removeEventListener("touchmove",a,this),Ub.removeEventListener("touchend",a,this),Ub.removeEventListener("touchcancel",a,this)},handleTouchstart:function(a){if(Ub.preventDefault(a),a.touches&&1==a.touches.length){var b=this.network.getLogicalPoint(a),c=this.network.getElementAt(b);this._startTouchTime=new Date,this._startTouchPoint=b;var d=this;c?(this._haveElementUnderTouch=!0,this._startTouchElement=c):(this._haveElementUnderTouch=!1,this._startTouchElement=null),this.timer=setTimeout(function(){Bc.handleLongClicked(d.network,a,c)},1e3)}else a.touches&&2==a.touches.length&&(this._distance=yc.getDistance(a),this._zoom=this.network.getZoom(),this._startTouchPoint={x:a.touches[0].clientX,y:a.touches[0].clientY});this._touchCount=a.touches.length},handleTouchmove:function(a){if(Ub.preventDefault(a),2==this._touchCount&&a.touches&&2==a.touches.length)if(this.timer&&clearTimeout(this.timer),Math.abs(this._distance-yc.getDistance(a))>=Dd.TOUCH_ZOOM_THRESHOLD||this._zoomFlag){this._zoomFlag=!0;var b=yc.getDistance(a)/this._distance;this.network.setTouchZoom(this._zoom*b,!1)}else{var c=a.touches[0],d=this._startTouchPoint.x-c.clientX,e=this._startTouchPoint.y-c.clientY,f=this.network.panByOffset(d,e);this._startTouchPoint.x-=d-f.x,this._startTouchPoint.y-=e-f.y}else if(1==this._touchCount&&a.touches&&1==a.touches.length)if(this._haveElementUnderTouch||!this.network.isRectSelectEnabled()){var g=this.network.getLogicalPoint(a),h=this.network.getElementAt(g);if(this.network.isMovingElement()||null!=this._startTouchElement&&this._startTouchElement==h&&this.network.getMovableSelectedElements().contains(h)){var d=g.x-this._startTouchPoint.x,e=g.y-this._startTouchPoint.y;(Math.abs(d)>=Dd.TOUCH_MOVE_THRESHOLD||Math.abs(e)>=Dd.TOUCH_MOVE_THRESHOLD)&&(this._startTouchPoint=g,this.network.moveSelectedElements(d,e),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a}),this.timer&&clearTimeout(this.timer)))}else{var d=g.x-this._startTouchPoint.x,e=g.y-this._startTouchPoint.y;(Math.abs(d)>=Dd.TOUCH_MOVE_THRESHOLD||Math.abs(e)>=Dd.TOUCH_MOVE_THRESHOLD)&&this.timer&&clearTimeout(this.timer)}}else{this._moveTouchPoint=this.network.getLogicalPoint(a);var d=this._moveTouchPoint.x-this._startTouchPoint.x,e=this._moveTouchPoint.y-this._startTouchPoint.y;if(Math.abs(d)>=Dd.TOUCH_RECT_SELECT_THRESHOLD&&Math.abs(e)>=Dd.TOUCH_RECT_SELECT_THRESHOLD){this.mark?this.network.fireInteractionEvent({kind:"selectBetween",event:a}):(this.mark=Ub.createDiv(),this.network.getTopDiv().appendChild(this.mark),this.network.setSelectingElement(!0),this.network.fireInteractionEvent({kind:"selectStart",event:a}),this.timer&&clearTimeout(this.timer));var i=Rb.getRect([this._startTouchPoint,this._moveTouchPoint]);Ub.setDiv(this.mark,i,this.getIntersectMode()?this.network.getSelectFillColor():null,this.network.getSelectOutlineWidth(),this.network.getSelectOutlineColor())}}},handleTouchend:function(a){if(Ub.preventDefault(a),this.network.isMovingElement())this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a});else if(this.network.isSelectingElement()){var b=this.network.getElementsAtRect(this.mark._viewRect,this.getIntersectMode(),this.network.getRectSelectFilter());if(b&&b.size()>0){var c=this.network.getSelectionModel(),d=c.toSelection();b.forEach(function(a){c.contains(a)?d.remove(a):d.add(a)},this),c.setSelection(d)}this.network.fireInteractionEvent({kind:"selectEnd",event:a}),this.network.getTopDiv().removeChild(this.mark),this.mark=null,this.network.setSelectingElement(!1),this.timer&&clearTimeout(this.timer)}else if(this._startTouchPoint){this._zoomFlag=!1;var e=new Date,f=this.network.getLogicalPoint(a),g=this.network.getElementAt(this._startTouchPoint);this._startTouchPoint&&f&&e.getTime()-this._startTouchTime.getTime()<=500&&Rb.getDistance(this._startTouchPoint,f)<=20&&(g?this.network.getSelectionModel().contains(g)||this.network.getSelectionModel().setSelection(g):this.network.getSelectionModel().clearSelection(),Bc.handleClicked(this.network,a,g),this.timer&&clearTimeout(this.timer),this._endTouchTime&&e.getTime()-this._endTouchTime.getTime()<=500&&Rb.getDistance(this._endTouchPoint,f)<=20?(delete this._endTouchTime,delete this._endTouchPoint,Bc.handleDoubleClicked(this.network,a,g),this.timer&&clearTimeout(this.timer)):(this._endTouchTime=e,this._endTouchPoint=f))}},getIntersectMode:function(){return"intersect"===this.network.getSelectMode()?!0:"contain"===this.network.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y}}),Gb.network.interaction.MSTouchInteraction=function(a){Gb.network.interaction.MSTouchInteraction.superClass.constructor.call(this,a),this._pointerMap={},this._pointerIdArray=[]},Hb.ext("twaver.network.interaction.MSTouchInteraction",Gb.network.interaction.BaseInteraction,{setUp:function(){var a=this.network.getView();Ub.addEventListener("MSPointerDown","handleTouchstart",a,this),Ub.addEventListener("MSPointerMove","handleTouchmove",a,this),Ub.addEventListener("MSPointerUp","handleTouchend",a,this),Ub.addEventListener("MSPointerCancel","handleTouchend",a,this)},tearDown:function(){var a=this.network.getView();Ub.removeEventListener("MSPointerDown",a,this),Ub.removeEventListener("MSPointerMove",a,this),Ub.removeEventListener("MSPointerUp",a,this),Ub.removeEventListener("MSPointerCancel",a,this)},handleTouchstart:function(a){if(this.network.isFocusOnClick()&&Gb.Util.setFocus(this.network._view),!this.network.isSelectingElement()||a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.network.getLogicalPoint(a),c=new Date;if(a.isPrimary&&this._pointerIdArray.length>0&&this.handle_mouseup(a),this._pointerMap[a.pointerId]||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length){var d=this.network.getElementAt(b);this._startTouchElement=d,this._startClientPoint={x:a.clientX,y:a.clientY},Bc.handleClicked(this.network,a,d),this._startTouchTime&&this._startTouchPoint&&c.getTime()-this._startTouchTime.getTime()<=500&&Rb.getDistance(this._startTouchPoint,b)<=20?(Bc.handleDoubleClicked(this.network,a,d),this._doubleClick=!0):(Ub.handle_mousedown(this,a),this._startTouchPoint=b,this._startTouchTime=c);var e=this.network.getSelectionModel();d?Hb.isCtrlDown(a)?e.contains(d)?e.removeSelection(d):e.appendSelection(d):e.contains(d)||e.setSelection(d):Hb.isCtrlDown(a)||e.clearSelection()}else 2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.network.getZoom())}},handleTouchmove:function(a){if(null!=this._startTouchPoint&&0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Rb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10)&&(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length)){var b=this._getDistance()/this._distance;this.network.setZoom(this._zoom*b,!1)}},handleTouchend:function(a){if(this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a})),this.network.isSelectingElement()){var b=this.network.getElementsAtRect(this.mark._viewRect,this.getIntersectMode(),this.network.getRectSelectFilter());if(b&&b.size()>0){var c=this.network.getSelectionModel(),d=c.toSelection();b.forEach(function(a){c.contains(a)?d.remove(a):d.add(a)},this),c.setSelection(d)}this.network.fireInteractionEvent({kind:"selectEnd",event:a}),this.network.getTopDiv().removeChild(this.mark),this.mark=null,this.network.setSelectingElement(!1)}this._doubleClick&&(delete this._doubleClick,delete this._startTouchPoint,delete this._startTouchTime);for(var e=-1,f=0;f<this._pointerIdArray.length;f++)if(this._pointerIdArray[f]==a.pointerId){e=f;break}e>=0&&this._pointerIdArray.splice(e,1),delete this._pointerMap[a.pointerId]},_getDistance:function(){return Rb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})},getIntersectMode:function(){return"intersect"===this.network.getSelectMode()?!0:"contain"===this.network.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y},handle_mousemove:function(a){if(this._startTouchPoint&&1==this._pointerIdArray.length){if(this._moveTouchPoint={x:this._startTouchPoint.x+(a.clientX-this._startClientPoint.x)/this.network.getZoom(),y:this._startTouchPoint.y+(a.clientY-this._startClientPoint.y)/this.network.getZoom()},Rb.getDistance(this._startTouchPoint,this._moveTouchPoint)<3)return;if(null==this._startTouchElement&&this.network.isRectSelectEnabled()){this.mark?this.network.fireInteractionEvent({kind:"selectBetween",event:a}):(this.mark=Ub.createDiv(),this.network.getTopDiv().appendChild(this.mark),this.network.setSelectingElement(!0),this.network.fireInteractionEvent({kind:"selectStart",event:a}));var b=Rb.getRect([this._startTouchPoint,this._moveTouchPoint]);Ub.setDiv(this.mark,b,this.getIntersectMode()?this.network.getSelectFillColor():null,this.network.getSelectOutlineWidth(),this.network.getSelectOutlineColor())}else{var c=this.network.getElementAt(this._moveTouchPoint),d=this._moveTouchPoint.x-this._startTouchPoint.x,e=this._moveTouchPoint.y-this._startTouchPoint.y;if(null!=this._startTouchElement||this.network.isRectSelectEnabled())(this.network.isMovingElement()||null!=this._startTouchElement&&c==this._startTouchElement&&this.network.getMovableSelectedElements().contains(c))&&(this.network.moveSelectedElements(d,e),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a})));else{this.network.panByOffset(-d,-e)}this._startClientPoint.x=a.clientX,this._startClientPoint.y=a.clientY}}},handle_mouseup:function(a){this.handleTouchend(a),this._pointerIdArray=[],this._pointerMap={}}});var Od={_hitCanvas:null,getHitCanvas:function(a,b){null==this._hitCanvas&&(this._hitCanvas=Ub.createCanvas()),0==arguments.length&&(a=2,b=2),this._hitCanvas.setAttribute("width",""+a-1),this._hitCanvas.setAttribute("height",""+b-1),this._hitCanvas.setAttribute("width",""+a),this._hitCanvas.setAttribute("height",""+b);var c=this.getCtx(this._hitCanvas);return c.clearRect(0,0,a,b),this._hitCanvas},disposeHitCanvas:function(){this._hitCanvas=null},getCtx:function(a){return a.getContext("2d")},render:function(a,b,c){void 0!=b&&(a.fillStyle=b,a.fill()),void 0!=c&&(a.strokeStyle=c,a.stroke())},text:function(a,b,c,d,e,f){a.textAlign="center",a.textBaseline="middle",null!=e&&(a.fillStyle=e,a.fillText(b,c,d)),f&&(a.strokeStyle=f,a.strokeText(b,c,d))},circle:function(a,b,c,d,e,f){a.arc(b,c,d,0,2*Math.PI,!0),a.closePath(),this.render(a,e,f)},rect:function(a,b,c,d,e,f,g){a.rect(b,c,d,e),a.closePath(),this.render(a,f,g)},OUT_LEFT:1,OUT_TOP:2,OUT_RIGHT:4,OUT_BOTTOM:8,outcode:function(a,b,c,d,e,f){var g=0;return 0>=e?g|=this.OUT_LEFT|this.OUT_RIGHT:c>a?g|=this.OUT_LEFT:a>c+e&&(g|=this.OUT_RIGHT),0>=f?g|=this.OUT_TOP|this.OUT_BOTTOM:d>b?g|=this.OUT_TOP:b>d+f&&(g|=this.OUT_BOTTOM),g},intersectsLine:function(a,b,c,d,e,f,g,h){var i,j;if(0==(j=this.outcode(c,d,e,f,g,h)))return!0;for(;0!=(i=this.outcode(a,b,e,f,g,h));){if(0!=(i&j))return!1;if(0!=(i&(this.OUT_LEFT|this.OUT_RIGHT))){var k=e;0!=(i&this.OUT_RIGHT)&&(k+=g),b+=(k-a)*(d-b)/(c-a),a=k}else{var l=f;0!=(i&this.OUT_BOTTOM)&&(l+=h),a+=(l-b)*(c-a)/(d-b),b=l}}return!0}};Gb.canvas={},Gb.canvas.interaction={},Gb.canvas.Network=function(a){Gb.canvas.Network.superClass.constructor.apply(this,arguments),this._rootCanvas=Ub.createCanvas(),this._topCanvas=Ub.createCanvas(),this.realWidth=0,this.realHeight=0,this._unionBounds={x:0,y:0,width:0,height:0},this._zoom=1,this._elementUIMap={},this._visibleMap={},this.viewRect={x:0,y:0,width:0,height:0},this.hScrollBarVisible=!1,this.vScrollBarVisible=!1,this.markerList=new Gb.List,this._topAttachmentList=new Gb.List,this.setElementBox(a?a:new Gb.ElementBox),Kb||(this._view=Ub.createView("hidden"),this._view.appendChild(this._rootCanvas),this._view.appendChild(this._topCanvas),Ob.isTouchable?Ob.isMSTouchable?this.setMSTouchInteractions():this.setTouchInteractions():this.setDefaultInteractions(!1),this.setToolTipEnabled(Gb.Defaults.NETWORK_TOOLTIP_ENABLED));var b=this;this._flowLink=function(){if(!(b.isMovingElement()||b.isSelectingElement()||b.isEditingElement()||b._box._layoutMovingElements)){b._flowLinkQuickFinder||(b._flowLinkQuickFinder=new Gb.QuickFinder(b._box,"link.flow","style"));var a=b._flowLinkQuickFinder.find(!0);a.forEach(function(a){a._styleMap["link.flow.offset"]=b.getLinkFlowOffset(a);var c=b.getElementUI(a);c.invalidate(!1)})}},Gb.imageUtil.addEventListener(this.invalidateElementUIs,this)},Hb.ext("twaver.canvas.Network",Gb.controls.View,{__accessor:["selectMode","makeVisibleOnSelected","movableFunction","editPointSize","editPointFillColor","scrollBarWidth","editPointOutlineWidth","editPointOutlineColor","editLineColor","editLineWidth","resizePointSize","resizePointFillColor","resizePointOutlineWidth","resizePointOutlineColor","resizeLineColor","resizeLineWidth","rotatePointSize","rotatePointFillColor","rotatePointOffset","rotatePointOutlineWidth","rotatePointOutlineColor","rotateScaleFillColor","rotateScaleFontColor","rotateScaleWidth","rotateScaleHeight","selectOutlineColor","selectOutlineWidth","selectFillColor","lazyMoveOutlineColor","lazyMoveOutlineWidth","lazyMoveFillColor","rectSelectFilter","paddingRight","paddingBottom","selectionTolerance"],__bool:["doubleClickToUpSubNetwork","doubleClickToSubNetwork","doubleClickToEmptySubNetwork","doubleClickToLinkBundle","doubleClickToGroupExpand","scrollBarVisible","limitViewInCanvas","autoValidateCanvasSize","subNetworkAnimate","lazyMoveAnimate","resizeAnimate","noAgentLinkVisible","keyboardRemoveEnabled","keyboardSelectEnabled","sendToTopOnSelected","lazyMoveFill","editingElement","rotatingElement","movingElement","selectingElement","rectSelectEnabled","limitElementInPositiveLocation","showRotateScale","transparentSelectionEnable","debug","showShadowInEdit"],_currentSubNetwork:null,_subNetworkAnimate:Gb.Defaults.NETWORK_SUBNETWORK_ANIMATE,_scrollBarWidth:10,_scrollBarVisible:!0,_limitViewInCanvas:!0,_autoValidateCanvasSize:!0,_makeVisibleOnSelected:Gb.Defaults.NETWORK_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Gb.Defaults.NETWORK_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Gb.Defaults.NETWORK_KEYBOARD_SELECT_ENABLED,_rectSelectEnabled:Dd.NETWORK_RECT_SELECT_ENABLED,_rectSelectFilter:null,_elementUIFunction:Gb.Defaults.CANVASUI_FUNCTION,_doubleClickToUpSubNetwork:Gb.Defaults.NETWORK_DOUBLECLICK_TO_UPSUBNETWORK,_doubleClickToSubNetwork:Gb.Defaults.NETWORK_DOUBLECLICK_TO_SUBNETWORK,_doubleClickToEmptySubNetwork:Gb.Defaults.NETWORK_DOUBLECLICK_TO_EMPTYSUBNETWORK,_doubleClickToLinkBundle:Gb.Defaults.NETWORK_DOUBLECLICK_TO_LINKBUNDLE,_doubleClickToGroupExpand:Gb.Defaults.NETWORK_DOUBLECLICK_TO_GROUPEXPAND,_selectOutlineColor:Gb.Defaults.NETWORK_SELECT_OUTLINE_COLOR,_selectOutlineWidth:Gb.Defaults.NETWORK_SELECT_OUTLINE_WIDTH,_selectFillColor:Gb.Defaults.NETWORK_SELECT_FILL_COLOR,_sendToTopOnSelected:Gb.Defaults.NETWORK_SENDTOTOP_ON_SELECTED,_lazyMoveOutlineColor:Gb.Defaults.NETWORK_LAZYMOVE_OUTLINE_COLOR,_lazyMoveOutlineWidth:Gb.Defaults.NETWORK_LAZYMOVE_OUTLINE_WIDTH,_lazyMoveFillColor:Gb.Defaults.NETWORK_LAZYMOVE_FILL_COLOR,_lazyMoveFill:Gb.Defaults.NETWORK_LAZYMOVE_FILL,_lazyMoveAnimate:Gb.Defaults.NETWORK_LAZYMOVE_ANIMATE,_resizePointSize:Gb.Defaults.NETWORK_RESIZE_POINT_SIZE,_resizePointFillColor:Gb.Defaults.NETWORK_RESIZE_POINT_FILL_COLOR,_resizePointOutlineColor:Gb.Defaults.NETWORK_RESIZE_POINT_OUTLINE_COLOR,_resizePointOutlineWidth:Gb.Defaults.NETWORK_RESIZE_POINT_OUTLINE_WIDTH,_resizeLineColor:Gb.Defaults.NETWORK_RESIZE_LINE_COLOR,_resizeLineWidth:Gb.Defaults.NETWORK_RESIZE_LINE_WIDTH,_resizeAnimate:Gb.Defaults.NETWORK_RESIZE_ANIMATE,_editPointSize:Gb.Defaults.NETWORK_EDIT_POINT_SIZE,_editPointFillColor:Gb.Defaults.NETWORK_EDIT_POINT_FILL_COLOR,_editPointOutlineColor:Gb.Defaults.NETWORK_EDIT_POINT_OUTLINE_COLOR,_editPointOutlineWidth:Gb.Defaults.NETWORK_EDIT_POINT_OUTLINE_WIDTH,_editLineColor:Gb.Defaults.NETWORK_EDIT_LINE_COLOR,_editLineWidth:Gb.Defaults.NETWORK_EDIT_LINE_WIDTH,_rotatePointSize:Gb.Defaults.NETWORK_ROTATE_POINT_SIZE,_rotatePointFillColor:Gb.Defaults.NETWORK_ROTATE_POINT_FILL_COLOR,_rotatePointOffset:Gb.Defaults.NETWORK_ROTATE_POINT_OFFSET,_rotatePointOutlineWidth:Gb.Defaults.NETWORK_ROTATE_POINT_OUTLINE_WIDTH,_rotatePointOutlineColor:Gb.Defaults.NETWORK_ROTATE_POINT_OUTLINE_COLOR,_rotateScaleWidth:Dd.NETWORK_ROTATE_SCALE_WIDTH,_rotateScaleHeight:Dd.NETWORK_ROTATE_SCALE_HEIGHT,_rotateScaleFillColor:Dd.NETWORK_ROTATE_SCALE_FILL_COLOR,_rotateScaleFontColor:Dd.NETWORK_ROTATE_SCALE_FONT_COLOR,_limitElementInPositiveLocation:Dd.NETWORK_LIMIT_ELEMENT_INPOSITIVE_LOCATION,_linkFlowInterval:Dd.NETWORK_LINK_FLOW_INTERVAL,_selectionTolerance:Dd.NETWORK_SELECTION_TOLERANCE,_invalidateElementVisibility:!1,_invalidateViewRectFlag:!1,_repaintTopFlag:!1,_invalidateCanvasSizeFlag:!1,_isEditingElement:!1,_isRotatingElement:!1,_isMovingElement:!1,_isSelectingElement:!1,_hasEditInteraction:!1,_showRotateScale:!0,_paddingRight:0,_paddingBottom:0,_transparentSelectionEnable:Gb.Defaults.NETWORK_TRANSPARENT_SELECTION_ENABLE,_debug:!1,_showShadowInEdit:!1,adjustBounds:function(a){if(Kb)this._rootCanvas=new Jb(a.width,a.height),this._topCanvas=new Jb(a.width,a.height),this.setViewRect(a.x,a.y,a.width,a.height);else{var b=!1,c=this._view.style;if(c.left==a.x+"px"&&c.top==a.y+"px"&&c.width==a.width+"px"&&c.height==a.height+"px"&&(b=!0),Gb.canvas.Network.superClass.adjustBounds.apply(this,arguments),1==b)return;var d=this._view.offsetWidth,e=this._view.offsetHeight;this._rootCanvas.setAttribute("width",d),this._rootCanvas.setAttribute("height",e),this._topCanvas.setAttribute("width",d),this._topCanvas.setAttribute("height",e),this.setViewRect(this.viewRect.x,this.viewRect.y,d,e)}"undefined"==typeof Gb.gis&&(Gb.Util.makeHighRes(this._rootCanvas),Gb.Util.makeHighRes(this._topCanvas)),this.invalidateElementVisibility()},getLabel:function(a){return a.getStyle("network.label")||a.getName()},getBackgroundImage:function(){return this._backgroundImage},setBackgroundImage:function(a){if(this._backgroundImage!=a){var b=this._backgroundImage;this._backgroundImage=a;var c=this._backgroundImage;if(c&&!c._viewRect)if(c.width>0)c._viewRect={x:0,y:0,width:c.width,height:c.height},this.validateCanvasSize(),this.firePropertyChange("backgroundImage",b,c);else{var d=this;c.onload=function(){c._viewRect={x:0,y:0,width:c.width,height:c.height},d.validateCanvasSize(),d.firePropertyChange("backgroundImage",b,c),c.onload=null}}else this.firePropertyChange("backgroundImage",b,c),this.validateCanvasSize()}},getRootCanvas:function(){return this._rootCanvas},getTopCanvas:function(){return this._topCanvas},validateImpl:function(){if(!Kb&&mc.twm(this),1==this._invalidateElementVisibility){this._invalidateElementVisibility=!1;var a,b,c,d=this.getElementBox().getDatas()._as,e=d.length,f={},g=this._visibleFunction,h=1===this._box._layerBox.size()?this._box._layerBox._defaultLayer:null;for(a=0;e>a;a++)b=d[a],f[b._id]=this.isVisible(b,g,h);if(this._visibleMap)for(a=0;e>a;a++)b=d[a],f[b._id]!==this._visibleMap[b._id]&&(c=this._elementUIMap[b._id],c&&c.invalidate());for(a=0;e>a;a++)b=d[a],c=this._elementUIMap[b._id],c&&c.validate();this._visibleMap=f,this.paintRoot()}this.validateCanvasSize(),1==this._repaintTopFlag&&(this._repaintTopFlag=!1,this.paintTopCanvas())},isLinkFlowEnabled:function(){return this._linkFlowEnabled?!0:!1},setLinkFlowEnabled:function(a){a?(this._linkFlowEnabled||(this._linkFlowEnabled=!0,this.firePropertyChange("linkFlowEnabled",!1,!0)),clearInterval(this._linkFlowTimerId),this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval)):(this._linkFlowEnabled&&(this._linkFlowEnabled=!1,this.firePropertyChange("linkFlowEnabled",!0,!1)),clearInterval(this._linkFlowTimerId),delete this._linkFlowTimerId)},getLinkFlowInterval:function(){return this._linkFlowInterval},setLinkFlowInterval:function(a){var b=this._linkFlowInterval;this._linkFlowInterval=a,this.firePropertyChange("linkFlowInterval",b,a),clearInterval(this._linkFlowTimerId),this.isLinkFlowEnabled()&&(this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval))},getElementBox:function(){return this._box},setElementBox:function(a){if(!a)throw"ElementBox can not be null";if(this._box!==a){var b=this._box;b&&(b.removeDataBoxChangeListener(this.handleElementBoxChange,this),b.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),b.removePropertyChangeListener(this.handleElementBoxPropertyChange,this),b.removeIndexChangeListener(this.handleIndexChange,this),b.getLayerBox().removeDataBoxChangeListener(this.handleLayerBoxChange,this),b.getLayerBox().removeDataPropertyChangeListener(this.handleLayerPropertyChange,this),b.getLayerBox().removeHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._selectionModel||b.getSelectionModel().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addDataBoxChangeListener(this.handleElementBoxChange,this),this._box.addDataPropertyChangeListener(this.handleElementPropertyChange,this),this._box.addPropertyChangeListener(this.handleElementBoxPropertyChange,this),this._box.addIndexChangeListener(this.handleIndexChange,this),this._box.getLayerBox().addDataBoxChangeListener(this.handleLayerBoxChange,this),this._box.getLayerBox().addDataPropertyChangeListener(this.handleLayerPropertyChange,this),this._box.getLayerBox().addHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._flowLinkQuickFinder&&(this._flowLinkQuickFinder.dispose(),this._flowLinkQuickFinder=new Gb.QuickFinder(this._box,"link.flow","style")),this._selectionModel?this._selectionModel._setDataBox(a):this._box.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this._elementUIMap={},this._box.forEach(this.createElementUI,this),this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.firePropertyChange("elementBox",b,this._box)}},handleElementBoxChange:function(a){var b=a.data;if("add"===a.kind)this.createElementUI(b),this.invalidateBundleLink(b);else if("remove"===a.kind){var c=this.getElementUI(b);c&&(c.dispose(),delete this._elementUIMap[b.getId()]),b===this._currentSubNetwork&&null!=this._currentSubNetwork&&this._setCurrentSubNetwork(null)}else if("clear"===a.kind){for(var d in this._elementUIMap)this._elementUIMap[d]&&this._elementUIMap[d].dispose&&this._elementUIMap[d].dispose();this._elementUIMap={},null!=this._currentSubNetwork&&this._setCurrentSubNetwork(null)}this.invalidateElementVisibility(),this.invalidateCanvasSize()},handleElementPropertyChange:function(a){var b=a.source,c=this.getElementUI(b);c&&c.handlePropertyChange(a),this.invalidateBundleLink(b),this.invalidateElementVisibility(),this.invalidateCanvasSize()},handleElementBoxPropertyChange:function(){this.invalidateElementVisibility()},handleIndexChange:function(a){this.invalidateElementVisibility()},handleLayerBoxChange:function(){this.invalidateElementVisibility()},handleLayerPropertyChange:function(a){"editable"===a.property&&this.invalidateSelectedElementUIs(!0),this.invalidateElementVisibility()},handleLayerHierarchyChange:function(){this.invalidateElementVisibility()},handleSelectionChange:function(a){a.datas.forEach(function(b){var c=this.getElementUI(b);c&&c.handleSelectionChange(a)},this);var b=this.getSelectionModel().getLastData();b&&("append"===a.kind||"set"===a.kind)&&(this.isMakeVisibleOnSelected()&&this.makeVisible(b),this.isSendToTopOnSelected()&&this.sendToTop(b)),this.invalidateElementVisibility()},sendToTop:function(a){if(this._box.contains(a)){for(var b=a;b._parent&&this.isVisible(b._parent)&&(b=b._parent););b!==a&&this._box.adjustElementIndex(b),this._box.adjustElementIndex(a)}},getScopeRect:function(a){var b=this._zoom;if("viewsize"===a)return{x:this._unionBounds.x-this.viewRect.x,y:this._unionBounds.y-this.viewRect.y,width:this._unionBounds.width,height:this._unionBounds.height};if("viewport"===a){if(this.viewRect)return Hb.cloneRect(this.viewRect)}else if("rootcanvas"===a)return{x:this.viewRect.x,y:this.viewRect.y,width:(Math.abs(this.viewRect.x-this._unionBounds.x)+this._unionBounds.width)*b,height:(Math.abs(this.viewRect.y-this._unionBounds.y)+this._unionBounds.height)*b};return{x:0,y:0,width:0,height:0}},getViewRect:function(){return this.viewRect?Hb.clone(this.viewRect):{x:0,y:0,width:0,height:0}},getCanvasSize:function(){return{width:this.realWidth,height:this.realHeight}},getUnionBounds:function(){return this._unionBounds},setViewOffSet:function(a,b){var c=this.viewRect.x,d=this.viewRect.y,e=this.viewRect.width,f=this.viewRect.height;this.setViewRect(c+a,d+b,e,f)},setViewRect:function(a,b,c,d){1==this.isLimitViewInCanvas()&&(0>a&&(a=0),c>this.realWidth?a=0:a+c>this.realWidth&&(a=this.realWidth-c),0>b&&(b=0),d>this.realHeight?b=0:b+d>this.realHeight&&(b=this.realHeight-d));var e=this.viewRect;(null==this.viewRect||a!=this.viewRect.x||b!=this.viewRect.y||c!=this.viewRect.width||d!=this.viewRect.height)&&(this.viewRect={x:a,y:b,width:c,height:d},this.firePropertyChange("viewRect",e,this.viewRect),this.invalidateElementVisibility())},isHScrollBarVisible:function(){return this.hScrollBarVisible},setHScrollBarVisible:function(a){this.hScrollBarVisible=a},isVScrollBarVisible:function(){return this.vScrollBarVisible},setVScrollBarVisible:function(a){this.vScrollBarVisible=a},dispose:function(){Gb.imageUtil.removeEventListener(this.invalidateElementUIs,this);for(var a in this._elementUIMap){var b=this._elementUIMap[a];b.curInterval&&clearTimeout(b.curInterval)}this.setInteractions(null)},invalidateElementVisibility:function(){this._invalidateElementVisibility||(this._invalidateElementVisibility=!0,this.invalidate())},repaintTopCanvas:function(){this._repaintTopFlag||(this._repaintTopFlag=!0,this.invalidate())},invalidateCanvasSize:function(a){this._invalidateCanvasSizeFlag||(this._invalidateCanvasSizeFlag=!0,this.invalidate())},validateCanvasSize:function(){0!=this._invalidateCanvasSizeFlag&&(this._invalidateCanvasSizeFlag=!1,this._validateCanvasSize())},_validateCanvasSize:function(){if(!this.isMovingElement()){if(0==this.isAutoValidateCanvasSize())return this.realWidth=0,this.realHeight=0,void(this._unionBounds={x:0,y:0,width:0,height:0});var a=this.getElementBox().getDatas(),b=a.size();if(b>0){for(var c={x:0,y:0,width:0,height:0},d=0;b>d;d++){var e=a.get(d);if(this._visibleMap[e._id]){var f=this._elementUIMap[e._id];f&&(c=Rb.unionRect(c,f._viewRect))}}var g=this.getBackgroundImage();if(g&&(c=Rb.unionRect(c,g._viewRect)),this.realWidth==(c.x+c.width)*this.getZoom()&&this.realHeight==(c.y+c.height)*this.getZoom())return;var h=this.getZoom();this.realWidth=(c.x+c.width)*h+this._paddingRight,this.realHeight=(c.y+c.height)*h+this._paddingBottom,this._unionBounds={x:c.x*h,y:c.y*h,width:c.width*h+this._paddingRight,height:c.height*h+this._paddingRight}}else this.realWidth=0,this.realHeight=0,this._unionBounds={x:0,y:0,width:0,height:0};this.setViewRect(this.viewRect.x,this.viewRect.y,this.viewRect.width,this.viewRect.height),this.firePropertyChange("canvasSizeChange",null,this.viewRect)}},getElementUI:function(a){return null==a?null:this._elementUIMap[a._id]},createElementUI:function(a){var b=this._elementUIMap[a.getId()];b||(b=this._elementUIFunction(this,a),b&&(this._elementUIMap[a.getId()]=b))},getElementUIFunction:function(){return this._elementUIFunction},setElementUIFunction:function(a){if(!a)throw"ElementUIFunction can not be null";if(this._elementUIFunction!==a){var b=this._elementUIFunction;this._elementUIFunction=a,this.firePropertyChange("elementUIFunction",b,a),this._box.isEmpty()||(this._elementUIMap={},this._box.forEach(this.createElementUI,this),this.invalidateElementVisibility(),this.invalidateCanvasSize())}},invalidateElementUI:function(a,b){var c=this.getElementUI(a);c&&c.invalidate(b)},invalidateElementUIs:function(a){for(var b in this._elementUIMap){var c=this._elementUIMap[b];c.invalidate(a)}},invalidateSelectedElementUIs:function(a){this.getSelectionModel().getSelection().forEach(function(b){this.invalidateElementUI(b,a);

},this)},invalidateBundleLink:function(a){if(a instanceof Gb.Link&&a._bundleLinks){var b=this._elementUIMap;a._bundleLinks.forEachSiblingLink(function(c){if(c!==a){var d=b[c._id];d&&d.invalidate(!1)}},this)}},paintRoot:function(){var a=this._rootCanvas.getContext("2d");if(a.clearRect(0,0,this._rootCanvas.width,this._rootCanvas.height),this.visibleList=new Gb.List,this._topAttachmentList=new Gb.List,null!=this.getElementBox()){kd.draw(a,this);var b=this.getElementBox().getDatas()._as,c=b.length;a.save(),a.scale(this.getZoom(),this.getZoom()),a.translate(-this.viewRect.x/this.getZoom(),-this.viewRect.y/this.getZoom()),this.paintBottom(a);var d={x:this.viewRect.x/this.getZoom(),y:this.viewRect.y/this.getZoom(),width:this.viewRect.width/this.getZoom(),height:this.viewRect.height/this.getZoom()},e=this.getBackgroundImage(),f=this.getBackgroundImageRect();if(e instanceof Nb&&(f?a.drawImage(e,f.x,f.y,f.width,f.height):a.drawImage(e,0,0,e.width,e.height),e._viewRect={x:0,y:0,width:e.width,height:e.height}),"string"==typeof e){var g=Hb.getImageAsset(e),h={x:0,y:0,width:g.getWidth(),height:g.getHeight()};Mc(a,e,null,h,null,this)}var i,j,k,l,m=this._box._layerBox;if(1===m.size())for(i=0;c>i;i++)j=b[i],this._visibleMap[j._id]&&(k=this._elementUIMap[j._id],null!=k&&this._isInView(k,d)?(k.paint(a),k.setAttachmentVisible&&k.setAttachmentVisible(!0),this.visibleList.add(j)):k.setAttachmentVisible&&k.setAttachmentVisible(!1));else m.forEachByDepthFirst(function(e){for(i=0;c>i;i++)j=b[i],m.getLayerByElement(j)===e&&this._visibleMap[j._id]&&(k=this._elementUIMap[j._id],null!=k&&this._isInView(k,d)?(k.paint(a),k.setAttachmentVisible&&k.setAttachmentVisible(!0),this.visibleList.add(j)):k.setAttachmentVisible&&k.setAttachmentVisible(!1))},null,this);for(c=this._topAttachmentList.size(),i=0;c>i;i++)l=this._topAttachmentList.get(i),l.getElementUI().paintAttachment(a,l);if(this._xyz){var c,n=this._xyz,o=n.markText,p=n.type,q=(n.expired,n.innerHTML),r=0,s=0,t=this.viewRect;a.translate(this.viewRect.x/this.getZoom(),this.viewRect.y/this.getZoom()),a.scale(1/this.getZoom(),1/this.getZoom());{this.getZoom()}void 0!=o&&null!=o&&""!=o||"2"==p?(a.font="15px Arial sans-serif",c=Hb.g.getTextSize(a.font,q),a.fillStyle="red",r=t.width-c.width,s=t.height-20):(a.font="10px Arial sans-serif",c=Hb.g.getTextSize(a.font,q),r=t.width/2-c.width/2,s=t.height/2),a.fillText(q,r,s)}a.restore()}},paintBottom:function(a){},_isInView:function(a,b){return Rb.intersects(b,a._viewRect)},paintTopCanvas:function(){var a=this._topCanvas.getContext("2d");a.clearRect(0,0,this._topCanvas.width,this._topCanvas.height),this.paintMarker(a)},paintMarker:function(a){for(var b=this.markerList.size(),c=0;b>c;c++){var d=this.markerList.get(c);d.paint(a)}},getLayerByElement:function(a){return this._box.getLayerBox().getLayerByElement(a)},getLogicalPoint:function(a){var b;if(Ob.isTouchable&&a.changedTouches&&a.changedTouches.length>0){var c=this._view.getBoundingClientRect(),d=a.changedTouches[0],e=Ob.isAndroid?0:yc.scrollLeft(),f=Ob.isAndroid?0:yc.scrollTop();return b={x:(d.clientX+this.viewRect.x-c.left-e)/this._zoom,y:(d.clientY+this.viewRect.y-c.top-f)/this._zoom}}return b=Ob.isFirefox?{x:(a.layerX+this.viewRect.x)/this.getZoom(),y:(a.layerY+this.viewRect.y)/this.getZoom()}:{x:(a.offsetX+this.viewRect.x)/this.getZoom(),y:(a.offsetY+this.viewRect.y)/this.getZoom()}},getElementAt:function(a,b){if(null==this.visibleList)return null;1===arguments.length&&(b=!0);var c,d;if(a.target?c=this.getLogicalPoint(a):a.event?a.event.target&&(c=this.getLogicalPoint(a.event)):c=a,null!=this._topAttachmentList)for(var e=this._topAttachmentList.size(),f=e-1;f>=0;f--){var g=this._topAttachmentList.get(f);if(d=g.getElement(),(!b||this.isSelectable(d))&&g.hit(c.x,c.y))return d}if(null!=this.visibleList)for(var h=this.visibleList.size(),i=h-1;i>=0;i--){var j=this.visibleList.get(i),k=this.getElementUI(j);if((!b||this.isSelectable(j))&&k&&k.hit(c.x,c.y))return j}return null},hitTest:function(a){var b=this.getElementAt(a);if(!b)return null;var c=this.getElementUI(b);if(!c)return null;var d;return d=a.target?this.getLogicalPoint(a):a,c.hitTest(d.x,d.y)},getElementsAtRect:function(a,b,c,d){var e=new Gb.List;if(null==this.visibleList)return e;d=void 0===d?!0:d;for(var f=this.visibleList.size(),g=f-1;g>=0;g--){var h=this.visibleList.get(g),i=this.getElementUI(h);i&&(!c||c(i._element))&&(d&&this.isSelectable(i._element)||!d)&&(b?i.intersects(a)&&e.add(h):Rb.contains(a,i.getViewRect())&&e.add(h))}return e},getPosition:function(a,b,c,d,e){var f,g=b instanceof Gb.canvas.ElementUI?b:this.getElementUI(b);if(g)if("from"===a||"to"===a){if(g.getFromPosition&&(f="from"===a?g.getFromPosition(d,e):g.getToPosition(d,e)))return c?{x:f.x-c.width/2,y:f.y-c.height/2}:f}else f="hotspot"===a?g.getHotSpot():Tb.get(a,g.getBodyRect(),c);if(!f&&b.getRect&&(f=Tb.get(a,b.getRect(),c)),f)return{x:f.x+d,y:f.y+e};throw"position '"+a+"' object '"+b+"'"},isValidEvent:function(a){if(!a)return!1;var b,c;if(a.currentTarget===this._view){if(Ob.isFirefox?(b=a.layerX,c=a.layerY):(b=a.offsetX,c=a.offsetY),1==this.isHScrollBarVisible()&&c>=this.viewRect.height-this.getScrollBarWidth())return!1;if(1==this.isVScrollBarVisible()&&b>=this.viewRect.width-this.getScrollBarWidth())return!1}return!0},addMarker:function(a){this.markerList.add(a),this.repaintTopCanvas()},removeMarker:function(a){this.markerList.remove(a),this.repaintTopCanvas()},clearMarker:function(){this.markerList.clear(),this.repaintTopCanvas()},isMovable:function(a){return this._box.contains(a)?a instanceof Gb.Link?!1:this._movableFunction&&!this._movableFunction(a)?!1:this.getLayerByElement(a).isMovable():!1},hasMovableSelectedElements:function(){for(var a=this.getSelectionModel().getSelection(),b=0;b<a.size();b++){var c=a.get(b);if(this.isMovable(c))return!0}return!1},getMovableSelectedElements:function(){return this.getSelectionModel().toSelection(function(a){return this.isMovable(a)},this)},moveSelectedElements:function(a,b,c,d){if(0!==a||0!==b){var e=this.getMovableSelectedElementsRect();null!=e&&(this._limitElementInPositiveLocation&&(e.x+a<0&&(a=-e.x),e.y+b<0&&(b=-e.y)),Gb.Util.moveElements(this.getMovableSelectedElements(),a,b,c,d,this))}},getMovableSelectedElementsRect:function(){var a=this.getMovableSelectedElements();if(0===a.size())return null;for(var b=null,c=0,d=a.size();d>c;c++){var e=a.get(c);if(e instanceof Ld){var f=this.getElementUI(e);f&&(b=Rb.unionRect(b,f.getViewRect()))}}return b},isVisible:function(a,b,c){if(!this._box.contains(a))return!1;if(!a.isVisible())return!1;if(3!==arguments.length&&(b=this._visibleFunction),b&&!b(a))return!1;if(!(c||this._box._layerBox.getLayerByElement(a))._visible)return!1;if(uc.getSubNetwork(a)!==this._currentSubNetwork)return!1;if(a instanceof Gb.Link){if(!this._noAgentLinkVisible){if(!a._fromAgent||!a._toAgent)return!1;if(!this.isVisible(a._fromAgent,b,c)||!this.isVisible(a._toAgent,b,c))return!1}if(a.getBundleIndex()>0&&a.getBundleCount()>1&&!a.getStyle("link.bundle.expanded"))return!1}else for(var d=a._parent;d&&!d.ISubNetwork;){if(d instanceof Gb.Group&&(!d.isExpanded()||!this.isVisible(d,b,c)))return!1;d=d._parent}return a.IDummy?!1:!0},getVisibleFunction:function(){return this._visibleFunction},setVisibleFunction:function(a){var b=this._visibleFunction;this._visibleFunction=a,this.firePropertyChange("visibleFunction",b,a),this.invalidateElementVisibility()},isEditable:function(a){return this._box.contains(a)?this._editableFunction&&!this._editableFunction(a)?!1:this.getLayerByElement(a).isEditable():!1},getEditableFunction:function(){return this._editableFunction},setEditableFunction:function(a){var b=this._editableFunction;this._editableFunction=a,this.firePropertyChange("editableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isRotatable:function(a){return this._rotatableFunction&&!this._rotatableFunction(a)?!1:!0},getRotatableFunction:function(){return this._rotatableFunction},setRotatableFunction:function(a){var b=this._rotatableFunction;this._rotatableFunction=a,this.firePropertyChange("rotatableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isLinkable:function(a){return null==this._linkableFunction||this._linkableFunction(a)},getLinkableFunction:function(){return this._linkableFunction},setLinkableFunction:function(a){var b=this._linkableFunction;this._linkableFunction=a,this.firePropertyChange("linkableFunction",b,a),this.invalidateSelectedElementUIs(!0)},onShareSelectionModelChanged:function(){this.invalidateElementUIs()},getShadowColor:function(a){var b=a.getStyle("shadow.color");return!b&&this.isSelected(a)&&"shadow"===a.getStyle("select.style")?a.getStyle("select.color"):b},getSelectColor:function(a){return a.getStyle("select.color")},getAlarmLabel:function(a){var b=a.getAlarmState().getHighestNewAlarmSeverity();if(b){var c=a.getAlarmState().getNewAlarmCount(b)+b.nickName;return a.getAlarmState().hasLessSevereNewAlarms()&&(c+="+"),c}return null},getLinkHandlerLabel:function(a){return a.isBundleAgent()?"+("+a.getBundleCount()+")":null},setInteractions:function(a){var b=this._interactions;b&&b.forEach(function(a){a.tearDown()}),this._interactions=a,a&&a.forEach(function(a){a.setUp()}),this.invalidateSelectedElementUIs(!0),this.firePropertyChange("interactions",b,a)},getInteractions:function(){return this._interactions},setDefaultInteractions:function(a,b){var c=[new Gb.canvas.interaction.DefaultInteraction(this),new Gb.canvas.interaction.SelectInteraction(this),new Gb.canvas.interaction.MoveInteraction(this,a),new Gb.canvas.interaction.ScrollInteraction(this)];b&&c.push(new Gb.canvas.interaction.MoveLinkInteraction(this,a)),this.setInteractions(c)},setTouchInteractions:function(){this.setInteractions([new Gb.canvas.interaction.DefaultInteraction(this),new Gb.canvas.interaction.SelectInteraction(this),new Gb.canvas.interaction.MoveInteraction(this,!1),new Gb.canvas.interaction.ScrollInteraction(this),new Gb.canvas.interaction.TouchInteraction(this)])},setMSTouchInteractions:function(){this.setInteractions([new Gb.canvas.interaction.ScrollInteraction(this),new Gb.canvas.interaction.MSTouchInteraction(this)])},setEditInteractions:function(a){this.setInteractions([new Gb.canvas.interaction.DefaultInteraction(this),new Gb.canvas.interaction.SelectInteraction(this),new Gb.canvas.interaction.EditInteraction(this,a),new Gb.canvas.interaction.MoveInteraction(this,a),new Gb.canvas.interaction.ScrollInteraction(this)])},setCreateElementInteractions:function(a){this.setInteractions([new Gb.canvas.interaction.DefaultInteraction(this),new Gb.canvas.interaction.CreateElementInteraction(this,a)])},setCreateLinkInteractions:function(a){this.setInteractions([new Gb.canvas.interaction.DefaultInteraction(this),new Gb.canvas.interaction.CreateLinkInteraction(this,a),new Gb.canvas.interaction.ScrollInteraction(this)])},setCreateShapeLinkInteractions:function(a){this.setInteractions([new Gb.canvas.interaction.DefaultInteraction(this),new Gb.canvas.interaction.CreateShapeLinkInteraction(this,a),new Gb.canvas.interaction.ScrollInteraction(this)])},setCreateShapeNodeInteractions:function(a){this.setInteractions([new Gb.canvas.interaction.DefaultInteraction(this),new Gb.canvas.interaction.CreateShapeNodeInteraction(this,a),new Gb.canvas.interaction.ScrollInteraction(this)])},setPanInteractions:function(){this.setInteractions([new Gb.canvas.interaction.DefaultInteraction(this),new Gb.canvas.interaction.PanInteraction(this),new Gb.canvas.interaction.ScrollInteraction(this)])},setMagnifyInteractions:function(){this.setInteractions([new Gb.canvas.interaction.DefaultInteraction(this),new Gb.canvas.interaction.SelectInteraction(this),new Gb.canvas.interaction.MoveInteraction(this),new Gb.canvas.interaction.ScrollInteraction(this),new Gb.canvas.interaction.MagnifyInteraction(this)])},hasEditInteraction:function(){return this._hasEditInteraction},setHasEditInteraction:function(a){var b=this._hasEditInteraction;this._hasEditInteraction=a,this.firePropertyChange("hasEditInteraction",b,a)},addElementByInteraction:function(a){a.getParent()||a.setParent(this._currentSubNetwork),this._box.add(a),this.getSelectionModel().setSelection(a),this.fireInteractionEvent({kind:"createElement",element:a})},getToolTip:function(a){if(a){var b=a.getToolTip();return b?b:a.getName()}return null},isToolTipEnabled:function(){return this._toolTipEnabled?!0:!1},setToolTipEnabled:function(a){if(this._toolTipEnabled=a,a){if(!this._toolTipListener){var b=this;this._toolTipListener=function(a){if(b.isMovingElement())return void Ac.hideToolTip();var c=b.getElementAt(a);if(b._preElement!==c)if(b._preElement=c,c){var d=b.getToolTip(c);Ac.showToolTip({x:a.pageX,y:a.pageY},d);var e=Ac.getToolTipDiv(),e=Ac.getToolTipDiv();if(e.children.length>0){var f=b._view.getBoundingClientRect(),g=e.getBoundingClientRect();g.width+g.left>f.width+f.left&&(e.style.left=f.width+f.left-g.width+(Mb.documentElement.scrollLeft||Mb.body.scrollLeft)+"px"),g.height+g.top>f.height+f.top&&(e.style.top=f.height+f.top-g.height+(Mb.documentElement.scrollTop||Mb.body.scrollTop)+"px")}}else Ac.hideToolTip()},this._view.addEventListener("mousemove",this._toolTipListener,!1),this.firePropertyChange("toolTipEnabled",!1,!0)}}else this._toolTipListener&&(Ac.hideToolTip(),this._view.removeEventListener("mousemove",this._toolTipListener,!1),delete this._toolTipListener,this.firePropertyChange("toolTipEnabled",!0,!1))},setZoom:function(a){a=this.checkZoom(a);var b=this._zoom;if(this._zoom!=a){var c={x:(this.viewRect.x+this.viewRect.width/2)/this.getZoom()*a,y:(this.viewRect.y+this.viewRect.height/2)/this.getZoom()*a};this._zoom=a,this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.validateCanvasSize(),this.setViewRect(c.x-this.viewRect.width/2,c.y-this.viewRect.height/2,this.viewRect.width,this.viewRect.height),this.firePropertyChange("zoom",b,this._zoom)}},getZoom:function(){return this._zoom},setTouchZoom:function(a){this.setZoom(a,!1)},zoomOverview:function(a){if(!(this.realWidth<=0||this.realHeight<=0)){var b=this.realWidth/this.getZoom(),c=this.realHeight/this.getZoom(),d=this.viewRect.width/b,e=this.viewRect.height/c,f=Math.min(d,e);this.setZoom(f)}},zoomReset:function(){this.setZoom(1)},zoomIn:function(){this.setZoom(1.2*this.getZoom())},zoomOut:function(){this.setZoom(this.getZoom()/1.2)},upSubNetwork:function(a,b){this._currentSubNetwork&&this.setCurrentSubNetwork(uc.getSubNetwork(this._currentSubNetwork),a,b)},getCurrentSubNetwork:function(){return this._currentSubNetwork},setCurrentSubNetwork:function(a,b,c){if(Gb.animate.AnimateManager.endAnimate(),b){if(this._currentSubNetwork===a)return;if(a&&!this._box.contains(a))throw a+" is not contained in this network's elementBox";var d=new Gb.animate.AnimateSubNetwork(this,a,c);Gb.animate.AnimateManager.start(d)}else this._setCurrentSubNetwork(a),c&&c()},_setCurrentSubNetwork:function(a){if(this._currentSubNetwork!==a){if(a&&!this._box.contains(a))throw a+" is not contained in this network's elementBox";var b=this._currentSubNetwork;this._currentSubNetwork=a,this.firePropertyChange("currentSubNetwork",b,a),this.invalidateElementVisibility(),this.invalidateCanvasSize()}},makeVisible:function(a){var b=this.getElementUI(a);if(b){var c=uc.getSubNetwork(a);if(c!==this._currentSubNetwork){var d=this;return void this.setCurrentSubNetwork(c,this.isSubNetworkAnimate(),function(){Hb.callLater(d.makeVisible,d,[a])})}for(var e=a;(e=e.getParent())&&e!==c;)e instanceof Gb.Group&&e.setExpanded(!0);var f=b.getViewRect();if(f){var g={x:f.x*this.getZoom(),y:f.y*this.getZoom(),width:f.width*this.getZoom(),height:f.height*this.getZoom()};Rb.intersects(this.viewRect,g)||this.isVisible(a)&&Hb.callLater(this.centerByLogicalPoint,this,[g.x+g.width/2,g.y+g.height/2])}}},centerByLogicalPoint:function(a,b,c){var d=a-this.viewRect.width/2,e=b-this.viewRect.height/2;this.setViewRect(d,e,this.viewRect.width,this.viewRect.height)},panByOffset:function(a,b){this.setViewOffSet(a,b)},getIconsNames:function(a){return a.getStyle("icons.names")},getIconsColors:function(a){return a.getStyle("icons.colors")},getLinkFlowStepping:function(a){var b=parseInt(a.getStyle("link.flow.stepping"));return b||(b=Dd.NETWORK_LINK_FLOW_STEPPING),b},getLinkFlowOffset:function(a){var b=a.getStyle("link.flow.offset");return isNaN(b)&&(b=0),b+this.getLinkFlowStepping(a)},toCanvas:function(a,b,c,d,e,f){c||(c=Ub.createCanvas()),c.setAttribute("width",a),c.setAttribute("height",b),c._viewRect?(c._viewRect.width=a,c._viewRect.height=b):c._viewRect={x:0,y:0,width:a,height:b};var g=c.getContext("2d");if(g.translate(-e,-f),g.clearRect(0,0,a,b),kd.draw(g,this),0===this._view.clientWidth||0===this._view.clientHeight)return c;a/this.realWidth*this.getZoom(),b/this.realHeight*this.getZoom();g.scale(d,d);var h=this.getElementBox().getDatas()._as,i=h.length;this._topAttachmentList=new Gb.List;var j,k,l,m,n,o,p=this.getElementBox().getLayerBox(),q=p.getRoots(),r=q.size();if(1===r)for(l=0;i>l;l++)m=h[l],this._visibleMap[m._id]&&(n=this._elementUIMap[m._id],null!=n&&n.paint(g));else for(j=0;r>j;j++)for(k=q.get(j),l=0;i>l;l++)m=h[l],p.getLayerByElement(m)===k&&this._visibleMap[m._id]&&(n=this._elementUIMap[m._id],null!=n&&n.paint(g));for(i=this._topAttachmentList.size(),l=0;i>l;l++)o=this._topAttachmentList.get(l),o.getElementUI().paintAttachment(g,o);return c},toCanvasByRegion:function(a,b,c){c||(c=Ub.createCanvas());var d=a.width*b,e=a.height*b;c.setAttribute("width",d),c.setAttribute("height",e),c._viewRect?(c._viewRect.width=d,c._viewRect.height=e):c._viewRect={x:0,y:0,width:d,height:e};var f=c.getContext("2d");if(f.clearRect(0,0,d,e),kd.draw(f,this),0===this._view.clientWidth||0===this._view.clientHeight)return c;f.save(),f.scale(b,b),f.beginPath(),f.translate(-a.x,-a.y);var g=this.getElementBox().getDatas()._as,h=g.length;this._topAttachmentList=new Gb.List;var i=this.getBackgroundImage();if(i&&i._viewRect&&Rb.intersects(a,i._viewRect)){var a=Rb.intersection(a,i._viewRect),j=i._viewRect;try{f.drawImage(i,j.x,j.y,j.width,j.height)}catch(k){}}var l,m,n,o,p,q,r=this.getElementBox().getLayerBox(),s=r.getRoots(),t=s.size();if(1===t)for(n=0;h>n;n++)o=g[n],this._visibleMap[o._id]&&(p=this._elementUIMap[o._id],null!=p&&Rb.intersects(a,p._viewRect)&&p.paint(f));else for(l=0;t>l;l++)for(m=s.get(l),n=0;h>n;n++)o=g[n],r.getLayerByElement(o)===m&&this._visibleMap[o._id]&&(p=this._elementUIMap[o._id],null!=p&&Rb.intersects(a,p._viewRect)&&p.paint(f));for(h=this._topAttachmentList.size(),n=0;h>n;n++)q=this._topAttachmentList.get(n),q.getElementUI().paintAttachment(f,q);return f.restore(),c},getGroupChildrenRects:function(a){var b=new md;return a.getChildren().forEach(function(a){if(a instanceof Ld){var c=this.getElementUI(a);if(c){var d=c.getViewRect();d&&b.add(d)}}},this),b},getBackgroundImageRect:function(){return null},getLinkPathFunction:function(){return this._linkPathFunction},setLinkPathFunction:function(a){var b=this._linkPathFunction;this._linkPathFunction=a,this.firePropertyChange("linkPathFunction",b,a),this.invalidateElementUIs()},onClickElement:function(a,b){},onClickBackground:function(a){},onDoubleClickElement:function(a,b){},onDoubleClickBackground:function(a){},onLongClickElement:function(a,b){},onLongClickBackground:function(a){},onMouseMove:function(a,b){},onMouseEnter:function(a,b){},onMouseLeave:function(a,b){},setMovingElement:function(a){if(a!=this._movingElement){var b=this._movingElement;this._movingElement=a,this.firePropertyChange("movingElement",b,a),this._box._undoManager._enabled&&(a?this._box._undoManager.startBatch():this._box._undoManager.endBatch())}},setEditingElement:function(a){if(a!=this._editingElement){var b=this._editingElement;this._editingElement=a,this.firePropertyChange("editingElement",b,a),this._box._undoManager._enabled&&(a?this._box._undoManager.startBatch():this._box._undoManager.endBatch())}}}),Gb.canvas.Overview=function(a){Gb.canvas.Overview.superClass.constructor.apply(this,a),this._view=Ub.createView(),this._rootDiv=Ub.createDiv(),this._imageCanvas=Ub.createCanvas(),this._imageDiv=Ub.createDiv(),this._maskCanvas=Ub.createCanvas(),this._selectDiv=Ub.createDiv(),this._isNetworkDirty=!1,this._isMaskDirty=!1,Ub.setVisible(this._selectDiv,!1),this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._imageDiv),this._rootDiv.appendChild(this._maskCanvas),this._rootDiv.appendChild(this._selectDiv),this._imageDiv.appendChild(this._imageCanvas),this._exportImageCanvas=Ub.createCanvas(),this._imageCtx=this._imageCanvas.getContext("2d"),this.setNetwork(a),Ob.isTouchable?Ob.isMSTouchable?new Gb.canvas.OverviewMSTouchInteraction(this):(new Gb.canvas.OverviewTouchInteraction(this),new Gb.canvas.OverviewInteraction(this)):new Gb.canvas.OverviewInteraction(this)},Hb.ext("twaver.canvas.Overview",Gb.controls.ControlBase,{__accessor:["fillColor","outlineColor","outlineWidth","selectColor","selectWidth","padding","maxPackingWidth","maxPackingHeight"],__bool:["animate"],_fillColor:Dd.OVERVIEW_FILL_COLOR,_outlineColor:Dd.OVERVIEW_OUTLINE_COLOR,_outlineWidth:Dd.OVERVIEW_OUTLINE_WIDTH,_selectColor:Dd.OVERVIEW_SELECT_COLOR,_selectWidth:Dd.OVERVIEW_SELECT_WIDTH,_padding:Dd.OVERVIEW_PADDING,_animate:Dd.OVERVIEW_ANIMATE,_maxPackingWidth:Dd.OVERVIEW_MAX_PACKING_WIDTH,_maxPackingHeight:Dd.OVERVIEW_MAX_PACKING_HEIGHT,getNetwork:function(){return this._network},onPropertyChanged:function(a){this._invalidateMask()},setNetwork:function(a){a!==this._network&&(this._network&&(this._network.removePropertyChangeListener(this._handleNetworkPropertyChange,this),this._network.removeViewListener(this._handleNetworkViewChange,this),Ub.removeEventListener("scroll","_handleScrollChange",this._network.getView(),this)),this._network=a,this._network&&(this._network.addPropertyChangeListener(this._handleNetworkPropertyChange,this),this._network.addViewListener(this._handleNetworkViewChange,this),Ub.addEventListener("scroll","_handleScrollChange",this._network.getView(),this)),this.invalidate())},_handleNetworkPropertyChange:function(a){("zoom"===a.property||"currentSubNetwork"===a.property||"elementBox"===a.property||"dataBox"===a.property||"canvasSizeChange"===a.property)&&this.invalidate()},_handleNetworkViewChange:function(a){"validateEnd"===a.kind&&this.invalidate()},_handleScrollChange:function(){this._invalidateMask()},invalidate:function(a){this._isNetworkDirty&&this._isMaskDirty||(this._isNetworkDirty||(this._isNetworkDirty=!0),this._isMaskDirty||(this._isMaskDirty=!0),Hb.callLater(this.validate,this,null,a))},_invalidateMask:function(){this._isMaskDirty||(this._isMaskDirty=!0,Hb.callLater(this.validate,this,[],100))},validate:function(){if((this._isMaskDirty||this._isNetworkDirty)&&this._network&&(this._maxPackingWidth>0&&this._maxPackingHeight>0||this._view.clientWidth>0&&this._view.clientHeight>0)&&0!==this._network.getViewRect().width&&0!==this._network.getViewRect().height&&!this._network._invalidate){var a,b=this._maxPackingWidth>0&&this._maxPackingHeight>0;a=b?{x:0,y:0,width:this._maxPackingWidth,height:this._maxPackingHeight}:{x:0,y:0,width:this._view.clientWidth,height:this._view.clientHeight},Rb.grow(a,-this._padding,-this._padding),b&&(Ub.setDiv(this._view,{x:0,y:0,width:this._imageDiv._viewRect.width,height:this._imageDiv._viewRect.height},null,0,null),a.width=this._imageDiv._viewRect.width,a.height=this._imageDiv._viewRect.height);var c=this._network.getZoom(),d=this._network._unionBounds;d=Rb.unionRect(d,{x:0,y:0,width:d.x,height:d.y}),d={x:d.x/c,y:d.y/c,width:d.width/c,height:d.height/c};var e={x:this._network.viewRect.x/c,y:this._network.viewRect.y/c,width:this._network.viewRect.width/c,height:this._network.viewRect.height/c},f=Rb.unionRect(d,e),g=Math.min(a.width/f.width,a.height/f.height),h=f.width*g,i=f.height*g,j=f.width*g,k=f.height*g,l=a.x+(a.width-j)/2,m=a.y+(a.height-k)/2;if(this._isNetworkDirty){var n={x:l,y:m,width:j,height:k};this._network.toCanvas(h,i,this._exportImageCanvas,g,f.x*g,f.y*g),this._imageCanvas.setAttribute("width",j),this._imageCanvas.setAttribute("height",k),this._imageCtx.drawImage(this._exportImageCanvas,0,0,h,i),Ub.setDiv(this._imageDiv,n,null,0,null),this._network.getElementBox&&(this._imageDiv.style.backgroundColor=(this._network.getCurrentSubNetwork()||this._network.getElementBox()).getStyle("background.color")||""),this._isNetworkDirty=!1}if(this._isMaskDirty){var o={x:(e.x-f.x)*g,y:(e.y-f.y)*g,width:e.width*g,height:e.height*g},p=Ub.setCanvas(this._maskCanvas,l,m,j,k);p.lineWidth=0,p.fillStyle=this._fillColor,Vb.drawVector(p,"rectangle",null,l,m,j,k),p.closePath(),p.fill(),p.stroke(),p.clearRect(l+o.x,m+o.y,o.width,o.height),p.lineWidth=this._outlineWidth,p.strokeStyle=this._outlineColor;var q=o.width-2*this._outlineWidth,r=o.height-2*this._outlineWidth;q=Math.min(q,j-2-o.x-this._outlineWidth),r=Math.min(r,k-2-o.y-this._outlineWidth),Vb.drawVector(p,"rectangle",null,l+o.x+this._outlineWidth,m+o.y+this._outlineWidth,q,r),p.closePath(),p.stroke(),this._isMaskDirty=!1}}else this._isNetworkDirty=!1,this._isMaskDirty=!1},getLogicalPoint:function(a){return Ub.getLogicalPoint(this._view,a,1,this._rootDiv)},centerNetwork:function(a,b){var c=this._imageDiv._viewRect;Rb.containsPoint(c,a)&&(this._network.centerByLogicalPoint((a.x-c.x)/c.width*this._network.getCanvasSize().width,(a.y-c.y)/c.height*this._network.getCanvasSize().height,b),this._invalidateMask())}}),Gb.canvas.OverviewTouchInteraction=function(a){this.overview=a,this.network=a.getNetwork(),this.view=a._view,Ub.addEventListener("touchstart","handleTouchstart",this.view,this)},Hb.ext("twaver.canvas.OverviewTouchInteraction",Object,{handleTouchstart:function(a){Ub.preventDefault(a),this.clear(),this.endPoint=this.overview.getLogicalPoint(a),yc.isMultiTouch(a)&&(this.distance=yc.getDistance(a),this.zoom=this.network.getZoom()),Ub.addEventListener("touchmove","handleTouchmove",this.view,this),Ub.addEventListener("touchend","handleTouchend",this.view,this)},handleTouchmove:function(a){if(this.moved||(this.moved=!0),this.endPoint=this.overview.getLogicalPoint(a),yc.isSingleTouch(a))this.overview.centerNetwork(this.endPoint,!1);else if(this.distance){var b=yc.getDistance(a)/this.distance;this.network.setZoom(this.zoom*b,!1)}},handleTouchend:function(a){if(!this.moved){this.endPoint=this.overview.getLogicalPoint(a);var b=this.lastPoint&&this.lastTouchStartTime&&(new Date).getTime()-this.lastTouchStartTime.getTime()<=300&&Math.abs(this.endPoint.x-this.lastPoint.x)<=10&&Math.abs(this.endPoint.y-this.lastPoint.y)<=10;b?(this.lastPoint=null,this.lastTouchStartTime=null):(this.lastPoint=this.endPoint,this.lastTouchStartTime=new Date),b?Hb.callLater(this.network.zoomReset,this.network,[this.overview._animate]):this.overview.centerNetwork(this.endPoint,this.overview._animate)}this.clear()},clear:function(){this.endPoint&&(this.endPoint=null,Ub.removeEventListener("touchmove",this.view,this),Ub.removeEventListener("touchend",this.view,this)),this.moved=!1}}),Gb.canvas.OverviewMSTouchInteraction=function(a){this.overview=a,this.network=a.getNetwork(),this.view=a._view,this._pointerMap={},this._pointerIdArray=[],Ub.addEventListener("MSPointerDown","handleTouchstart",this.view,this),Ub.addEventListener("MSPointerMove","handleTouchmove",this.view,this),Ub.addEventListener("MSPointerUp","handleTouchend",this.view,this),Ub.addEventListener("MSPointerCancel","handleTouchend",this.view,this)},Hb.ext("twaver.canvas.OverviewMSTouchInteraction",Object,{handleTouchstart:function(a){Ub.preventDefault(a),a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),!this._pointerMap[a.pointerId]&&this.overview.getLogicalPoint(a)&&(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length?(this._startTouchPoint=this.overview.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.network.getZoom())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Rb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.network.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&this._startTouchPoint){var c=this.overview.getLogicalPoint(a);if(null==c)return;this._startTouchPoint=c,this.overview.centerNetwork(this._startTouchPoint,!1)}},handleTouchend:function(a){var b=this.overview.getLogicalPoint(a);if(1==this._pointerIdArray.length&&b){var c=this._endTouchPoint&&this._endTouchTime&&(new Date).getTime()-this._endTouchTime.getTime()<=500&&Rb.getDistance(this._endTouchPoint,b)<=10;c?(this._endTouchPoint=null,this._endTouchTime=null):(this._endTouchPoint=b,this._endTouchTime=new Date),c?Hb.callLater(this.network.zoomReset,this.network,[this.overview._animate]):this.overview.centerNetwork(this._endTouchPoint,this.overview._animate)}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Rb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Gb.canvas.OverviewInteraction=function(a){this.overview=a,this.network=a.getNetwork(),this.view=a._view,Ub.addEventListener("mousedown","handleMousedown",this.view,this)},Hb.ext("twaver.canvas.OverviewInteraction",Object,{handleMousedown:function(a){0===a.button&&(this.clear(),this.endPoint=this.overview.getLogicalPoint(a),Hb.isCtrlDown(a)&&(this.startPoint=this.endPoint,Ub.setVisible(this.overview._selectDiv,!0)),Ub.addEventListener("mousemove","handleMousemove",this.view,this),Ub.addEventListener("mouseup","handleMouseup",this.view,this))},handleMouseup:function(a){if(this.endPoint=this.overview.getLogicalPoint(a),"detail"in a&&2===a.detail)Hb.callLater(this.network.zoomReset,this.network,[this.overview._animate]);else if(Ub.isVisible(this.overview._selectDiv)&&this.startPoint){var b=this.overview._imageDiv._viewRect,c=this.overview._selectDiv._viewRect.x,d=this.overview._selectDiv._viewRect.y,e=b.width/this.overview._selectDiv._viewRect.width,f=b.height/this.overview._selectDiv._viewRect.height,g=Math.min(e,f);this.network.setZoom(g*Math.min(this.network.getViewRect().width/this.network.getCanvasSize().width,this.network.getViewRect().height/this.network.getCanvasSize().height)*this.network.getZoom(),!1);var h=this.network.getCanvasSize().width*((c-b.x+this.overview._selectDiv._viewRect.width/2)/b.width),i=this.network.getCanvasSize().height*((d-b.y+this.overview._selectDiv._viewRect.height/2)/b.height);Hb.callLater(this.network.centerByLogicalPoint,this.network,[h,i,this.overview._animate]),Ub.setVisible(this.overview._selectDiv,!1),Ub.setDiv(this.overview._selectDiv,{x:0,y:0,width:0,height:0},null,0,null),this.startPoint=null}else this.overview.centerNetwork(this.endPoint,this.overview._animate);this.clear()},handleMousemove:function(a){var b=this.overview.getLogicalPoint(a);if(this.endPoint=b,Ub.isVisible(this.overview._selectDiv)&&this.startPoint){var c=b.x>this.startPoint.x?this.startPoint.x:b.x,d=b.x>this.startPoint.x?this.startPoint.y:b.y;b.x>this.startPoint.x&&b.y<this.startPoint.y&&(d=b.y),b.x<this.startPoint.x&&b.y>this.startPoint.y&&(d=this.startPoint.y);var e=this.overview._imageDiv._viewRect;c<e.x&&(c=e.x),c>e.x+e.width&&(c=e.x+e.width),d<e.y&&(d=e.y),d>e.y+e.height&&(d=e.y+e.height);var f=Math.abs(b.x-this.startPoint.x),g=Math.abs(b.y-this.startPoint.y);c+f>e.x+e.width&&(f=e.x+e.width-c),d+g>e.y+e.height&&(g=e.y+e.height-d),Ub.setDiv(this.overview._selectDiv,{x:c,y:d,width:f,height:g},null,this.overview._selectWidth,this.overview._selectColor)}else this.overview.centerNetwork(b,!1)},clear:function(){this.endPoint&&(this.endPoint=null,Ub.removeEventListener("mousemove",this.view,this),Ub.removeEventListener("mouseup",this.view,this))}}),Gb.canvas.ElementUI=function(a,b){this._network=a,this._element=b,
this._attachments=new Gb.List,this._bodyBounds=new Gb.List,this._hitTest=!1,this._hitTest=!1,this._intersectTest=!1,this.invalidate(!0)},Hb.ext("twaver.canvas.ElementUI",Object,{getElement:function(){return this._element},getNetwork:function(){return this._network},handlePropertyChange:function(a){this.invalidate(!0)},handleSelectionChange:function(a){this.invalidate(!0)},invalidate:function(a){void 0===a&&(a=!0),a&&(this._invalidateAttachmentsFlag=!0),this._invalidateFlag||(this._hotSpot=null,this._bodyRect=null,this._invalidateFlag=!0,this._network.invalidateElementVisibility())},updateStyle:function(){this._innerColor=this._network.getInnerColor(this._element),this._outerColor=this._network.getOuterColor(this._element),this._shadowColor=this._network.getShadowColor(this._element),this._shadowXOffset=this._element.getStyle("shadow.xoffset"),this._shadowYOffset=this._element.getStyle("shadow.yoffset"),this._shadowBlur=this._element.getStyle("shadow.blur"),this._wholeAlpha=this._element.getStyle("whole.alpha")},validate:function(){if(0!=this._invalidateFlag){this._bodyBounds.clear(),this._invalidateAttachmentsFlag&&(this._invalidateAttachmentsFlag=!1,this.checkAttachments()),this._invalidateFlag=!1,this.updateStyle(),this.validateImpl(),this._attachments.forEach(function(a){a.validate()});var a;this._bodyBounds.forEach(function(b){a=Rb.unionRect(a,b)}),this._unionBodyBounds=Hb.clone(a),this._attachments.forEach(function(b){a=Rb.unionRect(a,b.getViewRect())}),this._viewRect=a}},validateImpl:function(){},setShadow:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;return b.shadowOffsetX===this._shadowXOffset&&b.shadowOffsetY===this._shadowYOffset&&b.shadowBlur===this._shadowBlur?b:((c||this._network._showShadowInEdit)&&(b.shadowOffsetX=this._shadowXOffset,b.shadowOffsetY=this._shadowYOffset,b.shadowBlur=this._shadowBlur,b.shadowColor=this._shadowColor),b)},clearShadow:function(a){(0!=a.shadowOffsetX||0!=a.shadowOffsetY||0!=a.shadowBlur)&&(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0)},appendShadowBound:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;return c&&(this._shadowXOffset>0?b.width+=this._shadowXOffset:(b.x+=this._shadowXOffset,b.width+=-this._shadowXOffset),this._shadowYOffset>0?b.height+=this._shadowYOffset:(b.y+=this._shadowYOffset,b.height+=-this._shadowYOffset),Rb.grow(b,this._shadowBlur,this._shadowBlur)),b},isShadowable:function(){return this._shadowColor&&this._network.isSelected(this._element)&&"shadow"===this._element.getStyle("select.style")?!0:!1},addAttachment:function(a){this._attachments.add(a)},removeAttachment:function(a){this._attachments.remove(a)},getAttachments:function(){return this._attachments},checkAttachments:function(){this.checkLabelAttachment(),this.checkAlarmAttachment(),this.checkIconsAttachment(),this.checkEditAttachment()},checkLabelAttachment:function(){var a=this._network.getLabel(this._element);null!=a&&""!==a?this._labelAttachment||(this._labelAttachment=new Gb.canvas.LabelAttachment(this,Dd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._network.getAlarmLabel(this._element);null!=a&&""!==a?this._alarmAttachment||(this._alarmAttachment=new Gb.canvas.AlarmAttachment(this,Dd.SHOW_ALARM_IN_ATTACHMENT_DIV),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},checkIconsAttachment:function(){var a=this._network.getIconsNames(this._element);a&&a.length>0?this._iconsAttachment||(this._iconsAttachment=new Gb.canvas.IconsAttachment(this),this.addAttachment(this._iconsAttachment)):this._iconsAttachment&&(this.removeAttachment(this._iconsAttachment),this._iconsAttachment=null)},checkEditAttachment:function(){this._network.hasEditInteraction()&&this._network.isSelected(this._element)&&this._network.isEditable(this._element)&&this.isEditable()?this._editAttachment||(this._editAttachment=new Gb.canvas.EditAttachment(this),this.addAttachment(this._editAttachment)):this._editAttachment&&(this.removeAttachment(this._editAttachment),this._editAttachment=null)},getLabelAttachment:function(){return this._labelAttachment},getAlarmAttachment:function(){return this._alarmAttachment},getIconsAttachment:function(){return this._iconsAttachment},getEditAttachment:function(){return this._editAttachment},isEditable:function(){return!0},getInnerColor:function(){return this._innerColor},getOuterColor:function(){return this._outerColor},getShadowColor:function(){return this._shadowColor},getDyeColor:function(a){return this._innerColor?this._innerColor:this.getStyle(a)},getStyle:function(a){return this._element.getStyle(a)},getFont:function(a){var b=this._element.getStyle(a);return b?b:Gb.Defaults.FONT},paint:function(a){a.save(),a.globalAlpha=this._wholeAlpha,a.beginPath(),this.paintBody(a),this.clearShadow(a),a.closePath(),a.beginPath(),this.paintAttachments(a),a.closePath(),a.restore()},paintBody:function(a){},paintAttachments:function(a){a.beginPath();for(var b=this._attachments.size(),c=0;b>c;c++){var d=this._attachments.get(c);1==this._hitTest&&0==d.isShowOnTop()&&this.paintAttachment(a,d),1==this._intersectTest&&this.paintAttachment(a,d),0==this._hitTest&&0==this._intersectTest&&(d.isShowOnTop()?this._network._topAttachmentList.add(d):this.paintAttachment(a,d))}},paintAttachment:function(a,b){a.beginPath(),b.paint(a),this.clearShadow(a)},getViewRect:function(){return Hb.clone(this._viewRect)},getUnionBodyBounds:function(){return Hb.clone(this._unionBodyBounds)},addBodyBounds:function(a){a&&this._bodyBounds.add(a)},getBodyRect:function(){return this._bodyRect||(this._bodyRect=this.createBodyRect()),Hb.clone(this._bodyRect)},getHotSpot:function(){return this._hotSpot?Hb.clone(this._hotSpot):{x:0,y:0}},setHotSpot:function(a){this._hotSpot=a},hit:function(a,b){return!1},intersects:function(a){return Rb.contains(a,this.getViewRect())?!0:!1},hitCanvasRectAtBody:function(a){var b=Od.getHitCanvas(a.width,a.height),c=Od.getCtx(b);if(c.save(),c.translate(-a.x,-a.y),this._element.getImage){var d=Hb.getImageAsset(this._element.getImage());if(d&&d.getImage()instanceof Hd)return 1}this.paintBody(c);try{for(var e=c.getImageData(0,0,a.width,a.height),f=e.data,g=0;g<e.width;g++)for(var h=0;h<e.height;h++){var i=4*(h*e.width+g),j=f[i+3];if(0!==j)return c.restore(),1}}catch(k){if(Od.disposeHitCanvas(),Rb.contains(this.getUnionBodyBounds(),a))return 0}return c.restore(),-1},hitCanvasRectAtAttachments:function(a){var b=Od.getHitCanvas(a.width,a.height),c=Od.getCtx(b);c.save(),c.translate(-a.x,-a.y),this.paintAttachments(c);try{for(var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=0;f<d.width;f++)for(var g=0;g<d.height;g++){var h=4*(g*d.width+f),i=e[h+3];if(0!==i)return c.restore(),1}}catch(j){Od.disposeHitCanvas()}return c.restore(),-1},hitCanvasRect:function(a){this._intersectTest=!0,1==this._hitTest&&(this._intersectTest=!1);var b=Rb.intersection(a,this._viewRect),c=this.hitCanvasRectAtBody(b);if(1==c)return this._intersectTest=!1,!0;var d=this.hitCanvasRectAtAttachments(b);return 1==d?(this._intersectTest=!1,!0):(this._intersectTest=!1,0==c)},hitCanvasPoint:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._network.getSelectionTolerance();if(d&&d>0&&Rb.grow(c,d,d),!Rb.intersects(this._viewRect,c))return!1;this._hitTest=!0;var e=this.hitCanvasRect(c);return this._hitTest=!1,e},hitTest:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._network.getSelectionTolerance();if(d&&d>0&&Rb.grow(c,d,d),!Rb.intersects(this._viewRect,c))return null;var e=Rb.intersection(c,this._viewRect),f=this.hitCanvasRectAtBody(e);if(1==f)return this;for(var g=this._attachments.size(),h=0;g>h;h++){var i=this._attachments.get(h);if(i.hit(a,b))return i}return 0==f?this:null},dispose:function(){this._attachments.forEach(function(a){a.dispose()}),this._attachments.clear()}}),Gb.canvas.NodeUI=function(a,b){Gb.canvas.NodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.NodeUI",Gb.canvas.ElementUI,{invalidate:function(a){Gb.canvas.NodeUI.superClass.invalidate.call(this,a),this.curInterval&&clearInterval(this.curInterval);var b=this._element.getAgentLinks();b&&b.forEach(function(a){this._network.invalidateElementUI(a,!1)},this);var c=this._element.getParent();c instanceof Gb.Group&&this._network.invalidateElementUI(c,!1)},createBodyRect:function(){return this._element.getRect()},validateImpl:function(){Gb.canvas.NodeUI.superClass.validateImpl.call(this);var a=this.getStyle("vector.shape"),b=this.getBodyRect();this._hotSpot=Rb.getHotSpot(b.x,b.y,b.width,b.height,a),this.validateBodyBounds()},validate:function(){0!=this._invalidateFlag&&Gb.canvas.NodeUI.superClass.validate.call(this)},validateBodyBounds:function(){var a=this.getStyle("body.type");"default"===a?this.addBodyBounds(this.getDefaultBodyRect()):"vector"===a?this.addBodyBounds(this.getVectorBody()):"default.vector"===a?(this.addBodyBounds(this.getVectorBody()),this.addBodyBounds(this.getDefaultBodyRect())):"vector.default"===a&&(this.addBodyBounds(this.getDefaultBodyRect()),this.addBodyBounds(this.getVectorBody())),this._outerColor&&this.addBodyBounds(this.getOuterBorderRect()),!this._editAttachment&&"border"===this.getStyle("select.style")&&this._network.isSelected(this._element)&&this.addBodyBounds(this.getSelectBorderRect())},getDefaultBodyRect:function(){var a=this._element,b=Hb.getImageAsset(a.getImage()),c=this.getBodyRect();if(!b)return c;Rb.addPadding(c,this._element,"image.padding",1),this._defaultRect=c;var d=Hb.clone(c);return this.appendShadowBound(this,d),c=d},getVectorBody:function(){var a=this.getPathRect("vector");return a},getOuterBorderRect:function(){return this._getBorderRect("outer")},getSelectBorderRect:function(){return this._getBorderRect("select")},_getBorderRect:function(a){var b=this._element,c=b.getStyle(a+".width");if(c>0){var d=this.getBodyRect();Rb.addPadding(d,b,a+".padding",1);var e=Hb.clone(d);return Rb.grow(e,c/2,c/2),e}return null},getPathRect:function(a,b){var c=this._element,d=this.getBodyRect();b&&Rb.addPadding(d,c,a+".padding",1);var e=Hb.clone(d),f=c.getStyle(a+".outline.width");return f>0&&Rb.grow(e,f/2,f/2),this.appendShadowBound(this,e),e},paintBody:function(a){this.curInterval&&clearInterval(this.curInterval);var b=this.getStyle("body.type");"default"===b?this.drawDefaultBody(a):"vector"===b?this.drawVectorBody(a):"default.vector"===b?(this.drawVectorBody(a),this.drawDefaultBody(a)):"vector.default"===b&&(this.drawDefaultBody(a),this.drawVectorBody(a)),this._outerColor&&this.drawOuterBorder(a),"border"===this.getStyle("select.style")&&this._network.isSelected(this._element)&&this.drawSelectBorder(a)},drawOuterBorder:function(a){var b=this._element,c=b.getStyle("outer.width");if(c>0){var d=this.getBodyRect();Rb.addPadding(d,b,"outer.padding",1),a.lineWidth=c,a.lineCap=b.getStyle("outer.cap"),a.lineJoin=b.getStyle("outer.join"),a.strokeStyle=this._outerColor,Vb.drawVector(a,b.getStyle("outer.shape"),null,d),a.stroke()}},drawDefaultBody:function(a){var b=this._element,c=Hb.getImageAsset(b.getImage()),d=this._defaultRect;if(c&&c.getImage()){0!=b.getAngle()&&(a.save(),d=b.getOriginalRect(),Gb.Util.rotateCanvas(a,d,b.getAngle())),this.setShadow(this,a);if(c.getImage()instanceof Hd){var e,f=c.getImage().frames,g=c.getImage().size,h=0;e=Jd(f,g,0),a.drawImage(e,d.x,d.y,d.width,d.height),this.curInterval=setInterval(function(){h=(h+f.length)%f.length,e=Jd(f,g,h),a.drawImage(e,d.x,d.y,d.width,d.height),h++},100)}else Mc(a,b.getImage(),this.getInnerColor(),d,b,this._network);0!=b.getAngle()&&a.restore()}},drawSelectBorder:function(a){var b=this._element,c=b.getStyle("select.width");if(c>0){var d=this.getBodyRect();d=Hb.clone(d);var e=b.getStyle("select.physicalZoom")?1:this._network.getZoom();Rb.addPadding(d,b,"select.padding",1/e),Rb.grow(d,c/2/e,c/2/e),a.lineWidth=c/e,a.lineCap=b.getStyle("select.cap"),a.lineJoin=b.getStyle("select.join"),a.strokeStyle=b.getStyle("select.color"),Vb.drawVector(a,b.getStyle("select.shape"),null,d),a.stroke()}},drawVectorBody:function(a){this.drawPath(a,"vector",!0,this._element.getStyle("vector.outline.pattern"));var b=this.getStyle("vector.deep"),c=this.getStyle("vector.fill.color"),d=this.getBodyRect();if(0!==b&&c){var e=this._element.getAngle();0!=e&&(a.save(),d=this._element.getOriginalRect(),Gb.Util.rotateCanvas(a,d,e)),"rectangle"===this.getStyle("vector.shape")&&Vb.draw3DRect(a,c,b,d),0!=e&&a.restore()}},drawPath:function(a,b,c,d,e,f,g){var h=this._element,i=this.getBodyRect();c&&Rb.addPadding(i,h,b+".padding",1);var j=h.getStyle(b+".outline.width");this.setShadow(this,a),0!=h.getAngle()&&(h instanceof Nd||(i=h.getOriginalRect()),a.save(),Gb.Util.rotateCanvas(a,i,h.getAngle()));var k,l=h.getStyle(b+".fill");if(l){k=this._innerColor&&!uc.hasDefault(this._element)?this._innerColor:h.getStyle(b+".fill.color");var m=h.getStyle(b+".gradient");m?Vb.fill(a,k,m,h.getStyle(b+".gradient.color"),i):a.fillStyle=k}var n=h.getStyle(b+".shape"),o=h.getStyle("group.shape.roundrect.radius");0>o&&(o=10),l&&(a.beginPath(),e?Vb.drawLinePoints(a,e,null,f,g):"roundrect"===n&&"group"===b?Vb.drawVector(a,n,null,i,o):Vb.drawVector(a,n,null,i),a.fill()),j>0&&(a.lineWidth=j,a.lineCap=h.getStyle(b+".cap"),a.lineJoin=h.getStyle(b+".join"),a.strokeStyle=h.getStyle(b+".outline.color"),a.beginPath(),e?Vb.drawLinePoints(a,e,d,f,g):"roundrect"===n&&"group"===b?Vb.drawVector(a,n,d,i,o):Vb.drawVector(a,n,d,i),a.stroke()),0!=h.getAngle()&&a.restore()},hit:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._network.getSelectionTolerance();if(d&&d>0&&Rb.grow(c,d,d),this._network._transparentSelectionEnable){var e=this.getBodyRect();if(Hb.math.intersects(e,c))return!0}return Rb.intersects(this.getViewRect(),c)?this.hitCanvasPoint(a,b):!1},intersects:function(a){var b=Gb.canvas.NodeUI.superClass.intersects.apply(this,arguments);if(1==b)return!0;if(this._network._transparentSelectionEnable){var c=this.getBodyRect();if(Hb.math.intersects(c,a))return!0}return Rb.intersects(a,this.getViewRect())?this.hitCanvasRect(a):!1}}),Gb.canvas.LinkUI=function(a,b){Gb.canvas.LinkUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.LinkUI",Gb.canvas.ElementUI,{isEditable:function(){return wc.isOrthogonalLink(this._element)&&this.getControlPoint()?!0:!1},invalidate:function(a){this._linkPoints=null,this._fromPoint=null,this._toPoint=null,this._angle=null,Gb.canvas.LinkUI.superClass.invalidate.call(this,a)},validateImpl:function(){this.validateBodyBounds(),Gb.canvas.LinkUI.superClass.validateImpl.call(this)},validateBodyBounds:function(){var a=this.getLinkPoints();if(a&&!(a.size()<2)){var b=this._element,c=Rb.getLineRect(a),d=b.getStyle("link.width"),e=d;if(this._outerColor){var f=b.getStyle("outer.width");e+=2*f}var g=!this._editAttachment&&"border"===b.getStyle("select.style")&&this._network.isSelected(this._element);if(g){var h=b.getStyle("select.width");e+=2*h}Rb.grow(c,e/2,e/2),b.getStyle("arrow.from")&&(this._network._debug&&(this._arrowFromRect=nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset"))),c=Rb.unionRect(c,nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset")))),b.getStyle("arrow.to")&&(this._network._debug&&(this._arrowToRect=nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset"))),c=Rb.unionRect(c,nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset")))),this.appendShadowBound(this,c),this.addBodyBounds(c)}},createBodyRect:function(){var a=this.getHotSpot();return a?{x:a.x-1,y:a.y-1,width:2,height:2}:null},paintBody:function(a){var b=this._linkPoints;if(b&&!(b.size()<2)){var c=this._element,d=c.getStyle("link.width"),e=d;if(this._outerColor){var f=c.getStyle("outer.width");e+=2*f}var g=!this._editAttachment&&"border"===c.getStyle("select.style")&&this._network.isSelected(this._element);if(g){var h=c.getStyle("select.width");e+=2*h}this.setShadow(this,a),a.lineCap=c.getStyle("link.cap"),a.lineJoin=c.getStyle("link.join");var i=c.getStyle("link.pattern");g&&this.drawLinePoints(a,b,e,c.getStyle("select.color"),i),this._outerColor&&this.drawLinePoints(a,b,d+2*f,this._outerColor,i),this.drawLinePoints(a,b,d,this._innerColor||c.getStyle("link.color"),i),nd.drawLinkArrow(this,a,b)}},drawLinePoints:function(a,b,c,d,e){if(a.lineWidth=c,a.strokeStyle=d,this._element.getStyle("link.flow")===!0&&e&&e.length>1){var f=new tc(a,e[0],e[1]),g=this._element.getStyle("link.flow.offset"),h=Math.floor(g/(e[0]+e[1]));h>2&&(g-=(e[0]+e[1])*h),this._element.getStyle("link.flow.converse")?g<e[0]?f.overflow=e[0]-g:g>=e[0]&&g<=e[0]+e[1]?(f.overflow=e[1]-(g-e[0]),f.overflow&&(f.isLine=!1)):(g-=e[0]+e[1],f.overflow=e[0]-g):g<=e[1]?(f.overflow=g,g&&(f.isLine=!1)):g>e[1]&&g<=e[0]+e[1]?f.overflow=g-e[1]:(g-=e[0]+e[1],g&&(f.isLine=!1),f.overflow=g),this._element._styleMap["link.flow.offset"]=g,a.beginPath(),Vb._drawLine(b,a),a.stroke(),a.shadowColor="transparent",a.beginPath();var i=this._element.getStyle("link.flow.color");i=i?i:Dd.NETWORK_LINK_FLOW_COLOR,a.strokeStyle=i,Vb._drawLine(b,f),a.stroke(),a.shadowColor=this._shadowColor}else a.beginPath(),Vb.drawLinePoints(a,b,e),a.stroke()},getLinkPoints:function(){return this._linkPoints||(this._linkPoints=this.createLinkPoints(),this._lineLength=Rb.calculateLineLength(this._linkPoints)),this._linkPoints},getFromPosition:function(a,b){var c=this.getFromPoint();return c?{x:c.x+a,y:c.y+b}:null},getToPosition:function(a,b){var c=this.getToPoint();return c?{x:c.x+a,y:c.y+b}:null},getFromPoint:function(){return this._fromPoint||(this._fromPoint=wc.createFromPoint(this)),this._fromPoint},getToPoint:function(){return this._toPoint||(this._toPoint=wc.createToPoint(this)),this._toPoint},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=this.getStyle("link.type"),d=new Gb.List;if(wc.isOrthogonalOrFlexionalLink(this._element))d=wc.orthogonalAndFlexional(this,c);else if(this._element.isLooped()){var e=this._network.getElementUI(this._element.getFromAgent());null!=e&&(this._hotSpot=wc.fillLoopedPoints(this,e.getBodyRect(),d))}else{if("arc"!==c&&"triangle"!==c&&"parallel"!==c)throw"Can not resolve link type '"+c+"'";this._hotSpot=wc.fillBundlePoints(this,c,a,b,d)}if(this._network._linkPathFunction){var f=this._network._linkPathFunction(this,d);f&&(d=f)}return d},checkAttachments:function(){Gb.canvas.LinkUI.superClass.checkAttachments.call(this),this.checkLinkHandlerAttachment()},checkLinkHandlerAttachment:function(){var a=this._network.getLinkHandlerLabel(this._element);null!=a&&""!==a?this._linkHandlerAttachment||(this._linkHandlerAttachment=new Gb.canvas.LinkHandlerAttachment(this),this.addAttachment(this._linkHandlerAttachment)):this._linkHandlerAttachment&&(this.removeAttachment(this._linkHandlerAttachment),this._linkHandlerAttachment=null)},getLinkHandlerAttachment:function(){return this._linkHandlerAttachment},getControlPoint:function(){return wc.getControlPoint(this._element,this)},setControlPoint:function(a){if(a){var b=this.getStyle("link.type");if(wc.hasControlPoint(b)){var c=wc.getLinkSourceBounds(this),d=wc.getLinkTargetBounds(this);wc.setParamsByControlPoint(a,c,d,b,this._element)}}},getLineLength:function(){return this._lineLength},hit:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._network.getSelectionTolerance();return d&&d>0&&Rb.grow(c,d,d),Rb.intersects(this.getViewRect(),c)?this.hitCanvasPoint(a,b):!1},intersects:function(a){var b=Gb.canvas.LinkUI.superClass.intersects.apply(this,arguments);if(1==b)return!0;if(0==Rb.intersects(a,this.getViewRect()))return!1;var c=this.getLinkPoints(),d=c.size();if(2==d)for(var e=0;d>e;e+=2){var f=c.get(e);if(d>e+1){var g=c.get(e+1);if(Od.intersectsLine(f.x,f.y,g.x,g.y,a.x,a.y,a.width,a.height))return!0}}return this.hitCanvasRect(a)},getAngle:function(){return!this._angle&&this._fromPoint&&this._toPoint&&(this._angle=Rb.getAngle(this._fromPoint,this._toPoint)),this._angle||0}}),Gb.canvas.GroupUI=function(a,b){Gb.canvas.GroupUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.GroupUI",Gb.canvas.NodeUI,{isEditable:function(){return!this._element.isExpanded()},paintBody:function(a){this._shapeRect?this.drawExpandedGroup(a):Gb.canvas.GroupUI.superClass.paintBody.apply(this,arguments)},validateBodyBounds:function(){this.getBodyRect(),this._shapeRect?this.addBodyBounds(this.getPathRect("group",!1)):Gb.canvas.GroupUI.superClass.validateBodyBounds.call(this)},drawExpandedGroup:function(a){this.drawPath(a,"group",!1,this._element.getStyle("vector.outline.pattern"));var b=this.getStyle("group.deep"),c=this.getStyle("group.fill.color");0!==b&&c&&"rectangle"===this.getStyle("group.shape")&&Vb.draw3DRect(a,c,b,this._bodyRect)},getChildrenRects:function(){return this._network.getGroupChildrenRects(this._element)},createBodyRect:function(){this._shapeRect=null;var a=this._element,b=this._network;if(a.isExpanded()){a.getChildren().forEach(function(a){var c=b.getElementUI(a);c&&c.validate()});var c=this.getChildrenRects();if(!c.isEmpty()){var d=a.getStyle("group.shape"),e=Sb[d];if(!e)throw"Can not resolve group shape '"+d+"'";this._shapeRect=e(c)}}return this._shapeRect?(Rb.addPadding(this._shapeRect,a,"group.padding",1),this._shapeRect):Gb.canvas.GroupUI.superClass.createBodyRect.call(this)}}),Gb.canvas.ShapeNodeUI=function(a,b){Gb.canvas.ShapeNodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.ShapeNodeUI",Gb.canvas.NodeUI,{getDefaultBodyRect:function(){return this._element._points.size()<2?null:this.getPathRect("vector",!0)},drawDefaultBody:function(a){this._element._points.size()<2||(this.drawPath(a,"vector",!0,this._element.getStyle("vector.outline.pattern"),this._element._points,this._element._segments,this._element.getStyle("shapenode.closed")),nd.drawLinkArrow(this,a,Rb.getPointObject(this._element._points,this._element._segments)))},drawSelectBorder:function(a){var b=this._element,c=b.getStyle("select.width");if(c>0){var d=this.getBodyRect();d=Hb.clone(d);var e=b.getStyle("select.physicalZoom")?1:this._network.getGraphicsZoom();Rb.addPadding(d,b,"select.padding",1/e),Rb.grow(d,c/2,c/2);var f=b.getStyle("vector.outline.width");f>0&&Rb.grow(d,f/2/e,f/2/e),a.lineWidth=c/e,a.lineCap=b.getStyle("select.cap"),a.lineJoin=b.getStyle("select.join"),a.strokeStyle=b.getStyle("select.color"),Vb.drawVector(a,b.getStyle("select.shape"),null,d),a.stroke()}}}),Gb.canvas.ShapeLinkUI=function(a,b){Gb.canvas.ShapeLinkUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.ShapeLinkUI",Gb.canvas.LinkUI,{isEditable:function(){return!0},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=new Gb.List,d=this.getStyle("shapelink.type");c.add(a),null!=this._element._points&&c.addAll(this._element._points),c.add(b);var e,f,g,h,i,j,k,l=Rb.calculateLineLength(c)/2,m=c.size(),n=0,o=0;for(e=0;m>e;e++)if(h=c.get(e),0!=e){if(g=h,g instanceof md&&(g=g._as),g instanceof Array?(i=Rb.calculateCurveLength(f,g,1),f=g[g.length-1]):(k=h.y-f.y,j=h.x-f.x,i=Math.sqrt(j*j+k*k),f=g),o+=i,l>=n&&o>=l){var p=l-n,q=c.get(e-1);q instanceof md&&(q=q._as,q instanceof Array&&(q=q[q.length-1]));var r=c.get(e),s=Rb.getPathInfo(r,q,p,0,-1).point;this._hotSpot=Hb.clone(s)}n=o}else f=h;var t,u,v;if("lineto"===d);else if("quadto"===d){for(t=new Gb.List(c.get(0)),u=1,pointCount=c.size();u<pointCount;u++)t.add(u<pointCount-1?new Gb.List([c.get(u++),c.get(u)]):c.get(u));c=t}else if("cubicto"===d){for(t=new Gb.List(c.get(0)),u=1,pointCount=c.size();u<pointCount;u++)t.add(u<pointCount-2?new Gb.List([c.get(u++),c.get(u++),c.get(u)]):u<pointCount-1?new Gb.List([c.get(u++),c.get(u)]):c.get(u));c=t}else{if("orthogonalto"!==d)throw"Can not resolve shapelink type '"+d+"'";for(v=c.get(0),t=new Gb.List(v),u=1,pointCount=c.size();u<pointCount;u++)if(u<pointCount-1){var h=Hb.clone(c.get(u)),w=h.x,x=h.y,j=w-v.x,k=x-v.y;Math.abs(j)>Math.abs(k)?(h.x=w,h.y=v.y):(h.x=v.x,h.y=x),v=h,t.add(v)}else t.add(c.get(u));c=t}return c}}),Gb.canvas.GridUI=function(a,b){Gb.canvas.GridUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.GridUI",Gb.canvas.NodeUI,{drawDefaultBody:function(a){this._element.getImage()?Gb.canvas.GridUI.superClass.drawDefaultBody.apply(this,arguments):this.drawGridBody(a)},validateBodyBounds:function(){if(this._element.getImage())Gb.canvas.GridUI.superClass.validateBodyBounds.call(this);else{var a=this.getBodyRect(),b=Hb.clone(a);this.appendShadowBound(this,b),this.addBodyBounds(b)}},drawGridBody:function(a){var b=this.getStyle("grid.fill"),c=this.getStyle("grid.deep"),d=this.getStyle("grid.cell.deep");if(b||0!==c||0!==d){a.beginPath();var e=this._element.getRect(),f=this.getDyeColor("grid.fill.color");if(this.setShadow(this,a),b&&(a.fillStyle=f,a.rect(e.x,e.y,e.width,e.height),a.fill()),a.closePath(),this.clearShadow(a),a.beginPath(),0!=c&&Vb.draw3DRect(a,f,c,e.x,e.y,e.width,e.height),a.closePath(),0!=d)for(var g=this.getStyle("grid.row.count"),h=this.getStyle("grid.column.count"),i=0;g>i;i++)for(var j=0;h>j;j++){var k=this._element.getCellRect(i,j);null!=k&&(a.beginPath(),Vb.draw3DRect(a,f,d,k.x,k.y,k.width,k.height),a.closePath())}}}}),Gb.canvas.RotatableNodeUI=function(a,b){Gb.canvas.RotatableNodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.RotatableNodeUI",Gb.canvas.NodeUI,{isEditable:function(){return!1},getDefaultBodyRect:function(){var a=this._element,b=Hb.getImageAsset(a.getImage()),c=this.getBodyRect();return b?(Rb.addPadding(c,this._element,"image.padding",1),c):c},drawDefaultBody:function(a){var b=this._element,c=Hb.getImageAsset(b.getImage()),d=this.getBodyRect();if(Rb.addPadding(d,this._element,"image.padding",1),c.getImage()){var e=this._element._getOrignalWidth(),f=this._element._getOrignalHeight(),g=this._element._getRotateRect();a.save(),a.translate(d.x-g.x+e/2,d.y-g.y+f/2),a.rotate(this._element._angle*Math.PI/180);var d={x:-e/2,y:-f/2,width:e,height:f};Mc(a,c.getImage(this._innerColor,d.width,d.height),this._innerColor,d,b,this._network),a.restore()}else if(c.getSrc());else if(!c.getFunction())throw"ImageAsset '"+b.getImage()+" ' is empty"}}),Gb.canvas.HTMLNodeUI=function(a,b){Gb.canvas.HTMLNodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.HTMLNodeUI",Gb.canvas.NodeUI,{checkAttachments:function(){Gb.canvas.NodeUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Gb.canvas.HTMLNodeUI.superClass.checkLabelAttachment.call(this);var b=this._network.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Gb.canvas.HTMLLabelAttachment(this,Dd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Gb.canvas.HTMLNodeUI.superClass.checkAlarmAttachment.call(this);var b=this._network.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Gb.canvas.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},setAttachmentVisible:function(a){a?(this._labelAttachment&&this._labelAttachment.setVisibility("visible"),this._alarmAttachment&&this._alarmAttachment.setVisibility("visible")):(this._labelAttachment&&this._labelAttachment.setVisibility("hidden"),this._alarmAttachment&&this._alarmAttachment.setVisibility("hidden"))}}),Gb.canvas.HTMLLinkUI=function(a,b){Gb.canvas.HTMLLinkUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.HTMLLinkUI",Gb.canvas.LinkUI,{checkAttachments:function(){Gb.canvas.LinkUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Gb.canvas.HTMLLinkUI.superClass.checkLabelAttachment.call(this);var b=this._network.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Gb.canvas.HTMLLabelAttachment(this),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Gb.canvas.HTMLLinkUI.superClass.checkAlarmAttachment.call(this);var b=this._network.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Gb.canvas.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)}}),Gb.canvas.Attachment=function(a,b){this._ui=a,this._element=this._ui.getElement(),this._network=a.getNetwork(),this._showOnTop=b},Hb.ext("twaver.canvas.Attachment",Object,{getElement:function(){return this._element},getElementUI:function(){return this._ui},getNetwork:function(){return this._network},isShowOnTop:function(){return this._showOnTop===!0},setShowOnTop:function(a){this._showOnTop=a},getStyle:function(a){return this._ui.getStyle(a)},getFont:function(a){return this._ui.getFont(a)},getViewRect:function(){return Hb.clone(this._viewRect)},getAlpha:function(){return 1},validate:function(){},paint:function(a){},hit:function(a,b){return Rb.containsPoint(this._viewRect,a,b)?this.hitCanvasRect({x:a-1,y:b-1,width:2,height:2}):!1},hitCanvasRect:function(a){var b=Od.getHitCanvas(a.width,a.height),c=Od.getCtx(b);c.save(),c.translate(-a.x,-a.y),this.paint(c);try{for(var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=0;f<d.width;f++)for(var g=0;g<d.height;g++){var h=4*(g*d.width+f),i=e[h+3];if(0!==i)return c.restore(),!0}}catch(j){Od.disposeHitCanvas()}return c.restore(),!1},dispose:function(){},_rotatePoint:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_rotatePointList:function(a,b,c){var d=this,e=new Gb.List;return a.forEach(function(a){e.add(d._rotatePoint(a,b,c))}),e}}),Gb.canvas.BasicAttachment=function(a,b){Gb.canvas.BasicAttachment.superClass.constructor.call(this,a,b),this._roundRect={x:0,y:0,width:0,height:0},this._contentRect={x:0,y:0,width:0,height:0}},Hb.ext("twaver.canvas.BasicAttachment",Gb.canvas.Attachment,{paint:function(a){Gb.canvas.BasicAttachment.superClass.paint.apply(this,arguments);var b=this.isFill(),c=this.getOutlineWidth();if(this.getElementUI().setShadow(this,a),(c>0||b)&&(Vb.drawRoundRect(a,this._roundRect.x,this._roundRect.y,this._roundRect.width,this._roundRect.height,this.getCornerRadius()),this._pointers&&(a.moveTo(this._pointers[0].x,this._pointers[0].y),a.lineTo(this._pointers[1].x,this._pointers[1].y),a.lineTo(this._pointers[2].x,this._pointers[2].y)),a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b)){var d=this.getFillColor(),e=this.getGradient();e?Vb.fill(a,d,e,this.getGradientColor(),this._viewRect):a.fillStyle=d,a.fill()}},validate:function(){Gb.canvas.BasicAttachment.superClass.validate.call(this),this.calculateMeasure();var a=this.getOutlineWidth();this._viewRect=Rb.getRect(this._pointers),this._viewRect=Rb.unionRect(this._viewRect,this._roundRect),a>0&&Rb.grow(this._viewRect,a/2,a/2),this._viewRect=this._ui.appendShadowBound(this,this._viewRect)},calculateMeasure:function(){var a=this.getContentWidth(),b=this.getContentHeight(),c=this.getCornerRadius(),d=this.getPointerLength(),e=this.getPointerWidth(),f=this.getPosition(),g=this.getXOffset(),h=this.getYOffset(),i=this._roundRect;

i.width=a+c,i.height=b;var j;if(this._ui._element instanceof Gb.Link){var k,l=this._ui.getLinkPoints();k=this._ui.getLineLength?this._ui.getLineLength():this._ui._element.getLineLength(),Math.abs(g)>0&&Math.abs(g)<1?"from"===f?g*=k:"to"===f?g=k*(1-g):(g/=2,g+=.5,g*=k):"from"===f?g=g:"to"===f?g=k-g:g+=k/2;{var m,n=Rb.calculatePointInfoAlongLine(l,!0,g,h),o=n.point;n.angle}m="from"===f?this._ui.getFromPoint():"to"===f?this._ui.getToPoint():this._ui._hotSpot,g=o.x-m.x,h=o.y-m.y}if(d>0){var p=this.getDirection();j=this._network.getPosition(f,this._ui,null,g,h,!1);var q;if("aboveleft"===p)i.y=j.y-d-i.height,i.x=j.x-(i.width-c),q=Math.max(j.x-e,j.x-(i.width-c)+c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:q,y:j.y-d}];else if("aboveright"===p)i.y=j.y-d-i.height,i.x=j.x-c,q=Math.min(j.x+e,j.x-c+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:q,y:j.y-d}];else if("belowleft"===p)i.y=j.y+d,i.x=j.x-(i.width-c),q=Math.max(j.x-e,j.x-(i.width-c)+c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:q,y:j.y+d}];else if("belowright"===p)i.y=j.y+d,i.x=j.x-c,q=Math.min(j.x+e,j.x-c+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:q,y:j.y+d}];else if("leftabove"===p)i.y=j.y+c-i.height,i.x=j.x-d-i.width,q=Math.max(j.y-e,j.y+c-i.height+c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:q}];else if("leftbelow"===p)i.y=j.y-c,i.x=j.x-d-i.width,q=Math.min(j.y+e,j.y-c+i.height-c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:q}];else if("rightabove"===p)i.y=j.y+c-i.height,i.x=j.x+d,q=Math.max(j.y-e,j.y+c-i.height+c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:q}];else if("rightbelow"===p)i.y=j.y-c,i.x=j.x+d,q=Math.min(j.y+e,j.y-c+i.height-c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:q}];else if("above"===p)i.y=j.y-d-i.height,i.x=j.x-i.width/2,q=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-q,y:j.y-d},{x:j.x+q,y:j.y-d}];else if("below"===p)i.y=j.y+d,i.x=j.x-i.width/2,q=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-q,y:j.y+d},{x:j.x+q,y:j.y+d}];else if("left"===p)i.y=j.y-i.height/2,i.x=j.x-d-i.width,q=Math.min(b/2,e/2),this._pointers=[j,{x:j.x-d,y:j.y+q},{x:j.x-d,y:j.y-q}];else{if("right"!==p)throw"Can not resolve '"+p+"' attachment direction";i.y=j.y-i.height/2,i.x=j.x+d,q=Math.min(b/2,e/2),this._pointers=[j,{x:j.x+d,y:j.y+q},{x:j.x+d,y:j.y-q}]}}else j=this._network.getPosition(f,this._ui,{width:i.width,height:i.height},g,h,!1),i.x=j.x,i.y=j.y,this._pointers=null;this._contentRect.x=i.x+(i.width-a)/2,this._contentRect.y=i.y+(i.height-b)/2,this._contentRect.width=a,this._contentRect.height=b;var r=this.getPadding();0!=r&&Rb.grow(i,r,r),r=this.getPaddingLeft(),0!=r&&(i.x-=r,i.width+=r),r=this.getPaddingRight(),0!=r&&(i.width+=r),r=this.getPaddingTop(),0!=r&&(i.y-=r,i.height+=r),r=this.getPaddingBottom(),0!=r&&(i.height+=r),i.width<0&&(i.width=i.width,i.x-=i.width),i.height<0&&(i.height=-i.height,i.y-=i.height)},getContentWidth:function(){return Gb.Defaults.ATTACHMENT_CONTENT_WIDTH},getContentHeight:function(){return Gb.Defaults.ATTACHMENT_CONTENT_HEIGHT},getCornerRadius:function(){return Gb.Defaults.ATTACHMENT_CORNER_RADIUS},getPointerLength:function(){return Gb.Defaults.ATTACHMENT_POINTER_LENGTH},getPointerWidth:function(){return Gb.Defaults.ATTACHMENT_POINTER_WIDTH},getPosition:function(){return Gb.Defaults.ATTACHMENT_POSITION},getXOffset:function(){return Gb.Defaults.ATTACHMENT_XOFFSET},getYOffset:function(){return Gb.Defaults.ATTACHMENT_YOFFSET},getPadding:function(){return Gb.Defaults.ATTACHMENT_PADDING},getPaddingLeft:function(){return Gb.Defaults.ATTACHMENT_PADDING_LEFT},getPaddingRight:function(){return Gb.Defaults.ATTACHMENT_PADDING_RIGHT},getPaddingTop:function(){return Gb.Defaults.ATTACHMENT_PADDING_TOP},getPaddingBottom:function(){return Gb.Defaults.ATTACHMENT_PADDING_BOTTOM},getDirection:function(){return Gb.Defaults.ATTACHMENT_DIRECTION},isFill:function(){return Gb.Defaults.ATTACHMENT_FILL},getFillColor:function(){return Gb.Defaults.ATTACHMENT_FILL_COLOR},getGradient:function(){return Gb.Defaults.ATTACHMENT_GRADIENT},getGradientColor:function(){return Gb.Defaults.ATTACHMENT_GRADIENT_COLOR},getOutlineWidth:function(){return Gb.Defaults.ATTACHMENT_OUTLINE_WIDTH},getOutlineColor:function(){return Gb.Defaults.ATTACHMENT_OUTLINE_COLOR},getCap:function(){return Gb.Defaults.ATTACHMENT_CAP},getJoin:function(){return Gb.Defaults.ATTACHMENT_JOIN},isShadowable:function(){return Gb.Defaults.ATTACHMENT_SHADOWABLE},getRoundRect:function(){return Hb.clone(this._roundRect)},getContentRect:function(){return Hb.clone(this._contentRect)}}),Gb.canvas.LabelAttachment=function(a,b){Gb.canvas.LabelAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.LabelAttachment",Gb.canvas.BasicAttachment,{paint:function(a){var b=this._element instanceof Gb.Link&&this._element.getStyle("link.label.rotatable");if(b){a.save();var c=this._viewRect.x+this._viewRect.width/2,d=this._viewRect.y+this._viewRect.height/2;a.translate(c,d),a.rotate(this._network.getElementUI(this._element).getAngle()),a.translate(-c,-d)}Gb.canvas.LabelAttachment.superClass.paint.apply(this,arguments);var e=this._element.getStyle("label.align"),f=this._element&&this._element.getStyle("label.rotate.angle");0!==f&&(a.save(),Gb.Util.rotateCanvas(a,this._contentRect,f)),Vb.drawText(a,this.text,this._contentRect,this.font,this.getStyle("label.color"),e),(b||0!==f)&&a.restore()},validate:function(){this.font=this.getFont("label.font");var a=this.getLabel(),b=Hb.g.getTextSize(this.font,a),c=this.getMaxLength();0!==c&&b.width>c?(this.text=Hb.g.getCollapseTextInLength(this.font,a,c),this._textSize=Hb.g.getTextSize(this.font,this.text)):(this.text=a,this._textSize=b),Gb.canvas.LabelAttachment.superClass.validate.call(this);var d=this._viewRect,e=this._element&&this._element.getStyle("label.rotate.angle");if(0!==e){var f=new Gb.List;f.add({x:d.x,y:d.y}),f.add({x:d.x+d.width,y:d.y}),f.add({x:d.x+d.width,y:d.y+d.height}),f.add({x:d.x,y:d.y+d.height}),f=this._rotatePointList(f,e,d);var g=Gb.Util.getRect(f);this._viewRect=g}},getLabel:function(){return this._network.getLabel(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("label.corner.radius")},getPointerLength:function(){return this.getStyle("label.pointer.length")},getPointerWidth:function(){return this.getStyle("label.pointer.width")},getPosition:function(){return this.getStyle("label.position")},getXOffset:function(){return this.getStyle("label.xoffset")},getYOffset:function(){return this.getStyle("label.yoffset")},getPadding:function(){return this.getStyle("label.padding")},getPaddingLeft:function(){return this.getStyle("label.padding.left")},getPaddingRight:function(){return this.getStyle("label.padding.right")},getPaddingTop:function(){return this.getStyle("label.padding.top")},getPaddingBottom:function(){return this.getStyle("label.padding.bottom")},getDirection:function(){return this.getStyle("label.direction")},isFill:function(){return this.getStyle("label.fill")},getFillColor:function(){return this.getStyle("label.fill.color")},getGradient:function(){return this.getStyle("label.gradient")},getGradientColor:function(){return this.getStyle("label.gradient.color")},getOutlineWidth:function(){return this.getStyle("label.outline.width")},getOutlineColor:function(){return this.getStyle("label.outline.color")},getCap:function(){return this.getStyle("label.cap")},getJoin:function(){return this.getStyle("label.join")},getAlpha:function(){return this.getStyle("label.alpha")},getMaxLength:function(){return this.getStyle("label.maxlength")},isShadowable:function(){return this.getStyle("label.shadowable")}}),Gb.canvas.AlarmAttachment=function(a,b){Gb.canvas.AlarmAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.AlarmAttachment",Gb.canvas.BasicAttachment,{paint:function(a){Gb.canvas.AlarmAttachment.superClass.paint.apply(this,arguments),Vb.drawText(a,this.text,this._contentRect,this.font,this.getStyle("alarm.color"))},validate:function(){this.font=this.getFont("alarm.font"),this.text=this._network.getAlarmLabel(this._element),this._textSize=Vb.getTextSize(this.font,this.text),this._fillColor=this._network.getAlarmFillColor(this._element),Gb.canvas.LabelAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("alarm.corner.radius")},getPointerLength:function(){return this.getStyle("alarm.pointer.length")},getPointerWidth:function(){return this.getStyle("alarm.pointer.width")},getPosition:function(){return this.getStyle("alarm.position")},getXOffset:function(){return this.getStyle("alarm.xoffset")},getYOffset:function(){return this.getStyle("alarm.yoffset")},getPadding:function(){return this.getStyle("alarm.padding")},getPaddingLeft:function(){return this.getStyle("alarm.padding.left")},getPaddingRight:function(){return this.getStyle("alarm.padding.right")},getPaddingTop:function(){return this.getStyle("alarm.padding.top")},getPaddingBottom:function(){return this.getStyle("alarm.padding.bottom")},getDirection:function(){return this.getStyle("alarm.direction")},isFill:function(){return null!=this._fillColor},getFillColor:function(){return this._fillColor},getGradient:function(){return this.getStyle("alarm.gradient")},getGradientColor:function(){return this.getStyle("alarm.gradient.color")},getOutlineWidth:function(){return this.getStyle("alarm.outline.width")},getOutlineColor:function(){return this.getStyle("alarm.outline.color")},getCap:function(){return this.getStyle("alarm.cap")},getJoin:function(){return this.getStyle("alarm.join")},getAlpha:function(){return this.getStyle("alarm.alpha")},isShadowable:function(){return this.getStyle("alarm.shadowable")}}),Gb.canvas.LinkHandlerAttachment=function(a,b){Gb.canvas.LinkHandlerAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.LinkHandlerAttachment",Gb.canvas.BasicAttachment,{paint:function(a){Gb.canvas.LinkHandlerAttachment.superClass.paint.apply(this,arguments),Vb.drawText(a,this.linkHandlerLabel,this._contentRect,this.linkHandlerFont,this.getStyle("link.handler.color"))},validate:function(){this.linkHandlerFont=this.getFont("link.handler.font"),this.linkHandlerLabel=this._network.getLinkHandlerLabel(this._element),this._textSize=Vb.getTextSize(this.linkHandlerFont,this.linkHandlerLabel),Gb.canvas.LinkHandlerAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("link.handler.corner.radius")},getPointerLength:function(){return this.getStyle("link.handler.pointer.length")},getPointerWidth:function(){return this.getStyle("link.handler.pointer.width")},getPosition:function(){return this.getStyle("link.handler.position")},getXOffset:function(){return this.getStyle("link.handler.xoffset")},getYOffset:function(){return this.getStyle("link.handler.yoffset")},getPadding:function(){return this.getStyle("link.handler.padding")},getPaddingLeft:function(){return this.getStyle("link.handler.padding.left")},getPaddingRight:function(){return this.getStyle("link.handler.padding.right")},getPaddingTop:function(){return this.getStyle("link.handler.padding.top")},getPaddingBottom:function(){return this.getStyle("link.handler.padding.bottom")},getDirection:function(){return this.getStyle("link.handler.direction")},isFill:function(){return this.getStyle("link.handler.fill")},getFillColor:function(){return this.getStyle("link.handler.fill.color")},getGradient:function(){return this.getStyle("link.handler.gradient")},getGradientColor:function(){return this.getStyle("link.handler.gradient.color")},getOutlineWidth:function(){return this.getStyle("link.handler.outline.width")},getOutlineColor:function(){return this.getStyle("link.handler.outline.color")},getCap:function(){return this.getStyle("link.handler.cap")},getJoin:function(){return this.getStyle("link.handler.join")},getAlpha:function(){return this.getStyle("link.handler.alpha")},isShadowable:function(){return this.getStyle("link.handler.shadowable")}}),Gb.canvas.IconsAttachment=function(a,b){Gb.canvas.IconsAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.IconsAttachment",Gb.canvas.Attachment,{isShadowable:function(){return Gb.Defaults.ATTACHMENT_SHADOWABLE},validate:function(){if(Gb.canvas.IconsAttachment.superClass.validate.call(this),this.iconsNames=this._network.getIconsNames(this._element),this.iconsNames&&0!=this.iconsNames.length){var a=this._makeGroup(this.iconsNames),b=this._makeGroup(this._network.getIconsColors(this._element));len=a.length,this.iconsOrientation=this._makeArray(this._element.getStyle("icons.orientation"),len,"right"),this.iconsPosition=this._makeArray(this._element.getStyle("icons.position"),len,"topleft.bottomright"),this.iconsXoffset=this._makeArray(this._element.getStyle("icons.xoffset"),len,0),this.iconsYoffset=this._makeArray(this._element.getStyle("icons.yoffset"),len,0),this.iconsXgap=this._makeArray(this._element.getStyle("icons.xgap"),len,1),this.iconsYgap=this._makeArray(this._element.getStyle("icons.ygap"),len,1),this.locations=[],this.iconsSizes=[];var c,d;for(i=0;i<len;i++){var e=a[i],f=this.iconsOrientation[i]||"right",g=this.iconsPosition[i]||"topleft.bottomright",h=this.iconsXgap[i]||1,j=this.iconsYgap[i]||1,k=this.iconsXoffset[i]||0,l=this.iconsYoffset[i]||0;if(this._ui._element instanceof Gb.Link){var m,n=this._ui.getLinkPoints();m=this._ui.getLineLength?this._ui.getLineLength():this._ui._element.getLineLength(),Math.abs(k)>0&&Math.abs(k)<1?"from"===g?k*=m:"to"===g?k=m*(1-k):(k/=2,k+=.5,k*=m):"from"===g?k=k:"to"===g?k=m-k:k+=m/2;{var o,p=Rb.calculatePointInfoAlongLine(n,!0,k,l),q=p.point;p.angle}o="from"===g?this._ui.getFromPoint():"to"===g?this._ui.getToPoint():this._ui._hotSpot,k=q.x-o.x,l=q.y-o.y}d=null,c=this._getIconsSize(e,f,h,j),c&&(d=this._network.getPosition(g,this._ui,c,k,l),"top"===f?d.y+=c.height:"left"===f&&(d.x+=c.width)),this.locations.push(d),this.iconsSizes.push(c)}var r=null;for(i=0;i<this.locations.length;i++)d=this.locations[i],c=this.iconsSizes[i],null!=d&&(r=null==r?{x:d.x,y:d.y,width:c.width,height:c.height}:Rb.unionRect(r,{x:d.x,y:d.y,width:c.width,height:c.height}));this._viewRect=r||{x:this._element.getLocation().x,y:this._element.getLocation().y,width:0,height:0},this.iconsGroups=a,this.colorGroups=b;var s=this._element instanceof Gb.Link&&this._element.getStyle("link.icons.rotatable");for(i=0;i<len;i++)if(s instanceof Array&&s[i]&&this._viewRect){var t=this._viewRect.x+this._viewRect.width/2,u=this._viewRect.y+this._viewRect.height/2,v=Math.sqrt(this._viewRect.height*this._viewRect.height+this._viewRect.width*this._viewRect.width);this._viewRect={x:t-v/2,y:u-v/2,width:v,height:v}}}},_makeGroup:function(a){if(!Array.isArray(a))return[[a]];var b,c,d,e=[],f=!1,g=a.length;for(b=0;g>b;b++)c=a[b],Array.isArray(c)?(f=!0,e.push(c)):(d=[c],e.push(d));return f||(e.length=0,e.push(a)),e},_makeArray:function(a,b,c){if(Array.isArray(a))return a;for(var d=[],e=0;b>e;e++)d.push(a||c);return d},paint:function(a){if(Gb.canvas.IconsAttachment.superClass.paint.apply(this,arguments),this.iconsNames&&0!=this.iconsNames.length&&this.locations){var b,c,d,e,f,g,h,i,j,k;for(b=0;b<this.iconsGroups.length;b++)if(c=this.locations[b]){f=c.x,g=c.y,e=this.iconsGroups[b],h=this.colorGroups[b],i=this.iconsOrientation[b],j=this.iconsXgap[b]||1,k=this.iconsYgap[b]||1,d=0;for(var l in e){var m=null,n=null;h&&h.length>d&&(n=h[d++]);var o=Hb.getImageAsset(e[l]);if(null!=o){if("right"===i)m={x:f,y:g,width:o.getWidth(),height:o.getHeight()},f+=m.width+j;else if("left"===i)m={x:f-o.getWidth(),y:g,width:o.getWidth(),height:o.getHeight()},f-=m.width+j;else if("top"===i)m={x:f,y:g-o.getHeight(),width:o.getWidth(),height:o.getHeight()},g-=m.height+k;else{if("bottom"!==i)throw"Can not resolve '"+i+"' orientation";m={x:f,y:g,width:o.getWidth(),height:o.getHeight()},g+=m.height+k}var p=this._element instanceof Gb.Link&&this._element.getStyle("link.icons.rotatable");if(p instanceof Array&&p[b]){a.save();var q=m,f=q.x+q.width/2,g=q.y+q.height/2;a.translate(f,g),a.rotate(this._network.getElementUI(this._element).getAngle()),a.translate(-f,-g),Mc(a,o.getImage(n,m.width,m.height),n,m,this._element,this._network),a.restore()}else Mc(a,o.getImage(n,m.width,m.height),n,m,this._element,this._network);if(this._network._debug){var m=this._viewRect;Vb.strokeRect(a,m,"#FCFC00",1),Vb.strokeRect(a,m,"#FCFC00",1)}}}}}},_getIconsSize:function(a,b,c,d){var e=0,f=0,g=null,h=null,i=null;for(var j in a)if(h=Hb.getImageAsset(a[j])){if("right"===b)g={x:e,y:f,width:h.getWidth(),height:h.getHeight()},e+=g.width+c;else if("left"===b)g={x:e-h.getWidth(),y:f,width:h.getWidth(),height:h.getHeight()},e-=g.width+c;else if("top"===b)g={x:e,y:f-h.getHeight(),width:h.getWidth(),height:h.getHeight()},f-=g.height+d;else{if("bottom"!==b)throw"Can not resolve '"+b+"' orientation";g={x:e,y:f,width:h.getWidth(),height:h.getHeight()},f+=g.height+d}i=null==i?Hb.clone(g):Rb.unionRect(i,g)}return i?{width:Math.abs(i.width),height:Math.abs(i.height)}:null}}),Gb.canvas.EditAttachment=function(a,b){Gb.canvas.EditAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.canvas.EditAttachment",Gb.canvas.Attachment,{paint:function(a){Gb.canvas.EditAttachment.superClass.paint.apply(this,arguments),this._viewRect=null,this.paintResizingPoints(a),this.paintEditPoints(a),this.paintRotatePoints(a)},paintResizingPoints:function(a){var b=this.resizingPoints.size();if(!(0>=b)){var c=2*this.resizePointSize,d=2*this.resizePointSize,e=this._network.getResizePointFillColor(),f=this._network.getResizePointOutlineWidth(),g=this._network.getResizePointOutlineColor(),h=this._element.getAngle(),i=this._element.getOriginalRect();a.lineWidth=f;for(var j=0;b>j;j++){var k=this.resizingPoints.get(j),l={x:k.x-this.resizePointSize,y:k.y-this.resizePointSize,width:2*this.resizePointSize,height:2*this.resizePointSize},m=this._getRotateRect(l,h,{x:i.x+i.width/2,y:i.y+i.height/2});a.save(),Gb.Util.rotateCanvas(a,m,h),Od.rect(a,m.x,m.y,c,d),a.restore()}a.fillStyle=e,a.strokeStyle=g,a.fill(),a.stroke()}},paintEditPoints:function(a){var b=this.editPoints.size();if(!(0>=b)){var c=this._network.getEditPointOutlineColor(),d=this._network.getEditPointFillColor(),e=this._network.getEditPointOutlineWidth();a.beginPath(),a.lineWidth=e;for(var f=0;b>f;f++){var g=this.editPoints.get(f);a.beginPath(),Od.circle(a,g.x,g.y,this.editPointSize,d,c),a.closePath()}}},paintRotatePoints:function(a){var b=this.rotatePoints.size();if(!(0>=b)){var c=this._network.getRotatePointOutlineColor(),d=this._network.getRotatePointFillColor(),e=this._network.getRotatePointOutlineWidth();a.beginPath(),a.lineWidth=e;for(var f=0;b>f;f++){var g=this.rotatePoints.get(f);a.beginPath(),Od.circle(a,g.x,g.y,this.rotatePointSize,d,c),a.closePath()}}},validate:function(){Gb.canvas.EditAttachment.superClass.validate.call(this),this.editPointSize=this._network.getEditPointSize(),this.resizePointSize=this._network.getResizePointSize(),this.rotatePointSize=this._network.getRotatePointSize(),this.resizingPoints=new Gb.List,this.editPoints=new Gb.List,this.rotatePoints=new Gb.List,this._element instanceof Gb.Node&&this._addResizingPoint(this._element),!(this._network.isRotatable(this._element)&&this._element instanceof Ld)||this._element instanceof Gb.ShapeNode||this._element instanceof Gb.Grid||this._element instanceof Gb.Group||this._addRotatePoint(this._element),this._element instanceof Gb.ShapeNode&&(this._addResizingPoint(this._element),this._addShapeNodePoint(this._element)),this._ui instanceof Gb.canvas.ShapeLinkUI&&this._addShapeLinkPoints(this._element),this._ui instanceof Gb.canvas.LinkUI&&this._addLinkControlPoint(this._ui)},_addResizingPoint:function(a){var b=a.getOriginalRect();if(b){var c=this._network.getResizePointSize();if(!(0>=c)){var d=new md([{x:b.x,y:b.y},{x:b.x+b.width/2,y:b.y},{x:b.x+b.width,y:b.y},{x:b.x,y:b.y+b.height/2},{x:b.x+b.width,y:b.y+b.height/2},{x:b.x,y:b.y+b.height},{x:b.x+b.width/2,y:b.y+b.height},{x:b.x+b.width,y:b.y+b.height}]),e=this._network.getResizePointOutlineWidth(),f=this._network.getResizePointOutlineColor(),g=this._network.getResizePointFillColor();this._addPoints(a.getRect(),d,e,f,g,!0)}}},_addRotatePoint:function(a){var b=a.getOriginalRect();if(b){var c=this._network.getRotatePointSize();if(!(0>=c)){var d=2*c,e=new Gb.List([{x:b.x+b.width/2,y:b.y-this._network.getRotatePointOffset()-d/2}]),f=a.getAngle();0!=f&&(e=this._rotatePointList(e,f,a.getOriginalRect()));var g=e.get(0),h={x:g.x-d/2,y:g.y-d/2,width:d,height:d},i=this._network.getRotatePointOutlineWidth(),j=this.rotatePointSize+i;Rb.grow(b,j,j);var k=Rb.unionRect(a.getRect(),h);this._viewRect=Rb.unionRect(k,this._viewRect),this.rotatePoints=e}}},_addShapeNodePoint:function(a){this._addEditPoints(a.getPoints())},_addShapeLinkPoints:function(a){this._addEditPoints(a.getPoints())},_addLinkControlPoint:function(a){if(wc.isOrthogonalLink(a._element)){var b=a.getControlPoint();if(b){var c=new Gb.List;c.add(b),this._addEditPoints(c)}}},_addEditPoints:function(a){var b=Rb.getRect(a);if(b){var c=this._network.getEditPointSize();if(!(0>=c)){var d=this._network.getEditPointOutlineWidth();this._addPoints(b,a,d,!1)}}},_addPoints:function(a,b,c,d,e,f){var g=f?this._network.getResizePointSize():this._network.getEditPointSize();if(!(0>g)){var h=g+c;Rb.grow(a,h,h),this._viewRect=Rb.unionRect(a,this._viewRect),1==f?this.resizingPoints=b:this.editPoints=b}},_rotatePoint:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_rotatePointList:function(a,b,c){var d=this,e=new Gb.List;return a.forEach(function(a){e.add(d._rotatePoint(a,b,c))}),e},_getRotateRect:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x,c.y),e={x:a.x+a.width/2,y:a.y+a.height/2},f=d.transform(e),g=new Gb.List([{x:f.x-a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y+a.height/2},{x:f.x-a.width/2,y:f.y+a.height/2}]);return Rb.getRect(g)}}),Gb.canvas.HTMLLabelAttachment=function(a,b){Gb.canvas.HTMLLabelAttachment.superClass.constructor.call(this,a,b),this._triangleDiv=Gb.Util.createDiv(),this._roundDiv=Gb.Util.createDiv(),this._contentDiv=Gb.Util.createDiv();this._network.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Hb.ext("twaver.canvas.HTMLLabelAttachment",Gb.canvas.LabelAttachment,{validate:function(){var a=this._element.getStyle("attachment.htmllabel.hyperlink");a?(Gb.Util.setCSSStyle(this._triangleDiv,"pointer-events","auto"),Gb.Util.setCSSStyle(this._contentDiv,"pointer-events","auto")):(Gb.Util.setCSSStyle(this._triangleDiv,"pointer-events","none"),Gb.Util.setCSSStyle(this._contentDiv,"pointer-events","none")),Gb.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Gb.Util.setCSSStyle(this._contentDiv,"white-space","nowrap");var b=(this.getFont("label.font"),this.getLabel());this._contentDiv.innerHTML=b,this._contentDiv.style.visibility="hidden",Gb.canvas.HTMLLabelAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},paint:function(a){var b=this.isFill(),c=this.getOutlineWidth(),d=this._contentRect;if(this.getElementUI().setShadow(this,a),c>0||b){if(Vb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._pointers){var e=this._pointers;a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Vb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}var h=(this.getFont("label.font"),this.getLabel(),this._network.getViewRect().x),i=this._network.getViewRect().y,j=this._network.getZoom(),k={x:this._contentRect.x+this._contentRect.width/2,y:this._contentRect.y+this._contentRect.height/2},l=k.x*j-h-this._contentDiv.offsetWidth/2*j+"px",m=k.y*j-i-this._contentDiv.offsetHeight/2*j+"px";this._contentDiv.style.left=l,this._contentDiv.style.top=m,this._contentDiv.style.setProperty("-webkit-transform","scale("+j+")",null),this._contentDiv.style.setProperty("-webkit-transform-origin","0 0",null),this._network._debug&&Vb.strokeRect(a,this._contentRect,"#AAAAAA")},setVisibility:function(a){this._contentDiv.style.visibility=a},dispose:function(){this._network.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),Gb.canvas.HTMLAlarmAttachment=function(a,b){Gb.canvas.HTMLAlarmAttachment.superClass.constructor.call(this,a,b),this._triangleDiv=Gb.Util.createDiv(),this._roundDiv=Gb.Util.createDiv(),this._contentDiv=Gb.Util.createDiv(),Gb.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Gb.Util.setCSSStyle(this._triangleDiv,"pointer-events","none"),Gb.Util.setCSSStyle(this._contentDiv,"white-space","nowrap"),Gb.Util.setCSSStyle(this._contentDiv,"pointer-events","none");this._network.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Hb.ext("twaver.canvas.HTMLAlarmAttachment",Gb.canvas.AlarmAttachment,{validate:function(){var a=(this.getFont("alarm.font"),this._network.getAlarmLabel(this._element));this._contentDiv.innerHTML=a,this._contentDiv.style.visibility="hidden",Gb.canvas.HTMLAlarmAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},paint:function(a){var b=this.isFill(),c=this.getOutlineWidth(),d=this._contentRect;if(this.getElementUI().setShadow(this,a),c>0||b){if(Vb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._pointers){var e=this._pointers;a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Vb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}var h=(this.getFont("alarm.font"),this._network.getAlarmLabel(this._element),this._network.getViewRect().x),i=this._network.getViewRect().y,j=this._network.getZoom(),k={x:this._contentRect.x+this._contentRect.width/2,y:this._contentRect.y+this._contentRect.height/2},l=k.x*j-h-this._contentDiv.offsetWidth/2*j+"px",m=k.y*j-i-this._contentDiv.offsetHeight/2*j+"px";this._contentDiv.style.left=l,this._contentDiv.style.top=m,this._contentDiv.style.setProperty("-webkit-transform","scale("+j+")",null),this._contentDiv.style.setProperty("-webkit-transform-origin","0 0",null),this._network._debug&&Vb.strokeRect(a,this._contentRect,"#AAAAAB"),Gb.canvas.AlarmAttachment.superClass.paint.apply(this,arguments)},setVisibility:function(a){this._contentDiv.style.visibility=a},dispose:function(){this._network.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),Gb.canvas.interaction.BaseInteraction=function(a){this.network=a},Hb.ext("twaver.canvas.interaction.BaseInteraction",Object,{setUp:function(){},tearDown:function(){},repaint:function(){this.network.repaintTopCanvas()},convertPointFromView:function(a){var b=a.x*this.network.getZoom()-this.network.getViewRect().x,c=a.y*this.network.getZoom()-this.network.getViewRect().y;return{x:b,y:c}},convertFromUIToMarkerRect:function(a,b,c){var d=this.network.getZoom();return{x:a.x*d-this.network.getViewRect().x+b*d,y:a.y*d-this.network.getViewRect().y+c*d,width:a.width*d,height:a.height*d}},getMarkerPoint:function(a){var b;if(Ob.isTouchable&&a.changedTouches&&a.changedTouches.length>0){var c=a.changedTouches[0];return b={x:c.clientX,y:c.clientY}}return b=Ob.isFirefox?{x:a.layerX,y:a.layerY}:{x:a.offsetX,y:a.offsetY}},paint:function(a){},addListener:function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];Ub.addEventListener(b,"handle_"+b,this.network.getView(),this)}},removeListener:function(){for(var a=0;a<arguments.length;a++)Ub.removeEventListener(arguments[a],this.network.getView(),this)},_handle_mousedown:function(a){0===a.button&&(this._startLogical=this.network.getLogicalPoint(a),this._startClient=Ub.getClientPoint(a),this._startLogical&&Ub.handle_mousedown(this,a))},_handle_mousemove:function(a){this._endLogical={x:this._startLogical.x+(a.clientX-this._startClient.x)/this.network.getZoom(),y:this._startLogical.y+(a.clientY-this._startClient.y)/this.network.getZoom()}},_handle_mouseup:function(a){delete this._startClient,delete this._startLogical,delete this._endLogical}}),Gb.canvas.interaction.SelectInteraction=function(a){Gb.canvas.interaction.SelectInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.canvas.interaction.SelectInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup"),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseup"),this.end(),this.network.removeMarker(this)},paint:function(a){if(null!=this.startPoint&&null!=this.endPoint){var b=this.convertPointFromView(this.startPoint),c=this.convertPointFromView(this.endPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Rb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.network.getSelectOutlineWidth(),j=this.getIntersectMode()?this.network.getSelectFillColor():null;a.strokeStyle=this.network.getSelectOutlineColor(),a.lineWidth=i,Od.rect(a,h.x,h.y,h.width,h.height,j,this.network.getSelectOutlineColor()),a.closePath()}}},handle_mousedown:function(a){if(this.network.isValidEvent(a)&&!this.network.isMovingElement()&&!this.network.isEditingElement()&&!a.shiftKey){var b=this.network.getElementAt(a),c=this.network.getSelectionModel();b?Hb.isCtrlDown(a)?c.contains(b)?c.removeSelection(b):c.appendSelection(b):c.contains(b)||c.setSelection(b):(Hb.isCtrlDown(a)||c.clearSelection(),this.end(a),this.startPoint=this.network.getLogicalPoint(a),this.startPoint&&this.network.isRectSelectEnabled()&&this.addListener("mousemove"))}},handle_mouseup:function(a){this.end(a)},handle_mousemove:function(a){if(this.network.isMovingElement()||this.network.isEditingElement())return void this.end(a);var b=this.network.getLogicalPoint(a);b&&(this.network.setSelectingElement(!0),this.network.fireInteractionEvent(null==this.endPoint?{kind:"selectStart",event:a}:{kind:"selectBetween",event:a}),this.endPoint=b,this.repaint())},end:function(a){if(this.startPoint){if(this.endPoint&&this.startPoint.x!==this.endPoint.x&&this.startPoint.y!==this.endPoint.y){var b=Rb.getRect([this.startPoint,this.endPoint]),c=this.network.getElementsAtRect(b,this.getIntersectMode(),this.network.getRectSelectFilter());if(c&&c.size()>0){var d=this.network.getSelectionModel(),e=d.toSelection();c.forEach(function(a){d.contains(a)?e.remove(a):e.add(a)},this),d.setSelection(e)}this.network.fireInteractionEvent({kind:"selectEnd",event:a})}this.network.setSelectingElement(!1),this.removeListener("mousemove"),this.startPoint=null,this.endPoint=null,this.repaint()}},getIntersectMode:function(){return"intersect"===this.network.getSelectMode()?!0:"contain"===this.network.getSelectMode()?!1:this.startPoint.x>this.endPoint.x&&this.startPoint.y>this.endPoint.y}}),Gb.canvas.interaction.MoveInteraction=function(a,b){this.lazyMode=b,Gb.canvas.interaction.MoveInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.canvas.interaction.MoveInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup","keydown","mouseout"),
this.network.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseup","keydown","mouseout"),this.end(),this.network.removeMarker(this)},handle_keydown:function(a){this.currentKeyEvent=a,this.addListener("keyup")},handle_keyup:function(a){this.currentKeyEvent=null,this.removeListener("keyup")},isParenting:function(){return this.pressPoint&&null!=this.currentKeyEvent&&80===this.currentKeyEvent.keyCode},parentProcess:function(a,b){var c=null;this.parent=null;var d=this;if(!b&&this.isParenting()){var e={},f=this.network.getLogicalPoint(a);e.x=f.x-1,e.y=f.y-1,e.width=2,e.height=2;var g=this.network.getElementsAtRect(e,!0);if(g&&g.size()>0)for(var h=g.size(),i=0;h>i;i++){var j=g.get(i);if(!d.network.getElementBox().getSelectionModel().contains(j)){d.parent=j;break}}}else this.parent=null;null!=this.parent&&(c=this.network.getElementUI(this.parent).getViewRect()),this.parentRect=null==c||b?null:c},paint:function(a){if(this.lazyMode){if(null==this.pressPoint||null==this.dragPoint)return;a.beginPath();var b=this.dragPoint.x-this.pressPoint.x,c=this.dragPoint.y-this.pressPoint.y,d=this.network.getMovableSelectedElements(),e=d.size(),f=this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,g=this.network.getLazyMoveOutlineWidth(),h=this.network.getLazyMoveOutlineColor();a.strokeStyle=h,a.lineWidth=g,a.fillStyle=f;for(var i=0;e>i;i++){var j=d.get(i),k=this.network.getElementUI(j);if(k){var l=this.convertFromUIToMarkerRect(k.getViewRect(),b,c);Od.rect(a,l.x,l.y,l.width,l.height)}}a.fill(),a.stroke()}if(this.parentRect){a.beginPath();var f=this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,g=this.network.getLazyMoveOutlineWidth(),h=this.network.getLazyMoveOutlineColor();a.strokeStyle=h,a.lineWidth=g,a.fillStyle=f;var l=this.parentRect;Od.rect(a,l.x,l.y,l.width,l.height),a.fill(),a.stroke()}},handle_mousedown:function(a){if(0===a.button&&this.network.isValidEvent(a)&&!this.network.isSelectingElement()&&!this.network.isEditingElement()){var b=this.network.getElementAt(a);this.network.isMovable(b)&&(this.end(a),this.lastPoint=this.network.getLogicalPoint(a),this.lazyMode&&(this.pressPoint=this.lastPoint),this.lastPoint&&this.addListener("mousemove"))}},handle_mouseup:function(a){this.end(a)},handle_mouseout:function(a){this.end(a)},handle_mousemove:function(a){if(this.network.isSelectingElement()||this.network.isEditingElement()||!this.network.hasMovableSelectedElements())return void this.end(a);var b=this.network.getLogicalPoint(a);b&&this.lastPoint&&(this.xoffset=b.x-this.lastPoint.x,this.yoffset=b.y-this.lastPoint.y,Math.abs(this.xoffset)<1&&Math.abs(this.yoffset)<1||(this.lazyMode?null==this.dragPoint?(this.network.fireInteractionEvent({kind:"lazyMoveStart",event:a}),this.network.setMovingElement(!0)):this.network.fireInteractionEvent({kind:"lazyMoveBetween",event:a}):(this.lastPoint=b,this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a})),this.network.moveSelectedElements(this.xoffset,this.yoffset)),this.parentProcess(a,!1),this.lazyMode&&(this.dragPoint=b),(this.lazyMode||this.isParenting())&&this.repaint()))},end:function(a){if(this.lazyMode){if(null!=this.dragPoint&&null!=this.pressPoint){var b=this,c=function(){b.network.fireInteractionEvent({kind:"lazyMoveEnd",event:a}),b.network.setMovingElement(!1)},d=this.dragPoint.x-this.pressPoint.x,e=this.dragPoint.y-this.pressPoint.y;this.network.moveSelectedElements(d,e,this.network.isLazyMoveAnimate(),c)}}else this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a}));if(this.isParenting()){null==this.parent&&(this.parent=this.network.getCurrentSubNetwork());var b=this;this.network.getMovableSelectedElements().forEach(function(a){a.setParent(b.parent)},this.network)}this.parentProcess(a,!0),this.isParenting()&&this.repaint(),this.network.invalidateCanvasSize(),this.removeListener("mousemove"),this.lastPoint=null,this.dragPoint=null,this.pressPoint=null}}),Gb.canvas.interaction.ScrollInteraction=function(a){Gb.canvas.interaction.ScrollInteraction.superClass.constructor.call(this,a),this.hThumbRect=null,this.vThumbRect=null,this.scrollBarVisible=!1},Hb.ext("twaver.canvas.interaction.ScrollInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseover","mouseout"),Ob.isFirefox?Ub.addEventListener("DOMMouseScroll","handleMouseWheel",this.network.getView(),this):Ub.addEventListener("mousewheel","handleMouseWheel",this.network.getView(),this),Ub.addEventListener("mouseup","handleMouseUp",window,this),Ub.addEventListener("mousemove","handleMouseMove",window,this),this.network.addPropertyChangeListener(this.handleViewRectChange,this),this.validateScrollBar(),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseover","mouseout"),Ob.isFirefox?Ub.removeEventListener("DOMMouseScroll",this.network.getView(),this):Ub.removeEventListener("mousewheel",this.network.getView(),this),Ub.removeEventListener("mouseup",window,this),Ub.removeEventListener("mousemove",window,this),this.network.removePropertyChangeListener(this.handleViewRectChange,this),this.network.removeMarker(this)},handleViewRectChange:function(a){("viewRect"==a.property||"canvasSizeChange"==a.property)&&this.validateScrollBar()},getScrollBarWidth:function(){return this.network.getScrollBarWidth()},getScrollBarColor:function(){return"#cccccc"},validateScrollBar:function(){if(this.hThumbRect=null,this.vThumbRect=null,0==this.network.isScrollBarVisible())return void this.repaint();var a=this.network.getViewRect().height,b=this.network.getViewRect().width,c=this.network.getViewRect().x,d=this.network.getViewRect().y,e=this.network.getCanvasSize(),f=e.width,g=e.height;if(f>b&&(0>c||c+b>f))return void this.repaint();if(g>a&&(0>d||d+a>g))return void this.repaint();var h=0,i=g>a,j=f>b,k=this.getScrollBarWidth();if(g>a){h=j?a*(a-k)/g:a*a/g;var l=d/(g-a)*(a-h-k);this.vThumbRect={x:b-k,y:l,width:k,height:h}}var m=0;if(f>b){m=i?b*(b-k)/f:b*b/f;var n=c/(f-b)*(b-m-k);this.hThumbRect={x:n,y:a-k,width:m,height:k}}this.network.setHScrollBarVisible(null!=this.hThumbRect),this.network.setVScrollBarVisible(null!=this.vThumbRect),this.repaint()},scrollXOffset:function(a){var b=this.network.getViewRect().height,c=this.network.getViewRect().width,d=this.network.getViewRect().x,e=this.network.getViewRect().y,f=30;a&&(f=-30),this.network.setViewRect(d+f,e,c,b)},scrollYOffset:function(a){var b=this.network.getViewRect().height,c=this.network.getViewRect().width,d=this.network.getViewRect().x,e=this.network.getViewRect().y,f=30;a&&(f=-30),this.network.setViewRect(d,e+f,c,b)},handle_mousedown:function(a){if(1!=this.network.isValidEvent(a)){var b=this.getMarkerPoint(a);this.hBarDownPoint=null,this.vBarDownPoint=null,null!=this.vThumbRect&&Rb.containsPoint(this.vThumbRect,b.x,b.y)&&(this.vBarDownPoint={x:a.screenX,y:a.screenY},this.vBarDownOffset=this.vBarDownPoint.y-this.vThumbRect.y),null!=this.hThumbRect&&Rb.containsPoint(this.hThumbRect,b.x,b.y)&&(this.hBarDownPoint={x:a.screenX,y:a.screenY},this.hBarDownOffset=this.hBarDownPoint.x-this.hThumbRect.x)}},handle_mouseover:function(a){1!=this.scrollBarVisible&&(this.scrollBarVisible=!0,this.repaint())},handle_mouseout:function(a){0!=this.scrollBarVisible&&(this.scrollBarVisible=!1,this.repaint())},handleMouseUp:function(a){this.vBarDownPoint=null,this.hBarDownPoint=null,this.repaint()},handleMouseMove:function(a){var b={x:a.screenX,y:a.screenY},c=this.network.getCanvasSize(),d=this.network.getViewRect().height,e=this.network.getViewRect().width,f=this.getScrollBarWidth();if(null!=this.hBarDownPoint){var g=b.x-this.hBarDownPoint.x;return this.hBarDownPoint=b,void this.network.setViewOffSet(g*c.width/(e-f),0)}if(null!=this.vBarDownPoint){var h=b.y-this.vBarDownPoint.y;return this.vBarDownPoint=b,void this.network.setViewOffSet(0,h*c.height/(d-f))}},handleMouseWheel:function(a){var b=!1;a.wheelDelta!==a.wheelDeltaX?(a.wheelDelta?a.wheelDelta>0&&(b=!0):a.detail<0&&(b=!0),this.scrollYOffset(b)):(a.wheelDelta?a.wheelDelta>0&&(b=!0):a.detail<0&&(b=!0),this.scrollYOffset(b))},paintRoundRect:function(a,b,c,d,e,f,g,h){a.beginPath(),a.globalAlpha=c,a.fillStyle=b,Vb.drawRoundRect(a,d,e,f,g,h),a.fill()},paint:function(a){if(0!=this.network.isScrollBarVisible()&&(0!=this.scrollBarVisible||null!=this.hBarDownPoint||null!=this.vBarDownPoint)){var b=this.getScrollBarWidth(),c=this.network.getViewRect().height,d=this.network.getViewRect().width;a.save();var e,f=this.getScrollBarColor();null!=this.hThumbRect&&(e=a.createLinearGradient(this.hThumbRect.x,this.hThumbRect.y,this.hThumbRect.x,this.hThumbRect.y+this.hThumbRect.height),e.addColorStop(0,f),e.addColorStop(1,"#666666"),this.paintRoundRect(a,this.getScrollBarColor(),.5,0,c-b,d-b,b,b/2),this.paintRoundRect(a,e,.9,this.hThumbRect.x,this.hThumbRect.y+1,this.hThumbRect.width,this.hThumbRect.height-2,b/2)),null!=this.vThumbRect&&(e=a.createLinearGradient(this.vThumbRect.x,this.vThumbRect.y,this.vThumbRect.x+this.vThumbRect.width,this.vThumbRect.y),e.addColorStop(0,f),e.addColorStop(1,"#666666"),this.paintRoundRect(a,this.getScrollBarColor(),.5,d-b,0,b,c-b,b/2),this.paintRoundRect(a,e,.9,this.vThumbRect.x+1,this.vThumbRect.y,this.vThumbRect.width-2,this.vThumbRect.height,b/2)),a.restore()}}}),Gb.canvas.interaction.DefaultInteraction=function(a){Gb.canvas.interaction.DefaultInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.canvas.interaction.DefaultInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove","keydown")},tearDown:function(){this.removeListener("mousedown","mousemove","keydown")},handle_mousedown:function(a){if(this.network.isValidEvent(a)){this.network.isFocusOnClick()&&Gb.Util.setFocus(this.network.getView());var b=this.network.getElementAt(a);2===a.detail?this.handleDoubleClicked(a,b):this.handleClicked(a,b)}},handleClicked:function(a,b){Bc.handleClicked(this.network,a,b)},handleDoubleClicked:function(a,b){Bc.handleDoubleClicked(this.network,a,b)},handle_keydown:function(a){Bc.handleKeyDown(this.network,a)},handle_mousemove:function(a){var b=this.network.getElementAt(a),c=this._preElement,d=Cc(c),e=Cc(b);c!==b&&(c&&(d&&d.onMouseLeave&&d.onMouseLeave(c,this.network),this.network.onMouseLeave(c,a)),b&&(e&&e.onMouseEnter&&e.onMouseEnter(b,this.network),this.network.onMouseEnter(b,a))),b&&e&&e.onMouseMove&&e.onMouseMove(b,this.network),this.network.onMouseMove(b,a),this._preElement=b}}),Gb.canvas.interaction.PanInteraction=function(a){Gb.canvas.interaction.PanInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.canvas.interaction.PanInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup"),this._oldCursor=this.network.getView().style.cursor},tearDown:function(){this.removeListener("mousedown","mouseup")},handle_mousedown:function(a){this.network.isValidEvent(a)&&(this.lastPoint=this.getMarkerPoint(a),this.lastPoint&&(this.addListener("mousemove"),this.network.getView().style.cursor="pointer"))},handle_mouseup:function(a){this._clear()},handle_mousemove:function(a){if(this.lastPoint){var b=this.getMarkerPoint(a);if(b){var c=b.x-this.lastPoint.x,d=b.y-this.lastPoint.y;this.network.panByOffset(-c,-d),this.lastPoint=b}}},_clear:function(a){this.lastPoint&&(this.lastPoint=null,this.network.getView().style.cursor=this._oldCursor,this.removeListener("mousemove"))}}),Gb.canvas.interaction.CreateElementInteraction=function(a,b){b||(b=Gb.Node),this.elementFunction=Gb.Util.isTypeOf(b,Gb.Node)?function(a){var c=new b;return c instanceof Gb.Node&&c.setCenterLocation(a),c}:b,Gb.canvas.interaction.CreateElementInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.canvas.interaction.CreateElementInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown")},handle_mousedown:function(a){var b=this.network.getLogicalPoint(a);if(b){var c=this.elementFunction(b);c&&this.network.addElementByInteraction(c)}}}),Gb.canvas.interaction.EditInteraction=function(a,b){this.lazyMode=b,this.pointIndex=-1,Gb.canvas.interaction.EditInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.canvas.interaction.EditInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup","mousemove"),this.oldCursor=this.network.getView().style.cursor,this.network.setHasEditInteraction(!0),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseup","mousemove"),this.network.getView().style.cursor=this.oldCursor,this.network.setHasEditInteraction(!1),this.clear(),this.network.removeMarker(this)},paint:function(a){if(1==this.lazyMode&&null!=this.resizingRect){a.lineWidth=this.network.getResizeLineWidth();var b=this.convertFromUIToMarkerRect(this.resizingRect,0,0);a.save(),Gb.Util.rotateCanvas(a,b,this.node.getAngle()),a.beginPath(),Od.rect(a,b.x,b.y,b.width,b.height,null,this.network.getResizeLineColor()),a.restore()}this.isStartRotate&&this.showRotateScale(a)},clear:function(){this.network.setEditingElement(!1),this.network.setRotatingElement(!1),this.isStart=!1,this.isStartRotate=!1,this.node=null,this.shapeNode=null,this.shapeLink=null,this.linkUI=null,this.resizingRect=null,this.resizeDirection=null,this.pointIndex=-1,this._removeCursor(),this.oldCursor=null,this.network.repaintTopCanvas()},_removeCursor:function(){this.cursorID&&(this.network.getView().style.cursor=this.oldCursor||"default",this.cursorID=null),this.resizeDirection=null,this.isCrossCursor=!1},_setCrossCursor:function(){this.isCrossCursor||(this._removeCursor(),this._setCursor("crosshair"),this.isCrossCursor=!0)},_setCursor:function(a){this.cursorID=a,this.network.getView().style.cursor!==this.cursorID&&(this.network.getView().style.cursor=this.cursorID)},isKeyDown:function(a){return Hb.isAltDown(a)},handle_mousedown:function(a){if(0===a.button)if(!this.isKeyDown(a)||this.network.isEditingElement())!this.network.isEditingElement()||this.isStart||this.isStartRotate||(this.node&&this.resizeDirection?(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:this.lazyMode?"lazyResizeStart":"liveResizeStart",event:a,element:this.node,resizeDirection:this.resizeDirection})):this.shapeNode&&this.pointIndex>=0?this.isKeyDown(a)?(this.shapeNode.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeNode})):(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink&&this.pointIndex>=0?this.isKeyDown(a)?(this.shapeLink.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeLink})):(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI?(this.isStart=!0,this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.linkUI._element})):this.node&&(this.isStartRotate=!0,this._handle_mousedown(a)));else{var b=this.network.getElementAt(a),c=this.network.getLogicalPoint(a);if(b instanceof Gb.ShapeNode){var d=this.getPointIndex(b.getPoints(),c,!0);d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeNode=b,b.addPoint(c,d),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}if(b instanceof Gb.ShapeLink){var e=new Gb.List(b.getPoints()),f=this.network.getElementUI(b);e.add(f.getFromPoint(),0),e.add(f.getToPoint());var d=this.getPointIndex(e,c)-1;d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeLink=b,b.addPoint(c,d),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}}},handle_mouseup:function(a){if(this.isStart){var b=this.network.getLogicalPoint(a);if(this.resizingRect)if(this.lazyMode)if(this.network.isResizeAnimate()){var c=this,d=new Gb.animate.AnimateBounds(this.node,this.resizingRect,function(){c.network.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:c.node,resizeDirection:c.resizeDirection}),c.clear()});Gb.animate.AnimateManager.start(d)}else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"liveResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.shapeNode&&this.pointIndex>=0&&b?(this.shapeNode.setPoint(this.pointIndex,b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink&&this.pointIndex>=0&&b?(this.shapeLink.setPoint(this.pointIndex,b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI&&b&&(this.linkUI.setControlPoint(b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.linkUI._element}))}this._handle_mouseup(a),this.lazyMode||this.clear()},handle_mousemove:function(a){if(this.network.isValidEvent(a)){if(this.isStartRotate&&this.node)return this._handleRotateElement(a,this.node),void(this.network.isShowRotateScale()&&this.repaint());if(this.isStart){if(this.shapeNode&&this.pointIndex>=0)return void this._handleMovingShapeNodePoint(a);if(this.shapeLink&&this.pointIndex>=0)return void this._handleMovingShapeLinkPoint(a);if(this.node&&this.resizeDirection)return void this._handleResizing(a);if(this.linkUI)return void this._handleMovingLinkControlPoint(a)}if(this.network.isSelectingElement()||this.network.isMovingElement()||0===this.network.getSelectionModel().size())return void this.clear();var b=this.network.getElementAt(a),c=this.network.getElementUI(b);if(!c||!c.getEditAttachment())return void this.clear();var d=this.network.getLogicalPoint(a);if(b instanceof Gb.Node){if(this.node=b,this._isEditingShapeNode(d)||this._isResizingNode(d))return void this.network.setEditingElement(!0);if(this._isRotatingElement(d))return this.network.setRotatingElement(!0),void this.network.setEditingElement(!0)}else if(b instanceof Gb.ShapeLink){if(this.shapeLink=b,this._isEditingShapeLink(d))return void this.network.setEditingElement(!0)}else if(c instanceof Gb.canvas.LinkUI){var e=this.network.getEditPointSize();if(wc.isOrthogonalLink(c._element)){this.linkUI=c;var f=this.linkUI.getControlPoint();return void(f&&this._contains(d,f,e)&&(this._setCrossCursor(),this.network.setEditingElement(!0)))}}this.clear()}},_isRotatingElement:function(a){var b=this.network.getRotatePointSize();if(0>=b)return!1;var c=this.node.getOriginalRect(),d=this.node.getAngle();return this._isRotating(a,"crosshair",c,d)},_isRotating:function(a,b,c,d){var e=this.network.getRotatePointSize(),f={x:c.x+c.width/2,y:c.y-this.network.getRotatePointOffset()-e},g=this._rotatePoint(f,d,c),h={x:g.x-e,y:g.y-e,width:2*e,height:2*e};return Rb.containsPoint(h,a)?(this._removeCursor(),this._setCursor(b),!0):!1},_handleRotateElement:function(a,b){this._handle_mousemove(a);var c=this._calculateAngle(this.network.getLogicalPoint(a),b);b.setAngle(c)},_calculateAngle:function(a,b){var c=b.getCenterLocation();return Math.round(180*Math.atan2(c.x-a.x,a.y-c.y)/Math.PI+180)},_handleMovingShapeNodePoint:function(a){var b=this.network.getLogicalPoint(a);this.shapeNode.setPoint(this.pointIndex,b),this.network.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeNode,pointIndex:this.pointIndex})},_handleMovingShapeLinkPoint:function(a){var b=this.network.getLogicalPoint(a);this.shapeLink.setPoint(this.pointIndex,b),this.network.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeLink,pointIndex:this.pointIndex})},_handleMovingLinkControlPoint:function(a){this.linkUI.setControlPoint(this.network.getLogicalPoint(a)),this.network.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.linkUI._element})},_handleResizing:function(a){this._handle_mousemove(a);var b=this.node.getAngle(),c=this.node.getLocation(),d=this.node.getWidth()/2,e=this.node.getHeight()/2,f={x:c.x+d,y:c.y+e},g={x:-d,y:-e},h={x:-d,y:e},i={x:d,y:e},j={x:d,y:-e},k={x:0,y:-e},l={x:d,y:0},m={x:0,y:e},n={x:-d,y:0};if("northwest"===this.resizeDirection&&(this._transformPoint(i,f,b),g.x=this._endLogical.x,g.y=this._endLogical.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),"north"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),k.y=o.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}if("northeast"===this.resizeDirection&&(this._transformPoint(h,f,b),j.x=this._endLogical.x,j.y=this._endLogical.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"west"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),n.x=o.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("east"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),l.x=o.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("southwest"===this.resizeDirection&&(this._transformPoint(j,f,b),h.x=this._endLogical.x,h.y=this._endLogical.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"south"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),m.y=o.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}"southeast"===this.resizeDirection&&(this._transformPoint(g,f,b),i.x=this._endLogical.x,i.y=this._endLogical.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),this.lazyMode?(this.repaint(),this.network.fireInteractionEvent({kind:"lazyResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection})):(this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"liveResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection}))},_isEditingShapeNode:function(a){var b=this.network.getEditPointSize();if(this.node instanceof Gb.ShapeNode){this.shapeNode=this.node;for(var c=this.shapeNode.getPoints(),d=0,e=c.size();e>d;d++){var f=c.get(d);if(this._contains(a,f,b))return this._setCrossCursor(),this.pointIndex=d,!0}}return this.pointIndex=-1,!1},_isEditingShapeLink:function(a){for(var b=this.network.getEditPointSize(),c=this.shapeLink.getPoints(),d=0,e=c.size();e>d;d++){var f=c.get(d);if(this._contains(a,f,b))return this._setCrossCursor(),this.pointIndex=d,!0}return this.pointIndex=-1,!1},_isResizingNode:function(a){var b=this.network.getResizePointSize();if(0>=b)return!1;var c=this.node.getOriginalRect(),d=this.node.getAngle(),e={x:c.x,y:c.y},f=this._rotatePoint(e,d,c);return this._isResizing(a,f.x,f.y,"northwest","nwse-resize")?!0:(e={x:c.x+c.width/2,y:c.y},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"north","ns-resize")?!0:(e={x:c.x+c.width,y:c.y},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"northeast","nesw-resize")?!0:(e={x:c.x,y:c.y+c.height/2},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"west","ew-resize")?!0:(e={x:c.x+c.width,y:c.y+c.height/2},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"east","ew-resize")?!0:(e={x:c.x,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"southwest","nesw-resize")?!0:(e={x:c.x+c.width/2,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"south","ns-resize")?!0:(e={x:c.x+c.width,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"southeast","nwse-resize")?!0:!1)))))))},_rotatePoint:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_isResizing:function(a,b,c,d,e){var f=this.network.getResizePointSize();return this._contains(a,{x:b,y:c},f)?(this.resizeDirection!==d&&(this._removeCursor(),e=this._changeCursorWithAngle(d,this.node.getAngle()),this._setCursor(e),this.resizeDirection=d),!0):!1},_getRect:function(a,b,c,d){var e=c>a?a:c,f=d>b?b:d,g=Math.abs(a-c),h=Math.abs(b-d);return{x:e,y:f,width:g,height:h}},_contains:function(a,b,c){var d={x:b.x-c,y:b.y-c,width:2*c,height:2*c};return Rb.containsPoint(d,a)},getPointIndex:function(a,b,c){if(a.size()<2)return 0;for(var d,e=a.get(0),f=1;f<a.size();f++){if(d=a.get(f),this.isPointOnLine(b,e,d,6))return f;e=d}return e=a.get(0),c&&this.isPointOnLine(b,e,d,6)?a.size():0},showRotateScale:function(a){var b,c,d,e,f,g=(new Gb.List,this.network.getRotateScaleWidth()),h=this.network.getRotateScaleHeight(),i=this.network.getRotatePointSize(),j=this.node.getAngle(),k=this.node.getOriginalRect(),l={x:k.x+k.width/2,y:k.y-this.network.getRotatePointOffset()-i},m=this._rotatePoint(l,j,k),n="13px Arial",o=j+"°";this.node.getAngle()>=0&&this.node.getAngle()<=180?(c={x:m.x+i,y:m.y},d={x:c.x+g,y:c.y},e={x:d.x,y:d.y-h},f={x:c.x,y:e.y}):this.node.getAngle()>180&&this.node.getAngle()<=360&&(c={x:m.x-i,y:m.y},d={x:c.x-g,y:c.y},e={x:d.x,y:d.y-h},f={x:c.x,y:e.y});var p=new Gb.List([c,d,e,f]),b=Hb.math.getRect(p);a.fillStyle=this.network.getRotateScaleFillColor(),a.fillRect(b.x,b.y,b.width,b.height),a.fillStyle=this.network.getRotateScaleFontColor(),a.textBaseline="middle",a.textAlign="center",a.font=n,a.fillText(o,b.x+b.width/2,b.y+b.height/2)},isPointOnLine:function(a,b,c,d){0>d&&(d=0);var e=this.getDistanceFromPointToLine(a,b,c);return d>=e&&a.x>=Math.min(b.x,c.x)-d&&a.x<=Math.max(b.x,c.x)+d&&a.y>=Math.min(b.y,c.y)-d&&a.y<=Math.max(b.y,c.y)+d},getDistanceFromPointToLine:function(a,b,c){if(b.x===c.x)return Math.abs(a.x-b.x);var d=(c.y-b.y)/(c.x-b.x),e=(c.x*b.y-b.x*c.y)/(c.x-b.x);return Math.abs(d*a.x-a.y+e)/Math.sqrt(d*d+1)},_transformPoint:function(a,b,c){var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x,g=a.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_reversPoint:function(a,b,c){c*=-1;var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x-b.x,g=a.y-b.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_changeCursorWithAngle:function(a,b){var c,d=["auto","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"];switch(a){case"northwest":c=1;break;case"north":c=2;break;case"northeast":c=3;break;case"east":c=4;break;case"southeast":c=5;break;case"south":c=6;break;case"southwest":c=7;break;case"west":c=8;break;default:c=0}return(b>=360||-360>=b)&&(b%=360),b>22.5&&67.5>=b&&(c+=1),-22.5>b&&b>=-67.5&&(c-=1),b>67.5&&112.5>=b&&(c+=2),-67.5>b&&b>=-112.5&&(c-=2),b>112.5&&157.5>=b&&(c+=3),-112.5>b&&b>=-157.5&&(c-=3),b>157.5&&202.5>=b&&(c+=4),-157.5>b&&b>=-202.5&&(c-=4),b>202.5&&247.5>=b&&(c+=5),-202.5>b&&b>=-247.5&&(c-=5),b>247.5&&292.5>=b&&(c+=6),-247.5>b&&b>=-292.5&&(c-=6),b>292.5&&337.5>=b&&(c+=7),-292.5>b&&b>=-337.5&&(c-=7),c>8&&(c-=8),0>=c&&(c+=8),d[c]}}),Gb.canvas.interaction.CreateLinkInteraction=function(a,b){b||(b=Gb.Link),this.linkFunction=Gb.Util.isTypeOf(b,Gb.Link)?function(a,c){var d=new b;return d instanceof Gb.Link&&(d.setFromNode(a),d.setToNode(c)),d}:b,Gb.canvas.interaction.CreateLinkInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.canvas.interaction.CreateLinkInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear(),this.network.removeMarker(this)},paint:function(a){a.beginPath();var b,c;a.lineWidth=this.network.getEditLineWidth();var d=this.network.getEditLineColor();this.currentNode&&this.currentNode!==this.fromNode&&(b=this.network.getElementUI(this.currentNode).getViewRect(),c=this.convertFromUIToMarkerRect(b,0,0),Od.rect(a,c.x,c.y,c.width,c.height,null,d)),this.fromNode&&(b=this.network.getElementUI(this.fromNode).getViewRect(),c=this.convertFromUIToMarkerRect(b,0,0),Od.rect(a,c.x,c.y,c.width,c.height,null,d)),this.currentPoint&&this.paintLine(a),a.closePath()},paintLine:function(a){var b=this.network.getEditLineColor(),c=this.convertPointFromView(this.fromNode.getCenterLocation()),d=c.x,e=c.y,f=this.currentPoint.x,g=this.currentPoint.y;a.strokeStyle=b,a.beginPath(),a.moveTo(d,e),a.lineTo(f,g),a.stroke()},clear:function(){this.currentPoint=null,this.currentNode=null,this.fromNode=null,this.toNode=null},createLink:function(){return this.linkFunction(this.fromNode,this.toNode)},handle_mousedown:function(a){if(this.network.isValidEvent(a))if(this.fromNode){if(this.toNode=this.currentNode,this.toNode){var b=this.createLink();b&&this.network.addElementByInteraction(b)}this.clear()}else this.fromNode=this.currentNode,this.currentNode=null,this.currentPoint=null,this.repaint()},handle_mousemove:function(a){var b=this.getMarkerPoint(a);if(b){if(this.network.isMovingElement()||this.network.isEditingElement())return void this.clear();var c=null;this.fromNode?(this.currentNode=this.getToNode(a),this.currentPoint=b,this.repaint()):(c=this.getFromNode(a),this.currentNode!==c&&(this.currentNode=c,this.repaint()))}},getFromNode:function(a){return this.getNode(a)},getToNode:function(a){return this.getNode(a)},getNode:function(a){var b=this.network.getElementAt(a);return b instanceof Ld&&this.network.isLinkable(b)&&this.network.getElementBox().getSelectionModel().isSelectable(b)?b:null}}),Gb.canvas.interaction.CreateShapeLinkInteraction=function(a,b){Gb.canvas.interaction.CreateShapeLinkInteraction.superClass.constructor.call(this,a),b||(b=Gb.ShapeLink),this.linkFunction=Gb.Util.isTypeOf(b,Gb.ShapeLink)?function(a,c,d){var e=new b;return e instanceof Gb.ShapeLink&&(e.setFromNode(a),e.setToNode(c),d&&e.setPoints(d)),e}:b},Hb.ext("twaver.canvas.interaction.CreateShapeLinkInteraction",Gb.canvas.interaction.CreateLinkInteraction,{clear:function(){this.points=null,Gb.canvas.interaction.CreateShapeLinkInteraction.superClass.clear.call(this)},createLink:function(){return this.linkFunction(this.fromNode,this.toNode,this.points)},handle_mousedown:function(a){if(0===a.button){var b=this.network.getLogicalPoint(a);if(b){if(this.fromNode)if(this.toNode=this.currentNode,this.toNode){
var c=this.createLink();c&&this.network.addElementByInteraction(c),this.clear()}else{if(this.points||(this.points=new Gb.List),this.points.size()>0){var d=this.points.get(this.points.size()-1);if(d.x===b.x&&d.y===b.y)return}this.points.add(b)}else this.fromNode=this.currentNode,this.points=null,this.currentNode=null,this.currentPoint=null;this.repaint()}}},paintLine:function(a){if(this.currentPoint){var b,c=new Gb.List;if(b=this.convertPointFromView(this.fromNode.getCenterLocation()),c.add(b,0),this.points&&this.points.size()>0)for(var d=this.points.size(),e=0;d>e;e++)b=this.convertPointFromView(this.points.get(e)),c.add(b);b=this.currentPoint,c.add(b),a.lineWidth=this.network.getEditLineWidth(),a.strokeStyle=this.network.getEditLineColor(),a.beginPath(),Vb.drawLinePoints(a,c),a.stroke()}}}),Gb.canvas.interaction.CreateShapeNodeInteraction=function(a,b){b||(b=Gb.ShapeNode),this.shapeNodeFunction=Gb.Util.isTypeOf(b,Gb.ShapeNode)?function(a){var c=new b;return c instanceof Gb.ShapeNode&&a&&c.setPoints(a),c}:b,Gb.canvas.interaction.CreateShapeNodeInteraction.superClass.constructor.call(this,a),this.timeStamp=-1},Hb.ext("twaver.canvas.interaction.CreateShapeNodeInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear(),this.network.removeMarker(this),this.network.setEditingElement(!1)},clear:function(){this.points=null,this.currentPoint=null},paint:function(a){if(this.points&&this.points.size()>0&&this.currentPoint){for(var b,c=new Gb.List,d=this.points.size(),e=0;d>e;e++)b=this.convertPointFromView(this.points.get(e)),c.add(b);b=this.convertPointFromView(this.currentPoint),c.add(b),a.lineWidth=this.network.getEditLineWidth(),a.strokeStyle=this.network.getEditLineColor(),a.beginPath(),Vb.drawLinePoints(a,c),a.stroke()}},handle_mousedown:function(a){if(0===a.button){var b=this.network.getLogicalPoint(a);if(b){if(2===a.detail||a.timeStamp-this.timeStamp<300){if(this.points){var c=this.shapeNodeFunction(this.points);this.network.addElementByInteraction(c),this.clear();var d=this;setTimeout(function(){d.network.setEditingElement(!1)},0)}}else{if(this.network.isEditingElement()||this.network.setEditingElement(!0),this.points||(this.points=new Gb.List),this.points.size()>0){var e=this.points.get(this.points.size()-1);if(e.x===b.x&&e.y===b.y)return}this.points.add(b)}this.timeStamp=a.timeStamp,this.repaint()}}},handle_mousemove:function(a){this.points&&(this.currentPoint=this.network.getLogicalPoint(a),this.repaint())}}),Gb.canvas.interaction.MagnifyInteraction=function(a,b,c,d,e){Gb.canvas.interaction.MagnifyInteraction.superClass.constructor.call(this,a),this.zoom=b||2,this.xRadius=c||100,this.yRadius=d||100,this.shape=e||"circle",this.borderColor="black",this.borderWidth=1,this.backgroundColor="white",this.markCanvas=Ub.createCanvas()},Hb.ext("twaver.canvas.interaction.MagnifyInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousemove"),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousemove"),this.network.removeMarker(this)},paint:function(a){if(this.point){var b=this.network._zoom,c=this.zoom*b,d=this.point.x*b-this.network.viewRect.x-this.xRadius,e=this.point.y*b-this.network.viewRect.y-this.yRadius,f=2*this.xRadius,g=2*this.yRadius,h={x:this.point.x-this.xRadius/c,y:this.point.y-this.yRadius/c,width:f/c,height:g/c},i=this.borderWidth,j=Ub.createCanvas();j.width=f,j.height=g,this.network.toCanvasByRegion(h,c,j),a.save(),a.beginPath(),Vb.drawVector(a,this.shape,null,d,e,f,g),a.clip(),a.fillStyle=this.backgroundColor,a.beginPath(),a.rect(d,e,f,g),a.fill(),a.drawImage(j,d,e),a.restore(),a.beginPath(),a.lineWidth=i,Vb.drawVector(a,this.shape,null,d+i/2,e+i/2,f-i,g-i),a.strokeStyle=this.borderColor,a.stroke()}},handle_mousemove:function(a){this.point=this.network.getLogicalPoint(a),this.point&&this.repaint()},getZoom:function(){return this.zoom},setZoom:function(a){this.zoom=a,this.network.repaintTopCanvas()},getShape:function(){return this.shape},setShape:function(a){this.shape=a,this.network.repaintTopCanvas()},getXRadius:function(){return this.xRadius},setXRadius:function(a){this.xRadius=a,this.network.repaintTopCanvas()},getYRadius:function(){return this.yRadius},setYRadius:function(a){this.yRadius=a,this.network.repaintTopCanvas()},getBorderColor:function(){return this.borderColor},setBorderColor:function(a){this.borderColor=a,this.network.repaintTopCanvas()},getBorderWidth:function(){return this.borderWidth},setBorderWidth:function(a){this.borderWidth=a,this.network.repaintTopCanvas()},getBackgroundColor:function(){return this.backgroundColor},setBackgroundColor:function(a){this.backgroundColor=a,this.network.repaintTopCanvas()}}),Gb.canvas.interaction.TouchInteraction=function(a){Gb.canvas.interaction.TouchInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.canvas.interaction.TouchInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){var a=this.network.getView();Ub.addEventListener("touchstart","handleTouchstart",a,this),Ub.addEventListener("touchmove","handleTouchmove",a,this),Ub.addEventListener("touchend","handleTouchend",a,this),Ub.addEventListener("touchcancel","handleTouchend",a,this),this.network.addMarker(this)},tearDown:function(){var a=this.network.getView();Ub.removeEventListener("touchstart",this.network.getView(),this),Ub.removeEventListener("touchmove",a,this),Ub.removeEventListener("touchend",a,this),Ub.removeEventListener("touchcancel",a,this),this.network.removeMarker(this)},handleTouchstart:function(a){if(Ub.preventDefault(a),a.touches&&1==a.touches.length){var b=this.network.getLogicalPoint(a),c=this.network.getElementAt(b);this._startTouchTime=new Date,this._startTouchPoint=b,this._startTouchClient=this.getMarkerPoint(a),c?(this._haveElementUnderTouch=!0,this._startTouchElement=c):(this._haveElementUnderTouch=!1,this._startTouchElement=null),this.timer=setTimeout(function(){Bc.handleLongClicked(self.network,a,c)},1e3)}else a.touches&&2==a.touches.length&&(this._distance=yc.getDistance(a),this._zoom=this.network.getZoom());this._touchCount=a.touches.length},handleTouchmove:function(a){if(Ub.preventDefault(a),2==this._touchCount&&a.touches&&2==a.touches.length)if(this.timer&&clearTimeout(this.timer),Math.abs(this._distance-yc.getDistance(a))>=Dd.TOUCH_ZOOM_THRESHOLD||this._zoomFlag){this._zoomFlag=!0;var b=yc.getDistance(a)/this._distance;this.network.setTouchZoom(this._zoom*b,!1)}else{var c=this.getMarkerPoint(a),d=this._startTouchClient.x-c.x,e=this._startTouchClient.y-c.y;this.network.panByOffset(d,e),this._startTouchClient=c}else if(1==this._touchCount&&a.touches&&1==a.touches.length)if(this._haveElementUnderTouch||!this.network.isRectSelectEnabled()){var f=this.network.getLogicalPoint(a),g=this.network.getElementAt(f);if(this.network.isMovingElement()||null!=this._startTouchElement&&this._startTouchElement==g&&this.network.getMovableSelectedElements().contains(g)){var d=f.x-this._startTouchPoint.x,e=f.y-this._startTouchPoint.y;(Math.abs(d)>=Dd.TOUCH_MOVE_THRESHOLD||Math.abs(e)>=Dd.TOUCH_MOVE_THRESHOLD)&&(this._startTouchPoint=f,this.network.moveSelectedElements(d,e),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a}),this.timer&&clearTimeout(this.timer)))}else{var d=f.x-this._startTouchPoint.x,e=f.y-this._startTouchPoint.y;(Math.abs(d)>=Dd.TOUCH_MOVE_THRESHOLD||Math.abs(e)>=Dd.TOUCH_MOVE_THRESHOLD)&&this.timer&&clearTimeout(this.timer);var c=this.getMarkerPoint(a),d=this._startTouchClient.x-c.x,e=this._startTouchClient.y-c.y;this.network.panByOffset(d,e),this._startTouchClient=c}}else{var h=this.network.getLogicalPoint(a);if(!h)return;var d=h.x-this._startTouchPoint.x,e=h.y-this._startTouchPoint.y;Math.abs(d)>=Dd.TOUCH_RECT_SELECT_THRESHOLD&&Math.abs(e)>=Dd.TOUCH_RECT_SELECT_THRESHOLD&&(this.network.setSelectingElement(!0),this._moveTouchPoint?this.network.fireInteractionEvent({kind:"selectBetween",event:a}):(this.network.fireInteractionEvent({kind:"selectStart",event:a}),this.timer&&clearTimeout(this.timer)),this._moveTouchPoint=h,this.repaint())}},handleTouchend:function(a){if(Ub.preventDefault(a),this.network.isMovingElement())this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a});else if(this.network.isSelectingElement()){var b=Rb.getRect([this._startTouchPoint,this._moveTouchPoint]),c=this.network.getElementsAtRect(b,this.getIntersectMode(),this.network.getRectSelectFilter());if(c&&c.size()>0){var d=this.network.getSelectionModel(),e=d.toSelection();c.forEach(function(a){d.contains(a)?e.remove(a):e.add(a)},this),d.setSelection(e)}this.network.fireInteractionEvent({kind:"selectEnd",event:a}),this._moveTouchPoint=null,this.network.setSelectingElement(!1),this.repaint()}else if(this._startTouchPoint){this._zoomFlag=!1;var f=new Date,g=this.network.getLogicalPoint(a),h=this.network.getElementAt(this._startTouchPoint);g&&f.getTime()-this._startTouchTime.getTime()<=500&&Rb.getDistance(this._startTouchPoint,g)<=20&&(h?this.network.getSelectionModel().contains(h)||this.network.getSelectionModel().setSelection(h):this.network.getSelectionModel().clearSelection(),Bc.handleClicked(this.network,a,h),this.timer&&clearTimeout(this.timer),this._endTouchTime&&f.getTime()-this._endTouchTime.getTime()<=500&&Rb.getDistance(this._endTouchPoint,g)<=20?(delete this._endTouchTime,delete this._endTouchPoint,Bc.handleDoubleClicked(this.network,a,h)):(this._endTouchTime=f,this._endTouchPoint=g))}},paint:function(a){if(this._startTouchPoint&&this._moveTouchPoint){var b=this.convertPointFromView(this._startTouchPoint),c=this.convertPointFromView(this._moveTouchPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Rb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.network.getSelectOutlineWidth(),j=this.getIntersectMode()?this.network.getSelectFillColor():null;a.strokeStyle=this.network.getSelectOutlineColor(),a.lineWidth=i,Od.rect(a,h.x,h.y,h.width,h.height,j,this.network.getSelectOutlineColor()),a.closePath()}}},getIntersectMode:function(){return"intersect"===this.network.getSelectMode()?!0:"contain"===this.network.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y}}),Gb.canvas.interaction.MSTouchInteraction=function(a){Gb.canvas.interaction.MSTouchInteraction.superClass.constructor.call(this,a),this._pointerMap={},this._pointerIdArray=[]},Hb.ext("twaver.canvas.interaction.MSTouchInteraction",Gb.canvas.interaction.BaseInteraction,{setUp:function(){var a=this.network.getView();Ub.addEventListener("MSPointerDown","handleTouchstart",a,this),Ub.addEventListener("MSPointerMove","handleTouchmove",a,this),Ub.addEventListener("MSPointerUp","handleTouchend",a,this),Ub.addEventListener("MSPointerCancel","handleTouchend",a,this),this.network.addMarker(this)},tearDown:function(){var a=this.network.getView();Ub.removeEventListener("MSPointerDown",a,this),Ub.removeEventListener("MSPointerMove",a,this),Ub.removeEventListener("MSPointerUp",a,this),Ub.removeEventListener("MSPointerCancel",a,this),this.network.removeMarker(this)},handleTouchstart:function(a){if(this.network.isFocusOnClick()&&Gb.Util.setFocus(this.network._view),!this.network.isSelectingElement()||a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.network.getLogicalPoint(a),c=new Date;if(a.isPrimary&&this._pointerIdArray.length>0&&this.handle_mouseup(a),this._pointerMap[a.pointerId]||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length){var d=this.network.getElementAt(b);this._startTouchElement=d,this._startClientPoint={x:a.clientX,y:a.clientY},Bc.handleClicked(this.network,a,d),this._startTouchTime&&this._startTouchPoint&&c.getTime()-this._startTouchTime.getTime()<=500&&Rb.getDistance(this._startTouchPoint,b)<=20?(Bc.handleDoubleClicked(this.network,a,d),this._doubleClick=!0):(Ub.handle_mousedown(this,a),this._startTouchPoint=b,this._startTouchTime=c);var e=this.network.getSelectionModel();d?Hb.isCtrlDown(a)?e.contains(d)?e.removeSelection(d):e.appendSelection(d):e.contains(d)||e.setSelection(d):Hb.isCtrlDown(a)||e.clearSelection()}else 2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.network.getZoom())}},handleTouchmove:function(a){if(null!=this._startTouchPoint&&0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Rb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10)&&(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length)){var b=this._getDistance()/this._distance;this.network.setZoom(this._zoom*b,!1)}},handleTouchend:function(a){if(this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a})),this.network.isSelectingElement()){var b=Rb.getRect([this._startTouchPoint,this._moveTouchPoint]),c=this.network.getElementsAtRect(b,this.getIntersectMode(),this.network.getRectSelectFilter());if(c&&c.size()>0){var d=this.network.getSelectionModel(),e=d.toSelection();c.forEach(function(a){d.contains(a)?e.remove(a):e.add(a)},this),d.setSelection(e)}this.network.fireInteractionEvent({kind:"selectEnd",event:a}),this._moveTouchPoint=null,this.network.setSelectingElement(!1),this.repaint()}this._doubleClick&&(delete this._doubleClick,delete this._startTouchPoint,delete this._startTouchTime);for(var f=-1,g=0;g<this._pointerIdArray.length;g++)if(this._pointerIdArray[g]==a.pointerId){f=g;break}f>=0&&this._pointerIdArray.splice(f,1),delete this._pointerMap[a.pointerId],this._startTouchPoint=null,this._moveTouchPoint=null},_getDistance:function(){return Rb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})},getIntersectMode:function(){return"intersect"===this.network.getSelectMode()?!0:"contain"===this.network.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y},handle_mousemove:function(a){var b={x:a.clientX,y:a.clientY};if(!(Rb.getDistance(this._startClientPoint,b)<3)&&this._startTouchPoint&&1==this._pointerIdArray.length)if(this._moveTouchPoint={x:this._startTouchPoint.x+(b.x-this._startClientPoint.x)/this.network.getZoom(),y:this._startTouchPoint.y+(b.y-this._startClientPoint.y)/this.network.getZoom()},null==this._startTouchElement&&this.network.isRectSelectEnabled()){var c=this.network.getLogicalPoint(a);if(!c)return;this.network.setSelectingElement(!0),this.network.fireInteractionEvent(this._moveTouchPoint?{kind:"selectBetween",event:a}:{kind:"selectStart",event:a}),this.repaint()}else{var d=this.network.getElementAt(this._moveTouchPoint);if(null!=this._startTouchElement||this.network.isRectSelectEnabled()){if(this.network.isMovingElement()||null!=this._startTouchElement&&d==this._startTouchElement&&this.network.getMovableSelectedElements().contains(d)){var e=this._moveTouchPoint.x-this._startTouchPoint.x,f=this._moveTouchPoint.y-this._startTouchPoint.y;this.network.moveSelectedElements(e,f),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a}))}}else{var e=this._startClientPoint.x-b.x,f=this._startClientPoint.y-b.y;this.network.panByOffset(e,f)}this._startClientPoint=b}},handle_mouseup:function(a){this.handleTouchend(a),this._pointerIdArray=[],this._pointerMap={}},paint:function(a){if(this._startTouchPoint&&this._moveTouchPoint&&!this._startTouchElement&&this.network.isRectSelectEnabled()){var b=this.convertPointFromView(this._startTouchPoint),c=this.convertPointFromView(this._moveTouchPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Rb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.network.getSelectOutlineWidth(),j=this.getIntersectMode()?this.network.getSelectFillColor():null;a.strokeStyle=this.network.getSelectOutlineColor(),a.lineWidth=i,Od.rect(a,h.x,h.y,h.width,h.height,j,this.network.getSelectOutlineColor()),a.closePath()}}}});var Pd=function(a,b){Hb.registerImage(a,b),Qd[a]=1},Qd={};Pd("node_image",{w:32,h:24,origin:{x:0,y:0},v:[{shape:"path",data:"M32,23.5c0,0.276-0.224,0.5-0.5,0.5h-31C0.224,24,0,23.776,0,23.5v-2C0,21.224,0.224,21,0.5,21h31  c0.276,0,0.5,0.224,0.5,0.5V23.5z",gradient:{id:"SVGID_1_",type:"linear",x1:"15.9995",y1:"21",x2:"15.9995",y2:"24",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M15,22.3c0-0.165-0.134-0.3-0.3-0.3H3.3C3.134,22,3,22.135,3,22.3V24h12V22.3z",gradient:{id:"SVGID_2_",type:"linear",x1:"9",y1:"22",x2:"9",y2:"25",stop:[{offset:"0",color:"#69B4A5"},{offset:"0.1",color:"#61AD9C"}]}},{shape:"path",data:"M31,20H1V1c0-0.553,0.448-1,1-1h28c0.553,0,1,0.447,1,1V20z",gradient:{id:"SVGID_3_",type:"linear",x1:"15.9995",y1:"-0.1221",x2:"15.9995",y2:"19.9471",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:1,w:28,h:18,fill:"#FFFFFF"},{shape:"rect",x:3,y:2,w:26,h:16,gradient:{id:"SVGID_4_",type:"linear",x1:"15.9995",y1:"2.0654",x2:"15.9995",y2:"17.3835",stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#0089C1"}]}},{shape:"path",data:"9.649,17.034 6.815,17.034 9.935,2.966 12.768,2.966 z",fill:"#FFFFFF"},{shape:"path",data:"12.065,17.034 10.815,17.034 13.935,2.966 15.185,2.966 z",fill:"#FFFFFF"},{shape:"path",data:"14.065,17.034 13.315,17.034 16.435,2.966 17.185,2.966 z",fill:"#FFFFFF"}]}),Pd("group_image",{w:32,h:24,origin:{x:0,y:0},v:[{shape:"path",data:"M32,16.5c0,0.276-0.224,0.5-0.5,0.5h-24C7.224,17,7,16.776,7,16.5v-1C7,15.224,7.224,15,7.5,15h24   c0.276,0,0.5,0.224,0.5,0.5V16.5z",gradient:{id:"SVGID_1_",type:"linear",x1:"19.5",y1:"15",x2:"19.5",y2:"17",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M19,16.5c0-0.277-0.224-0.5-0.5-0.5h-8c-0.276,0-0.5,0.223-0.5,0.5V17h9V16.5z",gradient:{id:"SVGID_2_",type:"linear",x1:"14.4995",y1:"15.9209",x2:"14.4995",y2:"17.0459",stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M31,14H8V1c0-0.553,0.448-1,1-1h21c0.553,0,1,0.447,1,1V14z",gradient:{id:"SVGID_3_",type:"linear",x1:"19.5",y1:"0",x2:"19.5",y2:"14.0005",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:9,y:1,w:21,h:12,fill:"#FFFFFF"},{shape:"rect",x:10,y:2,w:19,h:10,gradient:{id:"SVGID_4_",type:"linear",x1:"19.5",y1:"1.9619",x2:"19.5",y2:"11.9744",stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M25,23.5c0,0.276-0.224,0.5-0.5,0.5h-24C0.224,24,0,23.776,0,23.5v-1C0,22.224,0.224,22,0.5,22h24   c0.276,0,0.5,0.224,0.5,0.5V23.5z",gradient:{id:"SVGID_5_",type:"linear",x1:"12.4995",y1:"22",x2:"12.4995",y2:"24",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M12,23.5c0-0.277-0.224-0.5-0.5-0.5h-8C3.224,23,3,23.223,3,23.5V24h9V23.5z",gradient:{id:"SVGID_6_",type:"linear",x1:"7.5",y1:"22.9209",x2:"7.5",y2:"24.0459",stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M24,21H1V8c0-0.553,0.448-1,1-1h21c0.553,0,1,0.447,1,1V21z",gradient:{id:"SVGID_7_",type:"linear",x1:"12.4995",y1:"7",x2:"12.4995",y2:"21.0005",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:8,w:21,h:12,fill:"#FFFFFF"},{shape:"rect",x:3,y:9,w:19,h:10,gradient:{id:"SVGID_8_",type:"linear",x1:"12.4995",y1:"8.9619",x2:"12.4995",y2:"18.9749",stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#0089C1"}]}}]}),Pd("subnetwork_image",{w:32,h:24,origin:{x:0,y:0},v:[{shape:"path",data:"M32,14.499c0,0.276-0.224,0.5-0.5,0.5h-20c-0.276,0-0.5-0.224-0.5-0.5v-1c0-0.276,0.224-0.5,0.5-0.5  h20c0.276,0,0.5,0.224,0.5,0.5V14.499z",gradient:{id:"SVGID_1_",type:"linear",x1:21.5,y1:12.999,x2:21.5,y2:14.9995,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M22,14.499c0-0.277-0.224-0.5-0.5-0.5h-7c-0.276,0-0.5,0.223-0.5,0.5v0.5h8V14.499z",gradient:{id:"SVGID_2_",type:"linear",x1:18,y1:13.9199,x2:18,y2:15.0449,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M31,11.499c0,0.276-0.224,0.5-0.5,0.5h-18c-0.276,0-0.5-0.224-0.5-0.5v-11c0-0.276,0.224-0.5,0.5-0.5  h18c0.276,0,0.5,0.224,0.5,0.5V11.499z",gradient:{id:"SVGID_3_",type:"linear",x1:21.5,y1:-.9502,x2:21.5,y2:12.5498,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:13,y:.999,w:17,h:10,fill:"#FFFFFF"},{shape:"rect",x:14,y:1.999,w:15,h:8,gradient:{id:"SVGID_4_",type:"linear",x1:21.5,y1:1.9312,x2:21.5,y2:9.6537,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M21,23.5c0,0.276-0.224,0.5-0.5,0.5h-20C0.224,24,0,23.776,0,23.5v-1C0,22.224,0.224,22,0.5,22h20  c0.276,0,0.5,0.224,0.5,0.5V23.5z",gradient:{id:"SVGID_5_",type:"linear",x1:10.4995,y1:22,x2:10.4995,y2:24,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:22,y:20.5,w:3,h:1.999,gradient:{id:"SVGID_6_",type:"linear",x1:-464.9424,y1:-722.2754,x2:-462.9424,y2:-722.2754,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"rect",x:28,y:16,w:2,h:3,gradient:{id:"SVGID_7_",type:"linear",x1:29,y1:16,x2:29,y2:19,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M11,23.5c0-0.277-0.224-0.5-0.5-0.5h-7C3.224,23,3,23.223,3,23.5V24h8V23.5z",gradient:{id:"SVGID_8_",type:"linear",x1:7,y1:22.9209,x2:7,y2:24.0459,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M20,20.5c0,0.276-0.224,0.5-0.5,0.5h-18C1.224,21,1,20.776,1,20.5v-11C1,9.224,1.224,9,1.5,9h18  C19.776,9,20,9.224,20,9.5V20.5z",gradient:{id:"SVGID_9_",type:"linear",x1:10.4995,y1:8.0508,x2:10.4995,y2:21.5513,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:10,w:17,h:10,fill:"#FFFFFF"},{shape:"rect",x:3,y:11,w:15,h:8,gradient:{id:"SVGID_10_",type:"linear",x1:10.4995,y1:10.9321,x2:10.4995,y2:18.6551,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#0089C1"}]}},{shape:"path",data:"M32,22.7c0,0.165-0.135,0.3-0.301,0.3h-5.4C26.134,23,26,22.865,26,22.7v-2.4  c0-0.165,0.134-0.3,0.299-0.3h5.4C31.865,20,32,20.135,32,20.3V22.7z",gradient:{id:"SVGID_11_",type:"linear",x1:29,y1:20,x2:29,y2:23,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}}]}),Pd("bus_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"rect",x:4,y:6,w:1,h:1,fill:"#232424"},{shape:"path",data:"M7,4c0,0.552-0.448,1-1,1H3C2.448,5,2,4.552,2,4V3c0-0.552,0.448-1,1-1h3c0.552,0,1,0.448,1,1V4z",gradient:{id:"SVGID_1_",type:"linear",x1:4.5,y1:2,x2:4.5,y2:5,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:3,y:3,w:3,h:1,fill:"#232424"},{shape:"rect",x:3,y:3,w:3,h:1,fill:"#FFFFFF"},{shape:"path",data:"M6,5.5C6,5.776,5.776,6,5.5,6h-2C3.224,6,3,5.776,3,5.5l0,0C3,5.224,3.224,5,3.5,5h2  C5.776,5,6,5.224,6,5.5L6,5.5z",gradient:{id:"SVGID_2_",type:"linear",x1:4.5,y1:6,x2:4.5,y2:5,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:12,y:6,w:1,h:1,fill:"#232424"},{shape:"path",data:"M15,4c0,0.552-0.447,1-1,1h-3c-0.553,0-1-0.448-1-1V3c0-0.552,0.447-1,1-1h3c0.553,0,1,0.448,1,1V4z",gradient:{id:"SVGID_3_",type:"linear",x1:12.5,y1:2,x2:12.5,y2:5,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:11,y:3,w:3,h:1,fill:"#232424"},{shape:"rect",x:11,y:3,w:3,h:1,fill:"#FFFFFF"},{shape:"path",data:"M14,5.5C14,5.776,13.777,6,13.5,6h-2C11.225,6,11,5.776,11,5.5l0,0C11,5.224,11.225,5,11.5,5h2  C13.777,5,14,5.224,14,5.5L14,5.5z",gradient:{id:"SVGID_4_",type:"linear",x1:12.5,y1:6,x2:12.5,y2:5,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:8,y:10,w:1,h:1,fill:"#232424"},{shape:"path",data:"M6,13c0-0.553,0.448-1,1-1h3c0.553,0,1,0.447,1,1v1c0,0.553-0.447,1-1,1H7c-0.552,0-1-0.447-1-1V13z",gradient:{id:"SVGID_5_",type:"linear",x1:-1428.3853,y1:-571.5747,x2:-1428.3853,y2:-568.5747,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:7,y:13,w:3,h:1,fill:"#232424"},{shape:"rect",x:7,y:13,w:3,h:1,fill:"#FFFFFF"},{shape:"path",data:"M7,11.5C7,11.223,7.224,11,7.5,11h2c0.277,0,0.5,0.223,0.5,0.5l0,0c0,0.275-0.223,0.5-0.5,0.5h-2  C7.224,12,7,11.775,7,11.5L7,11.5z",gradient:{id:"SVGID_6_",type:"linear",x1:-1428.3862,y1:-567.5737,x2:-1428.3862,y2:-568.5737,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M15,7.5C15,7.776,14.777,8,14.5,8h-12C2.224,8,2,7.776,2,7.5l0,0C2,7.224,2.224,7,2.5,7h12  C14.777,7,15,7.224,15,7.5L15,7.5z",gradient:{id:"SVGID_7_",type:"linear",x1:8.4995,y1:6.1152,x2:8.4995,y2:7.5558,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M15,9.5c0,0.275-0.223,0.5-0.5,0.5h-12C2.224,10,2,9.775,2,9.5l0,0C2,9.223,2.224,9,2.5,9h12  C14.777,9,15,9.223,15,9.5L15,9.5z",gradient:{id:"SVGID_8_",type:"linear",x1:8.4995,y1:8.1147,x2:8.4995,y2:9.556,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}}]}),Pd("data_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,12c0,0.553-0.447,1-1,1H7c-0.552,0-1-0.447-1-1V8c0-0.552,0.448-1,1-1h7c0.553,0,1,0.448,1,1V12   z",gradient:{id:"SVGID_1_",type:"linear",x1:10.5,y1:6.959,x2:10.5,y2:12.2259,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:7,y:8,w:7,h:4,fill:"#FFFFFF"},{shape:"rect",x:8,y:9,w:5,h:2,gradient:{id:"SVGID_2_",type:"linear",x1:10.5,y1:8.6997,x2:10.5,y2:11.0333,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M15,14.5c0,0.275-0.225,0.5-0.5,0.5h-8C6.224,15,6,14.775,6,14.5l0,0C6,14.223,6.224,14,6.5,14h8   C14.775,14,15,14.223,15,14.5L15,14.5z",gradient:{id:"SVGID_3_",type:"linear",x1:10.5,y1:13.125,x2:10.5,y2:14.5518,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:8,y:14,w:1,h:1,gradient:{id:"SVGID_4_",type:"linear",x1:8.4995,y1:14.0049,x2:8.4995,y2:14.9471,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M12,4H6c0,0-0.152-0.275-0.5-1C5.021,2,5.021,2,4,2C3.057,2,2,2,2,2C1.448,2,1,2.448,1,3v8  c0,0.553,0.448,1,1,1h3v-1H2V3h2.387l1.024,1.998L12,5v1h1V5C13,4.448,12.553,4,12,4z",gradient:{id:"SVGID_5_",type:"linear",x1:6.9995,y1:2.0527,x2:6.9995,y2:11.4757,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M12,5L5.411,4.998L4.387,3H2v8h3v-0.645V7.254V7c0-0.552,0.448-1,1-1h0.324h3.032H12V5z",gradient:{id:"SVGID_6_",type:"linear",x1:6.9995,y1:2.9902,x2:6.9995,y2:11.0032,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}}]}),Pd("grid_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,14c0,0.553-0.447,1-1,1H3c-0.552,0-1-0.447-1-1V3c0-0.552,0.448-1,1-1h11c0.553,0,1,0.448,1,1V14  z",gradient:{id:"SVGID_1_",type:"linear",x1:8.4995,y1:2.1255,x2:8.4995,y2:14.909,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:3,y:3,w:11,h:11,fill:"#FFFFFF"},{shape:"rect",x:3,y:5,w:11,h:1,gradient:{id:"SVGID_2_",type:"linear",x1:8.4995,y1:3.209,x2:8.4995,y2:13.8043,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:3,y:8,w:11,h:1,gradient:{id:"SVGID_3_",type:"linear",x1:8.4995,y1:3.209,x2:8.4995,y2:13.8043,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:3,y:11,w:11,h:1,gradient:{id:"SVGID_4_",type:"linear",x1:8.4995,y1:3.2095,x2:8.4995,y2:13.8048,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:11,y:3,w:1,h:11,gradient:{id:"SVGID_5_",type:"linear",x1:11.5,y1:3.209,x2:11.5,y2:13.8048,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:8,y:3,w:1,h:11,gradient:{id:"SVGID_6_",type:"linear",x1:8.4995,y1:3.209,x2:8.4995,y2:13.8048,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:5,y:3,w:1,h:11,gradient:{id:"SVGID_7_",type:"linear",x1:5.5,y1:3.209,x2:5.5,y2:13.8048,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}}]}),Pd("databox_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M14.5,6h-12H2v0.5v7C2,13.776,2.224,14,2.5,14h12c0.276,0,0.5-0.224,0.5-0.5v-7V6H14.5z",gradient:{id:"SVGID_1_",type:"linear",x1:8.4995,y1:6.0625,x2:8.4995,y2:14.063,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M14.776,5.553l-1.553-3.105C13.101,2.201,12.775,2,12.5,2h-8C4.225,2,3.899,2.201,3.776,2.447  L2.224,5.553L2,6h0.5h12H15L14.776,5.553z",gradient:{id:"SVGID_2_",type:"linear",x1:8.5005,y1:3.104,x2:8.5005,y2:-5.6467,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"12,2 9.5,2 7.5,2 5,2 3,6 7.5,6 9.5,6 14,6 z",gradient:{id:"SVGID_3_",type:"linear",x1:8.5005,y1:9.2295,x2:8.5005,y2:5.4586,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M11.5,9c0,0.276-0.224,0.5-0.5,0.5H6C5.724,9.5,5.5,9.276,5.5,9l0,0c0-0.276,0.224-0.5,0.5-0.5h5  C11.276,8.5,11.5,8.724,11.5,9L11.5,9z",fill:"#FFFFFF"}]}),Pd("group_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,8.5C15,8.776,14.776,9,14.5,9h-10C4.224,9,4,8.776,4,8.5v-7C4,1.224,4.224,1,4.5,1h10    C14.776,1,15,1.224,15,1.5V8.5z",gradient:{id:"SVGID_1_",type:"linear",x1:9.5,y1:.9512,x2:9.5,y2:8.9787,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:5,y:2,w:9,h:6,fill:"#FFFFFF"},{shape:"rect",x:6,y:3,w:7,h:4,gradient:{id:"SVGID_2_",type:"linear",x1:9.5,y1:3.02,x2:9.5,y2:6.9606,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M16,10.5c0,0.276-0.224,0.5-0.5,0.5h-12C3.224,11,3,10.776,3,10.5l0,0C3,10.224,3.224,10,3.5,10h12    C15.776,10,16,10.224,16,10.5L16,10.5z",gradient:{id:"SVGID_3_",type:"linear",x1:9.5,y1:9.9941,x2:9.5,y2:10.9976,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:6,y:10.001,w:2,h:.999,gradient:{id:"SVGID_4_",type:"linear",x1:7,y1:10.0059,x2:7,y2:10.9472,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M12,12.5c0,0.276-0.224,0.5-0.5,0.5h-10C1.224,13,1,12.776,1,12.5v-7C1,5.224,1.224,5,1.5,5h10    C11.776,5,12,5.224,12,5.5V12.5z",gradient:{id:"SVGID_5_",type:"linear",x1:6.4995,y1:4.9512,x2:6.4995,y2:12.9792,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:6,w:9,h:6,fill:"#FFFFFF"},{shape:"rect",x:3,y:7,w:7,h:4,gradient:{id:"SVGID_6_",type:"linear",x1:6.4995,y1:7.02,x2:6.4995,y2:10.9611,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M13,14.5c0,0.276-0.224,0.5-0.5,0.5h-12C0.224,15,0,14.776,0,14.5l0,0C0,14.224,0.224,14,0.5,14h12    C12.776,14,13,14.224,13,14.5L13,14.5z",gradient:{id:"SVGID_7_",type:"linear",x1:6.4995,y1:13.9941,x2:6.4995,y2:14.9976,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:3,y:14.001,w:2,h:.999,gradient:{id:"SVGID_8_",type:"linear",x1:4,y1:14.0059,x2:4,y2:14.9472,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}}]}),Pd("link_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"line",p1:{x:2.5,y:2.5},p2:{x:13.5,y:13.5},lineColor:"url(#SVGID_1_)",lineWidth:1},{shape:"ellipse",cx:13,cy:13,rx:2,ry:2,gradient:{id:"SVGID_2_",type:"linear",x1:11.5371,y1:11.5371,x2:14.2155,y2:14.2155,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:13,cy:13,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:3,cy:3,rx:2,ry:2,gradient:{id:"SVGID_3_",type:"linear",x1:1.4956,y1:1.4956,x2:4.1473,y2:4.1473,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:3,cy:3,rx:1,ry:1,fill:"#FFFFFF"}]}),Pd("linksubnetwork_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",
data:"M15,7.661c0-1.202-0.642-2.247-1.596-2.835C12.848,3.188,11.314,2,9.486,2  c-1.587,0-2.95,0.902-3.649,2.211C4.573,4.22,3.548,5.194,3.438,6.432C3.389,6.429,3.342,6.417,3.292,6.417  C2.026,6.417,1,7.443,1,8.708C1,9.975,2.026,11,3.292,11h8.371l0,0C13.506,11,15,9.506,15,7.661z",gradient:{id:"SVGID_1_",type:"linear",x1:7.9995,y1:1.959,x2:7.9995,y2:11.0921,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M3.292,10C2.58,10,2,9.42,2,8.708c0-0.712,0.58-1.292,1.292-1.292C3.286,7.422,3.332,7.427,3.379,7.43  l0.969,0.058L4.435,6.52C4.5,5.779,5.106,5.216,5.844,5.211l0.595-0.004l0.28-0.524C7.273,3.645,8.334,3,9.486,3  c1.342,0,2.535,0.863,2.971,2.147l0.116,0.341l0.307,0.189C13.581,6.11,14,6.851,14,7.661C14,8.951,12.951,10,11.661,10H3.292z",fill:"#FFFFFF"},{shape:"path",data:"M3.292,10h8.37c1.11,0,2.04-0.781,2.276-1.821c-0.131-0.615-0.5-1.158-1.058-1.501l-0.307-0.189  l-0.116-0.341C12.021,4.863,10.828,4,9.486,4C8.334,4,7.273,4.645,6.719,5.682l-0.28,0.524L5.844,6.211  C5.106,6.216,4.5,6.779,4.435,7.52L4.349,8.487L3.379,8.43C3.332,8.427,3.286,8.422,3.292,8.417c-0.535,0-0.994,0.328-1.19,0.792  C2.297,9.672,2.757,10,3.292,10z",gradient:{id:"SVGID_2_",type:"linear",x1:8.019,y1:4.084,x2:8.019,y2:9.8062,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"line",p1:{x:8.01,y:8.01},p2:{x:13.186,y:13.186},lineColor:"url(#SVGID_3_)",lineWidth:1},{shape:"ellipse",cx:8,cy:8,rx:2,ry:2,gradient:{id:"SVGID_4_",type:"linear",x1:6.7881,y1:6.7881,x2:9.9924,y2:9.9924,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:8,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:13,cy:13,rx:2,ry:2,gradient:{id:"SVGID_5_",type:"linear",x1:11.5791,y1:11.5791,x2:14.3132,y2:14.3132,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:13,cy:13,rx:1,ry:1,fill:"#FFFFFF"}]}),Pd("node_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,11.5c0,0.276-0.224,0.5-0.5,0.5h-13C1.224,12,1,11.776,1,11.5v-9C1,2.224,1.224,2,1.5,2h13  C14.776,2,15,2.224,15,2.5V11.5z",gradient:{id:"SVGID_1_",type:"linear",x1:7.9995,y1:1.939,x2:7.9995,y2:11.9739,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:3,w:12,h:8,fill:"#FFFFFF"},{shape:"rect",x:3,y:4,w:10,h:6,gradient:{id:"SVGID_2_",type:"linear",x1:7.9995,y1:4.0513,x2:7.9995,y2:9.865,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M16,14.5c0,0.276-0.224,0.5-0.5,0.5h-15C0.224,15,0,14.776,0,14.5v-1C0,13.224,0.224,13,0.5,13h15  c0.276,0,0.5,0.224,0.5,0.5V14.5z",gradient:{id:"SVGID_3_",type:"linear",x1:7.9995,y1:13.0508,x2:7.9995,y2:14.9258,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M9,14.5C9,14.224,8.776,14,8.5,14h-5C3.224,14,3,14.224,3,14.5V15h6V14.5z",gradient:{id:"SVGID_4_",type:"linear",x1:5.9995,y1:14.0508,x2:5.9995,y2:15.9258,stop:[{offset:"0",color:"#69B4A5"},{offset:"0.1",color:"#61AD9C"},{offset:"0.4637",color:"#449981"},{offset:"0.7764",color:"#2C8E73"},{offset:"1",color:"#218A6E"}]}}]}),Pd("shapelink_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"line",p1:{x:7.5,y:2.5},p2:{x:2.5,y:7.5},lineColor:"url(#SVGID_1_)",lineWidth:1},{shape:"line",p1:{x:2.5,y:7.5},p2:{x:8.5,y:13.5},lineColor:"url(#SVGID_2_)",lineWidth:1},{shape:"line",p1:{x:9,y:13.186},p2:{x:13.5,y:6.5},lineColor:"url(#SVGID_3_)",lineWidth:1},{shape:"ellipse",cx:7,cy:3,rx:2,ry:2,gradient:{id:"SVGID_4_",type:"linear",x1:5.5864,y1:1.5864,x2:8.4149,y2:4.4149,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:7,cy:3,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:2,cy:8,rx:2,ry:2,gradient:{id:"SVGID_5_",type:"linear",x1:.5864,y1:6.5864,x2:3.4142,y2:9.4142,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:2,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:8,cy:13,rx:2,ry:2,gradient:{id:"SVGID_6_",type:"linear",x1:6.5869,y1:11.5869,x2:9.4147,y2:14.4147,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:8,cy:13,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:13,cy:7,rx:2,ry:2,gradient:{id:"SVGID_7_",type:"linear",x1:11.5859,y1:5.5859,x2:14.4144,y2:8.4144,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:13,cy:7,rx:1,ry:1,fill:"#FFFFFF"}]}),Pd("shapenode_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M14.5,3h-9l-4,4v7h13L9,8.5L14.5,3z M12.086,13H2.5V7.414L5.914,4h6.172l-4.5,4.5L12.086,13z",gradient:{id:"SVGID_1_",type:"linear",x1:7.9995,y1:3.209,x2:7.9995,y2:13.6621,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:6,cy:3,rx:2,ry:2,gradient:{id:"SVGID_2_",type:"linear",x1:4.5859,y1:1.5859,x2:7.4151,y2:4.4151,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:6,cy:3,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:13,cy:3,rx:2,ry:2,gradient:{id:"SVGID_3_",type:"linear",x1:11.5869,y1:1.5864,x2:14.4153,y2:4.4149,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:13,cy:3,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:9,cy:8,rx:2,ry:2,gradient:{id:"SVGID_4_",type:"linear",x1:7.5864,y1:6.5864,x2:10.4149,y2:9.4149,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:9,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:2,cy:7,rx:2,ry:2,gradient:{id:"SVGID_5_",type:"linear",x1:.5859,y1:5.5859,x2:3.4144,y2:8.4144,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:2,cy:7,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:12.825,cy:13,rx:2,ry:2,gradient:{id:"SVGID_6_",type:"linear",x1:11.4111,y1:11.5869,x2:14.2396,y2:14.4153,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:12.825,cy:13,rx:1,ry:1,fill:"#FFFFFF"}]}),Pd("shapesubnetwork_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,6.661c0-1.202-0.642-2.247-1.596-2.835C12.848,2.188,11.314,1,9.486,1  c-1.587,0-2.95,0.902-3.649,2.211C4.573,3.22,3.548,4.194,3.438,5.432C3.389,5.429,3.342,5.417,3.292,5.417  C2.026,5.417,1,6.443,1,7.708S2.026,10,3.292,10h8.371l0,0C13.506,10,15,8.505,15,6.661z",gradient:{id:"SVGID_1_",type:"linear",x1:7.9995,y1:1.3755,x2:7.9995,y2:9.733,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M3.292,9C2.58,9,2,8.42,2,7.708s0.58-1.292,1.292-1.292C3.286,6.422,3.332,6.427,3.379,6.43l0.969,0.058  L4.435,5.52C4.5,4.779,5.106,4.216,5.844,4.211l0.595-0.004l0.28-0.524C7.273,2.645,8.334,2,9.486,2  c1.342,0,2.535,0.863,2.971,2.147l0.116,0.341l0.307,0.189C13.581,5.11,14,5.851,14,6.661C14,7.951,12.951,9,11.661,9H3.292z",fill:"#FFFFFF"},{shape:"path",data:"M3.272,9h8.37c1.11,0,2.039-0.689,2.275-1.729c-0.131-0.615-0.499-1.249-1.057-1.593l-0.307-0.189  l-0.116-0.341C12.002,3.863,10.809,3,9.468,3C8.314,3,7.254,3.645,6.7,4.682L6.42,5.207L5.825,5.211  C5.087,5.216,4.481,5.779,4.416,6.52L4.33,7.487L3.36,7.43C3.313,7.427,3.267,7.422,3.272,7.417c-0.535,0-0.994,0.327-1.19,0.792  C2.278,8.672,2.738,9,3.272,9z",gradient:{id:"SVGID_2_",type:"linear",x1:7.9995,y1:3.459,x2:7.9995,y2:8.4597,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M11.516,7.102h-8l2.469,6h8.5L11.516,7.102z M5.024,8.123h5.905l1.938,3.979H6.662L5.024,8.123z",gradient:{id:"SVGID_3_",type:"linear",x1:7.4443,y1:7.1724,x2:10.1111,y2:12.8383,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"5,8.112 10.904,8.112 12.842,12.092 6.638,12.092 z",fill:"#FFFFFF"},{shape:"ellipse",cx:5,cy:8,rx:2,ry:2,gradient:{id:"SVGID_4_",type:"linear",x1:3,y1:8,x2:7,y2:8,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:5,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:12,cy:8,rx:2,ry:2,gradient:{id:"SVGID_5_",type:"linear",x1:10,y1:8,x2:14,y2:8,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:12,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:7,cy:12,rx:2,ry:2,gradient:{id:"SVGID_6_",type:"linear",x1:5,y1:12,x2:9,y2:12,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:7,cy:12,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:14,cy:12,rx:2,ry:2,gradient:{id:"SVGID_7_",type:"linear",x1:12,y1:12,x2:16,y2:12,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:14,cy:12,rx:1,ry:1,fill:"#FFFFFF"}]}),Pd("subnetwork_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"rect",x:10,y:14.001,w:2,h:1,gradient:{id:"SVGID_1_",type:"linear",x1:11,y1:14.0059,x2:11,y2:14.9481,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"rect",x:14,y:10.001,w:1,h:2,gradient:{id:"SVGID_2_",type:"linear",x1:14.5,y1:10.0117,x2:14.5,y2:11.8962,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M16,6.001c0,0.552-0.447,1-1,1H8c-0.552,0-1-0.448-1-1v-4c0-0.552,0.448-1,1-1h7   c0.553,0,1,0.448,1,1V6.001z",gradient:{id:"SVGID_3_",type:"linear",x1:11.5,y1:.96,x2:11.5,y2:6.2265,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:8,y:2.001,w:7,h:4,fill:"#FFFFFF"},{shape:"rect",x:9,y:3.001,w:5,h:2,gradient:{id:"SVGID_4_",type:"linear",x1:11.5,y1:2.7007,x2:11.5,y2:5.0337,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M16,8.501c0,0.276-0.225,0.5-0.5,0.5h-8c-0.276,0-0.5-0.224-0.5-0.5l0,0c0-0.276,0.224-0.5,0.5-0.5   h8C15.775,8.001,16,8.225,16,8.501L16,8.501z",gradient:{id:"SVGID_5_",type:"linear",x1:11.5,y1:7.126,x2:11.5,y2:8.5535,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:9,y:8.001,w:1,h:.999,gradient:{id:"SVGID_6_",type:"linear",x1:9.5,y1:8.0063,x2:9.5,y2:8.9477,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M9,12c0,0.553-0.447,1-1,1H1c-0.552,0-1-0.447-1-1V8c0-0.552,0.448-1,1-1h7c0.553,0,1,0.448,1,1V12z   ",gradient:{id:"SVGID_7_",type:"linear",x1:4.4995,y1:6.959,x2:4.4995,y2:12.2259,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:1,y:8,w:7,h:4,fill:"#FFFFFF"},{shape:"rect",x:2,y:9,w:5,h:2,gradient:{id:"SVGID_8_",type:"linear",x1:4.5,y1:8.6997,x2:4.5,y2:11.0333,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M9,14.5C9,14.776,8.775,15,8.5,15h-8C0.224,15,0,14.776,0,14.5l0,0C0,14.224,0.224,14,0.5,14h8   C8.775,14,9,14.224,9,14.5L9,14.5z",gradient:{id:"SVGID_9_",type:"linear",x1:4.4995,y1:13.125,x2:4.4995,y2:14.5518,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:14,w:1,h:1,gradient:{id:"SVGID_10_",type:"linear",x1:2.5,y1:14.0049,x2:2.5,y2:14.9471,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M16,14.501c0,0.276-0.224,0.5-0.5,0.5h-2c-0.276,0-0.5-0.224-0.5-0.5v-1c0-0.276,0.224-0.5,0.5-0.5  h2c0.276,0,0.5,0.224,0.5,0.5V14.501z",gradient:{id:"SVGID_11_",type:"linear",x1:14.5,y1:13.0117,x2:14.5,y2:14.8962,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}}]});var Od={_hitCanvas:null,getHitCanvas:function(a,b){null==this._hitCanvas&&(this._hitCanvas=Ub.createCanvas()),0==arguments.length&&(a=2,b=2),this._hitCanvas.setAttribute("width",""+a-1),this._hitCanvas.setAttribute("height",""+b-1),this._hitCanvas.setAttribute("width",""+a),this._hitCanvas.setAttribute("height",""+b);var c=this.getCtx(this._hitCanvas);return c.clearRect(0,0,a,b),this._hitCanvas},disposeHitCanvas:function(){this._hitCanvas=null},getCtx:function(a){return a.getContext("2d")},render:function(a,b,c){void 0!=b&&(a.fillStyle=b,a.fill()),void 0!=c&&(a.strokeStyle=c,a.stroke())},text:function(a,b,c,d,e,f){a.textAlign="center",a.textBaseline="middle",null!=e&&(a.fillStyle=e,a.fillText(b,c,d)),f&&(a.strokeStyle=f,a.strokeText(b,c,d))},circle:function(a,b,c,d,e,f){a.arc(b,c,d,0,2*Math.PI,!0),a.closePath(),this.render(a,e,f)},rect:function(a,b,c,d,e,f,g){a.rect(b,c,d,e),a.closePath(),this.render(a,f,g)},OUT_LEFT:1,OUT_TOP:2,OUT_RIGHT:4,OUT_BOTTOM:8,outcode:function(a,b,c,d,e,f){var g=0;return 0>=e?g|=this.OUT_LEFT|this.OUT_RIGHT:c>a?g|=this.OUT_LEFT:a>c+e&&(g|=this.OUT_RIGHT),0>=f?g|=this.OUT_TOP|this.OUT_BOTTOM:d>b?g|=this.OUT_TOP:b>d+f&&(g|=this.OUT_BOTTOM),g},intersectsLine:function(a,b,c,d,e,f,g,h){var i,j;if(0==(j=this.outcode(c,d,e,f,g,h)))return!0;for(;0!=(i=this.outcode(a,b,e,f,g,h));){if(0!=(i&j))return!1;if(0!=(i&(this.OUT_LEFT|this.OUT_RIGHT))){var k=e;0!=(i&this.OUT_RIGHT)&&(k+=g),b+=(k-a)*(d-b)/(c-a),a=k}else{var l=f;0!=(i&this.OUT_BOTTOM)&&(l+=h),a+=(l-b)*(c-a)/(d-b),b=l}}return!0}};Gb.vector={},Gb.vector.interaction={},Gb.vector.Network=function(a){Gb.vector.Network.superClass.constructor.apply(this,arguments),this.zoomManager=new Gb.vector.PhysicalZoomManager(this),this._view=Ub.createView("hidden"),this._rootCanvas=Ub.createCanvas(),this._topCanvas=Ub.createCanvas(),this._view.appendChild(this._rootCanvas),this._view.appendChild(this._topCanvas),this.realWidth=0,this.realHeight=0,this._unionBounds={x:0,y:0,width:0,height:0},this._zoom=1,this._elementUIMap={},this._zoomMap={},this._viewRectMap={},this.viewRect={x:0,y:0,width:0,height:0},this.state={zooming:!1,panning:!1,autoLayout:!1},this.hScrollBarVisible=!1,this.vScrollBarVisible=!1,this.markerList=new Gb.List,this._topAttachmentList=new Gb.List,this._hitTestTopAttachmentList=new Gb.List,this.setElementBox(a?a:new Gb.ElementBox),Ob.isTouchable?Ob.isMSTouchable?this.setDefaultInteractions(!1,!1):this.setTouchInteractions():this.setDefaultInteractions(!1,!1);var b=this;this._flowLink=function(){if(!(b.isMovingElement()||b.isSelectingElement()||b.isEditingElement()||b._box._layoutMovingElements)){b._flowLinkQuickFinder||(b._flowLinkQuickFinder=new Gb.QuickFinder(b._box,"link.flow","style"));var a=b._flowLinkQuickFinder.find(!0);a.forEach(function(a){a._styleMap["link.flow.offset"]=b.getLinkFlowOffset(a),b.invalidateElementUI(a)})}},this.setToolTipEnabled(Gb.Defaults.NETWORK_TOOLTIP_ENABLED),this._paintAll=!0,this._dirtyRects=new md,this._invalidateMap={},this._invalidateAll=!0,b._count=0,b._invalidate=!0,function c(a){b._loopId=requestAnimationFrame(c),b._invalidate&&(b._count++,b._now=a,b.validate())}(0),Gb.imageUtil.addEventListener(this.invalidateElementUIs,this),Ub.addEventListener("mousemove","handle_mousemove",this._view,this)},Hb.ext("twaver.vector.Network",Gb.controls.View,{__accessor:["selectMode","makeVisibleOnSelected","movableFunction","editPointSize","editPointFillColor","scrollBarWidth","editPointOutlineWidth","editPointOutlineColor","editLineColor","editLineWidth","resizePointSize","resizePointFillColor","resizePointOutlineWidth","resizePointOutlineColor","resizeLineColor","resizeLineWidth","rotatePointSize","rotatePointFillColor","rotatePointOffset","rotatePointOutlineWidth","rotatePointOutlineColor","rotateScaleFillColor","rotateScaleFontColor","rotateScaleWidth","rotateScaleHeight","selectOutlineColor","selectOutlineWidth","selectFillColor","lazyMoveOutlineColor","lazyMoveOutlineWidth","lazyMoveFillColor","rectSelectFilter","selectionTolerance"],__bool:["doubleClickToUpSubNetwork","doubleClickToSubNetwork","doubleClickToEmptySubNetwork","doubleClickToLinkBundle","doubleClickToGroupExpand","scrollBarVisible","limitViewInCanvas","autoValidateCanvasSize","subNetworkAnimate","lazyMoveAnimate","resizeAnimate","noAgentLinkVisible","keyboardRemoveEnabled","keyboardSelectEnabled","sendToTopOnSelected","lazyMoveFill","editingElement","rotatingElement","movingElement","selectingElement","rectSelectEnabled","limitElementInPositiveLocation","showRotateScale","transparentSelectionEnable","edgeDetect","dragToPan","wheelToZoom","asyncZoomAndViewRect","debug","zoomDivVisible","showShadowInEdit","showAttachOnChg"],_currentSubNetwork:null,_subNetworkAnimate:Gb.Defaults.NETWORK_SUBNETWORK_ANIMATE,_scrollBarWidth:10,_scrollBarVisible:!0,_limitViewInCanvas:!1,_autoValidateCanvasSize:!0,_makeVisibleOnSelected:Gb.Defaults.NETWORK_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Gb.Defaults.NETWORK_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Gb.Defaults.NETWORK_KEYBOARD_SELECT_ENABLED,_rectSelectEnabled:Dd.NETWORK_RECT_SELECT_ENABLED,_rectSelectFilter:null,_elementUIFunction:Gb.Defaults.VECTORUI_FUNCTION,_doubleClickToUpSubNetwork:Gb.Defaults.NETWORK_DOUBLECLICK_TO_UPSUBNETWORK,_doubleClickToSubNetwork:Gb.Defaults.NETWORK_DOUBLECLICK_TO_SUBNETWORK,_doubleClickToEmptySubNetwork:Gb.Defaults.NETWORK_DOUBLECLICK_TO_EMPTYSUBNETWORK,_doubleClickToLinkBundle:Gb.Defaults.NETWORK_DOUBLECLICK_TO_LINKBUNDLE,_doubleClickToGroupExpand:Gb.Defaults.NETWORK_DOUBLECLICK_TO_GROUPEXPAND,_selectOutlineColor:Gb.Defaults.NETWORK_SELECT_OUTLINE_COLOR,_selectOutlineWidth:Gb.Defaults.NETWORK_SELECT_OUTLINE_WIDTH,_selectFillColor:Gb.Defaults.NETWORK_SELECT_FILL_COLOR,_sendToTopOnSelected:Gb.Defaults.NETWORK_SENDTOTOP_ON_SELECTED,_lazyMoveOutlineColor:Gb.Defaults.NETWORK_LAZYMOVE_OUTLINE_COLOR,_lazyMoveOutlineWidth:Gb.Defaults.NETWORK_LAZYMOVE_OUTLINE_WIDTH,_lazyMoveFillColor:Gb.Defaults.NETWORK_LAZYMOVE_FILL_COLOR,_lazyMoveFill:Gb.Defaults.NETWORK_LAZYMOVE_FILL,_lazyMoveAnimate:Gb.Defaults.NETWORK_LAZYMOVE_ANIMATE,_resizePointSize:Gb.Defaults.NETWORK_RESIZE_POINT_SIZE,_resizePointFillColor:Gb.Defaults.NETWORK_RESIZE_POINT_FILL_COLOR,_resizePointOutlineColor:Gb.Defaults.NETWORK_RESIZE_POINT_OUTLINE_COLOR,_resizePointOutlineWidth:Gb.Defaults.NETWORK_RESIZE_POINT_OUTLINE_WIDTH,_resizeLineColor:Gb.Defaults.NETWORK_RESIZE_LINE_COLOR,_resizeLineWidth:Gb.Defaults.NETWORK_RESIZE_LINE_WIDTH,_resizeAnimate:Gb.Defaults.NETWORK_RESIZE_ANIMATE,_rotatePointSize:Gb.Defaults.NETWORK_ROTATE_POINT_SIZE,_rotatePointFillColor:Gb.Defaults.NETWORK_ROTATE_POINT_FILL_COLOR,_rotatePointOffset:Gb.Defaults.NETWORK_ROTATE_POINT_OFFSET,_rotatePointOutlineWidth:Gb.Defaults.NETWORK_ROTATE_POINT_OUTLINE_WIDTH,_rotatePointOutlineColor:Gb.Defaults.NETWORK_ROTATE_POINT_OUTLINE_COLOR,_rotateScaleWidth:Dd.NETWORK_ROTATE_SCALE_WIDTH,_rotateScaleHeight:Dd.NETWORK_ROTATE_SCALE_HEIGHT,_rotateScaleFillColor:Dd.NETWORK_ROTATE_SCALE_FILL_COLOR,_rotateScaleFontColor:Dd.NETWORK_ROTATE_SCALE_FONT_COLOR,_editPointSize:Gb.Defaults.NETWORK_EDIT_POINT_SIZE,_editPointFillColor:Gb.Defaults.NETWORK_EDIT_POINT_FILL_COLOR,_editPointOutlineColor:Gb.Defaults.NETWORK_EDIT_POINT_OUTLINE_COLOR,_editPointOutlineWidth:Gb.Defaults.NETWORK_EDIT_POINT_OUTLINE_WIDTH,_editLineColor:Gb.Defaults.NETWORK_EDIT_LINE_COLOR,_editLineWidth:Gb.Defaults.NETWORK_EDIT_LINE_WIDTH,_limitElementInPositiveLocation:!1,_linkFlowInterval:Dd.NETWORK_LINK_FLOW_INTERVAL,_selectionTolerance:Dd.NETWORK_SELECTION_TOLERANCE,_invalidateViewRectFlag:!1,_repaintTopFlag:!1,_invalidateCanvasSizeFlag:!1,_isEditingElement:!1,_isRotatingElement:!1,_isMovingElement:!1,_isSelectingElement:!1,_hasEditInteraction:!1,_showRotateScale:!0,_transparentSelectionEnable:Gb.Defaults.NETWORK_TRANSPARENT_SELECTION_ENABLE,_edgeDetect:!1,_dragToPan:!0,_wheelToZoom:!0,_asyncZoomAndViewRect:!1,_debug:!1,_zoomDivVisible:!0,_showShadowInEdit:!1,_showAttachOnChg:!0,adjustBounds:function(a){var b=!1,c=this._view.style;if(c.left==a.x+"px"&&c.top==a.y+"px"&&c.width==a.width+"px"&&c.height==a.height+"px"&&(b=!0),Gb.vector.Network.superClass.adjustBounds.apply(this,arguments),1!=b){var d=a.width,e=a.height;this._rootCanvas.setAttribute("width",d),this._rootCanvas.setAttribute("height",e),this._topCanvas.setAttribute("width",d),this._topCanvas.setAttribute("height",e),this.setViewRect(this.viewRect.x,this.viewRect.y,d,e),"undefined"==typeof Gb.gis&&(Gb.Util.makeHighRes(this._rootCanvas),Gb.Util.makeHighRes(this._topCanvas)),this.invalidateElementVisibility()}},getLabel:function(a){return a.getStyle("network.label")||a.getName()},getLabel2:function(a){return a.getStyle("network.label")||a.getName2()},setZoomManager:function(a){var b=this.zoomManager;b!=a&&(this.zoomManager=a,this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.validateCanvasSize(),this.invalidateElementUIs(),this.firePropertyChange("zoomManager",b,a))},getZoomManager:function(){return this.zoomManager},getRootCanvas:function(){return this._rootCanvas},getTopCanvas:function(){return this._topCanvas},validateImpl:function(){mc.twm(this);var a,b,c,d,e=this.getElementBox().getDatas()._as,f=e.length,g={},h=this._visibleFunction,i=1===this._box._layerBox.size()?this._box._layerBox._defaultLayer:null;for(a=0;f>a;a++)c=e[a],g[c._id]=this.isVisible(c,h,i);var j=this.getGraphicsZoom(),k=null,l={x:this.viewRect.x/j,y:this.viewRect.y/j,width:this.viewRect.width/j,height:this.viewRect.height/j};if(this._invalidateAll){if(this._visibleMap)for(a=0;f>a;a++)c=e[a],g[c._id]!==this._visibleMap[c._id]&&(d=this._elementUIMap[c._id],d&&d.invalidate());for(a=0;f>a;a++)c=e[a],d=this._elementUIMap[c._id],d&&d.validate();this._paintAll=!0}else if(this._paintAll){for(b in this._invalidateMap)d=this._elementUIMap[b],d&&d.invalidate();for(b in this._invalidateMap)d=this._elementUIMap[b],d&&d.validate()}else{for(b in this._invalidateMap)d=this._elementUIMap[b],d&&(this._dirtyRects.add(d.getZoomViewRect(!1)),d.invalidate());for(b in this._invalidateMap)d=this._elementUIMap[b],d&&(d.validate(),this._dirtyRects.add(d.getZoomViewRect(!0)))}this._paintAll?k=l:(this._dirtyRects.forEach(function(a){k=null==k?Hb.cloneRect(a):Rb.unionRect(k,a)}),k?(Rb.grow(k,2,2),k=Rb.intersection(k,l)):k=l),this._visibleMap=g,k&&this.paintRoot(k),this.validateCanvasSize(),1==this._repaintTopFlag&&(this._repaintTopFlag=!1,this.paintTopCanvas())},isLinkFlowEnabled:function(){return this._linkFlowEnabled?!0:!1},setLinkFlowEnabled:function(a){a?(this._linkFlowEnabled||(this._linkFlowEnabled=!0,this.firePropertyChange("linkFlowEnabled",!1,!0)),clearInterval(this._linkFlowTimerId),this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval)):(this._linkFlowEnabled&&(this._linkFlowEnabled=!1,this.firePropertyChange("linkFlowEnabled",!0,!1)),clearInterval(this._linkFlowTimerId),delete this._linkFlowTimerId)},getLinkFlowInterval:function(){return this._linkFlowInterval},setLinkFlowInterval:function(a){var b=this._linkFlowInterval;this._linkFlowInterval=a,this.firePropertyChange("linkFlowInterval",b,a),clearInterval(this._linkFlowTimerId),this.isLinkFlowEnabled()&&(this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval))},getElementBox:function(){return this._box},setElementBox:function(a){if(!a)throw"ElementBox can not be null";if(this._box!==a){var b=this._box;b&&(b.removeDataBoxChangeListener(this.handleElementBoxChange,this),b.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),b.removePropertyChangeListener(this.handleElementBoxPropertyChange,this),b.removeIndexChangeListener(this.handleIndexChange,this),b.getLayerBox().removeDataBoxChangeListener(this.handleLayerBoxChange,this),b.getLayerBox().removeDataPropertyChangeListener(this.handleLayerPropertyChange,this),b.getLayerBox().removeHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._selectionModel||b.getSelectionModel().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addDataBoxChangeListener(this.handleElementBoxChange,this),this._box.addDataPropertyChangeListener(this.handleElementPropertyChange,this),this._box.addPropertyChangeListener(this.handleElementBoxPropertyChange,this),this._box.addIndexChangeListener(this.handleIndexChange,this),this._box.getLayerBox().addDataBoxChangeListener(this.handleLayerBoxChange,this),this._box.getLayerBox().addDataPropertyChangeListener(this.handleLayerPropertyChange,this),this._box.getLayerBox().addHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._flowLinkQuickFinder&&(this._flowLinkQuickFinder.dispose(),this._flowLinkQuickFinder=new Gb.QuickFinder(this._box,"link.flow","style")),this._selectionModel?this._selectionModel._setDataBox(a):this._box.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this._elementUIMap={},this._box.forEach(this.createElementUI,this),this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.firePropertyChange("elementBox",b,this._box)}},handleElementBoxChange:function(a){var b=a.data;if("add"===a.kind)this.createElementUI(b),this.invalidateBundleLink(b);else if("remove"===a.kind){var c=this.getElementUI(b);c&&(this._dirtyRects.add(c.getZoomViewRect()),c.dispose(),delete this._elementUIMap[b.getId()]),b===this._currentSubNetwork&&null!=this._currentSubNetwork&&this._setCurrentSubNetwork(null),delete this._invalidateMap[b._id]}else if("clear"===a.kind){for(var d in this._elementUIMap)this._elementUIMap[d]&&this._elementUIMap[d].dispose&&this._elementUIMap[d].dispose();this._elementUIMap={},null!=this._currentSubNetwork&&this._setCurrentSubNetwork(null),this._paintAll=!0}else"layoutEnd"===a.kind?this.state.layouting=!1:"layouting"===a.kind&&(this.state.layouting=!0);this.invalidateElementVisibility(),this.invalidateCanvasSize()},handleElementPropertyChange:function(a){var b=a.source,c=this.getElementUI(b);c&&(this.invalidateElementUI(b),c.handlePropertyChange(a)),this.invalidateBundleLink(b),this.invalidateElementVisibility(),this.invalidateCanvasSize()},handleElementBoxPropertyChange:function(){this.invalidateElementVisibility()},handleIndexChange:function(a){this.invalidateElementVisibility()},handleLayerBoxChange:function(){this.invalidateElementVisibility()},handleLayerPropertyChange:function(a){"editable"===a.property&&this.invalidateSelectedElementUIs(!0),this.invalidateElementVisibility()},handleLayerHierarchyChange:function(){this.invalidateElementVisibility()},handleSelectionChange:function(a){var b=this.getSelectionModel().getLastData();b&&("append"===a.kind||"set"===a.kind)&&(this.isMakeVisibleOnSelected()&&this.makeVisible(b),this.isSendToTopOnSelected()&&this.sendToTop(b)),a.datas.forEach(function(b){var c=this.getElementUI(b);c&&c.handleSelectionChange(a),this.invalidateElementUI(b)},this),this.invalidateElementVisibility()},sendToTop:function(a){if(this._box.contains(a)){for(var b=a;b._parent&&this.isVisible(b._parent)&&(b=b._parent););b!==a&&this._box.adjustElementIndex(b),this._box.adjustElementIndex(a)}},getScopeRect:function(a){{var b=this.getGraphicsZoom();this.zoomManager}if("viewsize"===a)return{x:this._unionBounds.x-this.viewRect.x,y:this._unionBounds.y-this.viewRect.y,width:this._unionBounds.width,height:this._unionBounds.height};if("viewport"===a){if(this.viewRect)return Hb.cloneRect(this.viewRect)}else if("rootcanvas"===a)return{x:this.viewRect.x,y:this.viewRect.y,width:(Math.abs(this.viewRect.x-this._unionBounds.x)+this._unionBounds.width)*b,height:(Math.abs(this.viewRect.y-this._unionBounds.y)+this._unionBounds.height)*b};return{x:0,y:0,width:0,height:0}},getViewRect:function(){return this.viewRect?Hb.cloneRect(this.viewRect):{x:0,y:0,width:0,height:0}},getCanvasSize:function(){return{width:this.realWidth,height:this.realHeight}},setViewOffSet:function(a,b){var c=this.viewRect.x,d=this.viewRect.y,e=this.viewRect.width,f=this.viewRect.height;this.setViewRect(c+a,d+b,e,f)},setViewRect:function(a,b,c,d){1==this.isLimitViewInCanvas()&&(0>a&&(a=0),c>this.realWidth?a=0:a+c>this.realWidth&&(a=this.realWidth-c),0>b&&(b=0),d>this.realHeight?b=0:b+d>this.realHeight&&(b=this.realHeight-d));var e=this.viewRect;(null==this.viewRect||a!=this.viewRect.x||b!=this.viewRect.y||c!=this.viewRect.width||d!=this.viewRect.height)&&(this.viewRect={x:a,y:b,width:c,height:d},this.firePropertyChange("viewRect",e,this.viewRect),this.invalidateElementVisibility(),this._paintAll=!0)},isHScrollBarVisible:function(){return this.hScrollBarVisible},setHScrollBarVisible:function(a){this.hScrollBarVisible=a},isVScrollBarVisible:function(){return this.vScrollBarVisible},setVScrollBarVisible:function(a){this.vScrollBarVisible=a},setZoomVisibilityThresholds:function(a){var b=this._visibilityThresholds;this._zoomVisibilityThresholds=a,this.firePropertyChange("zoomVisibilityThresholds",b,a),this.invalidateElementVisibility()},getZoomVisibilityThresholds:function(){return this._zoomVisibilityThresholds||{}},invalidateElementVisibility:function(){this.invalidate()},repaintTopCanvas:function(){this._repaintTopFlag||(this._repaintTopFlag=!0,this.invalidate())},invalidateCanvasSize:function(a){this._invalidateCanvasSizeFlag||(this._invalidateCanvasSizeFlag=!0,this.invalidate())},validateCanvasSize:function(){0!=this._invalidateCanvasSizeFlag&&(this._invalidateCanvasSizeFlag=!1,this._validateCanvasSize())},_validateCanvasSize:function(){if(0==this.isAutoValidateCanvasSize())return this.realWidth=0,this.realHeight=0,void(this._unionBounds={x:0,y:0,width:0,height:0});var a,b=this.getElementBox().getDatas(),c=b.size();if(c>0){for(var d=0;c>d;d++){var e=b.get(d);if(this._visibleMap[e._id]){var f=this._elementUIMap[e._id];f&&(a=a?Rb.unionRect(a,f.getZoomViewRect(!0)):Hb.cloneRect(f.getZoomViewRect(!0)))}}null==a&&(a={x:0,y:0,width:0,height:0});var g=this.getGraphicsZoom();if(this._unionBounds={x:a.x*g,y:a.y*g,width:a.width*g,height:a.height*g},this.realWidth==(a.x+a.width)*g&&this.realHeight==(a.y+a.height)*g)return;this.realWidth=(a.x+a.width)*g,this.realHeight=(a.y+a.height)*g}else this.realWidth=0,this.realHeight=0,this._unionBounds={x:0,y:0,width:0,height:0};this.setViewRect(this.viewRect.x,this.viewRect.y,this.viewRect.width,this.viewRect.height),this.firePropertyChange("canvasSizeChange",null,this.viewRect)},getElementUI:function(a){return null==a?null:this._elementUIMap[a._id]},getUnionBounds:function(){return this._unionBounds},getZoomBodyRect:function(a){var b=this.getElementUI(a);return b?b.getZoomBodyRect():null},getShapeNodeZoomPoints:function(a,b){if(a._points){var c=this.getElementUI(a);if(c)return c._getZoomPoints()}return null},createElementUI:function(a){var b=this._elementUIMap[a.getId()];if(!b){if(b=this._elementUIFunction(this,a),!b){var c=a.getClassName(),d=c.substr(c.indexOf(".")+1)+"UI",e=Gb.vector[d];e&&(b=new e(this,a))}b&&(this._elementUIMap[a.getId()]=b)}return this._invalidateMap&&(this._invalidateMap[a._id]=a),b},getElementUIFunction:function(){return this._elementUIFunction},setElementUIFunction:function(a){if(!a)throw"ElementUIFunction can not be null";if(this._elementUIFunction!==a){var b=this._elementUIFunction;this._elementUIFunction=a,this.firePropertyChange("elementUIFunction",b,a),this._box.isEmpty()||(this._elementUIMap={},this._box.forEach(this.createElementUI,this),this.invalidateElementVisibility(),this.invalidateCanvasSize())}},invalidateElementUI:function(a,b){if(!this._invalidateAll){this._invalidateMap[a._id]=a;{this.getElementUI(a)}if(a instanceof Ld){var c=a.getAgentLinks();null!=c&&c.forEach(this.invalidateElementUI,this);var d=a.getParent();d instanceof Gb.Group&&this.invalidateElementUI(d)}this.invalidateElementVisibility()}},invalidateElementUIs:function(a){this._invalidateAll=!0,this._invalidateMap={},this._visibleMap={},this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.invalidate()},invalidateSelectedElementUIs:function(a){this.getSelectionModel().getSelection().forEach(function(b){this.invalidateElementUI(b,a)},this)},invalidateBundleLink:function(a){if(a instanceof Gb.Link&&a._bundleLinks){var b=this._elementUIMap;a._bundleLinks.forEachSiblingLink(function(c){if(c!==a){var d=b[c._id];d&&d.invalidate(!1)}},this)}},paintRoot:function(a){var b=this._rootCanvas.getContext("2d");b.save();var c=this.getGraphicsZoom();b.beginPath(),b.rect(Math.round(a.x*c-this.viewRect.x),Math.round(a.y*c-this.viewRect.y),Math.round(a.width*c),Math.round(a.height*c)),b.clip(),b.clearRect(Math.round(a.x*c-this.viewRect.x),Math.round(a.y*c-this.viewRect.y),Math.round(a.width*c),Math.round(a.height*c)),this.visibleList=new Gb.List,this._topAttachmentList=new Gb.List,kd.draw(b,this);var d=this.getElementBox().getDatas()._as,e=d.length,f=this.zoomManager;f._zoomGraphicsBegin(b),this.paintBottom(b,a);var g,h,i,j,k=this._box._layerBox,c=this.getGraphicsZoom(),l={x:this.viewRect.x/c,y:this.viewRect.y/c,width:this.viewRect.width/c,height:this.viewRect.height/c};if(this.adjustLinkIndex(),
1===k.size())for(g=0;e>g;g++)h=d[g],this._visibleMap[h._id]?(i=this._elementUIMap[h._id],this._debug&&Vb.strokeRect(b,a,"red"),null!=i&&this._isInView(i,a)&&(i.paint(b),i.setAttachmentVisible&&i.setAttachmentVisible(!0)),null!=i&&Rb.intersects(l,i.getZoomViewRect())?i.setAttachmentVisible&&i.setAttachmentVisible(!0):i.setAttachmentVisible&&i.setAttachmentVisible(!1),this.visibleList.add(h)):(i=this._elementUIMap[h._id],i&&i.setAttachmentVisible&&i.setAttachmentVisible(!1));else k.forEachByDepthFirst(function(c){for(g=0;e>g;g++)h=d[g],k.getLayerByElement(h)===c&&this._visibleMap[h._id]?(i=this._elementUIMap[h._id],null!=i&&this._isInView(i,a)&&(i.paint(b),i.setAttachmentVisible&&i.setAttachmentVisible(!0)),null!=i&&Rb.intersects(l,i.getZoomViewRect())?i.setAttachmentVisible&&i.setAttachmentVisible(!0):i.setAttachmentVisible&&i.setAttachmentVisible(!1),i&&i.validateZIndex&&i.validateZIndex(k.getDatas().indexOf(c)),this.visibleList.add(h)):i=this._elementUIMap[h._id]},null,this);for(e=this._topAttachmentList.size(),g=0;e>g;g++)j=this._topAttachmentList.get(g),j.getElementUI().paintAttachment(b,j);if(this.paintTop(b,a),void 0!==this._xyz){var e,m=this._xyz,n=m.markText,o=m.type,p=(m.expired,m.innerHTML),q=0,r=0,s=this.viewRect;b.translate(this.viewRect.x/this.getZoom(),this.viewRect.y/this.getZoom()),b.scale(1/this.getZoom(),1/this.getZoom());var c=this.getZoom();void 0!=n&&null!=n&&""!=n||"2"==o?(b.font="15px Arial sans-serif",e=Hb.g.getTextSize(b.font,p),b.fillStyle="red",q=s.width-e.width,r=s.height-20):(b.font="10px Arial sans-serif",e=Hb.g.getTextSize(b.font,p),q=s.width/2-e.width/2,r=s.height/2),b.fillText(p,q,r)}b.restore(),this._invalidateMap={},this._invalidateAll=!1,this._paintAll=!1,this._dirtyRects=new md},adjustLinkIndex:function(){var a,b,c=this._box.getDatas()._as,d=this.hasEditInteraction();if(d){for(this._hasAdjustedLinks=!1,i=c.length-1;i>-1;i--)if(a=c[i],a instanceof Gb.Link)if(this.isEditable(a)&&this.getElementUI(a).isEditable()&&this.isSelected(a))b=this._box.getDatas().indexOf(a),this._box.getDatas().removeAt(b),this._box.getDatas().add(a),this._hasAdjustedLinks=!0;else{var e=a.getToNode();b=this._box.getDatas().indexOf(e),this._box.getDatas().removeAt(b),this._box.getDatas().add(e);var f=a.getFromNode();b=this._box.getDatas().indexOf(f),this._box.getDatas().removeAt(b),this._box.getDatas().add(f)}}else if(this._hasAdjustedLinks){for(i=c.length-1;i>-1;i--)if(a=c[i],a instanceof Gb.Link){var e=a.getToNode();b=this._box.getDatas().indexOf(e),this._box.getDatas().removeAt(b),this._box.getDatas().add(e);var f=a.getFromNode();b=this._box.getDatas().indexOf(f),this._box.getDatas().removeAt(b),this._box.getDatas().add(f)}this._hasAdjustedLinks=!1}},paintBottom:function(a,b){},paintTop:function(a,b){},_isInView:function(a,b){return Rb.intersects(b,a.getZoomViewRect())},paintTopCanvas:function(){var a=this._topCanvas.getContext("2d");a.clearRect(0,0,this._topCanvas.width,this._topCanvas.height),this.paintMarker(a)},paintMarker:function(a){for(var b=this.markerList.size(),c=0;b>c;c++){var d=this.markerList.get(c);d.paint(a)}},getLayerByElement:function(a){return this._box.getLayerBox().getLayerByElement(a)},getLogicalPoint2:function(a){return this.zoomManager._getLogicalPoint(a)},getLogicalPoint:function(a){return this.zoomManager._getLogicalPoint(a,!0)},getElementAt:function(a){if(null==this.visibleList)return null;var b;if(a.target?b=this.getLogicalPoint2(a):a.event?a.event.target&&(b=this.getLogicalPoint2(a.event)):b=a,null!=this._hitTestTopAttachmentList)for(var c=this._hitTestTopAttachmentList.size(),d=c-1;d>=0;d--){var e=this._hitTestTopAttachmentList.get(d);if(e.hit(b.x,b.y))return e.getElement()}if(null!=this.visibleList)for(var f=this.visibleList.size(),g=f-1;g>=0;g--){var h=this.visibleList.get(g),i=this.getElementUI(h);if(i&&i.hit(b.x,b.y))return h}return null},getElementsAt:function(a){var b=new Gb.List;if(null==this.visibleList)return null;var c;if(a.target?c=this.getLogicalPoint2(a):a.event?a.event.target&&(c=this.getLogicalPoint2(a.event)):c=a,null!=this._hitTestTopAttachmentList)for(var d=this._hitTestTopAttachmentList.size(),e=d-1;e>=0;e--){var f=this._hitTestTopAttachmentList.get(e);f.hit(c.x,c.y)&&b.add(f.getElement())}if(null!=this.visibleList)for(var g=this.visibleList.size(),h=g-1;h>=0;h--){var i=this.visibleList.get(h),j=this.getElementUI(i);j&&j.hit(c.x,c.y)&&b.add(i)}return b},hitTest:function(a){var b=this.getElementAt(a);if(!b)return null;var c=this.getElementUI(b);if(!c)return null;var d;return d=a.target?this.getLogicalPoint2(a):a.event?this.getLogicalPoint2(a.event):a,c.hitTest(d.x,d.y)},getElementsAtRect:function(a,b,c,d){var e=new Gb.List;if(null==this.visibleList)return e;d=void 0===d?!0:d;for(var f=this.visibleList.size(),g=f-1;g>=0;g--){var h=this.visibleList.get(g),i=this.getElementUI(h);i&&(!c||c(i._element))&&(d&&this.isSelectable(i._element)||!d)&&(b?i.intersects(a)&&e.add(h):Rb.contains(a,i.getZoomViewRect(jc))&&e.add(h))}return e},getPosition:function(a,b,c,d,e,f){var g,h=b instanceof Gb.vector.ElementUI?b:this.getElementUI(b);if(h)if("from"===a||"to"===a){if(h.getFromPosition&&(g="from"===a?h.getFromPosition(d,e):h.getToPosition(d,e)))return c?{x:g.x-c.width/2,y:g.y-c.height/2}:g}else g="hotspot"===a?f?h.getZoomHotSpot(this.zoomManager):h.getHotSpot():Tb.get(a,f?h.getZoomBodyRect():h.getBodyRect(),c);if(!g&&b.getRect&&(g=Tb.get(a,b.getRect(),c)),g)return{x:g.x+d,y:g.y+e};throw"position '"+a+"' object '"+b+"'"},isValidEvent:function(a){if(!a)return!1;var b,c;if(a.currentTarget===this._view){if(Ob.isFirefox?(b=a.layerX,c=a.layerY):(b=a.offsetX,c=a.offsetY),1==this.isHScrollBarVisible()&&c>=this.viewRect.height-this.getScrollBarWidth())return!1;if(1==this.isVScrollBarVisible()&&b>=this.viewRect.width-this.getScrollBarWidth())return!1}return!0},addMarker:function(a){this.markerList.add(a),this.repaintTopCanvas()},removeMarker:function(a){this.markerList.remove(a),this.repaintTopCanvas()},clearMarker:function(){this.markerList.clear(),this.repaintTopCanvas()},isMovable:function(a){return this._box.contains(a)&&a.isMovable()?this._movableFunction&&!this._movableFunction(a)?!1:this.getLayerByElement(a).isMovable():!1},hasMovableSelectedElements:function(){for(var a=this.getSelectionModel().getSelection(),b=0;b<a.size();b++){var c=a.get(b);if(this.isMovable(c))return!0}return!1},getMovableSelectedElements:function(){return this.getSelectionModel().toSelection(function(a){return this.isMovable(a)},this)},moveSelectedElements:function(a,b,c,d){if(0!==a||0!==b){var e=this.getMovableSelectedElementsRect();null!=e&&(this._limitElementInPositiveLocation&&(e.x+a<0&&(a=-e.x),e.y+b<0&&(b=-e.y)),Gb.Util.moveElements(this.getMovableSelectedElements(),a,b,c,d,this))}},getMovableSelectedElementsRect:function(){var a=this.getMovableSelectedElements();if(0===a.size())return null;for(var b=null,c=0,d=a.size();d>c;c++){var e=a.get(c);if(e instanceof Ld){var f=this.getElementUI(e);f&&(b=Rb.unionRect(b,f.getViewRect()))}}return b},isVisibleAttachment:function(a){return!this.state.zooming&&!this.state.panning&&!this.state.layouting},isVisible:function(a,b,c){if(!this._box.contains(a))return!1;if(!a.isVisible())return!1;if(3!==arguments.length&&(b=this._visibleFunction),b&&!b(a))return!1;if(!(c||this._box._layerBox.getLayerByElement(a))._visible)return!1;if(uc.getSubNetwork(a)!==this._currentSubNetwork)return!1;if(!this.zoomManager.isElementVisible(a))return!1;if(a instanceof Gb.Link){if(!this._noAgentLinkVisible){if(!a._fromAgent||!a._toAgent)return!1;if(!this.isVisible(a._fromAgent,b,c)||!this.isVisible(a._toAgent,b,c))return!1}if(a.getBundleIndex()>0&&a.getBundleCount()>1&&!a.getStyle("link.bundle.expanded"))return!1}else for(var d=a._parent;d&&!d.ISubNetwork;){if(d instanceof Gb.Group&&(!d.isExpanded()||!this.isVisible(d,b,c)))return!1;d=d._parent}return a.IDummy?!1:!0},getVisibleFunction:function(){return this._visibleFunction},setVisibleFunction:function(a){var b=this._visibleFunction;this._visibleFunction=a,this.firePropertyChange("visibleFunction",b,a),this.invalidateElementVisibility()},isEditable:function(a){return this._box.contains(a)?this._editableFunction&&!this._editableFunction(a)?!1:this.getLayerByElement(a).isEditable():!1},getEditableFunction:function(){return this._editableFunction},setEditableFunction:function(a){var b=this._editableFunction;this._editableFunction=a,this.firePropertyChange("editableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isRotatable:function(a){return this._rotatableFunction&&!this._rotatableFunction(a)?!1:!0},getRotatableFunction:function(){return this._rotatableFunction},setRotatableFunction:function(a){var b=this._rotatableFunction;this._rotatableFunction=a,this.firePropertyChange("rotatableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isLinkable:function(a,b){return null==this._linkableFunction||this._linkableFunction(a,b)},getLinkableFunction:function(){return this._linkableFunction},setLinkableFunction:function(a){var b=this._linkableFunction;this._linkableFunction=a,this.firePropertyChange("linkableFunction",b,a),this.invalidateSelectedElementUIs(!0)},onShareSelectionModelChanged:function(){this.invalidateElementUIs()},getShadowColor:function(a){var b=a.getStyle("shadow.color");return!b&&this.isSelected(a)&&"shadow"===a.getStyle("select.style")?a.getStyle("select.color"):b},getSelectColor:function(a){return a.getStyle("select.color")},getAlarmLabel:function(a){var b=a.getAlarmState().getHighestNewAlarmSeverity();if(b){var c=a.getAlarmState().getNewAlarmCount(b)+b.nickName;return a.getAlarmState().hasLessSevereNewAlarms()&&(c+="+"),c}return null},getLinkHandlerLabel:function(a){return a.isBundleAgent()?"+("+a.getBundleCount()+")":null},setInteractions:function(a){var b=this._interactions;b&&b.forEach(function(a){a.tearDown()}),this._interactions=a,a&&a.forEach(function(a){a.setUp()}),this.invalidateSelectedElementUIs(!0),this.firePropertyChange("interactions",b,a)},getInteractions:function(){return this._interactions},setDefaultInteractions:function(a,b){var c=[new Gb.vector.interaction.DefaultInteraction(this,a)];b&&c.push(new Gb.vector.interaction.MoveLinkInteraction(this,a)),this.setInteractions(c)},setTouchInteractions:function(){this.setInteractions([new Gb.vector.interaction.DefaultInteraction(this,!1),new Gb.vector.interaction.TouchInteraction(this)])},setMSTouchInteractions:function(){this.setInteractions([new Gb.vector.interaction.MSTouchInteraction(this)])},setEditInteractions:function(a,b){var c=[new Gb.vector.interaction.EditInteraction(this,a),new Gb.vector.interaction.DefaultInteraction(this)];b&&c.push(new Gb.vector.interaction.MoveLinkInteraction(this,a)),this.setInteractions(c)},setCreateElementInteractions:function(a){this.setInteractions([new Gb.vector.interaction.CreateElementInteraction(this,a),new Gb.vector.interaction.DefaultInteraction(this)])},setCreateLinkInteractions:function(a){this.setInteractions([new Gb.vector.interaction.CreateLinkInteraction(this,a),new Gb.vector.interaction.DefaultInteraction(this)])},setCreateShapeLinkInteractions:function(a){this.setInteractions([new Gb.vector.interaction.CreateShapeLinkInteraction(this,a),new Gb.vector.interaction.DefaultInteraction(this)])},setCreateShapeNodeInteractions:function(a){this.setInteractions([new Gb.vector.interaction.CreateShapeNodeInteraction(this,a),new Gb.vector.interaction.DefaultInteraction(this)])},setMagnifyInteractions:function(){this.setInteractions([new Gb.vector.interaction.DefaultInteraction(this),new Gb.vector.interaction.MagnifyInteraction(this)])},hasEditInteraction:function(){return this._hasEditInteraction},setHasEditInteraction:function(a){var b=this._hasEditInteraction;this._hasEditInteraction=a,this.firePropertyChange("hasEditInteraction",b,a)},addElementByInteraction:function(a){a.getParent()||a.setParent(this._currentSubNetwork),this._box.add(a),this.getSelectionModel().setSelection(a),this.fireInteractionEvent({kind:"createElement",element:a})},getToolTip:function(a){if(a){var b=a.getToolTip();return b?b:a.getName()}return null},isToolTipEnabled:function(){return this._toolTipEnabled?!0:!1},setToolTipEnabled:function(a){if(this._toolTipEnabled=a,a){if(!this._toolTipListener){var b=this;this._toolTipListener=function(a){if(b.isMovingElement())return void Ac.hideToolTip();var c=b.getElementAt(a);if(b._preElement!==c){if(b._preElement=c,c){var d=b.getToolTip(c);return void Ac.showToolTip({x:a.pageX,y:a.pageY},d,function(a){var c=b._view.getBoundingClientRect(),d=a.getBoundingClientRect();d.width+d.left>c.width+c.left&&(a.style.left=c.width+c.left-d.width+(Mb.documentElement.scrollLeft||Mb.body.scrollLeft)+"px"),d.height+d.top>c.height+c.top&&(a.style.top=c.height+c.top-d.height+(Mb.documentElement.scrollTop||Mb.body.scrollTop)+"px")})}Ac.hideToolTip()}},this._view.addEventListener("mousemove",this._toolTipListener,!1),this.firePropertyChange("toolTipEnabled",!1,!0)}}else this._toolTipListener&&(Ac.hideToolTip(),this._view.removeEventListener("mousemove",this._toolTipListener,!1),delete this._toolTipListener,this.firePropertyChange("toolTipEnabled",!0,!1))},setZoom:function(a,b){if(a=this.checkZoom(a),this.isAsyncZoomAndViewRect())var c=this._zoomMap[this._currentSubNetwork].zoom;else var c=this._zoom;if(a!=c){var d=this.getViewRect();b||(b={x:d.width/2,y:d.height/2});var e=this.viewRect,f=b.x-(b.x+e.x)*a/c,g=b.y-(b.y+e.y)*a/c;this.isAsyncZoomAndViewRect()?this._zoomMap[this._currentSubNetwork].zoom=a:this._zoom=a,this._paintAll=!0,this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.zoomManager._invalidateZoom(),this.setViewRect(-f,-g,this.viewRect.width,this.viewRect.height),this._asyncZoomAndViewRect?this.firePropertyChange("zoom",c,this._zoomMap[this._currentSubNetwork].zoom):this.firePropertyChange("zoom",c,this._zoom),this.state.zooming=!0;var h=null,i=this;h?clearTimeout(h):h=setTimeout(function(){h=null,i.state.zooming=!1,i.invalidateElementUIs(!0)},100)}},getZoom:function(){if(this.isAsyncZoomAndViewRect()){var a=this._zoomMap[this._currentSubNetwork];return a||(this._zoomMap[this._currentSubNetwork]={zoom:1}),this._zoomMap[this._currentSubNetwork].zoom}return this._zoom},getSizeZoom:function(a){return this.zoomManager.getSizeZoom(a)},getLocationZoom:function(){return this.zoomManager.getLocationZoom()},getGraphicsZoom:function(){return this.zoomManager.getGraphicsZoom()},zoomOverview:function(a){if(!(this._unionBounds.width<=0||this._unionBounds.width<=0)){var b=this.getZoom(),c=this._unionBounds,d=c.width/b,e=c.height/b,f=this.viewRect.width/d,g=this.viewRect.height/e,h=Math.min(f,g);this.setZoom(h);var i=this.getZoom(),j=this.viewRect.width/2-this._unionBounds.width/2*i/b,k=this.viewRect.height/2-this._unionBounds.height/2*i/b;if(this.setViewRect(this._unionBounds.x*i/b-j,this._unionBounds.y*i/b-k,this.viewRect.width,this.viewRect.height),1!=this.getLocationZoom()){var l=null==arguments[1]?5:arguments[1];if(l>0){l--;var m=this;setTimeout(function(){m.zoomOverview(a,l)},25)}}}},zoomReset:function(a){this.setZoom(1,a)},zoomIn:function(a){this.setZoom(1.2*this.getZoom(),a)},zoomOut:function(a){this.setZoom(this.getZoom()/1.2,a)},upSubNetwork:function(a,b){this._currentSubNetwork&&this.setCurrentSubNetwork(uc.getSubNetwork(this._currentSubNetwork),a,b)},getCurrentSubNetwork:function(){return this._currentSubNetwork},setCurrentSubNetwork:function(a,b,c){if(Gb.animate.AnimateManager.endAnimate(),b){if(this._currentSubNetwork===a)return;if(a&&!this._box.contains(a))throw a+" is not contained in this network's elementBox";var d=new Gb.animate.AnimateSubNetwork(this,a,c);Gb.animate.AnimateManager.start(d)}else this._setCurrentSubNetwork(a),c&&c()},_setCurrentSubNetwork:function(a){if(this._currentSubNetwork!==a){if(a&&!this._box.contains(a))throw a+" is not contained in this network's elementBox";if(this.isAsyncZoomAndViewRect()){var b=this._viewRectMap[this._currentSubNetwork];this._viewRectMap[this._currentSubNetwork]=b?this.viewRect:this.viewRect?this.viewRect:{x:0,y:0,width:this.viewRect.width,height:this.viewRect.height}}var c=this._currentSubNetwork;if(this._currentSubNetwork=a,this.firePropertyChange("currentSubNetwork",c,a),this.isAsyncZoomAndViewRect()){this._viewRectMap[this._currentSubNetwork]||(this._viewRectMap[this._currentSubNetwork]={x:0,y:0,width:this.viewRect.width,height:this.viewRect.height});var b=this._viewRectMap[this._currentSubNetwork];this.setViewRect(b.x,b.y,b.width,b.height),this.invalidateElementUIs()}this.invalidateElementVisibility(),this.invalidateCanvasSize(),this._paintAll=!0}},makeVisible:function(a){var b=this.getElementUI(a);if(b){var c=uc.getSubNetwork(a);if(c!==this._currentSubNetwork){var d=this;return void this.setCurrentSubNetwork(c,this.isSubNetworkAnimate(),function(){Hb.callLater(d.makeVisible,d,[a])})}for(var e=a;(e=e.getParent())&&e!==c;)e instanceof Gb.Group&&e.setExpanded(!0);var f=b.getViewRect();if(f){var g,h=b.getZoomViewRect(this.zoomManager);g=f.x==h.x&&f.y==h.y&&f.width==h.width&&f.height==h.height?{x:f.x*this.getGraphicsZoom(),y:f.y*this.getGraphicsZoom(),width:f.width*this.getGraphicsZoom(),height:f.height*this.getGraphicsZoom()}:h,Rb.intersects(this.viewRect,g)||this.isVisible(a)&&Hb.callLater(this.centerByLogicalPoint,this,[g.x+g.width/2,g.y+g.height/2])}}},centerByLogicalPoint:function(a,b,c){var d=a-this.viewRect.width/2,e=b-this.viewRect.height/2;this.setViewRect(d,e,this.viewRect.width,this.viewRect.height)},panByOffset:function(a,b){this.setViewOffSet(a,b)},getIconsNames:function(a){return a.getStyle("icons.names")},getIconsColors:function(a){return a.getStyle("icons.colors")},getLinkFlowStepping:function(a){var b=parseInt(a.getStyle("link.flow.stepping"));return b||(b=Dd.NETWORK_LINK_FLOW_STEPPING),b},getLinkFlowOffset:function(a){var b=a.getStyle("link.flow.offset");return isNaN(b)&&(b=0),b+this.getLinkFlowStepping(a)},toCanvas:function(a,b,c,d,e,f){c||(c=Ub.createCanvas()),c.setAttribute("width",a),c.setAttribute("height",b),c._viewRect?(c._viewRect.width=a,c._viewRect.height=b):c._viewRect={x:0,y:0,width:a,height:b};var g=c.getContext("2d");if(g.translate(-e,-f),g.clearRect(0,0,a,b),kd.draw(g,this),0===this._view.clientWidth||0===this._view.clientHeight)return c;a/this.realWidth*this.getGraphicsZoom(),b/this.realHeight*this.getGraphicsZoom();g.scale(d,d);var h=this.getElementBox().getDatas()._as,i=h.length;this._topAttachmentList=new Gb.List;var j,k,l,m,n,o,p=this.getElementBox().getLayerBox(),q=p.getRoots(),r=q.size();if(this.adjustLinkIndex(),1===r)for(l=0;i>l;l++)m=h[l],this._visibleMap[m._id]&&(n=this._elementUIMap[m._id],null!=n&&n.paint(g));else for(j=0;r>j;j++)for(k=q.get(j),l=0;i>l;l++)m=h[l],p.getLayerByElement(m)===k&&this._visibleMap[m._id]&&(n=this._elementUIMap[m._id],null!=n&&n.paint(g));for(i=this._topAttachmentList.size(),l=0;i>l;l++)o=this._topAttachmentList.get(l),o.getElementUI().paintAttachment(g,o);return c},toCanvasByRegion:function(a,b,c){c||(c=Ub.createCanvas());var d=a.width*b,e=a.height*b;c.setAttribute("width",d),c.setAttribute("height",e),c._viewRect?(c._viewRect.width=d,c._viewRect.height=e):c._viewRect={x:0,y:0,width:d,height:e};var f=c.getContext("2d");if(f.clearRect(0,0,d,e),kd.draw(f,this),0===this._view.clientWidth||0===this._view.clientHeight)return c;f.save(),f.scale(b,b),f.beginPath(),f.translate(-a.x,-a.y);var g=this.getElementBox().getDatas()._as,h=g.length;this._topAttachmentList=new Gb.List;var i,j,k,l,m,n,o=this.getElementBox().getLayerBox(),p=o.getRoots(),q=p.size();if(this.adjustLinkIndex(),1===q)for(k=0;h>k;k++)l=g[k],this._visibleMap[l._id]&&(m=this._elementUIMap[l._id],null!=m&&Rb.intersects(a,m.getZoomViewRect())&&m.paint(f));else for(i=0;q>i;i++)for(j=p.get(i),k=0;h>k;k++)l=g[k],o.getLayerByElement(l)===j&&this._visibleMap[l._id]&&(m=this._elementUIMap[l._id],null!=m&&Rb.intersects(a,m.getZoomViewRect())&&m.paint(f));for(h=this._topAttachmentList.size(),k=0;h>k;k++)n=this._topAttachmentList.get(k),n.getElementUI().paintAttachment(f,n);return f.restore(),c},getGroupChildrenRects:function(a){return this.zoomManager._getGroupChildrenRects(a)},convertPointFromView:function(a){return this.zoomManager._convertPointFromView(a)},getOffset:function(a,b){return this.zoomManager._getOffset(a,b)},panToCenter:function(){this.setViewRect((this.realWidth-this.viewRect.width)/2,(this.realHeight-this.viewRect.height)/2,this.viewRect.width,this.viewRect.height)},moveElementsToCenter:function(){if(this._limitViewInCanvas){var a=this.viewRect,b=this._unionBounds,c=a.x+a.width/2-b.x-b.width/2,d=a.y+a.height/2-b.y-b.height/2;Gb.Util.moveElements(this._box.toDatas(),c,d)}else{var c=this.viewRect.width/2-this._unionBounds.width/2,d=this.viewRect.height/2-this._unionBounds.height/2;this.setViewRect(this._unionBounds.x-c,this._unionBounds.y-d,this.viewRect.width,this.viewRect.height)}},getLinkPathFunction:function(){return this._linkPathFunction},setLinkPathFunction:function(a){var b=this._linkPathFunction;this._linkPathFunction=a,this.firePropertyChange("linkPathFunction",b,a),this.invalidateElementUIs()},invalidate:function(){this._invalidate||(this._invalidate=!0,this.fireViewEvent({kind:"invalidate"}))},validate:function(){this._invalidate&&(Kb||0!==this._view.offsetWidth||0!==this._view.offsetHeight)&&(this._invalidate=!1,this._isValidating=!0,this.fireViewEvent({kind:"validateStart"}),this.validateImpl(),this.fireViewEvent({kind:"validateEnd"}),this._isValidating=!1)},onClickElement:function(a,b){},onClickBackground:function(a){},onDoubleClickElement:function(a,b){},onDoubleClickBackground:function(a){},onLongClickElement:function(a,b){},onLongClickBackground:function(a){},onMouseMove:function(a,b){},onMouseEnter:function(a,b){},onMouseLeave:function(a,b){},setMovingElement:function(a){if(a!=this._movingElement){var b=this._movingElement;this._movingElement=a,this.firePropertyChange("movingElement",b,a),this._box._undoManager._enabled&&(a?this._box._undoManager.startBatch():this._box._undoManager.endBatch())}},setEditingElement:function(a){if(a!=this._editingElement){var b=this._editingElement;this._editingElement=a,this.firePropertyChange("editingElement",b,a),this._box._undoManager._enabled&&(a?this._box._undoManager.startBatch():this._box._undoManager.endBatch())}},dispose:function(){Gb.imageUtil.removeEventListener(this.invalidateElementUIs,this),this.setInteractions(null),cancelAnimationFrame(this._loopId)},handle_mousemove:function(a){var b=this.getElementAt(a),c=this.__preElement,d=Cc(c),e=Cc(b);c!==b&&(c&&(d&&d.onMouseLeave&&d.onMouseLeave(c,this),this.onMouseLeave(c,a)),b&&(e&&e.onMouseEnter&&e.onMouseEnter(b,this),this.onMouseEnter(b,a))),b&&e&&e.onMouseMove&&e.onMouseMove(b,this),this.onMouseMove(b,a),this.__preElement=b}}),Gb.vector.Overview=function(a){Gb.vector.Overview.superClass.constructor.apply(this,a),this._view=Ub.createView(),this._rootDiv=Ub.createDiv(),this._imageCanvas=Ub.createCanvas(),this._imageDiv=Ub.createDiv(),this._maskCanvas=Ub.createCanvas(),this._selectDiv=Ub.createDiv(),this._isNetworkDirty=!1,this._isMaskDirty=!1,Ub.setVisible(this._selectDiv,!1),this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._imageDiv),this._rootDiv.appendChild(this._maskCanvas),this._rootDiv.appendChild(this._selectDiv),this._imageDiv.appendChild(this._imageCanvas),this._exportImageCanvas=Ub.createCanvas(),this._imageCtx=this._imageCanvas.getContext("2d"),this.setNetwork(a),Ob.isTouchable?Ob.isMSTouchable?new Gb.vector.OverviewMSTouchInteraction(this):(new Gb.vector.OverviewTouchInteraction(this),new Gb.vector.OverviewInteraction(this)):new Gb.vector.OverviewInteraction(this)},Hb.ext("twaver.vector.Overview",Gb.controls.ControlBase,{__accessor:["fillColor","outlineColor","outlineWidth","selectColor","selectWidth","padding","maxPackingWidth","maxPackingHeight"],__bool:["animate"],_fillColor:Dd.OVERVIEW_FILL_COLOR,_outlineColor:Dd.OVERVIEW_OUTLINE_COLOR,_outlineWidth:Dd.OVERVIEW_OUTLINE_WIDTH,_selectColor:Dd.OVERVIEW_SELECT_COLOR,_selectWidth:Dd.OVERVIEW_SELECT_WIDTH,_padding:Dd.OVERVIEW_PADDING,_animate:Dd.OVERVIEW_ANIMATE,_maxPackingWidth:Dd.OVERVIEW_MAX_PACKING_WIDTH,_maxPackingHeight:Dd.OVERVIEW_MAX_PACKING_HEIGHT,getNetwork:function(){return this._network},onPropertyChanged:function(a){this._invalidateMask()},setNetwork:function(a){a!==this._network&&(this._network&&(this._network.removePropertyChangeListener(this._handleNetworkPropertyChange,this),this._network.removeViewListener(this._handleNetworkViewChange,this),Ub.removeEventListener("scroll","_handleScrollChange",this._network.getView(),this)),this._network=a,this._network&&(this._network.addPropertyChangeListener(this._handleNetworkPropertyChange,this),this._network.addViewListener(this._handleNetworkViewChange,this),Ub.addEventListener("scroll","_handleScrollChange",this._network.getView(),this)),this.invalidate())},_handleNetworkPropertyChange:function(a){("zoom"===a.property||"currentSubNetwork"===a.property||"elementBox"===a.property||"dataBox"===a.property||"canvasSizeChange"===a.property)&&this.invalidate()},_handleNetworkViewChange:function(a){"validateEnd"===a.kind&&this.invalidate()},_handleScrollChange:function(){this._invalidateMask()},invalidate:function(a){this._isNetworkDirty&&this._isMaskDirty||(this._isNetworkDirty||(this._isNetworkDirty=!0),this._isMaskDirty||(this._isMaskDirty=!0),Hb.callLater(this.validate,this,null,a))},_invalidateMask:function(){this._isMaskDirty||(this._isMaskDirty=!0,Hb.callLater(this.validate,this,[],100))},validate:function(){if((this._isMaskDirty||this._isNetworkDirty)&&this._network&&(this._maxPackingWidth>0&&this._maxPackingHeight>0||this._view.clientWidth>0&&this._view.clientHeight>0)&&0!==this._network.getViewRect().width&&0!==this._network.getViewRect().height&&!this._network._invalidate){var a,b=this._maxPackingWidth>0&&this._maxPackingHeight>0;a=b?{x:0,y:0,width:this._maxPackingWidth,height:this._maxPackingHeight}:{x:0,y:0,width:this._view.clientWidth,height:this._view.clientHeight},Rb.grow(a,-this._padding,-this._padding),b&&(Ub.setDiv(this._view,{x:0,y:0,width:this._imageDiv._viewRect.width,height:this._imageDiv._viewRect.height},null,0,null),a.width=this._imageDiv._viewRect.width,a.height=this._imageDiv._viewRect.height);var c=this._network.getGraphicsZoom(),d=this._network._unionBounds;d=Rb.unionRect(d,{x:0,y:0,width:d.x,height:d.y}),d={x:d.x/c,y:d.y/c,width:d.width/c,height:d.height/c};var e={x:this._network.viewRect.x/c,y:this._network.viewRect.y/c,width:this._network.viewRect.width/c,height:this._network.viewRect.height/c},f=d,g=Math.min(a.width/f.width,a.height/f.height),h=f.width*g,i=f.height*g,j=f.width*g,k=f.height*g,l=a.x+(a.width-j)/2,m=a.y+(a.height-k)/2;if(this._isNetworkDirty){var n={x:l,y:m,width:j,height:k};this._network.toCanvas(h,i,this._exportImageCanvas,g,f.x*g,f.y*g),this._imageCanvas.setAttribute("width",j),this._imageCanvas.setAttribute("height",k),this._imageCtx.drawImage(this._exportImageCanvas,0,0,h,i),Ub.setDiv(this._imageDiv,n,null,0,null),this._network.getElementBox&&(this._imageDiv.style.backgroundColor=(this._network.getCurrentSubNetwork()||this._network.getElementBox()).getStyle("background.color")||""),this._isNetworkDirty=!1}if(this._isMaskDirty){var o={x:(e.x-f.x)*g,y:(e.y-f.y)*g,width:e.width*g,height:e.height*g},p=Ub.setCanvas(this._maskCanvas,l,m,j,k);p.lineWidth=0,p.fillStyle=this._fillColor,Vb.drawVector(p,"rectangle",null,l,m,j,k),p.closePath(),p.fill(),p.stroke(),p.clearRect(l+o.x,m+o.y,o.width,o.height),p.lineWidth=this._outlineWidth,p.strokeStyle=this._outlineColor;var q=o.width-2*this._outlineWidth,r=o.height-2*this._outlineWidth;q=Math.min(q,j-2-o.x-this._outlineWidth),r=Math.min(r,k-2-o.y-this._outlineWidth),Vb.drawVector(p,"rectangle",null,l+o.x+this._outlineWidth,m+o.y+this._outlineWidth,q,r),p.closePath(),p.stroke(),this._isMaskDirty=!1}}else this._isNetworkDirty=!1,this._isMaskDirty=!1},getLogicalPoint:function(a){return Ub.getLogicalPoint(this._view,a,1,this._rootDiv)},centerNetwork:function(a,b){var c=this._imageDiv._viewRect;if(Rb.containsPoint(c,a)){var d=this._network.getGraphicsZoom(),e=this._network._unionBounds;e=Rb.unionRect(e,{x:0,y:0,width:e.x,height:e.y}),e={x:e.x/d,y:e.y/d,width:e.width/d,height:e.height/d};var f={x:this._network.viewRect.x/d,y:this._network.viewRect.y/d,width:this._network.viewRect.width/d,height:this._network.viewRect.height/d},g=Rb.unionRect(e,f);this._network.centerByLogicalPoint((g.x+(a.x-c.x)/c.width*g.width)*d,(g.y+(a.y-c.y)/c.height*g.height)*d,b),this._invalidateMask()}}}),Gb.vector.OverviewTouchInteraction=function(a){this.overview=a,this.network=a.getNetwork(),this.view=a._view,Ub.addEventListener("touchstart","handleTouchstart",this.view,this)},Hb.ext("twaver.vector.OverviewTouchInteraction",Object,{handleTouchstart:function(a){Ub.preventDefault(a),this.clear(),this.endPoint=this.overview.getLogicalPoint(a),yc.isMultiTouch(a)&&(this.distance=yc.getDistance(a),this.zoom=this.network.getZoom()),Ub.addEventListener("touchmove","handleTouchmove",this.view,this),Ub.addEventListener("touchend","handleTouchend",this.view,this)},handleTouchmove:function(a){if(this.moved||(this.moved=!0),this.endPoint=this.overview.getLogicalPoint(a),yc.isSingleTouch(a))this.overview.centerNetwork(this.endPoint,!1);else if(this.distance){var b=yc.getDistance(a)/this.distance;this.network.setZoom(this.zoom*b,!1)}},handleTouchend:function(a){if(!this.moved){this.endPoint=this.overview.getLogicalPoint(a);var b=this.lastPoint&&this.lastTouchStartTime&&(new Date).getTime()-this.lastTouchStartTime.getTime()<=300&&Math.abs(this.endPoint.x-this.lastPoint.x)<=10&&Math.abs(this.endPoint.y-this.lastPoint.y)<=10;b?(this.lastPoint=null,this.lastTouchStartTime=null):(this.lastPoint=this.endPoint,this.lastTouchStartTime=new Date),b?Hb.callLater(this.network.zoomReset,this.network,[this.overview._animate]):this.overview.centerNetwork(this.endPoint,this.overview._animate)}this.clear()},clear:function(){this.endPoint&&(this.endPoint=null,Ub.removeEventListener("touchmove",this.view,this),Ub.removeEventListener("touchend",this.view,this)),this.moved=!1}}),Gb.vector.OverviewMSTouchInteraction=function(a){this.overview=a,this.network=a.getNetwork(),this.view=a._view,this._pointerMap={},this._pointerIdArray=[],Ub.addEventListener("MSPointerDown","handleTouchstart",this.view,this),Ub.addEventListener("MSPointerMove","handleTouchmove",this.view,this),Ub.addEventListener("MSPointerUp","handleTouchend",this.view,this),Ub.addEventListener("MSPointerCancel","handleTouchend",this.view,this)},Hb.ext("twaver.vector.OverviewMSTouchInteraction",Object,{handleTouchstart:function(a){Ub.preventDefault(a),a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),!this._pointerMap[a.pointerId]&&this.overview.getLogicalPoint(a)&&(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length?(this._startTouchPoint=this.overview.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.network.getZoom())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Rb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.network.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&this._startTouchPoint){var c=this.overview.getLogicalPoint(a);if(null==c)return;this._startTouchPoint=c,this.overview.centerNetwork(this._startTouchPoint,!1)}},handleTouchend:function(a){var b=this.overview.getLogicalPoint(a);if(1==this._pointerIdArray.length&&b){var c=this._endTouchPoint&&this._endTouchTime&&(new Date).getTime()-this._endTouchTime.getTime()<=500&&Rb.getDistance(this._endTouchPoint,b)<=10;c?(this._endTouchPoint=null,this._endTouchTime=null):(this._endTouchPoint=b,this._endTouchTime=new Date),c?Hb.callLater(this.network.zoomReset,this.network,[this.overview._animate]):this.overview.centerNetwork(this._endTouchPoint,this.overview._animate);

}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Rb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Gb.vector.OverviewInteraction=function(a){this.overview=a,this.network=a.getNetwork(),this.view=a._view,Ub.addEventListener("mousedown","handleMousedown",this.view,this)},Hb.ext("twaver.vector.OverviewInteraction",Object,{handleMousedown:function(a){this.clear(),this.endPoint=this.overview.getLogicalPoint(a),Hb.isCtrlDown(a)&&(this.startPoint=this.endPoint,Ub.setVisible(this.overview._selectDiv,!0)),Ub.addEventListener("mousemove","handleMousemove",this.view,this),Ub.addEventListener("mouseup","handleMouseup",this.view,this)},handleMouseup:function(a){if(this.endPoint=this.overview.getLogicalPoint(a),"detail"in a&&2===a.detail)Hb.callLater(this.network.zoomReset,this.network,[this.endPoint,this.overview._animate]);else if(Ub.isVisible(this.overview._selectDiv)&&this.startPoint){var b=this.overview._imageDiv._viewRect,c=this.overview._selectDiv._viewRect.x,d=this.overview._selectDiv._viewRect.y,e=b.width/this.overview._selectDiv._viewRect.width,f=b.height/this.overview._selectDiv._viewRect.height,g=Math.min(e,f);this.network.setZoom(g*Math.min(this.network.getViewRect().width/this.network.getCanvasSize().width,this.network.getViewRect().height/this.network.getCanvasSize().height)*this.network.getZoom(),!1);var h=this.network.getCanvasSize().width*((c-b.x+this.overview._selectDiv._viewRect.width/2)/b.width),i=this.network.getCanvasSize().height*((d-b.y+this.overview._selectDiv._viewRect.height/2)/b.height);Hb.callLater(this.network.centerByLogicalPoint,this.network,[h,i,this.overview._animate]),Ub.setVisible(this.overview._selectDiv,!1),Ub.setDiv(this.overview._selectDiv,{x:0,y:0,width:0,height:0},null,0,null),this.startPoint=null}else this.overview.centerNetwork(this.endPoint,this.overview._animate);this.clear()},handleMousemove:function(a){var b=this.overview.getLogicalPoint(a);if(this.endPoint=b,Ub.isVisible(this.overview._selectDiv)&&this.startPoint){var c=b.x>this.startPoint.x?this.startPoint.x:b.x,d=b.x>this.startPoint.x?this.startPoint.y:b.y;b.x>this.startPoint.x&&b.y<this.startPoint.y&&(d=b.y),b.x<this.startPoint.x&&b.y>this.startPoint.y&&(d=this.startPoint.y);var e=this.overview._imageDiv._viewRect;c<e.x&&(c=e.x),c>e.x+e.width&&(c=e.x+e.width),d<e.y&&(d=e.y),d>e.y+e.height&&(d=e.y+e.height);var f=Math.abs(b.x-this.startPoint.x),g=Math.abs(b.y-this.startPoint.y);c+f>e.x+e.width&&(f=e.x+e.width-c),d+g>e.y+e.height&&(g=e.y+e.height-d),Ub.setDiv(this.overview._selectDiv,{x:c,y:d,width:f,height:g},null,this.overview._selectWidth,this.overview._selectColor)}else this.overview.centerNetwork(b,!1)},clear:function(){this.endPoint&&(this.endPoint=null,Ub.removeEventListener("mousemove",this.view,this),Ub.removeEventListener("mouseup",this.view,this))}}),Gb.vector.ElementUI=function(a,b){this._network=a,this._element=b,this._attachments=new Gb.List,this._bodyBounds=new Gb.List,this._hitTest=!1,this._hitTest=!1,this._intersectTest=!1,this.invalidate(!0)},Hb.ext("twaver.vector.ElementUI",Object,{getElement:function(){return this._element},getNetwork:function(){return this._network},handlePropertyChange:function(a){},handleSelectionChange:function(a){},invalidate:function(a){void 0===a&&(a=!0),a&&(this._invalidateAttachmentsFlag=!0),this._invalidateFlag||(this._hotSpot=null,this._bodyRect=null,this._invalidateFlag=!0,this.invalidateZoom(),this.setAttachmentVisible&&this.setAttachmentVisible(!1))},invalidateZoom:function(){this._zoomBodyRect=null,this._zoomViewRect=null,this._zoomHotSpot=null},updateStyle:function(){this._innerColor=this._network.getInnerColor(this._element),this._outerColor=this._network.getOuterColor(this._element),this._glowBlur=this._element.getStyle("glow.blur"),this._shadowColor=this._network.getShadowColor(this._element),this._shadowXOffset=this._element.getStyle("shadow.xoffset"),this._shadowYOffset=this._element.getStyle("shadow.yoffset"),this._shadowBlur=this._element.getStyle("shadow.blur"),this._wholeAlpha=this._element.getStyle("whole.alpha")},validate:function(){var a=this;if(0!=this._invalidateFlag){this._bodyBounds.clear(),this._invalidateAttachmentsFlag&&(this._invalidateAttachmentsFlag=!1,this.checkAttachments()),this._invalidateFlag=!1,this.updateStyle(),this.validateImpl(),this._attachments.forEach(function(a){a.validate()});var b;this._bodyBounds.forEach(function(a){b=Rb.unionRect(b,a)}),null==b&&(b=Hb.cloneRect(this._element.getLocation()),b.width=0,b.height=0),this._unionBodyBounds={x:b.x,y:b.y,width:b.width,height:b.height},this._attachments.forEach(function(c){b=c instanceof Gb.vector.EditAttachment?c.getElementUI()instanceof Gb.vector.LinkUI?Rb.unionRect(b,c._viewRect):Rb.unionRect(b,a._network.zoomManager._reverseElementZoomRect(a,c._viewRect)):c.getElementUI()instanceof Gb.vector.LinkUI?Rb.unionRect(b,a._network.zoomManager._getAttachmentZoomOutLineRect(c,c._viewRect)):c.getElementUI()instanceof Gb.vector.GroupUI&&c.getElementUI()._shapeRect?c instanceof Gb.vector.IconsAttachment?Rb.unionRect(b,c._viewRect):Rb.unionRect(b,a._network.zoomManager._getAttachmentZoomOutLineRect(c,c._viewRect)):Rb.unionRect(b,c._viewRect)}),this._viewRect=b}},validateImpl:function(){},setGlow:function(a,b){"glow"===this._element.getStyle("outer.style")&&(b.shadowColor=this._outerColor,b.shadowOffsetX=0,b.shadowOffsetY=0,b.shadowBlur=this._glowBlur)},clearGlow:function(a){(0!=a.shadowOffsetX||0!=a.shadowOffsetY||0!=a.shadowBlur)&&(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0)},setShadow:function(a,b){var c=this._network.zoomManager,d=a.isShadowable()&&this._shadowColor&&!this._editAttachment;if(b.shadowOffsetX===this._shadowXOffset&&b.shadowOffsetY===this._shadowYOffset&&b.shadowBlur===this._shadowBlur)return b;if(d||this._network._showShadowInEdit){var e=c.getGraphicsZoom(),f=c.getSizeZoom();e*=f,e>1&&(e=1),b.shadowOffsetX=this._shadowXOffset*e,b.shadowOffsetY=this._shadowYOffset*e,b.shadowBlur=this._shadowBlur*e,b.shadowColor=this._shadowColor}return b},clearShadow:function(a){(0!=a.shadowOffsetX||0!=a.shadowOffsetY||0!=a.shadowBlur)&&(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0)},appendShadowBound:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;if(c){var d=this._network.zoomManager,e=d.getGraphicsZoom(),f=d.getSizeZoom();e*=f,e>1&&(e=1),this._shadowXOffset>0?b.width+=this._shadowXOffset:(b.x+=this._shadowXOffset,b.width+=-this._shadowXOffset),this._shadowYOffset>0?b.height+=this._shadowYOffset:(b.y+=this._shadowYOffset,b.height+=-this._shadowYOffset);var g=this._shadowBlur;g=Math.ceil(g/e),Rb.grow(b,g+1,g+1)}return b},appendGlowBound:function(a,b){if("glow"===this._element.getStyle("outer.style")){var c=this._network.zoomManager,d=c.getGraphicsZoom(),e=c.getSizeZoom();d*=e,d>1&&(d=1);var f=this._glowBlur;f=Math.ceil(f/d),Rb.grow(b,f+1,f+1)}},isShadowable:function(){return this._shadowColor&&this._network.isSelected(this._element)&&"shadow"===this._element.getStyle("select.style")?!0:!1},addAttachment:function(a){this._attachments.add(a),this.invalidate(!1)},removeAttachment:function(a){this._attachments.remove(a),this.invalidate(!1)},getAttachments:function(){return this._attachments},checkAttachments:function(){this.checkLabelAttachment(),this.checkLabel2Attachment(),this.checkAlarmAttachment(),this.checkIconsAttachment(),this.checkEditAttachment()},checkLabelAttachment:function(){var a=this._network.getLabel(this._element);null!=a&&""!==a?this._labelAttachment||(this._labelAttachment=new Gb.vector.LabelAttachment(this,Dd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkLabel2Attachment:function(){var a=this._network.getLabel2(this._element);null!=a&&""!==a?this._label2Attachment||(this._label2Attachment=new Gb.vector.Label2Attachment(this,Dd.SHOW_LABEL2_IN_ATTACHMENT_DIV),this.addAttachment(this._label2Attachment)):this._label2Attachment&&(this.removeAttachment(this._label2Attachment),this._label2Attachment=null)},checkAlarmAttachment:function(){var a=this._network.getAlarmLabel(this._element);null!=a&&""!==a?this._alarmAttachment||(this._alarmAttachment=new Gb.vector.AlarmAttachment(this,Dd.SHOW_ALARM_IN_ATTACHMENT_DIV),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},checkIconsAttachment:function(){var a=this._network.getIconsNames(this._element);a&&a.length>0?this._iconsAttachment||(this._iconsAttachment=new Gb.vector.IconsAttachment(this,Dd.SHOW_ICON_IN_ATTACHMENT_DIV),this.addAttachment(this._iconsAttachment)):this._iconsAttachment&&(this.removeAttachment(this._iconsAttachment),this._iconsAttachment=null)},checkEditAttachment:function(){this._network.hasEditInteraction()&&this._network.isSelected(this._element)&&this._network.isEditable(this._element)&&this.isEditable()?this._editAttachment||(this._editAttachment=new Gb.vector.EditAttachment(this,Dd.SHOW_EDIT_IN_ATTACHMENT_DIV),this.addAttachment(this._editAttachment)):this._editAttachment&&(this.removeAttachment(this._editAttachment),this._editAttachment=null)},getLabelAttachment:function(){return this._labelAttachment},getAlarmAttachment:function(){return this._alarmAttachment},getIconsAttachment:function(){return this._iconsAttachment},getEditAttachment:function(){return this._editAttachment},isEditable:function(){return!0},getInnerColor:function(){return this._innerColor},getOuterColor:function(){return this._outerColor},getShadowColor:function(){return this._shadowColor},getDyeColor:function(a){return this._innerColor?this._innerColor:this.getStyle(a)},getStyle:function(a){return this._element.getStyle(a)},getFont:function(a){var b=this._element.getStyle(a);return b?b:Gb.Defaults.FONT},paint:function(a){a.save(),a.globalAlpha=this._wholeAlpha,a.beginPath(),this.paintBody(a),this.clearShadow(a),this.clearGlow(a),a.closePath(),a.beginPath(),this.paintAttachments(a),a.closePath(),a.restore(),this._network._debug&&Vb.strokeRect(a,this.getZoomBodyRect(),"orange")},paintBody:function(a){},getZoomBodyRect:function(a){return this._network.zoomManager._getElementZoomRect(this,this.getBodyRect())},getZoomHotSpot:function(){return this._zoomHotSpot||(this._zoomHotSpot=this._network.zoomManager._getZoomHotSpot(this,this._hotSpot)),Hb.clone(this._zoomHotSpot)},getZoomPointers:function(a,b){return this._network.zoomManager._getZoomPointers(a,this,b)},_getZoomViewRect:function(a,b,c){var d=this._network.zoomManager;if(b){var e=Hb.cloneRect(d._getAttachmentZoomRect(b,a));return e}var f=d.getLocationZoom(),g=d.getSizeZoom(this),h=this._bodyRect?this._bodyRect:this.getBodyRect();a=a||{x:h.x,y:h.y,width:0,height:0};var i=h.x+h.width/2,j=h.y+h.height/2;return{x:i*f+(a.x-i)*g,y:j*f+(a.y-j)*g,width:a.width*g,height:a.height*g}},getZoomViewRect:function(a){{var b=this._network.zoomManager,c=b.getLocationZoom();b.getGraphicsZoom()}if(1==c)return Hb.cloneRect(this._viewRect);if(!this._zoomViewRect||a){var d,e=this._getZoomViewRect(Hb.cloneRect(this._unionBodyBounds),!1);d=Rb.unionRect(d,e);this._attachments.forEach(function(a){d=a instanceof Gb.vector.EditAttachment?Rb.unionRect(d,a._viewRect):Rb.unionRect(d,a.getZoomViewRect())}),this._zoomViewRect=d}return Hb.cloneRect(this._zoomViewRect)},paintAttachments:function(a){a.beginPath();for(var b=this._attachments.size(),c=0;b>c;c++){var d=this._attachments.get(c);(this._network.isShowAttachOnChg()||this._network.isVisibleAttachment(d))&&(1==this._hitTest&&0==d.isShowOnTop()&&this.paintAttachment(a,d),1==this._intersectTest&&this.paintAttachment(a,d),0==this._hitTest&&0==this._intersectTest&&(d.isShowOnTop()?this._network._topAttachmentList.add(d):this.paintAttachment(a,d)))}},paintAttachment:function(a,b){var c=this._network.zoomManager;c.isAttachmentVisible(this._element)&&(b!=this._labelAttachment&&b!=this._label2Attachment||c.isLabelVisible(this._element))&&(b!=this._alarmAttachment||c.isAlarmBalloonVisible(this._element))&&(a.beginPath(),b.paint(a),this.clearShadow(a))},getViewRect:function(){return Hb.cloneRect(this._viewRect)},getUnionBodyBounds:function(){return Hb.cloneRect(this._unionBodyBounds)},addBodyBounds:function(a){a&&this._bodyBounds.add(a)},getBodyRect:function(a){return void 0==a&&(a=!0),this._bodyRect||(this._bodyRect=this.createBodyRect()),a?Hb.cloneRect(this._bodyRect):this._bodyRect},getHotSpot:function(){return this._hotSpot?Hb.clone(this._hotSpot):{x:0,y:0}},setHotSpot:function(a){this._hotSpot=a},hit:function(a,b){return!1},intersects:function(a){return Rb.contains(a,this.getZoomViewRect())?!0:!1},hitCanvasRectAtBody:function(a){a.width<1&&(a.width=1),a.height<1&&(a.height=1);var b=Od.getHitCanvas(a.width,a.height),c=Od.getCtx(b);if(c.save(),c.translate(-a.x,-a.y),this._element.getImage){var d=Hb.getImageAsset(this._element.getImage());if(d&&d.getImage()instanceof Hd)return 1}this.paintBody(c);try{for(var e=c.getImageData(0,0,a.width,a.height),f=e.data,g=0;g<e.width;g++)for(var h=0;h<e.height;h++){var i=4*(h*e.width+g),j=f[i+3];if(0!==j)return c.restore(),1}}catch(k){if(Od.disposeHitCanvas(),Rb.contains(this.getUnionBodyBounds(),a))return 0}return c.restore(),-1},hitCanvasRectAtAttachments:function(a){var b=Od.getHitCanvas(a.width,a.height),c=Od.getCtx(b);c.save(),c.translate(-a.x,-a.y),this.paintAttachments(c);try{for(var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=0;f<d.width;f++)for(var g=0;g<d.height;g++){var h=4*(g*d.width+f),i=e[h+3];if(0!==i)return c.restore(),1}}catch(j){Od.disposeHitCanvas()}return c.restore(),-1},hitCanvasRect:function(a){this._intersectTest=!0,1==this._hitTest&&(this._intersectTest=!1);var b=Rb.intersection(a,this.getZoomViewRect()),c=this.hitCanvasRectAtBody(b);if(1==c)return this._intersectTest=!1,!0;var d=this.hitCanvasRectAtAttachments(b);return 1==d?(this._intersectTest=!1,!0):(this._intersectTest=!1,0==c)},hitCanvasPoint:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._network.getSelectionTolerance();if(d&&d>0&&Rb.grow(c,d,d),!Rb.intersects(this.getZoomViewRect(),c))return!1;this._hitTest=!0;var e=this.hitCanvasRect(c);return this._hitTest=!1,e},hitTest:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._network.getSelectionTolerance();if(d&&d>0&&Rb.grow(c,d,d),!Rb.intersects(this.getZoomViewRect(),c))return null;for(var e=Rb.intersection(c,this.getZoomViewRect()),f=this._attachments.size(),g=0;f>g;g++){var h=this._attachments.get(g);if(h.hit(a,b))return h}var i=this.hitCanvasRectAtBody(e);return 1==i?this:0==i?this:null},dispose:function(){this._attachments.forEach(function(a){a.dispose()}),this._attachments.clear()}}),Gb.vector.NodeUI=function(a,b){Gb.vector.NodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.NodeUI",Gb.vector.ElementUI,{invalidate:function(a){this.curInterval&&clearInterval(this.curInterval),Gb.vector.NodeUI.superClass.invalidate.call(this,a)},createBodyRect:function(){return this._element.getRect()},validateImpl:function(){Gb.vector.NodeUI.superClass.validateImpl.call(this);var a=this.getStyle("vector.shape"),b=this.getBodyRect();this._hotSpot=Rb.getHotSpot(b.x,b.y,b.width,b.height,a),this.validateBodyBounds()},validate:function(){0!=this._invalidateFlag&&Gb.vector.NodeUI.superClass.validate.call(this)},validateBodyBounds:function(){var a=this.getStyle("body.type");"default"===a?this.addBodyBounds(this.getDefaultBodyRect()):"vector"===a?this.addBodyBounds(this.getVectorBody()):"default.vector"===a?(this.addBodyBounds(this.getVectorBody()),this.addBodyBounds(this.getDefaultBodyRect())):"vector.default"===a&&(this.addBodyBounds(this.getDefaultBodyRect()),this.addBodyBounds(this.getVectorBody())),this._outerColor&&"border"===this.getStyle("outer.style")&&this.addBodyBounds(this.getOuterBorderRect()),!this._editAttachment&&"border"===this.getStyle("select.style")&&this._network.isSelected(this._element)&&this.addBodyBounds(this.getSelectBorderRect())},getDefaultBodyRect:function(){var a=this._element,b=this.getBodyRect();if(!a.getImage()||"string"==typeof a.getImage()&&!Hb.getImageAsset(a.getImage()))return b;Rb.addPadding(b,this._element,"image.padding",1);var c=Hb.cloneRect(b);return this.appendGlowBound(this,c),this.appendShadowBound(this,c),b=c},getVectorBody:function(){var a=this.getPathRect("vector");return a},getOuterBorderRect:function(){return this._getBorderRect("outer")},getSelectBorderRect:function(){return this._getBorderRect("select")},_getBorderRect:function(a){var b=this._element,c=b.getStyle(a+".width"),d=b.getStyle("select.physicalZoom")?1:this._network.getGraphicsZoom();if(c>0){c="select"===a?c/d:c;var e=this.getBodyRect();Rb.addPadding(e,b,a+".padding","select"===a?1/d:1);var f=Hb.cloneRect(e);return Rb.grow(f,2*c,2*c),f}return null},getPathRect:function(a,b){{var c=this._element,d=this.getBodyRect();this._network.zoomManager.getSizeZoom()}b&&Rb.addPadding(d,c,a+".padding",1);var e=Hb.cloneRect(d),f=c.getStyle(a+".outline.width");if(f>0)if(this._getZoomPoints){for(var g=this._element._points,h=g.size(),i=0,j=0;h>j;j++){if(0==j)var k=g.get(j),l=g.get(h-1),m=g.get(j+1);else if(j==h-1)var k=g.get(j),l=g.get(j-1),m=g.get(0);else var k=g.get(j),l=g.get(j-1),m=g.get(j+1);var n=Rb.getCenterPoint(l,m),o=Rb.getAngle(n,k),p=Math.abs(5*(f+1)*Math.sin(o));i=p>i?p:i,p=Math.abs(5*(f+1)*Math.cos(o)),i=p>i?p:i}Rb.grow(e,i,i)}else Rb.grow(e,f/2,f/2);return this.appendGlowBound(this,e),this.appendShadowBound(this,e),e},getZoomPathRect:function(a,b){{var c=this._element,d=this.getZoomBodyRect();this._network.zoomManager.getSizeZoom()}b&&Rb.addPadding(d,c,a+".padding",1);var e=Hb.cloneRect(d),f=c.getStyle(a+".outline.width");if(f>0)if(this._getZoomPoints){for(var g=this._getZoomPoints(),h=g.size(),i=0,j=0;h>j;j++){if(0==j)var k=g.get(j),l=g.get(h-1),m=g.get(j+1);else if(j==h-1)var k=g.get(j),l=g.get(j-1),m=g.get(0);else var k=g.get(j),l=g.get(j-1),m=g.get(j+1);var n=Rb.getCenterPoint(l,m),o=Rb.getAngle(n,k),p=Math.abs(5*(f+1)*Math.sin(o));i=p>i?p:i,p=Math.abs(5*(f+1)*Math.cos(o)),i=p>i?p:i}Rb.grow(e,i,i)}else Rb.grow(e,f/2,f/2);return this.appendGlowBound(this,e),this.appendShadowBound(this,e),e},paintBody:function(a){this.curInterval&&clearInterval(this.curInterval);var b=this.getStyle("body.type");"default"===b?this.drawDefaultBody(a):"vector"===b?this.drawVectorBody(a):"default.vector"===b?(this.drawVectorBody(a),this.drawDefaultBody(a)):"vector.default"===b&&(this.drawDefaultBody(a),this.drawVectorBody(a)),this._outerColor&&"border"===this.getStyle("outer.style")&&this.drawOuterBorder(a),"border"===this.getStyle("select.style")&&this._network.isSelected(this._element)&&this.drawSelectBorder(a)},drawOuterBorder:function(a){var b=this._element,c=b.getStyle("outer.width");if(c>0){var d=this.getZoomBodyRect();Rb.addPadding(d,b,"outer.padding",1),a.lineWidth=c,a.lineCap=b.getStyle("outer.cap"),a.lineJoin=b.getStyle("outer.join"),a.strokeStyle=this._outerColor,Vb.drawVector(a,b.getStyle("outer.shape"),null,d),a.stroke()}},drawDefaultBody:function(a){var b,c=this._element;if(c.getImage()&&("string"!=typeof c.getImage()||(b=Hb.getImageAsset(c.getImage())))&&(!this._shapeRect||c.getStyle("group.expend.image")&&("string"!=typeof c.getStyle("group.expend.image")||(b=Hb.getImageAsset(c.getStyle("group.expend.image")))))){var d=this.getZoomBodyRect();Rb.addPadding(d,this._element,"image.padding",1),0!=c.getAngle()&&(a.save(),d=c.getOriginalRect(),d=this._network.zoomManager._getElementZoomRect(this,d),Gb.Util.rotateCanvas(a,d,c.getAngle())),this.setGlow(this,a),this.setShadow(this,a);if(b&&b.getImage()instanceof Hd){var e,f=b.getImage().frames,g=b.getImage().size,h=0;e=Jd(f,g,0),a.drawImage(e,d.x,d.y,d.width,d.height),this.curInterval=setInterval(function(){h=(h+f.length)%f.length,e=Jd(f,g,h),a.drawImage(e,d.x,d.y,d.width,d.height),h++},100)}else this._shapeRect?Mc(a,c.getStyle("group.expend.image"),this.getInnerColor(),d,c,this._network):Mc(a,c.getImage(),this.getInnerColor(),d,c,this._network);0!=c.getAngle()&&a.restore()}},drawSelectBorder:function(a){this.clearGlow(a);var b=this._element,c=b.getStyle("select.width");if(c>0){var d=this.getZoomBodyRect();d=Hb.cloneRect(d);var e=b.getStyle("select.physicalZoom")?1:this._network.getGraphicsZoom();Rb.addPadding(d,b,"select.padding",1/e),Rb.grow(d,c/2/e,c/2/e),a.lineWidth=c/e,a.lineCap=b.getStyle("select.cap"),a.lineJoin=b.getStyle("select.join"),a.strokeStyle=b.getStyle("select.color"),Vb.drawVector(a,b.getStyle("select.shape"),null,d),a.stroke()}},drawVectorBody:function(a){this.drawPath(a,"vector",!0,this._element.getStyle("vector.outline.pattern"));var b=this.getStyle("vector.deep"),c=this.getStyle("vector.fill.color");if(0!==b&&c&&"rectangle"===this.getStyle("vector.shape")){var d=this.getZoomBodyRect(),e=this._element.getAngle();if(0!=e){a.save();var f=this._element.getOriginalRect();f=this._network.zoomManager._getElementZoomRect(this,f),Gb.Util.rotateCanvas(a,f,e)}Vb.draw3DRect(a,c,b,d),0!=e&&a.restore()}},drawPath:function(a,b,c,d,e,f,g){var h=this._network.zoomManager,i=this._element,j=null;j="group"==b?this._shapeRect:this.getZoomBodyRect(),c&&Rb.addPadding(j,i,b+".padding",1);var k=i.getStyle(b+".outline.width");this.setGlow(this,a),this.setShadow(this,a),0!=i.getAngle()&&(i instanceof Nd||(j=i.getOriginalRect(),j=h._getElementZoomRect(this,j)),a.save(),Gb.Util.rotateCanvas(a,j,i.getAngle()));var l,m=i.getStyle(b+".fill");if(m){l=this._innerColor&&!uc.hasDefault(this._element)?this._innerColor:i.getStyle(b+".fill.color");var n=i.getStyle(b+".gradient");n?Vb.fill(a,l,n,i.getStyle(b+".gradient.color"),j):a.fillStyle=l}var o=i.getStyle(b+".shape"),p=i.getStyle("group.shape.roundrect.radius");0>p&&(p=10),m&&(a.beginPath(),e?Vb.drawLinePoints(a,e,null,f,g):"roundrect"===o&&"group"===b?Vb.drawVector(a,o,null,j,p):Vb.drawVector(a,o,null,j),a.fill()),k>0&&(a.lineWidth=k,a.lineCap=i.getStyle(b+".cap"),a.lineJoin=i.getStyle(b+".join"),a.strokeStyle=i.getStyle(b+".outline.color"),a.beginPath(),e?Vb.drawLinePoints(a,e,d,f,g):"roundrect"===o&&"group"===b?Vb.drawVector(a,o,d,j,p):Vb.drawVector(a,o,d,j),a.stroke()),0!=i.getAngle()&&a.restore()},hit:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._network.getSelectionTolerance();if(d&&d>0&&Rb.grow(c,d,d),this._network._transparentSelectionEnable){var e=this.getBodyRect();if(Hb.math.intersects(e,c))return!0}return Rb.intersects(this.getZoomViewRect(),c)?this.hitCanvasPoint(a,b):!1},intersects:function(a){var b=Gb.vector.NodeUI.superClass.intersects.apply(this,arguments);if(1==b)return!0;if(this._network._transparentSelectionEnable){var c=this.getBodyRect();if(Hb.math.intersects(c,a))return!0}return Rb.intersects(a,this.getZoomViewRect())?this.hitCanvasRect(a):!1}}),Gb.vector.LinkUI=function(a,b){Gb.vector.LinkUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.LinkUI",Gb.vector.ElementUI,{isEditable:function(){return!0},invalidate:function(a){this._linkPoints=null,this._fromPoint=null,this._toPoint=null,this._angle=null,Gb.vector.LinkUI.superClass.invalidate.call(this,a)},invalidateZoom:function(){this._fromPoint=null,this._toPoint=null,this._linkPoints=null,Gb.vector.LinkUI.superClass.invalidateZoom.call(this)},validateImpl:function(){this.validateBodyBounds(),Gb.vector.LinkUI.superClass.validateImpl.call(this)},validateBodyBounds:function(){var a=this.getLinkPoints();if(a&&!(a.size()<2)){var b=this._element,c=Rb.getLineRect(a),d=b.getStyle("link.width"),e=d;if(this._outerColor){var f=b.getStyle("outer.width");e+=2*f}var g=!this._editAttachment&&"border"===b.getStyle("select.style")&&this._network.isSelected(this._element);if(g){var h=b.getStyle("select.width");e+=2*h}Rb.grow(c,e/2,e/2),b.getStyle("arrow.from")&&(this._network._edgeDetect?(this._network._debug&&(this._arrowFromRect=nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),0,0,this._network.zoomManager)),c=Rb.unionRect(c,nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),0,0,this._network.zoomManager))):(this._network._debug&&(this._arrowFromRect=nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset"),this._network.zoomManager)),c=Rb.unionRect(c,nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset"),this._network.zoomManager)))),b.getStyle("arrow.to")&&(this._network._edgeDetect?(this._network._debug&&(this._arrowToRect=nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),0,0,this._network.zoomManager)),c=Rb.unionRect(c,nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),0,0,this._network.zoomManager))):(this._network._debug&&(this._arrowToRect=nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset"),this._network.zoomManager)),c=Rb.unionRect(c,nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset"),this._network.zoomManager)))),this.appendShadowBound(this,c),this.addBodyBounds(c),this._growLinkJoinBounds(c,e)}},_growLinkJoinBounds:function(a,b){},createBodyRect:function(){var a=this.getHotSpot();return a?{x:a.x-1,y:a.y-1,width:2,height:2}:null},paintBody:function(a){var b=this.getLinkPoints();if(b&&!(b.size()<2)){var c=this._element,d=c.isBundleAgent()&&c.getStyle("link.agent"),e=c.getStyle(d?"link.agent.width":"link.width"),f=e;if(this._outerColor&&"border"===this.getStyle("outer.style")){var g=c.getStyle("outer.width");f+=2*g}var h=!this._editAttachment&&"border"===c.getStyle("select.style")&&this._network.isSelected(this._element);if(h){var i=c.getStyle("select.width");f+=2*i}this.setGlow(this,a),this.setShadow(this,a),a.lineCap=c.getStyle(d?"link.agent.cap":"link.cap"),a.lineJoin=c.getStyle(d?"link.agent.join":"link.join");var j=c.getStyle(d?"link.agent.pattern":"link.pattern");h&&this.drawLinePoints(a,b,f,c.getStyle("select.color"),j),this._outerColor&&"border"===this.getStyle("outer.style")&&this.drawLinePoints(a,b,e+2*g,this._outerColor,j),this.drawLinePoints(a,b,e,this._innerColor||c.getStyle(d?"link.agent.color":"link.color"),j),nd.drawLinkArrow(this,a,b,this._network.zoomManager),this._network._debug&&(Vb.strokeRect(a,this._arrowToRect,Gb.Util.randomColor()),Vb.strokeRect(a,this._arrowFromRect,Gb.Util.randomColor()))}},drawLinePoints:function(a,b,c,d,e){a.lineWidth=c,a.strokeStyle=d;var f=this._element.isBundleAgent()&&this._element.getStyle("link.agent");if(this._element.getStyle(f?"link.agent.flow":"link.flow")===!0&&e&&e.length>1){var g=new tc(a,e[0],e[1]),h=this._element.getStyle(f?"link.agent.flow.offset":"link.flow.offset"),i=Math.floor(h/(e[0]+e[1]));i>2&&(h-=(e[0]+e[1])*i),this._element.getStyle(f?"link.agent.flow.converse":"link.flow.converse")?h<e[0]?g.overflow=e[0]-h:h>=e[0]&&h<=e[0]+e[1]?(g.overflow=e[1]-(h-e[0]),g.overflow&&(g.isLine=!1)):(h-=e[0]+e[1],g.overflow=e[0]-h):h<=e[1]?(g.overflow=h,h&&(g.isLine=!1)):h>e[1]&&h<=e[0]+e[1]?g.overflow=h-e[1]:(h-=e[0]+e[1],h&&(g.isLine=!1),g.overflow=h),this._element._styleMap[f?"link.agent.flow.offset":"link.flow.offset"]=h,a.beginPath(),Vb._drawLine(b,a),a.stroke(),a.shadowColor="transparent",a.beginPath();var j=this._element.getStyle(f?"link.agent.flow.color":"link.flow.color");j=j?j:Dd.NETWORK_LINK_FLOW_COLOR,a.strokeStyle=j,Vb._drawLine(b,g),a.stroke(),a.shadowColor=this._shadowColor}else a.beginPath(),Vb.drawLinePoints(a,b,e),a.stroke()},getLinkPoints:function(){return this._linkPoints||(this._linkPoints=this.createLinkPoints(),this._lineLength=Rb.calculateLineLength(this._linkPoints)),this._linkPoints},getFromPosition:function(a,b){var c=this.getFromPoint();return c?{x:c.x+a,y:c.y+b}:null},getToPosition:function(a,b){var c=this.getToPoint();return c?{x:c.x+a,y:c.y+b}:null},getFromPoint:function(){return this._fromPoint||(this._fromPoint=wc.createFromPoint(this,this._network.zoomManager)),this._fromPoint},getToPoint:function(){return this._toPoint||(this._toPoint=wc.createToPoint(this,this._network.zoomManager)),this._toPoint},getZoomBodyRect:function(){return this.getBodyRect()},getZoomViewRect:function(){return this._viewRect},createLinkPoints:function(){var a=this._network.zoomManager,b=this.getStyle("link.type"),c=new Gb.List;if(wc.isOrthogonalOrFlexionalLink(this._element))c=wc.orthogonalAndFlexional(this,b,a);else if(this._element.isLooped()){var d=this._network.getElementUI(this._element.getFromAgent());null!=d&&(this._hotSpot=wc.fillLoopedPoints(this,d.getZoomBodyRect(),c))}else{if("arc"!==b&&"triangle"!==b&&"parallel"!==b)throw"Can not resolve link type '"+b+"'";var e=this.getFromPoint(),f=this.getToPoint();this._hotSpot=wc.fillBundlePoints(this,b,e,f,c,a)}if(this._network._linkPathFunction){var g=this._network._linkPathFunction(this,c);g&&(c=g)}return c},checkAttachments:function(){Gb.vector.LinkUI.superClass.checkAttachments.call(this),this.checkLinkHandlerAttachment()},checkLinkHandlerAttachment:function(){var a=this._network.getLinkHandlerLabel(this._element);null!=a&&""!==a?this._linkHandlerAttachment||(this._linkHandlerAttachment=new Gb.vector.LinkHandlerAttachment(this),this.addAttachment(this._linkHandlerAttachment)):this._linkHandlerAttachment&&(this.removeAttachment(this._linkHandlerAttachment),this._linkHandlerAttachment=null)},getLinkHandlerAttachment:function(){return this._linkHandlerAttachment},getControlPoint:function(){return wc.getControlPoint(this._element,this,this._network.zoomManager)},setControlPoint:function(a){if(a){var b=this.getStyle("link.type");if(wc.hasControlPoint(b)){var c=wc.getLinkSourceBounds(this,this._network.zoomManager),d=wc.getLinkTargetBounds(this,this._network.zoomManager);wc.setParamsByControlPoint(a,c,d,b,this._element)}}},getLineLength:function(){return this._lineLength},hit:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._network.getSelectionTolerance();return d&&d>0&&Rb.grow(c,d,d),Rb.intersects(this._viewRect,c)?this.hitCanvasPoint(a,b):!1},intersects:function(a){var b=Gb.vector.NodeUI.superClass.intersects.apply(this,arguments);if(1==b)return!0;if(0==Rb.intersects(a,this._viewRect))return!1;var c=this.getLinkPoints(),d=c.size();if(2==d)for(var e=0;d>e;e+=2){var f=c.get(e);if(d>e+1){var g=c.get(e+1);if(Od.intersectsLine(f.x,f.y,g.x,g.y,a.x,a.y,a.width,a.height))return!0}}return this.hitCanvasRect(a)},getAngle:function(){return!this._angle&&this._fromPoint&&this._toPoint&&(this._angle=Rb.getAngle(this._fromPoint,this._toPoint)),this._angle||0},getAbsoluteAngle:function(){var a={x:10,y:0},b=this._fromPoint,c=this._toPoint,d={x:c.x-b.x,y:c.y-b.y},e=180*Math.acos((d.x*a.x+d.y*a.y)/(Math.sqrt(a.x*a.x+a.y*a.y)*Math.sqrt(d.x*d.x+d.y*d.y)))/Math.PI;return e=b.y<=c.y?e:360-e,e=e%360*Math.PI/180},appendShadowBound:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;if(c){this._shadowXOffset>0?b.width+=this._shadowXOffset:(b.x+=this._shadowXOffset,b.width+=-this._shadowXOffset),this._shadowYOffset>0?b.height+=this._shadowYOffset:(b.y+=this._shadowYOffset,b.height+=-this._shadowYOffset);var d=this._shadowBlur;Rb.grow(b,d+1,d+1)}return b}}),Gb.vector.GroupUI=function(a,b){Gb.vector.GroupUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.GroupUI",Gb.vector.NodeUI,{isEditable:function(){return!this._element.isExpanded()},paintBody:function(a){this._shapeRect?this._element.getStyle("group.expend.image")?(Gb.vector.GroupUI.superClass.paintBody.apply(this,arguments),
this._element.getStyle("group.expend.image.vector")&&this.drawExpandedGroup(a)):this.drawExpandedGroup(a):Gb.vector.GroupUI.superClass.paintBody.apply(this,arguments)},validateBodyBounds:function(){if(this.getBodyRect(),this._shapeRect){var a=this.getPathRect("group",!1),b=this.getStyle("group.deep");Rb.grow(a,b+1,b+1),this.addBodyBounds(a)}else Gb.vector.GroupUI.superClass.validateBodyBounds.call(this)},getZoomBodyRect:function(){return this._element.isExpanded()?this.getBodyRect():Gb.vector.GroupUI.superClass.getZoomBodyRect.call(this)},getZoomViewRect:function(){return this._element.isExpanded()?this.getViewRect():Gb.vector.GroupUI.superClass.getZoomViewRect.call(this)},drawExpandedGroup:function(a){this.drawPath(a,"group",!1,this._element.getStyle("vector.outline.pattern"));var b=this.getStyle("group.deep"),c=this.getStyle("group.fill.color");0!==b&&c&&"rectangle"===this.getStyle("group.shape")&&Vb.draw3DRect(a,c,b,this._shapeRect)},getChildrenRects:function(){return this._network.getGroupChildrenRects(this._element)},createBodyRect:function(){this._shapeRect=null;var a=this._element,b=this._network;if(a.isExpanded()){a.getChildren().forEach(function(a){var c=b.getElementUI(a);c&&c.validate()});var c=this.getChildrenRects();if(!c.isEmpty()){var d=a.getStyle("group.shape"),e=Sb[d];if(!e)throw"Can not resolve group shape '"+d+"'";this._shapeRect=e(c)}}return this._shapeRect?(Rb.addPadding(this._shapeRect,a,"group.padding",1),this._shapeRect):Gb.vector.GroupUI.superClass.createBodyRect.call(this)},appendShadowBound:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;if(c){this._shadowXOffset>0?b.width+=this._shadowXOffset:(b.x+=this._shadowXOffset,b.width+=-this._shadowXOffset),this._shadowYOffset>0?b.height+=this._shadowYOffset:(b.y+=this._shadowYOffset,b.height+=-this._shadowYOffset);var d=this._shadowBlur;Rb.grow(b,d+1,d+1)}return b}}),Gb.vector.ShapeNodeUI=function(a,b){Gb.vector.ShapeNodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.ShapeNodeUI",Gb.vector.NodeUI,{getDefaultBodyRect:function(){return this._element._points.size()<2?null:this._reverseZoomPathRect()},drawDefaultBody:function(a){this._element._points.size()<2||(this.drawPath(a,"vector",!0,this._element.getStyle("vector.outline.pattern"),this._getZoomPoints(),this._element._segments,this._element.getStyle("shapenode.closed")),nd.drawLinkArrow(this,a,Rb.getPointObject(this._element._points,this._element._segments)))},invalidateZoom:function(){this._zoomPoints=null,Gb.vector.LinkUI.superClass.invalidateZoom.call(this)},_getZoomPoints:function(){return this._zoomPoints=this._network.zoomManager._getShapeNodeZoomPoints(this,this._element._points),this._zoomPoints},_reverseZoomPathRect:function(){return this._network.zoomManager._reverseElementZoomRect(this,this.getZoomPathRect("vector",!0))}}),Gb.vector.ShapeLinkUI=function(a,b){Gb.vector.ShapeLinkUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.ShapeLinkUI",Gb.vector.LinkUI,{isEditable:function(){return!0},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=new Gb.List,d=this.getStyle("shapelink.type");c.add(a),null!=this._element._points&&c.addAll(this._network.zoomManager._getShapeLinkZoomPoints(this._element._points)),c.add(b);var e,f,g;if("lineto"===d);else if("quadto"===d){for(e=new Gb.List(c.get(0)),f=1,pointCount=c.size();f<pointCount;f++)e.add(f<pointCount-1?new Gb.List([c.get(f++),c.get(f)]):c.get(f));c=e}else if("cubicto"===d){for(e=new Gb.List(c.get(0)),f=1,pointCount=c.size();f<pointCount;f++)e.add(f<pointCount-2?new Gb.List([c.get(f++),c.get(f++),c.get(f)]):f<pointCount-1?new Gb.List([c.get(f++),c.get(f)]):c.get(f));c=e}else{if("orthogonalto"!==d)throw"Can not resolve shapelink type '"+d+"'";for(g=c.get(0),e=new Gb.List(g),f=1,pointCount=c.size();f<pointCount;f++)if(f<pointCount-1){var h=Hb.clone(c.get(f)),i=h.x,j=h.y,k=i-g.x,l=j-g.y;Math.abs(k)>Math.abs(l)?(h.x=i,h.y=g.y):(h.x=g.x,h.y=j),g=h,e.add(g)}else e.add(c.get(f));c=e}var m,n,o,h,p,k,l,q=Rb.calculateLineLength(c)/2,r=c.size(),s=0,t=0;for(m=0;r>m;m++)if(h=c.get(m),0!=m){if(o=h,o instanceof md&&(o=o._as),o instanceof Array?(p=Rb.calculateCurveLength(n,o,1),n=o[o.length-1]):(l=h.y-n.y,k=h.x-n.x,p=Math.sqrt(k*k+l*l),n=o),t+=p,q>=s&&t>=q){var u=q-s,v=c.get(m-1);v instanceof md&&(v=v._as,v instanceof Array&&(v=v[v.length-1]));var w=c.get(m),x=Rb.getPathInfo(w,v,u,0,-1).point;this._hotSpot=Hb.clone(x)}s=t}else n=h;return c},_growLinkJoinBounds:function(a,b){Rb.grow(a,3*b,3*b)}}),Gb.vector.GridUI=function(a,b){Gb.vector.GridUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.GridUI",Gb.vector.NodeUI,{drawDefaultBody:function(a){this._element.getImage()?Gb.vector.GridUI.superClass.drawDefaultBody.apply(this,arguments):this.drawGridBody(a)},validateBodyBounds:function(){if(this._element.getImage())Gb.vector.GridUI.superClass.validateBodyBounds.call(this);else{var a=this.getBodyRect(),b=Hb.clone(a),c=this._element.getStyle("outer.width");Rb.grow(b,c,c),this.appendShadowBound(this,b),this.addBodyBounds(b)}},_getZoomCellRect:function(a,b){var c=this._element.getCellRect(a,b),d=this._element.getRect(),e=d.x+d.width/2,f=d.y+d.height/2,g=this.getZoomBodyRect(),h=g.width/d.width,i=g.x+g.width/2,j=0==e?1:i/e;return{x:e*j+(c.x-e)*h,y:f*j+(c.y-f)*h,width:c.width*h,height:c.height*h}},drawGridBody:function(a){var b=this.getStyle("grid.fill"),c=this.getStyle("grid.deep"),d=this.getStyle("grid.cell.deep");if(b||0!==c||0!==d){a.beginPath();var e=this.getZoomBodyRect(),f=this.getDyeColor("grid.fill.color");if(this.setGlow(this,a),this.setShadow(this,a),b&&(a.fillStyle=f,a.rect(e.x,e.y,e.width,e.height),a.fill()),a.closePath(),this.clearShadow(a),a.beginPath(),0!=c&&Vb.draw3DRect(a,f,c,e.x,e.y,e.width,e.height),a.closePath(),0!=d)for(var g=this.getStyle("grid.row.count"),h=this.getStyle("grid.column.count"),i=0;g>i;i++)for(var j=0;h>j;j++){var k=this._getZoomCellRect(i,j);null!=k&&(a.beginPath(),Vb.draw3DRect(a,f,d,k.x,k.y,k.width,k.height),a.closePath())}}}}),Gb.vector.RotatableNodeUI=function(a,b){Gb.vector.RotatableNodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.RotatableNodeUI",Gb.vector.NodeUI,{isEditable:function(){return!1},getDefaultBodyRect:function(){var a=this._element,b=Hb.getImageAsset(a.getImage()),c=this.getBodyRect();return b?(Rb.addPadding(c,this._element,"image.padding",1),c):c},drawDefaultBody:function(a){var b=this._element,c=Hb.getImageAsset(b.getImage());if(c){var d=this.getBodyRect();if(Rb.addPadding(d,this._element,"image.padding",1),c.getImage()){var e=this._element._getOrignalWidth(),f=this._element._getOrignalHeight(),g=this._element._getRotateRect();a.save(),a.translate(d.x-g.x+e/2,d.y-g.y+f/2),a.rotate(this._element._angle*Math.PI/180),a.drawImage(c.getImage(this._innerColor),-e/2,-f/2,e,f),a.restore()}else if(c.getSrc());else if(!c.getFunction())throw"ImageAsset '"+b.getImage()+" ' is empty"}}}),Gb.vector.HTMLNodeUI=function(a,b){Gb.vector.HTMLNodeUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.HTMLNodeUI",Gb.vector.NodeUI,{checkAttachments:function(){Gb.vector.NodeUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Gb.vector.HTMLNodeUI.superClass.checkLabelAttachment.call(this);var b=this._network.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Gb.vector.HTMLLabelAttachment(this,Dd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkLabel2Attachment:function(){var a=this._element.getStyle("attachment.label2.style");if(a&&"none"===a)return void Gb.vector.HTMLNodeUI.superClass.checkLabel2Attachment.call(this);var b=this._network.getLabel2(this._element);null!=b&&""!==b?this._label2Attachment||(this._label2Attachment=new Gb.vector.HTMLLabel2Attachment(this,Dd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._label2Attachment)):this._label2Attachment&&(this.removeAttachment(this._label2Attachment),this._label2Attachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Gb.vector.HTMLNodeUI.superClass.checkAlarmAttachment.call(this);var b=this._network.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Gb.vector.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},setAttachmentVisible:function(a){a?(this._labelAttachment&&this._labelAttachment.setVisibility("visible"),this._label2Attachment&&this._label2Attachment.setVisibility("visible"),this._alarmAttachment&&this._alarmAttachment.setVisibility("visible")):(this._labelAttachment&&this._labelAttachment.setVisibility("hidden"),this._label2Attachment&&this._label2Attachment.setVisibility("hidden"),this._alarmAttachment&&this._alarmAttachment.setVisibility("hidden"))},validateZIndex:function(a){this._labelAttachment&&this._labelAttachment.validateZIndex(a)}}),Gb.vector.HTMLLinkUI=function(a,b){Gb.vector.HTMLLinkUI.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.HTMLLinkUI",Gb.vector.LinkUI,{checkAttachments:function(){Gb.vector.LinkUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Gb.vector.HTMLLinkUI.superClass.checkLabelAttachment.call(this);var b=this._network.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Gb.vector.HTMLLabelAttachment(this,Dd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkLabel2Attachment:function(){var a=this._element.getStyle("attachment.label2.style");if(a&&"none"===a)return void Gb.vector.HTMLNodeUI.superClass.checkLabelAttachment.call(this);var b=this._network.getLabel2(this._element);null!=b&&""!==b?this._label2Attachment||(this._label2Attachment=new Gb.vector.HTMLLabel2Attachment(this,Dd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._label2Attachment)):this._label2Attachment&&(this.removeAttachment(this._label2Attachment),this._label2Attachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Gb.vector.HTMLLinkUI.superClass.checkAlarmAttachment.call(this);var b=this._network.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Gb.vector.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},setAttachmentVisible:function(a){a?(this._labelAttachment&&this._labelAttachment.setVisibility("visible"),this._label2Attachment&&this._label2Attachment.setVisibility("visible"),this._alarmAttachment&&this._alarmAttachment.setVisibility("visible")):(this._labelAttachment&&this._labelAttachment.setVisibility("hidden"),this._label2Attachment&&this._label2Attachment.setVisibility("hidden"),this._alarmAttachment&&this._alarmAttachment.setVisibility("hidden"))}}),Gb.vector.Attachment=function(a,b){this._ui=a,this._element=this._ui.getElement(),this._network=a.getNetwork(),this._showOnTop=b,b&&this._network._hitTestTopAttachmentList.add(this)},Hb.ext("twaver.vector.Attachment",Object,{getElement:function(){return this._element},getElementUI:function(){return this._ui},getNetwork:function(){return this._network},isShowOnTop:function(){return this._showOnTop===!0},setShowOnTop:function(a){this._showOnTop=a},getStyle:function(a){return this._ui.getStyle(a)},getFont:function(a){return this._ui.getFont(a)},getViewRect:function(){return Hb.clone(this._viewRect)},getAlpha:function(){return 1},validate:function(){},paint:function(a){},getZoomViewRect:function(){var a=this._network.zoomManager._getAttachmentZoomOutLineRect(this,this._viewRect);return a},hit:function(a,b){return Rb.containsPoint(this.getZoomViewRect(),a,b)?this.hitCanvasRect({x:a-1,y:b-1,width:2,height:2}):!1},hitCanvasRect:function(a){var b=Od.getHitCanvas(a.width,a.height),c=Od.getCtx(b);c.save(),c.translate(-a.x,-a.y),this.paint(c);try{for(var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=0;f<d.width;f++)for(var g=0;g<d.height;g++){var h=4*(g*d.width+f),i=e[h+3];if(0!==i)return c.restore(),!0}}catch(j){Od.disposeHitCanvas()}return c.restore(),!1},dispose:function(){this._network._hitTestTopAttachmentList.remove(this)},_rotatePoint:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_rotatePointList:function(a,b,c){var d=this,e=new Gb.List;return a.forEach(function(a){e.add(d._rotatePoint(a,b,c))}),e}}),Gb.vector.BasicAttachment=function(a,b){Gb.vector.BasicAttachment.superClass.constructor.call(this,a,b),this._roundRect={x:0,y:0,width:0,height:0},this._contentRect={x:0,y:0,width:0,height:0}},Hb.ext("twaver.vector.BasicAttachment",Gb.vector.Attachment,{paint:function(a){Gb.vector.BasicAttachment.superClass.paint.apply(this,arguments);var b=this.isFill(),c=this.getOutlineWidth(),d=this._network.zoomManager._getAttachmentZoomOutLineRect(this,this._roundRect);if(this.getElementUI().setGlow(this,a),this.getElementUI().setShadow(this,a),c>0||b){if(Vb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._network._debug&&Vb.strokeRect(a,d,"#C71585"),this._pointers){var e=this._ui.getZoomPointers(this,this._pointers);a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Vb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}},validate:function(){Gb.vector.BasicAttachment.superClass.validate.call(this),this.calculateMeasure();var a=this.getOutlineWidth();(null==a||0>=a)&&(a=1),this._viewRect=Rb.getRect(this._pointers),this._viewRect=Rb.unionRect(this._viewRect,this._roundRect),a>0&&Rb.grow(this._viewRect,2*a,2*a),this._viewRect=this._ui.appendShadowBound(this,this._viewRect);var b=this._element instanceof Gb.Link&&this._element.getStyle("link.label.rotatable");if(b){var c=this._viewRect.x+this._viewRect.width/2,d=this._viewRect.y+this._viewRect.height/2,e=Math.sqrt(this._viewRect.height*this._viewRect.height+this._viewRect.width*this._viewRect.width);this._viewRect={x:c-e,y:d-e,width:2*e,height:2*e}}},calculateMeasure:function(){var a=this.getContentWidth(),b=this.getContentHeight(),c=this.getCornerRadius(),d=this.getPointerLength(),e=this.getPointerWidth(),f=this.getPosition(),g=this.getXOffset(),h=this.getYOffset(),i=this._roundRect;i.width=a+c,i.height=b;var j;if(this._ui._element instanceof Gb.Link){var k,l=this._ui.getLinkPoints();k=this._ui.getLineLength?this._ui.getLineLength():this._ui._element.getLineLength(),Math.abs(g)>0&&Math.abs(g)<1?"from"===f?g*=k:"to"===f?g=k*(1-g):(g/=2,g+=.5,g*=k):"from"===f?g=g:"to"===f?g=k-g:g+=k/2;{var m,n=Rb.calculatePointInfoAlongLine(l,!0,g,h),o=n.point;n.angle}m="from"===f?this._ui.getFromPoint():"to"===f?this._ui.getToPoint():this._ui._hotSpot,g=o.x-m.x,h=o.y-m.y}if(d>0){var p=this.getDirection();j=this._network.getPosition(f,this._ui,null,g,h,!1);var q;if("aboveleft"===p)i.y=j.y-d-i.height,i.x=j.x-(i.width-c),q=Math.max(j.x-e,j.x-(i.width-c)+c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:q,y:j.y-d}];else if("aboveright"===p)i.y=j.y-d-i.height,i.x=j.x-c,q=Math.min(j.x+e,j.x-c+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:q,y:j.y-d}];else if("belowleft"===p)i.y=j.y+d,i.x=j.x-(i.width-c),q=Math.max(j.x-e,j.x-(i.width-c)+c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:q,y:j.y+d}];else if("belowright"===p)i.y=j.y+d,i.x=j.x-c,q=Math.min(j.x+e,j.x-c+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:q,y:j.y+d}];else if("leftabove"===p)i.y=j.y+c-i.height,i.x=j.x-d-i.width,q=Math.max(j.y-e,j.y+c-i.height+c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:q}];else if("leftbelow"===p)i.y=j.y-c,i.x=j.x-d-i.width,q=Math.min(j.y+e,j.y-c+i.height-c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:q}];else if("rightabove"===p)i.y=j.y+c-i.height,i.x=j.x+d,q=Math.max(j.y-e,j.y+c-i.height+c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:q}];else if("rightbelow"===p)i.y=j.y-c,i.x=j.x+d,q=Math.min(j.y+e,j.y-c+i.height-c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:q}];else if("above"===p)i.y=j.y-d-i.height,i.x=j.x-i.width/2,q=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-q,y:j.y-d},{x:j.x+q,y:j.y-d}];else if("below"===p)i.y=j.y+d,i.x=j.x-i.width/2,q=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-q,y:j.y+d},{x:j.x+q,y:j.y+d}];else if("left"===p)i.y=j.y-i.height/2,i.x=j.x-d-i.width,q=Math.min(b/2,e/2),this._pointers=[j,{x:j.x-d,y:j.y+q},{x:j.x-d,y:j.y-q}];else{if("right"!==p)throw"Can not resolve '"+p+"' attachment direction";i.y=j.y-i.height/2,i.x=j.x+d,q=Math.min(b/2,e/2),this._pointers=[j,{x:j.x+d,y:j.y+q},{x:j.x+d,y:j.y-q}]}}else j=this._network.getPosition(f,this._ui,{width:i.width,height:i.height},g,h,!1),i.x=j.x,i.y=j.y,this._pointers=null;this._contentRect.x=i.x+(i.width-a)/2,this._contentRect.y=i.y+(i.height-b)/2,this._contentRect.width=a,this._contentRect.height=b;var r=this.getPadding();0!=r&&Rb.grow(i,r,r),r=this.getPaddingLeft(),0!=r&&(i.x-=r,i.width+=r),r=this.getPaddingRight(),0!=r&&(i.width+=r),r=this.getPaddingTop(),0!=r&&(i.y-=r,i.height+=r),r=this.getPaddingBottom(),0!=r&&(i.height+=r),i.width<0&&(i.width=i.width,i.x-=i.width),i.height<0&&(i.height=-i.height,i.y-=i.height)},getContentWidth:function(){return Gb.Defaults.ATTACHMENT_CONTENT_WIDTH},getContentHeight:function(){return Gb.Defaults.ATTACHMENT_CONTENT_HEIGHT},getCornerRadius:function(){return Gb.Defaults.ATTACHMENT_CORNER_RADIUS},getPointerLength:function(){return Gb.Defaults.ATTACHMENT_POINTER_LENGTH},getPointerWidth:function(){return Gb.Defaults.ATTACHMENT_POINTER_WIDTH},getPosition:function(){return Gb.Defaults.ATTACHMENT_POSITION},getXOffset:function(){return Gb.Defaults.ATTACHMENT_XOFFSET},getYOffset:function(){return Gb.Defaults.ATTACHMENT_YOFFSET},getPadding:function(){return Gb.Defaults.ATTACHMENT_PADDING},getPaddingLeft:function(){return Gb.Defaults.ATTACHMENT_PADDING_LEFT},getPaddingRight:function(){return Gb.Defaults.ATTACHMENT_PADDING_RIGHT},getPaddingTop:function(){return Gb.Defaults.ATTACHMENT_PADDING_TOP},getPaddingBottom:function(){return Gb.Defaults.ATTACHMENT_PADDING_BOTTOM},getDirection:function(){return Gb.Defaults.ATTACHMENT_DIRECTION},isFill:function(){return Gb.Defaults.ATTACHMENT_FILL},getFillColor:function(){return Gb.Defaults.ATTACHMENT_FILL_COLOR},getGradient:function(){return Gb.Defaults.ATTACHMENT_GRADIENT},getGradientColor:function(){return Gb.Defaults.ATTACHMENT_GRADIENT_COLOR},getOutlineWidth:function(){return Gb.Defaults.ATTACHMENT_OUTLINE_WIDTH},getOutlineColor:function(){return Gb.Defaults.ATTACHMENT_OUTLINE_COLOR},getCap:function(){return Gb.Defaults.ATTACHMENT_CAP},getJoin:function(){return Gb.Defaults.ATTACHMENT_JOIN},isShadowable:function(){return Gb.Defaults.ATTACHMENT_SHADOWABLE},getRoundRect:function(){return Hb.clone(this._roundRect)},getContentRect:function(){return Hb.clone(this._contentRect)}}),Gb.vector.LabelAttachment=function(a,b){Gb.vector.LabelAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.LabelAttachment",Gb.vector.BasicAttachment,{paint:function(a){var b=this._element instanceof Gb.Link&&this._element.getStyle("link.label.rotatable");if(b){a.save();var c=this.getZoomViewRect(),d=c.x+c.width/2,e=c.y+c.height/2;a.translate(d,e),a.rotate(this._network.getElementUI(this._element).getAngle()),a.translate(-d,-e)}Gb.vector.LabelAttachment.superClass.paint.apply(this,arguments);var f=this._network.zoomManager,g=f._getAttachmentZoomRect(this,this._contentRect),h=this._element.getStyle("label.align"),i=this._element&&this._element.getStyle("label.rotate.angle");if(0!==i&&(a.save(),Gb.Util.rotateCanvas(a,this._contentRect,i)),f._drawText(this,a,this.text,g,this.font,this.getStyle("label.color"),h),(b||0!==i)&&a.restore(),this._network._debug){var j=this._viewRect;Vb.strokeRect(a,j,"#AAABBB")}},validate:function(){this.font=this.getFont("label.font");var a=this.getLabel(),b=Hb.g.getTextSize(this.font,a),c=this.getMaxLength();0!==c&&b.width>c?(this.text=Hb.g.getCollapseTextInLength(this.font,a,c),this._textSize=Hb.g.getTextSize(this.font,this.text)):(this.text=a,this._textSize=b),Gb.vector.LabelAttachment.superClass.validate.call(this);var d=this._viewRect,e=this._element&&this._element.getStyle("label.rotate.angle");if(0!==e){var f=new Gb.List;f.add({x:d.x,y:d.y}),f.add({x:d.x+d.width,y:d.y}),f.add({x:d.x+d.width,y:d.y+d.height}),f.add({x:d.x,y:d.y+d.height}),f=this._rotatePointList(f,e,d);var g=Gb.Util.getRect(f);this._viewRect=g}},getLabel:function(){return this._network.getLabel(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("label.corner.radius")},getPointerLength:function(){return this.getStyle("label.pointer.length")},getPointerWidth:function(){return this.getStyle("label.pointer.width")},getPosition:function(){return this.getStyle("label.position")},getXOffset:function(){return this.getStyle("label.xoffset")},getYOffset:function(){return this.getStyle("label.yoffset")},getPadding:function(){return this.getStyle("label.padding")},getPaddingLeft:function(){return this.getStyle("label.padding.left")},getPaddingRight:function(){return this.getStyle("label.padding.right")},getPaddingTop:function(){return this.getStyle("label.padding.top")},getPaddingBottom:function(){return this.getStyle("label.padding.bottom")},getDirection:function(){return this.getStyle("label.direction")},isFill:function(){return this.getStyle("label.fill")},getFillColor:function(){return this.getStyle("label.fill.color")},getGradient:function(){return this.getStyle("label.gradient")},getGradientColor:function(){return this.getStyle("label.gradient.color")},getOutlineWidth:function(){return this.getStyle("label.outline.width")},getOutlineColor:function(){return this.getStyle("label.outline.color")},getCap:function(){return this.getStyle("label.cap")},getJoin:function(){return this.getStyle("label.join")},getAlpha:function(){return this.getStyle("label.alpha")},getMaxLength:function(){return this.getStyle("label.maxlength")},isShadowable:function(){return this.getStyle("label.shadowable")}}),Gb.vector.Label2Attachment=function(a,b){Gb.vector.Label2Attachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.Label2Attachment",Gb.vector.BasicAttachment,{paint:function(a){var b=this._element instanceof Gb.Link&&this._element.getStyle("link.label.rotatable");if(b){a.save();var c=this.getZoomViewRect(),d=c.x+c.width/2,e=c.y+c.height/2;a.translate(d,e),a.rotate(this._network.getElementUI(this._element).getAngle()),a.translate(-d,-e)}Gb.vector.Label2Attachment.superClass.paint.apply(this,arguments);var f=this._network.zoomManager,g=f._getAttachmentZoomRect(this,this._contentRect),h=this._element.getStyle("label.align"),i=this._element&&this._element.getStyle("label2.rotate.angle");if(0!==i&&(a.save(),Gb.Util.rotateCanvas(a,this._contentRect,i)),f._drawText(this,a,this.text,g,this.font,this.getStyle("label2.color"),h),(b||0!==i)&&a.restore(),this._network._debug){var j=f.getAttachmentSizeZoom(this),k=g;k.width*=j,k.height*=j,Vb.strokeRect(a,k,"#AAABBB")}},validate:function(){this.font=this.getFont("label2.font");var a=this.getLabel(),b=Hb.g.getTextSize(this.font,a),c=this.getMaxLength();0!==c&&b.width>c?(this.text=Hb.g.getCollapseTextInLength(this.font,a,c),this._textSize=Hb.g.getTextSize(this.font,this.text)):(this.text=a,this._textSize=b),Gb.vector.LabelAttachment.superClass.validate.call(this);var d=this._viewRect,e=this._element&&this._element.getStyle("label2.rotate.angle");if(0!==e){var f=new Gb.List;f.add({x:d.x,y:d.y}),f.add({x:d.x+d.width,y:d.y}),f.add({x:d.x+d.width,y:d.y+d.height}),f.add({x:d.x,y:d.y+d.height}),f=this._rotatePointList(f,e,d);var g=Gb.Util.getRect(f);this._viewRect=g}},getLabel:function(){return this._network.getLabel2(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("label2.corner.radius")},getPointerLength:function(){return this.getStyle("label2.pointer.length")},getPointerWidth:function(){return this.getStyle("label2.pointer.width")},getPosition:function(){return this.getStyle("label2.position")},getXOffset:function(){return this.getStyle("label2.xoffset")},getYOffset:function(){return this.getStyle("label2.yoffset")},getPadding:function(){return this.getStyle("label2.padding")},getPaddingLeft:function(){return this.getStyle("label2.padding.left")},getPaddingRight:function(){return this.getStyle("label2.padding.right")},getPaddingTop:function(){return this.getStyle("label2.padding.top")},getPaddingBottom:function(){return this.getStyle("label2.padding.bottom")},getDirection:function(){return this.getStyle("label2.direction")},isFill:function(){return this.getStyle("label2.fill")},getFillColor:function(){return this.getStyle("label2.fill.color")},getGradient:function(){return this.getStyle("label2.gradient")},getGradientColor:function(){return this.getStyle("label2.gradient.color")},getOutlineWidth:function(){return this.getStyle("label2.outline.width")},getOutlineColor:function(){return this.getStyle("label2.outline.color")},getCap:function(){return this.getStyle("label2.cap")},getJoin:function(){return this.getStyle("label2.join")},getAlpha:function(){return this.getStyle("label2.alpha")},getMaxLength:function(){return this.getStyle("label2.maxlength")},isShadowable:function(){return this.getStyle("label2.shadowable")}}),Gb.vector.AlarmAttachment=function(a,b){Gb.vector.AlarmAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.AlarmAttachment",Gb.vector.BasicAttachment,{paint:function(a){Gb.vector.AlarmAttachment.superClass.paint.apply(this,arguments);var b=this._network.zoomManager,c=b._getAttachmentZoomRect(this,this._contentRect);b._drawText(this,a,this.text,c,this.font,this.getStyle("alarm.color"))},validate:function(){this.font=this.getFont("alarm.font"),this.text=this._network.getAlarmLabel(this._element),this._textSize=Vb.getTextSize(this.font,this.text),this._fillColor=this._network.getAlarmFillColor(this._element),Gb.vector.AlarmAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("alarm.corner.radius")},getPointerLength:function(){return this.getStyle("alarm.pointer.length")},getPointerWidth:function(){return this.getStyle("alarm.pointer.width")},getPosition:function(){return this.getStyle("alarm.position")},getXOffset:function(){return this.getStyle("alarm.xoffset")},getYOffset:function(){return this.getStyle("alarm.yoffset")},getPadding:function(){return this.getStyle("alarm.padding")},getPaddingLeft:function(){return this.getStyle("alarm.padding.left")},getPaddingRight:function(){return this.getStyle("alarm.padding.right")},getPaddingTop:function(){return this.getStyle("alarm.padding.top")},getPaddingBottom:function(){return this.getStyle("alarm.padding.bottom")},getDirection:function(){return this.getStyle("alarm.direction")},isFill:function(){return null!=this._fillColor},getFillColor:function(){return this._fillColor},getGradient:function(){return this.getStyle("alarm.gradient")},getGradientColor:function(){return this.getStyle("alarm.gradient.color")},getOutlineWidth:function(){return this.getStyle("alarm.outline.width")},getOutlineColor:function(){return this.getStyle("alarm.outline.color")},getCap:function(){return this.getStyle("alarm.cap")},getJoin:function(){return this.getStyle("alarm.join")},getAlpha:function(){return this.getStyle("alarm.alpha")},isShadowable:function(){return this.getStyle("alarm.shadowable")}}),Gb.vector.LinkHandlerAttachment=function(a,b){Gb.vector.LinkHandlerAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.LinkHandlerAttachment",Gb.vector.BasicAttachment,{paint:function(a){var b=this._network.zoomManager;Gb.vector.LinkHandlerAttachment.superClass.paint.apply(this,arguments);var c=b._getAttachmentZoomRect(this,this._contentRect);b._drawText(this,a,this.linkHandlerLabel,c,this.linkHandlerFont,this.getStyle("link.handler.color"))},validate:function(){this.linkHandlerFont=this.getFont("link.handler.font"),this.linkHandlerLabel=this._network.getLinkHandlerLabel(this._element),this._textSize=Vb.getTextSize(this.linkHandlerFont,this.linkHandlerLabel),Gb.vector.LinkHandlerAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("link.handler.corner.radius")},getPointerLength:function(){return this.getStyle("link.handler.pointer.length")},getPointerWidth:function(){return this.getStyle("link.handler.pointer.width")},getPosition:function(){return this.getStyle("link.handler.position")},getXOffset:function(){return this.getStyle("link.handler.xoffset")},getYOffset:function(){return this.getStyle("link.handler.yoffset")},getPadding:function(){return this.getStyle("link.handler.padding")},getPaddingLeft:function(){return this.getStyle("link.handler.padding.left")},getPaddingRight:function(){return this.getStyle("link.handler.padding.right")},getPaddingTop:function(){return this.getStyle("link.handler.padding.top")},getPaddingBottom:function(){return this.getStyle("link.handler.padding.bottom")},getDirection:function(){return this.getStyle("link.handler.direction")},isFill:function(){return this.getStyle("link.handler.fill")},getFillColor:function(){return this.getStyle("link.handler.fill.color")},getGradient:function(){return this.getStyle("link.handler.gradient")},getGradientColor:function(){return this.getStyle("link.handler.gradient.color")},getOutlineWidth:function(){return this.getStyle("link.handler.outline.width")},getOutlineColor:function(){return this.getStyle("link.handler.outline.color")},getCap:function(){return this.getStyle("link.handler.cap")},getJoin:function(){return this.getStyle("link.handler.join")},getAlpha:function(){return this.getStyle("link.handler.alpha")},isShadowable:function(){return this.getStyle("link.handler.shadowable")}}),Gb.vector.IconsAttachment=function(a,b){Gb.vector.IconsAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.IconsAttachment",Gb.vector.Attachment,{isShadowable:function(){return Gb.Defaults.ATTACHMENT_SHADOWABLE},validate:function(){if(Gb.vector.IconsAttachment.superClass.validate.call(this),this.iconsNames=this._network.getIconsNames(this._element),this.iconsNames&&0!=this.iconsNames.length){var a=this._makeGroup(this.iconsNames),b=this._makeGroup(this._network.getIconsColors(this._element)),c=this._network.zoomManager;len=a.length,this.iconsOrientation=this._makeArray(this._element.getStyle("icons.orientation"),len,"right"),this.iconsPosition=this._makeArray(this._element.getStyle("icons.position"),len,"topleft.bottomright"),this.iconsXoffset=this._makeArray(this._element.getStyle("icons.xoffset"),len,0),this.iconsYoffset=this._makeArray(this._element.getStyle("icons.yoffset"),len,0),this.iconsXgap=this._makeArray(this._element.getStyle("icons.xgap"),len,1),this.iconsYgap=this._makeArray(this._element.getStyle("icons.ygap"),len,1),this.locations=[],this.iconsSizes=[],
this.iconsOrientations=[];var d,e,f;for(i=0;i<len;i++){var g=a[i],f=this.iconsOrientation[i]||"right",h=this.iconsPosition[i]||"topleft.bottomright",j=this.iconsXgap[i]||1,k=this.iconsYgap[i]||1,l=this.iconsXoffset[i]||0,m=this.iconsYoffset[i]||0;if(this._ui._element instanceof Gb.Link){var n,o=this._ui.getLinkPoints();n=this._ui.getLineLength?this._ui.getLineLength():this._ui._element.getLineLength(),Math.abs(l)>0&&Math.abs(l)<1?"from"===h?l*=n:"to"===h?l=n*(1-l):(l/=2,l+=.5,l*=n):"from"===h?l=l:"to"===h?l=n-l:l+=n/2;{var p,q=Rb.calculatePointInfoAlongLine(o,!0,l,m),r=q.point;q.angle}p="from"===h?this._ui.getFromPoint():"to"===h?this._ui.getToPoint():this._ui._hotSpot,l=r.x-p.x,m=r.y-p.y}e=null,d=this._getIconsSize(g,f,j,k,c),d&&(e=this._network.getPosition(h,this._ui,d,l,m),this._iconLocation=e,"top"===f?e.y+=d.height:"left"===f&&(e.x+=d.width)),this.locations.push(e),this.iconsSizes.push(d),this.iconsOrientations.push(f)}var s=null;for(i=0;i<this.locations.length;i++)e=this.locations[i],d=this.iconsSizes[i],f=this.iconsOrientations[i],null!=e&&(s=null==s?"top"===f?{x:e.x,y:e.y-d.height,width:d.width,height:d.height}:"left"===f?{x:e.x-d.width,y:e.y,width:d.width,height:d.height}:{x:e.x,y:e.y,width:d.width,height:d.height}:"top"===f?Rb.unionRect(s,{x:e.x,y:e.y-d.height,width:d.width,height:d.height}):"left"===f?Rb.unionRect(s,{x:e.x-d.width,y:e.y,width:d.width,height:d.height}):Rb.unionRect(s,{x:e.x,y:e.y,width:d.width,height:d.height}));this._viewRect=c?s||this.getElementUI().getViewRect():s||{x:this._element.getLocation().x,y:this._element.getLocation().y,width:0,height:0},this.iconsGroups=a,this.colorGroups=b;var t=this._element instanceof Gb.Link&&this._element.getStyle("link.icons.rotatable");for(i=0;i<len;i++)if(t instanceof Array&&t[i]&&this._viewRect){var u=this._viewRect.x+this._viewRect.width/2,v=this._viewRect.y+this._viewRect.height/2,w=Math.sqrt(this._viewRect.height*this._viewRect.height+this._viewRect.width*this._viewRect.width);this._viewRect={x:u-w/2,y:v-w/2,width:w,height:w}}}},_makeGroup:function(a){if(!Array.isArray(a))return[[a]];var b,c,d,e=[],f=!1,g=a.length;for(b=0;g>b;b++)c=a[b],Array.isArray(c)?(f=!0,e.push(c)):(d=[c],e.push(d));return f||(e.length=0,e.push(a)),e},_makeArray:function(a,b,c){if(Array.isArray(a))return a;for(var d=[],e=0;b>e;e++)d.push(a||c);return d},paint:function(a){if(Gb.vector.IconsAttachment.superClass.paint.apply(this,arguments),this.iconsNames&&0!=this.iconsNames.length&&this.locations){var b,c,d,e,f,g,h,i,j,k,l=this._network.zoomManager;for(b=0;b<this.iconsGroups.length;b++)if(c=this.locations[b]){f=c.x,g=c.y,e=this.iconsGroups[b],h=this.colorGroups[b],i=this.iconsOrientation[b],j=this.iconsXgap[b]||1,k=this.iconsYgap[b]||1,d=0;for(var m in e){var n=null,o=null;h&&h.length>d&&(o=h[d++]);var p=Hb.getImageAsset(e[m]);if(null!=p){if(l&&this._ui instanceof Gb.vector.GroupUI&&this._ui._shapeRect){var q=l.getAttachmentSizeZoom(this),r=p.getWidth()*q,s=p.getHeight()*q;if("right"===i)n={x:f,y:g,width:r,height:s},f+=n.width+j;else if("left"===i)n={x:f-r,y:g,width:r,height:s},f-=n.width+j;else if("top"===i)n={x:f,y:g-s,width:r,height:s},g-=n.height+k;else{if("bottom"!==i)throw"Can not resolve '"+i+"' orientation";n={x:f,y:g,width:r,height:s},g+=n.height+k}}else{if("right"===i)n={x:f,y:g,width:p.getWidth(),height:p.getHeight()},f+=n.width+j;else if("left"===i)n={x:f-p.getWidth(),y:g,width:p.getWidth(),height:p.getHeight()},f-=n.width+j;else if("top"===i)n={x:f,y:g-p.getHeight(),width:p.getWidth(),height:p.getHeight()},g-=n.height+k;else{if("bottom"!==i)throw"Can not resolve '"+i+"' orientation";n={x:f,y:g,width:p.getWidth(),height:p.getHeight()},g+=n.height+k}n=l._getAttachmentZoomOutLineRect(this,n)}var t=this._element instanceof Gb.Link&&this._element.getStyle("link.icons.rotatable");if(t instanceof Array&&t[b]){a.save();var u=n,f=u.x+u.width/2,g=u.y+u.height/2;a.translate(f,g),a.rotate(this._network.getElementUI(this._element).getAbsoluteAngle()),a.translate(-f,-g),Mc(a,p.getImage(o,n.width,n.height),o,n,this._element,this._network),a.restore()}else Mc(a,p.getImage(o,n.width,n.height),o,n,this._element,this._network);if(this._network._debug){var n=this._viewRect;Vb.strokeRect(a,n,"#FCFC00",1),Vb.strokeRect(a,n,"#FCFC00",1)}}}}}},_getIconsSize:function(a,b,c,d,e){var f=0,g=0,h=null,i=null,j=null;for(var k in a)if(i=Hb.getImageAsset(a[k])){if("right"===b)h={x:f,y:g,width:i.getWidth(),height:i.getHeight()},f+=h.width+c;else if("left"===b)h={x:f-i.getWidth(),y:g,width:i.getWidth(),height:i.getHeight()},f-=h.width+c;else if("top"===b)h={x:f,y:g-i.getHeight(),width:i.getWidth(),height:i.getHeight()},g-=h.height+d;else{if("bottom"!==b)throw"Can not resolve '"+b+"' orientation";h={x:f,y:g,width:i.getWidth(),height:i.getHeight()},g+=h.height+d}j=null==j?Hb.clone(h):Rb.unionRect(j,h)}return j?e&&this._ui instanceof Gb.vector.GroupUI&&this._ui._shapeRect?{width:Math.abs(j.width)*e.getAttachmentSizeZoom(this),height:Math.abs(j.height)*e.getAttachmentSizeZoom(this)}:{width:Math.abs(j.width),height:Math.abs(j.height)}:null}}),Gb.vector.EditAttachment=function(a,b){Gb.vector.EditAttachment.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.EditAttachment",Gb.vector.Attachment,{paint:function(a){Gb.vector.EditAttachment.superClass.paint.apply(this,arguments),this.paintResizingPoints(a),this.paintEditPoints(a),this.paintRotatePoints(a)},paintResizingPoints:function(a){var b=this.resizingPoints.size();if(!(0>=b)){var c=this._element.getStyle("edit.physicalZoom")?1:this._network.getGraphicsZoom(),d=this.resizePointSize/c,e=2*d,f=2*d,g=this._network.getResizePointFillColor(),h=this._network.getResizePointOutlineWidth()/c,i=this._network.getResizePointOutlineColor(),j=this._element.getAngle(),k=this._network.zoomManager,l=k._getElementZoomRect(this.getElementUI(),this._element.getOriginalRect());a.lineWidth=h;for(var m=this.resizingPoints,n=0;b>n;n++){var o=m.get(n),p={x:o.x-d,y:o.y-d,width:2*d,height:2*d},q=this._getRotateRect(p,j,{x:l.x+l.width/2,y:l.y+l.height/2});a.save(),Gb.Util.rotateCanvas(a,q,j),Od.rect(a,q.x,q.y,e,f),a.restore()}if(a.fillStyle=g,a.strokeStyle=i,a.fill(),a.stroke(),this._network._debug){var r=this.getViewRect("resize");Vb.strokeRect(a,r,"#CCDDCC");var r=k._getElementZoomRect(this.getElementUI(),this.getElementUI()._viewRect);Vb.strokeRect(a,r,"#FD7766")}}},paintEditPoints:function(a){var b=this.editPoints.size();if(!(0>=b)){var c=this._element.getStyle("edit.physicalZoom")?1:this._network.getGraphicsZoom(),d=this._network.getEditPointOutlineColor(),e=this._network.getEditPointFillColor(),f=this._network.getEditPointOutlineWidth()/c;a.beginPath(),a.lineWidth=f;for(var g=this.editPoints,h=0;b>h;h++){var i=g.get(h);a.beginPath(),Od.circle(a,i.x,i.y,this.editPointSize,e,d),a.closePath()}if(this._network._debug){var j=this.getViewRect("edit");Vb.strokeRect(a,j,"#AAABBC")}}},paintRotatePoints:function(a){var b=this.rotatePoints.size();if(!(0>=b)){var c=this._element.getStyle("edit.physicalZoom")?1:this._network.getGraphicsZoom(),d=this._network.getRotatePointOutlineColor(),e=this._network.getRotatePointFillColor(),f=this._network.getRotatePointOutlineWidth()/c;a.beginPath(),a.lineWidth=f;for(var g=this.rotatePoints,h=0;b>h;h++){var i=g.get(h);a.beginPath(),Od.circle(a,i.x,i.y,this.rotatePointSize/c,e,d),a.closePath(),a.beginPath()}if(this._network._debug){var j=this.getViewRect("rotate");Vb.strokeRect(a,j,"green")}}},getViewRect:function(a){if(a){if("resize"===a)return this._resizeRect;if("rotate"===a)return this._rotateRect;if("edit"===a)return this._editRect}return this._viewRect||{x:0,y:0,width:0,height:0}},validate:function(){Gb.vector.EditAttachment.superClass.validate.call(this);var a=this._network.getGraphicsZoom();this.editPointSize=this._network.getEditPointSize(),this.resizePointSize=this._network.getResizePointSize(),this.rotatePointSize=this._network.getRotatePointSize(),this.resizingPoints=new Gb.List,this.editPoints=new Gb.List,this.rotatePoints=new Gb.List,this._element instanceof Gb.Node&&this._addResizingPoint(this._element),!(this._network.isRotatable(this._element)&&this._element instanceof Ld)||this._element instanceof Gb.ShapeNode||this._element instanceof Gb.Grid||this._element instanceof Gb.Group||this._addRotatePoint(this._element),this._element instanceof Gb.ShapeNode&&(this._addResizingPoint(this._element),this._addShapeNodePoint(this._element)),this._ui instanceof Gb.vector.ShapeLinkUI&&this._addShapeLinkPoints(this._element),this._ui instanceof Gb.vector.LinkUI&&this._addLinkControlPoint(this._ui);var b=this._network.getResizePointOutlineWidth()/a,c=this.getElementUI().getZoomBodyRect(),d=2*Math.sqrt(2);if(this._resizeOffset=(this.resizePointSize+b+1)*d,Rb.grow(c,this._resizeOffset,this._resizeOffset),this._resizeRect=c,b=this._network.getEditPointOutlineWidth()/a,this.editPoints.size()>0){var e=Rb.getRect(this.editPoints);Rb.grow(e,2*this.editPointSize+2*b),c=Rb.unionRect(c,e)}this._editRect=e,b=this._network.getRotatePointOutlineWidth()/a;var f=this.rotatePointSize;if(this.rotatePoints.size()>0){var g=this.rotatePoints.get(0),h={x:g.x-f-b-1,y:g.y-f-b-1,width:2*f+2*b+2,height:2*f+2*b+2};c=Rb.unionRect(c,h),this._rotateRect=h}this._viewRect=c},_addResizingPoint:function(a){var b=this._network.zoomManager._getElementZoomRect(this.getElementUI(),a.getOriginalRect());if(b){var c=this._network.getResizePointSize();if(!(0>=c)){var d=new md([{x:b.x,y:b.y},{x:b.x+b.width/2,y:b.y},{x:b.x+b.width,y:b.y},{x:b.x,y:b.y+b.height/2},{x:b.x+b.width,y:b.y+b.height/2},{x:b.x,y:b.y+b.height},{x:b.x+b.width/2,y:b.y+b.height},{x:b.x+b.width,y:b.y+b.height}]),e=this._network.getResizePointOutlineWidth(),f=this._network.getResizePointOutlineColor(),g=this._network.getResizePointFillColor();this._addPoints(a.getRect(),d,e,f,g,!0)}}},_addRotatePoint:function(a){var b=this._network.zoomManager._getElementZoomRect(this.getElementUI(),a.getOriginalRect());if(b){var c=this._network.getRotatePointSize()/this._network.getGraphicsZoom();if(!(0>=c)){var d=2*c,e=new Gb.List([{x:b.x+b.width/2,y:b.y-this._network.getRotatePointOffset()/this._network.getGraphicsZoom()-c}]),f=a.getAngle();0!=f&&(e=this._rotatePointList(e,f,b));var g=e.get(0),h={x:g.x-d/2,y:g.y-d/2,width:d,height:d},i=this._network.getRotatePointOutlineWidth(),j=this.rotatePointSize+i;Rb.grow(b,j,j);{Rb.unionRect(a.getRect(),h)}this.rotatePoints=e}}},_addShapeNodePoint:function(a){var b=this._network.zoomManager._getShapeNodeZoomPoints(this.getElementUI(),a.getPoints());this._addEditPoints(b)},_addShapeLinkPoints:function(a){var b=this._network.zoomManager._getShapeLinkZoomPoints(a.getPoints());this._addEditPoints(b)},_addLinkControlPoint:function(a){var b,c=new Gb.List,d=a._element.getFromAgent();b=d?a._element.getFromAgent():a._element.getFromNode();var e=a._element.getStyle("link.from.xoffset"),f=a._element.getStyle("link.from.yoffset"),g=this._network.getElementUI(b),h=g.getZoomBodyRect(),i={x:h.x+h.width/2,y:h.y+h.height/2},j={x:i.x+e,y:i.y+f};c.add(j);var k,l=a._element.getToAgent();k=l?a._element.getToAgent():a._element.getToNode();var m=a._element.getStyle("link.to.xoffset"),n=a._element.getStyle("link.to.yoffset"),o=this._network.getElementUI(k),p=o.getZoomBodyRect(),q={x:p.x+p.width/2,y:p.y+p.height/2},r={x:q.x+m,y:q.y+n};if(c.add(r),wc.isOrthogonalLink(a._element)&&a.getControlPoint()){var s=a.getControlPoint();s&&c.add(s)}var t=this.editPoints.size();if(t>0)for(var u=0;t>u;u++)c.add(this.editPoints.get(u));this._addEditPoints(c)},_addEditPoints:function(a){var b=Rb.getRect(a);if(b){var c=this._network.getEditPointSize();if(!(0>=c)){var d=this._network.getEditPointOutlineWidth();this._addPoints(b,a,d,!1)}}},_addPoints:function(a,b,c,d,e,f){var g=f?this._network.getResizePointSize():this._network.getEditPointSize();if(!(0>g)){var h=g+c;Rb.grow(a,h,h),1==f?this.resizingPoints=b:this.editPoints=b}},_rotatePoint:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_rotatePointList:function(a,b,c){var d=this,e=new Gb.List;return a.forEach(function(a){e.add(d._rotatePoint(a,b,c))}),e},_getRotateRect:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x,c.y),e={x:a.x+a.width/2,y:a.y+a.height/2},f=d.transform(e),g=new Gb.List([{x:f.x-a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y+a.height/2},{x:f.x-a.width/2,y:f.y+a.height/2}]);return Rb.getRect(g)}}),Gb.vector.HTMLLabelAttachment=function(a,b){Gb.vector.HTMLLabelAttachment.superClass.constructor.call(this,a,b),this._triangleDiv=Gb.Util.createDiv(),this._roundDiv=Gb.Util.createDiv(),this._contentDiv=Gb.Util.createDiv();this._network.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Hb.ext("twaver.vector.HTMLLabelAttachment",Gb.vector.LabelAttachment,{validate:function(){this.validateZIndex(0);var a=this._element.getStyle("attachment.htmllabel.hyperlink");a?(Gb.Util.setCSSStyle(this._triangleDiv,"pointer-events","auto"),Gb.Util.setCSSStyle(this._contentDiv,"pointer-events","auto")):(Gb.Util.setCSSStyle(this._triangleDiv,"pointer-events","none"),Gb.Util.setCSSStyle(this._contentDiv,"pointer-events","none")),Gb.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Gb.Util.setCSSStyle(this._contentDiv,"white-space","nowrap");var b=(this.getFont("label.font"),this.getLabel());b!==this.text&&(this.text&&("object"==typeof this.text?window.jquery?window.jquery(this.text).remove():this._contentDiv.removeChild(this.text):this._contentDiv.innerHTML=""),b&&("object"==typeof b?window.jquery?window.jquery(this._contentDiv).append(b):this._contentDiv.appendChild(b):this._contentDiv.innerHTML=b),this.text=b),this._contentDiv.style.visibility="hidden",Gb.vector.HTMLLabelAttachment.superClass.validate.call(this)},validateZIndex:function(a){this._roundDiv.style.zIndex=1e5*a+this._network.getElementBox().getDatas().indexOf(this._element)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},paint:function(a){var b=this.isFill(),c=this.getOutlineWidth(),d=this._contentRect;if(this.getElementUI().setGlow(this,a),this.getElementUI().setShadow(this,a),c>0||b){if(Vb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._pointers){var e=this._ui.getZoomPointers(this,this._pointers);a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Vb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}var h=(this.getFont("label.font"),this.getLabel(),this._network.getViewRect().x),i=this._network.getViewRect().y,j=this._network.getZoom(),k={x:this._contentRect.x+this._contentRect.width/2,y:this._contentRect.y+this._contentRect.height/2},l=k.x*j-h-this._contentDiv.offsetWidth/2*j+"px",m=k.y*j-i-this._contentDiv.offsetHeight/2*j+"px";this._contentDiv.style.left=l,this._contentDiv.style.top=m,Ob.isFirefox?(Gb.Util.setCSSStyle(this._contentDiv,"-moz-transform","scale("+j+")"),Gb.Util.setCSSStyle(this._contentDiv,"-moz-transform-origin","0 0")):Ob.isOpera?(Gb.Util.setCSSStyle(this._contentDiv,"-o-transform","scale("+j+")"),Gb.Util.setCSSStyle(this._contentDiv,"-o-transform-origin","0 0")):Ob.isChrome||Ob.isSafari?(Gb.Util.setCSSStyle(this._contentDiv,"-webkit-transform","scale("+j+")"),Gb.Util.setCSSStyle(this._contentDiv,"-webkit-transform-origin","0 0")):Ob.isIE?(Gb.Util.setCSSStyle(this._contentDiv,"-ms-transform","scale("+j+")"),Gb.Util.setCSSStyle(this._contentDiv,"-ms-transform-origin","0 0")):(Gb.Util.setCSSStyle(this._contentDiv,"transform","scale("+j+")"),Gb.Util.setCSSStyle(this._contentDiv,"transform-origin","0 0")),this._network._debug&&(Vb.strokeRect(a,this._contentRect,"blue"),Vb.strokeRect(a,this._roundRect,"red"),Vb.strokeRect(a,this._viewRect,"green"));var n=this._element instanceof Gb.Link&&this._element.getStyle("link.label.rotatable");if(n){{var o=this.getZoomViewRect(),p=(o.x+o.width/2,o.y+o.height/2,180*this._network.getElementUI(this._element).getAbsoluteAngle()/Math.PI);this._contentDiv.offsetWidth/2*j,this._contentDiv.offsetHeight/2*j}Ob.isFirefox?Gb.Util.setCSSStyle(this._contentDiv,"-moz-transform","translate(0px,0px) rotate("+p+"deg) scale("+j+")"):Ob.isOpera?Gb.Util.setCSSStyle(this._contentDiv,"-o-transform","translate(0px,0px) rotate("+p+"deg) scale("+j+")"):Ob.isChrome||Ob.isSafari?Gb.Util.setCSSStyle(this._contentDiv,"-webkit-transform","translate(0px, 0px) rotate("+p+"deg) scale("+j+")"):Ob.isIE?Gb.Util.setCSSStyle(this._contentDiv,"-ms-transform","translate(0px,0px) rotate("+p+"deg) scale("+j+")"):Gb.Util.setCSSStyle(this._contentDiv,"transform","translate(0px,0px) rotate("+p+"deg) scale("+j+")")}},setVisibility:function(a){this._contentDiv.style.visibility=a},dispose:function(){this._network.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),Gb.vector.HTMLLabel2Attachment=function(a,b){Gb.vector.HTMLLabel2Attachment.superClass.constructor.call(this,a,b),this._triangleDiv=Gb.Util.createDiv(),this._roundDiv=Gb.Util.createDiv(),this._contentDiv=Gb.Util.createDiv();this._network.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Hb.ext("twaver.vector.HTMLLabel2Attachment",Gb.vector.LabelAttachment,{validate:function(){this.validateZIndex(0);var a=this._element.getStyle("attachment.htmllabel2.hyperlink");a?(Gb.Util.setCSSStyle(this._triangleDiv,"pointer-events","auto"),Gb.Util.setCSSStyle(this._contentDiv,"pointer-events","auto")):(Gb.Util.setCSSStyle(this._triangleDiv,"pointer-events","none"),Gb.Util.setCSSStyle(this._contentDiv,"pointer-events","none")),Gb.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Gb.Util.setCSSStyle(this._contentDiv,"white-space","nowrap");var b=(this.getFont("label2.font"),this.getLabel());b!==this.text&&(this.text&&("object"==typeof this.text?window.jquery?window.jquery(this.text).remove():this._contentDiv.removeChild(this.text):this._contentDiv.innerHTML=""),b&&("object"==typeof b?window.jquery?window.jquery(this._contentDiv).append(b):this._contentDiv.appendChild(b):this._contentDiv.innerHTML=b),this.text=b),this._contentDiv.style.visibility="hidden",Gb.vector.HTMLLabelAttachment.superClass.validate.call(this)},validateZIndex:function(a){this._roundDiv.style.zIndex=1e5*a+this._network.getElementBox().getDatas().indexOf(this._element)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},paint:function(a){var b=this.isFill(),c=this.getOutlineWidth(),d=this._contentRect;if(this.getElementUI().setGlow(this,a),this.getElementUI().setShadow(this,a),c>0||b){if(Vb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._pointers){var e=this._ui.getZoomPointers(this,this._pointers);a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Vb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}var h=(this.getFont("label2.font"),this.getLabel(),this._network.getViewRect().x),i=this._network.getViewRect().y,j=this._network.getZoom(),k={x:this._contentRect.x+this._contentRect.width/2,y:this._contentRect.y+this._contentRect.height/2},l=k.x*j-h-this._contentDiv.offsetWidth/2*j+"px",m=k.y*j-i-this._contentDiv.offsetHeight/2*j+"px";this._contentDiv.style.left=l,this._contentDiv.style.top=m,this._contentDiv.style.setProperty("-webkit-transform","scale("+j+")",null),this._contentDiv.style.setProperty("-webkit-transform-origin","0 0",null),this._network._debug&&(Vb.strokeRect(a,this._contentRect,"blue"),Vb.strokeRect(a,this._roundRect,"red"),Vb.strokeRect(a,this._viewRect,"green"));var n=this._element instanceof Gb.Link&&this._element.getStyle("link.label2.rotatable");if(n){{var o=this.getZoomViewRect(),p=(o.x+o.width/2,o.y+o.height/2,180*this._network.getElementUI(this._element).getAbsoluteAngle()/Math.PI);this._contentDiv.offsetWidth/2*j,this._contentDiv.offsetHeight/2*j}Ob.isFirefox?Gb.Util.setCSSStyle(this._contentDiv,"-moz-transform","translate(0px,0px) rotate("+p+"deg) scale("+j+")"):Ob.isOpera?Gb.Util.setCSSStyle(this._contentDiv,"-o-transform","translate(0px,0px) rotate("+p+"deg) scale("+j+")"):Ob.isChrome||Ob.isSafari?Gb.Util.setCSSStyle(this._contentDiv,"-webkit-transform","translate(0px, 0px) rotate("+p+"deg) scale("+j+")"):Ob.isIE?Gb.Util.setCSSStyle(this._contentDiv,"-ms-transform","translate(0px,0px) rotate("+p+"deg) scale("+j+")"):Gb.Util.setCSSStyle(this._contentDiv,"transform","translate(0px,0px) rotate("+p+"deg) scale("+j+")")}},setVisibility:function(a){this._contentDiv.style.visibility=a},dispose:function(){this._network.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv},getLabel:function(){return this._network.getLabel2(this._element)},getCornerRadius:function(){return this.getStyle("label2.corner.radius")},getPointerLength:function(){return this.getStyle("label2.pointer.length")},getPointerWidth:function(){return this.getStyle("label2.pointer.width")},getPosition:function(){return this.getStyle("label2.position")},getXOffset:function(){return this.getStyle("label2.xoffset")},getYOffset:function(){return this.getStyle("label2.yoffset")},getPadding:function(){return this.getStyle("label2.padding")},getPaddingLeft:function(){return this.getStyle("label2.padding.left")},getPaddingRight:function(){return this.getStyle("label2.padding.right")},getPaddingTop:function(){return this.getStyle("label2.padding.top")},getPaddingBottom:function(){return this.getStyle("label2.padding.bottom")},getDirection:function(){return this.getStyle("label2.direction")},isFill:function(){return this.getStyle("label2.fill")},getFillColor:function(){return this.getStyle("label2.fill.color")},getGradient:function(){return this.getStyle("label2.gradient")},getGradientColor:function(){return this.getStyle("label2.gradient.color")},getOutlineWidth:function(){return this.getStyle("label2.outline.width")},getOutlineColor:function(){return this.getStyle("label2.outline.color")},getCap:function(){return this.getStyle("label2.cap")},getJoin:function(){return this.getStyle("label2.join")},getAlpha:function(){return this.getStyle("label2.alpha")},isShadowable:function(){return this.getStyle("label2.shadowable")}}),Gb.vector.HTMLAlarmAttachment=function(a,b){Gb.vector.HTMLAlarmAttachment.superClass.constructor.call(this,a,b),this._triangleDiv=Gb.Util.createDiv(),this._roundDiv=Gb.Util.createDiv(),this._contentDiv=Gb.Util.createDiv(),Gb.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Gb.Util.setCSSStyle(this._triangleDiv,"pointer-events","none"),Gb.Util.setCSSStyle(this._contentDiv,"white-space","nowrap"),Gb.Util.setCSSStyle(this._contentDiv,"pointer-events","none");this._network.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Hb.ext("twaver.vector.HTMLAlarmAttachment",Gb.vector.AlarmAttachment,{validate:function(){var a=(this.getFont("alarm.font"),this._network.getAlarmLabel(this._element));this._contentDiv.innerHTML=a,this._contentDiv.style.visibility="hidden",Gb.vector.HTMLAlarmAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(Gb.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},paint:function(a){var b=this.isFill(),c=this.getOutlineWidth(),d=this._contentRect;if(this.getElementUI().setShadow(this,a),c>0||b){if(Vb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._pointers){var e=this._ui.getZoomPointers(this,this._pointers);a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Vb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}var h=(this.getFont("alarm.font"),this._network.getAlarmLabel(this._element),this._network.getViewRect().x),i=this._network.getViewRect().y,j=this._network.getZoom(),k={x:this._contentRect.x+this._contentRect.width/2,y:this._contentRect.y+this._contentRect.height/2},l=k.x*j-h-this._contentDiv.offsetWidth/2*j+"px",m=k.y*j-i-this._contentDiv.offsetHeight/2*j+"px";this._contentDiv.style.left=l,this._contentDiv.style.top=m,this._contentDiv.style.setProperty("-webkit-transform","scale("+j+")",null),this._contentDiv.style.setProperty("-webkit-transform-origin","0 0",null),this._network._debug&&Vb.strokeRect(a,this._contentRect,"#DDDDDD"),Gb.vector.AlarmAttachment.superClass.paint.apply(this,arguments)},setVisibility:function(a){this._contentDiv.style.visibility=a},dispose:function(){this._network.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),Gb.vector.BaseZoomManager=function(a){this.network=a,this.visibilityThresholds=a.visibilityThresholds},Hb.ext("twaver.vector.BaseZoomManager",Object,{getZoom:function(){return this.network.getZoom()},getGraphicsZoom:function(){return 1},getSizeZoom:function(a){return 1},getAttachmentSizeZoom:function(a){var b=a.getElementUI();return this.getSizeZoom(b)},getLocationZoom:function(a){return 1},_getZoomVisibilityThresholds:function(){return this.network.getZoomVisibilityThresholds()},_convertPointFromView:function(a){var b=a.x*this.getGraphicsZoom()-this.network.getViewRect().x,c=a.y*this.getGraphicsZoom()-this.network.getViewRect().y;return{x:b,y:c}},_getElementViewRect:function(a,b){var c=this.getLocationZoom(a),d=this.getSizeZoom(a);if(1==c&&1==d)return b;var e=this._getZoomPoint(a),f=e.x,g=e.y;return null==b&&console.log("View rect is null"),{x:f*c+(b.x-f)*d,y:g*c+(b.y-g)*d,width:b.width*d,height:b.height*d}},_invalidateZoom:function(){this.network.invalidateElementUIs()},_getGroupChildrenRects:function(a){var b=new md;return a.getChildren().forEach(function(a){if(a instanceof Ld){var c=this.network.getElementUI(a);if(c){var d=c.getZoomViewRect(this);d&&b.add(d)}}},this),b},_zoomGraphicsBegin:function(a){var b=this.network,c=this.getGraphicsZoom();a.scale(c,c),a.translate(-b.viewRect.x/c,-b.viewRect.y/c)},_getEditZoomPoints:function(a,b){var c=this.getLocationZoom(a),d=this.getSizeZoom(a);if(1==c&&1==d||a instanceof Gb.vector.LinkUI&&!(a instanceof Gb.vector.ShapeLinkUI))return b;var e;e=a instanceof Gb.vector.ShapeLinkUI?Rb.getCenterPoint(Rb.getRect(b)):this._getZoomPoint(a);var f=e.x,g=e.y;if(b.forEach){var h,i=new md;return b.forEach(function(a){a instanceof md?(h=new md,a.forEach(function(a){h.add({x:f*c+(a.x-f)*d,y:g*c+(a.y-g)*d})}),i.add(h)):i.add({x:f*c+(a.x-f)*d,y:g*c+(a.y-g)*d})}),i}return b.x?{x:f*c+(b.x-f)*d,y:g*c+(b.y-g)*d}:void 0},_getShapeNodeZoomPoints:function(a,b,c){var d=this.getLocationZoom(a),e=this.getSizeZoom(a);if(1==d&&1==e)return b;c&&(d=1/d,e=1/e);var f,g=Rb.getRect(b),h=g.x+g.width/2,i=g.y+g.height/2,j=new md;return b.forEach(function(a){a instanceof md?(f=new md,a.forEach(function(a){f.add({x:h*d+(a.x-h)*e,y:i*d+(a.y-i)*e})}),j.add(f)):j.add({x:h*d+(a.x-h)*e,y:i*d+(a.y-i)*e})}),j},_getShapeLinkZoomPoints:function(a,b){var c=this.getLocationZoom(),d=c;if(1==c&&1==d)return a;b&&(c=1/c,d=1/d);var e,f=Rb.getRect(a),g=f.x+f.width/2,h=f.y+f.height/2,i=new md;return a.forEach(function(a){a instanceof md?(e=new md,a.forEach(function(a){e.add({x:g*c+(a.x-g)*d,y:h*c+(a.y-h)*d})}),i.add(e)):i.add({x:g*c+(a.x-g)*d,y:h*c+(a.y-h)*d})}),i},_getLogicalPoint:function(a,b){var c,d=b?this.getZoom():this.getGraphicsZoom(),e=this.network;if(Ob.isTouchable&&a.changedTouches&&a.changedTouches.length>0){var f=e._view.getBoundingClientRect(),g=a.changedTouches[0],h=Ob.isAndroid?0:yc.scrollLeft(),i=Ob.isAndroid?0:yc.scrollTop();return c={x:(g.clientX+e.viewRect.x-f.left-h)/d,y:(g.clientY+e.viewRect.y-f.top-i)/d}}return c=Ob.isFirefox?{x:(a.layerX+e.viewRect.x)/d,y:(a.layerY+e.viewRect.y)/d}:{x:(a.offsetX+e.viewRect.x)/d,y:(a.offsetY+e.viewRect.y)/d}},_getVisibleRect:function(a){return a},_getElementZoomRect:function(a,b){var c=this.getLocationZoom(a),d=this.getSizeZoom(a);if(1==c&&1==d)return Hb.cloneRect(b);var e=null!=a?this._getZoomPoint(a):{x:b.x+b.width/2,y:b.y+b.height/2},f=e.x,g=e.y;return{x:f*c+(b.x-f)*d,y:g*c+(b.y-g)*d,width:b.width*d,height:b.height*d}},_reverseElementZoomRect:function(a,b){var c=this.getLocationZoom(a),d=this.getSizeZoom(a);if(1==c&&1==d)return Hb.cloneRect(b);var e=null!=a?this._getZoomPoint(a):{x:b.x+b.width/2,y:b.y+b.height/2},f=e.x,g=e.y;return{x:f+(b.x-f*c)/d,y:g+(b.y-g*c)/d,width:b.width/d,height:b.height/d}},_getZoomContentRect:function(a,b,c,d,e,f){var g=this.getSizeZoom(a.getElementUI()),h=this.getAttachmentSizeZoom(a),i=a.getElementUI();return void 0==f?i instanceof Gb.vector.GroupUI&&i._shapeRect?{x:d.x*e+1*(b.x-d.x)+(c.x-b.x)*h,y:d.y*e+1*(b.y-d.y)+(c.y-b.y)*h,width:c.width,height:c.height}:{x:d.x*e+(b.x-d.x)*g+(c.x-b.x)*h,y:d.y*e+(b.y-d.y)*g+(c.y-b.y)*h,width:c.width,height:c.height}:{x:d.x*e+(b.x-d.x)*g+(c.x-b.x)*h,y:d.y*e+(b.y-d.y)*g+(c.y-b.y)*h+f*(a.textHeight-4)*h,width:c.width,height:a.textHeight}},_getAttachmentZoomRect:function(a,b,c){var d=this.getLocationZoom(a.getElementUI()),e=a.getElementUI(),f=this.getSizeZoom(a.getElementUI()),g=this.getAttachmentSizeZoom(a),h=a._pointers;if(1==d&&1==g&&1==f)return void 0==c?b:{x:b.x,y:b.y+c*(a.textHeight-4),width:b.width,height:a.textHeight};var e=a.getElementUI(),i=this._getZoomPoint(e,a),j=(i.x,i.y,a.getPosition?a.getPosition():"center"),k=h?h[0]:Rd.get(j,b);return void 0==c?e instanceof Gb.vector.LinkUI||e instanceof Gb.vector.GroupUI&&e._shapeRect?this._getZoomContentRect(a,k,b,i,1):this._getZoomContentRect(a,k,b,i,d):this._getZoomContentRect(a,k,b,i,d,c)},_getZoomPoint:function(a,b){var c,d,e=a._element;if(e instanceof Gb.Follower&&e.getHost()&&e.getHost()instanceof Gb.Grid)return c=e.getHost(),d=c.getRect(),{x:d.x+d.width/2,y:d.y+d.height/2};if(d=a.getBodyRect(),a instanceof Gb.vector.LinkUI&&b&&b.getPosition){{b.getXOffset(),b.getYOffset()}if("from"===b.getPosition())return a._fromPoint;if("to"===b.getPosition())return a._toPoint}return{x:d.x+d.width/2,y:d.y+d.height/2}},_getZoomPointers:function(a,b,c){if(c){var d=this._getZoomPoint(b),e=this.getLocationZoom(b),f=this.getSizeZoom(b),g=this.getAttachmentSizeZoom(a),h=c[0];return b instanceof Gb.vector.LinkUI?[{x:d.x+(h.x-d.x)*f,y:d.y+(h.y-d.y)*f},{x:d.x+(h.x-d.x)*f+(c[1].x-h.x)*g,y:d.y+(h.y-d.y)*f+(c[1].y-h.y)*g},{x:d.x+(h.x-d.x)*f+(c[2].x-h.x)*g,y:d.y+(h.y-d.y)*f+(c[2].y-h.y)*g}]:b instanceof Gb.vector.GroupUI&&b._shapeRect?[{x:d.x+1*(h.x-d.x),y:d.y+1*(h.y-d.y)},{x:d.x+1*(h.x-d.x)+(c[1].x-h.x)*g,y:d.y+1*(h.y-d.y)+(c[1].y-h.y)*g},{x:d.x+1*(h.x-d.x)+(c[2].x-h.x)*g,y:d.y+1*(h.y-d.y)+(c[2].y-h.y)*g}]:[{x:d.x*e+(h.x-d.x)*f,y:d.y*e+(h.y-d.y)*f},{x:d.x*e+(h.x-d.x)*f+(c[1].x-h.x)*g,y:d.y*e+(h.y-d.y)*f+(c[1].y-h.y)*g},{x:d.x*e+(h.x-d.x)*f+(c[2].x-h.x)*g,y:d.y*e+(h.y-d.y)*f+(c[2].y-h.y)*g}]}},_getZoomHotSpot:function(a,b){if(b){var c=this._getZoomPoint(a),d=this.getLocationZoom(a),e=this.getSizeZoom(a);return{x:c.x*d+(b.x-c.x)*e,y:c.y*d+(b.y-c.y)*e}}return null},limitZoom:function(a){return a},_isVisible:function(a){var b,c=this._getZoomVisibilityThresholds(),d=c[a];if(null!=d){var e=c.zoomName;if(b="sizeZoom"==e?this.getSizeZoom():"locationZoom"==e?this.getLocationZoom():"graphicsZoom"==e?this.getGraphicsZoom():this.getZoom(),d>b)return!1}return!0},isElementVisible:function(a){var b=this.getZoom(),c=this._isVisible("element",b);

return c&&a instanceof Gb.Link?this.isLinkVisible(a):c},isLinkVisible:function(a){var b=this.getZoom();return this._isVisible("link",b)},isLabelVisible:function(a){var b=this.getZoom();return this._isVisible("label",b)},isAttachmentVisible:function(a){var b=this.getZoom();return this._isVisible("attachment",b)},isAlarmBalloonVisible:function(a){var b=this.getZoom();return this._isVisible("alarmBallon",b)},_getAttachmentOutLineWidth:function(a){return a.getOutlineWidth()},_getAttachmentZoomOutLineRect:function(a,b){var c=this.getLocationZoom(a.getElementUI()),d=this.getAttachmentSizeZoom(a);if(1==c&&1==d)return b;var e=this._getAttachmentZoomRect(a,b,null),f=a.getElement();return this.isAttachmentVisible(f)?(a instanceof Gb.vector.LabelAttachment||a instanceof Gb.vector.Label2Attachment)&&!this.isLabelVisible(f)?{x:e.x,y:e.x,width:0,height:0}:a instanceof Gb.vector.AlarmAttachment&&!this.isAlarmBalloonVisible(f)?{x:e.x,y:e.x,width:0,height:0}:{x:e.x,y:e.y,width:e.width*d,height:e.height*d}:{x:e.x,y:e.x,width:0,height:0}},_drawText:function(a,b,c,d,e,f,g){var h=this.getLocationZoom(a.getElementUI()),i=this.getAttachmentSizeZoom(a);1!=h&&1!=i?(b.translate(d.x,d.y),b.scale(i,i),Vb.drawText(b,c,{x:0,y:0,width:d.width,height:d.height},e,f,g),b.scale(1/i,1/i),b.translate(-d.x,-d.y)):Vb.drawText(b,c,d,e,f,g)},_getOffset:function(a,b){var c=this.getLocationZoom();return{x:(a.x-b.x)/c,y:(a.y-b.y)/c}}});var Rd={"topleft.topleft":function(a){return{x:a.x+a.width,y:a.y+a.height}},"topleft.topright":function(a){return{x:a.x,y:a.y+a.height}},"top.top":function(a){return{x:a.x+a.width/2,y:a.y+a.height}},"topright.topleft":function(a){return{x:a.x+a.width,y:a.y+a.height}},"topright.topright":function(a){return{x:a.x,y:a.y+a.height}},topleft:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},top:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},topright:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"topleft.bottomleft":function(a){return{x:a.x+a.width,y:a.y}},"topleft.bottomright":function(a){return{x:a.x,y:a.y}},"top.bottom":function(a){return{x:a.x+a.width/2,y:a.y}},"topright.bottomleft":function(a){return{x:a.x+a.width,y:a.y}},"topright.bottomright":function(a){return{x:a.x,y:a.y}},"left.left":function(a){return{x:a.x+a.width,y:a.y+a.height/2}},left:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"left.right":function(a){return{x:a.x,y:a.y+a.height/2}},center:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"right.left":function(a){return{x:a.x+a.width,y:a.y+a.height/2}},right:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"right.right":function(a){return{x:a.x,y:a.y+a.height/2}},"bottomleft.topleft":function(a){return{x:a.x+a.width,y:a.y+a.height}},"bottomleft.topright":function(a){return{x:a.x,y:a.y+a.height}},"bottom.top":function(a){return{x:a.x+a.width/2,y:a.y+a.height}},"bottomright.topleft":function(a){return{x:a.x+a.width,y:a.y+a.height}},"bottomright.topright":function(a){return{x:a.x,y:a.y+a.height}},bottomleft:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},bottom:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},bottomright:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"bottomleft.bottomleft":function(a){return{x:a.x+a.width,y:a.y}},"bottomleft.bottomright":function(a){return{x:a.x,y:a.y}},"bottom.bottom":function(a){return{x:a.x+a.width/2,y:a.y}},"bottomright.bottomleft":function(a){return{x:a.x+a.width,y:a.y}},"bottomright.bottomright":function(a){return{x:a.x,y:a.y}},from:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},to:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},get:function(a,b){if(!b)throw"rect can not be null";var c=Rd[a];if(c)return c(b);throw"Can not resolve '"+a+"' position"}};Gb.vector.PhysicalZoomManager=function(a){Gb.vector.PhysicalZoomManager.superClass.constructor.apply(this,arguments)},Hb.ext("twaver.vector.PhysicalZoomManager",Gb.vector.BaseZoomManager,{getGraphicsZoom:function(){return this.getZoom()},_invalidateZoom:function(){}}),Gb.vector.LogicalZoomManager=function(a,b){Gb.vector.LogicalZoomManager.superClass.constructor.apply(this,arguments),this.sizeChange=b},Hb.ext("twaver.vector.LogicalZoomManager",Gb.vector.BaseZoomManager,{getLocationZoom:function(a){return this.getZoom()},getSizeZoom:function(a){return this.sizeChange?this.getZoom():1}}),Gb.vector.MixedZoomManager=function(a,b){Gb.vector.MixedZoomManager.superClass.constructor.call(this,a,b)},Hb.ext("twaver.vector.MixedZoomManager",Gb.vector.LogicalZoomManager,{}),function(){function a(a){d[a]=function(){return this.getZoom()>1?b[a].apply(this,arguments):c[a].apply(this,arguments)}}var b=Gb.vector.LogicalZoomManager.prototype,c=Gb.vector.PhysicalZoomManager.prototype,d=Gb.vector.MixedZoomManager.prototype;for(var e in c)"function"==typeof c[e]&&"constructor"!=e&&(b.hasOwnProperty(e)||c.hasOwnProperty(e))&&a(e);d._invalidateZoom=function(){this.network.invalidateElementUIs()}}(),Gb.vector.interaction.BaseInteraction=function(a){this.network=a},Hb.ext("twaver.vector.interaction.BaseInteraction",Object,{setUp:function(){},tearDown:function(){},repaint:function(){this.network.repaintTopCanvas()},getOffset:function(a,b){return this.network.getOffset(a,b)},convertPointFromView:function(a){return this.network.convertPointFromView(a)},convertFromUIToMarkerRect:function(a,b,c,d){var e=this.network.zoomManager,f=e.getLocationZoom(),g=e.getGraphicsZoom(),h=e.getSizeZoom(this.network.getElementUI(d));return{x:a.x*f*g-this.network.getViewRect().x+b*f*g,y:a.y*f*g-this.network.getViewRect().y+c*f*g,width:a.width*h*g,height:a.height*h*g}},getMarkerPoint:function(a){var b;if(Ob.isTouchable&&a.changedTouches&&a.changedTouches.length>0){var c=a.changedTouches[0];return b={x:c.clientX,y:c.clientY}}return b=Ob.isFirefox?{x:a.layerX,y:a.layerY}:{x:a.offsetX,y:a.offsetY}},paint:function(a){},addListener:function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];Ub.addEventListener(b,"handle_"+b,this.network.getView(),this)}},removeListener:function(){for(var a=0;a<arguments.length;a++)Ub.removeEventListener(arguments[a],this.network.getView(),this)},_handle_mousedown:function(a){0===a.button&&(this._startLogical=this.network.getLogicalPoint2(a),this._startClient=Ub.getClientPoint(a),this._startLogical&&Ub.handle_mousedown(this,a))},_handle_mousemove:function(a){this._endLogical={x:this._startLogical.x+(a.clientX-this._startClient.x)/this.network.getGraphicsZoom(),y:this._startLogical.y+(a.clientY-this._startClient.y)/this.network.getGraphicsZoom()}},_handle_mouseup:function(a){delete this._startClient,delete this._startLogical,delete this._endLogical}}),Gb.vector.interaction.DefaultInteraction=function(a,b){Gb.vector.interaction.DefaultInteraction.superClass.constructor.call(this,a),this.lazyMode=b},Hb.ext("twaver.vector.interaction.DefaultInteraction",Gb.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseover","mouseout","keydown"),Ob.isFirefox?Ub.addEventListener("DOMMouseScroll","handleMouseWheel",this.network.getView(),this):Ub.addEventListener("mousewheel","handleMouseWheel",this.network.getView(),this),Ub.addEventListener("mouseup","handle_mouseup",window,this),Ub.addEventListener("dblclick","handleDoubleClicked",this.network.getView(),this),Ub.addEventListener("blur","handle_blur",this.network.getView(),this),this._oldCursor=this.network.getView().style.cursor,this.network.addPropertyChangeListener(this.handleViewRectChange,this),this.validateScrollBar(),this.network.addMarker(this),this.network.getView().oncontextmenu=function(a){a.preventDefault()},this._createZoomDiv()},tearDown:function(){this.removeListener("mousedown","mouseover","mouseout","keydown"),Ob.isFirefox?Ub.removeEventListener("DOMMouseScroll",this.network.getView(),this):Ub.removeEventListener("mousewheel",this.network.getView(),this),Ub.removeEventListener("mouseup",window,this),Ub.removeEventListener("dblclick",this.network.getView(),this),Ub.removeEventListener("blur",this.network.getView(),this),this.network.removePropertyChangeListener(this.handleViewRectChange,this),this.end(),this.network.removeMarker(this),this._zoomDiv=null},_createZoomDiv:function(){if(null==this._zoomDiv){this._zoomDiv=Mb.createElement("div"),this._zoomLabel=Mb.createElement("span"),this._zoomLabel.style.display="block",this._zoomLabel.style.textAlign="center";var a=Mb.createElement("button");a.innerHTML="Reset to default",this._zoomDiv.appendChild(this._zoomLabel),this._zoomDiv.appendChild(a);var b=Dd,c=this._zoomDiv.style;c.position="absolute",c.color=b.TOOLTIP_COLOR,c.background=b.TOOLTIP_BACKGROUND,c.fontSize=b.TOOLTIP_FONT_SIZE,c.padding=b.TOOLTIP_PADDING,c.border=b.TOOLTIP_BORDER,c.borderRadius=b.TOOLTIP_BORDER_RADIUS,c.boxShadow=b.TOOLTIP_BOX_SHADOW,c.zIndex=b.TOOLTIP_ZINDEX,c.setProperty&&c.setProperty("-webkit-box-shadow",b.TOOLTIP_BOX_SHADOW,null);var d=this;a.onclick=function(a){d.network.setZoom(1),d._setZoomDivVisible(!1)};var e=this._zoomDiv,f=function(){return e.style.opacity=parseFloat(e.style.opacity)-.05,parseFloat(e.style.opacity)<=.05?(d._setZoomDivVisible(!1),void(e._clearTimeout=null)):void(e._clearTimeout=setTimeout(e._clearFunc,100))};e._clearFunc=f,e.onmouseover=function(a){a||(a=window.event);for(var b=a.relatedTarget?a.relatedTarget:a.fromElement;b&&b!=e;)b=b.parentNode;b!=e&&(e._clearTimeout&&(clearTimeout(e._clearTimeout),e._clearTimeout=null),e.style.opacity=1)},e.onmouseout=function(a){a||(a=window.event);for(var b=a.relatedTarget?a.relatedTarget:a.toElement;b&&b!=e;)b=b.parentNode;b!=e&&(e._clearTimeout=setTimeout(e._clearFunc,10))}}},_isZoomDivVisible:function(){return null!=this._zoomDiv&&null!=this._zoomDiv.parentNode},_getZoomDiv:function(){return this._zoomDiv||this._createZoomDiv(),this._zoomDiv},_setZoomDivVisible:function(a,b,c){var d=this._getZoomDiv();if(a){this._zoomLabel.innerHTML=c,d.style.opacity=1,this._isZoomDivVisible()||this.network.getView().appendChild(d),d.style.left=Dd.TOOLTIP_XOFFSET+"px",d.style.top=Dd.TOOLTIP_YOFFSET+"px";d._clearTimeout&&(clearTimeout(d._clearTimeout),d._clearTimeout=null),d._clearTimeout=setTimeout(d._clearFunc,250)}else d.parentNode&&d.parentNode.removeChild(d)},handleViewRectChange:function(a){("viewRect"==a.property||"canvasSizeChange"==a.property)&&this.validateScrollBar()},getScrollBarWidth:function(){return this.network.getScrollBarWidth()},getScrollBarColor:function(){return"#cccccc"},validateScrollBar:function(){if(this.hThumbRect=null,this.vThumbRect=null,0==this.network.isScrollBarVisible())return void this.repaint();var a=this.network.getViewRect().height,b=this.network.getViewRect().width,c=this.network.getViewRect().x,d=this.network.getViewRect().y,e=this.network.getCanvasSize(),f=this.network._unionBounds,g=f.x,h=f.y,i=f.width,j=f.height,k=e.width,l=e.height,m=b,n=a,o=!1,p=!1;(c>g||k>b+c)&&(p=!0),(d>h||l>d+a)&&(o=!0);var q,r,s,t=0,u=0,v=0,w=0,x=m,y=n,z=this.getScrollBarWidth();p&&(o&&(x-=z),w=z,u=n-z,c>g&&c+b>k?(q=c-g,q=q*x/(q+m),t=q,v=x-q):g>c&&k>c+b?(q=k-(c+b),q=x*q/(q+m),t=0,v=x-q):(r=c-g,s=k-(c+b),r=x*r/i,s=x*s/i,t=r,v=m-r-s),this.hThumbRect={x:t,y:u,width:v,height:w}),t=0,u=0,v=0,w=0,x=m,y=n,o&&(p&&(y-=z),v=z,t=m-z,d>h&&d+a>l?(q=d-h,q=y*q/(q+n),u=q,w=y-q):h>d&&l>d+a?(q=l-(d+a),q=y*q/(q+n),u=0,w=y-q):(r=d-h,s=l-(d+a),r=y*r/j,s=y*s/j,u=r,w=y-r-s),this.vThumbRect={x:t,y:u,width:v,height:w}),this.network.setHScrollBarVisible(null!=this.hThumbRect),this.network.setVScrollBarVisible(null!=this.vThumbRect),this.repaint()},scrollXOffset:function(a){var b=this.network.getViewRect().height,c=this.network.getViewRect().width,d=this.network.getViewRect().x,e=this.network.getViewRect().y,f=30;a&&(f=-30),this.network.setViewRect(d+f,e,c,b)},scrollYOffset:function(a){var b=this.network.getViewRect().height,c=this.network.getViewRect().width,d=this.network.getViewRect().x,e=this.network.getViewRect().y,f=30;a&&(f=-30),this.network.setViewRect(d,e+f,c,b)},handle_mouseover:function(a){1!=this.scrollBarVisible&&(this.scrollBarVisible=!0,this.repaint())},handle_mouseout:function(a){0!=this.scrollBarVisible&&null==this.vBarDownPoint&&null==this.hBarDownPoint&&(this.scrollBarVisible=!1,this.repaint(),this.end(a))},handle_keydown:function(a){this.currentKeyEvent=a,this.addListener("keyup"),Bc.handleKeyDown(this.network,a)},handle_keyup:function(a){this.currentKeyEvent=null,this.removeListener("keyup")},start:function(a){this.end(a,!0),this.lastPoint=this.network.getLogicalPoint2(a),this.startPoint=this.network.getLogicalPoint2(a),this.lastPanPoint=this.getMarkerPoint(a),this.lazyMode&&(this.pressPoint=this.lastPoint),Ub.addEventListener("mousemove","handle_mousemove",window,this)},end:function(a,b){if(this.vBarDownPoint=null,this.hBarDownPoint=null,this.network.state.panning&&(this.network.state.panning=!1,this.network.invalidateElementUIs(!0)),b||(this.network.getView().style.cursor=this._oldCursor),this.isMoving){if(this.lazyMode){if(null!=this.dragPoint&&null!=this.pressPoint){var c=this,d=function(){c.network.fireInteractionEvent({kind:"lazyMoveEnd",event:a}),c.network.setMovingElement(!1)},e=this.getOffset(this.dragPoint,this.pressPoint),f=e.x,g=e.y;this.network.moveSelectedElements(f,g,this.network.isLazyMoveAnimate(),d)}}else this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a}));if(this.isParenting()){null==this.parent&&(this.parent=this.network.getCurrentSubNetwork());var c=this;this.network.getMovableSelectedElements().forEach(function(a){a.setParent(c.parent)},this.network)}this.parentProcess(a,!0),this.isParenting()&&this.repaint(),this.network.invalidateCanvasSize(),this.lastPoint=null,this.dragPoint=null,this.pressPoint=null,this.repaint()}if(this.isSelecting&&this.startPoint){if(this.endPoint&&this.startPoint.x!==this.endPoint.x&&this.startPoint.y!==this.endPoint.y){var h=Rb.getRect([this.startPoint,this.endPoint]),i=this.network.getElementsAtRect(h,this.getIntersectMode(),this.network.getRectSelectFilter());if(i&&i.size()>0){var j=this.network.getSelectionModel(),k=j.toSelection();i.forEach(function(a){j.contains(a)?k.remove(a):k.add(a)},this),j.setSelection(k)}this.network.fireInteractionEvent({kind:"selectEnd",event:a})}this.network.setSelectingElement(!1),this.startPoint=null,this.endPoint=null,this.repaint()}this.isMouseDown=!1,Ub.removeEventListener("mousemove",window,this)},_isDragToSelect:function(a){return!this.network._dragToPan},handle_mousedown:function(a){if(!Ob.isTouchable&&0!==a.button&&this.network.isSelectingElement())return void this.end(a);var b=this.network;if(a.target==b.getView()||a.target==b._topCanvas||a.target==b._rootCanvas){if(this.isMoving=!1,this.isSelecting=!1,this.hBarDownPoint=null,this.vBarDownPoint=null,this._setZoomDivVisible(!1),!this.network.isValidEvent(a)){var c=this.getMarkerPoint(a);return this.start(a),null!=this.vThumbRect&&Rb.containsPoint(this.vThumbRect,c.x,c.y)&&(this.vBarDownPoint={x:a.screenX,y:a.screenY},this.vBarDownOffset=this.vBarDownPoint.y-this.vThumbRect.y),void(null!=this.hThumbRect&&Rb.containsPoint(this.hThumbRect,c.x,c.y)&&(this.hBarDownPoint={x:a.screenX,y:a.screenY},this.hBarDownOffset=this.hBarDownPoint.x-this.hThumbRect.x))}this.network.isFocusOnClick()&&Gb.Util.setFocus(this.network.getView());var d=this.network.getElementAt(a),e=this.network.getElementsAt(a);if(e&&e instanceof md)for(var f=0;f<e.size();f++){var g=e.get(f),h=this.network.getElementBox().getSelectionModel().isSelectable(g);if(h){d=g;break}}if(this.network.isSelectingElement()||this.network.isEditingElement()||null==d||(this.network.isMovable(d)&&this.network.getElementBox().getSelectionModel().isSelectable(d)?this.isMoving=!0:this.network.getView().style.cursor="pointer",this.start(a)),!this.network.isSelectingElement()&&!this.network.isEditingElement()){var i=this.network.getSelectionModel();null==d||d&&!this.network.getElementBox().getSelectionModel().isSelectable(d)?(Hb.isCtrlDown(a)?this.isSelecting=!0:this._isDragToSelect(a)?(this.isSelecting=!0,i.clearSelection()):this.network.isRectSelectEnabled()&&(i.clearSelection(),this.network.getView().style.cursor="pointer"),this.start(a)):Hb.isCtrlDown(a)?i.contains(d)?i.removeSelection(d):i.appendSelection(d):i.contains(d)||i.setSelection(d)}this.handleClicked(a,d),this.isMouseDown=!0}},handle_mousemove:function(a){this._setZoomDivVisible(!1);var b=this.network.getLogicalPoint2(a);if(b){var c={x:a.screenX,y:a.screenY},d=this.network.getCanvasSize(),e=this.network.getViewRect().height,f=this.network.getViewRect().width,g=this.getScrollBarWidth();if(null!=this.hBarDownPoint){var h=c.x-this.hBarDownPoint.x;return this.hBarDownPoint=c,void this.network.setViewOffSet(h*d.width/(f-g),0)}if(null!=this.vBarDownPoint){var i=c.y-this.vBarDownPoint.y;return this.vBarDownPoint=c,void this.network.setViewOffSet(0,i*d.height/(e-g))}if(this.network.isSelectingElement()||this.network.isEditingElement()||!this.isMoving||!this.isMouseDown||Hb.isCtrlDown(a))if(this.isSelecting&&(Hb.isCtrlDown(a)||this._isDragToSelect()))this.network.setSelectingElement(!0),this.network.fireInteractionEvent(null==this.endPoint?{kind:"selectStart",event:a}:{kind:"selectBetween",event:a}),this.endPoint=b,this.repaint();else if(this.isMoving||this.isSelecting||!this.isMouseDown)this.end(a);else{if(!this.lastPanPoint||!this.network._dragToPan)return;var b=this.getMarkerPoint(a);if(!b)return;var j=b.x-this.lastPanPoint.x,k=b.y-this.lastPanPoint.y;this.network.panByOffset(-j,-k),this.network.fireInteractionEvent({kind:"panning",event:a}),this.network.state.panning=!0,this.lastPanPoint=b}else{var l=this.getOffset(b,this.lastPoint);if(this.xoffset=l.x,this.yoffset=l.y,Math.abs(this.xoffset)<1&&Math.abs(this.yoffset)<1)return;this.lazyMode?null==this.dragPoint?(this.network.fireInteractionEvent({kind:"lazyMoveStart",event:a}),this.network.setMovingElement(!0)):this.network.fireInteractionEvent({kind:"lazyMoveBetween",event:a}):(this.lastPoint=b,this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a})),this.network.moveSelectedElements(this.xoffset,this.yoffset)),this.parentProcess(a,!1),this.lazyMode&&(this.dragPoint=b),(this.lazyMode||this.isParenting())&&this.repaint()}}},handleMouseWheel:function(a){if(Mb.activeElement===this.network.getView()){if(!this.network._wheelToZoom)return void this._handleMouseWheelScroll(a);Ub.preventDefault(a);var b={x:a.offsetX||a.layerX,y:a.offsetY||a.layerY},c=this.network.getZoom();a.wheelDelta&&a.wheelDelta>0||a.detail&&a.detail<0?this.network.setZoom(1.1*c,b):this.network.setZoom(c/1.1,b),this._setZoomDivVisible(this.network.isZoomDivVisible(),a,"Zoom : "+parseFloat(this.network.getZoom().toFixed(4)))}},_handleMouseWheelScroll:function(a){Ub.preventDefault(a);var b=!1,c=this._getVisibleScrollBar();null!=c&&(b=a.wheelDelta?a.wheelDelta>0:a.detail<0,"v"==c?this.scrollYOffset(b):this.scrollXOffset(b))},handle_mouseup:function(a){this.end(a)},isParenting:function(){return this.pressPoint&&null!=this.currentKeyEvent&&80===this.currentKeyEvent.keyCode},parentProcess:function(a,b){var c=null;this.parent=null;var d=this;if(!b&&this.isParenting()){var e={},f=this.network.getLogicalPoint2(a);e.x=f.x-1,e.y=f.y-1,e.width=2,e.height=2;var g=this.network.getElementsAtRect(e,!0);if(g&&g.size()>0)for(var h=g.size(),i=0;h>i;i++){var j=g.get(i);if(!d.network.getElementBox().getSelectionModel().contains(j)){d.parent=j;break}}}else this.parent=null;null!=this.parent&&(c=this.network.getElementUI(this.parent).getViewRect()),this.parentRect=null==c||b?null:c},getIntersectMode:function(){return"intersect"===this.network.getSelectMode()?!0:"contain"===this.network.getSelectMode()?!1:this.startPoint.x>this.endPoint.x&&this.startPoint.y>this.endPoint.y},_getVisibleScrollBar:function(){return 0==this.network.isScrollBarVisible()?null:null!=this.vThumbRect?"v":null!=this.hThumbRect?"h":null},paintScroll:function(a){if(0!=this.network.isScrollBarVisible()&&(0!=this.scrollBarVisible||null!=this.hBarDownPoint||null!=this.vBarDownPoint)){var b=this.getScrollBarWidth(),c=this.network.getViewRect().height,d=this.network.getViewRect().width;a.save();var e,f=this.getScrollBarColor();null!=this.hThumbRect&&(e=a.createLinearGradient(this.hThumbRect.x,this.hThumbRect.y,this.hThumbRect.x,this.hThumbRect.y+this.hThumbRect.height),e.addColorStop(0,f),e.addColorStop(1,"#666666"),this.paintRoundRect(a,this.getScrollBarColor(),.5,0,c-b,d-b,b,b/2),this.paintRoundRect(a,e,.9,this.hThumbRect.x,this.hThumbRect.y+1,this.hThumbRect.width,this.hThumbRect.height-2,b/2)),null!=this.vThumbRect&&(e=a.createLinearGradient(this.vThumbRect.x,this.vThumbRect.y,this.vThumbRect.x+this.vThumbRect.width,this.vThumbRect.y),e.addColorStop(0,f),e.addColorStop(1,"#666666"),this.paintRoundRect(a,this.getScrollBarColor(),.5,d-b,0,b,c-b,b/2),this.paintRoundRect(a,e,.9,this.vThumbRect.x+1,this.vThumbRect.y,this.vThumbRect.width-2,this.vThumbRect.height,b/2)),a.restore()}},paintRoundRect:function(a,b,c,d,e,f,g,h){a.beginPath(),a.globalAlpha=c,a.fillStyle=b,Vb.drawRoundRect(a,d,e,f,g,h),a.fill()},paint:function(a){if(this.paintScroll(a),this.network.isSelectingElement()){if(null==this.startPoint||null==this.endPoint)return;var b=this.convertPointFromView(this.startPoint),c=this.convertPointFromView(this.endPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Rb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.network.getSelectOutlineWidth(),j=this.getIntersectMode()?this.network.getSelectFillColor():null;a.strokeStyle=this.network.getSelectOutlineColor(),a.lineWidth=i,Od.rect(a,h.x,h.y,h.width,h.height,j,this.network.getSelectOutlineColor()),a.closePath()}}else{if(this.lazyMode){if(null==this.pressPoint||null==this.dragPoint)return;a.beginPath();var k=this.getOffset(this.dragPoint,this.pressPoint),l=k.x,m=k.y,n=this.network.getMovableSelectedElements(),o=n.size(),p=this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,i=this.network.getLazyMoveOutlineWidth(),q=this.network.getLazyMoveOutlineColor();a.strokeStyle=q,a.lineWidth=i,a.fillStyle=p;for(var r=0;o>r;r++){var s=n.get(r),t=this.network.getElementUI(s);if(t){var u=this.convertFromUIToMarkerRect(t.getViewRect(),l,m);Od.rect(a,u.x,u.y,u.width,u.height)}}a.fill(),a.stroke()}if(this.parentRect){a.beginPath();var p=this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,i=this.network.getLazyMoveOutlineWidth(),q=this.network.getLazyMoveOutlineColor();a.strokeStyle=q,a.lineWidth=i,a.fillStyle=p;var u=this.parentRect;Od.rect(a,u.x,u.y,u.width,u.height),a.fill(),a.stroke()}}},handleClicked:function(a,b){Bc.handleClicked(this.network,a,b)},handleDoubleClicked:function(a){var b=this.network.getElementAt(a);Bc.handleDoubleClicked(this.network,a,b)},handle_blur:function(a){this.end()}}),Gb.vector.interaction.CreateElementInteraction=function(a,b){b||(b=Gb.Node),this.elementFunction=Gb.Util.isTypeOf(b,Gb.Node)?function(a){var c=new b;return c instanceof Gb.Node&&c.setCenterLocation(a),c}:b,Gb.vector.interaction.CreateElementInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.vector.interaction.CreateElementInteraction",Gb.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown")},handle_mousedown:function(a){var b=this.network.getLogicalPoint2(a);if(b){var c=this.elementFunction(b);c&&this.network.addElementByInteraction(c)}}}),Gb.vector.interaction.EditInteraction=function(a,b){this.lazyMode=b,this.pointIndex=-1,this.linkPointsType=null,Gb.vector.interaction.EditInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.vector.interaction.EditInteraction",Gb.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup","mousemove"),this.oldCursor=this.network.getView().style.cursor,this.network.setHasEditInteraction(!0),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseup","mousemove"),this.network.getView().style.cursor=this.oldCursor,this.network.setHasEditInteraction(!1),this.clear(),this.network.removeMarker(this)},paint:function(a){if(1==this.lazyMode&&null!=this.resizingRect){a.lineWidth=this.network.getResizeLineWidth();var b=this.convertFromUIToMarkerRect(this.resizingRect,0,0,this.node);a.save(),Gb.Util.rotateCanvas(a,b,this.node.getAngle()),a.beginPath(),Od.rect(a,b.x,b.y,b.width,b.height,null,this.network.getResizeLineColor()),a.restore()}this.isStartRotate&&this.showRotateScale(a)},clear:function(){this.network.setEditingElement(!1),this.network.setRotatingElement(!1),this.isStart=!1,this.isStartRotate=!1,this.node=null,this.shapeNode=null,this.shapeLink=null,this.linkUI=null,this.resizingRect=null,this.resizeDirection=null,this.pointIndex=-1,this._removeCursor(),this.oldCursor=null,this.network.repaintTopCanvas()},_removeCursor:function(){this.cursorID&&(this.network.getView().style.cursor=this.oldCursor||"default",this.cursorID=null),this.resizeDirection=null,this.isCrossCursor=!1},_setCrossCursor:function(){this.isCrossCursor||(this._removeCursor(),this._setCursor("crosshair"),this.isCrossCursor=!0)},_setCursor:function(a){this.cursorID=a,this.network.getView().style.cursor!==this.cursorID&&(this.network.getView().style.cursor=this.cursorID)},isKeyDown:function(a){return Hb.isAltDown(a)},handle_mousedown:function(a){if(0===a.button)if(!this.isKeyDown(a)||this.network.isEditingElement())!this.network.isEditingElement()||this.isStart||this.isStartRotate||(this.node&&this.resizeDirection?(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:this.lazyMode?"lazyResizeStart":"liveResizeStart",event:a,element:this.node,resizeDirection:this.resizeDirection})):this.shapeNode&&this.pointIndex>=0?this.isKeyDown(a)?(this.shapeNode.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeNode})):(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink?this.isKeyDown(a)?this.pointIndex>=0&&(this.shapeLink.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeLink})):(this.isStart=!0,this._handle_mousedown(a),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI?(this.isStart=!0,this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.linkUI._element})):this.node&&(this.isStartRotate=!0,this._handle_mousedown(a)));else{var b=this.network.getElementAt(a),c=this.network.getLogicalPoint2(a);if(b instanceof Gb.ShapeNode){var d=this.getPointIndex(this.network.getShapeNodeZoomPoints(b),c,!0);d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeNode=b,b.addPoint(c,d),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}if(b instanceof Gb.ShapeLink){var e=new Gb.List(b.getPoints()),f=this.network.getElementUI(b);e.add(f.getFromPoint(),0),e.add(f.getToPoint());var d=this.getPointIndex(e,c)-1;d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeLink=b,b.addPoint(c,d),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.network.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}}},handle_mouseup:function(a){if(this.isStart){var b=this.network.getLogicalPoint2(a);if(this.resizingRect)if(this.lazyMode)if(this.network.isResizeAnimate()){var c=this,d=new Gb.animate.AnimateBounds(this.node,this.resizingRect,function(){c.network.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:c.node,resizeDirection:c.resizeDirection}),c.clear()});Gb.animate.AnimateManager.start(d)}else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"liveResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.shapeNode&&this.pointIndex>=0&&b?(this._resetShapeNodePoints(b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):b&&(this.shapeLink||this.linkUI)&&("from"===this.linkPointsType?this._setFromPoint(b):"to"===this.linkPointsType?this._setToPoint(b):"shapeControl"===this.linkPointsType?(this._resetShapeLinkPoints(b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):"control"===this.linkPointsType&&wc.isOrthogonalLink(this.linkUI._element)&&this.linkUI.getControlPoint()&&(this._setLinkControlPoint(b),this.network.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.linkUI._element})))}this._handle_mouseup(a),this.clear()},handle_mousemove:function(a){var b=this.network.getEditPointSize();if(this.network.isValidEvent(a)){if(this.isStartRotate&&this.node)return this._handleRotateElement(a,this.node),void(this.network.isShowRotateScale()&&this.repaint());if(this.isStart){if(this.shapeNode&&this.pointIndex>=0)return void this._handleMovingShapeNodePoint(a);if(this.node&&this.resizeDirection)return void this._handleResizing(a);if((this.shapeLink||this.linkUI)&&this.linkPointsType){if("from"===this.linkPointsType)return void this._handleMovingFromPoint(a);if("to"===this.linkPointsType)return void this._handleMovingToPoint(a);if("shapeControl"===this.linkPointsType)return void this._handleMovingShapeLinkPoint(a);if("control"===this.linkPointsType&&wc.isOrthogonalLink(this.linkUI._element)&&this.linkUI.getControlPoint())return void this._handleMovingLinkControlPoint(a)}}if(this.network.isSelectingElement()||this.network.isMovingElement()||0===this.network.getSelectionModel().size())return void this.clear();var c=this.network.getElementAt(a),d=this.network.getElementUI(c);if(!d||!d.getEditAttachment())return void this.clear();var e=this.network.getLogicalPoint2(a);if(c instanceof Gb.Node){if(this.node=c,this._isEditingShapeNode(e)||this._isResizingNode(e))return void this.network.setEditingElement(!0);if(this._isRotatingElement(e))return this.network.setRotatingElement(!0),void this.network.setEditingElement(!0)}else if(c instanceof Gb.Link){c instanceof Gb.ShapeLink?this.shapeLink=c:d instanceof Gb.vector.LinkUI&&(this.linkUI=d);var f,g=c.getFromAgent();f=g?c.getFromAgent():c.getFromNode();var h,i=c.getStyle("link.from.xoffset"),j=c.getStyle("link.from.yoffset"),k=this.network.getElementUI(f),l=k.getZoomBodyRect(),m={x:l.x+l.width/2,y:l.y+l.height/2},n={x:m.x+i,y:m.y+j},o=c.getToAgent();h=o?c.getToAgent():c.getToNode();var p=c.getStyle("link.to.xoffset"),q=c.getStyle("link.to.yoffset"),r=this.network.getElementUI(h),s=r.getZoomBodyRect(),t={x:s.x+s.width/2,y:s.y+s.height/2},u={x:t.x+p,y:t.y+q};if(n&&this._contains(e,n,b))return this.linkPointsType="from",this._setCrossCursor(),void this.network.setEditingElement(!0);if(u&&this._contains(e,u,b))return this.linkPointsType="to",this._setCrossCursor(),void this.network.setEditingElement(!0);if(c instanceof Gb.ShapeLink){if(this._isEditingShapeLink(e))return this.linkPointsType="shapeControl",void this.network.setEditingElement(!0)}else if(d instanceof Gb.vector.LinkUI){if(wc.isOrthogonalLink(d._element)){var v=this.linkUI.getControlPoint();if(v&&this._contains(e,v,b))return this.linkPointsType="control",this._setCrossCursor(),void this.network.setEditingElement(!0)}return void(this.linkPointsType=null);

}this.linkPointsType=null}this.clear()}},_isRotatingElement:function(a){var b=this.network.getRotatePointSize();if(0>=b)return!1;var c=this.network.zoomManager,d=this.network.getElementUI(this.node),e=c.getSizeZoom(d),f=c._getElementZoomRect(d,this.node.getOriginalRect()),g=this.node.getAngle();return this._isRotating(a,"crosshair",f,g,e)},_isRotating:function(a,b,c,d,e){var f=this.network.getRotatePointSize()/this.network.getGraphicsZoom(),g={x:c.x+c.width/2,y:c.y-this.network.getRotatePointOffset()/this.network.getGraphicsZoom()-f},h=this._rotatePoint(g,d,c),i={x:h.x-f,y:h.y-f,width:2*f,height:2*f};return Rb.containsPoint(i,a)?(this._removeCursor(),this._setCursor(b),!0):!1},_handleRotateElement:function(a,b){this._handle_mousemove(a);var c=this._calculateAngle(this.network.getLogicalPoint2(a),b);b.setAngle(c)},_calculateAngle:function(a,b){var c=this.network.getZoomBodyRect(b),d=Rb.getCenterPoint(c);return Math.round(180*Math.atan2(d.x-a.x,a.y-d.y)/Math.PI+180)},_resetShapeNodePoints:function(a){var b=this.network.getShapeNodeZoomPoints(this.shapeNode);b.set(this.pointIndex,a);var c=this.network.getElementUI(this.shapeNode),d=this.network.zoomManager._getShapeNodeZoomPoints(c,b,!0);this.shapeNode.setPoints(d)},_handleMovingShapeNodePoint:function(a){var b=this.network.getLogicalPoint2(a);this._resetShapeNodePoints(b),this.network.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeNode,pointIndex:this.pointIndex})},_resetShapeLinkPoints:function(a){var b=this.network.zoomManager._getShapeLinkZoomPoints(this.shapeLink._points);b.set(this.pointIndex,a);var c=this.network.zoomManager._getShapeLinkZoomPoints(b,!0);this.shapeLink.setPoints(c)},_handleMovingShapeLinkPoint:function(a){var b=this.network.getLogicalPoint2(a);this._resetShapeLinkPoints(b),this.network.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeLink,pointIndex:this.pointIndex})},_setLinkControlPoint:function(a){var b=this.linkUI.getControlPoint(),c=this.linkUI.getControlPoint(),d=(this.network.zoomManager,{x:a.x-c.x,y:a.y-c.y});b.x+=d.x,b.y+=d.y,this.linkUI.setControlPoint(b)},_handleMovingLinkControlPoint:function(a){var b=this.network.getLogicalPoint2(a);this._setLinkControlPoint(b),this.network.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.linkUI._element})},_setFromPoint:function(a){var b;if(this.linkUI)b=this.linkUI._element;else{if(!this.shapeLink)return;b=this.shapeLink}var c,d=b.getFromAgent();c=d?b.getFromAgent():b.getFromNode();var e=this.network.getElementUI(c),f=e.getZoomBodyRect(),g={x:f.x+f.width/2,y:f.y+f.height/2},h={x:a.x-g.x,y:a.y-g.y};b.setStyle("link.from.xoffset",h.x),b.setStyle("link.from.yoffset",h.y)},_handleMovingFromPoint:function(a){var b=this.network.getLogicalPoint2(a);this._setFromPoint(b)},_setToPoint:function(a){var b;if(this.linkUI)b=this.linkUI._element;else{if(!this.shapeLink)return;b=this.shapeLink}var c,d=b.getToAgent();c=d?b.getToAgent():b.getToNode();var e=this.network.getElementUI(c),f=e.getZoomBodyRect(),g={x:f.x+f.width/2,y:f.y+f.height/2},h={x:a.x-g.x,y:a.y-g.y};b.setStyle("link.to.xoffset",h.x),b.setStyle("link.to.yoffset",h.y)},_handleMovingToPoint:function(a){var b=this.network.getLogicalPoint2(a);this._setToPoint(b)},convertFromUIToMarkerRect:function(a,b,c,d){var e=this.network.zoomManager,f=e.getLocationZoom(),g=e.getGraphicsZoom(),h=this.network.getElementUI(d),i=e.getSizeZoom(h),j=a.x+a.width/2,k=a.y+a.height/2,l=j-a.x,m=k-a.y;return{x:j*f*g-this.network.getViewRect().x+b*f*g-l*i*g,y:k*f*g-this.network.getViewRect().y+c*f*g-m*i*g,width:a.width*i*g,height:a.height*i*g}},_getReverseZoomPoint:function(a,b,c){var d=this.network.zoomManager,e=d.getLocationZoom(),f=d.getSizeZoom(this.network.getElementUI(a));return b.x*=e,b.y*=e,{x:b.x/e+(c.x-b.x)/f,y:b.y/e+(c.y-b.y)/f}},_getReverseZoomRect:function(a,b){var c=this.network.zoomManager,d=c.getLocationZoom(),e=c.getSizeZoom(f);if(d==e)return a;var f=this.network.getElementUI(b),g=f.getBodyRect(),h=g.x+g.width/2,i=g.y+g.height/2,j={x:h*d+(a.x-h)*e,y:i*d+(a.y-i)*e,width:a.width*e,height:a.height*e};return h=j.x+j.width/2,i=j.y+j.height/2,{x:h/d+(j.x-h)*e,y:i/d+(j.y-i)*e,width:a.width,height:a.height}},_handleResizing:function(a){this._handle_mousemove(a);var b=this.node.getAngle(),c=this.node.getLocation(),d=this.node.getWidth()/2,e=this.node.getHeight()/2,f={x:c.x+d,y:c.y+e},g={x:-d,y:-e},h={x:-d,y:e},i={x:d,y:e},j={x:d,y:-e},k={x:0,y:-e},l={x:d,y:0},m={x:0,y:e},n={x:-d,y:0},o=this._getReverseZoomPoint(this.node,Hb.clone(f),this._endLogical);if("northwest"===this.resizeDirection&&(this._transformPoint(i,f,b),g.x=o.x,g.y=o.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y},Hb.isShiftDown(a)&&this._revertResizeRect(this.node,this.resizingRect,1)),"north"===this.resizeDirection){var p={x:o.x,y:o.y};this._reversPoint(p,f,b),k.y=p.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}if("northeast"===this.resizeDirection&&(this._transformPoint(h,f,b),j.x=o.x,j.y=o.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y},Hb.isShiftDown(a)&&this._revertResizeRect(this.node,this.resizingRect,2)),"west"===this.resizeDirection){var p={x:o.x,y:o.y};this._reversPoint(p,f,b),n.x=p.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("east"===this.resizeDirection){var p={x:o.x,y:o.y};this._reversPoint(p,f,b),l.x=p.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("southwest"===this.resizeDirection&&(this._transformPoint(j,f,b),h.x=o.x,h.y=o.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y},Hb.isShiftDown(a)&&this._revertResizeRect(this.node,this.resizingRect,4)),"south"===this.resizeDirection){var p={x:o.x,y:o.y};this._reversPoint(p,f,b),m.y=p.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}"southeast"===this.resizeDirection&&(this._transformPoint(g,f,b),i.x=o.x,i.y=o.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y},Hb.isShiftDown(a)&&this._revertResizeRect(this.node,this.resizingRect,3)),this.resizingRect=this._getReverseZoomRect(this.resizingRect,this.node),this.lazyMode?(this.repaint(),this.network.fireInteractionEvent({kind:"lazyResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection})):(this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:"liveResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection}))},_revertResizeRect:function(a,b,c){var d=a.getOriginalRect(),e=Math.max(b.width/d.width,b.height/d.height),f=d.width*e,g=d.height*e,h=b.x,i=b.y;1==c?(h+=b.width-f,i+=b.height-g):2==c?i+=b.height-g:3==c||4==c&&(h+=b.width-f),b.x=h,b.y=i,b.width=f,b.height=g},_isEditingShapeNode:function(a){var b=this.network.getEditPointSize();if(this.node instanceof Gb.ShapeNode){this.shapeNode=this.node;for(var c=this.network.getShapeNodeZoomPoints(this.node),d=0,e=c.size();e>d;d++){var f=c.get(d);if(this._contains(a,f,b))return this._setCrossCursor(),this.pointIndex=d,!0}}return this.pointIndex=-1,!1},_isEditingShapeLink:function(a){for(var b=this.network.getEditPointSize(),c=this.network.zoomManager._getShapeLinkZoomPoints(this.shapeLink.getPoints()),d=0,e=c.size();e>d;d++){var f=c.get(d);if(this._contains(a,f,b))return this._setCrossCursor(),this.pointIndex=d,!0}return this.pointIndex=-1,!1},_isResizingNode:function(a){var b=this.network.getResizePointSize();if(0>=b)return!1;var c=this.network.zoomManager,d=this.network.getElementUI(this.node),e=c._getElementZoomRect(d,this.node.getOriginalRect()),f=this.node.getAngle(),g={x:e.x,y:e.y},h=this._rotatePoint(g,f,e);return this._isResizing(a,h.x,h.y,"northwest","nwse-resize")?!0:(g={x:e.x+e.width/2,y:e.y},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"north","ns-resize")?!0:(g={x:e.x+e.width,y:e.y},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"northeast","nesw-resize")?!0:(g={x:e.x,y:e.y+e.height/2},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"west","ew-resize")?!0:(g={x:e.x+e.width,y:e.y+e.height/2},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"east","ew-resize")?!0:(g={x:e.x,y:e.y+e.height},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"southwest","nesw-resize")?!0:(g={x:e.x+e.width/2,y:e.y+e.height},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"south","ns-resize")?!0:(g={x:e.x+e.width,y:e.y+e.height},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"southeast","nwse-resize")?!0:!1)))))))},_rotatePoint:function(a,b,c){var d=Rb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_isResizing:function(a,b,c,d,e){var f=this.network.getGraphicsZoom(),g=this.network.getResizePointSize()/f;return this._contains(a,{x:b,y:c},g)?(this.resizeDirection!==d&&(this._removeCursor(),e=this._changeCursorWithAngle(d,this.node.getAngle()),this._setCursor(e),this.resizeDirection=d),!0):!1},_getRect:function(a,b,c,d){var e=c>a?a:c,f=d>b?b:d,g=Math.abs(a-c),h=Math.abs(b-d);return{x:e,y:f,width:g,height:h}},_contains:function(a,b,c){var d={x:b.x-c,y:b.y-c,width:2*c,height:2*c};return Rb.containsPoint(d,a)},getPointIndex:function(a,b,c){if(a.size()<2)return 0;for(var d,e=a.get(0),f=1;f<a.size();f++){if(d=a.get(f),this.isPointOnLine(b,e,d,6))return f;e=d}return e=a.get(0),c&&this.isPointOnLine(b,e,d,6)?a.size():0},showRotateScale:function(a){var b,c,d,e,f,g=(new Gb.List,this.network.getRotateScaleWidth()),h=this.network.getRotateScaleHeight(),i=this.network.getRotatePointSize(),j=this.node.getAngle(),k=this.network.zoomManager,l=this.network.getElementUI(this.node),m=k._getElementZoomRect(l,this.node.getOriginalRect()),n={x:m.x+m.width/2,y:m.y-this.network.getRotatePointOffset()-i},o=this._rotatePoint(n,j,m),p="13px Arial",q=j+"°",r=this.network.getViewRect();1===k.getLocationZoom()&&(a.translate(-r.x,-r.y),a.scale(this.network.getZoom(),this.network.getZoom())),this.node.getAngle()>=0&&this.node.getAngle()<=180?(c={x:o.x+i,y:o.y},d={x:c.x+g,y:c.y},e={x:d.x,y:d.y-h},f={x:c.x,y:e.y}):this.node.getAngle()>180&&this.node.getAngle()<=360&&(c={x:o.x-i,y:o.y},d={x:c.x-g,y:c.y},e={x:d.x,y:d.y-h},f={x:c.x,y:e.y});var s=new Gb.List([c,d,e,f]),b=Hb.math.getRect(s);1!==k.getLocationZoom()&&(b.x-=r.x,b.y-=r.y),a.fillStyle=this.network.getRotateScaleFillColor(),a.fillRect(b.x,b.y,b.width,b.height),a.fillStyle=this.network.getRotateScaleFontColor(),a.textBaseline="middle",a.textAlign="center",a.font=p,a.fillText(q,b.x+b.width/2,b.y+b.height/2),1===k.getLocationZoom()&&(a.scale(1/this.network.getZoom(),1/this.network.getZoom()),a.translate(r.x,r.y))},isPointOnLine:function(a,b,c,d){0>d&&(d=0);var e=this.getDistanceFromPointToLine(a,b,c);return d>=e&&a.x>=Math.min(b.x,c.x)-d&&a.x<=Math.max(b.x,c.x)+d&&a.y>=Math.min(b.y,c.y)-d&&a.y<=Math.max(b.y,c.y)+d},getDistanceFromPointToLine:function(a,b,c){if(b.x===c.x)return Math.abs(a.x-b.x);var d=(c.y-b.y)/(c.x-b.x),e=(c.x*b.y-b.x*c.y)/(c.x-b.x);return Math.abs(d*a.x-a.y+e)/Math.sqrt(d*d+1)},_transformPoint:function(a,b,c){var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x,g=a.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_reversPoint:function(a,b,c){c*=-1;var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x-b.x,g=a.y-b.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_changeCursorWithAngle:function(a,b){var c,d=["auto","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"];switch(a){case"northwest":c=1;break;case"north":c=2;break;case"northeast":c=3;break;case"east":c=4;break;case"southeast":c=5;break;case"south":c=6;break;case"southwest":c=7;break;case"west":c=8;break;default:c=0}return(b>=360||-360>=b)&&(b%=360),b>22.5&&67.5>=b&&(c+=1),-22.5>b&&b>=-67.5&&(c-=1),b>67.5&&112.5>=b&&(c+=2),-67.5>b&&b>=-112.5&&(c-=2),b>112.5&&157.5>=b&&(c+=3),-112.5>b&&b>=-157.5&&(c-=3),b>157.5&&202.5>=b&&(c+=4),-157.5>b&&b>=-202.5&&(c-=4),b>202.5&&247.5>=b&&(c+=5),-202.5>b&&b>=-247.5&&(c-=5),b>247.5&&292.5>=b&&(c+=6),-247.5>b&&b>=-292.5&&(c-=6),b>292.5&&337.5>=b&&(c+=7),-292.5>b&&b>=-337.5&&(c-=7),c>8&&(c-=8),0>=c&&(c+=8),d[c]}}),Gb.vector.interaction.MoveLinkInteraction=function(a,b){Gb.vector.interaction.MoveLinkInteraction.superClass.constructor.call(this,a),this.xoffset=0,this.yoffset=0},Hb.ext("twaver.vector.interaction.MoveLinkInteraction",Gb.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown"),this.oldCursor=this.network.getView().style.cursor},tearDown:function(){this.removeListener("mousedown"),this.network.getView().style.cursor=this.oldCursor,this.end()},handle_mousedown:function(a){if(0===a.button&&!this.network.isSelectingElement()&&!this.network.isEditingElement()){var b=this.network.getElementAt(a);b instanceof Gb.Link&&(this.element=b,this.end(a),this._handle_mousedown(a))}},handle_mouseup:function(a){this.end(a)},handle_mousemove:function(a){if(!this._startLogical||this.network.isSelectingElement()||this.network.isEditingElement())return void this.end(a);if(this._handle_mousemove(a),this.xoffset=this._endLogical.x-this._startLogical.x,this.yoffset=this._endLogical.y-this._startLogical.y,this.lazyMode){if(this.mark)this.network.fireInteractionEvent({kind:"lazyMoveBetween",event:a,element:this.element});else{this.mark=Ub.createCanvas();var b;this.network.getMovableSelectedElements().forEach(function(a){var c=this.getElementUI(a);c&&(b=Rb.unionRect(b,c.getViewRect()))},this.network),this.network.getTopDiv().appendChild(this.mark),this.network.setMovingElement(!0),Ub.setDiv(this.mark,b,this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,this.network.getLazyMoveOutlineWidth(),this.network.getLazyMoveOutlineColor()),this.network.fireInteractionEvent({kind:"lazyMoveStart",event:a,element:this.element})}this.mark.style.left=this.xoffset+this.mark._viewRect.x+"px",this.mark.style.top=this.yoffset+this.mark._viewRect.y+"px"}else{var c=new Gb.List([this.element.getFromNode(),this.element.getToNode()]);Gb.Util.moveElements(c,this.xoffset,this.yoffset),this._startLogical=this._endLogical,this._startClient=Ub.getClientPoint(a),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a,element:this.element}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a,element:this.element}))}},end:function(a){if(this._startLogical){if(this.lazyMode){if(this.mark){var b=this,c=function(){b.network.fireInteractionEvent({kind:"lazyMoveEnd",event:a,element:this.element}),b.mark&&(b.network.getTopDiv().removeChild(b.mark),b.mark=null,b.network.setMovingElement(!1))},d=new Gb.List([this.element.getFromNode(),this.element.getToNode()]);Gb.Util.moveElements(d,this.xoffset,this.yoffset,this.network.isLazyMoveAnimate(),c)}}else this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a,element:this.element}));this._handle_mouseup(a),delete this.element}}}),Gb.vector.interaction.CreateLinkInteraction=function(a,b){b||(b=Gb.Link),this.linkFunction=Gb.Util.isTypeOf(b,Gb.Link)?function(a,c){var d=new b;return d instanceof Gb.Link&&(d.setFromNode(a),d.setToNode(c)),d}:b,Gb.vector.interaction.CreateLinkInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.vector.interaction.CreateLinkInteraction",Gb.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear(),this.network.removeMarker(this)},paint:function(a){a.beginPath();var b,c;a.lineWidth=this.network.getEditLineWidth();var d=this.network.getEditLineColor();this.currentNode&&this.currentNode!==this.fromNode&&(b=this.network.getElementUI(this.currentNode).getZoomViewRect(!0),c=this.convertFromUIToMarkerRect(b,0,0),Od.rect(a,c.x,c.y,c.width,c.height,null,d)),this.fromNode&&(b=this.network.getElementUI(this.fromNode).getZoomViewRect(!0),c=this.convertFromUIToMarkerRect(b,0,0),Od.rect(a,c.x,c.y,c.width,c.height,null,d)),this.currentPoint&&this.paintLine(a),a.closePath()},convertFromUIToMarkerRect:function(a,b,c){var d=this.network.zoomManager,e=d.getGraphicsZoom();return{x:a.x*e-this.network.getViewRect().x+b*e,y:a.y*e-this.network.getViewRect().y+c*e,width:a.width*e,height:a.height*e}},getZoomNodeRectOrPoint:function(a,b){var c=this.network.getElementUI(a).getZoomBodyRect();return b?{x:c.x+c.width/2,y:c.y+c.height/2}:c},paintLine:function(a){var b=this.network.getEditLineColor(),c=this.network.getElementUI(this.fromNode).getZoomBodyRect(),d=this.convertPointFromView({x:c.x+c.width/2,y:c.y+c.height/2}),e=d.x,f=d.y,g=this.currentPoint.x,h=this.currentPoint.y;a.strokeStyle=b,a.beginPath(),a.moveTo(e,f),a.lineTo(g,h),a.stroke()},clear:function(){this.currentPoint=null,this.currentNode=null,this.fromNode=null,this.toNode=null},createLink:function(){return this.linkFunction(this.fromNode,this.toNode)},handle_mousedown:function(a){if(this.network.isValidEvent(a))if(this.fromNode){if(this.toNode=this.currentNode,this.toNode){var b=this.createLink();b&&this.network.addElementByInteraction(b)}this.clear()}else this.fromNode=this.currentNode,this.currentNode=null,this.currentPoint=null,this.repaint()},handle_mousemove:function(a){var b=this.getMarkerPoint(a);if(b){if(this.network.isMovingElement()||this.network.isEditingElement())return void this.clear();var c=null;this.fromNode?(this.currentNode=this.getToNode(a,this.fromNode),this.currentPoint=b,this.repaint()):(c=this.getFromNode(a),this.currentNode!==c&&(this.currentNode=c,this.repaint()))}},getFromNode:function(a){return this.getNode(a)},getToNode:function(a,b){return this.getNode(a,b)},getNode:function(a,b){var c=this.network.getElementAt(a);return c instanceof Ld&&this.network.isLinkable(c,b)&&this.network.getElementBox().getSelectionModel().isSelectable(c)?c:null}}),Gb.vector.interaction.CreateShapeLinkInteraction=function(a,b){Gb.vector.interaction.CreateShapeLinkInteraction.superClass.constructor.call(this,a),b||(b=Gb.ShapeLink),this.linkFunction=Gb.Util.isTypeOf(b,Gb.ShapeLink)?function(a,c,d){var e=new b;if(e instanceof Gb.ShapeLink&&(e.setFromNode(a),e.setToNode(c),d)){var f=this.network.zoomManager;e.setPoints(f._getShapeLinkZoomPoints(d,!0))}return e}:b},Hb.ext("twaver.vector.interaction.CreateShapeLinkInteraction",Gb.vector.interaction.CreateLinkInteraction,{clear:function(){this.points=null,Gb.vector.interaction.CreateShapeLinkInteraction.superClass.clear.call(this)},createLink:function(){return this.linkFunction(this.fromNode,this.toNode,this.points)},handle_mousedown:function(a){if(0===a.button){var b=this.network.getLogicalPoint2(a);if(b){if(this.fromNode)if(this.toNode=this.currentNode,this.toNode){var c=this.createLink();c&&this.network.addElementByInteraction(c),this.clear()}else{if(this.points||(this.points=new Gb.List),this.points.size()>0){var d=this.points.get(this.points.size()-1);if(d.x===b.x&&d.y===b.y)return}this.points.add(b)}else this.fromNode=this.currentNode,this.points=null,this.currentNode=null,this.currentPoint=null;this.repaint()}}},paintLine:function(a){if(this.currentPoint){var b,c=new Gb.List;if(b=this.convertPointFromView(this.getZoomNodeRectOrPoint(this.fromNode,!0)),c.add(b,0),this.points&&this.points.size()>0)for(var d=this.points.size(),e=0;d>e;e++)b=this.convertPointFromView(this.points.get(e)),c.add(b);b=this.currentPoint,c.add(b),a.lineWidth=this.network.getEditLineWidth(),a.strokeStyle=this.network.getEditLineColor(),a.beginPath(),Vb.drawLinePoints(a,c),a.stroke()}}}),Gb.vector.interaction.CreateShapeNodeInteraction=function(a,b){b||(b=Gb.ShapeNode),this.shapeNodeFunction=Gb.Util.isTypeOf(b,Gb.ShapeNode)?function(a){var c=new b;if(c instanceof Gb.ShapeNode){var d=this.network.zoomManager,e=this.network.createElementUI(c);if(a){var f=d._getShapeNodeZoomPoints(e,a,!0);e.invalidateZoom(),c.setPoints(f)}}return c}:b,Gb.vector.interaction.CreateShapeNodeInteraction.superClass.constructor.call(this,a),this.timeStamp=-1},Hb.ext("twaver.vector.interaction.CreateShapeNodeInteraction",Gb.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear(),this.network.removeMarker(this),this.network.setEditingElement(!1)},clear:function(){this.points=null,this.currentPoint=null},paint:function(a){if(this.points&&this.points.size()>0&&this.currentPoint){for(var b,c=new Gb.List,d=this.points.size(),e=0;d>e;e++)b=this.convertPointFromView(this.points.get(e)),c.add(b);b=this.convertPointFromView(this.currentPoint),c.add(b),a.lineWidth=this.network.getEditLineWidth(),a.strokeStyle=this.network.getEditLineColor(),a.beginPath(),Vb.drawLinePoints(a,c),a.stroke()}},handle_mousedown:function(a){if(0===a.button){var b=this.network.getLogicalPoint2(a);if(b){if(2===a.detail||a.timeStamp-this.timeStamp<300){if(this.points){var c=this.shapeNodeFunction(this.points);this.network.addElementByInteraction(c),this.clear();var d=this;setTimeout(function(){d.network.setEditingElement(!1)},0)}}else{if(this.network.isEditingElement()||this.network.setEditingElement(!0),this.points||(this.points=new Gb.List),this.points.size()>0){var e=this.points.get(this.points.size()-1);if(e.x===b.x&&e.y===b.y)return}this.points.add(b)}this.timeStamp=a.timeStamp,this.repaint()}}},handle_mousemove:function(a){this.points&&(this.currentPoint=this.network.getLogicalPoint2(a),this.repaint())}}),Gb.vector.interaction.MagnifyInteraction=function(a,b,c,d,e){Gb.vector.interaction.MagnifyInteraction.superClass.constructor.call(this,a),this.scale=b||2,this.xRadius=c||100,this.yRadius=d||100,this.shape=e||"circle",this.borderColor="black",this.borderWidth=1,this.backgroundColor="white",this.markCanvas=Ub.createCanvas()},Hb.ext("twaver.vector.interaction.MagnifyInteraction",Gb.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousemove"),this.addListener("mousewheel"),this.network.addMarker(this)},tearDown:function(){this.removeListener("mousemove"),this.removeListener("mousewheel"),this.network.removeMarker(this)},paint:function(a){if(this.point){var b=this.network.zoomManager,c=b.getLocationZoom(),d=b.getGraphicsZoom(),e=(b.getSizeZoom(),this.network.getZoom(),this.xRadius/this.scale/d),f=this.yRadius/this.scale/d;if("mousewheel"===this.mouseFlag){var g={x:this.zoomPoint.x-e,y:this.zoomPoint.y-f,width:2*e,height:2*f};this.network.toCanvasByRegion(g,this.scale*d,this.markCanvas,"white");var h={x:this.zoomPoint.x-this.xRadius-this.network.viewRect.x,y:this.zoomPoint.y-this.yRadius-this.network.viewRect.y,width:this.markCanvas.width,height:this.markCanvas.height}}else{var g={x:this.point.x*c-e,y:this.point.y*c-f,width:2*e,height:2*f};this.network.toCanvasByRegion(g,this.scale*d,this.markCanvas,"white");var h={x:this.point.x*c*d-this.xRadius-this.network.viewRect.x,y:this.point.y*c*d-this.yRadius-this.network.viewRect.y,width:this.markCanvas.width,height:this.markCanvas.height}}a.save(),a.beginPath(),Vb.drawVector(a,this.shape,null,h.x,h.y,2*g.width*d,2*g.height*d),a.clip(),a.fillStyle=this.backgroundColor,a.beginPath(),a.rect(h.x,h.y,h.width,h.height),a.fill(),a.drawImage(this.markCanvas,h.x,h.y),a.restore(),a.beginPath(),a.lineWidth=this.borderWidth,Vb.drawVector(a,this.shape,null,h.x+this.borderWidth/2,h.y+this.borderWidth/2,2*g.width*d-this.borderWidth,2*g.height*d-this.borderWidth),a.strokeStyle=this.borderColor,a.stroke(),this.mouseFlag=null}},handle_mousemove:function(a){this.point=this.network.getLogicalPoint(a),this.point&&(this.mouseFlag="mousemove",this.repaint())},handle_mousewheel:function(a){var b=this.network.zoomManager,c=b.getLocationZoom();1!==c&&(this.zoomPoint=this.network.getLogicalPoint2(a)),this.zoomPoint&&(this.mouseFlag="mousewheel",this.repaint())},getScale:function(){return this.scale},setScale:function(a){this.scale=a,this.network.repaintTopCanvas()},getShape:function(){return this.shape},setShape:function(a){this.shape=a,this.network.repaintTopCanvas()},getXRadius:function(){return this.xRadius},setXRadius:function(a){this.xRadius=a,this.network.repaintTopCanvas()},getYRadius:function(){return this.yRadius},setYRadius:function(a){this.yRadius=a,this.network.repaintTopCanvas()},getBorderColor:function(){return this.borderColor},setBorderColor:function(a){this.borderColor=a,this.network.repaintTopCanvas()},getBorderWidth:function(){return this.borderWidth},setBorderWidth:function(a){this.borderWidth=a,this.network.repaintTopCanvas()},getBackgroundColor:function(){return this.backgroundColor},setBackgroundColor:function(a){this.backgroundColor=a,this.network.repaintTopCanvas()}}),Gb.vector.interaction.TouchInteraction=function(a){Gb.vector.interaction.TouchInteraction.superClass.constructor.call(this,a)},Hb.ext("twaver.vector.interaction.TouchInteraction",Gb.vector.interaction.BaseInteraction,{setUp:function(){var a=this.network.getView();Ub.addEventListener("touchstart","handleTouchstart",a,this),Ub.addEventListener("touchmove","handleTouchmove",a,this),Ub.addEventListener("touchend","handleTouchend",a,this),Ub.addEventListener("touchcancel","handleTouchend",a,this)},tearDown:function(){var a=this.network.getView();Ub.removeEventListener("touchstart",a,this),Ub.removeEventListener("touchmove",a,this),Ub.removeEventListener("touchend",a,this),Ub.removeEventListener("touchcancel",a,this)},_isDragToSelect:function(a){return!this.network._dragToPan},handleTouchstart:function(a){if(Ub.preventDefault(a),this.isMoving=!1,this.isSelecting=!1,1==a.touches.length){var b=this.network.getLogicalPoint2(a),c=this._element=this.network.getElementAt(b);if(this._startTouchTime=new Date,this._currentTouchPoint=b,this._startTouchClient=this._currentTouchClient=this.getMarkerPoint(a),c)if(this.network.getSelectionModel().contains(c))this.isSelecting=!0;else{this.network.getSelectionModel().setSelection(c);var d=this.network.getSelectionModel();d.contains(c)&&(this.isSelecting=!0)}else this.isSelecting=!1,this.network.getSelectionModel().clearSelection();Bc.handleClicked(this.network,a,c),this._endTouchTime&&this._startTouchTime.getTime()-this._endTouchTime.getTime()<=500&&Rb.getDistance(this._endTouchClient,this._startTouchClient)<=20?(delete this._endTouchTime,delete this._endTouchClient,Bc.handleDoubleClicked(this.network,a,c)):(this._endTouchTime=this._startTouchTime,this._endTouchClient=this._startTouchClient)}else this._distance=yc.getDistance(a),this._zoom=this.network.getZoom()},handleTouchmove:function(a){if(Ub.preventDefault(a),a.touches.length>1){var b=yc.getDistance(a);if(Math.abs(b-this._distance)<20)return;var c=b/this._distance;this.network.setZoom(this._zoom*c,!1)}else if(null==this._zoom){var d=this.getMarkerPoint(a);if(Rb.getDistance(this._startTouchClient,d)<20)return;if(this._element)if(this.isSelecting||this._isDragToSelect(a)){var e=this.network.getLogicalPoint2(a),f=this.getOffset(e,this._currentTouchPoint),g=f.x,h=f.y;this._currentTouchPoint=e,this.network.moveSelectedElements(g,h),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a}))}else{var g=this._currentTouchClient.x-d.x,h=this._currentTouchClient.y-d.y;this.network.panByOffset(g,h),this._currentTouchClient=d}else{var g=this._currentTouchClient.x-d.x,h=this._currentTouchClient.y-d.y;this.network.panByOffset(g,h),this._currentTouchClient=d}}},handleTouchend:function(a){Ub.preventDefault(a),this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a})),0===a.touches.length&&(this._distance=null,this._zoom=null,this._element=null,this._startTouchTime=null,this._currentTouchPoint=null,this._startTouchClient=this._currentTouchClient=null)}}),Gb.vector.interaction.MSTouchInteraction=function(a){Gb.vector.interaction.MSTouchInteraction.superClass.constructor.call(this,a),this._pointerMap={},this._pointerIdArray=[]},Hb.ext("twaver.vector.interaction.MSTouchInteraction",Gb.vector.interaction.BaseInteraction,{setUp:function(){var a=this.network.getView();Ub.addEventListener("MSPointerDown","handleTouchstart",a,this),Ub.addEventListener("MSPointerMove","handleTouchmove",a,this),Ub.addEventListener("MSPointerUp","handleTouchend",a,this),Ub.addEventListener("MSPointerCancel","handleTouchend",a,this),this.network.addMarker(this)},tearDown:function(){var a=this.network.getView();Ub.removeEventListener("MSPointerDown",a,this),Ub.removeEventListener("MSPointerMove",a,this),Ub.removeEventListener("MSPointerUp",a,this),Ub.removeEventListener("MSPointerCancel",a,this),this.network.removeMarker(this)},handleTouchstart:function(a){if(this.network.isFocusOnClick()&&Gb.Util.setFocus(this.network._view),!this.network.isSelectingElement()||a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.network.getLogicalPoint2(a),c=new Date;if(a.isPrimary&&this._pointerIdArray.length>0&&this.handle_mouseup(a),this._pointerMap[a.pointerId]||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length){var d=this.network.getElementAt(b);this._startTouchElement=d,this._startClientPoint={x:a.clientX,y:a.clientY};var e=this.network.getSelectionModel();d?Hb.isCtrlDown(a)?e.contains(d)?e.removeSelection(d):e.appendSelection(d):e.contains(d)||e.setSelection(d):Hb.isCtrlDown(a)||e.clearSelection(),Bc.handleClicked(this.network,a,d),this._startTouchTime&&this._startTouchPoint&&c.getTime()-this._startTouchTime.getTime()<=500&&Rb.getDistance(this._startTouchPoint,b)<=20?(Bc.handleDoubleClicked(this.network,a,d),this._doubleClick=!0):(Ub.handle_mousedown(this,a),this._startTouchPoint=b,this._startTouchTime=c)}else 2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.network.getZoom())}},handleTouchmove:function(a){if(null!=this._startTouchPoint&&0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Rb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10)&&(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length)){var b=this._getDistance()/this._distance;this.network.setZoom(this._zoom*b,!1)}},handleTouchend:function(a){if(this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:"liveMoveEnd",event:a})),this.network.isSelectingElement()){var b=Rb.getRect([this._startTouchPoint,this._moveTouchPoint]),c=this.network.getElementsAtRect(b,this.getIntersectMode(),this.network.getRectSelectFilter());if(c&&c.size()>0){var d=this.network.getSelectionModel(),e=d.toSelection();c.forEach(function(a){d.contains(a)?e.remove(a):e.add(a)},this),d.setSelection(e)}this.network.fireInteractionEvent({kind:"selectEnd",event:a}),this._moveTouchPoint=null,this.network.setSelectingElement(!1),this.repaint();

}this._doubleClick&&(delete this._doubleClick,delete this._startTouchPoint,delete this._startTouchTime);for(var f=-1,g=0;g<this._pointerIdArray.length;g++)if(this._pointerIdArray[g]==a.pointerId){f=g;break}f>=0&&this._pointerIdArray.splice(f,1),delete this._pointerMap[a.pointerId],this._moveTouchPoint=null},_getDistance:function(){return Rb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})},getIntersectMode:function(){return"intersect"===this.network.getSelectMode()?!0:"contain"===this.network.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y},handle_mousemove:function(a){var b={x:a.clientX,y:a.clientY};if(!(Rb.getDistance(this._startClientPoint,b)<3)&&this._startTouchPoint&&1==this._pointerIdArray.length)if(this._moveTouchPoint={x:this._startTouchPoint.x+(b.x-this._startClientPoint.x)/this.network.getZoom(),y:this._startTouchPoint.y+(b.y-this._startClientPoint.y)/this.network.getZoom()},null==this._startTouchElement&&this.network.isRectSelectEnabled()){var c=this.network.getLogicalPoint2(a);if(!c)return;this.network.setSelectingElement(!0),this.network.fireInteractionEvent(this._moveTouchPoint?{kind:"selectBetween",event:a}:{kind:"selectStart",event:a}),this.repaint()}else{var d=this.network.getElementAt(this._moveTouchPoint);if(null!=this._startTouchElement||this.network.isRectSelectEnabled()){if(this.network.isMovingElement()||null!=this._startTouchElement&&d==this._startTouchElement&&this.network.getMovableSelectedElements().contains(d)){var e=this._moveTouchPoint.x-this._startTouchPoint.x,f=this._moveTouchPoint.y-this._startTouchPoint.y;this.network.moveSelectedElements(e,f),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:"liveMoveStart",event:a}))}}else{var e=this._startClientPoint.x-b.x,f=this._startClientPoint.y-b.y;this.network.panByOffset(e,f)}this._startClientPoint=b}},handle_mouseup:function(a){this.handleTouchend(a),this._pointerIdArray=[],this._pointerMap={}},paint:function(a){if(this._startTouchPoint&&this._moveTouchPoint&&!this._startTouchElement&&this.network.isRectSelectEnabled()){var b=this.convertPointFromView(this._startTouchPoint),c=this.convertPointFromView(this._moveTouchPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Rb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.network.getSelectOutlineWidth(),j=this.getIntersectMode()?this.network.getSelectFillColor():null;a.strokeStyle=this.network.getSelectOutlineColor(),a.lineWidth=i,Od.rect(a,h.x,h.y,h.width,h.height,j,this.network.getSelectOutlineColor()),a.closePath()}}}}),Gb.XmlSerializer=function(a,b,c){this.dataBox=a,this.settings=b?b:new Gb.SerializationSettings,this.filterFunction=c,this.ref=0,this.refMap={},this.idMap={},this.xmlString=""},Hb.ext("twaver.XmlSerializer",Object,{serialize:function(){return this.xmlString="<twaver version='"+Gb.Util.getVersion()+"' platform='html5'>\n",this.serializeBody(),this.xmlString+="</twaver>\n",this.xmlString},serializeBody:function(){this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this),this.settings.isDataBoxSerializable&&(this.xmlString+="<dataBox class='"+this.dataBox.getClassName()+"'>\n",this.dataBox.serializeXml(this,this.dataBox.newInstance()),this.xmlString+="</dataBox>\n"),this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(a){this.refMap[a.getId()]=this.ref++,a.getChildren().forEach(this.initRefs,this)},isSerializable:function(a){return this.dataBox.contains(a)?this.filterFunction&&!this.filterFunction(a)?!1:!0:!1},serializeData:function(a){if(this.isSerializable(a)){var b=a.newInstance(),c=this.refMap[a.getId()];this.xmlString+="<data class='"+a.getClassName()+"' ref='"+c+"'",null!=this.settings.getPropertyType("id")&&(this.xmlString+=" id='"+a.getId()+"'"),this.xmlString+=">\n",a.serializeXml(this,b),this.xmlString+="</data>\n"}a.getChildren().forEach(this.serializeData,this)},serializePropertyXml:function(a,b,c){var d=this.settings.getPropertyType(b);if(d){var e=Hb.getValue(a,b,d),f=Hb.getValue(c,b,d);e!==f&&this.serializeValue("p",b,e,f,d)}},serializeStyleXml:function(a,b,c){var d=this.settings.getStyleType(b);if(d){var e=a.getStyle(b),f=c.getStyle(b);e!=f&&this.serializeValue("s",b,e,f,d)}},serializeClientXml:function(a,b,c){var d=this.settings.getClientType(b);if(null!=d){var e=a.getClient(b),f=c.getClient(b);e!=f&&this.serializeValue("c",b,e,f,d)}},serializeValue:function(a,b,c,d,e){if(null==c)this.xmlString+="	<"+a+" n='"+b+"' none=''/>\n";else if("cdata"===e)this.xmlString+="	<"+a+" n='"+b+"'><![CDATA["+c+"]]></"+a+">\n";else if("data"===e){var f=this.refMap[c.getId()];null!=f&&(this.xmlString+="	<"+a+" n='"+b+"' ref='"+f+"'/>\n")}else"point"===e?d&&c.x===d.x&&c.y===d.y||(this.xmlString+="	<"+a+" n='"+b+"' x='"+c.x+"' y='"+c.y+"'/>\n"):"list.point"===e?(this.xmlString+="	<"+a+" n='"+b+"'>\n",c.forEach(function(a){this.xmlString+="		<p x='"+a.x+"' y='"+a.y+"'/>\n"},this),this.xmlString+="	</"+a+">\n"):"list.string"===e||"list.number"===e?(this.xmlString+="	<"+a+" n='"+b+"'>\n",c.forEach(function(a){this.xmlString+="		<s>"+a+"</s>\n"},this),this.xmlString+="	</"+a+">\n"):this.xmlString+="rectangle"===e?"	<"+a+" n='"+b+"' x='"+c.x+"' y='"+c.y+"' w='"+c.width+"' h='"+c.height+"'/>\n":"	<"+a+" n='"+b+"'>"+c+"</"+a+">\n"},deserialize:function(a,b){Hb.isDeserializing=!0,this.xmlString=a;var c=Hb.xml(a).documentElement;this.refMap={},this.idMap={};var d,e,f,g=new md,h=new md,i=c.getElementsByTagName("data"),j=i.length;for(f=0;j>f;f++){e=i[f];var k=e.getAttribute("class"),l=this.settings.getPropertyType("id");if(l&&e.hasAttribute("id")){var m=null;if("string"===l)m=e.getAttribute("id");else if("int"===l)m=parseInt(e.getAttribute("id"));else{if("number"!==l)throw"Unsupported id type '"+l+"'";m=parseFloat(e.getAttribute("id"))}if("remove"===e.getAttribute("action")){this.dataBox.removeById(m);continue}d=this.dataBox.getDataById(m),d||(d=Hb.newInstance(k,m))}else d=Hb.newInstance(k);if(e.hasAttribute("ref")){var n=e.getAttribute("ref");this.refMap[n]=d}g.add(d),h.add(e),this.idMap[d.getId()]=d}for(this.dataBox.forEach(function(a){this.idMap[a.getId()]=a},this),j=g.size(),f=0;j>f;f++)d=g.get(f),e=h.get(f),d.deserializeXml(this,e);for(f=0;j>f;f++)d=g.get(f),this.dataBox.containsById(d.getId())||(b&&!d.getParent()&&d.setParent(b),this.dataBox.add(d));this.settings.isDataBoxSerializable&&1===c.getElementsByTagName("dataBox").length&&this.dataBox.deserializeXml(this,c.getElementsByTagName("dataBox")[0]),Hb.isDeserializing=!1},deserializePropertyXml:function(a,b,c){var d=this.settings.getPropertyType(c);d&&Hb.setValue(a,c,this.deserializeValue(b,d))},deserializeStyleXml:function(a,b,c){var d=this.settings.getStyleType(c);d&&a.setStyle(c,this.deserializeValue(b,d))},deserializeClientXml:function(a,b,c){var d=this.settings.getClientType(c);d&&a.setClient(c,this.deserializeValue(b,d))},deserializeValue:function(a,b){if(a.hasAttribute("@none"))return null;if("string"===b)return a.textContent;if("number"===b)return parseFloat(a.textContent);if("boolean"===b)return"true"===a.textContent;if("int"===b)return parseInt(a.textContent);if("point"===b)return{x:parseFloat(a.getAttribute("x")),y:parseFloat(a.getAttribute("y"))};if("data"===b){var c=a.getAttribute("ref"),d=this.refMap[c];return d?d:this.idMap[c]}var e,f,g,h;if("list.point"===b){var i=new md,j=a.getElementsByTagName("p");for(e=j.length,h=0;e>h;h++){var k=j[h];i.add({x:parseFloat(k.getAttribute("x")),y:parseFloat(k.getAttribute("y"))})}return i}if("list.string"===b){var l=new md;for(g=a.getElementsByTagName("s"),e=g.length,h=0;e>h;h++)l.add(g[h].textContent);return l}if("list.number"===b){for(f=new md,g=a.getElementsByTagName("s"),e=g.length,h=0;e>h;h++)f.add(parseFloat(g[h].textContent));return f}if("array.string"===b)return a.textContent.split(",");if("array.number"===b){for(f=a.textContent.split(","),e=f.length,h=0;e>h;h++)f[h]=parseFloat(f[h]);return f}return"rectangle"===b?{x:parseFloat(a.getAttribute("x")),y:parseFloat(a.getAttribute("y")),width:parseFloat(a.getAttribute("w")),height:parseFloat(a.getAttribute("h"))}:a.textContent}}),Hb.addMethod(Gb.Data,{serializeXml:function(a,b){if(a.settings.isClientSerializable&&this._clientMap)for(var c in this._clientMap)this.serializeClientXml(a,c,b);this.serializePropertyXml(a,"name",b),this.serializePropertyXml(a,"icon",b),this.serializePropertyXml(a,"toolTip",b),this.serializePropertyXml(a,"parent",b)},serializePropertyXml:function(a,b,c){a.serializePropertyXml(this,b,c)},serializeClientXml:function(a,b,c){a.serializeClientXml(this,b,c)},deserializeXml:function(a,b){var c,d,e,f,g=b.getElementsByTagName("p"),h=g.length;for(c=0;h>c;c++)d=g[c],d.hasAttribute("n")&&this.deserializePropertyXml(a,d,d.getAttribute("n"));if(a.settings.isClientSerializable)for(e=b.getElementsByTagName("c"),h=e.length,c=0;h>c;c++)f=e[c],f.hasAttribute("n")&&this.deserializeClientXml(a,f,f.getAttribute("n"))},deserializePropertyXml:function(a,b,c){a.deserializePropertyXml(this,b,c)},deserializeClientXml:function(a,b,c){a.deserializeClientXml(this,b,c)}}),Hb.addMethod(Gb.Element,{serializeXml:function(a,b){if(a.settings.isStyleSerializable&&this._styleMap)for(var c in this._styleMap)this.serializeStyleXml(a,c,b);Gb.Element.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"layerId",b),this._alarmState.getHighestNativeAlarmSeverity()&&"alarmstate"===a.settings.getPropertyType("alarmState")&&(a.xmlString+="	<p n='alarmState'>\n",Gb.AlarmSeverity.forEach(function(b){var c=this.getNewAlarmCount(b);c>0&&(a.xmlString+="		<n n='"+b.name+"' c='"+c+"'/>\n")},this._alarmState),Gb.AlarmSeverity.forEach(function(b){var c=this.getAcknowledgedAlarmCount(b);c>0&&(a.xmlString+="		<a n='"+b.name+"' c='"+c+"'/>\n")},this._alarmState),a.xmlString+="	</p>\n")},serializeStyleXml:function(a,b,c){a.serializeStyleXml(this,b,c)},deserializeXml:function(a,b){if(Gb.Element.superClass.deserializeXml.call(this,a,b),a.settings.isStyleSerializable){var c,d,e=b.getElementsByTagName("s"),f=e.length;for(c=0;f>c;c++)d=e[c],d.hasAttribute("n")&&this.deserializeStyleXml(a,d,d.getAttribute("n"))}},deserializeStyleXml:function(a,b,c){a.deserializeStyleXml(this,b,c)},deserializePropertyXml:function(a,b,c){if("alarmState"===c){if("alarmstate"===a.settings.getPropertyType("alarmState")){var d,e,f,g=b.getElementsByTagName("n");for(e=0;e<g.length;e++)f=g[e],d=Gb.AlarmSeverity.getByName(f.getAttribute("n")),this._alarmState.setNewAlarmCount(d,parseInt(f.getAttribute("c")));for(g=b.getElementsByTagName("a"),e=0;e<g.length;e++)f=g[e],d=Gb.AlarmSeverity.getByName(f.getAttribute("n")),this._alarmState.setAcknowledgedAlarmCount(d,parseInt(f.getAttribute("c")))}}else Gb.Element.superClass.deserializePropertyXml.call(this,a,b,c)}}),Hb.addMethod(Ld,{serializeXml:function(a,b){Ld.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"image",b),this.serializePropertyXml(a,"location",b),Hb.num(this._width)&&this._width>=0&&this.serializePropertyXml(a,"width",b),Hb.num(this._height)&&this._height>=0&&this.serializePropertyXml(a,"height",b)}}),Hb.addMethod(Gb.Link,{serializeXml:function(a,b){Gb.Link.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"fromNode",b),this.serializePropertyXml(a,"toNode",b)}}),Hb.addMethod(Gb.Follower,{serializeXml:function(a,b){Gb.Follower.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"host",b)}}),Hb.addMethod(Nd,{serializeXml:function(a,b){Nd.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"expanded",b)}}),Hb.addMethod(Gb.ShapeNode,{serializeXml:function(a,b){Gb.ShapeNode.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"points",b),this.serializePropertyXml(a,"segments",b)}}),Hb.addMethod(Gb.ShapeLink,{serializeXml:function(a,b){Gb.ShapeLink.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"points",b)}}),Hb.addMethod(Gb.RotatableNode,{serializeXml:function(a,b){Gb.RotatableNode.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"angle",b)}}),Hb.addMethod(Gb.DataBox,{serializeXml:function(a,b){if(a.settings.isClientSerializable&&this._clientMap)for(var c in this._clientMap)this.serializeClientXml(a,c,b);this.serializePropertyXml(a,"name",b),this.serializePropertyXml(a,"icon",b),this.serializePropertyXml(a,"toolTip",b)},serializePropertyXml:function(a,b,c){a.serializePropertyXml(this,b,c)},serializeClientXml:function(a,b,c){a.serializeClientXml(this,b,c)},deserializeXml:function(a,b){var c,d,e,f,g=b.getElementsByTagName("p"),h=g.length;for(c=0;h>c;c++)d=g[c],d.hasAttribute("n")&&this.deserializePropertyXml(a,d,d.getAttribute("n"));if(a.settings.isClientSerializable)for(e=b.getElementsByTagName("c"),h=e.length,c=0;h>c;c++)f=e[c],f.hasAttribute("n")&&this.deserializeClientXml(a,f,f.getAttribute("n"))},deserializePropertyXml:function(a,b,c){a.deserializePropertyXml(this,b,c)},deserializeClientXml:function(a,b,c){a.deserializeClientXml(this,b,c)}}),Hb.addMethod(Gb.ElementBox,{serializeXml:function(a,b){if(a.settings.isLayerBoxSerializable&&(a.xmlString+="	<layerBox>\n",this._layerBox.forEachByDepthFirst(function(b){a.xmlString+=this._layerBox.getDefaultLayer()===b?"		<layer ":"		<layer id='"+b.getId()+"' ",b.getName()&&(a.xmlString+="name='"+b.getName()+"' "),a.xmlString+="visible='"+b.isVisible()+"' editable='"+b.isEditable()+"' movable='"+b.isMovable()+"'/>\n"},null,this),a.xmlString+="	</layerBox>\n"),a.settings.isStyleSerializable&&this._styleMap)for(var c in this._styleMap)this.serializeStyleXml(a,c,b);Gb.ElementBox.superClass.serializeXml.call(this,a,b)},serializeStyleXml:function(a,b,c){a.serializeStyleXml(this,b,c)},deserializeStyleXml:function(a,b,c){a.deserializeStyleXml(this,b,c)},deserializeXml:function(a,b){if(Gb.ElementBox.superClass.deserializeXml.call(this,a,b),a.settings.isLayerBoxSerializable&&1==b.getElementsByTagName("layerBox").length)for(var c=b.getElementsByTagName("layerBox")[0].getElementsByTagName("layer"),d=0;d<c.length;d++){var e,f=c[d];if(f.hasAttribute("id")){var g=a.settings.getPropertyType("layerId");if("string"===g)e=new Gb.Layer(f.getAttribute("id"));else if("int"===g)e=new Gb.Layer(parseInt(f.getAttribute("id")));else{if("number"!==g)throw"Unsupported layer id type '"+g+"'";e=new Gb.Layer(parseFloat(f.getAttribute("id")))}this._layerBox.getDataById(e.getId())?e=this._layerBox.getDataById(e.getId()):this._layerBox.add(e)}else e=this._layerBox.getDefaultLayer(),this._layerBox.moveToBottom(e);f.hasAttribute("name")&&e.setName(f.getAttribute("name")),f.hasAttribute("visible")&&e.setVisible("true"===f.getAttribute("visible")),f.hasAttribute("editable")&&e.setEditable("true"===f.getAttribute("editable")),f.hasAttribute("movable")&&e.setMovable("true"===f.getAttribute("movable"))}if(a.settings.isStyleSerializable)for(var h=b.getElementsByTagName("s"),i=h.length,d=0;i>d;d++){var j=h[d];j.hasAttribute("n")&&this.deserializeStyleXml(a,j,j.getAttribute("n"))}}}),Gb.JsonSerializer=function(a,b,c){this.dataBox=a,this.settings=b?b:new Gb.SerializationSettings,this.filterFunction=c,this.ref=0,this.refMap={},this.idMap={},this.jsonObject={}},Hb.ext("twaver.JsonSerializer",Object,{serialize:function(){return this.jsonObject={version:Gb.Util.getVersion(),platform:"html5"},this.settings.isImageSerializable&&(this.jsonObject.images={}),this.serializeBody(),JSON.stringify(this.jsonObject)},serializeBody:function(){if(this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this),this.settings.isDataBoxSerializable){var a={"class":this.dataBox.getClassName(),p:{},s:{},c:{}};this.jsonObject.dataBox=a,this.dataBox.serializeJson(this,this.dataBox.newInstance(),a),Hb.isEmptyObject(a.p)&&delete a.p,Hb.isEmptyObject(a.s)&&delete a.s,Hb.isEmptyObject(a.c)&&delete a.c}this.jsonObject.datas=[],this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(a){this.refMap[a.getId()]=this.ref++,a.getChildren().forEach(this.initRefs,this)},isSerializable:function(a){return this.dataBox.contains(a)?this.filterFunction&&!this.filterFunction(a)?!1:!0:!1},serializeData:function(a){if(this.isSerializable(a)){var b=a.newInstance(),c=this.refMap[a.getId()],d={"class":a.getClassName(),ref:c,p:{},s:{},c:{}};if(this.settings.getPropertyType("id")&&(this.jsonObject.id=a.getId()),this.jsonObject.datas.push(d),a.serializeJson(this,b,d),Hb.isEmptyObject(d.p)&&delete d.p,Hb.isEmptyObject(d.s)&&delete d.s,Hb.isEmptyObject(d.c)&&delete d.c,this.settings.isImageSerializable&&a.getImage){var e=a.getImage();if("string"==typeof e&&!Qd[e]&&!this.jsonObject.images[e]){var f=Hb.getImageAsset(e),g=f&&f.getImage();g&&!bd(g)&&(this.jsonObject.images[e]=g)}}}a.getChildren().forEach(this.serializeData,this)},serializePropertyJson:function(a,b,c,d){var e=this.settings.getPropertyType(b);if(e){var f=Hb.getValue(a,b,e),g=Hb.getValue(c,b,e);f!==g&&this.serializeValue(b,f,g,e,d.p)}},serializeStyleJson:function(a,b,c,d){var e=this.settings.getStyleType(b);if(e){var f=a.getStyle(b),g=c.getStyle(b);f!=g&&this.serializeValue(b,f,g,e,d.s)}},serializeClientJson:function(a,b,c,d){var e=this.settings.getClientType(b);if(null!=e){var f=a.getClient(b),g=c.getClient(b);f!=g&&this.serializeValue(b,f,g,e,d.c)}},serializeValue:function(a,b,c,d,e){if(null==b)e[a]=null;else if(b instanceof md)e[a]=b._as;else if("data"===d){var f=this.refMap[b.getId()];null!=f&&(e[a]=f)}else e[a]=b},deserialize:function(a,b){Hb.isDeserializing=!0,this.jsonObject=JSON.parse(a);var c=this.jsonObject.images;this.settings.isImageSerializable&&c&&Object.keys(c).forEach(function(a){Hb.registerImage(a,c[a])}),this.refMap={},this.idMap={};for(var d,e=new md,f=new md,g=this.jsonObject.datas.length,h=0;g>h;h++){var i=this.jsonObject.datas[h],j=i["class"],k=this.settings.getPropertyType("id");if(k&&null!=i.id){if("remove"===i.action){this.dataBox.removeById(i.id);continue}d=this.dataBox.getDataById(i.id),d||(d=Hb.newInstance(j,i.id))}else d=Hb.newInstance(j);null!=i.ref&&(this.refMap[i.ref]=d),e.add(d),f.add(i),this.idMap[d.getId()]=d}for(this.dataBox.forEach(function(a){this.idMap[a.getId()]=a},this),g=e.size(),h=0;g>h;h++)d=e.get(h),d.deserializeJson(this,f.get(h));for(h=0;g>h;h++)d=e.get(h),this.dataBox.containsById(d.getId())||(b&&!d.getParent()&&d.setParent(b),this.dataBox.add(d));this.settings.isDataBoxSerializable&&this.jsonObject.dataBox&&this.dataBox.deserializeJson(this,this.jsonObject.dataBox),Hb.isDeserializing=!1},deserializePropertyJson:function(a,b,c){var d=this.settings.getPropertyType(c);d&&Hb.setValue(a,c,this.deserializeValue(b,d))},deserializeStyleJson:function(a,b,c){var d=this.settings.getStyleType(c);d&&a.setStyle(c,this.deserializeValue(b,d))},deserializeClientJson:function(a,b,c){var d=this.settings.getClientType(c);d&&a.setClient(c,this.deserializeValue(b,d))},deserializeValue:function(a,b){if("data"===b){var c=this.refMap[a];return c?c:this.idMap[a]}return"array.number"===b?a:a instanceof Array?new md(a):a}}),Hb.addMethod(Gb.Data,{serializeJson:function(a,b,c){if(a.settings.isClientSerializable&&this._clientMap)for(var d in this._clientMap)this.serializeClientJson(a,d,b,c);this.serializePropertyJson(a,"name",b,c),this.serializePropertyJson(a,"icon",b,c),this.serializePropertyJson(a,"toolTip",b,c),this.serializePropertyJson(a,"parent",b,c)},serializePropertyJson:function(a,b,c,d){a.serializePropertyJson(this,b,c,d)},serializeClientJson:function(a,b,c,d){a.serializeClientJson(this,b,c,d)},deserializeJson:function(a,b){var c;for(c in b.p)this.deserializePropertyJson(a,b.p[c],c);if(a.settings.isClientSerializable)for(c in b.c)this.deserializeClientJson(a,b.c[c],c)},deserializePropertyJson:function(a,b,c){a.deserializePropertyJson(this,b,c)},deserializeClientJson:function(a,b,c){a.deserializeClientJson(this,b,c)}}),Hb.addMethod(Gb.Element,{serializeJson:function(a,b,c){if(a.settings.isStyleSerializable&&this._styleMap)for(var d in this._styleMap)this.serializeStyleJson(a,d,b,c);if(Gb.Element.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"layerId",b,c),this._alarmState.getHighestNativeAlarmSeverity()&&"alarmstate"===a.settings.getPropertyType("alarmState")){var e={n:{},a:{}};c.p.alarmState=e,Gb.AlarmSeverity.forEach(function(a){var b=this.getNewAlarmCount(a);b>0&&(e.n[a.name]=b)},this._alarmState),Gb.AlarmSeverity.forEach(function(a){var b=this.getAcknowledgedAlarmCount(a);b>0&&(e.a[a.name]=b)},this._alarmState),Hb.isEmptyObject(e.n)&&delete e.n,Hb.isEmptyObject(e.a)&&delete e.a,Hb.isEmptyObject(e)&&delete c.p.alarmState}},serializeStyleJson:function(a,b,c,d){a.serializeStyleJson(this,b,c,d)},deserializeJson:function(a,b){if(Gb.Element.superClass.deserializeJson.call(this,a,b),a.settings.isStyleSerializable)for(var c in b.s)this.deserializeStyleJson(a,b.s[c],c)},deserializeStyleJson:function(a,b,c){a.deserializeStyleJson(this,b,c)},deserializePropertyJson:function(a,b,c){if("alarmState"===c){if("alarmstate"===a.settings.getPropertyType("alarmState")){var d;for(d in b.n)this._alarmState.setNewAlarmCount(Gb.AlarmSeverity.getByName(d),b.n[d]);for(d in b.a)this._alarmState.setAcknowledgedAlarmCount(Gb.AlarmSeverity.getByName(d),b.a[d])}}else Gb.Element.superClass.deserializePropertyJson.call(this,a,b,c)}}),Hb.addMethod(Ld,{serializeJson:function(a,b,c){Ld.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"image",b,c),this.serializePropertyJson(a,"location",b,c),Hb.num(this._width)&&this._width>=0&&this.serializePropertyJson(a,"width",b,c),Hb.num(this._height)&&this._height>=0&&this.serializePropertyJson(a,"height",b,c)}}),Hb.addMethod(Gb.Link,{serializeJson:function(a,b,c){Gb.Link.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"fromNode",b,c),this.serializePropertyJson(a,"toNode",b,c)}}),Hb.addMethod(Gb.Follower,{serializeJson:function(a,b,c){Gb.Follower.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"host",b,c)}}),Hb.addMethod(Nd,{serializeJson:function(a,b,c){Nd.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"expanded",b,c)}}),Hb.addMethod(Gb.ShapeNode,{serializeJson:function(a,b,c){Gb.ShapeNode.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"points",b,c),this.serializePropertyJson(a,"segments",b,c)}}),Hb.addMethod(Gb.ShapeLink,{serializeJson:function(a,b,c){Gb.ShapeLink.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"points",b,c)}}),Hb.addMethod(Gb.RotatableNode,{serializeJson:function(a,b,c){Gb.RotatableNode.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"angle",b,c)}}),Hb.addMethod(Gb.DataBox,{serializeJson:function(a,b,c){if(a.settings.isClientSerializable&&this._clientMap)for(var d in this._clientMap)this.serializeClientJson(a,d,b,c);this.serializePropertyJson(a,"name",b,c),this.serializePropertyJson(a,"icon",b,c),this.serializePropertyJson(a,"toolTip",b,c)},serializePropertyJson:function(a,b,c,d){a.serializePropertyJson(this,b,c,d)},serializeClientJson:function(a,b,c,d){a.serializeClientJson(this,b,c,d)},deserializeJson:function(a,b){var c;for(c in b.p)this.deserializePropertyJson(a,b.p[c],c);if(a.settings.isClientSerializable)for(c in b.c)this.deserializeClientJson(a,b.c[c],c)},deserializePropertyJson:function(a,b,c){a.deserializePropertyJson(this,b,c)},deserializeClientJson:function(a,b,c){a.deserializeClientJson(this,b,c)}}),Hb.addMethod(Gb.ElementBox,{serializeJson:function(a,b,c){if(a.settings.isLayerBoxSerializable&&(c.layers=[],this._layerBox.forEachByDepthFirst(function(a){var b={};c.layers.push(b),this._layerBox.getDefaultLayer()!==a&&(b.id=a.getId()),a.getName()&&(b.name=a.getName()),b.visible=a.isVisible(),b.editable=a.isEditable(),b.movable=a.isMovable()},null,this)),a.settings.isStyleSerializable&&this._styleMap)for(var d in this._styleMap)this.serializeStyleJson(a,d,b,c);Gb.ElementBox.superClass.serializeJson.call(this,a,b,c)},serializeStyleJson:function(a,b,c,d){a.serializeStyleJson(this,b,c,d)},deserializeStyleJson:function(a,b,c){a.deserializeStyleJson(this,b,c)},deserializeJson:function(a,b){if(Gb.ElementBox.superClass.deserializeJson.call(this,a,b),a.settings.isLayerBoxSerializable&&b.layers&&b.layers)for(var c=b.layers.length,d=0;c>d;d++){var e,f=b.layers[d];null!=f.id?(e=new Gb.Layer(f.id),this._layerBox.getDataById(e.getId())?e=this._layerBox.getDataById(e.getId()):this._layerBox.add(e)):(e=this._layerBox.getDefaultLayer(),this._layerBox.moveToBottom(e)),f.name&&e.setName(f.name),null!=f.visible&&e.setVisible(f.visible),null!=f.editable&&e.setEditable(f.editable),null!=f.movable&&e.setMovable(f.movable)}if(a.settings.isStyleSerializable)for(var g in b.s)this.deserializeStyleJson(a,b.s[g],g)}}),Gb.layout.SpringLayouter=function(a){this._network=a,this._damper=1,this._maxMotion=0,this._motionRatio=0,this._isAdjusting=!1,this._timer=null,this._snodeMap={},this._snodes=new md,this._slinks=new md,this._network.getElementBox().addDataBoxChangeListener(this._handleDataBoxChange,this),this._network.getElementBox().addDataPropertyChangeListener(this._handleDataPropertyChange,this),this._network.addPropertyChangeListener(this._handleNetworkPropertyChange,this)},Hb.ext("twaver.layout.SpringLayouter",Object,{_nodeRepulsionFactor:.6,_linkRepulsionFactor:.6,_limitBounds:null,_interval:50,_stepCount:10,_motionLimit:.01,start:function(){if(!this._timer){var a=this,b=function(){a.relax.call(a)};this._timer=window.setInterval(b,this._interval),this._damper=1}},stop:function(){this._timer&&(window.clearInterval(this._timer),this._timer=null)},relax:function(){if(!(this._damper<.1&&this._maxMotion<this._motionLimit)){this._rebuild();for(var a=this._snodes.size(),b=0;b<this._stepCount;b++){this._slinks.forEach(this._relaxLink,this);for(var c=0;a>c;c++)for(var d=0;a>d;d++){var e=this._snodes.get(c),f=this._snodes.get(d);e!=f&&this._relaxNodePair(e,f)}this._moveNodes()}this._isAdjusting=!0;for(var b=0;a>b;b++){var g=this._snodes.get(b);g.fix||g.element.setLocation(g.x,g.y)}this._isAdjusting=!1}},isRunning:function(){return!!this._timer},getNetwork:function(){return this._network},isVisible:function(a){return this._network.isVisible(a)},isMovable:function(a){return this._network.isMovable(a)?this._network.getSelectionModel().contains(a)?!1:a instanceof Nd?!1:!0:!1},getNodeRepulsionFactor:function(){return this._nodeRepulsionFactor},setNodeRepulsionFactor:function(a){.02>a&&(a=.02),this._nodeRepulsionFactor=a,this._damper=1},getLinkRepulsionFactor:function(){return this._linkRepulsionFactor},setLinkRepulsionFactor:function(a){.02>a&&(a=.02),this._linkRepulsionFactor=a,this._damper=1},getStepCount:function(){return this._stepCount},setStepCount:function(a){this._stepCount=a,this._damper=1},getInterval:function(){return this._interval},setInterval:function(a){if(this._interval!==a&&(this._interval=a,this._timer)){window.clearInterval(this._timer);var b=this,c=function(){b.relax.call(b)};this._timer=window.setInterval(c,this._interval)}},getLimitBounds:function(){return this._limitBounds},setLimitBounds:function(a){this._limitBounds=a,this._damper=1},_handleDataPropertyChange:function(a){this._isAdjusting||(this._damper=1)},_handleDataBoxChange:function(a){this._damper=0===this._network.getElementBox().size()?0:1},_handleNetworkPropertyChange:function(a){if("elementBox"===a.property){var b=a.oldValue;null!=b&&(b.removeDataBoxChangeListener(this._handleDataBoxChange,this),b.removeDataPropertyChangeListener(this._handleDataPropertyChange,this)),this._network.getElementBox().addDataBoxChangeListener(this._handleDataBoxChange,this),this._network.getElementBox().addDataPropertyChangeListener(this._handleDataPropertyChange,this)}},_relaxLink:function(a){var b=a.toNode.x-a.fromNode.x,c=a.toNode.y-a.fromNode.y,d=Math.sqrt(b*b+c*c),e=.25*b,f=.25*c;e/=100*a.length;var g=a.length,h=100*g,i=f;f/=h,i/=100*a.length,a.toNode.dx=a.toNode.dx-e*d,a.toNode.dy=a.toNode.dy-f*d,a.fromNode.dx=a.fromNode.dx+e*d,a.fromNode.dy=a.fromNode.dy+f*d},_relaxNodePair:function(a,b){var c=0,d=0,e=a.x-b.x,f=a.y-b.y,g=e*e+f*f;0===g?(c=Gb.Util.random(),d=Gb.Util.random()):36e4>g&&(c=e/g,d=f/g);var h=a.repulsion*b.repulsion/100,i=.25*h;a.dx+=c*i,a.dy+=d*i,b.dx-=c*i,b.dy-=d*i},_moveNodes:function(){for(var a=this._maxMotion,b=0,c=0,d=this._snodes.size();d>c;c++){var e=this._snodes.get(c),f=e.dx,g=e.dy;f*=this._damper,g*=this._damper,e.dx=f/2,e.dy=g/2;var h=Math.sqrt(f*f+g*g);if(!e.fix)if(e.x=e.x+Math.max(-30,Math.min(30,f)),e.y=e.y+Math.max(-30,Math.min(30,g)),this._limitBounds){e.x<this._limitBounds.x&&(e.x=this._limitBounds.x,this._adjustLocation(1,0)),e.y<this._limitBounds.y&&(e.y=this._limitBounds.y,this._adjustLocation(0,1));var i,j=this._network.getElementUI(e.element);i=j?j._viewRect:e.element.getRect(),i&&(e.x+i.width>this._limitBounds.x+this._limitBounds.width&&(e.x=this._limitBounds.x+this._limitBounds.width-i.width,this._adjustLocation(-1,0)),e.y+i.height>this._limitBounds.y+this._limitBounds.height&&(e.y=this._limitBounds.y+this._limitBounds.height-i.height,this._adjustLocation(0,-1)))}else e.x<1&&this._adjustLocation(1,0),e.y<1&&this._adjustLocation(0,1);b=Math.max(h,b)}this._maxMotion=b,this._motionRatio=this._maxMotion>0?a/this._maxMotion-1:0,this._damp()},_damp:function(){this._motionRatio<=.001&&((this._maxMotion<.2||this._maxMotion>1&&this._damper<.9)&&this._damper>.01?this._damper-=.01:this._maxMotion<.4&&this._damper>.003?this._damper-=.003:this._damper>1e-4&&(this._damper-=1e-4)),this._maxMotion<this._motionLimit&&(this._damper=0)},_rebuild:function(){this._snodeMap={},this._snodes.clear(),this._slinks.clear(),this._network.getElementBox().forEach(function(a){this.isVisible(a)&&(a instanceof Gb.Link?this._addLink(a):a instanceof Ld&&this._addNode(a))},this)},_addNode:function(a){var b=this._snodeMap[a.getId()];return b?b:(b={},b.element=a,b.repulsion=this._getRepulsion(a),b.x=a.getX(),b.y=a.getY(),b.dx=0,b.dy=0,b.fix=!this.isMovable(a),this._snodeMap[a.getId()]=b,this._snodes.add(b),b)},_addLink:function(a){var b={};b.fromNode=this._addNode(a.getFromNode()),b.toNode=this._addNode(a.getToNode()),b.element=a;var c,d,e=this._network.getElementUI(a.getToNode()),f=this._network.getElementUI(a.getFromNode());e&&e._viewRect&&f&&f._viewRect?(c=e._viewRect.width+f._viewRect.width,d=e._viewRect.height+f._viewRect.height):(c=a.getToNode().getWidth()+a.getFromNode().getWidth(),d=a.getToNode().getHeight()+a.getFromNode().getHeight()),b.length=Math.floor(Math.sqrt(c*c+d*d)*this._linkRepulsionFactor),b.length<=0&&(b.length=100),this._slinks.add(b)},_getRepulsion:function(a){var b,c=this._network.getElementUI(a);if(c&&c._viewRect){var d=c._viewRect;b=Math.floor(Math.sqrt(d.width*d.width+d.height*d.height)*this._nodeRepulsionFactor)}else b=100;return 0>=b&&(b=100),b},_adjustLocation:function(a,b){for(var c=0,d=this._snodes.size();d>c;c++){var e,f=this._snodes.get(c),g=this._network.getElementUI(f.element);if(e=g?g._viewRect:f.element.getRect(),!e)return;a>0?(!this._limitBounds||f.x+e.width+a<this._limitBounds.x+this._limitBounds.width)&&(f.x+=a):(!this._limitBounds||f.x+a>this._limitBounds.x)&&(f.x+=a),b>0?(!this._limitBounds||f.y+e.height+b<this._limitBounds.y+this._limitBounds.height)&&(f.y+=b):(!this._limitBounds||f.y+b>this._limitBounds.y)&&(f.y+=b)}}}),Gb.layout.CloudLayouter=function(a){Gb.layout.CloudLayouter.superClass.constructor.apply(this,arguments),this._network=a,this._centerX=0,this._centerY=0,this._radius=1,this._rect=null,this._localPoint=null,this._lastWidth=-1e3,this._lastHeight=-1e3,this._nodes=new md,this._sa=0,this._ca=0,this._sb=0,this._cb=0,this._sc=0,this._cc=0,this._lasta=0,this._lastb=0,this._active=!1,this._horizontalElliptical=1,this._verticalElliptical=1,this._timer=null,this._centering=!1,this._centeringNode=null,this._freeze=!1,this._network.setInteractions("twaver.network.Network"===this._network.getClassName()?[new Gb.network.interaction.SelectInteraction(this._network)]:[new Gb.canvas.interaction.SelectInteraction(this._network)]);

},Hb.ext("twaver.layout.CloudLayouter",Gb.PropertyChangeDispatcher,{__accessor:["updateNodeFunction","mouseMoveFunction","mouseOverFunction","percentPadding","ceaseRate","ceaseLimit"],__bool:["elliptical","active","updateLayoutRectOnResized","reloadOnDataBoxChanged"],_moveSpeed:2,_ceaseRate:.9,_ceaseLimit:.01,_percentPadding:.2,_elliptical:!0,_interval:50,_reloadOnDataBoxChanged:!0,_updateLayoutRectOnResized:!0,getNetwork:function(){return this._network},isLayoutable:function(a){return this._network.isVisible(a)&&this._network.isMovable(a)},start:function(a){if(0===arguments.length&&(a=!0),!this._timer){this._installListeners(),a&&this.updateLayoutRect(!0);var b=this,c=function(){b._update.call(b)};this._timer=window.setInterval(c,this._interval),this._update()}},stop:function(){this._timer&&(window.clearInterval(this._timer),this._timer=null)},isRunning:function(){return!!this._timer},getInterval:function(){return this._interval},setInterval:function(a){if(this._interval!==a){var b=this._interval;if(this._interval=a,this._timer){window.clearInterval(this._timer);var c=this,d=function(){c._update.call(c)};this._timer=window.setInterval(d,this._interval)}this.firePropertyChange("interval",b,a)}},getMoveSpeed:function(){return this._moveSpeed},setMoveSpeed:function(a){var b=this._moveSpeed;this._moveSpeed=a,this.firePropertyChange("moveSpeed",b,a)},getLayoutRect:function(){var a=this._network.getView().offsetWidth/this._network.getZoom(),b=this._network.getView().offsetHeight/this._network.getZoom(),c=a*this._percentPadding,d=b*this._percentPadding;return{x:c,y:d,width:a-2*c,height:b-2*d}},getCount:function(){return this._nodes.size()},updateLayoutRect:function(a){var b=this._radius;if(this._rect=this.getLayoutRect(),this._rect.width<=2&&(this._rect.width=2),this._rect.height<=2&&(this._rect.height=2),this._radius=Math.min(this._rect.width/2,this._rect.height/2),this.isElliptical()?(this._horizontalElliptical=this._rect.width/2/this._radius,this._verticalElliptical=this._rect.height/2/this._radius):(this._horizontalElliptical=1,this._verticalElliptical=1),this._centerX=this._rect.x+this._rect.width/2,this._centerY=this._rect.y+this._rect.height/2,a)this.reload();else{this._lasta=1,this._lastb=1;for(var c=this._nodes.size(),d=0;c>d;d++){var e=this._nodes.get(d);e.cx*=this._radius/b,e.cy*=this._radius/b,e.cz*=this._radius/b}this._freeze?this._updateNodes(0,0,0):this._update()}this._lastWidth=this._network.getView().offsetWidth,this._lastHeight=this._network.getView().offsetHeight},reload:function(){this._freeze=!1,this._centeringNode=null,this._localPoint=null,this._centering=!1,this._nodes=new md,this._box.forEach(function(a){if(a&&this.isLayoutable(a)){var b={};b.node=a,this._nodes.add(b)}},this),this._sineCosine(0,0,0),this._active=!1,this._lasta=1,this._lastb=1;for(var a=0,b=0,c=this._nodes.size(),d=0;c>d;d++){a=Math.acos(-1+(2*(d+1)-1)/c),b=Math.sqrt(c*Math.PI)*a;var e=this._nodes.get(d);e.cx=this._radius*Math.cos(b)*Math.sin(a),e.cy=this._radius*Math.sin(b)*Math.sin(a),e.cz=this._radius*Math.cos(a)}},_sineCosine:function(a,b,c){var d=Math.PI/180;this._sa=Math.sin(a*d),this._ca=Math.cos(a*d),this._sb=Math.sin(b*d),this._cb=Math.cos(b*d),this._sc=Math.sin(c*d),this._cc=Math.cos(c*d)},handleSelectionChange:function(a){this.centerNode(this._network.getSelectionModel().getLastData())},handleDataBoxChange:function(a){(this._reloadOnDataBoxChanged||"clear"===a.kind)&&this.reload()},handleMouseMove:function(a){this._centering||this._updateLogicalPoint(a),this._active=this._mouseMoveFunction?this._mouseMoveFunction(a):!0},handleMouseOver:function(a){this._centering||this._updateLogicalPoint(a),this._active=this._mouseOverFunction?this._mouseOverFunction(a):!0},_updateLogicalPoint:function(a){this._localPoint=this._network.getLogicalPoint(a)},handleRollOut:function(a){this._active=!1},handleResize:function(a){if("validateEnd"===a.kind){if(!this._updateLayoutRectOnResized)return;if(Math.abs(this._network.getView().offsetWidth-this._lastWidth)<=2&&Math.abs(this._network.getView().offsetHeight-this._lastHeight)<=2)return;this.updateLayoutRect()}},handleNetworkPropertyChange:function(a){"elementBox"===a.property&&(this._box.removeDataBoxChangeListener(this.handleDataBoxChange,this),this._box=this._network.getElementBox(),this._box.addDataBoxChangeListener(this.handleDataBoxChange,this),this.reload()),"zoom"===a.property&&(this._localPoint=null,this.updateLayoutRect())},_adjustIndex:function(){this._nodes.sort(this._sortFunction);for(var a=this._nodes.size(),b=0;a>b;b++){var c=this._nodes.get(b).node,d=this._box.getDatas().indexOf(c);this._box.getDatas().removeAt(d),this._box.getDatas().add(c,b),this._box.fireIndexChange(c,d,b),this.updateNode(c,b,a,this._nodes.get(b).alpha)}},_sortFunction:function(a,b){return b.cz>a.cz?1:b.cz<a.cz?-1:0},updateNode:function(a,b,c,d){this._updateNodeFunction&&this._updateNodeFunction(a,b,c,d)},_update:function(){if(!this._freeze){var a,b;if(this._centering&&this._centeringNode){var c=this.isAtCenter(this._centeringNode.node,this._centeringNode.perspective,this._centeringNode.cx,this._centeringNode.cy,this._centeringNode.cz);if(c)return this._freeze=!0,this._centering=!1,void(this._centeringNode=null)}if(!this._freeze&&(this._active||this._centering)&&this._localPoint?this.isElliptical()?(a=(this._centerY-this._localPoint.y)/(this._rect.height/2)*this._moveSpeed,b=(this._localPoint.x-this._centerX)/(this._rect.width/2)*this._moveSpeed):(a=(this._centerY-this._localPoint.y)/this._radius*this._moveSpeed,b=(this._localPoint.x-this._centerX)/this._radius*this._moveSpeed):(a=this._lasta*this._ceaseRate,b=this._lastb*this._ceaseRate),this._lasta=a,this._lastb=b,Math.abs(a)>this._ceaseLimit||Math.abs(b)>this._ceaseLimit){var d=0;this._sineCosine(a,b,d);for(var e=0,f=this._nodes.size();f>e;e++){var g=this._nodes.get(e),h=g.cx,i=g.cy*this._ca+g.cz*-this._sa,j=g.cy*this._sa+g.cz*this._ca,k=h*this._cb+j*this._sb,l=i,m=h*-this._sb+j*this._cb,n=k*this._cc+l*-this._sc,o=k*this._sc+l*this._cc,p=m;g.cx=n,g.cy=o,g.cz=p;var q=2*this._radius;q/=q+p,g.perspective=q,g.alpha=(this._radius-p)/(2*this._radius);var r=this._horizontalElliptical*n*q-2*this._horizontalElliptical+this._centerX,s=o*q*this._verticalElliptical+this._centerY;g.node.setCenterLocation(r,s)}this._adjustIndex()}}},centerNode:function(a){if(a&&this.isLayoutable(a)){if(this._centeringNode&&a===this._centeringNode.node&&this._freeze)return;for(var b=0,c=this._nodes.size();c>b;b++){var d=this._nodes.get(b);if(d&&a===d.node){this._centering=!0,this._freeze=!1,this._active=!0,this._centeringNode=d,this._localPoint=this.createControlPoint(this._centeringNode.node);break}}}else this._centering=!1,this._freeze=!1,this._active=!1,this._localPoint=null},createControlPoint:function(a){var b=a.getCenterLocation(),c=this.getLayoutRect(),d=c.x+c.width/2,e=c.y+c.height/2,f=Math.atan2(b.y-e,b.x-d),g=c.width+c.height;return{x:d+g*Math.cos(f),y:e+g*Math.sin(f)}},isAtCenter:function(a,b,c,d,e){if(this._moveSpeed<=0)return!0;var f=16/this._moveSpeed;return f>20?f=20:2>f&&(f=2),-e/Math.sqrt(c*c+d*d)>f},_updateNodes:function(a,b,c){this._sineCosine(a,b,c);for(var d=0,e=this._nodes.size();e>d;d++){var f=this._nodes.get(d),g=f.cx,h=f.cy*this._ca+f.cz*-this._sa,i=f.cy*this._sa+f.cz*this._ca,j=g*this._cb+i*this._sb,k=h,l=g*-this._sb+i*this._cb,m=j*this._cc+k*-this._sc,n=j*this._sc+k*this._cc,o=l;f.cx=m,f.cy=n,f.cz=o;var p=2*this._radius;p/=p+o,f.perspective=p;var q=this._horizontalElliptical*m*p-2*this._horizontalElliptical+this._centerX,r=n*p*this._verticalElliptical+this._centerY;f.node.setCenterLocation(q,r)}this._adjustIndex()},_installListeners:function(){this._box=this._network.getElementBox(),this._box.addDataBoxChangeListener(this.handleDataBoxChange,this),this._network.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this._network.addViewListener(this.handleResize,this),Ub.addEventListener("mouseout","handleRollOut",this._network.getView(),this),Ub.addEventListener("mousemove","handleMouseMove",this._network.getView(),this),Ub.addEventListener("mouseover","handleMouseOver",this._network.getView(),this),this._network.addPropertyChangeListener(this.handleNetworkPropertyChange,this)},_uninstallListeners:function(){this._box.removeDataBoxChangeListener(this.handleDataBoxChange,this),this._network.getSelectionModel().removeSelectionChangeListener(this.handleSelectionChange,this),this._network.removeViewListener(this.handleResize,this),Ub.removeEventListener("mouseout",this._network.getView(),this),Ub.removeEventListener("mousemove",this._network.getView(),this),Ub.removeEventListener("mouseover",this._network.getView(),this),this._network.removePropertyChangeListener(this.handleNetworkPropertyChange,this)}}),Gb.layout.AutoLayouter=function(a,b){this._box=a,this._network=b},Hb.ext("twaver.layout.AutoLayouter",Object,{_expandGroup:!1,_repulsion:1,_type:null,_animate:!0,_explicitXOffset:Number.NaN,_explicitYOffset:Number.NaN,_xOffset:0,_yOffset:0,isExpandGroup:function(){return this._expandGroup},setExpandGroup:function(a){this._expandGroup=a},getRepulsion:function(){return this._repulsion},setRepulsion:function(a){this._repulsion=a},getType:function(){return this._type},isAnimate:function(){return this._animate},setAnimate:function(a){this._animate=a},getElementBox:function(){return this._box},getExplicitXOffset:function(){return this._explicitXOffset},setExplicitXOffset:function(a){this._explicitXOffset=a},getExplicitYOffset:function(){return this._explicitYOffset},setExplicitYOffset:function(a){this._explicitYOffset=a},getNodeRect:function(a){var b=this;if(a instanceof Gb.Group&&a.isExpanded()&&a.getChildrenSize()>0){for(var c=null,d=0,e=a.getChildrenSize();e>d;d++){var f=a.getChildAt(d);f instanceof Gb.Node&&(c=Gb.Util.unionRect(c,b.getNodeRect(f)))}var g=a.s("group.padding"),h=a.s("group.padding.top"),i=a.s("group.padding.bottom"),j=a.s("group.padding.left"),k=a.s("group.padding.right");return g&&Gb.Util.grow(c,g,g),h&&(c.y-=h,c.height+=h),i&&(c.height+=h),j&&(c.x-=j,c.width+=j),k&&(c.width+=k),c}if(this._network){var l=this._network.getElementUI(a);return l.invalidate(),l.validate(),l.getViewRect()}return null},getDimension:function(a){var b=this.getNodeRect(a);return b?{width:b.width,height:b.height}:{width:a.getWidth(),height:a.getHeight()}},isVisible:function(a){return!0},isMovable:function(a){return!0},getGroupLayoutType:function(a){return this._type},getElements:function(){var a,b=this._box,c=b.getSelectionModel().size()>1;c?a=b.getSelectionModel().getSelection():(a=new md,b.forEachByBreadthFirst(a.add,null,a)),this._xOffset=-1,this._yOffset=-1;for(var d=new md,e=0,f=a.size();f>e;e++){var g=a.get(e);this.isVisible(g)&&(g instanceof Gb.Link?d.add(g):this.isMovable(g)&&g instanceof Ld&&(d.add(g),c&&((this._xOffset<0||g.getX()<this._xOffset)&&(this._xOffset=g.getX()),(this._yOffset<0||g.getY()<this._yOffset)&&(this._yOffset=g.getY()))))}return c||(this._xOffset=isNaN(this._explicitXOffset)?50/this._repulsion:this._explicitXOffset,this._yOffset=isNaN(this._explicitYOffset)?50/this._repulsion:this._explicitYOffset),d},getLayoutResult:function(a){var b={};return this.doLayoutImpl(a,null,b),b},doLayout:function(a,b){return this.doLayoutImpl(a,b)},doLayoutImpl:function(a,b,c){var d=this,e=b;b=function(a){d._box._layoutMovingElements=!1,e&&e(a)},this._type=a;var f=null;if("round"===a?f=new df:"symmetry"===a?f=new sf:"hierarchic"===a?f=new Cf:("topbottom"===a||"bottomtop"===a||"rightleft"===a||"leftright"===a)&&(f=new Re),null==f)return!1;d._box._layoutMovingElements=!0;var g={},h=this.getElements(),i=new tf(this,h,!0,null);h=i.process();var j=new nf(this,h,a,!0,null);try{f.i2(j)}catch(k){return i.resetGroup(),null!=b&&b(!1),!1}var l,m;for(l in j._a){m=j._a[l];var n=j.g4(m);g[l]={x:n.x+this._xOffset,y:n.y+this._yOffset}}var o;if("rightleft"===a||"leftright"===a||"bottomtop"===a){var p=tf.createMatrix(a),q=Number.MAX_VALUE,r=Number.MAX_VALUE;for(l in g){m=j._a[l],o=g[l];var s=p.transform(o);o.x=s.x,o.y=s.y;var t;"rightleft"===a||"leftright"===a?(t=s.x-j.g9(m)/2/this._repulsion,q>t&&(q=t),t=s.y-j.gj(m)/2/this._repulsion,r>t&&(r=t)):(t=s.x-j.gj(m)/2/this._repulsion,q>t&&(q=t),t=s.y-j.g9(m)/2/this._repulsion,r>t&&(r=t))}for(l in g)m=j._a[l],o=g[l],o.x=o.x-q+this._xOffset,o.y=o.y-r+this._yOffset}if(null==c&&this._animate){var u=new md,v=new md;for(l in g)u.add(j._a[l].node),v.add(g[l]);Gb.animate.AnimateManager.endAnimate(),d._box._dataBoxChangeDispatcher.fire({kind:"layouting"}),Gb.animate.AnimateManager.start(new Gb.animate.AnimateCenterLocation(u,v,function(){i.resetGroup(),d._box._dataBoxChangeDispatcher.fire({kind:"layoutEnd"}),null!=b&&Hb.callLater(b,null,[!0])}))}else{d._box._dataBoxChangeDispatcher.fire({kind:"layouting"});for(l in g)m=j._a[l],o=g[l],null==c?m.node.setCenterLocation(o.x,o.y):c[m.node.getId()]=o;i.resetGroup(),d._box._dataBoxChangeDispatcher.fire({kind:"layoutEnd"}),null!=b&&Hb.callLater(b,null,[!0])}return!0}});var Sd=function(a,b){this.x=a,this.y=b};Hb.ext(Sd,Object,{equals:function(a){return this===a?!0:a instanceof Sd?a.x==this.x&&a.y==this.y:!1}});var Td=function(a,b){this.width=a,this.height=b};Hb.ext(Td,Object,{});var Ud=function(a,b){this.x=a,this.y=b};Hb.ext(Ud,Object,{});var Vd=function(){2===arguments.length?(Vd.superClass.constructor.call(this,arguments[1].width,arguments[1].height),this.x=arguments[0].x,this.y=arguments[0].y):(Vd.superClass.constructor.call(this,arguments[2],arguments[3]),this.x=arguments[0],this.y=arguments[1])};Hb.ext(Vd,Td,{});var Wd=function(a,b){if(Wd.a2(a.x,b.x))this._a=1,this._b=0,this._c=-a.x;else{this._b=-1;var c=(b.y-a.y)/(b.x-a.x),d=a.y-a.x*c;this._a=c,this._c=d}};Hb.ext(Wd,Object,{a3:function(){return this._a},a4:function(){return this._b},a5:function(){return this._c}}),Wd.a6=function(a,b){if(Wd.a1(a.a3())&&Wd.a1(b.a3()))return null;if(Wd.a1(a.a4())&&Wd.a1(b.a4()))return null;if(Wd.a1(b.a4())){var c=a;a=b,b=c}var d,e,f=a.a3(),g=a.a4(),h=-a.a5();Wd.a1(a.a3())?(d=b.a4(),e=-b.a5()):(d=b.a4()-b.a3()/a.a3()*a.a4(),e=-b.a5()-b.a3()/a.a3()*-a.a5());var i=e/d,j=(h-i*g)/f;return new Sd(j,i)},Wd.a1=function(a){return Wd.a2(a,0)},Wd.a2=function(a,b){return Math.abs(a-b)<1e-5};var Xd=function(a){if(this._a=new qe,a)for(var b=0;b<a.size();b++)this._a.aa(a.get(b))};Hb.ext(Xd,Object,{c:function(){return this._a.ah()},d:function(){return this._a.ah()},a:function(){for(var a=new md,b=this.c();b.i1();b.i2())a.add(b.i6(),0);return new Xd(a)},b:function(){return this._a.ay()}});var Yd=function(a,b){this.x=a,this.y=b};Hb.ext(Yd,Object,{a:function(a,b){this.x=a,this.y=b}});var Zd=function(a,b){this.x=a||0,this.y=b||0};Hb.ext(Zd,Object,{b:function(){return new Zd(this.x,this.y)},a:function(a){this.z=a},c:function(){return this.x},d:function(){return this.y},f:function(a,b){this.x=a,this.y=b}});var $d=function(a){this._c=new qe,a?(this.ac(a.a8().b()),this.ad(a.a9().b())):(this.ac(new Zd),this.ad(new Zd))};Hb.ext($d,Object,{a6:function(){return this.a5(this)},ac:function(a){a.a(this),this._a=a},ad:function(a){a.a(this),this._b=a},a8:function(){return this._a},a9:function(){return this._b},a1:function(a,b){return this.a4(a,b,this.aa())},a2:function(){return this._c.ay()},a7:function(a){return this._c.ak(a)},aa:function(){return 0===this._c.ay()?null:this._c.as()},a3:function(){this._c.af()},i2:function(a){var b=this.a7(a);return null!=b?new Sd(b.x,b.y):null},i1:function(){return this.a2()},i6:function(){var a=this.a8();return new Sd(a.c(),a.d())},i7:function(){var a=this.a9();return new Sd(a.c(),a.d())},i8:function(a){this.a8().f(a.x,a.y)},i9:function(a){this.a9().f(a.x,a.y)},i3:function(a,b,c){var d=this.a7(a);null!=d&&d.a(b,c)},i4:function(a,b){this.a1(a,b)},i5:function(){this.a3()}});var _d=function(a){_d.superClass.constructor.call(this,a)};Hb.ext(_d,$d,{a5:function(a){return new _d(a)},a4:function(a,b,c){var d=new Yd(a,b);return this.ab(d,c),d},ab:function(a,b){this._c.an(a,this._c.al(b))}});var ae=function(){if(2===arguments.length){var a=arguments[0],b=arguments[1];this._s=!1,this._w=30,this._h=30,this._x=a-this._w/2,this._y=b-this._h/2}else{var c=arguments[0];this._s=c._s,this._w=c._w,this._h=c._h,this._x=c._x,this._y=c._y}};Hb.ext(ae,Object,{m3:function(){return this.m2(this)},m4:function(){return this._x+this._w/2},m5:function(){return this._y+this._h/2},m6:function(a,b){this._x=a-this._w/2,this._y=b-this._h/2},i1:function(){return this._x},i2:function(){return this._y},i5:function(a,b){this._x=a,this._y=b},i3:function(){return this._w},i4:function(){return this._h},i6:function(a,b){var c=(this._w-a)/2,d=(this._h-b)/2;this._x+=c,this._y+=d,this._w=a,this._h=b},m1:function(a){var b,c,d,e;a.width<=0?(b=this._x,c=this._x+this._w,d=this._y,e=this._y+this._h):(b=Math.min(this._x,a.x),c=Math.max(this._x+this._w,a.x+a.width),d=Math.min(this._y,a.y),e=Math.max(this._y+this._h,a.y+a.height)),a.x=b,a.y=d,a.width=c-b,a.height=e-d}});var be=function(a){a?be.superClass.constructor.call(this,a):be.superClass.constructor.call(this,0,0)};Hb.ext(be,ae,{m2:function(a){return new be(a)}});var ce={};ce.a2=function(a){var b=Ne.a2(Hf.a(a.xa()));return ce.a4(a,b,ce.a3(a,b))},ce.a3=function(a,b){for(var c=a.x9();c.i1();c.i2())b.i7(c.i9(),-1);for(var d=0,e=new we(a.xa()),f=a.x9();f.i1();f.i2()){var g=f.i9();-1===b.i2(g)&&ce.a(g,e,b,d++)}return d},ce.a6=function(a){for(var b=new re,c=ce.a2(a),d=0;d<c.length-1;d++){var e=a.xo(c[d].x2(),c[d+1].x3());b.aa(e)}return b},ce.a4=function(a,b,c){for(var d=[],e=0;c>e;e++)d[e]=new Je;for(var f=a.x9();f.i1();f.i2())d[b.i2(f.i9())].ae(f.i9());return d},ce.a=function(a,b,c,d){for(b.c(a),c.i7(a,d);!b.a();){a=b.b();for(var e=a.ag();null!=e;e=e.a8()){var f=e.a3();-1===c.i2(f)&&(c.i7(f,d),b.c(f))}for(var g=a.ae();null!=g;g=g.a7()){var h=g.a2();-1===c.i2(h)&&(c.i7(h,d),b.c(h))}}},ce.a1=function(a,b,c){var d=new le(b,c);return d.a8(a),d._i},ce.a5=function(a,b,c){for(var d=[],e=0;c>e;e++)d[e]=new re;for(var f=a.xf();f.i1();f.i2())d[b.i2(f.i8())].aa(f.i8());return d},ce.a7=function(a){var b=new re,c=Ne.a3(Hf.b(a.xa())),d=Ne.a4(Hf.a(a.xh())),e=ce.a1(a,d,c),f=ce.a5(a,d,e);if(f.length>1){for(var g=new Je,h=0;h<f.length;h++){var i=f[h],j=null;if(1===i.ay()){var k=i.c2();1===k.a2().ad()?j=k.a2():1===k.a3().ad()&&(j=k.a3())}else{for(var l=i.c1();l.i1();l.i2()){var m=l.i8();if(c.i4(m.a2()))if(null==j)j=m.a2();else if(j!==m.a2()){j=null;break}if(c.i4(m.a3()))if(null!=j){if(j!==m.a3()){j=null;break}}else j=m.a3()}if(null!=j){var n=i.c2();j=n.a2()!==j?n.a2():n.a3()}}null!=j&&g.aa(j)}for(var o,p=g.x4();!g.ar();p=o)o=g.x4(),b.ac(a.xo(p,o))}return b};var de=function(){this._c=0,this._d=0,this._e=0,this._b=!0,this._f=!1};Hb.ext(de,Object,{a6:function(a){this._f=a},a7:function(a){this._b=a},a8:function(a){0!==a.x0()&&this.a9(a,a.x9().i9())},a9:function(a,b){if(this._xx=a.xk(),this._c=a.xl(),this._d=0,this._e=0,this.a0(b),this._b)for(var c=a.x9();c.i1();c.i2()){var d=c.i9();null==this._xx.i1(d)&&(this.a1(d),this.a0(d))}a.xi(this._xx),a.xj(this._c)},a0:function(a){var b=++this._d;this._xx.z1(a,de._B),this.a5(a,b);for(var c=this._f?a.ap():a.af();c.i1();c.i2()){var d=c.i8();if(!this._c.i4(d)){this._c.i7(d,!0);var e=d.a1(a);null==this._xx.i1(e)?(this.a3(d,e,!0),this.a0(e),this.a2(d,e)):this.a3(d,e,!1)}}this.a4(a,b,++this._e),this._xx.z1(a,de._C)},a5:function(a,b){},a4:function(a,b,c){},a3:function(a,b,c){},a2:function(a,b){},a1:function(a){}}),de._B={},de._C={};var ee=function(a){this._a=a};Hb.ext(ee,de,{a5:function(a,b){var c=this._a._ah.i2(a);this._a._ad[c].ae(a)}});var fe=function(a){this._a=a};Hb.ext(fe,de,{a2:function(a,b){var c=a.a1(b),d=this._a[c.al()],e=this._a[b.al()];e._a+1>d._a?(d._c=d._a,d._b=d._d,d._a=e._a+1,d._d=a):e._a+1>d._c&&(d._c=e._a+1,d._b=a)}});var ge=function(a){this._a=a};Hb.ext(ge,de,{a3:function(a,b,c){c&&a.a2()===b&&this._a.ac(a)}});var he=function(){this._a=0,this._c=0};Hb.ext(he,Object,{});var ie=function(){this._a=0};Hb.ext(ie,Object,{a1:function(a,b){this._a=0;for(var c=b.length-1;c>=0;c--)b[c]=-1;for(var d=a.x9();d.i1();d.i2()){var e=d.i9();if(0===e.ak()){this.a2(e,e.al(),b);break}}for(var f=a.x9();f.i1();f.i2()){var g=f.i9(),h=g.al();-1===b[h]&&this.a2(g,h,b)}},a2:function(a,b,c){c[b]=-2;for(var d=a.ag();null!=d;){var e=d.a3(),f=e.al();switch(c[f]){case-1:this.a2(e,f,c);case-2:default:d=d.a8()}}c[b]=this._a++}});var je={};je.a1=function(a){var b=new ke;return b.a8(a),b._n},je.a2=function(a){var b=a.x9(),c=null,d=0;for(b.i4();b.i1();b.i2())0===b.i9().ak()&&(c=b.i9(),d++);if(1===d)return c;for(d=0,b.i4();b.i1();b.i2())0===b.i9().ao()&&(c=b.i9(),d++);return 1===d?c:je.a8(a)},je.a8=function(a){var b=Hf.a(a.x0()),c=Ne.a2(b);return je.a6(a,c)},je.a6=function(a,b){var c=a.xd(),d=Hf.d(1),e=Hf.a(a.x0(),-1),f=je.a4(a,c);je.a7(c,b,d,e,-1);for(var g=f.c1();g.i1();g.i2())a.x3(g.i8());return d[0]},je.a7=function(a,b,c,d,e){for(var f=0,g=a.ag();null!=g;g=g.a8()){var h=g.a3(),i=je.a7(h,b,c,d,e);i>e&&(e=i),f+=d[h.al()]}for(var j=f*(a._g.xa()-1-f),k=a.ag();null!=k;k=k.a8())for(var l=k.a3(),m=k.a8();null!=m;m=m.a8()){var n=m.a3();j+=d[l.al()]*d[n.al()]}return b.i7(a,j),d[a.al()]=f+1,j>e&&(e=j,c[0]=a),e},je.a4=function(a,b){var c=new re,d=new ge(c);d.a6(!1),d.a9(a,b);for(var e=c.c1();e.i1();e.i2())a.x3(e.i8());return c},je.a3=function(a){return je.a4(a,je.a2(a))};var ke=function(){this._n=!0,this.a6(!1)};Hb.ext(ke,de,{a3:function(a,b,c){c||(this._n=!1)},a1:function(a){this._n=!1}});var le=function(a,b){this._i=0,this._m=b,this._j=a,this._l=!1};Hb.ext(le,de,{a8:function(a){this._h=Hf.a(a.x0()),this._k=Hf.a(a.x0()),this._g=new we(a.xh()),le.superClass.a8.call(this,a)},a5:function(a,b){this._k[a.al()]=this._h[a.al()]=b},a3:function(a,b,c){if(this._g.c(a),!c){var d=a.a1(b);this._h[d.al()]=Math.min(this._h[d.al()],this._k[b.al()])}},a1:function(a){this._l=!1},a2:function(a,b){var c=a.a1(b);if(this._h[b.al()]>=this._k[c.al()]){for(;this._g.d()!==a;this._j.i5(this._g.b(),this._i));this._j.i5(this._g.b(),this._i),this._i++,this._g.a()?this._l?this._m.i5(c,!0):this._l=!0:this._m.i5(c,!0)}this._h[c.al()]=Math.min(this._h[c.al()],this._h[b.al()])}});var me=function(a,b){this._h=!1,this._i=a,this._g=b};Hb.ext(me,Object,{z1:function(a,b){a._c[this._i]=b},i1:function(a){return a._c[this._i]},i5:function(a,b){a._c[this._i]=b},i4:function(a){return a._c[this._i]},i7:function(a,b){a._c[this._i]=b},i2:function(a){var b=a._c[this._i];return null==b?0:b},i6:function(a,b){a._c[this._i]=b},i3:function(a){var b=a._c[this._i];return null==b?0:b},c:function(){return this._h},d:function(){this._h=!0}});var ne=function(a,b){this._c=!1,this._d=a,this._b=b};Hb.ext(ne,Object,{i8:function(a,b){a._c[this._d]=b},i1:function(a){return a._c[this._d]},i7:function(a,b){a._c[this._d]=b},i4:function(a){var b=a._c[this._d];return null==b?!1:b},i5:function(a,b){a._c[this._d]=b},i2:function(a){var b=a._c[this._d];return null==b?0:b},i6:function(a,b){a._c[this._d]=b},i3:function(a){var b=a._c[this._d];return null==b?0:b},a:function(){return this._c},b:function(){this._c=!0}});var oe=function(a){this._bb=a,this.i4()};Hb.ext(oe,Object,{i1:function(){return null!=this._aa},i2:function(){this._aa=this._aa._a},i3:function(){this._aa=this._aa._b},i4:function(){this._aa=this._bb._b},i5:function(){this._aa=this._bb._c},i7:function(){return this._bb.ay()},i6:function(){return this._aa._c}});var pe=function(a){pe.superClass.constructor.call(this,a)};Hb.ext(pe,oe,{i8:function(){return this.i6()}});var qe=function(a){if(this._id=Hb.id(),this._a=0,a)for(a.i4();a.i1();a.i2())this.ae(a.i6())};Hb.ext(qe,Object,{ac:function(a){var b=this.ag(a);return null==this._b?this._b=this._c=b:(this._b._b=b,b._a=this._b,this._b=b),this._a++,b},ae:function(a){var b=this.ag(a);return null==this._c?this._b=this._c=b:(this._c._a=b,b._b=this._c,this._c=b),this._a++,b},z1:function(a){a._b=null,a._a=null,null==this._c?this._b=this._c=a:(this._c._a=a,a._b=this._c,this._c=a),this._a++},ad:function(a){a._b=null,a._a=null,null==this._b?this._b=this._c=a:(this._b._b=a,a._a=this._b,this._b=a),this._a++},aa:function(a){return this.ae(a),!0},ab:function(a){for(;a.i1();a.i2())this.ae(a.i6())},ao:function(a,b){if(b===this._b)return this.ac(a);if(null==b)return this.ae(a);var c=this.ag(a);return this.aq(c,b),c},aq:function(a,b){if(null==b)this.ad(a);else if(b===this._b)this.ad(a);else{if(null==this._c)a._b=null,a._a=null,this._b=this._c=a;else{var c=b._b;b._b=a,a._a=b,c._a=a,a._b=c}this._a++}},ap:function(a,b){if(null==b)this.z1(a);else if(b===this._c)this.z1(a);else{if(null==this._b)a._b=null,a._a=null,this._b=this._c=a;else{var c=b._a;b._a=a,a._a=c,c._b=a,a._b=b}this._a++}},an:function(a,b){if(b===this._c)return this.ae(a);if(null==b)return this.ac(a);var c=this.ag(a);return this.ap(c,b),c},ay:function(){return this._a},ar:function(){return 0===this._a},af:function(){this._b=this._c=null,this._a=0},am:function(){return this._b._c},at:function(){var a=this.am();return this.aw(this._b),a},as:function(){return this._c._c},au:function(){return this.aw(this._c)},ak:function(a){for(var b=0,c=this._b;null!=c;){if(a===b)return c._c;c=c._a,b++}return null},aj:function(a){return null==a._a?this._b:a._a},ai:function(a){return null==a._b?this._c:a._b},aw:function(a){return a!==this._b?a._b._a=a._a:this._b=a._a,a!==this._c?a._a._b=a._b:this._c=a._b,this._a--,a._c},av:function(a){return this.aw(a._aa)},ah:function(){return new oe(this)},al:function(a){for(var b=this._b;null!=b;){if(null==b._c&&null==a)return b;if(b._c===a)return b;b=b._a}return null},a0:function(){for(var a=Hf.d(this._a),b=0,c=this._b;null!=c;)a[b]=c._c,c=c._a,b++;return a},ax:function(){for(var a=this._b;null!=a;a=a._b){var b=a._a;a._a=a._b,a._b=b}var c=this._b;this._b=this._c,this._c=c},a1:function(a){var b=this.a0();b.sort(a);for(var c=0,d=this._b;null!=d;)d._c=b[c],d=d._a,c++},a2:function(){var a=this.a0();a.sort(Hf.c);for(var b=0,c=this._b;null!=c;)c._c=a[b],c=c._a,b++},az:function(a){null==this._b?(this._b=a._b,this._c=a._c):null!=a._b&&(this._c._a=a._b,a._b._b=this._c,this._c=a._c),this._a+=a._a,a._b=a._c=null,a._a=0},ag:function(a){return new ue(a)}});var re=function(a){re.superClass.constructor.call(this,a)};Hb.ext(re,qe,{c1:function(){return new pe(this)},c2:function(){return this.am()},c3:function(){return this.at()}});var se=function(){this._c=0};Hb.ext(se,Object,{a:function(a){this._c++,a._b=this._b,a._a=null,null!=this._b?(this._b._a=a,this._b=a):this._b=this._a=a},b:function(a,b){if(null==b)return void this.a(a);var c=b._b;null!=c?c._a=a:this._a=a,a._b=c,a._a=b,b._b=a,this._c++},c:function(a){var b=a._a,c=a._b;this._c--,null!=b?b._b=c:this._b=c,null!=c?c._a=b:this._a=b}});var te=function(a,b){this._p=a,this._j=b,this._o=a._o[b]};Hb.ext(te,Object,{i1:function(){return null!=this._o},i2:function(){this._o=this._o._k[this._j]},i3:function(){this._o=this._o._f[this._j]},i4:function(){this._o=this._p._o[this._j]},i5:function(){this._o=this._p._q[this._j]},i7:function(){return this._p._n[this._j]},i6:function(){return this._o},i8:function(){return this._o}});var ue=function(a){this._c=a};Hb.ext(ue,Object,{a:function(){return this._a},b:function(){return this._b},c:function(a){this._c=a},d:function(){return this._c}});var ve=function(a,b,c,d){this._r=a,this._s=b,this._q=c,this._p=d};Hb.ext(ve,Object,{i1:function(a){return this._p[a.a5()]},i3:function(a){return this._r[a.a5()]},i2:function(a){return this._s[a.a5()]},i4:function(a){return this._q[a.a5()]},i8:function(a,b){this._p[a.a5()]=b},i6:function(a,b){this._r[a.a5()]=b},i5:function(a,b){this._s[a.a5()]=b},i7:function(a,b){this._q[a.a5()]=b}});var we=function(a){this._a=Hf.d(a),this._b=-1};Hb.ext(we,Object,{d:function(){return this._a[this._b]},b:function(){return this._a[this._b--]},c:function(a){this._a[++this._b]=a},a:function(){return this._b<0}});var xe=function(){};Hb.ext(xe,Object,{a0:function(a){this._c=Hf.d(a)}});var ye=function(a,b,c,d,e,f,g){this._g=0,a.xt(this,b,c,d,e,f,g)};Hb.ext(ye,xe,{a5:function(){return this._h._u&&this._h.b1(),this._g},a2:function(){return this._d},a3:function(){return this._e},a1:function(a){return this._d!==a?this._d:this._e},a4:function(){for(var a=0;1>=a;a++)this._k[a]=null,this._f[a]=null},a8:function(){return this._k[0]},a7:function(){return this._k[1]},a6:function(a,b,c,d){this.a0(d),this._h=a,this._k=Hf.d(2),this._f=Hf.d(2),this._d=b,this._e=c}});var ze=function(a){this._j=0,this._h=a,this.i4()};Hb.ext(ze,Object,{i2:function(){this._k=this._k._k[this._j],null==this._k&&0===this._j&&(this._k=this._h._o[1],this._j=1)},i3:function(){this._k=this._k._f[this._j],null==this._k&&1===this._j&&(this._k=this._h._q[0],this._j=0)},i4:function(){this._k=this._h._o[0],null==this._k?(this._k=this._h._o[1],this._j=1):this._j=0},i5:function(){this._k=this._h._q[1],null==this._k?(this._k=this._h._q[0],this._j=0):this._j=1},i1:function(){return null!=this._k},i6:function(){return this._k},i8:function(){return this._k},i7:function(){return this._h.ad()}});var Ae=function(){this._a=ff._A,this._b=ff._A,this._c=new md};Hb.ext(Ae,Object,{i1:function(){return this._c.size()},i2:function(a){return this._c.get(a)},i3:function(a,b,c){this._c.set(a,new Sd(b,c))},i4:function(a,b){this._c.add(new Sd(a,b))},i5:function(){this._c.clear()},i6:function(){return this._a},i7:function(){return this._b},i8:function(a){this._a=a},i9:function(a){this._b=a}});var Be=function(){this._x=0,this._y=0,this._w=0,this._h=0};Hb.ext(Be,Object,{i5:function(a,b){this._x=a,this._y=b},i6:function(a,b){this._w=a,this._h=b},i4:function(){return this._h},i3:function(){return this._w},i1:function(){return this._x},i2:function(){return this._y}});var Ce=function(a,b,c,d){this._m=a,this._n=b,this._l=c,this._k=d};Hb.ext(Ce,Object,{i1:function(a){return this._k[a.al()]},i3:function(a){return this._m[a.al()]},i2:function(a){return this._n[a.al()]},i4:function(a){return this._l[a.al()]},z1:function(a,b){this._k[a.al()]=b},i6:function(a,b){this._m[a.al()]=b},i7:function(a,b){this._n[a.al()]=b},i5:function(a,b){this._l[a.al()]=b}});var De=function(a,b){this._b=a,this._r=b,this._a=[];for(var c=this._b-1;c>=0;c--)this._a.push(c);this._c=new md};Hb.ext(De,Object,{a1:function(a){var b;if(0===this._a.length){this.a2(a,this._b,this._b+this._r);for(var c=this._b+this._r-1;c>this._b;c--)this._a.push(c);b=this._b,this._b+=this._r}else b=this._a.pop();return b},b:function(a){var b=this.a1(a),c=new me(b,this);return this._c.add(c),this.a4(a,b),c},c:function(a){var b=this.a1(a),c=new ne(b,this);return this._c.add(c),this.a4(a,b),c},a2:function(a,b,c){for(var d=a._a;null!=d;d=d._a){var e=Hf.d(c);Hf.f(d._c,e,b),d._c=e}},a3:function(a,b,c){var d=Hf.d(c);Hf.f(a._c,d,b),a._c=d},a4:function(a,b){for(var c=a._a;null!=c;c=c._a)c._c[b]=null},a5:function(a,b){if(a instanceof me){var c=a;if(c.c())throw"Error";c.d();var d=a._i;this._a.indexOf(d)<0&&(this.a4(b,d),this._a.push(d),this._c.remove(a))}},a6:function(a,b){if(a instanceof ne){var c=a;if(c.a())throw"Error";c.b();var d=c._d;this._a.indexOf(d)<0&&(this.a4(b,d),this._a.push(d),this._c.remove(a))}}});var Ee=function(a){this._id=Hb.id(),this._p=0,a.xs(this)};Hb.ext(Ee,xe,{ad:function(){return this._n[0]+this._n[1]},ak:function(){return this._n[1]},ao:function(){return this._n[0]},al:function(){return this._g._y&&this._g.c(),this._p},ag:function(){return this._o[0]},ae:function(){return this._o[1]},af:function(){return new ze(this)},am:function(){return new te(this,1)},ap:function(){return new te(this,0)},an:function(){return new Ge(this)},aq:function(){return new Fe(this,1)},aw:function(){return new Fe(this,0)},ah:function(a){for(var b=this._o[0];null!=b;b=b._k[0])if(b.a3()===a)return b;return null},ai:function(a){for(var b=this._o[1];null!=b;b=b._k[1])if(b.a2()===a)return b;return null},aj:function(a){var b=this.ah(a);return null==b&&(b=this.ai(a)),b},au:function(a){this.at(a,1,Hf.d(this.ak()))},av:function(a){this.at(a,0,Hf.d(this.ao()))},as:function(a,b){this.a0(b),this._g=a,this._o=Hf.d(2),this._q=Hf.d(2),this._n=Hf.a(2)},ab:function(a,b,c,d,e){if(null==b)return void this.aa(a,c,d);var f;if(f=b._d===b._e?d:this!==b._d?1:0,0===e){var g=b._k[f];a._f[d]=b,a._k[d]=g,b._k[f]=a,null==g?this._q[c]=a:g._d===g._e?g._f[d]=a:g._f[this!==g._d?1:0]=a;

}else{var h=b._f[f];a._k[d]=b,a._f[d]=h,b._f[f]=a,null==h?this._o[c]=a:h._d===h._e?h._k[d]=a:h._k[this!==h._d?1:0]=a}this._n[c]++},aa:function(a,b,c){var d=this._q[b];a._k[c]=null,null==d?(this._o[b]=a,a._f[c]=null):(a._f[c]=d,d._d===d._e?d._k[c]=a:d._k[this!==d._d?1:0]=a),this._q[b]=a,this._n[b]++},ar:function(a,b,c){var d,e;d=a._k[c],e=a._f[c],null==d?this._q[b]=e:d._f[d._d!==this?1:0]=e,null==e?this._o[b]=d:e._k[e._d!==this?1:0]=d,this._n[b]--},ac:function(){for(var a=0;1>=a;a++)this._o[a]=null,this._q[a]=null,this._n[a]=0},at:function(a,b,c){if(!(this._n[b]<2)){var d,e=this._n[b],f=0;for(d=this._o[b];null!=d;d=d._k[b])c[f]=d,f++;Hf.s(c,e,a);var g=this._o[b]=c[0];g._f[b]=null;for(var h=1;e>h;)d=c[h],d._f[b]=g,g._k[b]=d,h++,g=d;this._q[b]=d,d._k[b]=null}}});var Fe=function(a,b){Fe.superClass.constructor.call(this,a,b),this._h=1!==b?1:0};Hb.ext(Fe,te,{i6:function(){return this.i9()},i9:function(){return 0!==this._h?this._o._e:this._o._d}});var Ge=function(a){Ge.superClass.constructor.call(this,a)};Hb.ext(Ge,ze,{i6:function(){return this._k.a1(this._h)},i9:function(){return this._k.a1(this._h)}});var He=function(a){He.superClass.constructor.call(this,a)};Hb.ext(He,oe,{i9:function(){return this.i6()}});var Ie=function(a){this._o=a,this._c=a._a};Hb.ext(Ie,Object,{i1:function(){return null!=this._c},i2:function(){this._c=this._c._a},i3:function(){this._c=this._c._b},i5:function(){this._c=this._o._b},i4:function(){this._c=this._o._a},i7:function(){return this._o._c},i6:function(){return this._c},i9:function(){return this._c},i8:function(){return this._c}});var Je=function(a){if(a&&a.length){Je.superClass.constructor.call(this);for(var b=0;b<a.length;b++)this.ae(a[b])}else Je.superClass.constructor.call(this,a)};Hb.ext(Je,qe,{x1:function(){return new He(this)},x2:function(){return this.am()},x3:function(){return this.as()},x4:function(){return this.at()}});var Ke=function(a){this._d=a,Ke.superClass.constructor.call(this)};Hb.ext(Ke,Je,{});var Le=function(a){this._a=a,this._b=new re,this._c=new Je};Hb.ext(Le,Object,{a:function(){for(var a=this._a.x9();a.i1();a.i2())this.e(a.i9())},b:function(){this.c(),this.d()},c:function(){for(;!this._c.ar();){var a=this._c.x4();this._a.xq(a)||this.g(a)}},d:function(){for(;!this._b.ar();){var a=this._b.c3();this._a.xp(a)||this.f(a)}},e:function(a){for(var b=a.af();b.i1();b.i2())this._b.ac(b.i8()),this._a.h1(b.i8());this._c.ac(a),this._a.h2(a)},f:function(a){this._a.u1(a)},g:function(a){this._a.h3(a)}}),Le.h=function(a,b){for(b.i4();b.i1();b.i2()){var c=b.i8();a.xq(c.a2())||a.h3(c.a2()),a.xq(c.a3())||a.h3(c.a3()),a.xp(c)||a.u1(c)}},Le.i=function(a,b){for(b.i4();b.i1();b.i2()){var c=b.i8();a.xp(c)&&a.h1(c),0===c.a2().ad()&&a.h2(c.a2()),0===c.a3().ad()&&a.h2(c.a3())}};var Me=function(){this._g=arguments[0],this._f=this._g.xk(),this._h=this._g.xk(),this._d=new qe,this._e=0,1!==arguments.length&&this.a(arguments[1],arguments[2],arguments[3],arguments[4])};Hb.ext(Me,Object,{a:function(a,b,c,d){for(var e=Hf.d(c-b+1),f=b;c>=f;f++)e[f]=new Ke(f);for(var g=this._g.x9();g.i1();g.i2()){var h=g.i9();(null==d||d.i4(h))&&(this._f.z1(h,e[a.i2(h)-b].ac(h)),this._e++)}for(var i=0;i<e.length;i++)for(var j=e[i],k=this._d.ae(j),l=j.x1();l.i1();l.i2())this._h.z1(l.i9(),k)},c:function(){this._g.xi(this._h),this._g.xi(this._f)},e:function(){return 0===this._e},g:function(){for(;this._d.am().ar();this._d.at());this._e--;var a=this._d.am().x4();return this._h.z1(a,null),this._f.z1(a,null),a},f:function(){for(;this._d.as().ar();this._d.au());this._e--;var a=this._d.as().x4();return this._h.z1(a,null),this._f.z1(a,null),a},d:function(a){var b=this._f.i1(a),c=this._h.i1(a),d=c.d(),e=null,f=c.a();null!=f?(e=f.d(),this._h.z1(a,f)):(e=new Ke(d._d+1),this._h.z1(a,this._d.ae(e))),d.aw(b),this._f.z1(a,e.ac(a))},b:function(a){var b=this._f.i1(a),c=this._h.i1(a),d=c.d(),e=null,f=c.b();null!=f?(e=f.d(),this._h.z1(a,f)):(e=new Ke(d._d-1),this._h.z1(a,this._d.ac(e))),d.aw(b),this._f.z1(a,e.ac(a))}});var Ne={};Ne.a1=function(a){return new Ce(a,null,null,null)},Ne.a2=function(a){return new Ce(null,a,null,null)},Ne.a3=function(a){return new Ce(null,null,a,null)},Ne.a4=function(a){return new ve(null,a,null,null)},Ne.a5=function(a){return new ve(null,null,a,null)},Ne.a6=function(a){return new ve(null,null,null,a)};var Oe=function(){if(2===arguments.length){this._a=new qe,this._b=new qe,this._c=0;var a=arguments[0],b=arguments[1],c=new Pe(a._j2.gj(b)/2,0);this._a.ac(c),c=new Pe(a._j2.gj(b)/2,0),this._b.ac(c)}else this._a=arguments[1],this._b=arguments[2],this._c=arguments[3]};Hb.ext(Oe,Object,{});var Pe=function(a,b){this._b=a,this._a=b};Hb.ext(Pe,Object,{});var Qe=function(){this._cx=!0,this._cs=new af,this._ct=new $e,this._cw=new _e};Hb.ext(Qe,Object,{i5:function(a){this._cx=a},k:function(){var a=new bf(this);return this._cx&&(this._cs.w1(a),a=this._cs),this._cw.w1(a),a=this._cw,this._ct.w1(a),a=this._ct},i2:function(a){this.k().i2(a)},i1:function(a){return this.k().i1(a)}});var Re=function(){Re.superClass.constructor.call(this),this._jv=20,this._jw=40,this._jx=function(a,b){var c=a.a3(),d=b.a3(),e=c._g;return Math.floor(100*(e.g5(c)-e.g5(d)))}};Hb.ext(Re,Qe,{i4:function(a){return je.a1(a)},i3:function(a){if(!this.i4(a))throw"Error";var b=je.a3(a);if(this._j2=a,this._j3=new Se(a),of.c(a),this._jy=a.xk(),!a.xb()){this.bu();var c=this._j3.c1();this.f(c),this.b(this._j3),this.c(this._j3)}for(var d;!b.ar();a.x3(d))d=b.c3(),of.b(a.g2(d))},bu:function(){if(null!=this._jx)for(var a=this._j2.x9();a.i1();a.i2())a.i9().av(this._jx)},c:function(a){for(var b=this.a2(a),c=Hf.a(b.length),d=0;d<b.length;d++){for(var e=b[d],f=0,g=e.ah();g.i1();g.i2()){var h=g.i6();f=Math.max(f,this._j2.g9(h))}c[d]=f}for(var i=-this._jw,j=0;j<b.length;j++){i+=this._jw+c[j];for(var k=b[j],l=k.ah();l.i1();l.i2()){var m=l.i6();this._j2.s2(m,this._j2.g5(m),i-c[j]/2)}}},a2:function(a){for(var b=Hf.d(a.b()),c=0,d=a.b();d>c;c++)b[c]=new qe;return a.c1(),this.a1(a.c1(),0,b),b},a1:function(a,b,c){c[b].ae(a);for(var d=a.aw();d.i1();d.i2())this.a1(d.i9(),b+1,c)},b:function(a){var b=a.c1();this._j2.s2(b,0,this._j2.g6(b)),this.g(b)},g:function(a){for(var b=a.aw();b.i1();b.i2()){var c=b.i9(),d=this._jy.i1(c);this._j2.s2(c,this._j2.g5(a)+d._c,this._j2.g6(c)),this.g(c)}},f:function(a){if(this._j3.c2(a))return void this._jy.z1(a,new Oe(this,a));var b=a.aw(),c=b.i9();b.i2(),this.f(c);var d=this._jy.i1(c),e=new Oe(this,d._a,d._b,0);if(!b.i1())return e._a.ac(new Pe(this._j2.gj(a)/2,0)),e._b.ac(new Pe(this._j2.gj(a)/2,0)),void this._jy.z1(a,e);for(;b.i1();){c=b.i9(),b.i2(),this.f(c),d=this._jy.i1(c);for(var f=e._b.ah(),g=d._a.ah(),h=2147483647,i=0,j=0;f.i1()&&g.i1();){var k=f.i6();f.i2();var l=g.i6();g.i2(),j+=k._a,i+=l._a,h=Math.min(h,i-j-k._b-l._b)}d._c=this._jv-h,i+=d._c;var m=d._b.am();if(m._a=d._c,f.i1()&&!g.i1())for(var n=j-this.a3(d._b);f.i1();n=0){var o=f.i6();f.i2(),d._b.ae(new Pe(o._b,o._a+n))}else if(!f.i1()&&g.i1()){var p=this.a3(e._a);for(p=i-p;g.i1();p=0){var q=g.i6();g.i2(),e._a.ae(new Pe(q._b,q._a+p))}}e._b=d._b}this._jy.z1(a,e);for(var r=-d._c/2,s=a.aw();s.i1();){var t=s.i9();s.i2();var u=this._jy.i1(t);u._c+=r;var v=u._b.am();v._a+=r,v=u._a.am(),v._a+=r}e._a.ac(new Pe(this._j2.gj(a)/2,0)),e._b.ac(new Pe(this._j2.gj(a)/2,0))},a3:function(a){for(var b=0,c=a.ah();c.i1();c.i2()){var d=c.i6();b+=d._a}return b}});var Se=function(a){this._b=a,this.a()};Hb.ext(Se,Object,{c1:function(){return null==this._a&&this.a(),this._a},b:function(){return null==this._a?-1:this.d(this._a)},d:function(a){for(var b=0,c=a.aw();c.i1();c.i2())b=Math.max(b,this.d(c.i9()));return b+1},c2:function(a){return 0===a.ao()},a:function(){for(var a=this._b.x9();a.i1();a.i2())if(0===a.i9().ak())return void(this._a=a.i9())}});var Te=function(a){this._d=0,this._e=0,this._f=0,this._a=0,this._b=0,this._g=a,this._c=new qe};Hb.ext(Te,Object,{a:function(){return this._d+this._e+this._f}});var Ue=function(){Ue.superClass.constructor.call(this),this._kl=340,this._km=360,this._kk=40,this._ko=.5};Hb.ext(Ue,Qe,{ic:function(){return this._km},ia:function(){return this._kl},i9:function(){return this._ko},i3:function(a){if(!je.a1(a))throw"Error";this._a=a;var b=this.i8(),c=je.a4(a,b);of.c(a),this._kn=Hf.d(a.x0());for(var d=a.x9();d.i1();d.i2()){var e=d.i9();e!==b?this.aa(e,new Te(this._kk+this.q(e.aq().i9()))):this.aa(e,new Te(this._kk))}this.s(b),a.s2(b,0,0),this.t(b);for(var f;!c.ar();a.x3(f))f=c.c3()},i4:function(a){return je.a1(a)},i0:function(a){return this._kn[a.al()]},i8:function(){return je.a2(this._a)},i7:function(a){for(var b,c=this.ib(a);;){if(b=this.i6(a),c>=b)break;for(var d=a.aw();d.i1();d.i2()){var e=d.i9();this.i0(e)._g*=1+this._ko}}var f=(c-b)/(2*a.ao());b=0;for(var g=a.aw();g.i1();g.i2()){var h=this.i0(g.i9());h._d+=f,h._e+=f,b+=h._d+h._e}this.id(a)},id:function(a){for(var b=Hf.d(a.ao()),c=0,d=a.ap();d.i1();)b[c]=d.i8(),d.i2(),c++;var e=this;b.sort(function(a,b){var c=a.a3(),d=b.a3(),f=e.i0(c).a()-e.i0(d).a();return f>0?1:f>=0?0:-1});for(var f=0;f<b.length;f++)this._a.h1(b[f]);for(var g=0;g<b.length;g+=2)this._a.u1(b[g]);for(c=b.length-1,c%2===0&&c--;c>0;c-=2)this._a.u1(b[c])},ib:function(a){return 0===a.ak()?this._km:2===a.ao()?Math.min(180,this._kl):this._kl},i6:function(a){for(var b=0,c=a.ap();c.i1();c.i2()){for(var d,e=c.i8(),f=e.a3(),g=this.i0(f),h=-g._g,i=g._b,j=g._c,k=0,l=k+1,m=j._b,n=m.d();l>k;l=(d.y-i)/(d.x-h))d=n,m=j.ai(m),n=m.d(),k=(n.y-d.y)/(n.x-d.x);for(g._d=180*-Math.atan(l)/Math.PI,k=0,l=k-1,m=j._b,n=m.d();m.a().d().x===n.x;n=m.d())m=m.a();for(var o;k>l;l=(o.y-i)/(o.x-h))o=n,m=j.aj(m),n=m.d(),k=(n.y-o.y)/(n.x-o.x);g._e=180*Math.atan(l)/Math.PI,b+=g._d+g._e}return b},aa:function(a,b){this._kn[a.al()]=b},p:function(a){var b=this.i0(a),c=new qe,d=2*this.q(a);c.aa(new Sd(0,0)),c.aa(new Sd(0,d)),c.aa(new Sd(d,d)),c.aa(new Sd(d,0)),b._c=c,b._a=d/2,b._b=d/2},r:function(a){if(0===a.ao())this.p(a);else{var b=this.i0(a),c=this.q(a),d=new qe;d.aa(new Sd(-c,-c)),d.aa(new Sd(-c,c)),d.aa(new Sd(c,-c)),d.aa(new Sd(c,c));for(var e=a.aw();e.i1();e.i2()){var f=this.i0(e.i9());d.az(f._c)}for(var g=ff.h(d),h=Number.MAX_VALUE,i=Number.MAX_VALUE,j=Number.MIN_VALUE,k=Number.MIN_VALUE,l=g.ah();l.i1();l.i2()){var m=l.i6();m.x<h&&(h=m.x),m.x>j&&(j=m.x),m.y<i&&(i=m.y),m.y>k&&(k=m.y)}for(var n=new qe,o=g.ah();o.i1();o.i2()){var p=o.i6();n.aa(new Sd(p.x-h,p.y-i))}b._c=n,b._a=-h,b._b=-i}},s:function(a){if(0===a.ao())this.r(a);else{for(var b=a.aw();b.i1();b.i2())this.s(b.i9());this.i7(a);for(var c=0,d=a.aw();d.i1();d.i2()){var e=d.i9(),f=this.i0(e),g=180-(360-this.ib(a))/2-c-(f._e+f._f);c+=f.a(),g=g/180*Math.PI;for(var h=Math.sin(g),i=Math.cos(g),j=f._c._b;null!=j;j=j.a()){var k=j.d(),l=k.x+f._g,m=k.y-f._b,n=new Sd(l*i-h*m,l*h+i*m);j.c(n)}var o=f._a+f._g;f._a=o*i,f._b=o*h}this.r(a)}},t:function(a){var b=this._a.g4(a),c=0;if(a.ak()>0){var d=a.aq().i9(),e=this._a.g4(d);c=Math.PI+Math.atan2(e.y-b.y,e.x-b.x)}for(var f=a.aw();f.i1();f.i2()){var g=f.i9(),h=this.i0(g);if(0!==c){var i=Math.cos(c),j=Math.sin(c),k=h._a*i-j*h._b,l=h._a*j+i*h._b;h._a=k,h._b=l}this._a.s2(g,b.x+h._a,b.y+h._b),this.t(g)}},q:function(a){return 1.41*(Math.max(this._a.gj(a),this._a.g9(a))/2)}});var Ve=function(){};Hb.ext(Ve,Object,{i2:function(a){return a.ad()},i1:function(a){throw"Error"},i3:function(a){throw"Error"},i4:function(a){throw"Error"}});var We=function(a){this._a=a};Hb.ext(We,Object,{i2:function(a){for(var b=0,c=a.an();c.i1();c.i2())null!=this._a.i1(c.i9())&&b++;return b},i4:function(a){return null==this._a.i1(a)},i1:function(a){throw"Error"},i3:function(a){throw"Error"}});var Xe=function(){Xe.superClass.constructor.call(this),this._kq=!1,this._kp=90};Hb.ext(Xe,Ue,{a:function(a,b){this._kr=b,this._ks=a,this._kq=!0},i7:function(a){if(!this.u(a))return void Xe.superClass.i7.call(this,a);for(var b=this.i9(),c=this.ib(a),d=(360-c)/2+c,e=new re(a.ap());;){var f=this.i6(a);f=(360-c)/2;for(var g=null,h=null,i=e._b;null!=i;i=i.a()){var j=i.d(),k=j.a3(),l=this.i0(k),m=this._ks.i3(j),n=m-(f+l._e);if(n>=0&&m+l._d>=d&&(n=f+l.a()<=d?d-f-l.a():2*(d-(m+l._d))),l._f=0,n>=0)l._f=n,g=i,h=l;else{for(-n>l._d+l._e?n=(l._d+l._e)/2:n/=-2,f-=n,d>=f&&f+l.a()>d&&(f+=n,n=f+l.a()-d,f-=n);null!=g&&n>h._f;h=this.i0(g.d().a3()))if(n-=h._f,h._f=0,g=g.b(),null==g){h=null;break}null!=g?h._f-=n:f+=n}f+=l.a()}if(d>=f){for(var o=0,p=(360-c)/2,q=a.ap();q.i1();q.i2()){var r=q.i8(),s=r.a3(),t=this._ks.i3(r),u=this.i0(s),v=p+u._f+u._e;o<Math.abs(v-t)&&(o=Math.abs(v-t)),p+=u.a()}if(o<=this._kp)break}for(var w=a.aw();w.i1();w.i2()){var x=w.i9();this.i0(x)._g*=1+b}}},ib:function(a){return this.u(a)?0===a.ak()?this.ic():this.ia():Xe.superClass.ib.call(this,a)},u:function(a){return this._kq&&0!==a.ao()?null!=this._ks.i1(a.ag()):!1}});var Ye=function(a){this._a=a};Hb.ext(Ye,Object,{i1:function(a){return this._a.i1(a)},i2:function(a){throw"Error"},i3:function(a){throw"Error"},i4:function(a){throw"Error"}});var Ze=function(){};Hb.ext(Ze,Object,{w1:function(a){this._bb=a},w2:function(){return this._bb},w4:function(a){null!=this._bb&&this._bb.i2(a)},w3:function(a){return null!=this._bb?this._bb.i1(a):!0}});var $e=function(){this._cg=45,this._ce=400,this._ch=400,this._cf=0};Hb.ext($e,Ze,{i1:function(a){if(null!=this.w2()){for(var b=!0,c=a.xk(),d=ce.a3(a,c),e=Hf.d(d),f=Hf.d(d),g=0;d>g;g++)e[g]=new Je,f[g]=new re;for(var h=a.xf();h.i1();h.i2()){var i=h.i8();f[c.i2(i.a2())].aa(i),a.h1(i)}for(var j=a.x9();j.i1();j.i2()){var k=j.i9();e[c.i2(k)].aa(k),a.h2(j.i9())}for(var l=0;d>l;l++){for(var m=e[l].x1();m.i1();m.i2())a.h3(m.i9());for(var n=f[l].c1();n.i1();n.i2())a.u1(n.i8());b=this.w3(a);for(var o=f[l].c1();o.i1();o.i2())a.h1(o.i8());for(var p=e[l].x1();p.i1();p.i2())a.h2(p.i9());if(!b)break}for(var q=0;d>q;q++)for(var r=e[q].x1();r.i1();r.i2())a.h3(r.i9());for(var s=0;d>s;s++)for(var t=f[s].c1();t.i1();t.i2())a.u1(t.i8());return a.xi(c),b}return!0},i2:function(a){if(!a.xb()){for(var b=a.xk(),c=ce.a3(a,b),d=Hf.d(c),e=Hf.d(c),f=Hf.d(c),g=Hf.d(c),h=0;c>h;h++)d[h]=new Je,e[h]=new re;for(var i=a.xf();i.i1();i.i2()){var j=i.i8();e[b.i2(j.a2())].aa(j),a.h1(j)}for(var k=a.x9();k.i1();k.i2()){var l=k.i9();d[b.i2(l)].aa(l),a.h2(k.i9())}for(var m=0;c>m;m++){for(var n=d[m].x1();n.i1();n.i2())a.h3(n.i9());for(var o=e[m].c1();o.i1();o.i2())a.u1(o.i8());this.w4(a);var p=a.g3();f[m]=new Vd(p.x,p.y,p.width,p.height);var q={};if(g[m]=q,this._cf>0){var r=this._cg+Math.ceil((p.width+1)/this._cf)*this._cf,s=this._cg+Math.ceil((p.height+1)/this._cf)*this._cf;q.x=p.x,q.y=p.y,q.width=r,q.height=s}else q.x=p.x,q.y=p.y,q.width=p.width+this._cg,q.height=p.height+this._cg;for(var t=e[m].c1();t.i1();t.i2())a.h1(t.i8());for(var u=d[m].x1();u.i1();u.i2())a.h2(u.i9())}for(var v=0;c>v;v++)for(var w=d[v].x1();w.i1();w.i2())a.h3(w.i9());for(var x=0;c>x;x++)for(var y=e[x].c1();y.i1();y.i2())a.u1(y.i8());if(of.a(g,null,this._ce/this._ch),this._cf<=0)for(var z=0;z<g.length;z++)this.w5(a,d[z],e[z],new Sd(g[z].x,g[z].y),f[z]);else for(var A=0;A<g.length;A++){var B=Math.floor((g[A].x-f[A].x)/this._cf)*this._cf,C=Math.floor((g[A].y-f[A].y)/this._cf)*this._cf,D=f[A].x+B,E=f[A].y+C;this.w5(a,d[A],e[A],new Sd(D,E),f[A])}a.xi(b)}},w5:function(a,b,c,d,e){for(var f=-e.x+d.x,g=-e.y+d.y,h=b.x1();h.i1();h.i2()){var i=a.ga(h.i9());a.s4(h.i9(),new Sd(i.x+f,i.y+g))}for(var j=c.c1();j.i1();j.i2()){for(var k=j.i8(),l=new md,m=a.gp(k).c();m.i1();m.i2()){var n=m.i6();l.add(new Sd(n.x+f,n.y+g))}a.s5(k,new Xd(l))}}});var _e=function(){};Hb.ext(_e,Ze,{i1:function(a){return this.w3(a)},i2:function(a){this.w7(a),null!=this.w2()&&this.w4(a),this.w6(a)},w7:function(a){this.e(a),this.k(a),this.i(a)},e:function(a){for(var b=a.x9();b.i1();b.i2()){var c=a.g4(b.i9());a.s1(b.i9(),c)}},w6:function(a){this.l(a),this.j(a),this.f(a)},l:function(a){for(var b=a.x9();b.i1();b.i2()){var c=a.g4(b.i9());a.s1(b.i9(),c)}},j:function(a){for(var b=a.xf();b.i1();b.i2()){var c=a.g7(b.i8()),d=c.i6();c.i8(d),d=c.i7(),c.i9(d);for(var e=0;e<c.i1();e++){var f=c.i2(e);c.i3(e,f.x,f.y)}}},k:function(a){for(var b=a.xf();b.i1();b.i2()){var c=a.g7(b.i8()),d=c.i6();c.i8(d),d=c.i7(),c.i9(d);for(var e=0;e<c.i1();e++){var f=c.i2(e);c.i3(e,f.x,f.y)}}},f:function(a){null!=this._ca&&(a.x1("A",this._ca),this._ca=null,this._b6=null),null!=this._b8&&(a.x1("B",this._b8),this._b8=null,this._b9=null)},i:function(a){this._ca=a.xc("A"),null!=this._ca&&(this._b6=new Ye(this._ca),a.x1("A",this._b6)),this._b8=a.xc("B"),null!=this._b8&&(this._b9=new Ye(this._b8),a.x1("B",this._b9))}});var af=function(){this._a=new re,this._c=10};Hb.ext(af,Ze,{i2:function(a){this._b=a.xl(),this.w9(a),this.w4(a),this.c(a),this.w8(a,this._b),a.xj(this._b)},i1:function(a){if(null==this.w2())return!0;this._b=a.xl(),this.w9(a);var b=this.w3(a);return this.c(a),a.xj(this._b),b},w8:function(a,b){for(var c=a.xf();c.i1();c.i2()){var d=c.i8();if(null!=b.i1(d)){var e=b.i1(d);of.g(a,d,e,this._c)}}},w9:function(a){for(var b=a.xk(),c=a.x9();c.i1();c.i2()){for(var d=c.i9(),e=d.af();e.i1();e.i2()){var f=e.i8(),g=f.a1(d),h=b.i1(g);if(h!==f)if(null==h)b.z1(g,f);else{null==this._b.i1(h)&&this._b.i8(h,new re);var i=this._b.i1(h);i.aa(f),this._a.ac(f),a.h1(f)}}for(var j=d.af();j.i1();j.i2()){var k=j.i8(),l=k.a1(d);b.z1(l,null)}}a.xi(b)},c:function(a){for(;!this._a.ar();a.u1(this._a.c3()));}});var bf=function(a){this._a=a};Hb.ext(bf,Object,{i2:function(a){this._a.i3(a)},i1:function(a){return this._a.i4(a)}});var cf=function(){cf.superClass.constructor.call(this),this._jo=30,this._jp=new gf,this._jt=5};Hb.ext(cf,Qe,{i4:function(a){return!0},i3:function(a){this._ju=a,of.c(a);for(var b=this._jp.i1(a),c=0,d=a.x9();d.i1();d.i2())c=Math.max(c,this.e(d.i9()));c<this._jt&&(c=this._jt),this.a(b,c)},a:function(a,b){var c=a.i7(),d=2*Math.PI/c,e=0,f=Hf.a(c);a.i4();for(var g=0;c>g;)f[g]=this.e(a.i9())+this._jo,e+=f[g],g++,a.i2();var h=e/c,i=e/(2*Math.PI);b>i&&(i=b),a.i4();for(var j=0,k=0;c>k;){var l=d/h*f[k];j+=l/2;var m=Math.cos(j)*i,n=Math.sin(j)*i;j+=l/2,this._ju.s2(a.i9(),m,n),k++,a.i2()}return i},e:function(a){var b=this._ju.gj(a),c=this._ju.g9(a);return c>=b?c:b}});var df=function(){df.superClass.constructor.call(this),this._jm=new cf,this._jk=new Xe};Hb.ext(df,Qe,{i4:function(a){return!0},i3:function(a){if(!(a.x0()<2)){this._jn=a,of.c(this._jn),of.e(this._jn);var b=new mf(this._jn);b.a1(),b.h();var c=new Le(this._jn);c.a();for(var d=b.x9();d.i1();d.i2()){var e=d.i9(),f=b.c2(e);if(f.ay()>1){var g=b.d1(e);Le.h(this._jn,g.c1()),this._jm.i3(this._jn);var h=this._jn.g3();b.s7(e,h.width,h.height)}else if(1===f.ay()){var i=f.x2();b.s8(e,this._jn.gm(i)),this._jn.s2(i,0,0)}else b.s7(e,1,1);Le.i(this._jn,this._jn.xf())}c.b();var j=this.a7(b);je.a4(b,j);var k=b.xk(),l=b.xl();this.a2(b,l,k),this.a1(b,l),this.a3(b,j,l),this._jk.a(l,k),this._jk.i3(b),this.a5(b,j,k);for(var m=b.x9();m.i1();m.i2())for(var n=m.i9(),o=b.g4(n),p=b.c2(n).x1();p.i1();p.i2()){var q=p.i9();this._jn.s2(q,o.x+this._jn.g5(q),o.y+this._jn.g6(q))}}},a7:function(a){for(var b=-1,c=null,d=a.x9();d.i1();d.i2()){var e=d.i9();a.c2(e).ay()>b&&(c=e,b=a.c2(e).ay())}return c},a1:function(a,b){for(var c=function(a,c){var d=b.i3(a)-b.i3(c);return d>0?1:d>=0?0:-1},d=a.x9();d.i1();d.i2())d.i9().av(c)},a2:function(a,b,c){for(var d=Hf.a(this._jn.x0()),e=a.x9();e.i1();e.i2())for(var f=e.i9(),g=a.c2(f),h=g.x1();h.i1();h.i2()){var i=h.i9();d[i.al()]=f.al()}var j=je.a2(a);this.a4(a,j,d,b,c)},a3:function(a,b,c){if(a.c2(b).ay()>1){for(var d=0,e=0,f=0,g=b.ap();g.i1();g.i2()){var h=g.i8(),i=c.i3(h);i-d>e&&(e=i-d,f=(d+i)/2),d=i}360-d>e&&(f=(360+d)/2),this.a6(a,b,f);for(var j=b.ap();j.i1();j.i2()){var k=j.i8(),l=c.i3(k);for(l-=f;0>l;l+=360);c.i6(k,l)}b.av(function(a,b){var d=c.i3(a)-c.i3(b);return d>0?1:d>=0?0:-1})}},a4:function(a,b,c,d,e){for(var f=b.al(),g=e.i3(b),h=b.ap();h.i1();h.i2()){for(var i=h.i8(),j=a.b(i),k=0,l=0,m=0,n=0,o=j.c1();o.i1();o.i2()){var p=o.i8(),q=null,r=null;c[p.a2().al()]===f?(q=p.a2(),r=p.a3()):(q=p.a3(),r=p.a2()),m-=this._jn.g5(q),n+=this._jn.g6(q),k-=this._jn.g5(r),l+=this._jn.g6(r)}if(0!==m||0!==n){var s;for(s=180*Math.atan2(n,m)/Math.PI-g;0>s;s+=360);d.i6(i,s)}if(0!==k&&0!==l){var t=180*Math.atan2(l,k)/Math.PI;0>t&&(t+=360),e.i6(i.a3(),t)}this.a4(a,i.a3(),c,d,e)}},a5:function(a,b,c){for(var d=a.g4(b),e=b.ap();e.i1();e.i2()){var f=e.i8(),g=f.a3(),h=a.g4(g),i=h.x-d.x,j=h.y-d.y,k=180*Math.atan2(j,i)/Math.PI;if(null!=c.i1(g)){var l=c.i3(g);k+=l}this.a6(a,g,k),this.a5(a,g,c)}},a6:function(a,b,c){c=c/180*Math.PI;var d=a.c2(b);if(!(d.ay()<=1))for(var e=d.x1();e.i1();e.i2()){var f=e.i9(),g=this._jn.g5(f),h=this._jn.g6(f),i=Math.cos(c),j=Math.sin(c),k=g*i-j*h,l=g*j+i*h;this._jn.s2(f,k,l)}}});var ef=function(){this._a=(new Date).getTime()};Hb.ext(ef,Object,{b:function(){return(new Date).getTime()-this._a}});var ff={};ff._A=new Sd(0,0),ff.b=function(a,b,c){return ff.c(a.x,a.y,b.x,b.y,c.x,c.y)},ff.c=function(a,b,c,d,e,f){c-=a,d-=b,e-=a,f-=b;var g=e*d-f*c;return Math.abs(g)<1e-5?0:g>=0?0>=g?0:-1:1},ff.d=function(a,b,c){return ff.b(a,b,c)>0},ff.f=function(a,b,c){return ff.b(a,b,c)<0},ff.g=function(a,b,c){return 0===ff.b(a,b,c)},ff.h=function(a){return ff.i(a)},ff.i=function(a){var b=new qe(a.ah()),c=new qe;if(b.a2(),b.ar())return c;var d=b.at();for(c.ae(d);!b.ar()&&d.equals(b.am());b.at());if(b.ar())return c;d=b.at();for(var e=c.ae(d),f=b.ah();f.i1();f.i2()){var g=f.i6();if(!g.equals(d))if(d=g,2===c.ay()&&ff.g(c.am(),c.as(),g))e.c(g);else{var h;for(h=e;!ff.f(c.ai(h).d(),h.d(),g);h=c.ai(h));var i;for(i=e;!ff.d(c.aj(i).d(),i.d(),g);i=c.aj(i));for(;i!==c.aj(h);c.aw(c.aj(h)));e=c.an(g,h)}}return c},ff.j=function(){return ff.k(Number.MAX_VALUE)},ff.k=function(a){return Math.floor(Gb.Util.random()*a)},ff.l=function(a,b){return Gb.Util.random()*(b-a)+a};var gf=function(){};Hb.ext(gf,Object,{i1:function(a){this._b=a;var b=new re;b=ce.a6(a),b.az(ce.a7(a));for(var c=this.a1();!b.ar();a.x5(b.c3()));return c.x1()},a1:function(){if(this._b.x0()<3)return new Je(this._b.x9());for(var a=this._b.xk(),b=this._b.xk(),c=this._b.xl(),d=new Me(this._b,new Ve,0,this.a3(this._b)),e=this._b.x0(),f=new re,g=new re,h=new Le(this._b);e>3;e--){for(var i=d.g(),j=i.an();j.i1();j.i2())a.z1(j.i9(),e),b.i5(j.i9(),!1);for(var k=i.an();k.i1();k.i2())for(var l=k.i9(),m=l.ap();m.i1();m.i2()){var n=m.i8();a.i2(n.a3())===e&&(g.aa(n),b.i5(n.a2(),!0),b.i5(n.a3(),!0))}if(g.ay()<i.ad()-1){for(var o=null,p=i.an();p.i1();p.i2()){var q=p.i9();if(a.i2(q)===e&&!b.i4(q))if(null==o)o=q;else{var r=this._b.xo(o,q);c.i7(r,!0),g.aa(r),o=null}}if(null!=o)for(var s=i.an();s.i1();s.i2()){var t=s.i9();if(t!==o&&null==t.aj(o)){var u=this._b.xo(o,t);c.i7(u,!0),g.aa(u);break}}if(g.ay()<i.ad()-1){for(var v=2147483647,w=null,x=i.an();x.i1();x.i2()){var y=x.i9();y.ad()<v&&(w=y,v=y.ad())}for(var z=i.an();z.i1();z.i2()){var A=z.i9();if(null==w.aj(A)&&w!==A){var B=this._b.xo(w,A);if(c.i7(B,!0),g.aa(B),g.ay()>=i.ad()-1)break}}}}for(var C=i.an();C.i1();C.i2())d.b(C.i9());for(var D=g.c1();D.i1();D.i2()){var E=D.i8();c.i4(E)&&(d.d(E.a2()),d.d(E.a3()))}f.az(g),h.e(i)}h.b(),d.c();for(var F=f.c1();F.i1();F.i2()){var G=F.i8();null!=G._h&&(c.i4(G)?this._b.x5(G):this._b.h1(G))}var H=this.a4(this._b),I=new Je,J=H.ak(0),K=H.ak(1),L=null;L=J.a2()===K.a2()||J.a2()===K.a3()?J.a3():J.a2(),I.aa(L);for(var M=H.c1();M.i1();M.i2()){var N=M.i8();L=N.a1(L),I.aa(L)}for(var O=f.c1();O.i1();O.i2()){var P=O.i8();c.i4(P)||null!=P._h||this._b.u1(P)}return this._b.xi(b),this._b.xj(c),this._b.xi(a),this.a2(I),I},a2:function(a){if(a.ay()<this._b.x0()){for(var b=this._b.xk(),c=a._b;null!=c;c=c.a()){var d=c.d();b.z1(d,c)}var e;for(e=new Me(this._b,new We(b),0,a.ay(),new We(b));!e.e();){for(var f=e.f(),g=f.an();g.i1();g.i2()){var h=g.i9();if(null!=b.i1(h)){var i=b.i1(h),j=a.ai(i).d(),k=null;k=null!=f.aj(j)?a.ao(f,i):a.an(f,i),b.z1(f,k);break}}for(var l=f.an();l.i1();l.i2()){var m=l.i9();null==b.i1(m)&&e.d(m)}}this._b.xi(b),e.c()}},a3:function(a){for(var b=0,c=a.x9();c.i1();c.i2())b=Math.max(b,c.i9().ad());return b},a4:function(a){for(var b=[],c=0,d=a.x0();d>c;c++)b[c]=new he;var e=new fe(b);e.a6(!1),e.a8(a);for(var f=-1,g=null,h=a.x9();h.i1();h.i2()){var i=h.i9(),j=b[i.al()];j._a+j._c>f&&(f=j._a+j._c,g=i)}for(var k=new re,l=g,m=b[l.al()]._d;null!=m;m=b[l.al()]._d)k.ac(m),l=m.a1(l);l=g;for(var n=b[l.al()]._b;null!=n;n=b[l.al()]._d)k.ae(n),l=n.a1(l);return k}});var hf=function(){this._v=new se,this._x=new se,this._z=new De(3,5),this._w=new De(3,5),this._y=!1,this._u=!1,this._t={}};Hb.ext(hf,Object,{xm:function(){var a=new Ee(this);return a},xo:function(a,b){return this.xn(a,null,b,null,0,0)},xn:function(a,b,c,d,e,f){return new ye(this,a,b,c,d,e,f)},x4:function(a){this.b3(a)},b3:function(a){for(var b;null!=(b=a._o[0]);)this.x5(b);for(;null!=(b=a._o[1]);)this.x5(b);this._v.c(a),a._g=null,this._y=!0},x5:function(a){this.a11(a)},a11:function(a){if(a._h!==this)throw"Error";var b=a.a2(),c=a.a3();this.a12(a,b,c),this._x.c(a),a._h=null,this._u=!0},x7:function(a){a._p=this._v._c,a._g=this,a.ac(),a._c.length<this._z._b&&this._z.a3(a,a._c.length,this._z._b),this._v.a(a),this._y=!0},x8:function(a){if(null!=a._h)throw"Error";a._c.length<this._w._b&&this._w.a3(a,a._c.length,this._w._b),null==a._a||a._a._h!==this?this._x.a(a):this._x.b(a,a._a),a._h=this,a.a4(),this.b2(a,a.a2(),null,a.a3(),null,0,0),this._u=!0},xr:function(a,b,c){var d=a.a2(),e=a.a3();null==a._h?(a._d=b,a._e=c):(d!==b&&(d.ar(a,0,0),a._d=b,b.ab(a,null,0,0,0)),e!==c&&(e.ar(a,1,1),a._e=c,c.ab(a,null,1,1,0)))},x3:function(a){this.xr(a,a.a3(),a.a2())},h1:function(a){this.a11(a)},u1:function(a){this.x8(a)},h2:function(a){this.x4(a)},h3:function(a){this.x7(a)},xa:function(){return this._v._c},x0:function(){return this._v._c},xh:function(){return this._x._c},xg:function(){return this._x._c},xb:function(){return 0===this._v._c},xq:function(a){return a._g===this},xp:function(a){return a._h===this},xd:function(){return this._v._a},x9:function(){return new Ie(this._v)},xf:function(){return new Ie(this._x)},x2:function(a,b){var c=Hf.d(this.xh());if(null!=a&&null!=b)for(var d=this.x9();d.i1();d.i2())d.i9().at(a,1,c),d.i9().at(b,0,c);else if(null==b&&null!=a)for(var e=this.x9();e.i1();e.i2())e.i9().at(a,1,c);else if(null!=b&&null==a)for(var f=this.x9();f.i1();f.i2())f.i9().at(b,0,c)},xk:function(){return this._z.b(this._v)},xl:function(){return this._w.c(this._x)},xi:function(a){this._z.a5(a,this._v)},xj:function(a){this._w.a6(a,this._x)},xc:function(a){return this._t[a]},x1:function(a,b){this._t[a]=b},x6:function(a){delete this._t[a]},b2:function(a,b,c,d,e,f,g){b.ab(a,c,0,0,f),d.ab(a,e,1,1,g)},a12:function(a,b,c){b.ar(a,0,0),c.ar(a,1,1)},c:function(){for(var a=0,b=this.x9();b.i1();b.i2())b.i9()._p=a++;this._y=!1},b1:function(){for(var a=0,b=this.xf();b.i1();b.i2())b.i8()._g=a++;this._u=!1},xs:function(a){a.as(this,this._z._b),a._p=this._v._c,this._v.a(a)},xt:function(a,b,c,d,e,f,g){a.a6(this,b,d,this._w._b),a._g=this._x._c,this._x.a(a),this.b2(a,a.a2(),c,a.a3(),e,f,g)}});var jf=function(){jf.superClass.constructor.call(this)};Hb.ext(jf,hf,{gb:function(a){return this.g1(a)},g7:function(a){return this.g2(a)},g5:function(a){var b=this.g1(a);return b.i1()+b.i3()/2},g6:function(a){var b=this.g1(a);return b.i2()+b.i4()/2},g4:function(a){return new Sd(this.g5(a),this.g6(a))},gi:function(a){return this.g1(a).i1()},gh:function(a){return this.g1(a).i2()},ga:function(a){var b=this.g1(a);return new Sd(b.i1(),b.i2())},gj:function(a){return this.g1(a).i3()},g9:function(a){return this.g1(a).i4()},gm:function(a){return new Td(this.gj(a),this.g9(a))},s1:function(a,b){this.s2(a,b.x,b.y)},s2:function(a,b,c){var d=this.g1(a);d.i5(b-d.i3()/2,c-d.i4()/2)},s7:function(a,b,c){this.g1(a).i6(b,c)},s8:function(a,b){this.s7(a,b.width,b.height)},s3:function(a,b,c){this.g1(a).i5(b,c)},s4:function(a,b){this.s3(a,b.x,b.y)},gp:function(a){for(var b=this.g2(a),c=new md,d=0;d<b.i1();d++)c.add(b.i2(d));return new Xd(c)},gf:function(a){for(var b=this.g2(a),c=new qe,d=0;d<b.i1();d++)c.aa(b.i2(d));return c},gc:function(a){var b=new md;b.add(this.gs(a));for(var c=this.gp(a).d();c.i1();c.i2())b.add(c.i6());return b.add(this.gl(a)),new Xd(b)},gd:function(a){var b=new qe;b.aa(this.gs(a));for(var c=this.gp(a).d();c.i1();c.i2())b.aa(c.i6());return b.aa(this.gl(a)),b},m1:function(a,b){var c=this.g2(a);c.i5();var d=b.ah(),e=d.i6();this.gx(a,e);var f=b.as();for(d.i2();d.i6()!==f;d.i2()){var g=d.i6();c.i4(g.x,g.y)}this.gy(a,f)},s5:function(a,b){var c=this.g2(a);c.i5();for(var d=b.d();d.i1();d.i2()){var e=d.i6();c.i4(e.x,e.y)}},s6:function(a,b){var c=this.g2(a);c.i5();for(var d=b.ah();d.i1();d.i2()){var e=d.i6();c.i4(e.x,e.y)}},m2:function(a,b,c){this.gx(a,b),this.gy(a,c)},gn:function(a){return this.g2(a).i6()},gk:function(a){return this.g2(a).i7()},gt:function(a,b){this.g2(a).i8(b)},gz:function(a,b){this.g2(a).i9(b)},gs:function(a){var b=this.g2(a).i6();if(null==b)return this.g4(a.a2());var c=new Sd(this.g5(a.a2())+b.x,this.g6(a.a2())+b.y);return c},gl:function(a){var b=this.g2(a).i7();if(null==b)return this.g4(a.a3());var c=new Sd(this.g5(a.a3())+b.x,this.g6(a.a3())+b.y);return c},gx:function(a,b){var c=new Sd(b.x-this.g5(a.a2()),b.y-this.g6(a.a2()));this.g2(a).i8(c)},gy:function(a,b){var c=new Sd(b.x-this.g5(a.a3()),b.y-this.g6(a.a3()));this.g2(a).i9(c)},g8:function(){for(var a=new re,b=this.xf();b.i1();b.i2())a.aa(b.i8());return a},g3:function(){for(var a,b,c=a=Number.MAX_VALUE,d=b=Number.MIN_VALUE,e=this.x9();e.i1();e.i2()){var f=this.ga(e.i9()),g=this.gm(e.i9());c=Math.min(f.x,c),a=Math.min(f.y,a),d=Math.max(f.x+g.width,d),b=Math.max(f.y+g.height,b)}for(var h=this.xf();h.i1();h.i2())for(var i=this.gp(h.i8()).c();i.i1();i.i2()){var j=i.i6();c=Math.min(j.x,c),a=Math.min(j.y,a),d=Math.max(j.x,d),b=Math.max(j.y,b)}return{x:Math.floor(c),y:Math.floor(a),width:Math.floor(d-c),height:Math.floor(b-a)}}});var kf=function(){kf.superClass.constructor.call(this),this.a(new be,new _d)};Hb.ext(kf,jf,{a:function(a,b){this._a3=a,this._a4=b},xo:function(a,b){return this.l2(a,b,this._a4.a6())},l2:function(a,b,c){return this.l1(a,null,b,null,0,0,c)},xn:function(a,b,c,d,e,f){return this.l1(a,b,c,d,e,f,this._a4.a6())},l1:function(a,b,c,d,e,f,g){var h=new ye(this,a,b,c,d,e,f);return h._l=g,h},xm:function(){var a=new Ee(this);return a._r=this._a3.m3(),a},g3:function(){for(var a={x:0,y:0,width:-1,height:-1},b=this.x9();b.i1();b.i2())b.i9()._r.m1(a);return a},g1:function(a){return a._r},g2:function(a){return a._l},g5:function(a){return a._r.m4()},g6:function(a){return a._r.m5()},gi:function(a){return a._r.i1()},gh:function(a){return a._r.i2()},gj:function(a){return a._r.i3()},g9:function(a){return a._r.i4()},s2:function(a,b,c){a._r.m6(b,c)},s7:function(a,b,c){a._r.i6(b,c)},s3:function(a,b,c){a._r.i5(b,c)}});var lf=function(){lf.superClass.constructor.call(this),this._ap=this.xk(),this._as=this.xl()};Hb.ext(lf,jf,{g1:function(a){var b=this._ap.i1(a);return null==b&&(b=new Be,this._ap.z1(a,b)),b},g2:function(a){var b=this._as.i1(a);return null==b&&(b=new Ae,this._as.i8(a,b)),b}});var mf=function(a){mf.superClass.constructor.call(this),this._ay=a,this._a0=this.xk(),this._au=this.xl()};Hb.ext(mf,lf,{c2:function(a){var b=this._a0.i1(a);return b},a2:function(a,b){this._a0.z1(a,b)},h:function(){null==this._az&&(this._az=this.xk());for(var a=Hf.a(this._ay.x0()+1),b=1,c=this.x9();c.i1();){for(var d=this.c2(c.i9()),e=d.x1();e.i1();e.i2()){var f=e.i9();a[f.al()]=b}for(var g=new re,h=d.x1();h.i1();h.i2())for(var i=h.i9(),j=a[i.al()],k=i.ap();k.i1();k.i2()){var l=k.i8(),m=l.a3(),n=a[m.al()];n===j&&g.ac(l)}this._az.z1(c.i9(),g),c.i2(),b++}},d1:function(a){return this._az.i1(a)},b:function(a){return this._au.i1(a)},a3:function(a,b){this._au.i8(a,b)},a1:function(){var a=this._ay.xk(),b=Ne.a4(Hf.a(this._ay.xh())),c=ce.a1(this._ay,b,a),d=ce.a5(this._ay,b,c);this.d2(a,d),this._ay.xi(a)},c1:function(a){for(var b=null,c=-1,d=0,e=a.length;e>d;d++){var f=a[d];f.ay()>c&&(b=f,c=f.ay())}return b},d2:function(a,b){for(var c=this._ay.xl(),d=this._ay.xk(),e=b.length,f=0;e>f;f++)for(var g=b[f],h=g.c1();h.i1();h.i2())c.i8(h.i8(),g);var i=this.c1(b);this.a4(i,a,c,new md,d);var j={};e=b.length;for(var k=0;e>k;k++){var l=b[k];if(l.ay()>1){var m=this.xm();j[l._id]=m}}for(var n=this._ay.x9();n.i1();n.i2()){var o=n.i9();if(a.i4(o)&&null==d.i1(o)){var p=this.xm();j[o._id]=p;var q=new Je;q.aa(o),this.a2(p,q)}}var r=Hf.d(2);e=b.length;for(var s=0;e>s;s++){
var t=b[s];if(1===t.ay()){var u=t.c2();r[0]=u.a2(),r[1]=u.a3();for(var v=0;2>v;v++){var w=r[v];if(1===w.ad()){var x=this.xm();j[w._id]=x;var y=new Je;y.aa(w),this.a2(x,y)}}}}for(var z=this._ay.x9();z.i1();z.i2()){var A=z.i9();if(null!=d.i1(A))for(var B=d.i1(A),C=j[B._id],D=A.af();D.i1();D.i2()){var E=D.i8();if(c.i1(E)!==B){var F=j[c.i1(E)._id];if(null==F){var G=E.a1(A),H=d.i1(G);F=null!=H?j[H._id]:j[G._id]}var I=C.aj(F),J=null;null==I?(I=this.xo(C,F),J=new re):J=this.b(I),J.aa(E),this.a3(I,J)}}else if(a.i4(A))for(var K=j[A._id],L=A.af();L.i1();L.i2()){var M=L.i8(),N=M.a1(A),O=j[N._id];if(null!=O){var P=K.aj(O);if(null==P){var Q=this.xo(K,O),R=new re;R.aa(M),this.a3(Q,R)}}}}if(2===this._ay.x0()&&1===this._ay.xg()){var S=this._ay.xf().i8(),T=j[S.a2()._id],U=j[S.a3()._id];if(null!=U&&null!=T&&null==U.aj(T)){var V=this.xo(T,U),W=new re;W.aa(S),this.a3(V,W)}}var X=Hf.a(this._ay.x0()),Y=1;e=b.length;for(var Z=0;e>Z;Z++){var $=b[Z],_=j[$._id];if(null!=_){var aa=this.c2(_);null==aa&&(aa=new Je,this.a2(_,aa));for(var ba=$.c1();ba.i1();ba.i2()){var ca=ba.i8(),da=ca.a2();X[da.al()]===Y||a.i4(da)&&d.i1(da)!==$||(X[da.al()]=Y,aa.aa(da)),da=ca.a3(),X[da.al()]===Y||a.i4(da)&&d.i1(da)!==$||(X[da.al()]=Y,aa.aa(da))}}}this._ay.xj(c),this._ay.xi(d)},a4:function(a,b,c,d,e){if(!d.contains(a)){d.add(a);for(var f=[],g=a.c1();g.i1();g.i2()){var h=g.i8();f[0]=h.a2(),f[1]=h.a3();for(var i=0;2>i;i++){var j=f[i];if(b.i4(j)&&null==e.i1(j)){a.ay()>1&&e.z1(j,a);for(var k=j.af();k.i1();k.i2()){var l=c.i1(k.i8());this.a4(l,b,c,d,e)}}}}}}});var nf=function(a,b,c,d,e){this._a={},nf.superClass.constructor.call(this);var f,g,h=new md;for(f=0,g=b.size();g>f;f++){var i=b.get(f);if(i instanceof Gb.Link)h.add(i);else{var j=d&&null==e&&i instanceof Nd;j&&i.setExpanded(!0);var k=a.getDimension(i);if(j&&i.setExpanded(!1),null==k)continue;var l=this.xm(),m=a._repulsion;"rightleft"===c||"leftright"===c?this.s7(l,k.height*m,k.width*m):this.s7(l,k.width*m,k.height*m),l.node=i,this._a[i.getId()]=l}}for(f=0,g=h.size();g>f;f++){var n=h.get(f),o=n.getFromAgent(),p=n.getToAgent(),q=this._a[o.getId()],r=this._a[p.getId()];null!=q&&null!=r&&q!==r&&this.xo(q,r)}};Hb.ext(nf,kf,{});var of={};of._D=new Xd,of._E=new Sd(0,0),of.b=function(a){if(a.i1()>0){for(var b=new md,c=a.i1()-1;c>=0;c--)b.add(a.i2(c));a.i5();for(var d=0,e=b.size();e>d;d++){var f=b.get(d);a.i4(f.x,f.y)}}var g=a.i6();a.i8(a.i7()),a.i9(g)},of.c=function(a){of.d(a,!0)},of.d=function(a,b){if(b)for(var c=a.xf();c.i1();c.i2()){var d=c.i8();a.gt(d,of._E),a.gz(d,of._E),a.s5(d,of._D)}else for(var e=a.xf();e.i1();e.i2())a.s5(e.i8(),of._D)},of.e=function(a){for(var b=new Sd(0,0),c=a.xf();c.i1();c.i2()){var d=c.i8();a.gt(d,b),a.gz(d,b)}},of.f=function(a,b,c,d){for(var e=a.gc(b).b(),f=Hf.d(e),g=0,h=a.gc(b).c();h.i1();h.i2()){var i=h.i6();(0>=g||!i.equals(f[g-1]))&&(f[g]=new Sd(i.x,i.y),g++)}if(e=g,!(2>e)){var j=new md,k=new Ud(f[1].x-f[0].x,f[1].y-f[0].y),l=of.i(k);l.x*=d,l.y*=d;for(var m=of.h(f[0],l),n=of.h(f[1],l),o=new Wd(m,n),p=1;e-1>p;p++){var q=o,r=of.i(new Ud(f[p+1].x-f[p].x,f[p+1].y-f[p].y));r.x*=d,r.y*=d;var s=of.h(f[p],r),t=of.h(f[p+1],r);o=new Wd(s,t);var u=Wd.a6(q,o);null!=u&&j.add(new Sd(u.x,u.y))}var v=new Ud(f[e-1].x-f[e-2].x,f[e-1].y-f[e-2].y);v=of.i(v),v.x*=d,v.y*=d;var w=of.h(f[e-1],v),x=new Xd(j);b.a2()===c.a2()?(a.s5(c,x),a.m2(c,m,w)):(a.s5(c,x.a()),a.m2(c,w,m))}},of.g=function(a,b,c,d){for(var e=d,f=c.c1();f.i1();f.i2()){var g=f.i8();of.f(a,b,g,e),0>e&&(e-=d),e=-e}},of.a=function(a,b,c){return of.j(a,b,c,1)},of.l=function(a,b,c){if(null==a||a.length<1)return null!=b&&(b.x=0,b.y=0,b.width=0,b.height=0),{width:0,height:0};for(var d=0,e=0,f=0;f<a.length;f++){var g=a[f];d=Math.max(d,g.width),e=Math.max(e,g.height)}var h,i,j=d*e*a.length,k=Math.sqrt(j/c),l=j/k,m=Math.floor(l/d),n=Math.ceil(l/d),o=Math.ceil(a.length/m),p=Math.ceil(a.length/n);n*p>m*o?(h=m,i=o):(h=n,i=p);var q,r=0,s=0,t=0,u=0;if(d>e)for(var v=0;v<a.length;v++)q=a[v],q.x=s*d,q.y=r*e,t=Math.max(t,q.x+q.width),u=Math.max(u,q.y+q.height),++s>=h&&(r++,s=0);else for(var w=0;w<a.length;w++)q=a[w],q.x=s*d,q.y=r*e,t=Math.max(t,q.x+q.width),u=Math.max(u,q.y+q.height),++r>=i&&(s++,r=0);return null!=b&&(b.x=0,b.y=0,b.width=t,b.height=u),{width:i,height:h}},of.j=function(a,b,c,d){if(null==a||a.length<1)return null!=b&&(b.x=0,b.y=0,b.width=0,b.height=0),0;for(var e,f,g=e=a[0].width,h=f=a[0].height,i=a.length,j=1;i>j;j++){var k=a[j].width;g=Math.min(g,k),e=Math.max(e,k);var l=a[j].height;h=Math.min(h,l),f=Math.max(f,l)}if(h/f>.95&&g/e>.95)return of.l(a,b,c).width;for(var m=new qe,n=0,o=0;i>o;o++){var p=a[o];m.aa(a[o]),n=Math.floor(n+p.width*p.height)}m.a1(function(a,b){var c=Math.floor(b.height)-Math.floor(a.height);return 0===c?Math.floor(b.width)-Math.floor(a.width):c});var q=0,r=0,s=Math.floor(c*Math.sqrt(n/c)),t=s,u=0,v=new qe;do{var w=new qe;v.aa(w);for(var x,y,z=x=y=0,A=m.ah();A.i1();A.i2()){var B=A.i6();z+B.width>t&&w.ay()>0?(y=Math.max(y,z),w=new qe,w.aa(B),v.aa(w),z=Math.floor(B.width)):(w.aa(B),z=Math.floor(z+B.width)),1===w.ay()&&(x=Math.floor(x+w.am().height))}y=Math.max(y,z),c*x>y&&u!==y&&(v.af(),t=Math.floor(1.1*t),u=y)}while(v.ar());for(var C=0,D=v.ah();D.i1();D.i2()){for(var E=0,F=D.i6(),G=F.ah();G.i1();G.i2()){var H=G.i6();H.x=E,H.y=C,E+=H.width}q=Math.max(q,E),C+=of.k(F),r=Math.max(r,C)}return null!=b&&(b.x=0,b.y=0,b.width=q,b.height=r),v.ay()},of.k=function(a){for(var b=0,c=a.ah();c.i1();c.i2())b=Math.max(c.i6().height,b);return b},of.h=function(a,b){return new Sd(a.x+b.x,a.y+b.y)},of.i=function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y);return new Ud(-a.y/b,a.x/b)};var pf=function(a){this._a=a,this._b=!1};Hb.ext(pf,Object,{a:function(){return this._b},b:function(){return this._a},c:function(){return 1===this._a},d:function(){return 2===this._a},e:function(){return 4===this._a},f:function(){return 8===this._a},g:function(){return 0===this._a}}),pf.h=function(a,b){var c=a.xc("A");return null==c?null:c.i1(b)},pf.i=function(a,b){var c=a.xc("B");return null==c?null:c.i1(b)},pf.j=function(a){switch(a){case 1:return pf.k;case 2:return pf.l}return null},pf.k=new pf(1),pf.l=new pf(2);var qf=function(a,b,c,d,e){this._o=0,this._l=0,this._i=0,this._d=0,this._f=0,this._b=a,this._a=1e-4,this._r=b,this._p=1,this._e=(e.gj(a)+e.g9(a))/4;var f=.45*c*Math.sqrt(d);this._k=ff.l(-f,f),this._h=ff.l(-f,f),this._g=ff.l(-f,f)};Hb.ext(qf,Object,{});var rf=function(){this._a=0,this._c=0,this._b=0};Hb.ext(rf,Object,{});var sf=function(){sf.superClass.constructor.call(this),this._dj=0,this._dh=0,this._dq=0,this._dp=0,this._dt=0,this._de=0,this._d3=0,this._dr=0,this._ed=0,this._dw=.65,this._ea=1,this._dl=80,this._dx=3,this._d8=!0,this._eb=3e5,this._ee=2,this._di=2,this._df=1e3};Hb.ext(sf,Qe,{i4:function(a){return!0},i3:function(a){if(null!=a&&(this._d5=a,this.s(a))){var b=new rf,c=0,d=Math.floor(this._dx*this._dz.length*this._dz.length+20*this._dz.length);d=Math.max(d,1e4);var e=this._ea*this._ea*this._dz.length,f=this._df;try{for(;this._dj>e&&d>c;c++){var g=this.b(2147483647&c);0===f--&&(this._dy.b()>this._eb&&(c=d),f=this._df),this.h(g,b),this.d(g,b),this.i(g,b),this._d8?(this.g(g,b),this.j(g,b)):(this.f(g,b),this.c(g,b));var h=Math.sqrt(b._a*b._a+b._c*b._c+b._b*b._b);this.ac(g,b,h),this.aa(g,b,h)}}catch(i){}finally{this.r()}}},s:function(a){if(null==a||a.xa()<1)return!1;this._d5=a,this._dp=1,this._dy=new ef,this._dt=a.x0(),this._d2=Hf.d(this._dt),this._df=1+1e5/this._dt,this._ed=1/(2*this._di),this._de=this._ed*this._ee/(.05*this._dl),this._d3=Math.pow(this._dl,-1)*this._ed,this._dr=Math.pow(this._dl,3)*this._ed,this._dj=0,this._du=new rf,this._dq=Math.max(20*this._dl,10);var b=Math.max(.1,Math.min(this._dw*this._dl,this._dq)),c=this._dt;of.c(a),this._dz=Hf.d(c);for(var d=a.x9();d.i1();d.i2()){var e=d.i9(),f=new qf(e,b,this._dl,this._dt,a);this._dz[--c]=f,this._dj+=f._r,this._dh+=f._r*f._r,this._du._a+=f._k,this._du._c+=f._h,this._du._b+=f._g,this._d2[e.al()]=f}return this._d8=!1,this._dz.length>0},b:function(a){var b=this._dz.length,c=b-a%b-1,d=ff.k(c+1),e=this._dz[d];return this._dz[d]=this._dz[c],this._dz[c]=e,e},f:function(a,b){for(var c,d,e=c=d=0,f=a._b.ae();null!=f;f=f.a7()){var g,h=this._d2[f.a2().al()],i=h._k-a._k,j=h._h-a._h,k=h._g-a._g,l=i*i+j*j+k*k,m=Math.sqrt(l),n=m-(h._e+a._e);0>=n||(g=n*n*this._d3/m,e+=i*g,c+=j*g,d+=k*g)}for(var o=a._b.ag();null!=o;o=o.a8()){var p,q=this._d2[o.a3().al()],r=q._k-a._k,s=q._h-a._h,t=q._g-a._g,u=r*r+s*s+t*t,v=Math.sqrt(u),w=v-(q._e+a._e);0>=w||(p=w*w*this._d3/v,e+=r*p,c+=s*p,d+=t*p)}b._a+=e,b._c+=c,b._b+=d},g:function(a,b){var c,d,e=c=d=0;this._dp++,a._f=this._dp;for(var f=a._b.ae();null!=f;f=f.a7()){var g=this._d2[f.a2().al()];g._f=this._dp;var h=g._k-a._k,i=g._h-a._h,j=g._g-a._g,k=h*h+i*i+j*j,l=Math.sqrt(k);if(0!==l){var m=Math.max(1e-6,l-(a._e+g._e)),n=-this._ef[f.a5()]/(m*m);n+=m*m*this._d1[f.a5()],n/=l,e+=h*n,c+=i*n,d+=j*n}}for(var o=a._b.ag();null!=o;o=o.a8()){var p=this._d2[o.a3().al()];p._f=this._dp;var q=p._k-a._k,r=p._h-a._h,s=p._g-a._g,t=q*q+r*r+s*s,u=Math.sqrt(t);if(0!==u){var v=Math.max(1e-6,u-(a._e+p._e)),w=-this._ef[o.a5()]/(v*v);w+=v*v*this._d1[o.a5()],w/=u,e+=q*w,c+=r*w,d+=s*w}}b._a+=e,b._c+=c,b._b+=d},j:function(a,b){for(var c,d,e=c=d=0,f=this._dt-1;f>=0;f--){var g=this._d2[f];if(g._f!==a._f){var h=a._k-g._k,i=a._h-g._h,j=a._g-g._g,k=h*h+i*i+j*j;if(0!==k){var l=Math.sqrt(k),m=Math.max(1e-6,l-(a._e+g._e)),n=this._dr/(m*m*l);e+=h*n,c+=i*n,d+=j*n}}}b._a+=e,b._c+=c,b._b+=d},c:function(a,b){for(var c,d,e=c=d=0,f=this._dt-1;f>=0;f--){var g=this._d2[f],h=a._k-g._k,i=a._h-g._h,j=a._g-g._g,k=h*h+i*i+j*j;if(0!==k){var l,m=Math.sqrt(k),n=m-(a._e+g._e);l=0>=n?this._dr/(1e-8*m):this._dr/(n*n*m),e+=h*l,c+=i*l,d+=j*l}}b._a+=e,b._c+=c,b._b+=d},i:function(a,b){var c=this._du._b/this._dt-a._g;b._b+=c*this._dl*this._dt/this._dh},d:function(a,b){if(0!==this._de){var c=this._du._a/this._dt-a._k,d=this._du._c/this._dt-a._h,e=this._du._b/this._dt-a._g;b._a+=c*this._de,b._c+=d*this._de,b._b+=e*this._de}},h:function(a,b){var c=.05*(a._r+2);c>0&&(b._a=ff.l(-c,c),b._c=ff.l(-c,c),b._b=ff.l(-c,c))},ac:function(a,b,c){if(0!==c&&0!==a._a){var d=b._a*a._o+b._c*a._l+b._b*a._i,e=d/(c*a._a);this._dh-=a._r*a._r,this._dj-=a._r,a._r+=a._p*e>0?.45*e:.15*e,a._r>this._dq?a._r=this._dq:a._r<.1&&(a._r=.1),this._dj+=a._r,this._dh+=a._r*a._r,a._p=e}},aa:function(a,b,c){if(c>0){var d=a._r/c,e=b._a*d,f=b._c*d,g=b._b*d;a._k+=e,a._h+=f,a._g+=g,this._du._a+=e,this._du._c+=f,this._du._b+=g,a._a=c,a._o=b._a,a._l=b._c,a._i=b._b}},r:function(){for(var a=this._d2.length-1;a>=0;a--){var b=this._d2[a];this._d5.s2(b._b,b._k,b._h)}}});var tf=function(a,b,c,d){this._e=a,this._f=b,this._a=c,this._b=d,this._c={}};Hb.ext(tf,Object,{resetGroup:function(){if(this._a&&null==this._b)for(var a in this._c){var b=this._c[a];b.group.setExpanded(this._e.isExpandGroup()?!0:b.b)}},process:function(){for(var a=new md,b=0,c=this._f.size();c>b;b++){var d=this._f.get(b);if(d instanceof Gb.Link)d.isLooped()||a.add(d);else{if(null==this._b&&d.getParent()instanceof Nd)continue;(null==this._b||null!=this._b&&this._b!==d)&&a.add(d),null==this._b&&d instanceof Nd&&this.layoutGroup(d)}}return a},layoutGroup:function(a){if(this._a&&null==this._c[a.getId()]&&null==this._b){this._c[a.getId()]={group:a,b:a.isExpanded()};var b=this._e.getGroupLayoutType(a);if(b){a.setExpanded(!0);for(var c,d=new md,e=a.getChildren(),f=0,g=e.size();g>f;f++)if(c=e.get(f),c instanceof Nd&&(this.layoutGroup(c),c.setExpanded(!1)),c instanceof Gb.Link||d.contains(c)||d.add(c),c instanceof Ld){var h=c.getLinks();if(null!=h)for(var i=0,j=h.size();j>i;i++){var k=h.get(i);d.contains(k)||d.add(k)}}var l=new nf(this._e,d,b,this._a,this._b);try{var m=null;if("round"===b?m=new df:"symmetry"===b?m=new sf:"hierarchic"===b?m=new Cf:("topbottom"===b||"bottomtop"===b||"rightleft"===b||"leftright"===b)&&(m=new Re),null!=m){m.i2(l);var n=tf.createMatrix(b),o={},p={};for(var q in l._a){var r=l._a[q],s=r.node,t=l.g4(r);if(o[q]=s.getCenterLocation(),null!=n){var u=n.transform(t);s.setCenterLocation(u.x,u.y)}else s.setCenterLocation(t.x,t.y);p[q]=s.getCenterLocation()}}}catch(v){}for(e=a.getChildren(),f=0,g=e.size();g>f;f++)c=e.get(f),c instanceof Nd&&c.setExpanded(!0)}}}}),tf.createMatrix=function(a){return"rightleft"===a?Rb.createMatrix(Math.PI/2,0,0):"leftright"===a?Rb.createMatrix(-Math.PI/2,0,0):"bottomtop"===a?Rb.createMatrix(Math.PI,0,0):null};var uf=function(){};Hb.ext(uf,Object,{i1:function(a,b,c){var d=this.a1(a,b);return this.a2(a,b,c),d},a1:function(a,b){var c=uf.i4(a);c.ax();for(var d=0,e=c.x1();e.i1();e.i2())b.i7(e.i9(),-1);for(var f=c.x1();f.i1();f.i2()){for(var g=f.i9(),h=-1,i=g.aq();i.i1();i.i2())h=Math.max(h,b.i2(i.i9()));b.i7(g,h+1),d=Math.max(d,h+1)}return d+1},a2:function(a,b,c){c.az(uf.i3(a,b))}}),uf.i3=function(a,b){for(var c=new re,d=a.xf();d.i1();d.i2()){var e=d.i8();b.i2(e.a2())>b.i2(e.a3())&&(a.x3(e),c.ac(e))}return c},uf.i4=function(a){var b=Hf.a(a.xa());return(new ie).a1(a,b),uf.i2(a,b)},uf.i2=function(a,b){for(var c=Hf.d(a.x0()),d=a.x9();d.i1();d.i2()){var e=d.i9(),f=e.al();c[b[f]]=e}return new Je(c)};var vf=function(){vf.superClass.constructor.call(this),this.c0()};Hb.ext(vf,re,{c0:function(){this._bc=1,this._bd=0}});var wf=function(){this._m1=20,this._m2=60,this._m3=5,this._m4=0};Hb.ext(wf,Object,{i4:function(a){this._m3=a},i5:function(a){this._m4=a},i3:function(a){this._m1=a},i6:function(a){this._m2=a},i2:function(a){this._m5=a},t1:function(){return this._m2},a1:function(a,b){for(var c=Hf.d(b.length),d=0;d<b.length;d++)c[d]=b[d].x1();this.a2(a,c)},a2:function(a,b){for(var c=Hf.a(b.length),d=0,e=0;e<b.length;e++){var f=0,g=b[e];for(g.i4();g.i1();g.i2())f=Math.max(f,a.g9(g.i9()));for(c[e]=f,g.i4();g.i1();g.i2()){var h=(c[e]-a.g9(g.i9()))/2;a.s4(g.i9(),new Sd(a.gi(g.i9()),d+h))}var i=this.t1();d+=c[e]+i,g.i4()}},i1:function(a,b,c){this._m6=a,this.t2(b,c)}});var xf=function(a,b){xf.superClass.constructor.call(this)};Hb.ext(xf,wf,{t2:function(a,b){var c=this._m6;this._a=c.xc("D"),this._h=c.xc("C"),this.a1(c,a),this.tg(c,a),this.tf(a,Ne.a5(this._e),this._m5,this._l),this.tb(c,this._f[0]),this.ta(a),this.th(c,this._f[0],a),this.b(a),this.tb(c,this._f[1]),this.ta(a),this.th(c,this._f[1],a),this.b(a),this.a11(this._f[1]),this.a12(a),this.tb(c,this._f[2]),this.ta(a),this.th(c,this._f[2],a),this.b(a),this.tb(c,this._f[3]),this.ta(a),this.th(c,this._f[3],a),this.b(a),this.a11(this._f[3]),this.a12(a),this.tc(c),this.tj()},a11:function(a){for(var b=0;b<a.length;b++)a[b]=-a[b]},b:function(a){for(var b=0;b<a.length;b++){var c=a[b];c.ax()}for(var d=0;d<a.length;d++)for(var e=0,f=null,g=a[d].x1();g.i1();g.i2()){var h=g.i9(),i=h.al();this._l[i]=e++,this._b[i]=f,this._k[i]=null,null!=f&&(this._k[f.al()]=h),f=h}var j=this._a;this._a=this._h,this._h=j;for(var k=this._m6.xf();k.i1();k.i2()){var l=k.i8(),m=this._m6.gn(l);this._m6.gt(l,new Sd(-m.x,m.y));var n=this._m6.gk(l);this._m6.gz(l,new Sd(-n.x,n.y))}var o=this._l,p=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:o[a.a2().al()]-o[b.a2().al()]},q=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:o[a.a3().al()]-o[b.a3().al()]};this._m6.x2(p,q)},a12:function(a){for(var b=this._m6.xf();b.i1();b.i2()){var c=b.i8();this._m6.x3(c);var d=this._m6.gn(c),e=this._m6.gk(c);this._m6.gz(c,d),this._m6.gt(c,e)}for(var f=new qe,g=0;g<a.length;g++)f.ae(a[g]);for(var h=0;h<a.length;h++)a[h]=f.au();var i=this._l,j=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:i[a.a2().al()]-i[b.a2().al()]},k=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:i[a.a3().al()]-i[b.a3().al()]};this._m6.x2(j,k)},tg:function(a,b){var c=a.x0(),d=a.xg();this._l=Hf.a(c),this._b=Hf.d(c),this._k=Hf.d(c),this._m=Hf.d(c),this._i=Hf.d(c),this._o=Hf.d(c),this._f=Hf.e(4,c),this._c=Hf.a(c),this._g=Hf.a(c),this._j=Hf.a(c),this._d=Hf.b(c),this._e=Hf.b(d);for(var e=0;e<b.length;e++)for(var f=0,g=null,h=b[e].x1();h.i1();h.i2()){var i=h.i9(),j=i.al();this._l[j]=f++,this._b[j]=g,this._k[j]=null,null!=g&&(this._k[g.al()]=i),g=i}var k=this._l,l=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:k[a.a2().al()]-k[b.a2().al()]},m=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:k[a.a3().al()]-k[b.a3().al()]};a.x2(l,m)},tb:function(a,b){for(var c=a.x9();c.i1();c.i2()){var d=c.i9(),e=d.al();this._m[e]=d,this._i[e]=d,b[e]=Number.MAX_VALUE,this._o[e]=d,this._c[e]=Number.MAX_VALUE,this._d[e]=!1,this._j[e]=this._g[e]=0}},ta:function(a){for(var b=1;b<a.length;b++)for(var c=-1,d=a[b]._b;null!=d;d=d.a()){var e=d.d(),f=e.al(),g=e.ak();if(0!==g){var h,i=Math.floor((g+1)/2),j=Math.ceil((g+1)/2),k=1;for(h=e.ae();i>k;h=h.a7())k++;for(var l=!1;j>=k&&!l;k++){var m=this._m6.g2(h),n=h.a2(),o=n.al();this._i[f]===e&&!this._e[h.a5()]&&c<this._l[o]&&(c=this._l[o],this._i[o]=e,this._m[f]=this._m[o],this._i[f]=this._m[f],l=!0,this._j[o]=m.i6().x,this._g[f]=m.i7().x),h=h.a7()}}}},th:function(a,b,c){for(var d=a.x9();d.i1();d.i2()){var e=d.i9(),f=e.al();this._m[f]===e&&this.td(a,e,b)}for(var g=0;g<c.length;g++){var h=c[g].x1();if(h.i1()){var i=c[g].x1().i9(),j=i.al();this._o[this._m[j].al()]===i&&this.tk(a,i,b)}}for(var k=a.x9();k.i1();k.i2()){var l=k.i9(),m=l.al(),n=this._c[this._o[this._m[m].al()].al()];n<Number.MAX_VALUE&&(b[m]+=n)}},td:function(a,b,c){var d=b.al();if(c[d]===Number.MAX_VALUE){c[d]=0;var e=b,f=0;do{var g=e.al();if(g!==d&&(f-=this._g[g]),this._l[g]>0){var h=this._b[g],i=this._m[this._b[g].al()],j=i.al();this.td(a,i,c),this._o[d]===b&&(this._o[d]=this._o[j]),this._o[d]===this._o[j]&&(c[d]=Math.max(c[d],c[h.al()]+this.ti(a,h,e)-f))}f+=this._j[g],e=this._i[g]}while(e!==b);f=0,e=b;do{var k=e.al();k!==d&&(f-=this._g[k]),c[k]=c[d]+f,f+=this._j[k],e=this._i[k]}while(e!==b)}},tk:function(a,b,c){var d=b.al();if(!this._d[d]){this._d[d]=!0;var e=b;do{var f=e.al(),g=this._k[f];if(null!=g){var h=g.al(),i=this._o[this._m[h].al()];if(i!==this._o[d]){var j=c[h]-c[d]-this.ti(a,e,g);this._c[i.al()]!==Number.MAX_VALUE&&(j+=this._c[i.al()]),this._c[this._o[d].al()]=Math.min(this._c[this._o[d].al()],j)}else this.tk(a,this._m[h],c)}e=this._i[f]}while(e!==b)}},tc:function(a){for(var b=Hf.a(4),c=Hf.a(4),d=a.x9();d.i1();d.i2()){var e=d.i9(),f=e.al();c[0]+=this._f[0][f],c[1]+=this._f[1][f],c[2]+=this._f[2][f],c[3]+=this._f[3][f]}c[0]/=a.xa(),c[1]/=a.xa(),c[2]/=a.xa(),c[3]/=a.xa();for(var g=a.x9();g.i1();g.i2()){var h=g.i9(),i=h.al(),j=a.g4(h);b[0]=this._f[0][i]-c[0],b[1]=this._f[1][i]-c[1],b[2]=this._f[2][i]-c[2],b[3]=this._f[3][i]-c[3],b.sort(Hf.n);var k=(b[1]+b[2])/2;a.s1(h,new Sd(k,j.y))}},ti:function(a,b,c){var d,e=a.gj(b),f=a.gj(c);return d=e>1&&f>1?this._m1+(e+f)/2:this._m3+(e+f)/2,this._l[b.al()]<this._l[c.al()]?(null!=this._a&&(d+=this._a.i3(c)),null!=this._h&&(d+=this._h.i3(b))):(null!=this._a&&(d+=this._a.i3(b)),null!=this._h&&(d+=this._h.i3(c))),d},tj:function(){this._l=null,this._b=null,this._k=null,this._e=null,this._m=null,this._i=null,this._f=null,this._c=null,this._o=null,this._d=null,this._j=null,this._g=null},tf:function(a,b,c,d){for(var e=a.length,f=2;e-1>f;f++)for(var g=-1,h=0,i=0,j=a[f].x1(),k=a[f].x1();k.i1();k.i2()){var l=k.i9(),m=null,n=!1;if(1===l.ak()&&(m=l.ae().a2(),null!=c.i1(m)&&null!=c.i1(l)&&(n=!0)),i===a[f].ay()-1||n){for(var o=n?d[m.al()]:a[f-1].ay();i>=h;h++){for(var p=j.i9(),q=p.am();q.i1();q.i2()){var r=q.i8(),s=d[r.a2().al()];(g>s||s>o)&&b.i7(q.i8(),!0)}j.i2()}g=o}i++}}});var yf=function(a,b){this._b=20,this._a=b,this._d=a,this._f={}};Hb.ext(yf,Object,{a3:function(a){this._b=a},a4:function(a,b,c,d,e){if(this.a2(a)){var f=this.b2(a);f._o=b,f._m=e,f._n=d,f._f=c}},b2:function(a){var b=this._f[a._id];return null==b&&(b=new zf,this._f[a._id]=b),b},a2:function(a){return null!=this._f[a._id]},c:function(){for(var a=Ne.a1(Hf.a(this._d.xa())),b=Ne.a1(Hf.a(this._d.xa())),c=this._d.x9();c.i1();c.i2()){var d=c.i9();if(this.a2(d)){var e=this.b2(d);a.i6(d,this._b*(e.c()-1)),b.i6(d,this._b*(e.b()-1))}}this._d.x1("D",a),this._d.x1("C",b)},g:function(){this._d.x6("D"),this._d.x6("C")},f:function(){for(var a=this._d.x9();a.i1();a.i2()){var b=a.i9();if(this.a2(b)){var c=this._d.gi(b),d=this._d.gh(b),e=this._d.gj(b),f=this._d.g9(b),g=this.b2(b),h=g._q.ay()+g._b.ay()+g._f,i=g._d.ay()+g._g.ay()+g._o,j=g._i.ay()+g._l.ay()+g._n,k=g._h.ay()+g._k.ay()+g._m,l=this._a.a7(e,h),m=this._a.a7(e,i),n=this._a.a7(f,k),o=this._a.a7(f,j);g.a2(this._a.a8(e,h,l),this._a.a8(e,i,m),this._a.a8(f,k,n),this._a.a8(f,j,o));for(var p=g._j.c1();p.i1();p.i2()){var q=p.i8(),r=this.a1(q),s=this.b1(q),t=new qe;r.b()===s.b()?(r.c()?(t.aa(new Sd(c+g._g._bd*m+g._c,d)),t.aa(new Sd(c+g._g._bd*m+g._c,d-this._b)),g._g._bd++,t.aa(new Sd(c+g._g._bd*m+g._c,d-this._b)),t.aa(new Sd(c+g._g._bd*m+g._c,d)),g._g._bd++,g._g._bc=Math.max(g._g._bc,2)):r.d()?(t.aa(new Sd(c+g._b._bd*l+g._p,d+f)),t.aa(new Sd(c+g._b._bd*l+g._p,d+f+this._b)),g._b._bd++,t.aa(new Sd(c+g._b._bd*l+g._p,d+f+this._b)),t.aa(new Sd(c+g._b._bd*l+g._p,d+f)),g._b._bd++,g._b._bc=Math.max(g._b._bc,2)):r.f()?(t.aa(new Sd(c,d+g._i._bd*o+g._a)),t.aa(new Sd(c-this._b,d+g._i._bd*o+g._a)),g._i._bd++,t.aa(new Sd(c-this._b,d+g._i._bd*o+g._a)),t.aa(new Sd(c,d+g._i._bd*o+g._a)),g._i._bd++,g._i._bc=Math.max(g._i._bc,2)):r.e()&&(t.aa(new Sd(c+e,d+g._h._bd*n+g._e)),t.aa(new Sd(c+e+this._b,d+g._h._bd*n+g._e)),g._h._bd++,t.aa(new Sd(c+e+this._b,d+g._h._bd*n+g._e)),t.aa(new Sd(c+e,d+g._h._bd*n+g._e)),g._h._bd++,g._h._bc=Math.max(g._h._bc,2)),this._d.m1(q,t)):r.c()||s.c()?r.e()||s.e()?(t.aa(new Sd(c+e-g._d._bd*m-g._c,d)),t.aa(new Sd(c+e-g._d._bd*m-g._c,d-this._b*g._d._bc)),t.aa(new Sd(c+e+this._b*g._h._bc,d-this._b*g._d._bc)),t.aa(new Sd(c+e+this._b*g._h._bc,d+g._h._bd*n+g._e)),t.aa(new Sd(c+e,d+g._h._bd*n+g._e)),g._d._bd++,g._d._bc++,g._h._bd++,g._h._bc++,s.c()&&t.ax(),this._d.m1(q,t)):r.f()||s.f()?(t.aa(new Sd(c+g._g._bd*m+g._c,d)),t.aa(new Sd(c+g._g._bd*m+g._c,d-this._b*g._g._bc)),t.aa(new Sd(c-this._b*g._i._bc,d-this._b*g._g._bc)),t.aa(new Sd(c-this._b*g._i._bc,d+g._i._bd*o+g._a)),t.aa(new Sd(c,d+g._i._bd*o+g._a)),g._g._bd++,g._g._bc++,g._i._bd++,g._i._bc++,s.c()&&t.ax(),this._d.m1(q,t)):(r.d()||s.d())&&(t.aa(new Sd(c+e-g._d._bd*m-g._c,d)),t.aa(new Sd(c+e-g._d._bd*m-g._c,d-this._b*g._d._bc)),t.aa(new Sd(c+e+this._b*g.b(),d-this._b*g._d._bc)),t.aa(new Sd(c+e+this._b*g.b(),d+f+this._b*g._q._bc)),t.aa(new Sd(c+e-g._q._bd*l-g._p,d+f+this._b*g._q._bc)),t.aa(new Sd(c+e-g._q._bd*l-g._p,d+f)),g._d._bd++,g._d._bc++,g._k._bc++,g._h._bc++,g._q._bc++,g._q._bd++,s.c()&&t.ax(),this._d.m1(q,t)):r.d()||s.d()?r.e()||s.e()?(t.aa(new Sd(c+e-g._q._bd*l-g._p,d+f)),t.aa(new Sd(c+e-g._q._bd*l-g._p,d+f+this._b*g._q._bc)),t.aa(new Sd(c+e+this._b*g._k._bc,d+f+this._b*g._q._bc)),t.aa(new Sd(c+e+this._b*g._k._bc,d+f-g._k._bd*n-g._e)),t.aa(new Sd(c+e,d+f-g._k._bd*n-g._e)),g._q._bd++,g._q._bc++,g._k._bd++,g._k._bc++,s.d()&&t.ax(),this._d.m1(q,t)):(r.f()||s.f())&&(t.aa(new Sd(c+g._b._bd*l+g._p,d+f)),t.aa(new Sd(c+g._b._bd*l+g._p,d+f+this._b*g._b._bc)),t.aa(new Sd(c-this._b*g._l._bc,d+f+this._b*g._b._bc)),t.aa(new Sd(c-this._b*g._l._bc,d+f-g._l._bd*o-g._a)),t.aa(new Sd(c,d+f-g._l._bd*o-g._a)),g._b._bd++,g._b._bc++,g._l._bd++,g._l._bc++,s.d()&&t.ax(),this._d.m1(q,t)):(t.aa(new Sd(c,d+f-g._l._bd*o-g._a)),t.aa(new Sd(c-this._b*g._l._bc,d+f-g._l._bd*o-g._a)),t.aa(new Sd(c-this._b*g._l._bc,d+f+this._b*g.a1())),t.aa(new Sd(c+e+this._b*g._k._bc,d+f+this._b*g.a1())),t.aa(new Sd(c+e+this._b*g._k._bc,d+f-g._k._bd*n-g._e)),t.aa(new Sd(c+e,d+f-g._k._bd*n-g._e)),g._l._bd++,g._l._bc++,g._b._bc++,g._q._bc++,g._k._bc++,g._k._bd++,s.f()&&t.ax(),this._d.m1(q,t))}}}},a5:function(a,b){for(var c=0;c<a.length;c++)for(var d=a[c],e=b[c],f=d.x1();f.i1();f.i2()){var g=f.i9();if(this.a2(g)){var h=this.b2(g);e._g=Math.max(e._g,this._b*(h.d()-1)),e._j=Math.max(e._j,this._b*(h.a1()-1))}}},a1:function(a){var b=this._d.xc("A"),c=null;if(null!=b&&(c=b.i1(a)),null==c||c.g()){var d=this._d.xc("B");if(null==d)return pf.j(1);var e=d.i1(a);if(null==e||e.g())return pf.j(1);if(e.c())return pf.j(8);if(e.f())return pf.j(1);if(e.d())return pf.j(4);if(e.e())return pf.j(2)}return c},b1:function(a){var b=this._d.xc("B"),c=null;if(null!=b&&(c=b.i1(a)),null==c||c.g()){var d=this._d.xc("A");if(null==d)return pf.j(8);var e=d.i1(a);if(null==e||e.g())return pf.j(8);if(e.c())return pf.j(8);if(e.f())return pf.j(1);if(e.d())return pf.j(4);if(e.e())return pf.j(2)}return c}});var zf=function(){this._o=0,this._f=0,this._n=0,this._m=0,this._c=0,this._p=0,this._e=0,this._a=0,this._j=new re,this._g=new vf,this._d=new vf,this._b=new vf,this._q=new vf,this._h=new vf,this._k=new vf,this._i=new vf,this._l=new vf};Hb.ext(zf,Object,{a1:function(){return Math.max(this._q._bc,this._b._bc)},d:function(){return Math.max(this._d._bc,this._g._bc)},b:function(){return Math.max(this._k._bc,this._h._bc)},c:function(){return Math.max(this._l._bc,this._i._bc)},a2:function(a,b,c,d){this._c=b,this._a=d,this._p=a,this._e=c,this._g.c0(),this._d.c0(),this._b.c0(),this._q.c0(),this._k.c0(),this._h.c0(),this._l.c0(),this._i.c0()}});var Af=function(a,b,c,d){this._k=20,this._r=.5,this._d=a,this._c=b,this._j=c,this._m=d,this._i=null!=a.xc("A")||null!=a.xc("B"),this._t=new Df(a,b,c,d),this._b=new yf(a,this)};Hb.ext(Af,Object,{a6:function(a){this._k=a,this._t.a1(a),this._b.a3(a)},g1:function(){return this._k},a9:function(a){return this.c1(),a},a5:function(a){return this.a1(),a},b3:function(a){return this.c1(),a=this.c4(a),this._b.c(),a},g2:function(a){return this._b.g(),a},e2:function(a){a=this.f(a),this._b.f()},e1:function(){this._t.d(),null!=this._n&&this._d.xi(this._n),this.a1(),this._d=null},a1:function(){this._i&&(null!=this._q&&(this._d.x1("A",this._q),this._q=null),null!=this._p&&(this._d.x1("B",this._p),this._p=null),null!=this._h&&(this._d.xj(this._h),this._h=null),null!=this._l&&(this._d.xj(this._l),this._l=null))},c1:function(){if(this._i){null==this._h&&(this._h=this._d.xl()),null==this._l&&(this._l=this._d.xl());for(var a=this._d.xf();a.i1();a.i2()){var b=a.i8(),c=null!=this._j.i1(b.a2()),d=null!=this._j.i1(b.a3());if(c&&!d){var e=this._j.i1(b.a2());this._m.i4(e)?this._l.i8(b,pf.h(this._d,e)):this._l.i8(b,pf.i(this._d,e))}else if(!c&&d){var f=this._j.i1(b.a3());this._m.i4(f)?this._h.i8(b,pf.i(this._d,f)):this._h.i8(b,pf.h(this._d,f))}else c||d||(this._m.i4(b)?(this._h.i8(b,pf.i(this._d,b)),this._l.i8(b,pf.h(this._d,b))):(this._h.i8(b,pf.h(this._d,b)),this._l.i8(b,pf.i(this._d,b))))}this._q=this._d.xc("A"),this._p=this._d.xc("B"),this._d.x1("A",this._h),this._d.x1("B",this._l)}},c4:function(a){this._n=this._d.xk(),this._a=this._d.xl(),this._g=this._d.xl();for(var b=new re,c=new re,d=new re,e=new re,f=new re,g=new re,h=new re,i=new re,j=new re,k=this._d.xk(),l=0;l<a.length;l++)for(var m=0,n=a[l].x1();n.i1();)k.i6(n.i9(),m),n.i2(),m++;for(var o=function(a,b){var c=k.i3(a.a3())-k.i3(b.a3());return 0>=c?c>=0?0:-1:1},p=function(a,b){var c=k.i3(a.a2())-k.i3(b.a2());return 0>=c?c>=0?0:-1:1},q=0;q<a.length;q++)for(var r=a[q],s=r._b;null!=s;s=s.a()){var t=s.d();t.av(o),t.au(p);var u=0;b.af(),c.af(),d.af(),e.af(),f.af(),g.af(),h.af(),i.af(),j.af();for(var v=t.ap();v.i1();){var w=v.i8(),x=this.b1(w);null==x||x.d()||x.g()?d.aa(w):x.e()?b.aa(w):x.f()?(c.aa(w),j.aa(w)):x.c()&&(i.aa(w),j.aa(w)),v.i2(),u++}u=0;for(var y=t.am();y.i1();){var z=y.i8(),A=this.a2(z);null==A||A.c()||A.g()?e.aa(z):A.e()?b.aa(z):A.f()?(c.aa(z),j.aa(z)):A.d()&&(g.aa(z),j.aa(z)),y.i2(),u++}var B=k.i3(t);if(!j.ar())for(var C=.1/j.ay(),D=B-.4;!j.ar();D+=C){var E=j.c3();if(E.a2()===t){var F=this._d.xm();this._n.z1(F,E.a2()),this._d.s7(F,1,1),this._c.z1(F,this._c.i1(t)),k.i6(F,D),this._a.i8(E,this._d.gn(E)),this._d.gt(E,ff._A),this._d.xr(E,F,E.a3()),r.ao(F,s)}else{var G=this._d.xm();this._n.z1(G,E.a3()),this._d.s7(G,1,1),this._c.z1(G,this._c.i1(t)),k.i6(G,D),this._g.i8(E,this._d.gk(E)),this._d.gz(E,ff._A),this._d.xr(E,E.a2(),G),r.ao(G,s)}}if(!b.ar())for(var H=.1/b.ay(),I=B+.1;!b.ar();I+=H){var J=b.c3();if(J.a2()===t){var K=this._d.xm();this._n.z1(K,J.a2()),this._d.s7(K,1,1),this._c.z1(K,this._c.i1(t)),k.i6(K,I),this._a.i8(J,this._d.gn(J)),this._d.gt(J,ff._A),this._d.xr(J,K,J.a3()),s=r.an(K,s)}else{var L=this._d.xm();this._n.z1(L,J.a3()),this._d.s7(L,1,1),this._c.z1(L,this._c.i1(t)),k.i6(L,I),this._g.i8(J,this._d.gk(J)),this._d.gz(J,ff._A),this._d.xr(J,J.a2(),L),s=r.an(L,s)}}var M=Af._z;this._b.a2(t)&&(M=this._b.b2(t));var N=M._b.ay()+g.ay()+t.ao()+f.ay()+M._q.ay();if(N>0)for(var O=this._d.g9(t)/2,P=this._d.gj(t),Q=this.a7(P,N),R=-.5*P+this.a8(this._d.gj(t),N,Q)+Q*(M._b.ay()+g.ay()),S=t.ap();S.i1();S.i2()){var T=S.i8();this.c2(T)||null!=this._j.i1(T.a2())||(this._d.g2(T).i8(new Sd(R,O)),R+=Q)}var U=this._t.a3(t),V=0,W=0,X=0,Y=0;if(null!=U&&(V=U._e.ay(),W=U._c.ay(),X=U._b.ay(),Y=U._d.ay()),N=M._g.ay()+V+i.ay()+t.ak()+h.ay()+W+M._d.ay(),N>0){for(var Z=this._d.gj(t),$=this.a7(Z,N),_=this.a8(Z,N,$),aa=-.5*Z+_+$*(M._g.ay()+V+i.ay()),ba=-this._d.g9(t)/2,ca=t.am();ca.i1();ca.i2()){var da=ca.i8();this.d1(da)||null!=this._j.i1(da.a3())||(this._d.g2(da).i9(new Sd(aa,ba)),aa+=$)}if(null!=U){for(var ea=-.5*Z+_+$*(M._g.ay()+i.ay()+U._e.ay()-1),fa=U._e.c1();fa.i1();fa.i2()){var ga=fa.i8();this._d.u1(ga),ga.a2()!==t||this.c2(ga)?this.d1(ga)||(this._d.g2(fa.i8()).i9(new Sd(ea,ba)),ea-=$):(this._d.g2(fa.i8()).i8(new Sd(ea,ba)),ea-=$),this._d.h1(ga)}ea=.5*Z-_-$*(M._d.ay()+h.ay());for(var ha=U._c.c1();ha.i1();ha.i2()){var ia=ha.i8();this._d.u1(ia),ia.a2()!==t||this.c2(ia)?this.d1(ia)||(this._d.g2(ha.i8()).i9(new Sd(ea,ba)),ea-=$):(this._d.g2(ha.i8()).i8(new Sd(ea,ba)),ea-=$),this._d.h1(ia)}}}this._b.a2(t)&&this._b.a4(t,V+i.ay()+t.ak()+h.ay()+W,g.ay()+t.ao()+f.ay(),X+c.ay(),Y+b.ay())}return this._d.xi(k),a},a7:function(a,b){return 1>=b?0:a/(b-1+2*this._r)},a8:function(a,b,c){return 1>=b?.5*a:.5*(a-c*(b-1))},f:function(a){var b=this.g1();this._f=this._d.xk();for(var c=0;c<a.length;c++)for(var d=a[c],e=d._b;null!=e;){var f=e.d(),g=this._n.i1(f);if(null!=g||this._t.b2(f))e=e.a();else{var h=new Je,i=new Je,j=new Je,k=new Je,l=new Je,m=new Je,n=new re,o=new re,p=new Gf(h,i,j,k,l,m,n,o);this._f.z1(f,p),n.ab(f.am()),o.ab(f.ap());for(var q=e.b();null!=q&&this._n.i1(q.d())===f;q=q.b()){var r=q.d(),s=this.c3(r);s.f()?i.ac(r):s.c()?k.ac(r):s.d()&&m.ac(r)}var t;for(t=e.a();null!=t&&this._n.i1(t.d())===f;t=t.a()){var u=t.d(),v=this.c3(u);v.e()?h.aa(u):v.c()?j.aa(u):v.d()&&l.aa(u)}e=t}}for(var w=this.d2(a),x=0,y=0;y<a.length;y++){var z=w[y];y>0&&(x+=w[y-1]._j+w[y-1]._h+w[y-1]._b),x+=z._g+z._f+z._a+z._d;for(var A=a[y].x1();A.i1();A.i2()){var B=A.i9();this._d.s3(B,this._d.gi(B),this._d.gh(B)+x)}z._c+=x,z._i+=x}for(var C=0;C<a.length;C++)for(var D=a[C],E=D.x1();E.i1();E.i2()){var F=E.i9();null!=this._n.i1(F)&&D.av(E)}for(var G=this,H=function(a,b){return G.a3(a)?G.a3(b)&&G._d.gi(a)>=G._d.gi(b)?-1:1:G.a3(b)?-1:G._d.gi(a)>=G._d.gi(b)?1:-1},I=function(a,b){return G.a3(a)?G.a3(b)?G._d.gi(a)>=G._d.gi(b)?1:-1:1:G.a3(b)?-1:G._d.gi(a)>=G._d.gi(b)?-1:1},J=0;J<a.length;J++)for(var K=w[J],L=a[J].x1();L.i1();L.i2()){var M=L.i9();if(!this._t.b2(M)){var N=this._f.i1(M),O=N._d,P=N._a,Q=N._b,R=N._h,S=N._f,T=N._c,U=N._g,V=N._e,W=0,X=0,Y=0,Z=0,$=M.ao(),_=M.ak(),aa=this._d.gi(M),ba=this._d.gh(M),ca=this._d.gj(M),da=this._d.g9(M),ea=this._t.a3(M),fa=Af._z;if(this._b.a2(M)&&(fa=this._b.b2(M)),null!=ea){if(W=ea._d.ay(),X=ea._b.ay(),Y=ea._e.ay(),Z=ea._c.ay(),W>0)for(var ga=fa._h.ay()+O.ay()+W+fa._k.ay(),ha=this.a7(da,ga),ia=this.a8(da,ga,ha),ja=ba+ia+ha*(fa._h.ay()+this.a4(O)),ka=ea._d.c1();ka.i1();ka.i2()){var la=ka.i8();this._d.u1(la),la.a2()===M?this.c2(la)||this._d.gx(la,new Sd(aa+ca,ja)):(this.d1(la),this._d.gy(la,new Sd(aa+ca,ja))),ja+=ha,this._d.h1(la)}if(X>0)for(var ma=fa._i.ay()+P.ay()+X+fa._l.ay(),na=this.a7(da,ma),oa=this.a8(da,ma,na),pa=ba+oa+na*(fa._i.ay()+this.a4(P)),qa=ea._b.c1();qa.i1();qa.i2()){var ra=qa.i8();this._d.u1(ra),ra.a2()===M?this.c2(ra)||this._d.gx(ra,new Sd(aa,pa)):this.d1(ra)||this._d.gy(ra,new Sd(aa,pa)),pa+=na,this._d.h1(ra)}}if(O.ay()>0){O.a1(H);for(var sa=fa._h.ay()+O.ay()+W+fa._k.ay(),ta=this.a7(da,sa),ua=this.a8(da,sa,ta),va=ba+ua+ta*fa._h.ay(),wa=!0;!O.ar();){var xa=O.x4();if(this.a3(xa)){wa&&(wa=!1,va+=ta*W);var ya=xa.ag(),za=this._d.gd(ya),Aa=za.at();if(za.ac(new Sd(Aa.x,K.b())),this.c2(ya)){var Ba=this._a.i1(ya);za.ac(new Sd(Aa.x,Ba.y+this._d.g6(M))),
za.ac(new Sd(Ba.x+this._d.g5(M),Ba.y+this._d.g6(M)))}else za.ac(new Sd(Aa.x,va)),za.ac(new Sd(aa+ca,va));this._d.xr(ya,M,ya.a3()),this._d.m1(ya,za)}else{var Ca=xa.ae(),Da=this._d.gd(Ca),Ea=Da.au();if(Da.ae(new Sd(Ea.x,K.a())),this.d1(Ca)){var Fa=this._g.i1(Ca);Da.ae(new Sd(Ea.x,Fa.y+this._d.g6(M))),Da.ae(new Sd(Fa.x+this._d.g5(M),Fa.y+this._d.g6(M)))}else Da.ae(new Sd(Ea.x,va)),Da.ae(new Sd(aa+ca,va));this._d.xr(Ca,Ca.a2(),M),this._d.m1(Ca,Da)}this._d.x4(xa),va+=ta}}if(P.ay()>0){P.a1(I);for(var Ga=fa._i.ay()+P.ay()+X+fa._l.ay(),Ha=this.a7(da,Ga),Ia=this.a8(da,Ga,Ha),Ja=ba+Ia+Ha*fa._i.ay(),Ka=!0;!P.ar();){var La=P.x4();if(this.a3(La)){Ka&&(Ka=!1,Ja+=Ha*X);var Ma=La.ag(),Na=this._d.gd(Ma),Oa=Na.at();if(Na.ac(new Sd(Oa.x,K.b())),this.c2(Ma)){var Pa=this._a.i1(Ma);Na.ac(new Sd(Oa.x,Pa.y+this._d.g6(M))),Na.ac(new Sd(Pa.x+this._d.g5(M),Pa.y+this._d.g6(M)))}else Na.ac(new Sd(Oa.x,Ja)),Na.ac(new Sd(aa,Ja));this._d.xr(Ma,M,Ma.a3()),this._d.m1(Ma,Na)}else{var Qa=La.ae(),Ra=this._d.gd(Qa),Sa=Ra.au();if(Ra.ae(new Sd(Sa.x,K.a())),this.d1(Qa)){var Ta=this._g.i1(Qa);Ra.ae(new Sd(Sa.x,Ta.y+this._d.g6(M))),Ra.ae(new Sd(Ta.x+this._d.g5(M),Ta.y+this._d.g6(M)))}else Ra.ae(new Sd(Sa.x,Ja)),Ra.ae(new Sd(aa,Ja));this._d.xr(Qa,Qa.a2(),M),this._d.m1(Qa,Ra)}this._d.x4(La),Ja+=Ha}}var Ua=fa._g.ay()+fa._d.ay()+_+R.ay()+Q.ay()+Y+Z;ca=this._d.gj(M);var Va=this.a7(ca,Ua),Wa=this.a8(ca,Ua,Va);Ua=fa._b.ay()+fa._q.ay()+$+T.ay()+S.ay();var Xa=this.a7(ca,Ua),Ya=this.a8(ca,Ua,Xa);if(R.ay()>0)for(var Za,$a=Va,_a=b,ab=this._d.gi(M)+Wa+$a*(fa._g.ay()+R.ay()-1),bb=this._d.gh(M),cb=K._c-K._g-R.ay()*_a;!R.ar();this._d.x4(Za)){Za=R.x4();var db=Za.ag(),eb=this._d.gd(db),fb=eb.at();if(eb.ac(new Sd(fb.x,K.b())),eb.ac(new Sd(fb.x,cb)),this.c2(db)){var gb=this._a.i1(db);eb.ac(new Sd(gb.x+this._d.g5(M),cb)),eb.ac(new Sd(gb.x+this._d.g5(M),gb.y+this._d.g6(M)))}else eb.ac(new Sd(ab,cb)),eb.ac(new Sd(ab,bb)),ab-=$a;cb+=_a,this._d.xr(db,M,db.a3()),this._d.m1(db,eb)}if(Q.ay()>0)for(var hb,ib=Va,jb=b,kb=this._d.gi(M)+this._d.gj(M)-Wa-ib*fa._d.ay(),lb=this._d.gh(M),mb=K._c-K._g-jb;!Q.ar();this._d.x4(hb)){hb=Q.x4();var nb=hb.ag(),ob=this._d.gd(nb),pb=ob.at();if(ob.ac(new Sd(pb.x,K.b())),ob.ac(new Sd(pb.x,mb)),this.c2(nb)){var qb=this._a.i1(nb);ob.ac(new Sd(qb.x+this._d.g5(M),mb)),ob.ac(new Sd(qb.x+this._d.g5(M),qb.y+this._d.g6(M)))}else ob.ac(new Sd(kb,mb)),ob.ac(new Sd(kb,lb)),kb-=ib;mb-=jb,this._d.xr(nb,M,nb.a3()),this._d.m1(nb,ob)}if(T.ay()>0)for(var rb,sb=Xa,tb=b,ub=this._d.gi(M)+Ya+sb*(fa._b.ay()+T.ay()-1),vb=this._d.gh(M)+this._d.g9(M),wb=vb+T.ay()*tb;!T.ar();this._d.x4(rb)){rb=T.x4();var xb=rb.ae(),yb=this._d.gd(xb),zb=yb.au();if(yb.ae(new Sd(zb.x,K.a())),yb.ae(new Sd(zb.x,wb)),this.d1(xb)){var Ab=this._g.i1(xb);yb.ae(new Sd(Ab.x+this._d.g5(M),wb)),yb.ae(new Sd(Ab.x+this._d.g5(M),Ab.y+this._d.g6(M)))}else yb.ae(new Sd(ub,wb)),yb.ae(new Sd(ub,vb)),ub-=sb;wb-=tb,this._d.xr(xb,xb.a2(),M),this._d.m1(xb,yb)}if(S.ay()>0)for(var Bb,Cb=Xa,Db=b,Eb=this._d.gi(M)+this._d.gj(M)-Ya-Xa*fa._q.ay(),Fb=this._d.gh(M)+this._d.g9(M),Gb=Fb+Db;!S.ar();this._d.x4(Bb)){Bb=S.x4();var Hb=Bb.ae(),Ib=this._d.gd(Hb),Jb=Ib.au();if(Ib.ae(new Sd(Jb.x,K.a())),Ib.ae(new Sd(Jb.x,Gb)),this.d1(Hb)){var Kb=this._g.i1(Hb);Ib.ae(new Sd(Kb.x+this._d.g5(M),Gb)),Ib.ae(new Sd(Kb.x+this._d.g5(M),Kb.y+this._d.g6(M)))}else Ib.ae(new Sd(Eb,Gb)),Ib.ae(new Sd(Eb,Fb)),Eb-=Cb;Gb+=Db,this._d.xr(Hb,Hb.a2(),M),this._d.m1(Hb,Ib)}for(;!V.ar();){var Lb=V.c3(),Mb=this._d.gl(Lb);K.a()+12<Mb.y&&this._d.g7(Lb).i4(Mb.x,K.a())}for(;!U.ar();){var Nb=U.c3(),Ob=this._d.gs(Nb);if(K.b()-12>Ob.y){var Pb=this._d.gf(Nb);Pb.ac(new Sd(Ob.x,K.b())),this._d.s6(Nb,Pb)}}}}for(var Qb=0;Qb<a.length;Qb++)for(var Rb=a[Qb],Sb=Rb._b;null!=Sb;Sb=Sb.a()){var Tb=Sb.d(),Ub=this._t.a3(Tb);null!=Ub&&null!=Ub._a&&(this._d.x4(Ub._a),Rb.aw(Sb.b()))}return this._d.xi(this._f),this._d.xj(this._a),this._d.xj(this._g),a},c3:function(a){return this.a3(a)?this.b1(a.ag()):this.a2(a.ae())},b1:function(a){return null==this._h?Af.s:this._h.i1(a)},a2:function(a){return null==this._l?Af.u:this._l.i1(a)},c2:function(a){if(null==a)return!1;var b=this.b1(a);return null!=b&&b.a()},d1:function(a){if(null==a)return!1;var b=this.a2(a);return null!=b&&b.a()},a3:function(a){return 1===a.ao()},b2:function(a){return 1===a.ak()},a4:function(a){for(var b=0,c=a._b;null!=c;c=c.a())this.b2(c.d())&&b++;return b},d2:function(a){for(var b=this._k,c=Hf.d(a.length+1),d=0;d<a.length;d++){var e=a[d],f=new Ef;c[d]=f,f._c=Number.MAX_VALUE,f._i=Number.MIN_VALUE;for(var g=e.x1();g.i1();g.i2()){var h=g.i9(),i=this._d.gb(h);f._c=Math.min(f._c,i.i2()),f._i=Math.max(f._i,i.i2()+i.i4())}}this._b.a5(a,c);for(var j=0;j<a.length;j++)for(var k=c[j],l=a[j].x1();l.i1();l.i2()){var m=l.i9(),n=this._f.i1(m);null!=n&&(k._h=Math.max(k._h,Math.max(n._f.ay()*b,n._c.ay()*b)),k._f=Math.max(k._f,Math.max(n._b.ay()*b,n._h.ay()*b)))}return c}}),Af.s=pf.j(2),Af.u=pf.j(1),Af._z=new zf;var Bf=function(){this._af=0,this._b=0};Hb.ext(Bf,Object,{ib:function(a){this._af=a},ia:function(a,b,c){this.a6(a,b,c),this.b2(!1);var d=this.g();if(this.o()&&d>0){for(var e=this.r(),f=0;20>f&&d>0&&this.o();f++){this.b2(!0);var g=this.g();d>g&&(this.a7(e),d=g)}this.b3(e),this.b1()}return this.c()},a6:function(a,b,c){this._b=(new Date).getTime(),this._ac=a,this._ah=b;var d=this;this._p=function(a,b){var c=d._n[a.al()]-d._n[b.al()];return c>0?1:c>=0?0:-1},this._ad=Hf.d(c);for(var e=0;e<this._ad.length;e++)this._ad[e]=new Je;this._ab=Hf.a(this._ac.x0()),this._f=Hf.d(this._ac.x0()),this._n=Hf.a(this._ac.x0()+1);var f=this._ab;this._o=function(a,b){if(null==a&&null!=b)return 1;if(null!=a&&null==b)return-1;if(null==a&&null==b)return 0;var c=a,d=b,e=c._h,g=c.a2(),h=d.a2(),i=f[g.al()]-f[h.al()];if(0===i){var j=Bf.b(pf.h(e,c),e.gn(c)),k=Bf.b(pf.h(e,d),e.gn(d)),l=j-k;if(0===l){var m=f[c.a3().al()]-f[d.a3().al()];if(0===m){var n=Bf.a(pf.i(e,c),e.gk(c)),o=Bf.a(pf.i(e,d),e.gk(d));return n-o}return m}return l}return i},this._l=function(a,b){if(null==a&&null!=b)return 1;if(null!=a&&null==b)return-1;if(null==a&&null==b)return 0;var c=a,d=b,e=c._h,g=c.a3(),h=d.a3(),i=f[g.al()]-f[h.al()];if(0===i){var j=Bf.a(pf.i(e,c),e.gk(c)),k=Bf.a(pf.i(e,d),e.gk(d)),l=j-k;if(0===l){var m=f[c.a2().al()]-f[d.a2().al()];if(0===m){var n=Bf.b(pf.h(e,c),e.gn(c)),o=Bf.b(pf.h(e,d),e.gn(d));return n-o}return m}return l}return i},this._z=function(a,b){if(null==a&&null!=b)return 1;if(null!=a&&null==b)return-1;if(null==a&&null==b)return 0;var c=a,d=b,e=c._h,f=Bf.b(pf.h(e,c),e.gn(c)),g=Bf.b(pf.h(e,d),e.gn(d));return f-g},this._e=function(a,b){if(null==a&&null!=b)return 1;if(null!=a&&null==b)return-1;if(null==a&&null==b)return 0;var c=a,d=b,e=c._h,f=Bf.a(pf.i(e,c),e.gk(c)),g=Bf.a(pf.i(e,d),e.gk(d));return f-g},this._ac.x2(this._e,this._z)},c:function(){this._ah=null,this._aa=null,this._f=null,this._n=null,this._p=null,this._o=null,this._l=null,this._ac=null;var a=this._ad;return this._ad=null,a},o:function(){var a=(new Date).getTime()-this._b;return a<=this._af},m:function(){for(var a=this,b=function(b,c){return Math.ceil(a._n[b.a3().al()])-Math.ceil(a._n[c.a3().al()])},c=this._ac.x9();c.i1();c.i2()){for(var d=c.i9().aw();d.i1();d.i2())this._n[d.i9().al()]=ff.j();c.i9().av(b)}},b2:function(a){for(var b=0;b<this._ad.length;b++)this._ad[b].af();if(a){this.m();for(var c=0,d=this._ab.length;d>c;c++)this._ab[c]=0;this._ac.x2(null,this._z)}var e=this._ac.xm();this._ah.i7(e,0);for(var f=this._ac.x9();f.i1();f.i2())0===f.i9().ak()&&f.i9()!==e&&this._ac.xo(e,f.i9());var g=new ee(this);g.a6(!0),g.a9(this._ac,e),this._ad[0].at(),this._ac.x4(e),this.d()},a1:function(){this._ac.x2(this._o,this._l);for(var a=0,b=1;b<this._ad.length;b++){var c=this.a2(this._ad[b-1],this._ad[b]);a+=c}var d=0;return a+=d},a2:function(a,b){var c=a.ah(),d=b.ah(),e=new qe,f=new qe;this._aa=Hf.d(this._ac.x0());for(var g=0;c.i1()&&d.i1();d.i2())g+=this.a8(c.i6(),e,f,!0),g+=this.a8(d.i6(),f,e,!1),c.i2();for(;c.i1();c.i2())g+=this.a8(c.i6(),e,f,!0);for(;d.i1();d.i2())g+=this.a8(d.i6(),f,e,!1);return g},a8:function(a,b,c,d){var e=0,f=0,g=0;if(null!=this._aa[a.al()])for(var h=this._aa[a.al()].a(),i=b._b;i!==h;i=i.a()){var j=i._c;j===a?(e++,g+=f,b.aw(i)):f++}var k=e*c.ay()+g;if(d)for(var l=a.ag();null!=l;l=l.a8()){var m=l.a3();this._ab[m.al()]>=this._ab[a.al()]&&(this._aa[m.al()]=c.ae(m))}else for(var n=a.ae();null!=n;n=n.a7()){var o=n.a2();this._ab[o.al()]>this._ab[a.al()]&&(this._aa[o.al()]=c.ae(o))}return k},g:function(){for(var a=this.r(),b=this.a1(),c=!0,d=0;3>d&&this.o()&&b>0;){var e=this.k();b>e?(this.a7(a),b=e):d++,c=!c}if(this.b3(a),this.b1(),b>0){for(var f=1,g=0;1===f&&b>0;g++){this.e(),this.i();var h=this.a1();b>h?(f=1,this.a7(a)):f=-1,b=h}this.b3(a),this.b1()}return b},e:function(){for(var a=this.l(),b=this.r(),c=Hf.d(this._ac.x0()),d=this._ad.length-1;d>=0;d--)for(var e=this._ad[d].ah();e.i1();e.i2()){var f=e.i6();if(1===f.ak()&&1===f.ao()){var g=a.i1(f.ag());if(null!=g&&null==c[g.al()])for(var h=this.a4(f,g),i=g.al(),j=c[i]=Hf.d(h+1),k=j.length-1;k>=0;k--)j[k]=new qe}}for(var l=0;l<this._ad.length;l++)for(var m=this._ad[l].ah();m.i1();m.i2()){var n=m.i6();if(1===n.ak()&&1===n.ao()){var o=a.i1(n.ag());if(null!=o){var p=o.al(),q=this.a4(n,o)-1;c[p][q].ae(n.ae())}}else for(var r=n.ae();null!=r;r=r.a7()){var s=a.i1(r);if(null!=s){var t=s.al(),u=this.a4(n,s)-1;c[t][u].ae(r)}}}for(var v=this._ac.x9();v.i1();v.i2()){var w=v.i9();if(null!=c[w.al()])for(var x=w.ag();null!=x;x=x.a8()){var y=a.i1(x);if(null!=y)for(var z=c[y.al()];z[0].ay()>0;){for(var A,B=0;;){A=z[B].am();var C=A.a3();if(1!==C.ak()||1!==C.ao())break;B++}var D=z[B].at().a3();B--,D=A.a2(),A=z[B].at();for(var E=A.a3();B>=0;)if(b[D.al()]!==b[E.al()]&&(this._ab[D.al()]=b[E.al()]),D=D.ae().a2(),--B>=0){var F=z[B].at();E=F.a3()}}}}this.b1(),this._ac.xj(a)},i:function(){for(var a=this.f(),b=this.r(),c=Hf.d(this._ac.x0()),d=0;d<this._ad.length;d++)for(var e=this._ad[d].ah();e.i1();e.i2()){var f=e.i6();if(1===f.ak()&&1===f.ao()){var g=a.i1(f.ae());if(null!=g&&null==c[g.al()])for(var h=this.a4(g,f),i=g.al(),j=c[i]=Hf.d(h+1),k=j.length-1;k>=0;k--)j[k]=new qe}}for(var l=this._ad.length-1;l>=0;l--)for(var m=this._ad[l].ah();m.i1();m.i2()){var n=m.i6();if(1===n.ak()&&1===n.ao()){var o=a.i1(n.ae());if(null!=o){var p=o.al(),q=this.a4(o,n)-1;c[p][q].ae(n.ag())}}else for(var r=n.ag();null!=r;r=r.a8()){var s=a.i1(r);if(null!=s){var t=s.al(),u=this.a4(s,n)-1;c[t][u].ae(r)}}}for(var v=this._ac.x9();v.i1();v.i2()){var w=v.i9();if(null!=c[w.al()])for(var x=w.ae();null!=x;x=x.a7()){var y=a.i1(x);if(null!=y)for(var z=c[y.al()];z[0].ay()>0;){for(var A,B=0;;){A=z[B].am();var C=A.a2();if(1!==C.ak()||1!==C.ao())break;B++}var D=z[B].at().a2();B--,D=A.a3(),A=z[B].at();for(var E=A.a2();B>=0;)if(b[D.al()]!==b[E.al()]&&(this._ab[D.al()]=b[E.al()]),D=D.ag().a3(),--B>=0){var F=z[B].at();E=F.a2()}}}}this.b1(),this._ac.xj(a)},a4:function(a,b){return this._ah.i2(a)-this._ah.i2(b)},l:function(){for(var a=Ne.a6(Hf.d(this._ac.xg())),b=this._ac.x9();b.i1();b.i2()){var c=b.i9();if(c.ao()>1){for(var d=0,e=c.ag();null!=e;e=e.a8()){var f=e.a3();1===f.ak()&&1===f.ao()&&d++}if(d>1)for(var g=c.ag();null!=g;g=g.a8()){var h=g,i=h.a3();if(1===i.ak()&&1===i.ao()){for(;1===i.ak()&&1===i.ao();i=h.a3())a.i8(h,c),h=i.ag();a.i8(h,c)}}}}return a},f:function(){for(var a=Ne.a6(Hf.d(this._ac.xg())),b=this._ac.x9();b.i1();b.i2()){var c=b.i9();if(c.ak()>1){for(var d=0,e=c.ae();null!=e;e=e.a7()){var f=e.a2();1===f.ak()&&1===f.ao()&&d++}if(d>1)for(var g=c.ae();null!=g;g=g.a7()){var h=g,i=h.a2();if(1===i.ak()&&1===i.ao()){for(;1===i.ak()&&1===i.ao();i=h.a2())a.i8(h,c),h=i.ae();a.i8(h,c)}}}}return a},k:function(){for(var a=1;a<this._ad.length;a++){for(var b=this._ad[a],c=b.ah();c.i1();c.i2()){var d=c.i6();this._n[d.al()]=this.a5(d,b.ay(),d.am(),this._ad[a-1].ay()),this._n[d.al()]+=this._ab[d.al()]/(3*this._ad[a-1].ay())}this.a3(b,this._p)}return this.a1()},a5:function(a,b,c,d){var e=0;if(0===c.i7())e=d*this._ab[a.al()]/b;else{for(;c.i1();c.i2()){var f=c.i8();e+=f.a2()===a?this._ab[f.a3().al()]:this._ab[f.a2().al()]}e/=c.i7()}return e},a7:function(a){Hf.f(this._ab,a,a.length)},b3:function(a){Hf.f(a,this._ab,a.length)},r:function(){var a=Hf.a(this._ab.length);return this.a7(a),a},d:function(){for(var a=0;a<this._ad.length;a++)for(var b=0,c=this._ad[a].ah();c.i1();)this._ab[c.i6().al()]=b,c.i2(),b++},b1:function(){for(var a=0;a<this._ad.length;a++){for(var b=this._ad[a],c=b._b;null!=c;c=c.a()){var d=c.d();this._f[this._ab[d.al()]]=d}for(var e=0,f=b._b;null!=f;)f.c(this._f[e]),f=f.a(),e++}},a3:function(a,b){for(var c=a.ah(),d=0;d<a.ay();c.i2())this._f[d]=c.i6(),d++;Hf.s(this._f,a.ay(),b);for(var e=0,f=a._b;null!=f;)f.c(this._f[e]),this._ab[this._f[e].al()]=e,f=f.a(),e++}}),Bf.b=function(a,b){if(null==a)return 0;var c=a.a()?Math.floor(b.x):0,d=a.a()?Math.floor(b.y):0;return a.e()?1e4-d:a.f()?-1e4+d:a.c()?-2e4-c:c},Bf.a=function(a,b){if(null==a)return 0;var c=a.a()?Math.floor(b.x):0,d=a.a()?Math.floor(b.y):0;return a.e()?1e4+d:a.f()?-1e4-d:a.d()?-2e4-c:c};var Cf=function(){Cf.superClass.constructor.call(this),this._i6=0,this._i3=2147483647,this._i0=60,this._iz=20,this._i2=20,this._i4=20,this.i5(!1),this._i7=new uf,this._i1=new Bf,this._i8=new xf};Hb.ext(Cf,Qe,{j2:function(){return this._i2},i4:function(a){return!0},i3:function(a){this._i6=(new Date).getTime(),of.d(a,!1);var b=a.xk(),c=a.xk(),d=a.xl(),e=new re,f=new Af(a,b,c,d);f.a6(this.j2()),this._i8.i3(this._iz),this._i8.i6(this._i0),this._i8.i4(this._i2),this._i8.i5(this._i4),this._i8.i2(c);for(var g=this._i7.i1(a,b,e),h=e.c1();h.i1();h.i2()){var i=h.i8();d.i7(i,!0);var j=a.gn(i);a.gt(i,a.gk(i)),a.gz(i,j)}this.a2(a,b,c),g=f.a9(g);var k=this.j1(a,b,g);k=f.a5(k),k=f.b3(k),this._i8.i1(a,k,b),k=f.g2(k),f.e2(k),this.b(a,c),this.w(a),this.a1(a,e),f.e1(),a.xj(d),a.xi(c),a.xi(b)},j1:function(a,b,c){if(this._i1 instanceof Bf){var d=this._i1,e=(new Date).getTime()-this._i6;d.ib(this._i3-e)}var f=this._i1.ia(a,b,c);return f},a1:function(a,b){for(var c=b.c1();c.i1();c.i2()){var d=c.i8(),e=a.gs(d),f=a.gl(d);a.x3(d);var g=a.gp(d);a.s5(d,g.a()),a.gy(d,e),a.gx(d,f)}},b:function(a,b){for(var c=a.x9();c.i1();c.i2()){var d=c.i9(),e=b.i1(d);if(null!=e&&!a.xp(e)){for(var f=d.am().i8().a2();null!=b.i1(f);f=d.am().i8().a2())d=f;a.u1(e);for(var g=d.ae(),h=new qe;null!=b.i1(g.a3());g=g.a3().ag()){var i=a.gs(g);h.aa(i),h.az(a.gf(g));var j=a.gl(g);j.equals(i)||h.aa(j)}var k=a.gs(g);h.aa(k),h.az(a.gf(g));var l=a.gl(g);l.equals(k)||h.aa(l),a.m1(e,h)}}for(var m=a.x9();m.i1();m.i2())null!=b.i1(m.i9())&&a.x4(m.i9())},w:function(a){for(var b=a.xf();b.i1();b.i2()){var c=b.i8(),d=a.g2(c);if(d.i1()>0){var e=new md,f=a.gc(c),g=f.c(),h=g.i6();g.i2();var i=h.x,j=h.y;if(g.i1()){var k=g.i6(),l=k.x,m=k.y;for(g.i2();g.i1();g.i2()){var n=g.i6(),o=n.x,p=n.y,q=(i-o)*(m-p)/(j-p)+o;Math.abs(q-l)>=1&&(e.add(k),i=l,j=m),k=n,l=o,m=p}}e.size()<d.i1()&&a.s5(c,new Xd(e))}}},a2:function(a,b,c){var d=a.g8().c1();for(d.i5();d.i1();d.i3()){var e=d.i8().a2(),f=d.i8().a3(),g=b.i2(f)-b.i2(e);if(g>1){for(var h=null,i=null,j=e;g>1;g--)h=a.xm(),a.s7(h,1,1),a.s4(h,ff._A),i=a.xo(j,h),j===e&&a.gt(i,a.gn(d.i8())),b.i7(h,b.i2(j)+1),c.z1(h,d.i8()),j=h;i=a.xo(h,f),a.gz(i,a.gk(d.i8())),a.h1(d.i8())}}}});var Df=function(a,b,c,d){this._i=20,this._j=a,this._g=b,this._a=c,this._h=d};Hb.ext(Df,Object,{a1:function(a){this._i=a},b2:function(a){return null==this._e?!1:this._e.i4(a)},a3:function(a){return null==this._f?null:this._f.i1(a)},d:function(){this._j.xi(this._f),this._j.xi(this._e)}});var Ef=function(){this._c=0,this._i=0,this._g=0,this._j=0,this._f=0,this._h=0,this._d=0,this._e=0,this._a=0,this._b=0};Hb.ext(Ef,Object,{a:function(){return this._c-this._g-this._f-this._a},b:function(){return this._i+this._j+this._h+this._b}});var Ff=function(){this._d=new re,this._b=new re,this._c=new re,this._e=new re};Hb.ext(Ff,Object,{});var Gf=function(a,b,c,d,e,f,g,h){this._d=a,this._a=b,this._b=c,this._h=d,this._f=e,this._c=f,this._e=g,this._g=h};Hb.ext(Gf,Object,{});var Hf={};if(Hf.a=function(a,b){for(var c=[],d=0;a>d;d++)c[d]=b||0;return c},Hf.b=function(a){for(var b=[],c=0;a>c;c++)b[c]=!1;return b},Hf.c=function(a,b){if(a instanceof Sd)return a.x<b.x?-1:a.x>b.x?1:a.y<b.y?-1:a.y<=b.y?0:1;if(a instanceof Td)return b.width>a.width?-1:b.width<a.width?1:b.height>a.height?-1:b.height>=a.height?0:1;if(a instanceof Vd)return a.x<b.x?-1:a.x>b.x?1:a.y<b.y?-1:a.y>b.y?1:b.width>a.width?-1:b.width<a.width?1:b.height>a.height?-1:b.height>=a.height?0:1;throw"Unkown Type: "+a},Hf.d=function(a){for(var b=[],c=0;a>c;c++)b[c]=null;return b},Hf.e=function(a,b){for(var c=[],d=0;a>d;d++)c[d]=Hf.a(b);return c},Hf.f=function(a,b,c){for(var d=0;c>d;d++)b[d]=a[d]},Hf.s=function(a,b,c){var d=[];Hf.f(a,d,b),d.sort(c),Hf.f(d,a,b)},Hf.n=function(a,b){return a-b},window.make)var If=window.make;else{var If=window.make={},Jf={},Kf={},Lf=[],Mf={};If.Default={path:"./",resPath:"",getImagePath:function(a){return this.path+this.resPath+"res/images/"+(a||"")},register:function(a,b,c){c=c||{},c.name=c.name||a,c.modelDefaultParameters=c.modelDefaultParameters||{},c.description=c.description||c.name,Jf[a]&&console.log(a," already exist"),Jf[a]=b;var d=c.category||"",e=Kf[d]||{};e[a]=b,Kf[d]=e,Mf[a]=c,-1==Lf.indexOf(d)&&Lf.push(d),this.checkModelDefaultParameters(c.modelDefaultParameters)},checkModelDefaultParameters:function(a){if(a)for(var b in a){var c=a[b];c instanceof Object||(c={value:c},a[b]=c),c.propertyName=b,c.hidden=!!c.hidden,c.propertyType=c.propertyType||If.Default.PARAMETER_PROPERTY_TYPE_FIELD,c.type=c.type||If.Default.PARAMETER_TYPE_STRING,c.category=c.category||If.Default.PARAMETER_CATEGORY_DETAIL,c.editable=void 0===c.editable?!0:!!c.editable,c.index=void 0===c.index?100:parseInt(c.index)}},remove:function(a){if(Jf[a]){Jf[a]=void 0,delete Jf[a];var b=If.Default.getCategory(a),c=Kf[b];delete c[a];var d=0;for(var e in c)e&&d++;if(0==d)for(var e=0;e<Lf.length;e++){var f=Lf.indexOf(b);f>=0&&Lf.splice(f,1)}delete Mf[a]}else console.log(a," not exist")},getCategories:function(){return Lf},getCreatorsForCategory:function(a){return Kf[a]},getCreator:function(a){return Jf[a]},getIds:function(a){var b=[];for(var c in Jf)(!a||a&&a(this.getParameters(c)))&&b.push(c);return b},getModelDefaultParameters:function(a){var b=this.getParameters(a);return b.modelDefaultParameters},getDescription:function(a){var b=this.getParameters(a);return b.description},getName:function(a){var b=this.getParameters(a);return b.name},getIcon:function(a){var b=this.getParameters(a);return this.path+b.icon},isAsync:function(a){var b=this.getParameters(a);return b.async},isCombo:function(a){var b=this.getParameters(a);return b.combo},getCategory:function(a){var b=this.getParameters(a);return b.category},getOrder:function(a){var b=this.getParameters(a);return b.order||0},getType:function(a){var b=this.getParameters(a);return b.type},getOtherParameter:function(a,b){var c=this.getParameters(a);return c[b]},registerIcon:function(a,b){var c=this.getParameters(a);if(c)return c.icon=b,c.icon},registerDescription:function(a,b){var c=this.getParameters(a);return c.description=b,c.description},registerName:function(a,b){var c=this.getParameters(a);return c.name=b,c.name},registerOther:function(a,b,c){var d=e[b],e=this.getParameters(a);return e[b]=c,"modelDefaultParameters"===b&&(console.warn("rewrite modelDefaultParameters: id={0}, oldValue={}, newValue={}",a,d,c),this.checkModelDefaultParameters(c)),d},appendModelDefaultParameter:function(a,b,c,d,e,f,g){},getParameters:function(a){return Mf[a]||{}},load:function(a,b,c){var d,c=c||{},e=c.isRelation;if(b){var f=b;b=function(b){e&&a instanceof Array&&a.length>1&&b instanceof Array&&b.length>1&&this._relation(a,b),f(b)}}if(a instanceof Array){var g={};if(b){var h=function(c,d){var e=a.length;return function(a){c.datas=c.datas||[],c.datas.push(a),c._total===e&&b(c.datas)}(d)};g._total=0;for(var i=0;i<a.length;i++){var j=a[i];this.load(j,function(a){g._total++,h(g,a)})}return null}d=[];for(var i=0;i<a.length;i++){var j=a[i],k=this.load(j);k&&d.push(k)}}else{var l={};"string"==typeof a?l.id=a:l=a,l=this.filterJson(l),b?this._load(l,b):d=this._load(l)}return e&&d instanceof Array&&d.length>1&&this._relation(a,d),d},_relation:function(a,b){var c={};b.forEach(function(a){a.getId&&(c[a.getId()]=a)}),a.forEach(function(a){a.objectId&&a.parentId&&c[a.objectId]&&c[a.parentId]&&c[a.objectId].setParent&&c[a.objectId].setParent(c[a.parentId])})},_load:function(a,b){var c=a.id,d=this.getCreator(c);if(!d)return console.log("unknown id: ",c),null;if(!b){var e=d(a);return If.Default._setObjectClientId(e,c),e}d(a,function(a){If.Default._setObjectClientId(a,c),b&&b(a)})},_setObjectClientId:function(a,b){a&&a.setClient&&a.setClient("id",b)},copyArray:function(a,b,c){if(b=[],a)for(var d,e=0,f=a.length;f>e;e++)d={},this.copyProperties(a[e],d),b.push(d);return b},copyProperties:function(a,b,c){if(a&&b)for(var d in a)c&&c.indexOf(d)>=0||0==d.indexOf("_")||(void 0===b[d]&&(b[d]=a[d]instanceof Array?[]:a[d]instanceof Function?a[d]:a[d]instanceof Object?{}:a[d]),!(a[d]instanceof Function)&&a[d]instanceof Object&&b[d]instanceof Object&&If.Default.copyProperties(a[d],b[d]))},getModelDefaultParametersValues:function(a,b){var c=this.getModelDefaultParameters(a),d={};for(var e in c){var f=c[e];b&&b(f)||(f.propertyType==If.Default.PARAMETER_PROPERTY_TYPE_CLIENT?(d.client=d.client||{},d.client[e]=f.value):f.propertyType==If.Default.PARAMETER_PROPERTY_TYPE_STYLE?(d.style=d.style||{},d.style[e]=f.value):d[e]=f.value)}return d},getModelDefaultParameterProperties:function(a,b){var c=this,d=[],e=this.getModelDefaultParameters(a);if(!e)return d;b&&!e.id&&(e.id={propertyName:"id",name:"模型ID",category:If.Default.PARAMETER_CATEGORY_BASIC,editable:!1,propertyType:If.Default.PARAMETER_PROPERTY_TYPE_FIELD,type:If.Default.PARAMETER_TYPE_STRING,exportable:!1,index:-2}),b&&!e.objectId&&(e.objectId={propertyName:"objectId",name:"实例ID",category:If.Default.PARAMETER_CATEGORY_BASIC,editable:!1,propertyType:If.Default.PARAMETER_PROPERTY_TYPE_FIELD,type:If.Default.PARAMETER_TYPE_STRING,exportable:!1,index:-1});for(var f in e)d.push(e[f]);return d.sort(function(a,b){return a.index-b.index}),d=d.map(function(a){return c.modelParameterToProperty(a)})},_getNameFromPropertyName:function(a){for(var b=a.split("."),c="",d=0;d<b.length;d++)b[d].length>0&&(c+=b[d].substring(0,1).toUpperCase()+b[d].substring(1,b[d].length)),d<b.length-1&&(c+=" ");return c},modelParameterToProperty:function(a){var b=new Gb.Property;return b.setCategoryName(a.category),a.name||(a.name=this._getNameFromPropertyName(a.propertyName)),b.setName(a.name),b.setEditable(a.editable),b.setPropertyType(a.propertyType),b.setPropertyName(a.propertyName),b.setValueType(a.type),b.setEnumInfo(a.enumInfo),b.isVisible=function(){return!a.hidden},b},filterJson:function(a){var b=this.getModelDefaultParameters(a.id);for(var c in b){var d=b[c].propertyType||"client",e=b[c].value;d==If.Default.PARAMETER_PROPERTY_TYPE_STYLE?a.style&&void 0!==a.style[c]||(a.style=a.style||{},a.style[c]=e):d==If.Default.PARAMETER_PROPERTY_TYPE_CLIENT?a.client&&void 0!==a.client[c]||(a.client=a.client||{},a.client[c]=e):void 0===a[c]&&(a[c]=e)}return a},UNIT_HEIGHT:4.445,EQUIPMENT_WIDTH:45.5,RACK_OFFSET_X:7.25,RACK_OFFSET_Y:6.655,RACK_WIDTH:60,getUnitHeight:function(){return this.UNIT_HEIGHT},getEquipmentWidth:function(){return this.EQUIPMENT_WIDTH},getEquipmentHeight:function(a){return parseInt(a)>0||console.error("method getEquipmentHeight's first argument scale value is zero"),this.UNIT_HEIGHT*a},getRackWidth:function(){return this.RACK_WIDTH},getRackHeight:function(a){return parseInt(a)>0||console.error("method getRackHeight's first argument scale value is zero"),this.RACK_OFFSET_Y+this.UNIT_HEIGHT*parseInt(a)+this.RACK_OFFSET_Y}},If.Default.toJson=function(a,b){if(a&&a.getClient){var c=a.getClient("id"),d=If.Default.getModelDefaultParameters(c),e={},f=null,g=null;for(var h in d)if(d[h].exportable!==!1){var i=d[h].propertyType,g=d[h].value;i==If.Default.PARAMETER_PROPERTY_TYPE_ACCESSOR?(f=a[Hb.getter(h)](),If.Default.equals(f,g)||(e[h]=f)):i==If.Default.PARAMETER_PROPERTY_TYPE_FIELD?(f=a[h],If.Default.equals(f,g)||(e[h]=f)):i==If.Default.PARAMETER_PROPERTY_TYPE_STYLE?(f=a.getStyle(h),If.Default.equals(f,g)||(e.style=e.style||{},e.style[h]=f)):i==If.Default.PARAMETER_PROPERTY_TYPE_CLIENT&&(f=a.getClient(h),If.Default.equals(f,g)||(e.client=e.client||{},e.client[h]=f))}return e.id=c,If.Default.EXPORT_OBJECT_ID&&(e.objectId=a.getId()),b&&(e=b(e)),e}return b&&(a=b(a)),a},If.Default.copy=function(a,b,c,d,e){var f=function(a,b,c,d,e){e=e||{};var f={},g={},h=If.Default.getParameters(b);if(h=If.Default.clone(h),If.Default.copyProperties(h,g),d instanceof Function?f=d(g)||{}:If.Default.copyProperties(d,f),e.copyDefaultParamCoverage&&delete g.modelDefaultParameters,e.copyParamCoverage||If.Default.copyProperties(g,f),e.defaultValue&&f.modelDefaultParameters)for(var i in e.defaultValue)void 0!==f.modelDefaultParameters[i]&&(f.modelDefaultParameters[i]instanceof Object?f.modelDefaultParameters[i].value=e.defaultValue[i]:f.modelDefaultParameters[i]=e.defaultValue[i]);If.Default.register(a,function(a,d){var e={id:b};c instanceof Function?c(a):If.Default.copyProperties(c,e),If.Default.copyProperties(a,e);var f=If.Default.load(e,d);return f},f)};f(a,b,c,d,e)},If.Default.PARAMETER_CATEGORY_BASIC="BASIC",If.Default.PARAMETER_CATEGORY_DETAIL="Detail",If.Default.PARAMETER_TYPE_STRING="string",If.Default.PARAMETER_TYPE_BOOLEAN="boolean",If.Default.PARAMETER_TYPE_COLOR="color",If.Default.PARAMETER_TYPE_INT="int",If.Default.PARAMETER_TYPE_NUMBER="number",If.Default.PARAMETER_TYPE_IMAGE="image",If.Default.PARAMETER_TYPE_ARRAY_STRING="array.string",If.Default.PARAMETER_TYPE_ARRAY_NUMBER="array.number",If.Default.PARAMETER_TYPE_ARRAY_INT="array.int",If.Default.PARAMETER_PROPERTY_TYPE_FIELD="field",If.Default.PARAMETER_PROPERTY_TYPE_ACCESSOR="accessor",If.Default.PARAMETER_PROPERTY_TYPE_STYLE="style",If.Default.PARAMETER_PROPERTY_TYPE_CLIENT="client",String.prototype.replaceAll=function(a,b,c){return RegExp.prototype.isPrototypeOf(a)?this.replace(a,b):this.replace(new RegExp(a,c?"gi":"g"),b)},String.prototype.format=function(a){var b=this;if(arguments.length>1){for(var c=[],d=0;d<arguments.length;d++)c.push(arguments[d]);a=c}if(a){if(a instanceof Array)a.forEach(function(a,c){a instanceof Object&&(a=JSON.stringify(a)),b=b.replaceAll("{"+c+"}",a)});else{if(!(a instanceof Object))return b.replaceAll("{}",a);for(var e in a){var f=a[e];f instanceof Object&&(f=JSON.stringify(f)),b=b.replaceAll("{"+e+"}",f)}}}return b},If.Default.getId=function(a){return a.getClient("id")},If.Default.objectWrapper=function(a,b,c,d){Object.defineProperty(a,b,{get:function(){var d=a["___"+b];return c&&(d=c.call(a,d,a,b)),d},set:function(c){var e=a[b];d&&(c=d.call(a,c,a,b)),e!==c&&(a["___"+b]=c,this.firePropertyChange&&this.firePropertyChange(b,e,c))}})},If.Default.equals=function(a,b){return a instanceof Object&&b instanceof Object?JSON.stringify(a)==JSON.stringify(b):a==b},If.Default.clone=function(a){try{return JSON.parse(JSON.stringify(a))}catch(b){throw console.error(b,a),b}},If.Default.EXPORT_OBJECT_ID=!0}If.Utils2D={create2dShapeNode:function(a){var b=a.position||[0,0,0],c=a.data,d=a.image,e=(a.objType,a.objectId),f=a.closed,g=new If.Default.WallShapeNode(e);"innerWall"==a.objType?g=new If.Default.InnerWallShapeNode(e):"floor"==a.objType?g=new If.Default.FloorShapeNode(e):"cable"==a.objType&&(g=new If.Default.LineWidthShapeNode(e));var h=If.Default.create2dShapePath(c,b);return If.Default.objectWrapper(g,"id",function(){return this.getClient("id")}),If.Default.objectWrapper(g,"objectId",function(){return this.getId()}),g.setSegments(h.segments),g.setPoints(h.points),f&&g.setClient("closed",!0),d&&g.setClient("imageSrc",d),If.Default.setObject2dCSProps(g,a),g},create2dShapePath:function(a,b){var c=new Gb.List,d=new Gb.List;if(a.length>0)if(c.add("moveto"),a[0]instanceof Array){d.add({x:parseFloat(a[0][0])+parseFloat(b[0]),y:parseFloat(a[0][1])+parseFloat(b[2])});for(var e=1;e<a.length;e++){var f=a[e];"c"==f[0]?(c.add("quadto"),d.add({x:parseFloat(f[1])+parseFloat(b[0]),y:parseFloat(f[2])+parseFloat(b[2])}),d.add({x:parseFloat(f[3])+parseFloat(b[0]),y:parseFloat(f[4])+parseFloat(b[2])})):(c.add("lineto"),d.add({x:parseFloat(f[0])+parseFloat(b[0]),y:parseFloat(f[1])+parseFloat(b[2])}))}}else{d.add({x:parseFloat(a[0])+parseFloat(b[0]),y:parseFloat(a[1])+parseFloat(b[2])});for(var e=2;e<a.length;e+=2)c.add("lineto"),d.add({x:parseFloat(a[e])+parseFloat(b[0]),y:parseFloat(a[e+1])+parseFloat(b[2])})}return{segments:c,points:d}},setObject2dCSProps:function(a,b){var c=b.style,d=b.client;if(c)for(var e in c)a.setStyle(e,c[e]);if(d)for(var e in d)a.setClient(e,d[e])},createBlockObject:function(a,b){var c=a.objectId,d=new If.Default.Block(c);"door"==b?d=new If.Default.Door(c):"window"==b&&(d=new If.Default.Window(c)),a.width&&d.setClient("length",a.width);var e=a.client||{};return d.setClient("edgeIndex",e.edgeIndex||1),d.setClient("offset",e.offset||0),If.Default.setObject2dCSProps(d,a),d},createNode:function(a){var b=a.position||[0,0,0],c=a.rotation||[0,0,0],d=a.width||50,e=a.depth||50,f=a.image,g=a.objectId,h=new Gb.Follower(g),i=a.color||"#CCCCFF";return If.Default.objectWrapper(h,"id",function(){return this.getClient("id")}),If.Default.objectWrapper(h,"objectId",function(){return this.getId()}),h.setSize(parseFloat(d),parseFloat(e)),h.setCenterLocation({x:parseFloat(b[0]),y:parseFloat(b[2])}),h.setAngle(c[1]),h.setClient("positionY",b[1]),"string"==typeof f?h.setImageUrl(f):"object"==typeof f?h.setImage(f):(h.setStyle("body.type","vector"),h.setStyle("vector.shape","rectangle"),h.setStyle("vector.fill.color",i)),h.setStyle("select.style","border"),h.setStyle("select.color","#F07819"),h.setStyle("select.width",.7),h.setStyle("vector.outline.width",1),h.setStyle("vector.outline.color","#BEC9BE"),h.getWidth()>20&&h.setStyle("label.maxlength",Math.min(h.getWidth(),h.getHeight())),h.setStyle("label.position","center"),If.Default.setObject2dCSProps(h,a),h},createFollower:function(a){var b=a,a={};If.Default.copyProperties(b,a),a.id=a.objectId||Hb.id(),a.scale=a.scale||1,a.depth=a.depth||5,a.position=a.position||[0,0,0],a.rotation=a.rotation||[0,0,0];var c=new Gb.Follower(a);return If.Default.objectWrapper(c,"id",function(){return c.getClient("id")}),If.Default.objectWrapper(c,"objectId",function(){return c.getId()}),If.Default.objectWrapper(c,"depth"),If.Default.objectWrapper(c,"position",null,function(a){return this.setLocation({x:a[0],y:a[1]}),a}),If.Default.objectWrapper(c,"rotation",null,function(a){return this.setAngle(a[2]),a}),If.Default.objectWrapper(c,"scale",null,function(a){var b=this.getSize();b.width=b.width*a,b.height=b.height*a,this.setSize(b);var d=this.getLocation();return d.x=d.x*a,d.y=d.y*a,c.setLocation(d),a}),c.depth=a.depth,c.position=a.position,c.rotation=a.rotation,c.scale=a.scale,c.addPropertyChangeListener(function(a){var b=a.property,c=a.source;"location"==b?(c.position[0]=a.newValue.x,c.position[1]=a.newValue.y):"angle"==b&&(c.rotation[2]=a.newValue)},c),a.x&&c.setX(a.x),a.y&&c.setY(a.y),c.z=a.z,a.location&&c.setLocation(a.location instanceof Array?{x:a.location[0],y:a.location[1]}:a.location),a.centerLocation&&c.setCenterLocation(a.centerLocation instanceof Array?{x:a.centerLocation[0],y:a.centerLocation[1]}:a.centerLocation),a.size&&c.setSize(a.size),a.angle&&c.setAngle(a.angle),c.setStyle("select.style","border"),c.setStyle("select.color","#F07819"),c.setStyle("select.width",.7),c.setStyle("vector.outline.color","#BEC9BE"),If.Default.setObject2dCSProps(c,a),c},align:function(a,b){if(b&&a&&!(a.size()<2)){var c=this["_align_"+b];c&&c.call(this,a)}},_align_up:function(a){for(var b=a.get(0).getLocation().y,c=1;c<a.size();c++)b=Math.min(b,a.get(c).getLocation().y);a.forEach(function(a){a.setY(b)})},_align_down:function(a){for(var b=a.get(0).getLocation().y+a.get(0).getSize().height,c=1;c<a.size();c++)b=Math.max(b,a.get(c).getLocation().y+a.get(c).getSize().height);a.forEach(function(a){a.setY(b-a.getSize().height)})},_align_left:function(a){for(var b=a.get(0).getLocation().x,c=1;c<a.size();c++)b=Math.min(b,a.get(c).getLocation().x);

a.forEach(function(a){a.setX(b)})},_align_right:function(a){for(var b=a.get(0).getLocation().x+a.get(0).getSize().width,c=1;c<a.size();c++)b=Math.max(b,a.get(c).getLocation().x+a.get(c).getSize().width);a.forEach(function(a){a.setX(b-a.getSize().width)})},_align_center:function(a){for(var b=0,c=0;c<a.size();c++)b+=a.get(c).getCenterLocation().y;var d=b/a.size();a.forEach(function(a){a.setY(d-a.getSize().height/2)})},_align_middle:function(a){for(var b=0,c=0;c<a.size();c++)b+=a.get(c).getCenterLocation().x;var d=b/a.size();a.forEach(function(a){a.setX(d-a.getSize().width/2)})},flow:function(a,b,c){if(b&&a&&!(a.size()<2)){var d=this["_flow_"+b];d&&d.call(this,a,c)}},_flow_hor:function(a,b){this.sort(a,function(a,b){return a.getLocation().y-b.getLocation().y}),this.sort(a,function(a,b){return a.getLocation().x-b.getLocation().x});for(var c=a.get(0),d=1;d<a.size();d++){var e=a.get(d),f=c.getLocation().x;e.setX(f+b),c=e}},_flow_ver:function(a,b){this.sort(a,function(a,b){return a.getLocation().x-b.getLocation().x}),this.sort(a,function(a,b){return a.getLocation().y-b.getLocation().y});for(var c=a.get(0),d=1;d<a.size();d++){var e=a.get(d),f=c.getLocation().y;e.setY(f+b),c=e}},sort:function(a,b){for(var c,d,e,f,g=a.size(),h=0;g>h;h++){c=a.get(h);for(var i=h+1;g>i;i++)d=a.get(i),e=b?b(c,d):0,e>0&&(f=d,d=c,c=f,a.set(h,c),a.set(i,d))}},wrapper:function(a,b){If.Default.objectWrapper(a,"id",function(){return this.getClient("id")}),If.Default.objectWrapper(a,"objectId",function(){return this.getId()}),If.Default.objectWrapper(a,"width"),If.Default.objectWrapper(a,"height"),If.Default.objectWrapper(a,"depth"),If.Default.objectWrapper(a,"px"),If.Default.objectWrapper(a,"py"),If.Default.objectWrapper(a,"pz"),If.Default.objectWrapper(a,"rx"),If.Default.objectWrapper(a,"ry"),If.Default.objectWrapper(a,"rz"),If.Default.objectWrapper(a,"position"),If.Default.objectWrapper(a,"rotation"),b&&b.forEach(function(b){If.Default.objectWrapper(a,b)})}},If.Default.register("twaver.cube.top",function(a,b){var c=If.Utils2D.createNode(a);return b&&b(c),c});for(var pc in If.Utils2D)If.Default[pc]=If.Utils2D[pc]}();

(function(e,t){function I(e,t,n,r,i,s){var o=i.realSize?i.realSize:i;t=t||"",t=String(t),e.font=n,e.fillStyle=r,e.strokeStyle="gray",e.textBaseline="middle",e.textAlign="center";var u=t.split("\n"),a=u.length,f=o.height/a,l=(i.height-o.height)/2;for(var c=0;c<a;c++){var h=w.getTextSize(n,u[c]).width,p=i.height,d=h/2;s=="right"?(d=i.width-h/2,e.textAlign="center"):s=="left"?(d=h/2,e.textAlign="center",e.textBaseline="middle"):s=="center"&&(d=i.width/2),e.strokeText(u[c],d,f/2+c*f+l),e.fillText(u[c],d,f/2+c*f+l)}}function R(e,t){var n=0;if(e.shadowMatrix)for(var r=0,i=t.size();r<i;r++){var s=t.get(r);s.refreshShadowUniforms(e,n)&&n++}}function U(e,t){var n=0;if(e.pShadowMap)for(var r=0,i=t.size();r<i;r++){var s=t.get(r);s.refreshUniformsPointShadow(e,n)&&n++}}function z(e,t,n,r){t._modelViewMatrix||(t._modelViewMatrix=new h),n.uniformMatrix4fv(e.modelViewMatrix,!1,t._modelViewMatrix.elements),e.normalMatrix&&n.uniformMatrix3fv(e.normalMatrix,!1,t._normalMatrix.elements);if(e.modelViewProjectionMatrix){t._modelViewProjectionMatrix=new h;var i=r._currentCamera,s=i.projectionMatrix;t._modelViewProjectionMatrix.multiply(s,t._modelViewMatrix),n.uniformMatrix4fv(e.modelViewProjectionMatrix,!1,t._modelViewProjectionMatrix.elements)}}function W(e,t,n){var r;return e==="fragment"?r=n.createShader(n.FRAGMENT_SHADER):e==="vertex"&&(r=n.createShader(n.VERTEX_SHADER)),n.shaderSource(r,t),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)&&!n.isContextLost()?(console.log(n.getShaderInfoLog(r)),console.error(t),null):r}function X(e,t){e.ambientLightColor.value=t.ambient,e.directionalLightColor.value=t.directional.colors,e.directionalLightDirection.value=t.directional.positions,e.pointLightColor.value=t.point.colors,e.pointLightPosition.value=t.point.positions,e.pointLightDistance.value=t.point.distances,e.spotLightColor.value=t.spot.colors,e.spotLightPosition.value=t.spot.positions,e.spotLightDistance.value=t.spot.distances,e.spotLightDirection.value=t.spot.directions,e.spotLightAngleCos.value=t.spot.anglesCos,e.spotLightExponent.value=t.spot.exponents,e.hemisphereLightSkyColor.value=t.hemi.skyColors,e.hemisphereLightGroundColor.value=t.hemi.groundColors,e.hemisphereLightDirection.value=t.hemi.positions}function V(e,t,n,r){e[t]=n.r*r,e[t+1]=n.g*r,e[t+2]=n.b*r}function $(e,t,n,r){e[t]=n.r*n.r*r,e[t+1]=n.g*n.g*r,e[t+2]=n.b*n.b*r}function Q(t){var n=t,r=n._canvas;H.isNaN(n._renderInterval)&&(n._renderInterval=10),n.__timeOutFunc||(n.__timeOutFunc=function(){var t=n._vrDisplay;n._animateId=(t&&t.isPresenting?t:e).requestAnimationFrame(n.__timeOutFunc);if(n._isPresenting){var i=n._camera;i.updateProjectionMatrix(),i.worldMatrix=i.leftVm,i.worldMatrixInverse=i.leftVmInverse,i.projectionMatrix=i.leftPm,n._gl.viewport(0,0,r.width*.5,r.height),n._dirty=!0,q.clear(!0,n.autoClearDepth,n.autoClearStencil,n),n.render(),i.worldMatrix=i.rightVm,i.worldMatrixInverse=i.rightVmInverse,i.projectionMatrix=i.rightPm,n._gl.viewport(r.width*.5,0,r.width*.5,r.height),q.clear(!1,n.autoClearDepth,n.autoClearStencil,n),n.innerRender(i,!0),n.extendRender(i),t.submitFrame()}else n.render()}),setTimeout(n.__timeOutFunc,n._renderInterval)}function nt(e,t,n){e!=null&&("number"==typeof e?this.fromNumber(e,t,n):t==null&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function rt(){return new nt(null)}function it(e,t,n,r,i,s){while(--s>=0){var o=t*this[e++]+n[r]+i;i=Math.floor(o/67108864),n[r++]=o&67108863}return i}function st(e,t,n,r,i,s){var o=t&32767,u=t>>15;while(--s>=0){var a=this[e]&32767,f=this[e++]>>15,l=u*a+f*o;a=o*a+((l&32767)<<15)+n[r]+(i&1073741823),i=(a>>>30)+(l>>>15)+u*f+(i>>>30),n[r++]=a&1073741823}return i}function ot(e,t,n,r,i,s){var o=t&16383,u=t>>14;while(--s>=0){var a=this[e]&16383,f=this[e++]>>14,l=u*a+f*o;a=o*a+((l&16383)<<14)+n[r]+i,i=(a>>28)+(l>>14)+u*f,n[r++]=a&268435455}return i}function ht(e){return at.charAt(e)}function pt(e,t){var n=ft[e.charCodeAt(t)];return n==null?-1:n}function dt(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s}function vt(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+DV:this.t=0}function mt(e){var t=rt();return t.fromInt(e),t}function gt(e,t){var n;if(t==16)n=4;else if(t==8)n=3;else if(t==256)n=8;else if(t==2)n=1;else if(t==32)n=5;else{if(t!=4){this.fromRadix(e,t);return}n=2}this.t=0,this.s=0;var r=e.length,i=!1,s=0;while(--r>=0){var o=n==8?e[r]&255:pt(e,r);if(o<0){e.charAt(r)=="-"&&(i=!0);continue}i=!1,s==0?this[this.t++]=o:s+n>this.DB?(this[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this[this.t++]=o>>this.DB-s):this[this.t-1]|=o<<s,s+=n,s>=this.DB&&(s-=this.DB)}n==8&&(e[0]&128)!=0&&(this.s=-1,s>0&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),i&&nt.ZERO.subTo(this,this)}function yt(){var e=this.s&this.DM;while(this.t>0&&this[this.t-1]==e)--this.t}function bt(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(e==16)t=4;else if(e==8)t=3;else if(e==2)t=1;else if(e==32)t=5;else{if(e!=4)return this.toRadix(e);t=2}var n=(1<<t)-1,r,i=!1,s="",o=this.t,u=this.DB-o*this.DB%t;if(o-->0){u<this.DB&&(r=this[o]>>u)>0&&(i=!0,s=ht(r));while(o>=0)u<t?(r=(this[o]&(1<<u)-1)<<t-u,r|=this[--o]>>(u+=this.DB-t)):(r=this[o]>>(u-=t)&n,u<=0&&(u+=this.DB,--o)),r>0&&(i=!0),i&&(s+=ht(r))}return i?s:"0"}function wt(){var e=rt();return nt.ZERO.subTo(this,e),e}function Et(){return this.s<0?this.negate():this}function St(e){var t=this.s-e.s;if(t!=0)return t;var n=this.t;t=n-e.t;if(t!=0)return t;while(--n>=0)if((t=this[n]-e[n])!=0)return t;return 0}function xt(e){var t=1,n;return(n=e>>>16)!=0&&(e=n,t+=16),(n=e>>8)!=0&&(e=n,t+=8),(n=e>>4)!=0&&(e=n,t+=4),(n=e>>2)!=0&&(e=n,t+=2),(n=e>>1)!=0&&(e=n,t+=1),t}function Tt(){return this.t<=0?0:this.DB*(this.t-1)+xt(this[this.t-1]^this.s&this.DM)}function Nt(e,t){var n;for(n=this.t-1;n>=0;--n)t[n+e]=this[n];for(n=e-1;n>=0;--n)t[n]=0;t.t=this.t+e,t.s=this.s}function Ct(e,t){for(var n=e;n<this.t;++n)t[n-e]=this[n];t.t=Math.max(this.t-e,0),t.s=this.s}function kt(e,t){var n=e%this.DB,r=this.DB-n,i=(1<<r)-1,s=Math.floor(e/this.DB),o=this.s<<n&this.DM,u;for(u=this.t-1;u>=0;--u)t[u+s+1]=this[u]>>r|o,o=(this[u]&i)<<n;for(u=s-1;u>=0;--u)t[u]=0;t[s]=o,t.t=this.t+s+1,t.s=this.s,t.clamp()}function Lt(e,t){t.s=this.s;var n=Math.floor(e/this.DB);if(n>=this.t){t.t=0;return}var r=e%this.DB,i=this.DB-r,s=(1<<r)-1;t[0]=this[n]>>r;for(var o=n+1;o<this.t;++o)t[o-n-1]|=(this[o]&s)<<i,t[o-n]=this[o]>>r;r>0&&(t[this.t-n-1]|=(this.s&s)<<i),t.t=this.t-n,t.clamp()}function At(e,t){var n=0,r=0,i=Math.min(e.t,this.t);while(n<i)r+=this[n]-e[n],t[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){r-=e.s;while(n<this.t)r+=this[n],t[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{r+=this.s;while(n<e.t)r-=e[n],t[n++]=r&this.DM,r>>=this.DB;r-=e.s}t.s=r<0?-1:0,r<-1?t[n++]=this.DV+r:r>0&&(t[n++]=r),t.t=n,t.clamp()}function Ot(e,t){var n=this.abs(),r=e.abs(),i=n.t;t.t=i+r.t;while(--i>=0)t[i]=0;for(i=0;i<r.t;++i)t[i+n.t]=n.am(0,r[i],t,i,0,n.t);t.s=0,t.clamp(),this.s!=e.s&&nt.ZERO.subTo(t,t)}function Mt(e){var t=this.abs(),n=e.t=2*t.t;while(--n>=0)e[n]=0;for(n=0;n<t.t-1;++n){var r=t.am(n,t[n],e,2*n,0,1);(e[n+t.t]+=t.am(n+1,2*t[n],e,2*n+1,r,t.t-n-1))>=t.DV&&(e[n+t.t]-=t.DV,e[n+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(n,t[n],e,2*n,0,1)),e.s=0,e.clamp()}function _t(e,t,n){var r=e.abs();if(r.t<=0)return;var i=this.abs();if(i.t<r.t){t!=null&&t.fromInt(0),n!=null&&this.copyTo(n);return}n==null&&(n=rt());var s=rt(),o=this.s,u=e.s,a=this.DB-xt(r[r.t-1]);a>0?(r.lShiftTo(a,s),i.lShiftTo(a,n)):(r.copyTo(s),i.copyTo(n));var f=s.t,l=s[f-1];if(l==0)return;var c=l*(1<<this.F1)+(f>1?s[f-2]>>this.F2:0),h=this.FV/c,p=(1<<this.F1)/c,d=1<<this.F2,v=n.t,m=v-f,g=t==null?rt():t;s.dlShiftTo(m,g),n.compareTo(g)>=0&&(n[n.t++]=1,n.subTo(g,n)),nt.ONE.dlShiftTo(f,g),g.subTo(s,s);while(s.t<f)s[s.t++]=0;while(--m>=0){var y=n[--v]==l?this.DM:Math.floor(n[v]*h+(n[v-1]+d)*p);if((n[v]+=s.am(0,y,n,m,0,f))<y){s.dlShiftTo(m,g),n.subTo(g,n);while(n[v]<--y)n.subTo(g,n)}}t!=null&&(n.drShiftTo(f,t),o!=u&&nt.ZERO.subTo(t,t)),n.t=f,n.clamp(),a>0&&n.rShiftTo(a,n),o<0&&nt.ZERO.subTo(n,n)}function Dt(e){var t=rt();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(nt.ZERO)>0&&e.subTo(t,t),t}function Pt(e){this.m=e}function Ht(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e}function Bt(e){return e}function jt(e){e.divRemTo(this.m,null,e)}function Ft(e,t,n){e.multiplyTo(t,n),this.reduce(n)}function It(e,t){e.squareTo(t),this.reduce(t)}function qt(){if(this.t<1)return 0;var e=this[0];if((e&1)==0)return 0;var t=e&3;return t=t*(2-(e&15)*t)&15,t=t*(2-(e&255)*t)&255,t=t*(2-((e&65535)*t&65535))&65535,t=t*(2-e*t%this.DV)%this.DV,t>0?this.DV-t:-t}function Rt(e){this.m=e,this.mp=e.invDigit(),this.mpl=this.mp&32767,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function Ut(e){var t=rt();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(nt.ZERO)>0&&this.m.subTo(t,t),t}function zt(e){var t=rt();return e.copyTo(t),this.reduce(t),t}function Wt(e){while(e.t<=this.mt2)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var n=e[t]&32767,r=n*this.mpl+((n*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;n=t+this.m.t,e[n]+=this.m.am(0,r,e,t,0,this.m.t);while(e[n]>=e.DV)e[n]-=e.DV,e[++n]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)}function Xt(e,t){e.squareTo(t),this.reduce(t)}function Vt(e,t,n){e.multiplyTo(t,n),this.reduce(n)}function $t(){return(this.t>0?this[0]&1:this.s)==0}function Jt(e,t){if(e>4294967295||e<1)return nt.ONE;var n=rt(),r=rt(),i=t.convert(this),s=xt(e)-1;i.copyTo(n);while(--s>=0){t.sqrTo(n,r);if((e&1<<s)>0)t.mulTo(r,i,n);else{var o=n;n=r,r=o}}return t.revert(n)}function Kt(e,t){var n;return e<256||t.isEven()?n=new Pt(t):n=new Rt(t),this.exp(e,n)}function Qt(){var e=rt();return this.copyTo(e),e}function Gt(){if(this.s<0){if(this.t==1)return this[0]-this.DV;if(this.t==0)return-1}else{if(this.t==1)return this[0];if(this.t==0)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function Yt(){return this.t==0?this.s:this[0]<<24>>24}function Zt(){return this.t==0?this.s:this[0]<<16>>16}function en(e){return Math.floor(Math.LN2*this.DB/Math.log(e))}function tn(){return this.s<0?-1:this.t<=0||this.t==1&&this[0]<=0?0:1}function nn(e){e==null&&(e=10);if(this.signum()==0||e<2||e>36)return"0";var t=this.chunkSize(e),n=Math.pow(e,t),r=mt(n),i=rt(),s=rt(),o="";this.divRemTo(r,i,s);while(i.signum()>0)o=(n+s.intValue()).toString(e).substr(1)+o,i.divRemTo(r,i,s);return s.intValue().toString(e)+o}function rn(e,t){this.fromInt(0),t==null&&(t=10);var n=this.chunkSize(t),r=Math.pow(t,n),i=!1,s=0,o=0;for(var u=0;u<e.length;++u){var a=pt(e,u);if(a<0){e.charAt(u)=="-"&&this.signum()==0&&(i=!0);continue}o=t*o+a,++s>=n&&(this.dMultiply(r),this.dAddOffset(o,0),s=0,o=0)}s>0&&(this.dMultiply(Math.pow(t,s)),this.dAddOffset(o,0)),i&&nt.ZERO.subTo(this,this)}function sn(e,t,n){if("number"==typeof t)if(e<2)this.fromInt(1);else{this.fromNumber(e,n),this.testBit(e-1)||this.bitwiseTo(nt.ONE.shiftLeft(e-1),pn,this),this.isEven()&&this.dAddOffset(1,0);while(!this.isProbablePrime(t))this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(nt.ONE.shiftLeft(e-1),this)}else{var r=new Array,i=e&7;r.length=(e>>3)+1,t.nextBytes(r),i>0?r[0]&=(1<<i)-1:r[0]=0,this.fromString(r,256)}}function on(){var e=this.t,t=new Array;t[0]=this.s;var n=this.DB-e*this.DB%8,r,i=0;if(e-->0){n<this.DB&&(r=this[e]>>n)!=(this.s&this.DM)>>n&&(t[i++]=r|this.s<<this.DB-n);while(e>=0){n<8?(r=(this[e]&(1<<n)-1)<<8-n,r|=this[--e]>>(n+=this.DB-8)):(r=this[e]>>(n-=8)&255,n<=0&&(n+=this.DB,--e)),(r&128)!=0&&(r|=-256),i==0&&(this.s&128)!=(r&128)&&++i;if(i>0||r!=this.s)t[i++]=r}}return t}function un(e){return this.compareTo(e)==0}function an(e){return this.compareTo(e)<0?this:e}function fn(e){return this.compareTo(e)>0?this:e}function ln(e,t,n){var r,i,s=Math.min(e.t,this.t);for(r=0;r<s;++r)n[r]=t(this[r],e[r]);if(e.t<this.t){i=e.s&this.DM;for(r=s;r<this.t;++r)n[r]=t(this[r],i);n.t=this.t}else{i=this.s&this.DM;for(r=s;r<e.t;++r)n[r]=t(i,e[r]);n.t=e.t}n.s=t(this.s,e.s),n.clamp()}function cn(e,t){return e&t}function hn(e){var t=rt();return this.bitwiseTo(e,cn,t),t}function pn(e,t){return e|t}function dn(e){var t=rt();return this.bitwiseTo(e,pn,t),t}function vn(e,t){return e^t}function mn(e){var t=rt();return this.bitwiseTo(e,vn,t),t}function gn(e,t){return e&~t}function yn(e){var t=rt();return this.bitwiseTo(e,gn,t),t}function bn(){var e=rt();for(var t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e}function wn(e){var t=rt();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t}function En(e){var t=rt();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t}function Sn(e){if(e==0)return-1;var t=0;return(e&65535)==0&&(e>>=16,t+=16),(e&255)==0&&(e>>=8,t+=8),(e&15)==0&&(e>>=4,t+=4),(e&3)==0&&(e>>=2,t+=2),(e&1)==0&&++t,t}function xn(){for(var e=0;e<this.t;++e)if(this[e]!=0)return e*this.DB+Sn(this[e]);return this.s<0?this.t*this.DB:-1}function Tn(e){var t=0;while(e!=0)e&=e-1,++t;return t}function Nn(){var e=0,t=this.s&this.DM;for(var n=0;n<this.t;++n)e+=Tn(this[n]^t);return e}function Cn(e){var t=Math.floor(e/this.DB);return t>=this.t?this.s!=0:(this[t]&1<<e%this.DB)!=0}function kn(e,t){var n=nt.ONE.shiftLeft(e);return this.bitwiseTo(n,t,n),n}function Ln(e){return this.changeBit(e,pn)}function An(e){return this.changeBit(e,gn)}function On(e){return this.changeBit(e,vn)}function Mn(e,t){var n=0,r=0,i=Math.min(e.t,this.t);while(n<i)r+=this[n]+e[n],t[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){r+=e.s;while(n<this.t)r+=this[n],t[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{r+=this.s;while(n<e.t)r+=e[n],t[n++]=r&this.DM,r>>=this.DB;r+=e.s}t.s=r<0?-1:0,r>0?t[n++]=r:r<-1&&(t[n++]=this.DV+r),t.t=n,t.clamp()}function _n(e){var t=rt();return this.addTo(e,t),t}function Dn(e){var t=rt();return this.subTo(e,t),t}function Pn(e){var t=rt();return this.multiplyTo(e,t),t}function Hn(){var e=rt();return this.squareTo(e),e}function Bn(e){var t=rt();return this.divRemTo(e,t,null),t}function jn(e){var t=rt();return this.divRemTo(e,null,t),t}function Fn(e){var t=rt(),n=rt();return this.divRemTo(e,t,n),new Array(t,n)}function In(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()}function qn(e,t){if(e==0)return;while(this.t<=t)this[this.t++]=0;this[t]+=e;while(this[t]>=this.DV)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}function Rn(){}function Un(e){return e}function zn(e,t,n){e.multiplyTo(t,n)}function Wn(e,t){e.squareTo(t)}function Xn(e){return this.exp(e,new Rn)}function Vn(e,t,n){var r=Math.min(this.t+e.t,t);n.s=0,n.t=r;while(r>0)n[--r]=0;var i;for(i=n.t-this.t;r<i;++r)n[r+this.t]=this.am(0,e[r],n,r,0,this.t);for(i=Math.min(e.t,t);r<i;++r)this.am(0,e[r],n,r,0,t-r);n.clamp()}function $n(e,t,n){--t;var r=n.t=this.t+e.t-t;n.s=0;while(--r>=0)n[r]=0;for(r=Math.max(t-this.t,0);r<e.t;++r)n[this.t+r-t]=this.am(t-r,e[r],n,0,0,this.t+r-t);n.clamp(),n.drShiftTo(1,n)}function Jn(e){this.r2=rt(),this.q3=rt(),nt.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}function Kn(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=rt();return e.copyTo(t),this.reduce(t),t}function Qn(e){return e}function Gn(e){e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);while(e.compareTo(this.r2)<0)e.dAddOffset(1,this.m.t+1);e.subTo(this.r2,e);while(e.compareTo(this.m)>=0)e.subTo(this.m,e)}function Yn(e,t){e.squareTo(t),this.reduce(t)}function Zn(e,t,n){e.multiplyTo(t,n),this.reduce(n)}function er(e,t){var n=e.bitLength(),r,i=mt(1),s;if(n<=0)return i;n<18?r=1:n<48?r=3:n<144?r=4:n<768?r=5:r=6,n<8?s=new Pt(t):t.isEven()?s=new Jn(t):s=new Rt(t);var o=new Array,u=3,a=r-1,f=(1<<r)-1;o[1]=s.convert(this);if(r>1){var l=rt();s.sqrTo(o[1],l);while(u<=f)o[u]=rt(),s.mulTo(l,o[u-2],o[u]),u+=2}var c=e.t-1,h,p=!0,d=rt(),v;n=xt(e[c])-1;while(c>=0){n>=a?h=e[c]>>n-a&f:(h=(e[c]&(1<<n+1)-1)<<a-n,c>0&&(h|=e[c-1]>>this.DB+n-a)),u=r;while((h&1)==0)h>>=1,--u;(n-=u)<0&&(n+=this.DB,--c);if(p)o[h].copyTo(i),p=!1;else{while(u>1)s.sqrTo(i,d),s.sqrTo(d,i),u-=2;u>0?s.sqrTo(i,d):(v=i,i=d,d=v),s.mulTo(d,o[h],i)}while(c>=0&&(e[c]&1<<n)==0)s.sqrTo(i,d),v=i,i=d,d=v,--n<0&&(n=this.DB-1,--c)}return s.revert(i)}function tr(e){var t=this.s<0?this.negate():this.clone(),n=e.s<0?e.negate():e.clone();if(t.compareTo(n)<0){var r=t;t=n,n=r}var i=t.getLowestSetBit(),s=n.getLowestSetBit();if(s<0)return t;i<s&&(s=i),s>0&&(t.rShiftTo(s,t),n.rShiftTo(s,n));while(t.signum()>0)(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),(i=n.getLowestSetBit())>0&&n.rShiftTo(i,n),t.compareTo(n)>=0?(t.subTo(n,t),t.rShiftTo(1,t)):(n.subTo(t,n),n.rShiftTo(1,n));return s>0&&n.lShiftTo(s,n),n}function nr(e){if(e<=0)return 0;var t=this.DV%e,n=this.s<0?e-1:0;if(this.t>0)if(t==0)n=this[0]%e;else for(var r=this.t-1;r>=0;--r)n=(t*n+this[r])%e;return n}function rr(e){var t=e.isEven();if(this.isEven()&&t||e.signum()==0)return nt.ZERO;var n=e.clone(),r=this.clone(),i=mt(1),s=mt(0),o=mt(0),u=mt(1);while(n.signum()!=0){while(n.isEven()){n.rShiftTo(1,n);if(t){if(!i.isEven()||!s.isEven())i.addTo(this,i),s.subTo(e,s);i.rShiftTo(1,i)}else s.isEven()||s.subTo(e,s);s.rShiftTo(1,s)}while(r.isEven()){r.rShiftTo(1,r);if(t){if(!o.isEven()||!u.isEven())o.addTo(this,o),u.subTo(e,u);o.rShiftTo(1,o)}else u.isEven()||u.subTo(e,u);u.rShiftTo(1,u)}n.compareTo(r)>=0?(n.subTo(r,n),t&&i.subTo(o,i),s.subTo(u,s)):(r.subTo(n,r),t&&o.subTo(i,o),u.subTo(s,u))}return r.compareTo(nt.ONE)!=0?nt.ZERO:u.compareTo(e)>=0?u.subtract(e):u.signum()<0?(u.addTo(e,u),u.signum()<0?u.add(e):u):u}function or(e){var t,n=this.abs();if(n.t==1&&n[0]<=ir[ir.length-1]){for(t=0;t<ir.length;++t)if(n[0]==ir[t])return!0;return!1}if(n.isEven())return!1;t=1;while(t<ir.length){var r=ir[t],i=t+1;while(i<ir.length&&r<sr)r*=ir[i++];r=n.modInt(r);while(t<i)if(r%ir[t++]==0)return!1}return n.millerRabin(e)}function ur(e){var t=this.subtract(nt.ONE),n=t.getLowestSetBit();if(n<=0)return!1;var r=t.shiftRight(n);e=e+1>>1,e>ir.length&&(e=ir.length);var i=rt();for(var s=0;s<e;++s){i.fromInt(ir[Math.floor(Math.random()*ir.length)]);var o=i.modPow(r,this);if(o.compareTo(nt.ONE)!=0&&o.compareTo(t)!=0){var u=1;while(u++<n&&o.compareTo(t)!=0){o=o.modPowInt(2,this);if(o.compareTo(nt.ONE)==0)return!1}if(o.compareTo(t)!=0)return!1}}return!0}function ar(){this.i=0,this.j=0,this.S=new Array}function fr(e){var t,n,r;for(t=0;t<256;++t)this.S[t]=t;n=0;for(t=0;t<256;++t)n=n+this.S[t]+e[t%e.length]&255,r=this.S[t],this.S[t]=this.S[n],this.S[n]=r;this.i=0,this.j=0}function lr(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]}function cr(){return new ar}function mr(e){dr[vr++]^=e&255,dr[vr++]^=e>>8&255,dr[vr++]^=e>>16&255,dr[vr++]^=e>>24&255,vr>=hr&&(vr-=hr)}function gr(){mr((new Date).getTime())}function wr(){if(pr==null){gr(),pr=cr(),pr.init(dr);for(vr=0;vr<dr.length;++vr)dr[vr]=0;vr=0}return pr.next()}function Er(e){var t;for(t=0;t<e.length;++t)e[t]=wr()}function Sr(){}function Nr(e){var t,n,r="";for(t=0;t+3<=e.length;t+=3)n=parseInt(e.substring(t,t+3),16),r+=xr.charAt(n>>6)+xr.charAt(n&63);t+1==e.length?(n=parseInt(e.substring(t,t+1),16),r+=xr.charAt(n<<2)):t+2==e.length&&(n=parseInt(e.substring(t,t+2),16),r+=xr.charAt(n>>2)+xr.charAt((n&3)<<4));while((r.length&3)>0)r+=Tr;return r}function Cr(e){var t="",n,r=0,i;for(n=0;n<e.length;++n){if(e.charAt(n)==Tr)break;v=xr.indexOf(e.charAt(n));if(v<0)continue;r==0?(t+=ht(v>>2),i=v&3,r=1):r==1?(t+=ht(i<<2|v>>4),i=v&15,r=2):r==2?(t+=ht(i),t+=ht(v>>2),i=v&3,r=3):(t+=ht(i<<2|v>>4),t+=ht(v&15),r=0)}return r==1&&(t+=ht(i<<2)),t}function kr(e){var t=Cr(e),n,r=new Array;for(n=0;2*n<t.length;++n)r[n]=parseInt(t.substring(2*n,2*n+2),16);return r}function Lr(e,t){return new nt(e,t)}function Ar(e){return e<16?"0"+e.toString(16):e.toString(16)}function Or(e,t){if(t<e.length+11)return null;var n=new Array,r=e.length-1;while(r>=0&&t>0){var i=e.charCodeAt(r--);i<128?n[--t]=i:i>127&&i<2048?(n[--t]=i&63|128,n[--t]=i>>6|192):(n[--t]=i&63|128,n[--t]=i>>6&63|128,n[--t]=i>>12|224)}n[--t]=0;var s=new Sr,o=new Array;while(t>2){o[0]=0;while(o[0]==0)s.nextBytes(o);n[--t]=o[0]}return n[--t]=2,n[--t]=0,new nt(n)}function Mr(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function _r(e,t){this.n=Lr(e,16),this.e=parseInt(t,16)}function Dr(e){return e.modPowInt(this.e,this.n)}function Pr(e){var t=Or(e,this.n.bitLength()+7>>3);if(t==null)return null;var n=this.doPrivate(t);if(n==null)return null;var r=n.toString(16);return(r.length&1)==0?r:"0"+r}function Hr(e,t){var n=e.toByteArray(),r=0;while(r<n.length&&n[r]==0)++r;if(n.length-r!=t-1||n[r]!=2)return null;++r;while(n[r]!=0)if(++r>=n.length)return null;var i="";while(++r<n.length){var s=n[r]&255;s<128?i+=String.fromCharCode(s):s>191&&s<224?(i+=String.fromCharCode((s&31)<<6|n[r+1]&63),++r):(i+=String.fromCharCode((s&15)<<12|(n[r+1]&63)<<6|n[r+2]&63),r+=2)}return i}function Br(e,t,n){this.n=Lr(e,16),this.e=parseInt(t,16),this.d=Lr(n,16)}function jr(e,t,n,r,i,s,o,u){this.n=Lr(e,16),this.e=parseInt(t,16),this.d=Lr(n,16),this.p=Lr(r,16),this.q=Lr(i,16),this.dmp1=Lr(s,16),this.dmq1=Lr(o,16),this.coeff=Lr(u,16)}function Fr(e){if(this.p==null||this.q==null)return e.modPow(this.d,this.n);var t=e.mod(this.p).modPow(this.dmp1,this.p),n=e.mod(this.q).modPow(this.dmq1,this.q);while(t.compareTo(n)<0)t=t.add(this.p);return t.subtract(n).multiply(this.coeff).mod(this.p).multiply(this.q).add(n)}function Ir(e){var t=Lr(e,16),n=this.doPublic(t);return n==null?null:Hr(n,this.n.bitLength()+7>>3)}function ei(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity,e.skyY.value=t.skyY,e.horizonY.value=t.horizonY,e.earthY.value=t.earthY,e.skyColor.value=t.skyColor,e.horizonColor.value=t.horizonColor,e.earthColor.value=t.earthColor}function ti(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function ni(e,t){e&&e.skyY&&(e.skyY.value=t.skyY,e.horizonY.value=t.horizonY,e.earthY.value=t.earthY,e.skyColor.value=t.skyColor,e.horizonColor.value=t.horizonColor,e.earthColor.value=t.earthColor)}function si(e,t){e.psColor.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size,e.scale.value=t.scale||1,e.map.value=t.map}function pi(e,t){return e.distance-t.distance}function di(e,t,r,i,s){(e instanceof n.Node||e instanceof n.Billboard)&&mi(e,t,r,i,s)}function vi(e,n,r,i,s){if(e===t)return;var o=e.getDescendants();for(var u=0,a=o.length;u<a;u++)di(o[u],n,r,i,s)}function mi(e,r,i,s,u){if(!s&&u.isVisible(e)==0)return;if(e instanceof n.Billboard){var a=r.matrixPosition;a.setFromMatrixPosition(e.worldMatrix);var l=r.ray.distanceToPoint(a),c=e.material.alignment,h=new n.Plane(1,1);if(c.x||c.y)h.setPosition(c.x,c.y,0),h=n.Utils.transformElement(h,!0);h.setPosition(a);var p=(new f).getScaleFromMatrix(e.worldMatrix);h.setScale(p.x,p.y,1);var d=r.direction.clone(),v=h.getPosition().clone(),m=e.material;m&&m.vertical&&(d.y=0),v.sub(d),h.lookAt(v),h.updateWorldMatrix(!0);var g=[];return mi(h,r,g,!0,u),g.length===0?i:(i.push({distance:g[0].distance,point:e._position,face:null,object:e,element:e}),i)}if(e instanceof n.Line){var y=1;y-=1;var b=Math.sqrt(r.linePrecision+y),w=b*b,E=e;E.boundingSphere==null&&E.computeBoundingSphere(),hi.copy(E.boundingSphere),hi.applyMatrix4(e.worldMatrix);if(r.ray.isIntersectionSphere(hi)===!1)return i;fi.getInverse(e.worldMatrix),ai.copy(r.ray).transform(fi);var S=E.vertices,x=S.length,T=new f,N=new f,C=e.type===n.LineStrip?1:2;for(var k=0;k<x-1;k+=C){var L=ai.distanceSqToSegment(S[k],S[k+1],N,T);if(L>w)continue;var l=ai.origin.distanceTo(N);if(l<r.near||l>r.far)continue;i.push({distance:l,point:T.clone().applyMatrix4(e.worldMatrix),face:null,faceIndex:null,element:e,object:e})}return i}e.boundingSphere===null&&e.computeBoundingSphere(),hi.set(e.worldMatrix.getPosition(),e.boundingSphere.radius*e.worldMatrix.getMaxScaleOnAxis());if(!r.ray.isIntersectionSphere(hi))return i;var E=e,S=E.vertices,A=e.material instanceof n.ArrayMaterial,O=A===!0?e.material.materials:null,M=e.material.side,_,D,P,B,j,F,I,b=r.precision;e.rotationWorldMatrix.extractRotation(e.worldMatrix),fi.getInverse(e.worldMatrix),ai.copy(r.ray).transform(fi);for(var q=0,R=E.faces.length;q<R;q++){var U=E.faces[q],z=A===!0?O[U.materialIndex]:e.material,W=u.getOverLoadMaterial(e,z);W&&(z=W);if(z===t||z.visible===!1||E.visible===!1&&!s)continue;if(z.transparent&&z.opacity==0)continue;li.setFromNormalAndCoplanarPoint(U.normal,S[U.a]);var X=ai.distanceToPlane(li);if(Math.abs(X)<b)continue;if(X<0)continue;M=z.side;var V=ai.direction.dot(li.normal);if(M!==n.DoubleSide&&!(M===n.FrontSide?V<0:V>0))continue;if(X<r.near||X>r.far)continue;ci=ai.at(X,ci);var $=new f,J=U.materialIndex,K=!1,Q;u&&u._selectTransparencyThreshold>0&&(K=z.transparent==1||z.alphaTest>0);if(U instanceof n.Face3){_=S[U.a],D=S[U.b],P=S[U.c];if(!n.Triangle.containsPoint(ci,_,D,P))continue;$=n.Triangle.barycoordFromPoint(ci,_,D,P)}else{if(!(U instanceof n.Face4))throw Error("face type not supported");_=S[U.a],D=S[U.b],P=S[U.c],B=S[U.d];var G=n.Triangle.containsPoint(ci,_,D,B),Y=n.Triangle.containsPoint(ci,D,P,B);if(!G&&!Y)continue;G?$=n.Triangle.barycoordFromPoint(ci,_,D,B):($=n.Triangle.barycoordFromPoint(ci,D,P,B),Q=!0)}var Z=new o,et=$.z,tt=$.x,nt=$.y;if(E.uvs&&E.uvs[q]){var rt=E.uvs[q];U instanceof n.Face3?(Z.x=rt[0].x*tt+rt[1].x*nt+rt[2].x*et,Z.y=rt[0].y*tt+rt[1].y*nt+rt[2].y*et):Q?(Z.x=rt[1].x*tt+rt[2].x*nt+rt[3].x*et,Z.y=rt[1].y*tt+rt[2].y*nt+rt[3].y*et):(Z.x=rt[0].x*tt+rt[1].x*nt+rt[3].x*et,Z.y=rt[0].y*tt+rt[1].y*nt+rt[3].y*et)}var it=1,st;Z=u.debugUV||Z;if(K){if(z.opacity<u._selectTransparencyThreshold)continue;if(z.map==null)it=z.opacity;else if(u._pickingTexturePixel){st=z.map._image;var ot=H.getPixelFromImage(st,Z.x,Z.y);it=ot[3]/255*(z.opacity==null?1:z.opacity)}it<z.alphaTest?it=0:z.transparent==0&&(it=1)}if(it<u._selectTransparencyThreshold)continue;i.push({distance:X,point:r.ray.at(X),face:U,uv:Z,faceIndex:q,element:e,object:e,side:V>0?1:-1})}}function ki(e){if(!Hi[e.id]){ji=!0,Hi[e.id]=e,e.finish=e.finish==null?e.delay+e.dur+e.interval:e.finish;if(e.from==null&&e.attr&&e.source){var t;(t=e.attr.match(/^S[:@](.*)/i))?e.from=e.source.getStyle(t[1]):(t=e.attr.match(/^C[:@](.*)/i))?e.from=e.source.getClient(t[1]):e.from=mono.getValue(e.source,e.attr)}Li(e),Ai(e)}return e}function Li(e){var t=e.type,n=e.from,r=e.to;t==="number"?(e.from=n||0,e.to=r||0):t==="point"?(n?n.length&&(e.from={x:n[0],y:n[1]}):e.from=e.attr==="scale"?{x:1,y:1}:{x:0,y:0},r?r.length&&(e.to={x:r[0],y:r[1]}):e.to=e.attr==="scale"?{x:1,y:1}:{x:0,y:0}):t==="rect"?(n?n.length&&(e.from={x:n[0],y:n[1],w:n[2],h:n[3]}):e.from={x:0,y:0,w:0,h:0},r?r.length&&(e.to={x:r[0],y:r[1],w:r[2],h:r[3]}):e.to={x:0,y:0,w:0,h:0}):t==="color"?(e.from=getColorValue(n),e.to=getColorValue(r)):t!=="set"&&t==="group_set",e.current=e.from}function Ai(e){var t=e.type,n=e.from,r=e.to;t==="number"?e.delta=r-n:t==="point"?e.delta={x:r.x-n.x,y:r.y-n.y}:t==="rect"?e.delta={x:r.x-n.x,y:r.y-n.y,w:r.w-n.w,h:r.h-n.h}:t==="color"?e.delta={r:r.r-n.r,g:r.g-n.g,b:r.b-n.b,a:r.a-n.a}:t!=="set"&&t==="group_set"}function Oi(e,t){return Hi[e.id]&&(t==null&&(t=!0),t&&Pi(e,e.to),e.onStop&&e.onStop(),e.time=0,e.total=0,e.start=null,e.count=0,e.started=!1,e.stopped=!1,delete Hi[e.id]),e}function Mi(e){e==null&&(e=!0),Object.keys(Hi).forEach(function(t){var n=Hi[t];e&&Pi(n,n.to),n.onStop&&n.onStop()}),Hi={}}function _i(e){Object.keys(Hi).forEach(function(t){var n=Hi[t];if(!n)return;n.start==null&&(n.start=e),n.total=e-n.start;if(n.total>n.delay){n.time=n.total-n.delay;var r=!1;n.time>=n.dur&&(n.time=n.dur,r=!0),!n.stopped&&Pi(n,Di(n)),n.stopped=r;if(n.total>=n.finish){n.count++;if(n.count>=n.repeat)Oi(n,!1),n.onDone&&n.onDone();else{n.time=0,n.total=0,n.start=null,n.stopped=!1;if(n.reverse){var i=n.from;n.from=n.to,n.to=i,Ai(n)}}}}!ji&&(ji=!0)})}function Di(e,t){var n=e.type,r=e.delta,i=e.from,s=e.time,o=e.dur,u=N[e.easing||"easeNone"];return u||(u=N.easeNone),n==="number"?t=u(s,i,r,o):n==="point"?t={x:u(s,i.x,r.x,o),y:u(s,i.y,r.y,o)}:n==="rect"?t={x:u(s,i.x,r.x,o),y:u(s,i.y,r.y,o),w:u(s,i.w,r.w,o),h:u(s,i.h,r.h,o)}:n==="color"?t="rgba("+Math.floor(u(s,i.r,r.r,o))+","+Math.floor(u(s,i.g,r.g,o))+","+Math.floor(u(s,i.b,r.b,o))+","+Math.floor(u(s,i.a,r.a,o))+")":n==="set"?e.time&&(t=e.to):n==="group_set"&&(t=e.to[e.groupIndex]),e.current=t,t}function Pi(e,t){e.started||(e.started=!0,e.onPlay&&e.onPlay()),e.filter&&(t=e.filter(t));if(e.attr&&e.source){var n;(n=e.attr.match(/^S[:@](.*)/i))?e.source.setStyle(n[1],t):(n=e.attr.match(/^C[:@](.*)/i))?e.source.setClient(n[1],t):mono.setValue(e.source,e.attr,t)}e.onUpdate&&e.onUpdate(t)}self.Int32Array=self.Int32Array||Array,self.Float32Array=self.Float32Array||Array,Number.isNaN||(Number.isNaN=function(e){return typeof e=="number"&&isNaN(e)}),Object.create=Object.create||function(e){var t=function(){};return t.prototype=e,new t};var n={version:"2.6.2",_id:["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],id:function(e){e=e==null?"":e;var t=[];for(var n=0;n<32;n++)t[n]=this._id[Math.floor(Math.random()*16)];return t[12]="4",t[16]=this._id[t[16]&3|8],e+t.join("")},ip:function(e,t,r,i){var s=r+t;e[n.getter(t,i)]=function(){return this[s]},e[n.setter(t)]=function(e){var n=this[s];if(n===e)return;this.setPropertyValue?this.setPropertyValue(s,e)&&(this.onPropertyChange(t,n,e),this.firePropertyChange(t,n,e)):(this[s]=e,this.onPropertyChange(t,n,e),this.firePropertyChange(t,n,e))}},getter:function(e,t){var n=e.charAt(0).toUpperCase()+e.slice(1),r=/ble$/.test(e)||/ed$/.test(e)?"is":"get";return t&&t.indexOf(e)!=-1&&(r="is"),r+n},setter:function(e){var t=e.charAt(0).toUpperCase()+e.slice(1);return"set"+t},getValue:function(e,t,n){var r=t.charAt(0).toUpperCase()+t.slice(1),i="get"+r,s="is"+r;return n?n==="boolean"?e[s]():(e[i]==null&&console.log("get Function "+i+" not exist"),e[i]()):e[i]?e[i]():e[s]?e[s]():e[t]},setValue:function(e,t,n){e["set"+t.charAt(0).toUpperCase()+t.slice(1)](n)},clone:function(e){if(!e)return null;var t={};for(var n in e)t[n]=e[n];return t},addMethod:function(e,t){var n=e.prototype;for(var r in t)n[r]=t[r]},classCache:{},getClass:function(t){var r=n.classCache[t];if(!r){var i=t.split("."),s=i.length;r=e;for(var o=0;o<s;o++)r=r[i[o]];n.classCache[t]=r}return r},newInstance:function(e){typeof e=="string"&&(e=n.getClass(e),e=e.prototype);var t=e.constructor;if(!t)return null;var r=arguments.length,i=arguments;if(r===1)return new t;if(r===2)return new t(i[1]);if(r===3)return new t(i[1],i[2]);if(r===4)return new t(i[1],i[2],i[3]);if(r===5)return new t(i[1],i[2],i[3],i[4]);if(r===6)return new t(i[1],i[2],i[3],i[4],i[5]);if(r===7)return new t(i[1],i[2],i[3],i[4],i[5],i[6]);if(r===8)return new t(i[1],i[2],i[3],i[4],i[5],i[6],i[7]);throw"don't support args more than 7"},xml:function(t){if(e.DOMParser)return(new DOMParser).parseFromString(t,"text/xml");var n=new ActiveXObject("Microsoft.XmlDOM");return n.async=!1,n.loadXml(t),n}};typeof define=="function"?define(function(){return n}):typeof exports=="object"&&(module.exports=n),e&&(e.TGL=e.mono=n);var r={};n.extend=function(e,t,r){if(t){var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e,e.superClass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)}var s=e.prototype;if(r){s.getClassName=function(){return r.className};for(var o in r){if(o==="__accessor"){var u=r.__accessor,a=r.__bool;for(var f=0;f<u.length;f++){var l=u[f];n.ip(s,l,"",a)}}else if(o==="___accessor"){var u=r.___accessor;for(var f=0;f<u.length;f++){var l=u[f];n.ip(s,l,"_",a)}}s[o]=r[o]}r.constructor&&(s.newInstance=function(){return n.newInstance(this)})}},n.defaultEulerOrder="XYZ",String.prototype.startsWith=String.prototype.startsWith||function(e){return this.slice(0,e.length)===e},String.prototype.endsWith=String.prototype.endsWith||function(e){var t=String(e),n=this.lastIndexOf(t);return(-1<n&&n)===this.length-t.length},String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},function(){var n=0,r=["ms","moz","webkit","o"];for(var i=0;i<r.length&&!e.requestAnimationFrame;++i)e.requestAnimationFrame=e[r[i]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[r[i]+"CancelAnimationFrame"]||e[r[i]+"CancelRequestAnimationFrame"];e.requestAnimationFrame===t&&(e.requestAnimationFrame=function(t,r){var i=Date.now(),s=Math.max(0,16-(i-n)),o=e.setTimeout(function(){t(i+s)},s);return n=i+s,o}),e.cancelAnimationFrame=e.cancelAnimationFrame||function(t){e.clearTimeout(t)}}(),n.CullFaceNone=0,n.CullFaceBack=1,n.CullFaceFront=2,n.CullFaceFrontBack=3,n.FrontFaceDirectionCW=0,n.FrontFaceDirectionCCW=1,n.BasicShadowMap=0,n.PCFShadowMap=1,n.PCFSoftShadowMap=2,n.FrontSide="front",n.BackSide="back",n.DoubleSide="both"
,n.BothSide="both",n.NoShading=0,n.FlatShading=1,n.SmoothShading=2,n.NormalTypeFlat="flat",n.NormalTypeSmooth="smooth",n.NoColors=0,n.FaceColors=1,n.VertexColors=2,n.GradientColors=3,n.NoBlending=0,n.NormalBlending=1,n.AdditiveBlending=2,n.SubtractiveBlending=3,n.MultiplyBlending=4,n.CustomBlending=5,n.AddEquation=100,n.SubtractEquation=101,n.ReverseSubtractEquation=102,n.ZeroFactor=200,n.OneFactor=201,n.SrcColorFactor=202,n.OneMinusSrcColorFactor=203,n.SrcAlphaFactor=204,n.OneMinusSrcAlphaFactor=205,n.DstAlphaFactor=206,n.OneMinusDstAlphaFactor=207,n.DstColorFactor=208,n.OneMinusDstColorFactor=209,n.SrcAlphaSaturateFactor=210,n.MultiplyOperation=0,n.MixOperation=1,n.AddOperation=2,n.UVMapping=function(){},n.CubeReflectionMapping=function(){},n.CubeRefractionMapping=function(){},n.SphericalReflectionMapping=function(){},n.SphericalRefractionMapping=function(){},n.RepeatWrapping="repeat",n.ClampToEdgeWrapping="clamp",n.MirroredRepeatWrapping="mirrored",n.NearestFilter=1003,n.NearestMipMapNearestFilter=1004,n.NearestMipMapLinearFilter=1005,n.LinearFilter=1006,n.LinearMipMapNearestFilter=1007,n.LinearMipMapLinearFilter=1008,n.UnsignedByteType=1009,n.ByteType=1010,n.ShortType=1011,n.UnsignedShortType=1012,n.IntType=1013,n.UnsignedIntType=1014,n.FloatType=1015,n.UnsignedShort4444Type=1016,n.UnsignedShort5551Type=1017,n.UnsignedShort565Type=1018,n.AlphaFormat=1019,n.RGBFormat=1020,n.RGBAFormat=1021,n.LuminanceFormat=1022,n.LuminanceAlphaFormat=1023,n.RGB_S3TC_DXT1_Format=2001,n.RGBA_S3TC_DXT1_Format=2002,n.RGBA_S3TC_DXT3_Format=2003,n.RGBA_S3TC_DXT5_Format=2004,n.Gradient_Linear_U=1,n.Gradient_Linear_V=2,n.Gradient_Linear_UV=3,n.Gradient_Linear_NUV=4,n.Gradient_Radial=5,n.Gradient_Sweep=6,n.Math={clamp:function(e,t,n){return e<t?t:e>n?n:e},isConcave:function(e,t,n){var r=n?1:-1;return(e.x*t.y-t.x*e.y)*r<0?!0:!1},area:function(e,n,r,i){var s=i?1:-1;if(!e||!n||!r)return t;var o=-e.x*n.y-n.x*r.y-r.x*e.y+r.x*n.y+n.x*e.y+e.x*r.y;return o*s},isClockwise:function(e,t,n){t=t||"x",n=n||"y";var r=0,i=e.length;for(var s=0;s<i;s++){var o=e[s],u=e[s+1===i?0:s+1];r+=(u[t]-o[t])*(u[n]+o[n])}return r<0},isClockwise3:function(e,t,n){var r=(new mono.Vec3).crossVectors(e,t),i=(new mono.Vec3).subVectors(t,e),s=(new mono.Vec3).subVectors(t,e)},clampBottom:function(e,t){return e<t?t:e},mapLinear:function(e,t,n,r,i){return r+(e-t)*(i-r)/(n-t)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return e<0?-1:e>0?1:0},degToRad:function(e){return e*n.Math.__d2r},radToDeg:function(e){return e*n.Math.__r2d},smoothstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t),e*e*(3-2*e))},smootherstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t),e*e*e*(e*(e*6-15)+10))},PI2:Math.PI*2,generateUUID:function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),t=new Array(36),n=0,r;return function(){for(var i=0;i<36;i++)i==8||i==13||i==18||i==23?t[i]="-":i==14?t[i]="4":(n<=2&&(n=33554432+Math.random()*16777216|0),r=n&15,n>>=4,t[i]=e[i==19?r&3|8:r]);return t.join("")}}()},n.Math.__d2r=Math.PI/180,n.Math.__r2d=180/Math.PI,n.Quat=function(e,n,r,i){this.x=e||0,this.y=n||0,this.z=r||0,this.w=i!==t?i:1},n.Quat.prototype={constructor:n.Quat,set:function(e,t,n,r){return this.x=e,this.y=t,this.z=n,this.w=r,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},setFromEuler:function(e,n){var r=Math.cos(e.x/2),i=Math.cos(e.y/2),s=Math.cos(e.z/2),o=Math.sin(e.x/2),u=Math.sin(e.y/2),a=Math.sin(e.z/2);return n===t||n==="XYZ"?(this.x=o*i*s+r*u*a,this.y=r*u*s-o*i*a,this.z=r*i*a+o*u*s,this.w=r*i*s-o*u*a):n==="YXZ"?(this.x=o*i*s+r*u*a,this.y=r*u*s-o*i*a,this.z=r*i*a-o*u*s,this.w=r*i*s+o*u*a):n==="ZXY"?(this.x=o*i*s-r*u*a,this.y=r*u*s+o*i*a,this.z=r*i*a+o*u*s,this.w=r*i*s-o*u*a):n==="ZYX"?(this.x=o*i*s-r*u*a,this.y=r*u*s+o*i*a,this.z=r*i*a-o*u*s,this.w=r*i*s+o*u*a):n==="YZX"?(this.x=o*i*s+r*u*a,this.y=r*u*s+o*i*a,this.z=r*i*a-o*u*s,this.w=r*i*s-o*u*a):n==="XZY"&&(this.x=o*i*s-r*u*a,this.y=r*u*s-o*i*a,this.z=r*i*a+o*u*s,this.w=r*i*s+o*u*a),this},setFromAxisAngle:function(e,t){var n=t/2,r=Math.sin(n);return this.x=e.x*r,this.y=e.y*r,this.z=e.z*r,this.w=Math.cos(n),this},setFromRotationMatrix:function(e){var t=e.elements,n=t[0],r=t[4],i=t[8],s=t[1],o=t[5],u=t[9],a=t[2],f=t[6],l=t[10],c=n+o+l,h;return c>0?(h=.5/Math.sqrt(c+1),this.w=.25/h,this.x=(f-u)*h,this.y=(i-a)*h,this.z=(s-r)*h):n>o&&n>l?(h=2*Math.sqrt(1+n-o-l),this.w=(f-u)/h,this.x=.25*h,this.y=(r+s)/h,this.z=(i+a)/h):o>l?(h=2*Math.sqrt(1+o-n-l),this.w=(i-a)/h,this.x=(r+s)/h,this.y=.25*h,this.z=(u+f)/h):(h=2*Math.sqrt(1+l-n-o),this.w=(s-r)/h,this.x=(i+a)/h,this.y=(u+f)/h,this.z=.25*h),this},inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var e=this.length();return e===0?(this.x=0,this.y=0,this.z=0,this.w=1):(e=1/e,this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e),this},multiply:function(e){return this.multiplyQuaternions(this,e)},multiplyQuaternions:function(e,t){var n=e.x,r=e.y,i=e.z,s=e.w,o=t.x,u=t.y,a=t.z,f=t.w;return this.x=n*f+s*o+r*a-i*u,this.y=r*f+s*u+i*o-n*a,this.z=i*f+s*a+n*u-r*o,this.w=s*f-n*o-r*u-i*a,this},multiplyVector3:function(e){return console.warn("DEPRECATED: Quat's .multiplyVector3() has been removed. Use is now vector.applyQuaternion( Quat ) instead."),e.applyQuaternion(this)},slerp:function(e,t){var n=this.x,r=this.y,i=this.z,s=this.w,o=s*e.w+n*e.x+r*e.y+i*e.z;o<0?(this.w=-e.w,this.x=-e.x,this.y=-e.y,this.z=-e.z,o=-o):this.copy(e);if(o>=1)return this.w=s,this.x=n,this.y=r,this.z=i,this;var u=Math.acos(o),a=Math.sqrt(1-o*o);if(Math.abs(a)<.001)return this.w=.5*(s+this.w),this.x=.5*(n+this.x),this.y=.5*(r+this.y),this.z=.5*(i+this.z),this;var f=Math.sin((1-t)*u)/a,l=Math.sin(t*u)/a;return this.w=s*f+this.w*l,this.x=n*f+this.x*l,this.y=r*f+this.y*l,this.z=i*f+this.z*l,this},toEuler:function(){var e=this.w*this.w,t=this.x*this.x,n=this.y*this.y,r=this.z*this.z,i=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-t-n+r+e),s=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),o=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),t-n-r+e);return[i,s,o]},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},clone:function(){return new n.Quat(this.x,this.y,this.z,this.w)}},n.Quat.slerp=function(e,t,n,r){return n.copy(e).slerp(t,r)};var o=function(e,t){this.x=e||0,this.y=t||0};o.prototype={constructor:o,set:function(e,t){return this.x=e,this.y=t,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e){return this.x+=e.x,this.y+=e.y,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScalar:function(e){return this.x+=e,this.y+=e,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},divideScalar:function(e){return e!==0?(this.x/=e,this.y/=e):this.set(0,0),this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y;return t*t+n*n},setLength:function(e){var t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},equals:function(e){return e==null?!1:e.x===this.x&&e.y===this.y},clone:function(){return new o(this.x,this.y)}},n.Vec2=o;var f=function(e,t,n){this.x=parseFloat(e)||0,this.y=parseFloat(t)||0,this.z=parseFloat(n)||0};n.Vec3=f,f.prototype={set:function(e,t,n){return this.x=e,this.y=t,this.z=n,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},center:function(e,t){return this.x=(e.x+t.x)/2,this.y=(e.y+t.y)/2,this.z=(e.z+t.z)/2,this},copy:function(e){return(this==null||e==null)&&console.log("TGL.Vec3.copy this : "+this+" v : "+e),this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyMatrix3:function(e){var t=this.x,n=this.y,r=this.z,i=e.elements;return this.x=i[0]*t+i[3]*n+i[6]*r,this.y=i[1]*t+i[4]*n+i[7]*r,this.z=i[2]*t+i[5]*n+i[8]*r,this},applyMatrix4:function(e){var t=this.x,n=this.y,r=this.z,i=e.elements,s=1/(i[3]*t+i[7]*n+i[11]*r+i[15]);return this.x=(i[0]*t+i[4]*n+i[8]*r+i[12])*s,this.y=(i[1]*t+i[5]*n+i[9]*r+i[13])*s,this.z=(i[2]*t+i[6]*n+i[10]*r+i[14])*s,this},applyProjection:function(e){var t=this.x,n=this.y,r=this.z,i=e.elements,s=1/(i[3]*t+i[7]*n+i[11]*r+i[15]);return this.x=(i[0]*t+i[4]*n+i[8]*r+i[12])*s,this.y=(i[1]*t+i[5]*n+i[9]*r+i[13])*s,this.z=(i[2]*t+i[6]*n+i[10]*r+i[14])*s,this},applyQuaternion:function(e){var t=this.x,n=this.y,r=this.z,i=e.x,s=e.y,o=e.z,u=e.w,a=u*t+s*r-o*n,f=u*n+o*t-i*r,l=u*r+i*n-s*t,c=-i*t-s*n-o*r;return this.x=a*u+c*-i+f*-o-l*-s,this.y=f*u+c*-s+l*-i-a*-o,this.z=l*u+c*-o+a*-s-f*-i,this},applyEuler:function(e,t){var n=f.__q1.setFromEuler(e,t);return this.applyQuaternion(n),this},applyAxisAngle:function(e,t){var n=f.__q1.setFromAxisAngle(e,t);return this.applyQuaternion(n),this},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return e!==0?(this.x/=e,this.y/=e,this.z/=e):(this.x=0,this.y=0,this.z=0),this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this},cross:function(e){var t=this.x,n=this.y,r=this.z;return this.x=n*e.z-r*e.y,this.y=r*e.x-t*e.z,this.z=t*e.y-n*e.x,this},crossVectors:function(e,t){return this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this},angleTo:function(e){return Math.acos(this.dot(e)/this.length()/e.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y,r=this.z-e.z;return t*t+n*n+r*r},getPositionFromMatrix:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},setEulerFromRotationMatrix:function(e,n){function r(e){return Math.min(Math.max(e,-1),1)}var i=e.elements,s=i[0],o=i[4],u=i[8],a=i[1],f=i[5],l=i[9],c=i[2],h=i[6],p=i[10];return n===t||n==="XYZ"?(this.y=Math.asin(r(u)),Math.abs(u)<.99999?(this.x=Math.atan2(-l,p),this.z=Math.atan2(-o,s)):(this.x=Math.atan2(h,f),this.z=0)):n==="YXZ"?(this.x=Math.asin(-r(l)),Math.abs(l)<.99999?(this.y=Math.atan2(u,p),this.z=Math.atan2(a,f)):(this.y=Math.atan2(-c,s),this.z=0)):n==="ZXY"?(this.x=Math.asin(r(h)),Math.abs(h)<.99999?(this.y=Math.atan2(-c,p),this.z=Math.atan2(-o,f)):(this.y=0,this.z=Math.atan2(a,s))):n==="ZYX"?(this.y=Math.asin(-r(c)),Math.abs(c)<.99999?(this.x=Math.atan2(h,p),this.z=Math.atan2(a,s)):(this.x=0,this.z=Math.atan2(-o,f))):n==="YZX"?(this.z=Math.asin(r(a)),Math.abs(a)<.99999?(this.x=Math.atan2(-l,f),this.y=Math.atan2(-c,s)):(this.x=0,this.y=Math.atan2(u,p))):n==="XZY"&&(this.z=Math.asin(-r(o)),Math.abs(o)<.99999?(this.x=Math.atan2(h,f),this.y=Math.atan2(u,s)):(this.x=Math.atan2(-l,p),this.y=0)),this},setEulerFromQuaternion:function(e,n){function r(e){return Math.min(Math.max(e,-1),1)}var i=e.x*e.x,s=e.y*e.y,o=e.z*e.z,u=e.w*e.w;return n===t||n==="XYZ"?(this.x=Math.atan2(2*(e.x*e.w-e.y*e.z),u-i-s+o),this.y=Math.asin(r(2*(e.x*e.z+e.y*e.w))),this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),u+i-s-o)):n==="YXZ"?(this.x=Math.asin(r(2*(e.x*e.w-e.y*e.z))),this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),u-i-s+o),this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),u-i+s-o)):n==="ZXY"?(this.x=Math.asin(r(2*(e.x*e.w+e.y*e.z))),this.y=Math.atan2(2*(e.y*e.w-e.z*e.x),u-i-s+o),this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),u-i+s-o)):n==="ZYX"?(this.x=Math.atan2(2*(e.x*e.w+e.z*e.y),u-i-s+o),this.y=Math.asin(r(2*(e.y*e.w-e.x*e.z))),this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),u+i-s-o)):n==="YZX"?(this.x=Math.atan2(2*(e.x*e.w-e.z*e.y),u-i+s-o),this.y=Math.atan2(2*(e.y*e.w-e.x*e.z),u+i-s-o),this.z=Math.asin(r(2*(e.x*e.y+e.z*e.w)))):n==="XZY"&&(this.x=Math.atan2(2*(e.x*e.w+e.y*e.z),u-i+s-o),this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),u+i-s-o),this.z=Math.asin(r(2*(e.z*e.w-e.x*e.y)))),this},getScaleFromMatrix:function(e){var t=this.set(e.elements[0],e.elements[1],e.elements[2]).length(),n=this.set(e.elements[4],e.elements[5],e.elements[6]).length(),r=this.set(e.elements[8],e.elements[9],e.elements[10]).length();return this.x=t,this.y=n,this.z=r,this},toString:function(){return this.x+"_"+this.y+"_"+this.z},equals:function(e){return e==null?!1:e.x===this.x&&e.y===this.y&&e.z===this.z},clone:function(){return new f(this.x,this.y,this.z)},setFromMatrixPosition:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},rotateFromAxisAndCenter:function(e,t,r){var i=(new n.Mat4).makeRotationAxisAndCenter(e,t,r);return this.applyMatrix4(i),this},rotationTowards:function(e,t){var r=(new n.Mat4).rotationTowards(e,t);return this.setEulerFromRotationMatrix(r),this},constructor:n.Vec3},f.__q1=new n.Quat,n.Vec4=function(e,n,r,i){this.x=e||0,this.y=n||0,this.z=r||0,this.w=i!==t?i:1},n.Vec4.prototype={constructor:n.Vec4,set:function(e,t,n,r){return this.x=e,this.y=t,this.z=n,this.w=r,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==t?e.w:1,this},add:function(e,n){return n!==t?(console.warn("DEPRECATED: Vec4's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,n)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},sub:function(e,n){return n!==t?(console.warn("DEPRECATED: Vec4's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,n)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,n=this.y,r=this.z,i=this.w,s=e.elements;return this.x=s[0]*t+s[4]*n+s[8]*r+s[12]*i,this.y=s[1]*t+s[5]*n+s[9]*r+s[13]*i,this.z=s[2]*t+s[6]*n+s[10]*r+s[14]*i,this.w=s[3]*t+s[7]*n+s[11]*r+s[15]*i,this},divideScalar:function(e){return e!==0?(this.x/=e,this.y/=e,this.z/=e,this.w/=e):(this.x=0,this.y=0,this.z=0,this.w=1),this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this.w>e.w&&(this.w=e.w),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this.w<e.w&&(this.w=e.w),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this.w<e.w?this.w=e.w:this.w>t.w&&(this.w=t.w),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},clone:function(){return new n.Vec4(this.x,this.y,this.z,this.w)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,n,r,i,s=.01,o=.1,u=e.elements,a=u[0],f=u[4],l=u[8],c=u[1],h=u[5],p=u[9],d=u[2],v=u[6],m=u[10];if(Math.abs(f-c)<s&&Math.abs(l-d)<s&&Math.abs(p-v)<s){if(Math.abs(f+c)<o&&Math.abs(l+d)<o&&Math.abs(p+v)<o&&Math.abs(a+h+m-3)<o)return this.set(1,0,0,0),this;t=Math.PI;var g=(a+1)/2,y=(h+1)/2,b=(m+1)/2,w=(f+c)/4,E=(l+d)/4,S=(p+v)/4;return g>y&&g>b?g<s?(n=0,r=.707106781,i=.707106781):(n=Math.sqrt(g),r=w/n,i=E/n):y>b?y<s?(n=.707106781,r=0,i=.707106781):(r=Math.sqrt(y),n=w/r,i=S/r):b<s?(n=.707106781,r=.707106781,i=0):(i=Math.sqrt(b),n=E/i,r=S/i),this.set(n,r,i,t),this}var x=Math.sqrt((v-p)*(v-p)+(l-d)*(l-d)+(c-f)*(c-f));return Math.abs(x)<.001&&(x=1),this.x=(v-p)/x,this.y=(l-d)/x,this.z=(c-f)/x,this.w=Math.acos((a+h+m-1)/2),this}};var l=function(e,n,r,i,s,o,u,a,f){this.elements=new Float32Array(9),this.set(e!==t?e:1,n||0,r||0,i||0,s!==t?s:1,o||0,u||0,a||0,f!==t?f:1)};l.prototype={constructor:l,set:function(e,t,n,r,i,s,o,u,a){var f=this.elements;return f[0]=e,f[3]=t,f[6]=n,f[1]=r,f[4]=i,f[7]=s,f[2]=o,f[5]=u,f[8]=a,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},copy:function(e){var t=e.elements;return this.set(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]),this},multiplyVector3:function(e){return console.warn("DEPRECATED: Mat3's .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(){var e=new f;return function(t){for(var n=0,r=t.length;n<r;n+=3)e.x=t[n],e.y=t[n+1],e.z=t[n+2],e.applyMatrix3(this),t[n]=e.x,t[n+1]=e.y,t[n+2]=e.z;return t}}(),multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8];return t*s*f-t*o*a-n*i*f+n*o*u+r*i*a-r*s*u},getInverse:function(e,t){var n=e.elements,r=this.elements;r[0]=n[10]*n[5]-n[6]*n[9],r[1]=-n[10]*n[1]+n[2]*n[9],r[2]=n[6]*n[1]-n[2]*n[5],r[3]=-n[10]*n[4]+n[6]*n[8],r[4]=n[10]*n[0]-n[2]*n[8],r[5]=-n[6]*n[0]+n[2]*n[4],r[6]=n[9]*n[4]-n[5]*n[8],r[7]=-n[9]*n[0]+n[1]*n[8],r[8]=n[5]*n[0]-n[1]*n[4];var i=n[0]*r[0]+n[1]*r[3]+n[2]*r[6];if(i===0){var s="Mat3.getInverse(): can't invert matrix, determinant is 0";if(t||!1)throw new Error(s);return console.warn(s),this.identity(),this}return this.multiplyScalar(1/i),this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.getInverse(e).transpose(),this},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},clone:function(){var e=this.elements;return new l(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8])}},n.Mat3=l;var h=function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){this.elements=new Float32Array(16),this.set(e!==t?e:1,n||0,r||0,i||0,s||0,o!==t?o:1,u||0,a||0,f||0,l||0,c!==t?c:1,h||0,p||0,d||0,v||0,m!==t?m:1)};h.prototype={constructor:h,set:function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m=this.elements;if(e.length)for(var g=0;g<e.length;g++)m[g]=e[g];else m[0]=e,m[4]=t,m[8]=n,m[12]=r,m[1]=i,m[5]=s,m[9]=o,m[13]=u,m[2]=a,m[6]=f,m[10]=l,m[14]=c,m[3]=h,m[7]=p,m[11]=d,m[15]=v;return this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]),this},setRotationFromEuler:function(e,n){var r=this.elements,i=e.x,s=e.y,o=e.z,u=Math.cos(i),a=Math.sin(i),f=Math.cos(s),l=Math.sin(s),c=Math.cos(o),h=Math.sin(o);if(n===t||n==="XYZ"){var p=u*c,d=u*h,v=a*c,m=a*h;r[0]=f*c,r[4]=-f*h,r[8]=l,r[1]=d+v*l,r[5]=p-m*l,r[9]=-a*f,r[2]=m-p*l,r[6]=v+d*l,r[10]=u*f}else if(n==="YXZ"){var g=f*c,y=f*h,b=l*c,w=l*h;r[0]=g+w*a,r[4]=b*a-y,r[8]=u*l,r[1]=u*h,r[5]=u*c,r[9]=-a,r[2]=y*a-b,r[6]=w+g*a,r[10]=u*f}else if(n==="ZXY"){var g=f*c,y=f*h,b=l*c,w=l*h;r[0]=g-w*a,r[4]=-u*h,r[8]=b+y*a,r[1]=y+b*a,r[5]=u*c,r[9]=w-g*a,r[2]=-u*l,r[6]=a,r[10]=u*f}else if(n==="ZYX"){var p=u*c,d=u*h,v=a*c,m=a*h;r[0]=f*c,r[4]=v*l-d,r[8]=p*l+m,r[1]=f*h,r[5]=m*l+p,r[9]=d*l-v,r[2]=-l,r[6]=a*f,r[10]=u*f}else if(n==="YZX"){var E=u*f,S=u*l,x=a*f,T=a*l;r[0]=f*c,r[4]=T-E*h,r[8]=x*h+S,r[1]=h,r[5]=u*c,r[9]=-a*c,r[2]=-l*c,r[6]=S*h+x,r[10]=E-T*h}else if(n==="XZY"){var E=u*f,S=u*l,x=a*f,T=a*l;r[0]=f*c,r[4]=-h,r[8]=l*c,r[1]=E*h+T,r[5]=u*c,r[9]=S*h-x,r[2]=x*h-S,r[6]=a*c,r[10]=T*h+E}return this},setRotationFromQuaternion:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z,s=e.w,o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,p=r*a,d=i*a,v=s*o,m=s*u,g=s*a;return t[0]=1-(h+d),t[4]=l-g,t[8]=c+m,t[1]=l+g,t[5]=1-(f+d),t[9]=p-v,t[2]=c-m,t[6]=p+v,t[10]=1-(f+h),this},lookAt:function(e,t,n){var r=this.elements,i=h.__v1,s=h.__v2,o=h.__v3;return o.subVectors(e,t).normalize(),o.length()===0&&(o.z=1),i.crossVectors(n,o).normalize(),i.length()===0&&(o.x+=1e-4,i.crossVectors(n,o).normalize()),s.crossVectors(o,i),r[0]=i.x,r[1]=i.y,r[2]=i.z,r[4]=s.x,r[5]=s.y,r[6]=s.z,r[8]=o.x,r[9]=o.y,r[10]=o.z,this},multiply:function(e,n){return n!==t?this.multiplyMatrices(e,n):this.multiplyMatrices(this,e)},multiplyMatrices:function(e,t){var n=e.elements,r=t.elements,i=this.elements,s=n[0],o=n[4],u=n[8],a=n[12],f=n[1],l=n[5],c=n[9],h=n[13],p=n[2],d=n[6],v=n[10],m=n[14],g=n[3],y=n[7],b=n[11],w=n[15],E=r[0],S=r[4],x=r[8],T=r[12],N=r[1],C=r[5],k=r[9],L=r[13],A=r[2],O=r[6],M=r[10],_=r[14],D=r[3],P=r[7],H=r[11],B=r[15];return i[0]=s*E+o*N+u*A+a*D,i[4]=s*S+o*C+u*O+a*P,i[8]=s*x+o*k+u*M+a*H,i[12]=s*T+o*L+u*_+a*B,i[1]=f*E+l*N+c*A+h*D,i[5]=f*S+l*C+c*O+h*P,i[9]=f*x+l*k+c*M+h*H,i[13]=f*T+l*L+c*_+h*B,i[2]=p*E+d*N+v*A+m*D,i[6]=p*S+d*C+v*O+m*P,i[10]=p*x+d*k+v*M+m*H,i[14]=p*T+d*L+v*_+m*B,i[3]=g*E+y*N+b*A+w*D,i[7]=g*S+y*C+b*O+w*P,i[11]=g*x+y*k+b*M+w*H,i[15]=g*T+y*L+b*_+w*B,this},multiplyToArray:function(e,t,n){var r=this.elements;return this.multiplyMatrices(e,t),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n[9]=r[9],n[10]=r[10],n[11]=r[11],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){return e.applyProjection(this)},multiplyVector4:function(e){return e.applyMatrix4(this)},multiplyVector3Array:function(e){var t=h.__v1;for(var n=0,r=e.length;n<r;n+=3)t.x=e[n],t.y=e[n+1],t.z=e[n+2],t.applyProjection(this),e[n]=t.x,e[n+1]=t.y,e[n+2]=t.z;return e},rotateAxis:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z;return e.x=n*t[0]+r*t[4]+i*t[8],e.y=n*t[1]+r*t[5]+i*t[9],e.z=n*t[2]+r*t[6]+i*t[10],e.normalize(),e},crossVector:function(e){var t=this.elements,r=new n.Vector4;return r.x=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12]*e.w,r.y=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13]*e.w,r.z=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14]*e.w,r.w=e.w?t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15]*e.w:1,r},determinant:function(){var e=this.elements,t=e[0],n=e[4],r=e[8],i=e[12],s=e[1],o=e[5],u=e[9],a=e[13],f=e[2],l=e[6],c=e[10],h=e[14],p=e[3],d=e[7],v=e[11],m=e[15];return p*(+i*u*l-r*a*l-i*o*c+n*a*c+r*o*h-n*u*h)+d*(+t*u*h-t*a*c+i*s*c-r*s*h+r*a*f-i*u*f)+v*(+t*a*l-t*o*h-i*s*l+n*s*h+i*o*f-n*a*f)+m*(-r*o*f-t*u*l+t*o*c+r*s*l-n*s*c+n*u*f)},transpose:function(){var e=this.elements,t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},flattenToArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},flattenToArrayOffset:function(e,t){var n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e},getPosition:function(){var e=this.elements;return(new f).set(e[12],e[13],e[14])},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getColumnX:function(){var e=this.elements;return h.__v1.set(e[0],e[1],e[2])},getColumnY:function(){var e=this.elements;return h.__v1.set(e[4],e[5],e[6])},getColumnZ:function(){var e=this.elements;return h.__v1.set(e[8],e[9],e[10])},getInverse:function(e,t){var n=this.elements,r=e.elements,i=r[0],s=r[4],o=r[8],u=r[12],a=r[1],f=r[5],l=r[9],c=r[13],h=r[2],p=r[6],d=r[10],v=r[14],m=r[3],g=r[7],y=r[11],b=r[15];n[0]=l*v*g-c*d*g+c*p*y-f*v*y-l*p*b+f*d*b,n[4]=u*d*g-o*v*g-u*p*y+s*v*y+o*p*b-s*d*b,n[8]=o*c*g-u*l*g+u*f*y-s*c*y-o*f*b+s*l*b,n[12]=u*l*p-o*c*p-u*f*d+s*c*d+o*f*v-s*l*v,n[1]=c*d*m-l*v*m-c*h*y+a*v*y+l*h*b-a*d*b,n[5]=o*v*m-u*d*m+u*h*y-i*v*y-o*h*b+i*d*b,n[9]=u*l*m-o*c*m-u*a*y+i*c*y+o*a*b-i*l*b,n[13]=o*c*h-u*l*h+u*a*d-i*c*d-o*a*v+i*l*v,n[2]=f*v*m-c*p*m+c*h*g-a*v*g-f*h*b+a*p*b,n[6]=u*p*m-s*v*m-u*h*g+i*v*g+s*h*b-i*p*b,n[10]=s*c*m-u*f*m+u*a*g-i*c*g-s*a*b+i*f*b,n[14]=u*f*h-s*c*h-u*a*p+i*c*p+s*a*v-i*f*v,n[3]=l*p*m-f*d*m-l*h*g+a*d*g+f*h*y-a*p*y,n[7]=s*d*m-o*p*m+o*h*g-i*d*g-s*h*y+i*p*y,n[11]=o*f*m-s*l*m-o*a*g+i*l*g+s*a*y-i*f*y,n[15]=s*l*h-o*f*h+o*a*p-i*l*p-s*a*d+i*f*d;var w=r[0]*n[0]+r[1]*n[4]+r[2]*n[8]+r[3]*n[12];if(w==0){var E="Mat4.getInverse(): can't invert matrix, determinant is 0";if(t||!1)throw new Error(E);return console.warn(E),this.identity(),this}return this.multiplyScalar(1/w),this},compose:function(e,t,n){var r=this.elements,i=h.__m1,s=h.__m2;return i.identity(),i.setRotationFromQuaternion(t),s.makeScale(n.x,n.y,n.z),this.multiplyMatrices(i,s),r[12]=e.x,r[13]=e.y,r[14]=e.z,this},decompose:function(e,t,r){var i=this.elements,s=h.__v1,o=h.__v2,u=h.__v3;s.set(i[0],i[1],i[2]),o.set(i[4],i[5],i[6]),u.set(i[8],i[9],i[10]),e=e instanceof f?e:new f,t=t instanceof n.Quat?t:new n.Quat,r=r instanceof f?r:new f,r.x=s.length(),r.y=o.length(),r.z=u.length(),e.x=i[12],e.y=i[13],e.z=i[14];var a=h.__m1;return a.copy(this),a.elements[0]/=r.x,a.elements[1]/=r.x,a.elements[2]/=r.x,a.elements[4]/=r.y,a.elements[5]/=r.y,a.elements[6]/=r.y,a.elements[8]/=r.z,a.elements[9]/=r.z,a.elements[10]/=r.z,t.setFromRotationMatrix(a),[e,t,r]},extractPosition:function(e){var t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this},extractRotation:function(e){var t=this.elements,n=e.elements,r=h.__v1,i=1/r.set(n[0],n[1],n[2]).length(),s=1/r.set(n[4],n[5],n[6]).length(),o=1/r.set(n[8],n[9],n[10]).length();return t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i,t[4]=n[4]*s,t[5]=n[5]*s,t[6]=n[6]*s,t[8]=n[8]*o,t[9]=n[9]*o,t[10]=n[10]*o,this},translate:function(e){var t=this.elements,n,r,i;return e.length?(n=e[0],r=e[1],i=e[2]):(n=e.x,r=e.y,i=e.z),t[12]=t[0]*n+t[4]*r+t[8]*i+t[12],t[13]=t[1]*n+t[5]*r+t[9]*i+t[13],t[14]=t[2]*n+t[6]*r+t[10]*i+t[14],t[15]=t[3]*n+t[7]*r+t[11]*i+t[15],this},rotateX:function(e){var t=this.elements,n=t[4],r=t[5],i=t[6],s=t[7],o=t[8],u=t[9],a=t[10],f=t[11],l=Math.cos(e),c=Math.sin(e);return t[4]=l*n+c*o,t[5]=l*r+c*u,t[6]=l*i+c*a,t[7]=l*s+c*f,t[8]=l*o-c*n,t[9]=l*u-c*r,t[10]=l*a-c*i,t[11]=l*f-c*s,this},rotateY:function(e){var t=this.elements,n=t[0],r=t[1],i=t[2],s=t[3],o=t[8],u=t[9],a=t[10],f=t[11],l=Math.cos(e),c=Math.sin(e);return t[0]=l*n-c*o,t[1]=l*r-c*u,t[2]=l*i-c*a,t[3]=l*s-c*f,t[8]=l*o+c*n,t[9]=l*u+c*r,t[10]=l*a+c*i,t[11]=l*f+c*s,this},rotateZ:function(e){var t=this.elements,n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=Math.cos(e),c=Math.sin(e);return t[0]=l*n+c*o,t[1]=l*r+c*u,t[2]=l*i+c*a,t[3]=l*s+c*f,t[4]=l*o-c*n,t[5]=l*u-c*r,t[6]=l*a-c*i,t[7]=l*f-c*s,this},rotateByAxis:function(e,t){var n=this.elements;if(e.x===1&&e.y===0&&e.z===0)return this.rotateX(t);if(e.x===0&&e.y===1&&e.z===0)return this.rotateY(t);if(e.x===0&&e.y===0&&e.z===1)return this.rotateZ(t);var r=e.x,i=e.y,s=e.z,o=Math.sqrt(r*r+i*i+s*s);r/=o,i/=o,s/=o;var u=r*r,a=i*i,f=s*s,l=Math.cos(t),c=Math.sin(t),h=1-l,p=r*i*h,d=r*s*h,v=i*s*h,m=r*c,g=i*c,y=s*c,b=u+(1-u)*l,w=p+y,E=d-g,S=p-y,x=a+(1-a)*l,T=v+m,N=d+g,C=v-m,k=f+(1-f)*l,L=n[0],A=n[1],O=n[2],M=n[3],_=n[4],D=n[5],P=n[6],H=n[7],B=n[8],j=n[9],F=n[10],I=n[11],q=n[12],R=n[13],U=n[14],z=n[15];return n[0]=b*L+w*_+E*B,n[1]=b*A+w*D+E*j,n[2]=b*O+w*P+E*F,n[3]=b*M+w*H+E*I,n[4]=S*L+x*_+T*B,n[5]=S*A+x*D+T*j,n[6]=S*O+x*P+T*F,n[7]=S*M+x*H+T*I,n[8]=N*L+C*_+k*B,n[9]=N*A+C*D+k*j,n[10]=N*O+C*P+k*F,n[11]=N*M+C*H+k*I,this},scale:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z;return t[0]*=n,t[4]*=r,t[8]*=i,t[1]*=n,t[5]*=r,t[9]*=i,t[2]*=n,t[6]*=r,t[10]*=i,t[3]*=n,t[7]*=r,t[11]*=i,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(n,r)))},makeTranslation:function(e,t,n){return this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var n=Math.cos(t),r=Math.sin(t),i=1-n,s=e.x,o=e.y,u=e.z,a=i*s,f=i*o;return this.set(a*s+n,a*o-r*u
,a*u+r*o,0,a*o+r*u,f*o+n,f*u-r*s,0,a*u-r*o,f*u+r*s,i*u*u+n,0,0,0,0,1),this},makeScale:function(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this},makeFrustum:function(e,t,n,r,i,s){var o=this.elements,u=2*i/(t-e),a=2*i/(r-n),f=(t+e)/(t-e),l=(r+n)/(r-n),c=-(s+i)/(s-i),h=-2*s*i/(s-i);return o[0]=u,o[4]=0,o[8]=f,o[12]=0,o[1]=0,o[5]=a,o[9]=l,o[13]=0,o[2]=0,o[6]=0,o[10]=c,o[14]=h,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},makePerspective:function(e,t,r,i){var s=r*Math.tan(n.Math.degToRad(e*.5)),o=-s,u=o*t,a=s*t;return this.makeFrustum(u,a,o,s,r,i)},perspectiveFromFieldOfView:function(e,t,n){var r=this,i=r.elements,s=Math.tan(e.upDegrees*Math.PI/180),o=Math.tan(e.downDegrees*Math.PI/180),u=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),f=2/(u+a),l=2/(s+o);return i[0]=f,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=l,i[6]=0,i[7]=0,i[8]=-((u-a)*f*.5),i[9]=(s-o)*l*.5,i[10]=n/(t-n),i[11]=-1,i[12]=0,i[13]=0,i[14]=n*t/(t-n),i[15]=0,r},makeOrthographic:function(e,t,n,r,i,s){var o=this.elements,u=t-e,a=n-r,f=s-i,l=(t+e)/u,c=(n+r)/a,h=(s+i)/f;return o[0]=2/u,o[4]=0,o[8]=0,o[12]=-l,o[1]=0,o[5]=2/a,o[9]=0,o[13]=-c,o[2]=0,o[6]=0,o[10]=-2/f,o[14]=-h,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},clone:function(){var e=this.elements;return new h(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15])},makeRotationFromQuaternion:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z,s=e.w,o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,p=r*a,d=i*a,v=s*o,m=s*u,g=s*a;return t[0]=1-(h+d),t[4]=l-g,t[8]=c+m,t[1]=l+g,t[5]=1-(f+d),t[9]=p-v,t[2]=c-m,t[6]=p+v,t[10]=1-(f+h),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},getEulerAngles:function(){var e=(new h).extractRotation(this).elements,t=e[0],n=e[1],r=e[2],i=e[5],s=e[6],o=e[10],u=Math.atan2(s,o),a=Math.atan2(-r,Math.sqrt(t*t+n*n)),l=Math.sin(u),c=Math.cos(u),p=Math.atan2(l*e[8]-c*e[4],c*i-l*e[9]);return new f(u,a,p)},makeRotationAxisAndCenter:function(e,t,n){var r=Math.cos(t),i=Math.sin(t),s=1-r,o=e.x,u=e.y,a=e.z,f=s*o,l=s*u,c=n.x,h=n.y,p=n.z,d=this,v=new Float32Array(16);return v[0]=f*o+r,v[4]=f*u-i*a,v[8]=f*a+i*u,v[12]=c-c*(f*o+r)-h*(f*u-i*a)-p*(f*a+i*u),v[1]=f*u+i*a,v[5]=l*u+r,v[9]=l*a-i*o,v[13]=h-c*(f*u+i*a)-h*(l*u+r)-p*(l*a-i*o),v[2]=f*a-i*u,v[6]=l*a+i*o,v[10]=s*a*a+r,v[14]=p-c*(f*a-i*u)-h*(l*a+i*o)-p*(s*a*a+r),v[3]=0,v[7]=0,v[11]=0,v[15]=1,d.elements=v,d},rotationTowards:function(e,t){var r=Math.acos(t.dot(e)/t.length()/e.length()),i=(new n.Vec3).crossVectors(t,e).normalize();return this.makeRotationAxis(i,-r),this},equals:function(e){if(e instanceof h){for(var t=0;t<this.elements.length;t++)if(Math.abs(this.elements[t]-e.elements[t])>1e-4)return!1;return!0}},fromRotationTranslation:function(e,t){var n=this,r=n.elements,i=e[0],s=e[1],o=e[2],u=e[3],a=i+i,f=s+s,l=o+o,c=i*a,h=i*f,p=i*l,d=s*f,v=s*l,m=o*l,g=u*a,y=u*f,b=u*l;return r[0]=1-(d+m),r[1]=h+b,r[2]=p-y,r[3]=0,r[4]=h-b,r[5]=1-(c+m),r[6]=v+g,r[7]=0,r[8]=p+y,r[9]=v-g,r[10]=1-(c+d),r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,n}},h.__v1=new f,h.__v2=new f,h.__v3=new f,h.__m1=new h,h.__m2=new h,n.Mat4=h,n.Euler=function(e,t,r,i){this._x=e||0,this._y=t||0,this._z=r||0,this._order=i||n.Euler.DefaultOrder},n.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],n.Euler.DefaultOrder="XYZ",n.Euler.prototype={constructor:n.Euler,_x:0,_y:0,_z:0,_order:n.Euler.DefaultOrder,_quaternion:t,_updateQuaternion:function(){this._quaternion!==t&&this._quaternion.setFromEuler(this,!1)},get x(){return this._x},set x(e){this._x=e,this._updateQuaternion()},get y(){return this._y},set y(e){this._y=e,this._updateQuaternion()},get z(){return this._z},set z(e){this._z=e,this._updateQuaternion()},get order(){return this._order},set order(e){this._order=e,this._updateQuaternion()},set:function(e,t,n,r){return this._x=e,this._y=t,this._z=n,this._order=r||this._order,this._updateQuaternion(),this},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._updateQuaternion(),this},setFromRotationMatrix:function(e,t){function n(e){return Math.min(Math.max(e,-1),1)}var r=e.elements,i=r[0],s=r[4],o=r[8],u=r[1],a=r[5],f=r[9],l=r[2],c=r[6],h=r[10];return t=t||this._order,t==="XYZ"?(this._y=Math.asin(n(o)),Math.abs(o)<.99999?(this._x=Math.atan2(-f,h),this._z=Math.atan2(-s,i)):(this._x=Math.atan2(c,a),this._z=0)):t==="YXZ"?(this._x=Math.asin(-n(f)),Math.abs(f)<.99999?(this._y=Math.atan2(o,h),this._z=Math.atan2(u,a)):(this._y=Math.atan2(-l,i),this._z=0)):t==="ZXY"?(this._x=Math.asin(n(c)),Math.abs(c)<.99999?(this._y=Math.atan2(-l,h),this._z=Math.atan2(-s,a)):(this._y=0,this._z=Math.atan2(u,i))):t==="ZYX"?(this._y=Math.asin(-n(l)),Math.abs(l)<.99999?(this._x=Math.atan2(c,h),this._z=Math.atan2(u,i)):(this._x=0,this._z=Math.atan2(-s,a))):t==="YZX"?(this._z=Math.asin(n(u)),Math.abs(u)<.99999?(this._x=Math.atan2(-f,a),this._y=Math.atan2(-l,i)):(this._x=0,this._y=Math.atan2(o,h))):t==="XZY"?(this._z=Math.asin(-n(s)),Math.abs(s)<.99999?(this._x=Math.atan2(c,a),this._y=Math.atan2(o,i)):(this._x=Math.atan2(-f,h),this._y=0)):console.warn("WARNING: Euler.setFromRotationMatrix() given unsupported order: "+t),this._order=t,this._updateQuaternion(),this},setFromQuaternion:function(e,t,n){function r(e){return Math.min(Math.max(e,-1),1)}var i=e.x*e.x,s=e.y*e.y,o=e.z*e.z,u=e.w*e.w;return t=t||this._order,t==="XYZ"?(this._x=Math.atan2(2*(e.x*e.w-e.y*e.z),u-i-s+o),this._y=Math.asin(r(2*(e.x*e.z+e.y*e.w))),this._z=Math.atan2(2*(e.z*e.w-e.x*e.y),u+i-s-o)):t==="YXZ"?(this._x=Math.asin(r(2*(e.x*e.w-e.y*e.z))),this._y=Math.atan2(2*(e.x*e.z+e.y*e.w),u-i-s+o),this._z=Math.atan2(2*(e.x*e.y+e.z*e.w),u-i+s-o)):t==="ZXY"?(this._x=Math.asin(r(2*(e.x*e.w+e.y*e.z))),this._y=Math.atan2(2*(e.y*e.w-e.z*e.x),u-i-s+o),this._z=Math.atan2(2*(e.z*e.w-e.x*e.y),u-i+s-o)):t==="ZYX"?(this._x=Math.atan2(2*(e.x*e.w+e.z*e.y),u-i-s+o),this._y=Math.asin(r(2*(e.y*e.w-e.x*e.z))),this._z=Math.atan2(2*(e.x*e.y+e.z*e.w),u+i-s-o)):t==="YZX"?(this._x=Math.atan2(2*(e.x*e.w-e.z*e.y),u-i+s-o),this._y=Math.atan2(2*(e.y*e.w-e.x*e.z),u+i-s-o),this._z=Math.asin(r(2*(e.x*e.y+e.z*e.w)))):t==="XZY"?(this._x=Math.atan2(2*(e.x*e.w+e.y*e.z),u-i+s-o),this._y=Math.atan2(2*(e.x*e.z+e.y*e.w),u+i-s-o),this._z=Math.asin(r(2*(e.z*e.w-e.x*e.y)))):console.warn("WARNING: Euler.setFromQuaternion() given unsupported order: "+t),this._order=t,n!==!1&&this._updateQuaternion(),this},reorder:function(){var e=new n.Quat;return function(t){e.setFromEuler(this),this.setFromQuaternion(e,t)}}(),fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],e[3]!==t&&(this._order=e[3]),this._updateQuaternion(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},clone:function(){return new n.Euler(this._x,this._y,this._z,this._order)}},n.math={},n.math.Plane=function(e,n){this.normal=e!==t?e:new f(1,0,0),this.constant=n!==t?n:0},n.math.Plane.prototype={constructor:n.math.Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,n,r){return this.normal.set(e,t,n),this.constant=r,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(e,t,r){var i=n.math.Plane.__v1.subVectors(r,t).cross(n.math.Plane.__v2.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(i,e),this},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(e,t){var n=this.distanceToPoint(e),r=t||new f;return r.copy(this.normal).multiplyScalar(n)},isIntersectionLine:function(e,t){var n=this.distanceToPoint(e),r=this.distanceToPoint(t);return n<0&&r>0||r<0&&n>0},isIntersectionFace:function(e,t){var n=[];n.push(t[e.a]),n.push(t[e.b]),n.push(t[e.c]),e.d!=null&&n.push(t[e.d]);var r=[],i,s,o;for(i=0;i<n.length;i++)r.push(this.distanceToPoint(n[i]));for(i=0;i<r.length;i++)if(i==0)s=o=r[i];else{o=r[i];if(s<0&&o>0||o<0&&s>0)return"intersect";s=o}return o>0?"in":"out"},intersectLine:function(e,r,i){var s=i||new f,o=n.math.Plane.__v1.subVectors(r,e),u=this.normal.dot(o);if(u==0)return this.distanceToPoint(e)==0?s.copy(e):t;var a=-(e.dot(this.normal)+this.constant)/u;return a<0||a>1?t:s.copy(o).multiplyScalar(a).add(e)},coplanarPoint:function(e){var t=e||new f;return t.copy(this.normal).multiplyScalar(-this.constant)},transform:function(e,t){t=t||(new n.Mat3).getInverse(e).transpose();var r=n.math.Plane.__v1.copy(this.normal).applyMatrix3(t),i=this.coplanarPoint(n.math.Plane.__v2);return i.applyMatrix4(e),this.setFromNormalAndCoplanarPoint(r,i),this},translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant==this.constant},clone:function(){return(new n.math.Plane).copy(this)}},n.math.Plane.__vZero=new f(0,0,0),n.math.Plane.__v1=new f,n.math.Plane.__v2=new f,n.Frustum=function(e,r,i,s,o,u){this.planes=[e!==t?e:new n.math.Plane,r!==t?r:new n.math.Plane,i!==t?i:new n.math.Plane,s!==t?s:new n.math.Plane,o!==t?o:new n.math.Plane,u!==t?u:new n.math.Plane]},n.Frustum.prototype={set:function(e,t,n,r,i,s){var o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(n),o[3].copy(r),o[4].copy(i),o[5].copy(s),this},setPoints:function(e){this.points=e},copy:function(e){var t=this.planes;for(var n=0;n<6;n++)t[n].copy(e.planes[n]);return this},setFromMatrix:function(e){var t=this.planes,n=e.elements,r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5],f=n[6],l=n[7],c=n[8],h=n[9],p=n[10],d=n[11],v=n[12],m=n[13],g=n[14],y=n[15];return t[0].setComponents(o-r,l-u,d-c,y-v).normalize(),t[1].setComponents(o+r,l+u,d+c,y+v).normalize(),t[2].setComponents(o+i,l+a,d+h,y+m).normalize(),t[3].setComponents(o-i,l-a,d-h,y-m).normalize(),t[4].setComponents(o-s,l-f,d-p,y-g).normalize(),t[5].setComponents(o+s,l+f,d+p,y+g).normalize(),this},intersectsObjectAccurate:function(e,t){if(t==0)return this.intersectsObject(e);var r=e.worldMatrix,i=this.planes,s=e.vertices,o=[],u,a,f=s.length;for(a=0;a<f;a++){u=s[a].clone(),u.applyMatrix4(r),o.push(u);if(this.containsPoint(u))return!0}if(t==2)if(e instanceof n.Line)for(a=0,f=o.length;a<f-1;a++){var l=o[a],c=o[a+1];if(this.containsLine(l,c))return!0}else{var h=e.faces,p,d,v,m,g,y;for(a=0,f=h.length;a<f;a++){p=h[a];if(this.containsLine(o[p.a],o[p.b]))return!0;if(this.containsLine(o[p.b],o[p.c]))return!0;if(p.d!=null){if(this.containsLine(o[p.c],o[p.d]))return!0;if(this.containsLine(o[p.d],o[p.a]))return!0}else if(this.containsLine(o[p.a],o[p.c]))return!0}}return!1},intersectsObject:function(e){var t=e.worldMatrix,n=this.planes,r=t.getPosition();if(!e.computeBoundingSphere)return!1;e.boundingSphere||e.computeBoundingSphere();var i=-e.boundingSphere.radius*t.getMaxScaleOnAxis();for(var s=0;s<6;s++){var o=n[s].distanceToPoint(r);if(o<i)return!1}return!0},intersectsSphere:function(e){var t=this.planes,n=e.center,r=-e.radius;for(var i=0;i<6;i++){var s=t[i].distanceToPoint(n);if(s<r)return!1}return!0},intersectsBox:function(e){var t=new f,n=new f,r=this.planes;for(var i=0;i<6;i++){var s=r[i];t.x=s.normal.x>0?e.min.x:e.max.x,n.x=s.normal.x>0?e.max.x:e.min.x,t.y=s.normal.y>0?e.min.y:e.max.y,n.y=s.normal.y>0?e.max.y:e.min.y,t.z=s.normal.z>0?e.min.z:e.max.z,n.z=s.normal.z>0?e.max.z:e.min.z;var o=s.distanceToPoint(t),u=s.distanceToPoint(n);if(o<0&&u<0)return!1}return!0},containsLine:function(e,t){var n=this.planes,r=new f;for(var i=0;i<6;i++){r=n[i].intersectLine(e,t,r);if(r&&this.containsPoint(r))return!0}return!1},containsPoint:function(e){var t=this.planes;for(var n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0},clone:function(){return(new n.Frustum).copy(this)}},n.Ray=function(e,n){this.origin=e!==t?e:new f,this.direction=n!==t?n:new f},n.Ray.prototype={constructor:n.Ray,set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){var n=t||new f;return n.copy(this.direction).multiplyScalar(e).add(this.origin)},recast:function(e){return this.origin.copy(this.at(e,n.Ray.__v1)),this},closestPointToPoint:function(e,t){var n=t||new f;n.subVectors(e,this.origin);var r=n.dot(this.direction);return n.copy(this.direction).multiplyScalar(r).add(this.origin)},distanceToPoint:function(e){var t=n.Ray.__v1.subVectors(e,this.origin).dot(this.direction);return n.Ray.__v1.copy(this.direction).multiplyScalar(t).add(this.origin),n.Ray.__v1.distanceTo(e)},isIntersectionSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},isIntersectionPlane:function(e){var t=e.normal.dot(this.direction);return t!=0?!0:e.distanceToPoint(this.origin)==0?!0:!1},distanceToPlane:function(e){var n=e.normal.dot(this.direction);if(n==0)return e.distanceToPoint(this.origin)==0?0:t;var r=-(this.origin.dot(e.normal)+e.constant)/n;return r},intersectPlane:function(e,n){var r=this.distanceToPlane(e);return r===t?t:this.at(r,n)},transform:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this},distanceSqToSegment:function(e,t,n,r){var i=e.clone().add(t).multiplyScalar(.5),s=t.clone().sub(e).normalize(),o=e.distanceTo(t)*.5,u=this.origin.clone().sub(i),a=-this.direction.dot(s),f=u.dot(this.direction),l=-u.dot(s),c=u.lengthSq(),h=Math.abs(1-a*a),p,d,v,m;if(h>=0){p=a*l-f,d=a*f-l,m=o*h;if(p>=0)if(d>=-m)if(d<=m){var g=1/h;p*=g,d*=g,v=p*(p+a*d+2*f)+d*(a*p+d+2*l)+c}else d=o,p=Math.max(0,-(a*d+f)),v=-p*p+d*(d+2*l)+c;else d=-o,p=Math.max(0,-(a*d+f)),v=-p*p+d*(d+2*l)+c;else d<=-m?(p=Math.max(0,-(-a*o+f)),d=p>0?-o:Math.min(Math.max(-o,-l),o),v=-p*p+d*(d+2*l)+c):d<=m?(p=0,d=Math.min(Math.max(-o,-l),o),v=d*(d+2*l)+c):(p=Math.max(0,-(a*o+f)),d=p>0?o:Math.min(Math.max(-o,-l),o),v=-p*p+d*(d+2*l)+c)}else d=a>0?-o:o,p=Math.max(0,-(a*d+f)),v=-p*p+d*(d+2*l)+c;return n&&n.copy(this.direction.clone().multiplyScalar(p).add(this.origin)),r&&r.copy(s.clone().multiplyScalar(d).add(i)),v},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)},clone:function(){return(new n.Ray).copy(this)}},n.Ray.__v1=new f,n.Ray.__v2=new f,n.Triangle=function(e,n,r){this.a=e!==t?e:new f,this.b=n!==t?n:new f,this.c=r!==t?r:new f},n.Triangle.normal=function(e,t,r,i){var s=i||new f;s.subVectors(r,t),n.Triangle.__v0.subVectors(e,t),s.cross(n.Triangle.__v0);var o=s.lengthSq();return o>0?s.multiplyScalar(1/Math.sqrt(o)):s.set(0,0,0)},n.Triangle.barycoordFromPoint=function(e,t,r,i,s){n.Triangle.__v0.subVectors(i,t),n.Triangle.__v1.subVectors(r,t),n.Triangle.__v2.subVectors(e,t);var o=n.Triangle.__v0.dot(n.Triangle.__v0),u=n.Triangle.__v0.dot(n.Triangle.__v1),a=n.Triangle.__v0.dot(n.Triangle.__v2),l=n.Triangle.__v1.dot(n.Triangle.__v1),c=n.Triangle.__v1.dot(n.Triangle.__v2),h=o*l-u*u,p=s||new f;if(h==0)return p.set(-2,-1,-1);var d=1/h,v=(l*a-u*c)*d,m=(o*c-u*a)*d;return p.set(1-v-m,m,v)},n.Triangle.containsPoint=function(e,t,r,i){var s=n.Triangle.barycoordFromPoint(e,t,r,i,n.Triangle.__v3);return s.x>=0&&s.y>=0&&s.x+s.y<=1},n.Triangle.prototype={constructor:n.Triangle,set:function(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this},setFromPointsAndIndices:function(e,t,n,r){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[r]),this},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){return n.Triangle.__v0.subVectors(this.c,this.b),n.Triangle.__v1.subVectors(this.a,this.b),n.Triangle.__v0.cross(n.Triangle.__v1).length()*.5},midpoint:function(e){var t=e||new f;return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return n.Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){var t=e||new n.math.Plane;return t.setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return n.Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return n.Triangle.containsPoint(e,this.a,this.b,this.c)},equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)},clone:function(){return(new n.Triangle).copy(this)},intersectLine:function(e,t){var n=this.plane(),r=n.intersectLine(e,t);return r!=null&&this.containsPoint(r)}},n.Triangle.__v0=new f,n.Triangle.__v1=new f,n.Triangle.__v2=new f,n.Triangle.__v3=new f,n.Box2=function(e,n){this.min=e!==t?e:new o(+Infinity,+Infinity),this.max=n!==t?n:new o(-Infinity,-Infinity)},n.Box2.prototype={constructor:n.Box2,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new o;return function(n,r){var i=e.copy(r).multiplyScalar(.5);return this.min.copy(n).sub(i),this.max.copy(n).add(i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=+Infinity,this.max.x=this.max.y=-Infinity,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(e){var t=e||new o;return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new o;return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y?!1:!0},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(e,t){var n=t||new o;return n.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(e){return e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y?!1:!0},clampPoint:function(e,t){var n=t||new o;return n.copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new o;return function(n){var r=e.copy(n).clamp(this.min,this.max);return r.sub(n).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}};var p={getLogicalPoint:function(e,t){var n,r=e.getBoundingClientRect();if(d.isTouchable&&t.changedTouches&&t.changedTouches.length>0){var i=t.changedTouches[0],s=d.isAndroid?0:$touch.scrollLeft(),o=d.isAndroid?0:$touch.scrollTop();n={x:i.clientX+e.scrollLeft-r.left-s,y:i.clientY+e.scrollTop-r.top-o}}else{if(!p.isValidEvent(e,t))return null;n={x:t.clientX-r.left+e.scrollLeft,y:t.clientY-r.top+e.scrollTop}}return n},isValidEvent:function(e,t){if(!t)return!1;if(t.target===e)if(d.isFirefox){if(e.clientHeight<e.scrollHeight&&t.layerX<25)return!1;if(e.clientWidth<e.scrollWidth&&t.layerY<25)return!1}else if(t.offsetX>e.clientWidth||t.offsetY>e.clientHeight)return!1;return!0},isImage:function(e){return e&&e.nodeName&&e.nodeName.toLowerCase()==="img"},isCanvas:function(e){return e&&e.nodeName&&e.nodeName.toLowerCase()==="canvas"},createView:function(e,t){var n=document.createElement("div");return n.style.position=P.VIEW_POSITION,n.style.fontSize=P.VIEW_FONT_SIZE,n.style.fontFamily=P.VIEW_FONT_FAMILY,n.style.cursor="default",n.style.outline="none",n.style.textAlign="left",n.style.msTouchAction="none",n.tabIndex=0,t||(n.onmousedown=p.preventDefault),n.style.setProperty&&(n.style.setProperty("-khtml-user-select","none",null),n.style.setProperty("-webkit-user-select","none",null),n.style.setProperty("-moz-user-select","none",null),n.style.setProperty("-webkit-tap-highlight-color","rgba(0, 0, 0, 0)",null)),e&&(n.style.overflow=e),n},preventDefault:function(e){if(P.KEEP_DEFAULT_FUNCTION(e))return;e.preventDefault?e.preventDefault():e.preventManipulation?e.preventManipulation():e.returnValue=!1},createCanvas:function(e){var t=document.createElement("canvas"),n=e.getView();return t.width=n.width,t.height=n.height,t.style.msTouchAction="none",t.style.position="absolute",t},isCtrlDown:function(e){return e.ctrlKey||e.metaKey},getScrollTop:function(e){if(!e)return 0;var t=e.scrollTop,n=e.parentElement;return t+this.getScrollTop(n)},getScrollLeft:function(e){if(!e)return 0;var t=e.scrollLeft,n=e.parentElement;return t+this.getScrollLeft(n)},debug:function(e,t){try{e.call(t)}catch(n){alert(n)}},setFocus:function(e){if(document.activeElement===e)return;var t,n,r=document.documentElement,i=document.body,s;r&&(d.isIE||d.isOpera||r.scrollLeft||r.scrollTop)&&(t=r.scrollLeft,n=r.scrollTop,s=r),e.focus(),s&&(s.scrollLeft=t,s.scrollTop=n)},isRightClick:function(t){var n;if(!t)var t=e.event;return t.which?n=t.which==3:t.button&&(n=t.button==2),n}};n.html=p;var d=function(){var e={},t=navigator.userAgent.toLowerCase();return e.isOpera=/opera/.test(t),e.isIE=/msie/.test(t)||/trident/.test(t),e.isFirefox=/firefox/i.test(t),e.isChrome=/chrome/i.test(t),e.isSafari=!e.isChrome&&/safari/i.test(t),e.isIPhone=/iphone/.test(t),e.isIPod=/ipod/.test(t),e.isIPad=/ipad/.test(t),e.isAndroid=/android/i.test(t),e.isWebOS=/webos/i.test(t),e.isMSToucheable=navigator.msMaxTouchPoints&&navigator.msMaxTouchPoints>1,e.isTouchable="ontouchend"in document||e.isMSToucheable,e.isIOS=e.isIPhone||e.isIPod||e.isIPad,e}();n.ua=d,function(){function r(e){var n,r,i,s,o,u;i=e.length,r=0,n="";while(r<i){s=e.charCodeAt(r++)&255;if(r==i){n+=t.charAt(s>>2),n+=t.charAt((s&3)<<4),n+="==";break}o=e.charCodeAt(r++);if(r==i){n+=t.charAt(s>>2),n+=t.charAt((s&3)<<4|(o&240)>>4),n+=t.charAt((o&15)<<2),n+="=";break}u=e.charCodeAt(r++),n+=t.charAt(s>>2),n+=t.charAt((s&3)<<4|(o&240)>>4),n+=t.charAt((o&15)<<2|(u&192)>>6),n+=t.charAt(u&63)}return n}function i(e){var t,r,i,s,o,u,a;u=e.length,o=0,a="";while(o<u){do t=n[e.charCodeAt(o++)&255];while(o<u&&t==-1);if(t==-1)break;do r=n[e.charCodeAt(o++)&255];while(o<u&&r==-1);if(r==-1)break;a+=String.fromCharCode(t<<2|(r&48)>>4);do{i=e.charCodeAt(o++)&255;if(i==61)return a;i=n[i]}while(o<u&&i==-1);if(i==-1)break;a+=String.fromCharCode((r&15)<<4|(i&60)>>2);do{s=e.charCodeAt(o++)&255;if(s==61)return a;s=n[s]}while(o<u&&s==-1);if(s==-1)break;a+=String.fromCharCode((i&3)<<6|s)}return a}var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);e.btoa||(e.btoa=r),e.atob||(e.atob=i)}();var g=function(){var t=!1,n=document.createElement("canvas");n.getContext("2d")&&(t=!0);if(!t)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var r=!!n.getContext("2d").getImageData,i=!!n.toDataURL,s=!!e.btoa,o="image/octet-stream",u=function(e){var t=parseInt(e.width),n=parseInt(e.height);return e.getContext("2d").getImageData(0,0,t,n)},a=function(e){var t="";if(typeof e=="string")t=e;else{var n=e;for(var r=0;r<n.length;r++)t+=String.fromCharCode(n[r])}return btoa(t)},f=function(e){var t=[],n=e.width,r=e.height;t.push(66),t.push(77);var i=n*r*3+54;t.push(i%256),i=Math.floor(i/256),t.push(i%256),i=Math.floor(i/256),t.push(i%256),i=Math.floor(i/256),t.push(i%256),t.push(0),t.push(0),t.push(0),t.push(0),t.push(54),t.push(0),t.push(0),t.push(0);var s=[];s.push(40),s.push(0),s.push(0),s.push(0);var o=n;s.push(o%256),o=Math.floor(o/256),s.push(o%256),o=Math.floor(o/256),s.push(o%256),o=Math.floor(o/256),s.push(o%256);var u=r;s.push(u%256),u=Math.floor(u/256),s.push(u%256),u=Math.floor(u/256),s.push(u%256),u=Math.floor(u/256),s.push(u%256),s.push(1),s.push(0),s.push(24),s.push(0),s.push(0),s.push(0),s.push(0),s.push(0);var f=n*r*3;s.push(f%256),f=Math.floor(f/256),s.push(f%256),f=Math.floor(f/256),s.push(f%256),f=Math.floor(f/256),s.push(f%256);for(var l=0;l<16;l++)s.push(0);var c=(4-n*3%4)%4,h=e.data,p="",d=r;do{var v=n*(d-1)*4,m="";for(var g=0;g<n;g++){var y=4*g;m+=String.fromCharCode(h[v+y+2]),m+=String.fromCharCode(h[v+y+1]),m+=String.fromCharCode(h[v+y])}for(var b=0;b<c;b++)m+=String.fromCharCode(0);p+=m}while(--d);var w=a(t.concat(s))+a(p);return w},l=function(e,t){return"data:"+t+";base64,"+e},c=function(e){var t=document.createElement("img");return t.src=e,t},h=function(e,t,n,r,i){n=n||(t?t.w:e.width),r=r||(t?t.h:e.height);var s=document.createElement("canvas");s.width=n,s.height=r,s.style.width=n+"px",s.style.height=r+"px";var o=s.getContext("2d"),o=s.getContext("2d"),u=e.style.backgroundColor;return u||(i==="PNG"?u="rgba(255,255,255,0.0)":i==="BMP"?u="rgba(255,255,255,0.01)":u="#FFFFFF"),o.fillStyle=u,o.fillRect(0,0,n,r),t=t?t:{x:0,y:0,w:e.width,h:e.height},o.drawImage(e,t.x,t.y,t.w,t.h,0,0,n,r),s};return{saveAsPNG:function(e,t,n,r,s){if(!i)return!1;var o=h(e,t,r,s,"PNG"),u=o.toDataURL("image/png");return n?c(u):u},saveAsJPEG:function(e,t,n,r,s){if(!i)return!1;var o=h(e,t,r,s,"JPEG"),u="image/jpeg",a=o.toDataURL(u);return a.indexOf(u)!=5?!1:n?c(a):a},saveAsBMP:function(e,t,n,i,o){if(!r||!s)return!1;var a=h(e,t,i,o,"BMP"),p=u(a),d=f(p);return n?c(l(d,"image/bmp")):l(d,"image/bmp")}}}(),y={},w={cache:{},g:document.createElement("canvas").getContext("2d"),getTextSize:function(e,t){w.g.font=e?e:P.FONT;var n=w.cache[w.g.font];return n||(n=w.g.measureText("e").width*2+4,w.cache[w.g.font]=n),{width:w.g.measureText(t).width+4,height:n}}};y.g=w,n.g=w;var E={},S=setTimeout;E.bcld=function(e,t,n,r,i,s,u,a,l){var c=e/2,h,p,d=[],v=[],m={vertices:[],faces:[],uvs:[],uv2s:[]};for(p=0;p<=t;p++){var g=[],y=[],b=p/t,w=b*(n-r)+r;for(h=0;h<=i;h++){var E=h/i,S=new f;S.x=w*Math.sin(E*a+l),S.y=-b*e+c,S.z=w*Math.cos(E*a+l),m.vertices.push(S),g.push(m.vertices.length-1),y.push(new o(E,1-b))}d.push(g),v.push(y)}var x=(n-r)/e,T,N;for(h=0;h<i;h++){r!==0?(T=m.vertices[d[0][h]].clone(),N=m.vertices[d[0][h+1]].clone()):(T=m.vertices[d[1][h]].clone(),N=m.vertices[d[1][h+1]].clone()),T.setY(Math.sqrt(T.x*T.x+T.z*T.z)*x).normalize(),N.setY(Math.sqrt(N.x*N.x+N.z*N.z)*x).normalize();for(p=0;p<t;p++){var C=d[p][h],k=d[p+1][h],L=d[p+1][h+1],A=d[p][h+1],M=T.clone(),_=T.clone(),D=N.clone(),P=N.clone(),H=v[p][h].clone(),B=v[p+1][h].clone(),j=v[p+1][h+1].clone(),F=v[p][h+1].clone();m.faces.push(new O(C,k,A,[M,_,P],null,0)),m.uvs.push([H,B,F]),m.uv2s.push([H.clone(),B.clone(),F.clone()]),m.faces.push(new O(k,L,A,[_,D,P],null,0)),m.uvs.push([B,j,F]),m.uv2s.push([B.clone(),j.clone(),F.clone()])}}var I=!1;if(s===!1&&r>0){m.vertices.push(new f(0,c,0)),I=!0;for(h=0;h<i;h++){var C=d[0][h],k=d[0][h+1],L=m.vertices.length-1,M=new f(0,1,0),_=new f(0,1,0),D=new f(0,1,0),q=m.vertices[C],R=m.vertices[k],H=new o((q.x/r+1)/2,1-(q.z/r+1)/2),B=new o((R.x/r+1)/2,1-(R.z/r+1)/2),j=new o(.5,.5);m.faces.push(new O(C,k,L,[M,_,D],null,1)),m.uvs.push([H,B,j]),m.uv2s.push([H.clone(),B.clone(),j.clone()])}}var U=!1;if(u===!1&&n>0){m.vertices.push(new f(0,-c,0)),U=!0;for(h=0;h<i;h++){var C=d[p][h+1],k=d[p][h],L=m.vertices.length-1,M=new f(0,-1,0),_=new f(0,-1,0),D=new f(0,-1,0),q=m.vertices[C],R=m.vertices[k],H=new o((q.x/n+1)/2,(q.z/n+1)/2),B=new o((R.x/n+1)/2,(R.z/n+1)/2),j=new o(.5,.5);m.faces.push(new O(C,k,L,[M,_,D],null,2)),m.uvs.push([H,B,j]),m.uv2s.push([H.clone(),B.clone(),j.clone()])}}if(a!==Math.PI*2){!I&&m.vertices.push(new f(0,c,0)),!U&&m.vertices.push(new f(0,-c,0));var C=d[0][0],k=d[t][0],L=m.vertices.length-1,A=m.vertices.length-2,H=new o(0,0),B=new o(0,1),j=new o(1,1),F=new o(1,0);m.faces.push(new O(C,L,k)),m.uvs.push([H,j,B]),m.uv2s.push([H.clone(),j.clone(),B.clone()]),m.faces.push(new O(A,L,C)),m.uvs.push([F,j,H]),m.uv2s.push([F.clone(),j.clone(),H.clone()]),C=d[0][i],k=d[t][i];var H=new o(0,0),B=new o(0,1),j=new o(1,1),F=new o(1,0);m.faces.push(new O(C,k,A)),m.uvs.push([H,B,F]),m.uv2s.push([H.clone(),B.clone(),F.clone()]),m.faces.push(new O(k,L,A)),m.uvs.push([B,j,F]),m.uv2s.push([B.clone(),j.clone(),F.clone()])}return m},E.buildCubeData=function(e,t,n,r,i,s,u,a){function v(v){var m,g,y,b,w,E,S,x,T,N;l=c.length;var C,k=u=="six-each"||u=="front-other"||u=="back-other"||u=="left-other"||u=="right-other"||u=="top-other"||u=="bottom-other",L=new o(0,0),A=k?new o(1/3,.5):new o(1,1),O=u.split("-")[0];O=="six"?O=null:A=new o(.5,1),v=="right"?(m="z",g="y",y="x",b=-1,w=-1,E=e/2,S=n,x=t,T=s,N=i,C=0,L=new o(2/3,0)):v=="left"?(m="z",g="y",y="x",b=1,w=-1,E=-e/2,S=n,x=t,T=s,N=i,C=1):v=="top"?(m="x",g="z",y="y",b=1,w=1,E=t/2,S=e,x=n,T=r,N=s,C=2,L=new o(1/3,.5)):v=="bottom"?(m="x",g="z",y="y",b=1,w=-1,E=-t/2,S=e,x=n,T=r,N=s,C=3,L=new o(0,.5)):v=="front"?(m="x",g="y",y="z",b=1,w=-1,E=n/2,S=e,x=t,T=r,N=i,C=4,L=new o(1/3,0)):v=="back"&&(m="x",g="y",y="z",b=-1,w=-1,E=-n/2,S=e,x=t,T=r,N=i,C=5,L=new o(2/3,.5)),O&&(O==v?L=new o(0,0):L=new o(.5,0));var _,D,P=T+1,H=N+1;for(D=0;D<H;D++)for(_=0;_<P;_++){var B=new f;B[m]=(_/T*S-S/2)*b+a[m],B[g]=(D/N*x-x/2)*w+a[g],B[y]=E+a[y],c.push(B)}k&&(C=0);var j=new f;j[y]=E>0?1:-1;for(D=0;D<N;D++)for(_=0;_<T;_++){var F=_+P*D,I=_+P*(D+1),q=_+1+P*(D+1),R=_+1+P*D,U=[new o(_/T,1-D/N),new o(_/T,1-(D+1)/N),new o((_+1)/T,1-(D+1)/N),new o((_+1)/T,1-D/N)];if(k)for(var z=0;z<U.length;z++)U[z].multiply(A).add(L);var W=new M(F+l,I+l,q+l,R+l);W.normal.copy(j),W.vertexNormals.push(j.clone(),j.clone(),j.clone(),j.clone()),W.materialIndex=C,h.push(W),p.push([U[0],U[1],U[2],U[3]]),d.push([U[0].clone(),U[1].clone(),U[2].clone(),U[3].clone()])}}var l,c=[],h=[],p=[],d=[];v("right"),v("left"),v("top"),v("bottom"),v("front"),v("back");var m={vertices:c,faces:h,uvs:p,uv2s:d};return m},E.bsd=function(e,t,n,r,i,s,u){var a,l,c=[],h=[],p=[],d=[],v=[],m=[];for(l=0;l<=n;l++){var g=[],y=[];for(a=0;a<=t;a++){var b=a/t,w=l/n,E=new f;E.x=-e*Math.cos(r+b*i)*Math.sin(s+w*u),E.y=e*Math.cos(s+w*u),E.z=e*Math.sin(r+b*i)*Math.sin(s+w*u),c.push(E),g.push(c.length-1),y.push(new o(b,1-w))}v.push(g),m.push(y)}for(l=0;l<n;l++)for(a=0;a<t;a++){var S=v[l][a+1],x=v[l][a],T=v[l+1][a],N=v[l+1][a+1],C=c[S].clone().normalize(),k=c[x].clone().normalize(),L=c[T].clone().normalize(),A=c[N].clone().normalize(),M=m[l][a+1].clone(),_=m[l][a].clone(),D=m[l+1][a].clone(),P=m[l+1][a+1].clone();Math.abs(c[S].y)===e?(p.push(new O(S,T,N,[C,L,A])),h.push([M,D,P]),d.push([M.clone(),D.clone(),P.clone()])):Math.abs(c[T].y)===e?(p.push(new O(S,x,T,[C,k,L])),h.push([M,_,D]),d.push([M.clone(),_.clone(),D.clone()])):(p.push(new O(S,x,N,[C,k,A])),h.push([M,_,P]),d.push([M.clone(),_.clone(),P.clone()]),p.push(new O(x,T,N,[k.clone(),L,A.clone()])),h.push([_.clone(),D,P.clone()]),d.push([_.clone(),D.clone(),P.clone()]))}return{vertices:c,faces:p,uvs:h,uv2s:d}};var x=function(e){var r,i,s,o,u,a,f,l={},c=e.primitive;if(c.groups){e.groups=c.groups,e.groupList=c.groupList;return}c.groups={};var h=e.material,p=e.getMaterialMapping();for(r=0,i=c.faces.length;r<i;r++)s=c.faces[r],o=h instanceof n.ArrayMaterial?s.materialIndex:0,o=p[o],o==null,a=o!==t?o:-1,l[a]===t&&(l[a]={hash:a,counter:0}),f=l[a].hash+"_"+l[a].counter,c.groups[f]===t&&(c.groups[f]={faces3:[],faces4:[],materialIndex:o,vertices:0}),u=s instanceof O?3:4,c.groups[f].vertices+u>65535&&(l[a].counter+=1,f=l[a].hash+"_"+l[a].counter,c.groups[f]===t&&(c.groups[f]={faces3:[],faces4:[],materialIndex:o,vertices:0})),s instanceof O?c.groups[f].faces3.push(r):c.groups[f].faces4.push(r),c.groups[f].vertices+=u;c.groupsList=[];for(var d in e.groups)c.groupsList.push(e.groups[d]);e.groups=c.groups,e.groupList=c.groupsList},T=function(e,n,r,i){var s,o,u,a,f,l,c,h,p=e,d=p,v=d.vertices,m=v.length,g=d.colors,y=g.length,b=d.sizes,w=b.length,E=i.__vertexArray,S=i.__colorArray,x=i.__normalArray,T=i.__sortArray,N=d.verticesNeedUpdate,C=d.elementsNeedUpdate,k=d.normalsNeedUpdate,L=d.colorsNeedUpdate,A=d.__webglCustomAttributesList,O,M,_,D,P,H,B;w<m&&(w=m);if(p.sortParticles){_projScreenMatrixPS.copy(_projScreenMatrix),_projScreenMatrixPS.multiply(p.matrixWorld);for(s=0;s<m;s++)a=v[s],_vector3.copy(a),_vector3.applyProjection(_projScreenMatrixPS),T[s]=[_vector3.z,s];T.sort(numericalSort);for(s=0;s<m;s++)a=v[T[s][1]],f=s*3,E[f]=a.x,E[f+1]=a.y,E[f+2]=a.z;for(o=0;o<y;o++)f=o*3,c=g[T[o][1]],S[f]=c.r,S[f+1]=c.g,S[
f+2]=c.b;for(u=0;u<w;u++)f=u*3,h=b[T[u][1]],h=h==null?1:h,x[f]=h.x==null?h||1:h.x,x[f+1]=0,x[f+2]=0;if(A)for(O=0,M=A.length;O<M;O++){B=A[O];if(B.boundTo!==t&&B.boundTo!=="vertices")continue;f=0,P=B.value.length;if(B.size===1)for(D=0;D<P;D++)l=T[D][1],B.array[D]=B.value[l];else if(B.size===2)for(D=0;D<P;D++)l=T[D][1],H=B.value[l],B.array[f]=H.x,B.array[f+1]=H.y,f+=2;else if(B.size===3)if(B.type==="c")for(D=0;D<P;D++)l=T[D][1],H=B.value[l],B.array[f]=H.r,B.array[f+1]=H.g,B.array[f+2]=H.b,f+=3;else for(D=0;D<P;D++)l=T[D][1],H=B.value[l],B.array[f]=H.x,B.array[f+1]=H.y,B.array[f+2]=H.z,f+=3;else if(B.size===4)for(D=0;D<P;D++)l=T[D][1],H=B.value[l],B.array[f]=H.x,B.array[f+1]=H.y,B.array[f+2]=H.z,B.array[f+3]=H.w,f+=4}}else{if(N)for(s=0;s<m;s++)a=v[s],f=s*3,E[f]=a.x,E[f+1]=a.y,E[f+2]=a.z;if(L)for(o=0;o<y;o++)c=g[o],f=o*3,S[f]=c.r,S[f+1]=c.g,S[f+2]=c.b;if(k)for(u=0;u<w;u++)h=b[u]==null?1:b[u],f=u*3,x[f]=h.x==null?h||1:h.x,x[f+1]=0,x[f+2]=0;if(A)for(O=0,M=A.length;O<M;O++){B=A[O];if(B.needsUpdate&&(B.boundTo===t||B.boundTo==="vertices")){P=B.value.length,f=0;if(B.size===1)for(D=0;D<P;D++)B.array[D]=B.value[D];else if(B.size===2)for(D=0;D<P;D++)H=B.value[D],B.array[f]=H.x,B.array[f+1]=H.y,f+=2;else if(B.size===3)if(B.type==="c")for(D=0;D<P;D++)H=B.value[D],B.array[f]=H.r,B.array[f+1]=H.g,B.array[f+2]=H.b,f+=3;else for(D=0;D<P;D++)H=B.value[D],B.array[f]=H.x,B.array[f+1]=H.y,B.array[f+2]=H.z,f+=3;else if(B.size===4)for(D=0;D<P;D++)H=B.value[D],B.array[f]=H.x,B.array[f+1]=H.y,B.array[f+2]=H.z,B.array[f+3]=H.w,f+=4}}}if(N||p.sortParticles)r.bindBuffer(r.ARRAY_BUFFER,i.__webglVertexBuffer),r.bufferData(r.ARRAY_BUFFER,E,n);if(L||p.sortParticles)r.bindBuffer(r.ARRAY_BUFFER,i.__webglColorBuffer),r.bufferData(r.ARRAY_BUFFER,S,n);if(k||p.sortParticles)r.bindBuffer(r.ARRAY_BUFFER,i.__webglNormalBuffer),r.bufferData(r.ARRAY_BUFFER,x,n);if(A)for(O=0,M=A.length;O<M;O++){B=A[O];if(B.needsUpdate||p.sortParticles)r.bindBuffer(r.ARRAY_BUFFER,B.buffer),r.bufferData(r.ARRAY_BUFFER,B.array,n)}};E.buildGroupBufferData=function(e,r,i,s,o,u,a,f){var l=o._type=="basic"?!1:!0,c=o.isVertexColor(),h=o.needUV();l=!0;var p=f.needSmoothNormal(r,o),d,v,m,g,y,b,w,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt,ct,ht,pt,dt,vt,mt,gt,yt=0,bt=0,wt=0,Et=0,St=0,xt=0,Tt=0,Nt=0,Ct=0,kt=0,Lt,At=a.__vertexArray,Ot=a.__uvArray,Mt=a.__uv2Array,_t=a.__normalArray,Dt=a.__colorArray,Pt=a.__webglCustomAttributesList,Ht,Bt=a.__faceArray,jt=a.__lineArray,Ft=r,It=Ft.verticesNeedUpdate,qt=Ft.elementsNeedUpdate,Rt=Ft.uvsNeedUpdate,Ut=Ft.normalsNeedUpdate,zt=Ft.colorsNeedUpdate,Wt=Ft.vertices,Xt=e.faces3,Vt=e.faces4,$t=Ft.faces,Jt=Ft.colors,Kt=Ft.uvs,Qt=Ft.uv2s,Gt=Ft.colors;a.__vao!=null&&(a.__vao.dirty=!0);if(It){for(d=0,v=Xt.length;d<v;d++)g=$t[Xt[d]],C=Wt[g.a],k=Wt[g.b],L=Wt[g.c],At[bt]=C.x,At[bt+1]=C.y,At[bt+2]=C.z,At[bt+3]=k.x,At[bt+4]=k.y,At[bt+5]=k.z,At[bt+6]=L.x,At[bt+7]=L.y,At[bt+8]=L.z,bt+=9;for(d=0,v=Vt.length;d<v;d++)g=$t[Vt[d]],C=Wt[g.a],k=Wt[g.b],L=Wt[g.c],A=Wt[g.d],At[bt]=C.x,At[bt+1]=C.y,At[bt+2]=C.z,At[bt+3]=k.x,At[bt+4]=k.y,At[bt+5]=k.z,At[bt+6]=L.x,At[bt+7]=L.y,At[bt+8]=L.z,At[bt+9]=A.x,At[bt+10]=A.y,At[bt+11]=A.z,bt+=12;u.bindBuffer(u.ARRAY_BUFFER,a.__webglVertexBuffer),u.bufferData(u.ARRAY_BUFFER,At,i),a.__vertexArray=At}if(zt&&c){for(d=0,v=Xt.length;d<v;d++)g=$t[Xt[d]],S=g.vertexColors,Jt&&Jt.length>0&&(S[0]=Jt[g.a],S[1]=Jt[g.b],S[2]=Jt[g.c]),x=g.color,S.length===3&&c===n.VertexColors?(F=S[0],I=S[1],q=S[2]):(F=x,I=x,q=x),Dt[Nt]=F.r,Dt[Nt+1]=F.g,Dt[Nt+2]=F.b,Dt[Nt+3]=I.r,Dt[Nt+4]=I.g,Dt[Nt+5]=I.b,Dt[Nt+6]=q.r,Dt[Nt+7]=q.g,Dt[Nt+8]=q.b,Nt+=9;for(d=0,v=Vt.length;d<v;d++)g=$t[Vt[d]],S=g.vertexColors,x=g.color,S.length===4&&c===n.VertexColors?(F=S[0],I=S[1],q=S[2],R=S[3]):(F=x,I=x,q=x,R=x),Dt[Nt]=F.r,Dt[Nt+1]=F.g,Dt[Nt+2]=F.b,Dt[Nt+3]=I.r,Dt[Nt+4]=I.g,Dt[Nt+5]=I.b,Dt[Nt+6]=q.r,Dt[Nt+7]=q.g,Dt[Nt+8]=q.b,Dt[Nt+9]=R.r,Dt[Nt+10]=R.g,Dt[Nt+11]=R.b,Nt+=12;Nt>0&&(u.bindBuffer(u.ARRAY_BUFFER,a.__webglColorBuffer),u.bufferData(u.ARRAY_BUFFER,Dt,i))}if(Ut&&l){for(d=0,v=Xt.length;d<v;d++){g=$t[Xt[d]],y=g.vertexNormals,b=g.normal;if(y.length===3&&p)for(ot=0;ot<3;ot++)at=y[ot],_t[xt]=at.x,_t[xt+1]=at.y,_t[xt+2]=at.z,xt+=3;else for(ot=0;ot<3;ot++)_t[xt]=b.x,_t[xt+1]=b.y,_t[xt+2]=b.z,xt+=3}for(d=0,v=Vt.length;d<v;d++){g=$t[Vt[d]],y=g.vertexNormals,b=g.normal;if(y.length===4&&p)for(ot=0;ot<4;ot++)at=y[ot],_t==null&&console.log("normal array is null"),_t[xt]=at.x,_t[xt+1]=at.y,_t[xt+2]=at.z,xt+=3;else for(ot=0;ot<4;ot++)_t[xt]=b.x,_t[xt+1]=b.y,_t[xt+2]=b.z,xt+=3}u.bindBuffer(u.ARRAY_BUFFER,a.__webglNormalBuffer),u.bufferData(u.ARRAY_BUFFER,_t,i),a.__normalArray=_t}if(Rt&&Kt&&h){for(d=0,v=Xt.length;d<v;d++){m=Xt[d],T=Kt[m];if(T===t)continue;for(ot=0;ot<3;ot++)ft=T[ot],Ot[wt]=ft.x,Ot[wt+1]=ft.y,wt+=2}for(d=0,v=Vt.length;d<v;d++){m=Vt[d],T=Kt[m];if(T===t)continue;for(ot=0;ot<4;ot++)ft=T[ot],Ot[wt]=ft.x,Ot[wt+1]=ft.y,wt+=2}wt>0&&(u.bindBuffer(u.ARRAY_BUFFER,a.__webglUVBuffer),u.bufferData(u.ARRAY_BUFFER,Ot,i),a.uvArray=Ot)}if(Rt&&Qt&&h){for(d=0,v=Xt.length;d<v;d++){m=Xt[d],N=Qt[m];if(N===t)continue;for(ot=0;ot<3;ot++)lt=N[ot],Mt[Et]=lt.x,Mt[Et+1]=lt.y,Et+=2}for(d=0,v=Vt.length;d<v;d++){m=Vt[d],N=Qt[m];if(N===t)continue;for(ot=0;ot<4;ot++)lt=N[ot],Mt[Et]=lt.x,Mt[Et+1]=lt.y,Et+=2}Et>0&&(u.bindBuffer(u.ARRAY_BUFFER,a.__webglUV2Buffer),u.bufferData(u.ARRAY_BUFFER,Mt,i))}if(qt){for(d=0,v=Xt.length;d<v;d++)Bt[St]=yt,Bt[St+1]=yt+1,Bt[St+2]=yt+2,St+=3,jt[Tt]=yt,jt[Tt+1]=yt+1,jt[Tt+2]=yt,jt[Tt+3]=yt+2,jt[Tt+4]=yt+1,jt[Tt+5]=yt+2,Tt+=6,yt+=3;for(d=0,v=Vt.length;d<v;d++)Bt[St]=yt,Bt[St+1]=yt+1,Bt[St+2]=yt+3,Bt[St+3]=yt+1,Bt[St+4]=yt+2,Bt[St+5]=yt+3,St+=6,jt[Tt]=yt,jt[Tt+1]=yt+1,jt[Tt+2]=yt,jt[Tt+3]=yt+3,jt[Tt+4]=yt+1,jt[Tt+5]=yt+2,jt[Tt+6]=yt+2,jt[Tt+7]=yt+3,Tt+=8,yt+=4;u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,a.__webglFaceBuffer),u.bufferData(u.ELEMENT_ARRAY_BUFFER,Bt,i),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,a.__webglLineBuffer),u.bufferData(u.ELEMENT_ARRAY_BUFFER,jt,i),a.__lineArray=jt}if(Pt)for(ot=0,ut=Pt.length;ot<ut;ot++){Ht=Pt[ot];if(!Ht.__original.needsUpdate)continue;Ct=0,kt=0;if(Ht.size===1){if(Ht.boundTo===t||Ht.boundTo==="vertices"){for(d=0,v=Xt.length;d<v;d++)g=$t[Xt[d]],Ht.array[Ct]=Ht.value[g.a],Ht.array[Ct+1]=Ht.value[g.b],Ht.array[Ct+2]=Ht.value[g.c],Ct+=3;for(d=0,v=Vt.length;d<v;d++)g=$t[Vt[d]],Ht.array[Ct]=Ht.value[g.a],Ht.array[Ct+1]=Ht.value[g.b],Ht.array[Ct+2]=Ht.value[g.c],Ht.array[Ct+3]=Ht.value[g.d],Ct+=4}else if(Ht.boundTo==="faces"){for(d=0,v=Xt.length;d<v;d++)Lt=Ht.value[Xt[d]],Ht.array[Ct]=Lt,Ht.array[Ct+1]=Lt,Ht.array[Ct+2]=Lt,Ct+=3;for(d=0,v=Vt.length;d<v;d++)Lt=Ht.value[Vt[d]],Ht.array[Ct]=Lt,Ht.array[Ct+1]=Lt,Ht.array[Ct+2]=Lt,Ht.array[Ct+3]=Lt,Ct+=4}}else if(Ht.size===2){if(Ht.boundTo===t||Ht.boundTo==="vertices"){for(d=0,v=Xt.length;d<v;d++)g=$t[Xt[d]],C=Ht.value[g.a],k=Ht.value[g.b],L=Ht.value[g.c],Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=k.x,Ht.array[Ct+3]=k.y,Ht.array[Ct+4]=L.x,Ht.array[Ct+5]=L.y,Ct+=6;for(d=0,v=Vt.length;d<v;d++)g=$t[Vt[d]],C=Ht.value[g.a],k=Ht.value[g.b],L=Ht.value[g.c],A=Ht.value[g.d],Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=k.x,Ht.array[Ct+3]=k.y,Ht.array[Ct+4]=L.x,Ht.array[Ct+5]=L.y,Ht.array[Ct+6]=A.x,Ht.array[Ct+7]=A.y,Ct+=8}else if(Ht.boundTo==="faces"){for(d=0,v=Xt.length;d<v;d++)Lt=Ht.value[Xt[d]],C=Lt,k=Lt,L=Lt,Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=k.x,Ht.array[Ct+3]=k.y,Ht.array[Ct+4]=L.x,Ht.array[Ct+5]=L.y,Ct+=6;for(d=0,v=Vt.length;d<v;d++)Lt=Ht.value[Vt[d]],C=Lt,k=Lt,L=Lt,A=Lt,Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=k.x,Ht.array[Ct+3]=k.y,Ht.array[Ct+4]=L.x,Ht.array[Ct+5]=L.y,Ht.array[Ct+6]=A.x,Ht.array[Ct+7]=A.y,Ct+=8}}else if(Ht.size===3){var Yt;Ht.type==="c"?Yt=["r","g","b"]:Yt=["x","y","z"];if(Ht.boundTo===t||Ht.boundTo==="vertices"){for(d=0,v=Xt.length;d<v;d++)g=$t[Xt[d]],C=Ht.value[g.a],k=Ht.value[g.b],L=Ht.value[g.c],Ht.array[Ct]=C[Yt[0]],Ht.array[Ct+1]=C[Yt[1]],Ht.array[Ct+2]=C[Yt[2]],Ht.array[Ct+3]=k[Yt[0]],Ht.array[Ct+4]=k[Yt[1]],Ht.array[Ct+5]=k[Yt[2]],Ht.array[Ct+6]=L[Yt[0]],Ht.array[Ct+7]=L[Yt[1]],Ht.array[Ct+8]=L[Yt[2]],Ct+=9;for(d=0,v=Vt.length;d<v;d++)g=$t[Vt[d]],C=Ht.value[g.a],k=Ht.value[g.b],L=Ht.value[g.c],A=Ht.value[g.d],Ht.array[Ct]=C[Yt[0]],Ht.array[Ct+1]=C[Yt[1]],Ht.array[Ct+2]=C[Yt[2]],Ht.array[Ct+3]=k[Yt[0]],Ht.array[Ct+4]=k[Yt[1]],Ht.array[Ct+5]=k[Yt[2]],Ht.array[Ct+6]=L[Yt[0]],Ht.array[Ct+7]=L[Yt[1]],Ht.array[Ct+8]=L[Yt[2]],Ht.array[Ct+9]=A[Yt[0]],Ht.array[Ct+10]=A[Yt[1]],Ht.array[Ct+11]=A[Yt[2]],Ct+=12}else if(Ht.boundTo==="faces"){for(d=0,v=Xt.length;d<v;d++)Lt=Ht.value[Xt[d]],C=Lt,k=Lt,L=Lt,Ht.array[Ct]=C[Yt[0]],Ht.array[Ct+1]=C[Yt[1]],Ht.array[Ct+2]=C[Yt[2]],Ht.array[Ct+3]=k[Yt[0]],Ht.array[Ct+4]=k[Yt[1]],Ht.array[Ct+5]=k[Yt[2]],Ht.array[Ct+6]=L[Yt[0]],Ht.array[Ct+7]=L[Yt[1]],Ht.array[Ct+8]=L[Yt[2]],Ct+=9;for(d=0,v=Vt.length;d<v;d++)Lt=Ht.value[Vt[d]],C=Lt,k=Lt,L=Lt,A=Lt,Ht.array[Ct]=C[Yt[0]],Ht.array[Ct+1]=C[Yt[1]],Ht.array[Ct+2]=C[Yt[2]],Ht.array[Ct+3]=k[Yt[0]],Ht.array[Ct+4]=k[Yt[1]],Ht.array[Ct+5]=k[Yt[2]],Ht.array[Ct+6]=L[Yt[0]],Ht.array[Ct+7]=L[Yt[1]],Ht.array[Ct+8]=L[Yt[2]],Ht.array[Ct+9]=A[Yt[0]],Ht.array[Ct+10]=A[Yt[1]],Ht.array[Ct+11]=A[Yt[2]],Ct+=12}else if(Ht.boundTo==="faceVertices"){for(d=0,v=Xt.length;d<v;d++)Lt=Ht.value[Xt[d]],C=Lt[0],k=Lt[1],L=Lt[2],Ht.array[Ct]=C[Yt[0]],Ht.array[Ct+1]=C[Yt[1]],Ht.array[Ct+2]=C[Yt[2]],Ht.array[Ct+3]=k[Yt[0]],Ht.array[Ct+4]=k[Yt[1]],Ht.array[Ct+5]=k[Yt[2]],Ht.array[Ct+6]=L[Yt[0]],Ht.array[Ct+7]=L[Yt[1]],Ht.array[Ct+8]=L[Yt[2]],Ct+=9;for(d=0,v=Vt.length;d<v;d++)Lt=Ht.value[Vt[d]],C=Lt[0],k=Lt[1],L=Lt[2],A=Lt[3],Ht.array[Ct]=C[Yt[0]],Ht.array[Ct+1]=C[Yt[1]],Ht.array[Ct+2]=C[Yt[2]],Ht.array[Ct+3]=k[Yt[0]],Ht.array[Ct+4]=k[Yt[1]],Ht.array[Ct+5]=k[Yt[2]],Ht.array[Ct+6]=L[Yt[0]],Ht.array[Ct+7]=L[Yt[1]],Ht.array[Ct+8]=L[Yt[2]],Ht.array[Ct+9]=A[Yt[0]],Ht.array[Ct+10]=A[Yt[1]],Ht.array[Ct+11]=A[Yt[2]],Ct+=12}}else if(Ht.size===4)if(Ht.boundTo===t||Ht.boundTo==="vertices"){for(d=0,v=Xt.length;d<v;d++)g=$t[Xt[d]],C=Ht.value[g.a],k=Ht.value[g.b],L=Ht.value[g.c],Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=C.z,Ht.array[Ct+3]=C.w,Ht.array[Ct+4]=k.x,Ht.array[Ct+5]=k.y,Ht.array[Ct+6]=k.z,Ht.array[Ct+7]=k.w,Ht.array[Ct+8]=L.x,Ht.array[Ct+9]=L.y,Ht.array[Ct+10]=L.z,Ht.array[Ct+11]=L.w,Ct+=12;for(d=0,v=Vt.length;d<v;d++)g=$t[Vt[d]],C=Ht.value[g.a],k=Ht.value[g.b],L=Ht.value[g.c],A=Ht.value[g.d],Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=C.z,Ht.array[Ct+3]=C.w,Ht.array[Ct+4]=k.x,Ht.array[Ct+5]=k.y,Ht.array[Ct+6]=k.z,Ht.array[Ct+7]=k.w,Ht.array[Ct+8]=L.x,Ht.array[Ct+9]=L.y,Ht.array[Ct+10]=L.z,Ht.array[Ct+11]=L.w,Ht.array[Ct+12]=A.x,Ht.array[Ct+13]=A.y,Ht.array[Ct+14]=A.z,Ht.array[Ct+15]=A.w,Ct+=16}else if(Ht.boundTo==="faces"){for(d=0,v=Xt.length;d<v;d++)Lt=Ht.value[Xt[d]],C=Lt,k=Lt,L=Lt,Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=C.z,Ht.array[Ct+3]=C.w,Ht.array[Ct+4]=k.x,Ht.array[Ct+5]=k.y,Ht.array[Ct+6]=k.z,Ht.array[Ct+7]=k.w,Ht.array[Ct+8]=L.x,Ht.array[Ct+9]=L.y,Ht.array[Ct+10]=L.z,Ht.array[Ct+11]=L.w,Ct+=12;for(d=0,v=Vt.length;d<v;d++)Lt=Ht.value[Vt[d]],C=Lt,k=Lt,L=Lt,A=Lt,Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=C.z,Ht.array[Ct+3]=C.w,Ht.array[Ct+4]=k.x,Ht.array[Ct+5]=k.y,Ht.array[Ct+6]=k.z,Ht.array[Ct+7]=k.w,Ht.array[Ct+8]=L.x,Ht.array[Ct+9]=L.y,Ht.array[Ct+10]=L.z,Ht.array[Ct+11]=L.w,Ht.array[Ct+12]=A.x,Ht.array[Ct+13]=A.y,Ht.array[Ct+14]=A.z,Ht.array[Ct+15]=A.w,Ct+=16}else if(Ht.boundTo==="faceVertices"){for(d=0,v=Xt.length;d<v;d++)Lt=Ht.value[Xt[d]],C=Lt[0],k=Lt[1],L=Lt[2],Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=C.z,Ht.array[Ct+3]=C.w,Ht.array[Ct+4]=k.x,Ht.array[Ct+5]=k.y,Ht.array[Ct+6]=k.z,Ht.array[Ct+7]=k.w,Ht.array[Ct+8]=L.x,Ht.array[Ct+9]=L.y,Ht.array[Ct+10]=L.z,Ht.array[Ct+11]=L.w,Ct+=12;for(d=0,v=Vt.length;d<v;d++)Lt=Ht.value[Vt[d]],C=Lt[0],k=Lt[1],L=Lt[2],A=Lt[3],Ht.array[Ct]=C.x,Ht.array[Ct+1]=C.y,Ht.array[Ct+2]=C.z,Ht.array[Ct+3]=C.w,Ht.array[Ct+4]=k.x,Ht.array[Ct+5]=k.y,Ht.array[Ct+6]=k.z,Ht.array[Ct+7]=k.w,Ht.array[Ct+8]=L.x,Ht.array[Ct+9]=L.y,Ht.array[Ct+10]=L.z,Ht.array[Ct+11]=L.w,Ht.array[Ct+12]=A.x,Ht.array[Ct+13]=A.y,Ht.array[Ct+14]=A.z,Ht.array[Ct+15]=A.w,Ct+=16}u.bindBuffer(u.ARRAY_BUFFER,Ht.buffer),u.bufferData(u.ARRAY_BUFFER,Ht.array,i)}s&&E.deleteGroupBufferData(e)},E.buildLineBufferData=function(e,n,r,i){var s,o,u,a,f,l,c=e,h=c.vertices,p=c.colors,d=c.lineDistances,v=h.length,m=p.length,g=d.length,y=i.__vertexArray,b=i.__colorArray,w=i.__lineDistanceArray,E=c.verticesNeedUpdate,S=c.colorsNeedUpdate,x=c.lineDistancesNeedUpdate,T=c.__webglCustomAttributesList,N,C,k,L,A,O,M;if(E){for(s=0;s<v;s++)a=h[s],f=s*3,y[f]=a.x,y[f+1]=a.y,y[f+2]=a.z;r.bindBuffer(r.ARRAY_BUFFER,i.__webglVertexBuffer),r.bufferData(r.ARRAY_BUFFER,y,n)}if(S){for(o=0;o<m;o++)l=p[o],f=o*3,b[f]=l.r,b[f+1]=l.g,b[f+2]=l.b;r.bindBuffer(r.ARRAY_BUFFER,i.__webglColorBuffer),r.bufferData(r.ARRAY_BUFFER,b,n)}if(x){for(u=0;u<g;u++)w[u]=d[u];r.bindBuffer(r.ARRAY_BUFFER,i.__webglLineDistanceBuffer),r.bufferData(r.ARRAY_BUFFER,w,n)}if(T)for(N=0,C=T.length;N<C;N++){M=T[N];if(M.needsUpdate&&(M.boundTo===t||M.boundTo==="vertices")){f=0,A=M.value.length;if(M.size===1)for(L=0;L<A;L++)M.array[L]=M.value[L];else if(M.size===2)for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,f+=2;else if(M.size===3)if(M.type==="c")for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.r,M.array[f+1]=O.g,M.array[f+2]=O.b,f+=3;else for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,M.array[f+2]=O.z,f+=3;else if(M.size===4)for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,M.array[f+2]=O.z,M.array[f+3]=O.w,f+=4;r.bindBuffer(r.ARRAY_BUFFER,M.buffer),r.bufferData(r.ARRAY_BUFFER,M.array,n)}}},E.buildLineBufferData=function(e,n,r,i){var s,o,u,a,f,l,c=e,h=c.vertices,p=c.colors,d=c.lineDistances,v=h.length,m=p.length,g=d.length,y=i.__vertexArray,b=i.__colorArray,w=i.__lineDistanceArray,E=c.verticesNeedUpdate,S=c.colorsNeedUpdate,x=c.lineDistancesNeedUpdate,T=c.__webglCustomAttributesList,N,C,k,L,A,O,M;if(E){for(s=0;s<v;s++)a=h[s],f=s*3,y[f]=a.x,y[f+1]=a.y,y[f+2]=a.z;r.bindBuffer(r.ARRAY_BUFFER,i.__webglVertexBuffer),r.bufferData(r.ARRAY_BUFFER,y,n)}if(S){for(o=0;o<m;o++)l=p[o],f=o*3,b[f]=l.r,b[f+1]=l.g,b[f+2]=l.b;r.bindBuffer(r.ARRAY_BUFFER,i.__webglColorBuffer),r.bufferData(r.ARRAY_BUFFER,b,n)}if(x){for(u=0;u<g;u++)w[u]=d[u];r.bindBuffer(r.ARRAY_BUFFER,i.__webglLineDistanceBuffer),r.bufferData(r.ARRAY_BUFFER,w,n)}if(T)for(N=0,C=T.length;N<C;N++){M=T[N];if(M.needsUpdate&&(M.boundTo===t||M.boundTo==="vertices")){f=0,A=M.value.length;if(M.size===1)for(L=0;L<A;L++)M.array[L]=M.value[L];else if(M.size===2)for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,f+=2;else if(M.size===3)if(M.type==="c")for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.r,M.array[f+1]=O.g,M.array[f+2]=O.b,f+=3;else for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,M.array[f+2]=O.z,f+=3;else if(M.size===4)for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,M.array[f+2]=O.z,M.array[f+3]=O.w,f+=4;r.bindBuffer(r.ARRAY_BUFFER,M.buffer),r.bufferData(r.ARRAY_BUFFER,M.array,n)}}},E.deleteGroupBufferData=function(e){delete e.__inittedArrays,delete e.__colorArray,delete e.__normalArray,delete e.__uvArray,delete e.__uv2Array,delete e.__faceArray,delete e.__vertexArray,delete e.__lineArray},E.getMaterial=function(e,t){var r=e.material;return r instanceof n.ArrayMaterial?(t>r.materials.length-1&&(t=r.materials.length-1),r.materials[t]):r},n.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(e){var t=e.familyName.toLowerCase(),n=this;n.faces[t]=n.faces[t]||{},n.faces[t][e.cssFontWeight]=n.faces[t][e.cssFontWeight]||{},n.faces[t][e.cssFontWeight][e.cssFontStyle]=e;var r=n.faces[t][e.cssFontWeight][e.cssFontStyle]=e;return e},drawText:function(e){var t=[],r=[],i,s,o=this.getFace(),u=this.size/o.resolution,a=0,f=String(e).split(""),l=f.length,c=[];for(i=0;i<l;i++){var h=new n.Path,p=this.extractGlyphPoints(f[i],o,u,a,h);a+=p.offset,c.push(p.path)}var d=a/2,v,m,g;for(i=0;i<l;i++){var h=c[i];for(g=0;g<h.actions.length;g++){var v=h.actions[g].args;for(m=0;m<v.length;m++)m%3===0&&(v[m]-=d)}}return{paths:c,offset:d}},extractGlyphPoints:function(e,t,r,i,s,o){var u=[],a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k=t.glyphs[e]||t.glyphs["?"],L=0;if(!k)return;if(k.o){c=k._cachedOutline||(k._cachedOutline=k.o.split(" ")),p=c.length,d=r,v=r;for(a=0;a<p;){h=c[a++];switch(h){case"m":m=c[a++]*d+i,g=c[a++]*v-L,s.moveTo(m,g,0);break;case"l":m=c[a++]*d+i,g=c[a++]*v-L,s.lineTo(m,g,0);break;case"q":y=c[a++]*d+i,b=c[a++]*v-L,S=c[a++]*d+i,x=c[a++]*v-L,s.quadraticCurveTo(S,x,0,y,b,0),C=u[u.length-1];if(C){w=C.x,E=C.y;for(f=1,l=this.divisions;f<=l;f++)var A=f/l,O=n.Shape.Utils.b2(A,w,S,y),M=n.Shape.Utils.b2(A,E,x,b)}break;case"b":y=c[a++]*d+i,b=c[a++]*v-L,S=c[a++]*d+i,x=c[a++]*-v-L,T=c[a++]*d+i,N=c[a++]*-v-L,s.bezierCurveTo(y,b,0,S,x,0,T,N,0),C=u[u.length-1];if(C){w=C.x,E=C.y;for(f=1,l=this.divisions;f<=l;f++)var A=f/l,O=n.Shape.Utils.b3(A,w,S,T,y),M=n.Shape.Utils.b3(A,E,x,N,b)}}}}return{offset:k.ha*r,path:s}}},n.FontUtils.generateShapes=function(e,r){r=r||{};var i=r.size!==t?r.size:100,s=r.curveSegments!==t?r.curveSegments:4,o=r.font!==t?r.font:"helvetiker",u=r.weight!==t?r.weight:"normal",a=r.style!==t?r.style:"normal";n.FontUtils.size=i,n.FontUtils.divisions=s,n.FontUtils.face=o,n.FontUtils.weight=u,n.FontUtils.style=a;var f=n.FontUtils.drawText(e),l=f.paths,c=[];for(var h=0,p=l.length;h<p;h++)Array.prototype.push.apply(c,l[h].toShapes());return c},function(e){var t=1e-10,n=function(e,t){var n=e.length;if(n<3)return null;var s=[],o=[],u=[],a,f,l;if(r(e)>0)for(f=0;f<n;f++)o[f]=f;else for(f=0;f<n;f++)o[f]=n-1-f;var c=n,h=2*c;for(f=c-1;c>2;){if(h--<=0)return console.log("Warning, unable to triangulate polygon!"),t?u:s;a=f,c<=a&&(a=0),f=a+1,c<=f&&(f=0),l=f+1,c<=l&&(l=0);if(i(e,a,f,l,c,o)){var p,d,v,m,g;p=o[a],d=o[f],v=o[l],s.push([e[p],e[d],e[v]]),u.push([o[a],o[f],o[l]]);for(m=f,g=f+1;g<c;m++,g++)o[m]=o[g];c--,h=2*c}}return t?u:s},r=function(e){var t=e.length,n=0;for(var r=t-1,i=0;i<t;r=i++)n+=e[r].x*e[i].y-e[i].x*e[r].y;return n*.5},i=function(e,n,r,i,s,o){var u,a,f,l,c,h,p,d,v;a=e[o[n]].x,f=e[o[n]].y,l=e[o[r]].x,c=e[o[r]].y,h=e[o[i]].x,p=e[o[i]].y;if(t>(l-a)*(p-f)-(c-f)*(h-a))return!1;var m,g,y,b,w,E,S,x,T,N,C,k,L,A,O;m=h-l,g=p-c,y=a-h,b=f-p,w=l-a,E=c-f;for(u=0;u<s;u++){if(u===n||u===r||u===i)continue;d=e[o[u]].x,v=e[o[u]].y,S=d-a,x=v-f,T=d-l,N=v-c,C=d-h,k=v-p,O=m*N-g*T,L=w*x-E*S,A=y*k-b*C;if(O>=-t&&A>=-t&&L>=-t)return!1}return!0};return e.Triangulate=n,e.Triangulate.area=r,e}(n.FontUtils),self._typeface_js={faces:n.FontUtils.faces,loadFace:n.FontUtils.loadFace},n.typeface_js=self._typeface_js;var N={easeNone:function(e,t,n,r){return n*e/r+t},easeIn:function(e,t,n,r){return n*(e/=r)*e+t},easeOut:function(e,t,n,r){return-n*(e/=r)*(e-2)+t},easeBoth:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},easeInStrong:function(e,t,n,r){return n*(e/=r)*e*e*e+t},easeOutStrong:function(e,t,n,r){return-n*((e=e/r-1)*e*e*e-1)+t},easeBothStrong:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e*e*e+t:-n/2*((e-=2)*e*e*e-2)+t},elasticIn:function(e,t,n,r,i,s){var o;return e===0?t:(e/=r)===1?t+n:(s||(s=r*.3),!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),-(i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s))+t)},elasticOut:function(e,t,n,r,i,s){var o;return e===0?t:(e/=r)===1?t+n:(s||(s=r*.3),!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),i*Math.pow(2,-10*e)*Math.sin((e*r-o)*2*Math.PI/s)+n+t)},elasticBoth:function(e,t,n,r,i,s){var o;return e===0?t:(e/=r/2)===2?t+n:(s||(s=r*.3*1.5),!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),e<1?-0.5*i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)+t:i*Math.pow(2,-10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)*.5+n+t)},backIn:function(e,n,r,i,s){return s===t&&(s=1.70158),e===i&&(e-=.001),r*(e/=i)*e*((s+1)*e-s)+n},backOut:function(e,t,n,r,i){return typeof i=="undefined"&&(i=1.70158),n*((e=e/r-1)*e*((i+1)*e+i)+1)+t},backBoth:function(e,t,n,r,i){return typeof i=="undefined"&&(i=5.70158),(e/=r/2)<1?n/2*e*e*(((i*=1.525)+1)*e-i)+t:n/2*((e-=2)*e*(((i*=1.525)+1)*e+i)+2)+t},bounceIn:function(e,t,n,r){return n-N.bounceOut(r-e,0,n,r)+t},bounceOut:function(e,t,n,r){return(e/=r)<1/2.75?n*7.5625*e*e+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t},bounceBoth:function(e,t,n,r){return e<r/2?N.bounceIn(e*2,0,n,r)*.5+t:N.bounceOut(e*2-r,0,n,r)*.5+n*.5+t}},C=function(){this._as=[];if(arguments.length===1){var e=arguments[0];e instanceof C&&(e=e._as);if(e instanceof Array){var t=e.length;for(var n=0;n<t;n++)this._as.push(e[n])}else e!=null&&this._as.push(e)}else if(arguments.length>1){t=arguments.length;for(n=0;n<t;n++)this._as.push(arguments[n])}};n.List=C,n.extend(n.List,Object,{size:function(){return this._as.length},isEmpty:function(){return this._as.length===0},add:function(e,n){return n===t?this._as.push(e):this._as.splice(n,0,e)},addAll:function(e){e instanceof C&&(e=e._as);if(e instanceof Array){var t=e.length;for(var n=0;n<t;n++)this._as.push(e[n])}else this._as.push(e)},get:function(e){return this._as[e]},remove:function(e){var t=this._as.indexOf(e);return t>=0&&t<this._as.length&&this.removeAt(t),t},removeAt:function(e){return this._as.splice(e,1)[0]},set:function(e,t){return this._as[e]=t},clear:function(){return this._as.splice(0,this._as.length)},contains:function(e){return this.indexOf(e)>=0},indexOf:function(e){return this._as.indexOf(e)},forEach:function(e,t){var n=this._as.length;for(var r=0;r<n;r++){var i=this._as[r];t?e.call(t,i):e(i)}},forEachReverse:function(e,t){var n=this._as.length;for(var r=n-1;r>=0;r--){var i=this._as[r];t?e.call(t,i):e(i)}},toArray:function(e,t){if(e){var n=[],r=this._as.length;for(var i=0;i<r;i++){var s=this._as[i];t?e.call(t,s)&&n.push(s):e(s)&&n.push(s)}return n}return this._as.concat()},toList:function(e,t){if(e){var n=new C,r=this._as.length;for(var i=0;i<r;i++){var s=this._as[i];t?e.call(t,s)&&n.add(s):e(s)&&n.add(s)}return n}return new C(this)},sort:function(e){return e?this._as.sort(e):this._as.sort(),this},toString:function(){return this._as.toString()}}),n.ImageCache=function(){};var k=n.ImageCache;k.AlarmBillboardImage=new Image,k.AlarmBillboardImage.src="data:image/png;base64,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"
,k.Logo=new Image,k.Logo.src="data:image/png;base64,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"
,n.ImageUtils={},n.ImageUtils.registerDefaultImage=function(e){e.src!=null?k.Logo.src=e.src:k.Logo.src=e},n.ImageUtils.registerAlarmImage=function(e){e.src!=null?k.AlarmBillboardImage.src=e.src:k.AlarmBillboardImage.src=e},k.ssaoNormalImage=new Image,k.ssaoNormalImage.src="data:image/png;base64,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",k.ssaoNormalImage.loaded=!0,n.EventDispatcher=function(){this.listeners={}},n.extend(n.EventDispatcher,null,{constructor:n.EventDispatcher,addEventListener:function(e,n){this.listeners[e]===t&&(this.listeners[e]=[]),this.listeners[e].indexOf(n)===-1&&this.listeners[e].push(n)},removeEventListener:function(e,t){var n=this.listeners[e].indexOf(t);n!==-1&&this.listeners[e].splice(n,1)},dispatchEvent:function(e){var n=this.listenters[e.type];if(n!=t){e.target=this;for(var r=0;r<n.length;r++){var i=n[r];i.call(this,e)}}},contains:function(e,t){if(this._ls)for(var n=0,r=this._ls.size(),i;n<r;n++){i=this._ls.get(n);if(e===i.l&&t===i.s)return!0}return!1},add:function(e,t,n){if(e==null){console.error("TGL.EventDispatcher#add:listener is null");return}var r={l:e,s:t,a:n};this._ls||(this._ls=new C),this._f?(this._addPendings||(this._addPendings=new C),this._addPendings.add(r)):r.a?this._ls.add(r,0):this._ls.add(r)},remove:function(e,t){this._ls&&(this._f?(this._removePendings||(this._removePendings=new C),this._removePendings.add({l:e,s:t})):this._remove(e,t))},_remove:function(e,t){for(var n=0,r=this._ls.size(),i;n<r;n++){i=this._ls.get(n);if(i.l===e&&i.s===t){this._ls.removeAt(n);return}}},fire:function(e){if(this._ls){var t,n=this._ls.size(),r;this._f=!0;for(t=0;t<n;t++)r=this._ls.get(t),r.s?r.l.call(r.s,e):r.l(e);this._f=!1;if(this._removePendings){n=this._removePendings.size();for(t=0;t<n;t++)r=this._removePendings.get(t),this._remove(r.l,r.s);delete this._removePendings}if(this._addPendings){n=this._addPendings.size();for(t=0;t<n;t++)r=this._addPendings.get(t),r.a?this._ls.add(r,0):this._ls.add(r);delete this._addPendings}}}}),n.PropertyChangeDispatcher=function(){this._dispatcher=new n.EventDispatcher},n.extend(n.PropertyChangeDispatcher,Object,{addPropertyChangeListener:function(e,t,n){this._dispatcher.add(e,t,n)},removePropertyChangeListener:function(e,t){this._dispatcher.remove(e,t)},firePropertyChange:function(e,t,n){if(t==n)return!1;var r={property:e,oldValue:t,newValue:n,source:this};return this._dispatcher.fire(r),this.onPropertyChanged(r),!0},onPropertyChanged:function(e){}}),n.Texture=function(e,r,i,s,o,u,a,f,l){n.PropertyChangeDispatcher.call(this),this.id=n.TextureIdCount++,this.name="",e!=null&&this.setImage(e),this.mipmaps=[],this.mapping=r!==t?r:new n.UVMapping,this.wrapS=i!==t?i:n.RepeatWrapping,this.wrapT=s!==t?s:n.RepeatWrapping,this.magFilter=o!==t?o:n.LinearFilter,this.minFilter=u!==t?u:n.LinearMipMapLinearFilter,this.anisotropy=l!==t?l:1,this.format=a!==t?a:n.RGBAFormat,this.type=f!==t?f:n.UnsignedByteType,this.repeatX=1,this.repeatY=1,this.offsetX=0,this.offsetY=0,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!1,this.flipX=!1,this.unpackAlignment=4,this.needsUpdate=!1,this.onUpdate=null},n.extend(n.Texture,n.PropertyChangeDispatcher,{getUniqueCode:function(){if(p.isImage(this._image)||typeof this._image=="string"||H.isArray(this._image))return this._imageSrc+" "+this.format+" "+this.type+" "+" "+this.wrapS+" "+this.wrapT+" "+this.magFilter+" "+this.minFilter+" "+this.flipY+" "+this.flipX+this.anisotropy;if(p.isCanvas(this._image)){var e=this._image;return e.__uniqueCode||(e.__uniqueCode=n.id("texture")),e.__uniqueCode+" "+this.format+" "+this.type+" "+this.wrapS+" "+this.wrapT+" "+this.magFilter+" "+this.minFilter+" "+this.flipY+" "+this.flipX+this.anisotropy}},resetValue:function(){this.name="",this._image=null,this.mipmaps=[],this.mapping=new n.UVMapping,this.wrapS=n.RepeatWrapping,this.wrapT=n.RepeatWrapping,this.magFilter=n.LinearFilter,this.minFilter=n.LinearMipMapLinearFilter,this.anisotropy=1,this.format=n.RGBAFormat,this.type=n.UnsignedByteType,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!1,this.flipX=!1,this.unpackAlignment=4,this.needsUpdate=!1,this.onUpdate=null},clone:function(e,r){return e===t&&(e=new n.Texture),r==null||r?e.setImage(this._image):e._image=this._image,e._imageSrc=this._imageSrc,e.mipmaps=this.mipmaps.slice(0),e.mapping=this.mapping,e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.format=this.format,e.type=this.type,e.generateMipmaps=this.generateMipmaps,e.premultiplyAlpha=this.premultiplyAlpha,e.flipY=this.flipY,e.flipX=this.flipX,e.unpackAlignment=this.unpackAlignment,e},onloadTexture:function(){},setImageSrc:function(e){if(typeof e=="string")this._imageSrc=e;else if(H.isArray(e)){var t="";for(var n=0;n<e.length;n++)typeof e[n]=="string"?t+=e:t+=e[n].src;this._imageSrc=t}else this._imageSrc=e.src},loadAllImages:function(e,t){function s(s){s.onload=function(){s.loaded=!0,s.onload=null,r++,r==n&&(i.onloadTexture(),i.firePropertyChange("image",t,i._image),e.loaded=!0)}}var n=e.length,r=0,i=this;for(var o=0;o<n;o++)s(e[o])},setImage:function(e){var t=this._image;if(H.isArray(e)){var n="",r=[],i;for(var s=0;s<e.length;s++)typeof e[s]=="string"?(n+=e,i=new Image,e[s].startsWith("data:image")||(i.crossOrigin="use-credentials"),i.src=e[s],r.push(i)):(n+=e[s].src,r.push(e[s]));this._imageSrc=n,this.loadAllImages(r,t),this._image=r}else if(typeof e=="string"){if(this._image&&this._image.src===e)return;this._imageSrc=e;var o=new Image;e.startsWith("data:image")||(o.crossOrigin="use-credentials"),o.src=e;var u=this;u._image=o,o.onload=function(e){o.loaded=!0,o.onload=null,u.onloadTexture(),u.firePropertyChange("image",t,o)}}else{if(this._image===e)return;this._imageSrc=e.src;var t=this._image;p.isCanvas(e)&&(e.loaded=!0);if(e&&!e.loaded){var u=this;u._image=e;var a=e.onload;e.onload=function(n){a&&a.call(null,n),e.loaded=!0,e.onload=null,u.onloadTexture(),u.firePropertyChange("image",t,e)}}else this._image=e,this.firePropertyChange("image",t,e)}},getImage:function(){return this._image},dispose:function(){this.firePropertyChange("disposed",!1,!0)}}),n.TextureIdCount=0,n.PixelsTexture=function(e,t,r,i,s,o,u,a,f,l,c){n.Texture.call(this,null,o,u,a,f,l,i,s,c),this.image={data:e,width:t,height:r}},n.PixelsTexture.prototype=Object.create(n.Texture.prototype),n.PixelsTexture.prototype.clone=function(){var e=new n.PixelsTexture;return n.Texture.prototype.clone.call(this,e),e},n.CompressedTexture=function(e,t,r,i,s,o,u,a,f,l,c){n.Texture.call(this,null,o,u,a,f,l,i,s,c),this.image={width:t,height:r},this.mipmaps=e,this.generateMipmaps=!1},n.CompressedTexture.prototype=Object.create(n.Texture.prototype),n.CompressedTexture.prototype.clone=function(){var e=new n.CompressedTexture;return n.Texture.prototype.clone.call(this,e),e};var L={pools:{},useTimes:{},size:0,setTexture:function(e,t){L.size++,L.pools[e]=t},getTexture:function(e){return L.pools[e]},useTexture:function(e){if(e){var t=e.id,n=L.useTimes[t]||0;n++,L.useTimes[t]=n}},unUseTexture:function(e){if(e){var t=e.id,n=L.useTimes[t]||0;n--,L.useTimes[t]=n;if(n<=0){var r=e.getUniqueCode();delete L.pools[r],L.size--,e.dispose()}}},clear:function(){this.pools={},this.useTimes={},this.size=0}};n.TexturePool=L,n.TexturePool.TestTexture=new n.Texture,n.SerializationSettings=function(){var e=n.SerializationSettings;this.isDataBoxSerializable=e.isDataBoxSerializable,this.isStyleSerializable=e.isStyleSerializable,this.isClientSerializable=e.isClientSerializable,this.encodeURI=e.encodeURI,this._pm=n.clone(e._pm),this._sm=n.clone(e._sm),this._cm=n.clone(e._cm)},function(){var e=n.SerializationSettings;e.isDataBoxSerializable=!0,e.isStyleSerializable=!0,e.isClientSerializable=!0,e.encodeURI=!0,e._pm={},e._sm={},e._cm={},e.setPropertyType=function(t,n){e._pm[t]=n},e.getPropertyType=function(t){return e._pm[t]},e.setStyleType=function(t,n){e._sm[t]=n},e.getStyleType=function(t){return e._sm[t]},e.setClientType=function(t,n){e._cm[t]=n},e.getClientType=function(t){return e._cm[t]}}(),n.extend(n.SerializationSettings,Object,{setPropertyType:function(e,t){this._pm[e]=t},getPropertyType:function(e){return this._pm[e]},setStyleType:function(e,t){this._sm[e]=t},getStyleType:function(e){return this._sm[e]},setClientType:function(e,t){this._cm[e]=t},getClientType:function(e){return this._cm[e]}}),n.Styles={_m:{},setStyle:function(e,t){return t==null?delete n.Styles._m[e]:n.Styles._m[e]=t,n.Styles},getStyle:function(e){return n.Styles._m[e]}},n.Styles.MaterailType="S:m.type",n.Styles.NormalType="S:m.normalType",n.Styles.PREFIX_STYLE="S:",function(){var e=function(e,t){n.SerializationSettings.setPropertyType(e,t)};e("combos","data.list"),e("name","cdata"),e("toolTip","cdata"),e("parent","data"),e("fromNode","data"),e("toNode","data"),e("alarmState","alarmstate"),e("vertices","list.vec3"),e("faces","serializeabe.list"),e("uvs","list.vec2"),e("position","vec3"),e("rotation","vec3"),e("scale","vec3"),e("location","point"),e("materialSize","number"),e("color","color"),e("ambient","color"),e("diffuse","color"),e("specular","color"),e("intensity","number"),e("distance","number"),e("type","number"),e("startClosed","boolean"),e("endClosed","boolean"),e("curveSegments","number"),e("amount","number"),e("vertical","boolean"),e("repeat","number"),e("centralized","boolean"),e("visible","boolean"),e=function(e,t,r){r==null&&(t!=null?t instanceof n.Vec2?r="vec2":t instanceof n.Vec3?r="vec3":r=typeof t:r="string"),n.Styles.setStyle(e,t),n.SerializationSettings.setStyleType(e,r)},e("select.style","border"),e("select.width",1),e("select.color",65280),e("select.offset",0),e("outer.width",1),e("outer.offset",0),e("outer.color",null,"color"),e("m.type","basic"),e("m.color",16777215,"color"),e("m.side","front"),e("m.alphaTest",0),e("m.polygonOffset",!1),e("m.polygonOffsetFactor",0),e("m.polygonOffsetUnits",0),e("m.wireframe",!1),e("m.wireframeLinewidth",1),e("m.wireframeLinecolor",16777215,"color"),e("m.wireframeLineopacity",1),e("m.gradient",{}),e("m.gradientType",1),e("m.transparent",!1),e("m.opacity",1),e("m.visible",!0),e("m.depthTest",!0),e("m.depthMask",!0),e("m.alignment",new n.Vec2(0,0)),e("m.linewidth",1),e("m.texture.image",null),e("m.texture.offset",new n.Vec2(0,0)),e("m.texture.repeat",new n.Vec2(1,1)),e("m.texture.wrapS",n.RepeatWrapping),e("m.texture.wrapT",n.RepeatWrapping),e("m.texture.flipX",!1),e("m.texture.flipY",!1),e("m.normalmap.image",null),e("m.envmap.image",null),e("m.specularmap.image",null),e("right.m.type","basic"),e("left.m.type","basic"),e("top.m.type","basic"),e("bottom.m.type","basic"),e("front.m.type","basic"),e("back.m.type","basic"),e("side.m.type","basic"),e("alarm.billboard.scale",null),e("alarm.billboard.position","top"),e("alarm.billboard.vertical",!1),e("annotation.class","tgl_annotation")}(),n.extend(n.Styles,Object,{}),n.BoundingBox=function(e,n){this.min=e!==t?e:new f(Infinity,Infinity,Infinity),this.max=n!==t?n:new f(-Infinity,-Infinity,-Infinity)},n.BoundingBox.prototype={constructor:n.BoundingBox,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var n=1,r=e.length;n<r;n++)t=e[n],t.x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y),t.z<this.min.z?this.min.z=t.z:t.z>this.max.z&&(this.max.z=t.z)}else this.makeEmpty();return this},setFromCenterAndSize:function(e,t){var r=n.BoundingBox.__v1.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=0,this.max.x=this.max.y=this.max.z=0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},center:function(e){var t=e||new f;return t.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(e){var t=e||new f;return t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z?!1:!0},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z?!0:!1},getParameter:function(e){return new f((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(e){return e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z?!1:!0},clampPoint:function(e,t){var n=t||new f;return(new f).copy(e).clamp(this.min,this.max)},distanceToPoint:function(e){var t=n.BoundingBox.__v1.copy(e).clamp(this.min,this.max);return t.sub(e).length()},getBoundingSphere:function(e){var t=e||new n.Sphere;return t.center=this.center(),t.radius=this.size(n.BoundingBox.__v0).length()*.5,t},intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},transform:function(e){var t=[n.BoundingBox.__v0.set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),n.BoundingBox.__v0.set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),n.BoundingBox.__v1.set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),n.BoundingBox.__v2.set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),n.BoundingBox.__v3.set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),n.BoundingBox.__v4.set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),n.BoundingBox.__v5.set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),n.BoundingBox.__v6.set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),n.BoundingBox.__v7.set(this.max.x,this.max.y,this.max.z).applyMatrix4(e)];return this.makeEmpty(),this.setFromPoints(t),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new n.BoundingBox).copy(this)}},n.BoundingBox.__v0=new f,n.BoundingBox.__v1=new f,n.BoundingBox.__v2=new f,n.BoundingBox.__v3=new f,n.BoundingBox.__v4=new f,n.BoundingBox.__v5=new f,n.BoundingBox.__v6=new f,n.BoundingBox.__v7=new f,n.BoundingSphere=function(e,n){this.center=e!==t?e:new f,this.radius=n!==t?n:0},n.BoundingSphere.prototype={constructor:n.BoundingSphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromCenterAndPoints:function(e,t){var n=0;for(var r=0,i=t.length;r<i;r++){var s=e.distanceToSquared(t[r]);n=Math.max(n,s)}return this.center=e,this.radius=Math.sqrt(n),this},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsBoundingSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},clampPoint:function(e,t){var n=this.center.distanceToSquared(e),r=t||new f;return r.copy(e),n>this.radius*this.radius&&(r.sub(this.center).normalize(),r.multiplyScalar(this.radius).add(this.center)),r},getBoundingBox:function(e){var t=e||new n.Box3;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},transform:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius},clone:function(){return(new n.BoundingSphere).copy(this)}},n.Primitive=function(e,t){e=e||{},this.data=e,this.vertices=e.vertices,this.faces=e.faces,this.uvs=e.uvs,this.uv2s=e.uv2s,this.colors=e.colors||[],this.uniqueCode=t},n.extend(n.Primitive,Object,{clone:function(e){if(e){var t={},r;t.vertices=[];for(r=0;r<this.vertices.length;r++)t.vertices.push(this.vertices[r].clone());t.faces=[];for(r=0;r<this.faces.length;r++)t.faces.push(this.faces[r].clone());t.uvs=[];for(r=0;r<this.uvs.length;r++){var i=this.uvs[r],s=[];for(var o=0;o<i.length;o++)s.push(i[o].clone);t.uvs.push(s)}t.uv2s=[];for(r=0;r<this.uv2s.length;r++)t.uv2s.push(this.uv2s[r].clone());return new n.Primitive(t)}return new n.Primitvie(this.data)}}),n.PrimitiveCache={_cache:{},_useCount:{},getPrimitive:function(e){return e?n.PrimitiveCache._cache[e]:null},setPrimitive:function(e,t){e&&(n.PrimitiveCache._cache[e]=t)},usePrimitive:function(e){var t=n.PrimitiveCache._useCount[e]||0;t++,n.PrimitiveCache._useCount[e]=t},unUsePrimitive:function(e){var t=n.PrimitiveCache._useCount[e]||0;t--,t<=0&&delete n.PrimitiveCache._useCount[e]}},n.PrimitiveGroupCache={},n.Color=function(e){return e!==t&&this.set(e),this},n.extend(n.Color,Object,{r:1,g:1,b:1,getUniqueCode:function(){return""+this.r+this.g+this.b},set:function(e){switch(typeof e){case"number":this.setHex(e);break;case"string":this.setStyle(e)}},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,this},setRGB:function(e,t,n){return this.r=e,this.g=t,this.b=n,this},setHSV:function(e,t,n){var r,i,s,o,u;return n===0?this.r=this.g=this.b=0:(r=Math.floor(e*6),i=e*6-r,s=n*(1-t),o=n*(1-t*i),u=n*(1-t*(1-i)),r===0?(this.r=n,this.g=u,this.b=s):r===1?(this.r=o,this.g=n,this.b=s):r===2?(this.r=s,this.g=n,this.b=u):r===3?(this.r=s,this.g=o,this.b=n):r===4?(this.r=u,this.g=s,this.b=n):r===5&&(this.r=n,this.g=s,this.b=o)),this},setStyle:function(e){if(/^rgb\((\d+),(\d+),(\d+)\)$/i.test(e)){var t=/^rgb\((\d+),(\d+),(\d+)\)$/i.exec(e);return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,this}if(/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.test(e)){var t=/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.exec(e);return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,this}if(/^\#([0-9a-f]{6})$/i.test(e)){var t=/^\#([0-9a-f]{6})$/i.exec(e);return this.setHex(parseInt(t[1],16)),this}if(/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(e)){var t=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(e);return this.setHex(parseInt(t[1]+t[1]+t[2]+t[2]+t[3]+t[3],16)),this}if(/^(\w+)$/i.test(e))return this.setHex(n.ColorKeywords[e]),this},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e){return this.r=e.r*e.r,this.g=e.g*e.g,this.b=e.b*e.b,this},copyLinearToGamma:function(e){return this.r=Math.sqrt(e.r),this.g=Math.sqrt(e.g),this.b=Math.sqrt(e.b),this},convertGammaToLinear:function(){var e=this.r,t=this.g,n=this.b;return this.r=e*e,this.g=t*t,this.b=n*n,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return this.r*255<<16^this.g*255<<8^this.b*255<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getStyle:function(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"},getHSV:function(e){var n=this.r,r=this.g,i=this.b,s=Math.max(Math.max(n,r),i),o=Math.min(Math.min(n,r),i),u,a,f=s;if(o===s)u=0,a=0;else{var l=s-o;a=l/s,n===s?u=(r-i)/l:r===s?u=2+(i-n)/l:u=4+(n-r)/l,u/=6,u<0&&(u+=1),u>1&&(u-=1)}return e===t&&(e={h:0,s:0,v:0}),e.h=u,e.s=a,e.v=f,e},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},clone:function(){return(new n.Color).setRGB(this.r,this.g,this.b)},toString:function(){return this.getStyle()}}),n.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885
,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},n.Data=function(e){n.PropertyChangeDispatcher.call(this),this._childList=new C,this._childMap={},this._clientMap={};if(e===t||e===null)this._id=n.id("E");else if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")this._id=e;else{for(var r in e)if(r==="clients")for(var i in e.clients)this._clientMap[i]=e.clients[i];else r==="styles"?this.s(e.styles):e[r]!=null&&(r==="id"?this._id=e[r]:this[n.setter(r)]&&this[n.setter(r)](e[r]));this._id==null&&(this._id=n.id("E"))}},n.extend(n.Data,n.PropertyChangeDispatcher,{___accessor:["name"],constructor:n.Data,getId:function(){return this._id},onAlarmChange:function(){},onPropertyChange:function(e,t,n){},setGroupId:function(e){if(this._groupId===e)return;var t=this._groupId;this._groupId=e,this.firePropertyChange("groupId",t,e)},getGroupId:function(){return this._groupId},hasChildren:function(){return this._childList.size()>0},getChildren:function(){return this._childList},isDescendantOf:function(e){if(!e)return!1;if(!e.hasChildren())return!1;var t=this._parent;while(t){if(e===t)return!0;t=t.getParent()}return!1},getParent:function(){return this._parent},getRoot:function(){var e=this._parent;return e&&e._parent==null?e:e&&e._parent!=null?e.getRoot(e):arguments[0]},setParent:function(e){e===null&&e===t;if(this._isUpdatingParent||this._parent===e||this===e)return;if(e&&e.isDescendantOf(this))return;var n=this._parent;this._parent=e,this._isUpdatingParent=!0,n&&n.removeChild(this),e&&e.addChild(this),delete this._isUpdatingParent,this.firePropertyChange("parent",n,e),this.onParentChanged(n,e)},onParentChanged:function(e,t){},addChild:function(e,n){n===t&&(n=this._childList.size());if(!e||e===this)return!1;if(this._childMap[e.getId()])return!1;if(this.isDescendantOf(e))return!1;e.getParent()&&e.getParent().removeChild(e);if(n<0||n>this._childList.size())n=this._childList.size();return this._childList.add(e,n),this._childMap[e._id]=e,e.setParent(this),this.firePropertyChange("children",null,e),this.onChildAdded(e,n),!0},onChildAdded:function(e,t){},clearChildren:function(){if(this._childList!=null&&this._childList.size()>0){var e=this._childList.toList(),t=this;e.forEach(function(e){t.removeChild(e)})}},removeChild:function(e){if(!e)return!1;if(!this._childMap[e._id])return!1;var t=this._childList.remove(e);return delete this._childMap[e._id],this.firePropertyChange("children",e,null),e.setParent(null),this.onChildRemoved(e,t),!0},onChildRemoved:function(e,t){},c:function(e){if(e)for(var t in e)this.setClient(t,e[t])},setClient:function(e,t){if(e==null)return this;this._clientMap==null&&(this._clientMap=new Object);var n=this._clientMap[e];return n===t?this:(t==null?delete this._clientMap[e]:this._clientMap[e]=t,this._clientMap[e]=t,this.firePropertyChange("C:"+e,n,t),this.onClientChanged(e,n,t),this)},getClient:function(e){return this._clientMap[e]},onClientChanged:function(e,t,n){},setPropertyValue:function(e,t){if(this[e]===t)return!1;var r=this[e];return r instanceof n.Color&&t!=null?(r=r.clone(),t instanceof n.Color?this[e].copy(t):this[e].set(t)):this[e]=t,!0}}),n.Element=function(e){this.styleMap={},this._visible=!0,this._selected=!1,this._selectable=!0,this._editable=!0,this.editing=!1,this.up=new f(0,1,0),this._position=new f(0,0,0),this._rotation=new f(0,0,0),this._scale=new f(1,1,1),this.eulerOrder=n.defaultEulerOrder,this.rotationAutoUpdate=!0,this.matrix=new h,this.worldMatrix=new h,this.rotationWorldMatrix=new h,this.matrixAutoUpdate=!1,this.worldMatrixNeedsUpdate=!0,this.quaternion=new n.Quat,this.useQuaternion=!1,this._sizeFixed=!1,this._fixedSize=108,this.castShadow=!0,this.receiveShadow=!0,this.frustumCulled=!0,this._vector=new f,this.renderDepth=null,this._attachId="",this._groupId=null,this.editTransformToParent=!1,this._alarmState=new n.AlarmState(this),n.Data.call(this,e)},n.Element.__m1=new h,n.ElementIdCount=0,n.extend(n.Element,n.Data,{IStyle:!0,___accessor:["visible","selected","selectable","editable","sizeFixed"],constructor:n.Element,getAlarmState:function(){return this._alarmState},onAlarmChange:function(e,t){var r=this._alarmState.getHighestNativeAlarmSeverity();r?this.setStyle("m.alarmColor",new n.Color(r.color)):this.setStyle("m.alarmColor",null)},getDefaultInstance:function(){return this.constructor.defaultInstance===t&&(this.constructor.defaultInstance=new this.constructor),this.constructor.defaultInstance},onParentChanged:function(e,t){this.updateWorldMatrix(!0,!1)},onChildAdded:function(e,t){e.updateWorldMatrix(!0,!1)},onChildRemoved:function(e,t){e.updateWorldMatrix(!0,!1)},generatePrimitiveKey:function(){return null},serializeProperty:function(){},clear:function(e){},getSelectStyle:function(){return this.getStyle("select.style")},isSpaceChangedProperty:function(e){return e==="scale"||e==="position"||e==="rotation"},isStyleEquals:function(e,t,n){return t==null&&n==null?!0:t===n},setStyle:function(e,t){if(e==null)return this;this.styleMap==null&&(this.styleMap={});var r=this.styleMap[e];return this.isStyleEquals(e,r,t)?this:(t==null?delete this.styleMap[e]:this.styleMap[e]=t,this.onStyleChanged(e,r,t),this.firePropertyChange(n.Styles.PREFIX_STYLE+e,r,t),this)},c:function(e){if(!e)return;for(var t in e)this.setClient(t,e[t])},s:function(e){if(e==null)return this;this.styleMap==null&&(this.styleMap={});var t,r,i,s={},o={};for(t in e){r=e[t],i=this.styleMap[t];if(this.isStyleEquals(t,i,r))continue;r==null?delete this.styleMap[t]:this.styleMap[t]=r,o[t]=i,this.isMaterialStyle(t)&&(s[t]=[r,i])}this.onMaterialStylesChanged(s);for(t in e)this.firePropertyChange(n.Styles.PREFIX_STYLE+t,o[t],this.styleMap[t]);return this},getStyle:function(e,t,n){n==null&&(n=!0);var r;return this.styleMap!=null&&(r=this.styleMap[e]),t&&(r=this.getCloneObject(r)),r==null&&n&&(r=this.getDefaultStyle(e,t)),r},getCloneObject:function(e){if(e==null)return null;if(n.Utils.isArray(e)){var t=[];for(var r=0;r<e.length;r++)t.push(this.getCloneObject(e[r]));return t}return e.clone?e.clone():e},getSideIndexMapping:function(){},setMaterialStyle:function(e,t){},setMaterialStyles:function(e){var t,r,s,o;for(var u in e){if(u.startsWith("m."))t=u.substr(u.indexOf(".")+1);else if(this.getSideIndexMapping()&&this.isSideStyle(s)){var a=s.substr(0,s.indexOf(".")),f=this.getSideMaterialIndex(a);if(f!=i)continue;s=s.substr(s.indexOf(".")+1),t=s.substr(u.indexOf(".")+1)}else u.startsWith("alarm.billboard.")&&(o=!0);var l=e[u];r=l[0],r==null?r=n.Styles.getStyle(u):H.isArray(r)&&(r=r[i]),this._A97(this.material,t,r)}o&&this._alarmBillboard&&this._setAlarmBillboardPositionAndSize(this._alarmBillboard)},onMaterialStylesChanged:function(e){this.setMaterialStyles(e)},isMaterialStyle:function(e){return e.startsWith("m.")?!0:this.getSideIndexMapping()&&this.isSideStyle(e)?!0:!1},onStyleChanged:function(e,t,n){if(e.startsWith("m."))this.setMaterialStyle(e,n);else if(this.getSideIndexMapping()&&this.isSideStyle(e)){var r=e.substr(0,e.indexOf("."));e=e.substr(e.indexOf(".")+1);var i=this.getSideMaterialIndex(r);this.setMaterialStyle(e,n,i)}else e.startsWith("alarm.billboard.")&&this._alarmBillboard&&this._setAlarmBillboardPositionAndSize(this._alarmBillboard)},textureMapping:{texture:"map",texture1:"map1",texture2:"map2",textureb:"blendMap",texturebp:"bumpMap",lightMap:"lightMap",lightmap:"lightMap",normalmap:"normalMap",envmap:"envMap",specularmap:"specularMap"},_A97:function(e,t,r){if(t.startsWith("texture.")||t.startsWith("texture1.")||t.startsWith("texture2.")||t.startsWith("textureb.")||t.startsWith("texturen.")||t.startsWith("texturebp.")||t.startsWith("lightmap")||t.startsWith("envmap")||t.startsWith("normalmap")||t.startsWith("specularmap")){var i=t.substr(0,t.indexOf(".")),s=t.substr(t.indexOf(".")+1);if(s==="offset"||s==="repeat"){e.setPropertyValue(s,this.getCloneObject(r));return}var o=this.textureMapping[i],u=e[o],a=n.TexturePool.TestTexture;if(s==="image"){var f=r;if(t.startsWith("envmap")&&H.isArray(f))for(var l=0;l<f.length;l++)if(f[l]==null){f=null;break}if(u==null&&f!=null){a.resetValue(),a._image=f,a.setImageSrc(f);var c=a.getUniqueCode(),h=n.TexturePool.getTexture(c);h==null&&(h=new n.Texture(f),n.TexturePool.setTexture(c,h)),e.setMap(h,o)}else if(f==null)e.setMap(null,o);else{u.clone(a,!1),a._image=f,a.setImageSrc(f);var c=a.getUniqueCode(),h=n.TexturePool.getTexture(c);h!==u&&(h==null&&(h=new n.Texture,u.clone(h,!1),h.setImage(f),n.TexturePool.setTexture(c,h)),e.setMap(h,o))}}else if(u!=null){u.clone(a,!1),a[s]=this.getCloneObject(r);var c=a.getUniqueCode(),h=n.TexturePool.getTexture(c);h!=u&&(h==null&&(h=new n.Texture,u.clone(h),h[s]=r),e.setMap(h,o))}}else t==="type"&&e.setType?e.setType(r):e.setPropertyValue(t,this.getCloneObject(r))},getDefaultStyle:function(e,t){if(e==null)return null;if(e.startsWith("m.")){var r=[],i=e.substr(e.indexOf(".")+1);if(this.material.materials){var s=this.material.materials;s=s||[this.material];for(var o=0;o<s.length;o++){var u=s[o];if(i.startsWith("texture.")||i.startsWith("texture1.")||i.startsWith("texture2.")||i.startsWith("textureb.")||i.startsWith("texturen.")||i.startsWith("texturebp.")||i.startsWith("lightmap")||i.startsWith("envmap")||i.startsWith("normalmap")||i.startsWith("specularmap")){var a=i.substr(0,i.indexOf(".")),f=i.substr(i.indexOf(".")+1),l=i.substr(i.indexOf(".")+1),c=this.textureMapping[a],h=u[c];if(h)if(f==="image")if(H.isArray(h._image)){var p=[];r.push(p);for(var d=0;d<h._image.length;d++)p.push(h._image[d].src)}else r.push(h._image.src);else f==="offset"||f==="repeat"?r.push(u[f]):r.push(u.map[f]);else r.push(n.Styles.getStyle(e))}else{var v=n.Styles.getStyle(e);r.push(v==null?u[i]:v)}}}t&&(r=this.getCloneObject(r));var m=!0;for(var o=0;o<r.length;o++)if(r.indexOf(r[o])!=0){m=!1;break}return m?r[0]:r}if(this.isSideStyle(e)){var g=e.substr(0,e.indexOf("."));e=e.substr(e.indexOf(".")+1);var i=e.substr(e.indexOf(".")+1),y=this.getSideMaterialIndex(g);if(y!=null){var v,u=this.material.materials[y];return i.startsWith("texture.")?u.map&&(i==="texture.image"?v=u.map._image.src:v=u.map[i]):v=u[i],t&&(v=this.getCloneObject(v)),v}}return n.Styles.getStyle(e)},isSideStyle:function(e){if(e.indexOf(".")===-1)return!1;var n=this.getSideIndexMapping();if(!n)return!1;var r=e.substr(0,e.indexOf("."));return n[r]!==t?!0:!1},setUp:function(e,t,n){var r;if(arguments.length===3){if(this.up.x===e&&this.up.y===t&&this.up.z===n)return;r=new f(e,t,n)}else{if(this.up.x===e.x&&this.up.y===e.y&&this.up.z===e.z)return;r=e}var i=this.up;this.up=r,this.onUpChanged(i,r),this.firePropertyChange("up",i,r)},getUp:function(){return this.up},onUpChanged:function(e,t){},checkNumber:function(e,t,n,r){H.isNaN(e)&&console.error(r+",x is not a number"),H.isNaN(t)&&console.error(r+",y is not a number"),H.isNaN(n)&&console.error(r+",z is not a number")},invalidateTexture:function(e){var t=this.material,r,i,s,o;if(e!=null&&t instanceof n.ArrayMaterial){if(typeof e=="string"){var u=this.getSideIndexMapping();u!=null&&(e=u[e]);if(e==null)return}if(typeof e!="number")return;t instanceof n.ArrayMaterial?s=t.materials[e]:s=materail,this._dirtyMaterialTexture(s)}else if(t instanceof n.ArrayMaterial){i=t.materials;for(r=0;r<i.length;r++)s=i[r],this._dirtyMaterialTexture(s)}else this._dirtyMaterialTexture(t)},_dirtyMaterialTexture:function(e){e!=null&&(e.map instanceof n.Texture&&this._dirtyTexture(e.map),e.lightMap instanceof n.Texture&&this._dirtyTexture(e.lightMap))},_dirtyTexture:function(e){var t=e._image;e.firePropertyChange("image",null,t)},p:function(e,t,n){if(arguments.length===0)return this.getPosition();arguments.length===3?this.setPosition(e,t,n):this.setPosition(e)},checkPosition:function(e){return!0},setPosition:function(e,t,n){var r;if(arguments.length===3){if(this._position.x===e&&this._position.y===t&&this._position.z===n)return;this.checkNumber(e,t,n,"setPosition"),r=new f(e,t,n)}else{if(this._position.x===e.x&&this._position.y===e.y&&this._position.z===e.z)return;if(!(e instanceof f))throw"Element.setPosition : position is not instanceof TGL.Vec3";r=e}if(!this.checkPosition(r))return;var i=this._position;this._position=r,this.updateWorldMatrix(!0,!1),this.firePropertyChange("position",i,r)},getPosition:function(e){return e==t&&(e=!0),e?this._position.clone():this._position},setPositionX:function(e){if(this._position.x===e)return;this.checkNumber(e,0,0,"setPositionX");var t=this._position.x,n=this._position.clone();n.x=e;if(!this.checkPosition(n))return!1;this._position.x=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("positionX",t,e)},setX:function(e){this.setPositionX(e)},getPositionX:function(){return this._position.x},getX:function(){return this.getPositionX()},setPositionY:function(e){if(this._position.y===e)return;this.checkNumber(0,e,0,"setPositionY");var t=this._position.y,n=this._position.clone();n.y=e;if(!this.checkPosition(n))return!1;this._position.y=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("positionY",t,e)},setY:function(e){this.setPositionY(e)},getPositionY:function(){return this._position.y},getY:function(){return this.getPositionY()},setPositionZ:function(e){if(this._position.z===e)return;this.checkNumber(0,0,e,"setPositionZ");var t=this._position.z,n=this._position.clone();n.z=e;if(!this.checkPosition(n))return!1;this._position.z=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("positionZ",t,e)},setZ:function(e){this.setPositionZ(e)},getPositionZ:function(){return this._position.z},getZ:function(){return this.getPositionZ()},setScale:function(e,t,n){var r;if(arguments.length===3){if(this._scale.x===e&&this._scale.y===t&&this._scale.z===n)return;this.checkNumber(e,t,n,"setScale"),r=new f(e,t,n)}else{if(this._scale.x===e.x&&this._scale.y===e.y&&this._scale.z===e.z)return;if(!(e instanceof f))throw"Element.setScale : scale is not instanceof TGL.Vec3";r=e}var i=this._scale;r.x=r.x||1,r.y=r.y||1,r.z=r.z||1,this._scale=r,this.updateWorldMatrix(!0,!1),this.firePropertyChange("scale",i,r)},getScale:function(e){return e==t&&(e=!0),e?this._scale.clone():this._scale},setScaleX:function(e){if(this._scale.x===e)return;this.checkNumber(e,0,0,"setScalX");var t=this._scale.x;this._scale.x=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("scaleX",t,e)},getScaleX:function(){return this._scale.x},setScaleY:function(e){if(this._scale.y===e)return;this.checkNumber(0,e,0,"setScaleY");var t=this._scale.y;this._scale.y=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("scaleY",t,e)},getScaleY:function(){return this._scale.y},setScaleZ:function(e){if(this._scale.z===e)return;this.checkNumber(0,0,e,"setScaleZ");var t=this._scale.z;this._scale.z=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("scaleZ",t,e)},getScaleZ:function(){return this._scale.z},setRotation:function(e,t,n){var r;if(arguments.length===3){if(this._rotation.x===e&&this._rotation.y===t&&this._rotation.z===n)return;this.checkNumber(e,t,n,"setRotation"),r=new f(e,t,n)}else{if(this._rotation.x===e.x&&this._rotation.y===e.y&&this._rotation.z===e.z)return;if(!(e instanceof f))throw"Element.setRotation : rotation is not instanceof TGL.Vec3";r=e}var i=this._rotation;this._rotation=r,this.updateWorldMatrix(!0,!1),this.firePropertyChange("rotation",i,r)},getRotation:function(e){return e==t&&(e=!0),e?this._rotation.clone():this._rotation},setRotationX:function(e){if(this._rotation.x===e)return;this.checkNumber(e,0,0,"setRotationX");var t=this._rotation.x;this._rotation.x=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("rotationX",t,e)},getRotationX:function(){return this._rotation.x},setRotationY:function(e){if(this._rotation.y===e)return;this.checkNumber(0,e,0,"setRotationY");var t=this._rotation.y;this._rotation.y=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("rotationY",t,e)},getRotationY:function(){return this._rotation.y},setRotationZ:function(e){if(this._rotation.z===e)return;this.checkNumber(0,0,e,"setRotationZ");var t=this._rotation.z;this._rotation.z=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("rotationZ",t,e)},getRotationZ:function(){return this._rotation.z},applyMatrix:function(e){var t=this.matrix.clone();this.matrix.multiplyMatrices(e,this.matrix),this._scale.getScaleFromMatrix(this.matrix);var n=(new h).extractRotation(this.matrix);this._rotation.setEulerFromRotationMatrix(n,this.eulerOrder),this._position.getPositionFromMatrix(this.matrix),this.updateWorldMatrix(!0,!1),this.firePropertyChange("matrix",t,this.matrix)},translate:function(e,t){this.matrix.rotateAxis(t),this.setPosition(this._position.clone().add(t.multiplyScalar(e)))},translateX:function(e){this.translate(e,this._vector.set(1,0,0))},translateY:function(e){this.translate(e,this._vector.set(0,1,0))},translateZ:function(e){this.translate(e,this._vector.set(0,0,1))},rotateFromAxis:function(e,t,n){t=t.clone().applyMatrix4(this.matrix),e=e.clone().normalize().applyMatrix4((new h).extractRotation(this.matrix));var r=(new h).makeRotationAxisAndCenter(e,n,t);this.applyMatrix(r)},rotateFromWorldAxis:function(e,t){var n=new h;n.makeRotationAxis(e.normalize(),t),n.multiply(this.matrix),this.matrix=n;var r=(new h).extractRotation(this.matrix),i=new f;i.setEulerFromRotationMatrix(r,this.eulerOrder),this.setRotation(i)},getEulerAngles:function(){return this.matrix.getEulerAngles()},rotateFromWorldXAxis:function(e){this.rotateFromWorldAxis(new f(1,0,0),e)},rotateFromWorldYAxis:function(e){this.rotateFromWorldAxis(new f(0,1,0),e)},rotateFromWorldZAxis:function(e){this.rotateFromWorldAxis(new f(0,0,1),e)},getRelativeTransform:function(e){if(e instanceof n.Element){var t=(new h).getInverse(e.matrix.clone()),r=(new h).multiplyMatrices(t,this.matrix.clone()),i=(new f).getPositionFromMatrix(r),s=(new f).setEulerFromRotationMatrix(r),o=(new f).getScaleFromMatrix(r),u={position:i,rotation:s,scale:o,matrix:r};return u}return null},localToWorld:function(e){return this._parent==null?e:e.clone().applyMatrix4(this._parent.worldMatrix)},localToWorld2:function(e){return e.clone().applyMatrix4(this.worldMatrix)},getWorldPosition:function(){return this.worldMatrix.getPosition()},direction:function(e){var t=e.applyMatrix4((new h).extractRotation(this.worldMatrix));return t.normalize(),t},frontDirection:function(){var e=new f(0,0,1);return e=e.applyMatrix4((new h).extractRotation(this.worldMatrix)),e.normalize(),e},worldPosition:function(e,t){t=t>0?t:e.length();var n=this.worldMatrix.getPosition();return n.add(this.direction(e).multiplyScalar(t))},frontWorldPosition:function(e){e=e>0?e:1;var t=this.worldMatrix.getPosition();return t.add(this.frontDirection().multiplyScalar(e))},worldToLocal:function(e){return e.clone().applyMatrix4(n.Element.__m1.getInverse(this.worldMatrix))},lookAt:function(e,t){this.matrix.lookAt(e,this._position,t?t:this.up),this.rotationAutoUpdate&&(this.useQuaternion===!1?this._rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder):this.quaternion.copy(this.matrix.decompose()[1])),this.worldMatrixNeedsUpdate=!0},iterator:function(e){e(this),this._childList&&this._childList.forEach(function(t){t.iterator(e)})},getChildByName:function(e,n){for(var r=0,i=this.children.length;r<i;r++){var s=this.children[r];if(s.name===e)return s;if(n===!0){s=s.getChildByName(e,n);if(s!==t)return s}}return t},getDescendants:function(e){e===t&&(e=[]);var n=this.getChildren().toArray();Array.prototype.push.apply(e,n);for(var r=0,i=n.length;r<i;r++)n[r].getDescendants(e);return e},fixSize:function(e){if(this._sizeFixed){this.updateWorldMatrix();var t=new f,n=new f;t.getPositionFromMatrix(this.worldMatrix),e.updateWorldMatrix(),n.getPositionFromMatrix(e.worldMatrix),scale=t.distanceTo(n)/this._fixedSize,scale===0&&(scale=1e-5),this.setScale(scale,scale,scale)}},updateMatrix:function(){this.matrix.setPosition(this._position),this.useQuaternion===!1?this.matrix.setRotationFromEuler(this._rotation,this.eulerOrder):this.matrix.setRotationFromQuaternion(this.quaternion),(this._scale.x!==1||this._scale.y!==1||this._scale.z!==1)&&this.matrix.scale(this._scale),this.worldMatrixNeedsUpdate=!0},updateWorldMatrix:function(e,n){n=n==t?!0:n,this.matrixAutoUpdate===!0&&this.updateMatrix();if(this.worldMatrixNeedsUpdate===!0||e===!0){this.matrixAutoUpdate===!1&&this.updateMatrix();var r=this.worldMatrix.clone();this._parent==t?this.worldMatrix.copy(this.matrix):this.worldMatrix.multiplyMatrices(this._parent.worldMatrix,this.matrix),this.worldMatrixNeedsUpdate=!1,e=!0,r.equals(this.worldMatrix)||(n&&this.firePropertyChange("worldMatrix",r,this.worldMatrix),this.updateCameraMatrix&&this.updateCameraMatrix(!1))}this._childList.forEach(function(t){t.updateWorldMatrix(e)})},cloneCallback:function(e){},clonePrefab:function(e){var r=new mono.Entity;e===t&&(e=!0),r.name=this.name,r.up==null&&(r.up=new f(0,1,0)),r.up.copy(this.up),r._position.copy(this._position),r._rotation.copy(this._rotation),r.eulerOrder=this.eulerOrder,r._scale.copy(this._scale),r.renderDepth=this.renderDepth,r.rotationAutoUpdate=this.rotationAutoUpdate,r.matrix.copy(this.matrix),r.worldMatrix.copy(this.worldMatrix),r.rotationWorldMatrix.copy(this.rotationWorldMatrix),r.matrixAutoUpdate=this.matrixAutoUpdate,r.worldMatrixNeedsUpdate=this.worldMatrixNeedsUpdate,r.quaternion.copy(this.quaternion),r.useQuaternion=this.useQuaternion,r._visible=this._visible,r.castShadow=this.castShadow,r.receiveShadow=this.receiveShadow,r.frustumCulled=this.frustumCulled,r.styleMap=r.styleMap||{},e&&this._childList&&this._childList.forEach(function(t){r.addChild(t.clonePrefab(e))}),r.vertices=this.vertices,r.faces=this.faces,r.uvs=this.uvs,r.uv2s=this.uv2s,this.primitive&&(r.primitive=this.primitive,r.data=this.primitive.data,r.computed=!0);for(var i in this.styleMap)r.styleMap[i]=this.getCloneObject(this.styleMap[i]);if(this._clientMap!=null)for(var s in this._clientMap)r.setClient(s,this._clientMap[s]);r.material=this.material;if(this.material instanceof n.ArrayMaterial){r.material=new n.ArrayMaterial,r.material.materials=[];for(var o=0;o<this.material.materials.length;o++)r.material.materials.push(this.material.materials[o])}return r.materialSize=this.getMaterialSize?this.getMaterialSize():1,r.boundingBox=this.boundingBox,r},createCloneObject:function(){return this.constructor?object=new this.constructor:object=new n.Element,object},clone:function(e,r,i){typeof e=="boolean"&&(i=r,r=e,e=t),e==t&&(e=this.createCloneObject()),i===t&&(i=!0),e.name=this.name,e.up==null&&(e.up=new f(0,1,0)),e.up.copy(this.up),e._position.copy(this._position),e._rotation.copy(this._rotation),e.eulerOrder=this.eulerOrder,e._scale.copy(this._scale),e.renderDepth=this.renderDepth,e.rotationAutoUpdate=this.rotationAutoUpdate,e.matrix.copy(this.matrix),e.worldMatrix.copy(this.worldMatrix),e.rotationWorldMatrix.copy(this.rotationWorldMatrix),e.matrixAutoUpdate=this.matrixAutoUpdate,e.worldMatrixNeedsUpdate=this.worldMatrixNeedsUpdate,e.quaternion.copy(this.quaternion),e.useQuaternion=this.useQuaternion,e._visible=this._visible,e.castShadow=this.castShadow,e.receiveShadow=this.receiveShadow,e.frustumCulled=this.frustumCulled,e.styleMap=e.styleMap||{},i&&this._childList&&this._childList.forEach(function(t){e.addChild(t.clone(r,i))});if(this.constructor){var s=this.constructor.prototype.__accessor,o=this.constructor.prototype.__bool;if(s&&s.length>0)for(var u=0;u<s.length;u++){var a=s[u],l=n.getter(a,o),c=n.setter(a);a==="vertices"?e.vertices=this.vertices:a==="faces"?e.faces=this.faces:e[c]&&e[c](this[l]())}}if(r&&this.vertices){var h=e,p=this.vertices;h.vertices=[],h.faces=[],h.uvs=[];for(var u=0,d=p.length;u<d;u++)h.vertices.push(p[u].clone());var v=this.faces;for(var u=0,d=v.length;u<d;u++)h.faces.push(v[u].clone());var m=this.uvs;for(var u=0,d=m.length;u<d;u++){var g=m[u],y=[];for(var b=0,w=g.length;b<w;b++)y.push(new n.Vec2(g[b].x,g[b].y));h.uvs.push(y)}}for(var E in this.styleMap)e.setStyle(E,this.getCloneObject(this.styleMap[E]));if(this._clientMap!=null)for(var S in this._clientMap)e.setClient(S,this._clientMap[S]);return e.cloneCallback(r),e}}),n.Annotation=function(e,t,r){n.Element.call(this,r),this._label=e,this._text=t,this._cameraPosition=null},n.extend(n.Annotation,n.Element,{___accessor:["label","text","cameraPosition"]}),n.Node=function(e){this.name="",this.computed=!1,this.selectionData=null,this.renderGroup=[],this.primitive=null,this.vertices=[],this.faces=[],this.uvs=[],this.uv2s=[],this.colors=this.colors||[],this.normals=[],this.faces=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.dynamic=!0,this.verticesNeedUpdate=!1,this.elementsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.buffersNeedUpdate=!1,this.computeNodeData(),this._alarmBillboard=null,n.Element.call(this,e)},n.extend(n.Node,n.Element,{__accessor:["vertices","faces","uvs","linkAgent"],__SizePropeties:[],setUpdateFlags:function(e){this.verticesNeedUpdate=e,this.elementsNeedUpdate=e,this.uvsNeedUpdate=e,this.normalsNeedUpdate=e,this.colorsNeedUpdate=e},getLinks:function(){return this._links},getFromLinks:function(){return this._fromLinks},getToLinks:function(){return this._toLinks},_addFromLink:function(e){this._allLinks||(this._allLinks=new C),this._fromLinks||(this._fromLinks=new C),this._allLinks.add(e),this._fromLinks.add(e),this._resetLinkSet()},_addToLink:function(e){this._allLinks||(this._allLinks=new C),this._toLinks||(this._toLinks=new C),this._allLinks.add(e),this._toLinks.add(e),this._resetLinkSet()},_removeFromLink:function(e){this._allLinks.remove(e),this._fromLinks.remove(e),this._allLinks.size()===0&&delete this._allLinks,this._fromLinks.size()===0&&delete this._fromLinks,this._resetLinkSet()},_removeToLink:function(e){this._allLinks.remove(e),this._toLinks.remove(e),this._allLinks.size()===0&&delete this._allLinks,this._toLinks.size()===0&&delete this._toLinks,this._resetLinkSet()},_resetLinkSet:function(){delete this._loopedLinks;if(!this._allLinks||this._allLinks.size()===0){delete this._links;return}var e;this._allLinks.forEach(function(t){t.isLooped()&&(e||(e={}),e[t._id]||(this._loopedLinks||(this._loopedLinks=new C),this._loopedLinks.add(t),e[t._id]=t))},this),e?(this._links=new C,this._allLinks.forEach(function(t){e[t._id]?e[t._id]!==!1&&(e[t._id]=!1,this._links.add(t)):this._links.add(t)},this)):this._links=this._allLinks},onAlarmChange:function(e,t){n.Element.prototype.onAlarmChange.call(this,e,t);var r=this;setTimeout(function(){var e=r._alarmState.getPropagateSeverity();e||(e=r._alarmState.getHighestNativeAlarmSeverity());var t=r._parent,i=!1;if(t==null||!t._alarmState)i=!0;else{var s=t._alarmState.getPropagateSeverity();s||(i=!0)}e&&i?(r._alarmBillboard==null&&r.setAlarmBillboard(new n.Billboard),r.setAlarmBillboardImageAndColor(r._alarmBillboard,e)):r.setAlarmBillboard(null)},10)},setAlarmBillboardImageAndColor:function(e,t){e.setStyle("m.texture.image",n.ImageCache.AlarmBillboardImage),e.setStyle("m.color",t.color),e.setStyle("m.alignment",n.BillboardAlignment.bottomCenter)},_setAlarmBillboardPositionAndSize:function(e){var t=this.getStyle("alarm.billboard.position"),n=this.getBoundingBox(),r=n.min,i=n.max,s=n.center(),o=n.size();t==="topLeft"?e._position.set(r.x,i.y,s.z+1):t==="topRight"?e._position.set(i.x,i.y,s.z+1):t==="topBack"?e._position.set(s.x,i.y,r.z-1):t==="topFront"?e._position.set(s.x,i.y,i.z+1):e._position.set(s.x,i.y,s.z+1);var u=this.getStyle("alarm.billboard.scale");u instanceof f?e._scale.copy(u):e._scale.set(o.x/2,o.x/2,1);var a=this.getStyle("alarm.billboard.vertical");e.setStyle("m.vertical",a)},getLinkOffset:function(e){return new mono.Vec3(0,0,0)},getLinkExtend:function(e){return new mono.Vec3(0,0,0)},clearLinkOrthogonal:function(e,t){return!1},clearLinkExtend:function(e,t){return!1},setAlarmBillboard:function(e){if(this._alarmBillboard==e)return;var t=this._alarmBillboard;e?(this._alarmBillboard=e,e.setParent(this),e.setClient("alarmBillboard",!0),this._setAlarmBillboardPositionAndSize(e)):(this._alarmBillboard.setParent(null),delete this._alarmBillboard),this.firePropertyChange("alarmBillboard",t,e)},needUpdate:function(){return this.verticesNeedUpdate||this.elementsNeedUpdate||this.uvsNeedUpdate||this.normalsNeedUpdate||this.colorsNeedUpdate},getVerticesWithChildren:function(e,t){function c(n){n.applyMatrix4(e),t.push(n)}t==null&&(t=[]),e==null&&(e=new h);var r,i;if(this instanceof n.Node){if(this.vertices!=null&&this.vertices.length!=0){var s=this.getBoundingBox(),o=s.min,u=s.max;c(o.clone()),c(u.clone()),c(new f(o.x,o.y,u.z)),c(new f(o.x,u.y,o.z)),c(new f(u.x,o.y,o.z)),c(new f(u.x,u.y,o.z)),c(new f(u.x,o.y,u.z)),c(new f(o.x,u.y,u.z))}for(var r=0;r<(this._childList?this._childList.size():0);r++){var a=this._childList.get(r),l=new h;l.multiplyMatrices(e,a.matrix.clone()),a.getVerticesWithChildren&&a.getVerticesWithChildren(l,t)}}return t},getBoundingBoxWithChildren:function(e){var t=this.getVerticesWithChildren();if(e)for(var r=0;r<e.length;r++){var i=e[r];if(i.getParent()===this.getParent()&&i!==this){var s=(new h).getInverse(this.matrix.clone()),o=(new h).multiplyMatrices(s,i.matrix.clone());t=t.concat(i.getVerticesWithChildren(o))}}var u=new n.BoundingBox;return u.setFromPoints(t),u},getWorldBoundingBox:function(){var e=[];for(var t=0;t<this.vertices.length;t++){var r=this.vertices[t].clone();r.applyMatrix4(this.worldMatrix),e.push(r)}var i=new n.BoundingBox;return i.setFromPoints(e),i},getBoundingBox:function(){return this.boundingBox==null&&this.computeBoundingBox(),this.boundingBox},computeBoundingBox:function(){this.boundingBox===null&&(this.boundingBox=new n.BoundingBox),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){this.boundingSphere===null&&(this.boundingSphere=new n.BoundingSphere),this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},createPropagateAlarmCube:function(e){this.boundingBox==null&&this.computeBoundingBox(),e._attachId=this._id;if(this.propagateAlarmData==null){var t=this.getStyle("outer.offset"),n=this.boundingBox.min,r=this.boundingBox.max;e.width=r.x-n.x+t,e.height=r.y-n.y+t,e.depth=r.z-n.z+t,e.computed=!1,e.computeNodeData(),this.propagateAlarmData=e.data,x(e,!0),this.propagateAlarmData.primitive=e.primitive,this.propagateAlarmData.groups=e.groups;var i=(new f).center(n,r);for(var s=0;s<e.vertices.length;s++){var o=e.vertices[s];o.add(i)}this.propagateAlarmData.vertices=e.vertices}else{var u=this.propagateAlarmData;e.primitive=u.primitive,e.data=u,e.vertices=u.vertices,e.uvs=u.uvs,e.faces=u.faces,e.groups=u.groups}this.updateMatrix(!0),e._position.copy(this._position),e._scale.copy(this._scale),e._rotation.copy(this._rotation),e.useQuaternion=this.useQuaternion,e.quaternion=this.quaternion,e.worldMatrix=this.worldMatrix,e._parent=this.getParent(),e.updateMatrix(!0);var a=e.material;a.wireframeLinewidth=this.getStyle("outer.width");var l=this.getAlarmState().getPropagateSeverity();return a.color.set(l.color),e},createCanvasSelectionCube:function(){return this._csc==null&&(this._csc=new _,this._csc.material=new n.EntityMaterial,this._csc.material.wireframe=!0),this.createSelectionCube(this._csc),this._csc},createSelectionCube:function(e){this.boundingBox==null&&this.computeBoundingBox(),e._attachId=this._id+"_selection";if(this.selectionData==null){var t=this.getStyle("select.offset"),n=this.boundingBox.min,r=this.boundingBox.max,i=(new f).center(n,r);e.width=r.x-n.x+t,e.height=r.y-n.y+t,e.depth=r.z-n.z+t,
e.offset=i,e.computed=!1;var s=e.computeNodeData();this.selectionData=e.data,x(e,!0),this.selectionData.primitive=e.primitive,this.selectionData.groups=e.groups,this.selectionData.vertices=e.vertices}else{var o=this.selectionData;e.primitive=o.primitive,e.data=o,e.vertices=o.vertices,e.uvs=o.uvs,e.faces=o.faces,e.groups=o.groups}this.updateMatrix(!0),e._position.copy(this._position),e._scale.copy(this._scale),e._rotation.copy(this._rotation),e.useQuaternion=this.useQuaternion,e.quaternion=this.quaternion,e.worldMatrix=this.worldMatrix,e._parent=this.getParent(),e.updateMatrix(!0);var u=e.material;return u.wireframeLinewidth=this.getStyle("select.width"),u.color.set(this.getStyle("select.color")),u.wireframeLinecolor.set(this.getStyle("select.color")),e},mergeVertices:function(){var e={},n=[],r=[],i,s,o=4,u=Math.pow(10,o),a,f,l,c,h,p,d,v;this.__tmpVertices=t,this.vertices==null&&console.log("vertices is null");for(a=0,f=this.vertices.length;a<f;a++)i=this.vertices[a],s=[Math.round(i.x*u),Math.round(i.y*u),Math.round(i.z*u)].join("_"),e[s]===t?(e[s]=a,n.push(this.vertices[a]),r[a]=n.length-1):r[a]=r[e[s]];var m=[];for(a=0,f=this.faces.length;a<f;a++){l=this.faces[a];if(l instanceof O){l.a=r[l.a],l.b=r[l.b],l.c=r[l.c],c=[l.a,l.b,l.c];var g=-1;for(var y=0;y<3;y++)if(c[y]==c[(y+1)%3]){g=y,m.push(a);break}}else if(l instanceof M){l.a=r[l.a],l.b=r[l.b],l.c=r[l.c],l.d=r[l.d],c=[l.a,l.b,l.c,l.d];var g=-1;for(var y=0;y<4;y++)c[y]==c[(y+1)%4]&&(g>=0&&m.push(a),g=y);if(g>=0){c.splice(g,1);var b=new O(c[0],c[1],c[2],l.normal,l.color,l.materialIndex);v=this.uvs[a],v&&v.splice(g,1),l.vertexNormals&&l.vertexNormals.length>0&&(b.vertexNormals=l.vertexNormals,b.vertexNormals.splice(g,1)),l.vertexColors&&l.vertexColors.length>0&&(b.vertexColors=l.vertexColors,b.vertexColors.splice(g,1)),this.faces[a]=b}}}for(a=m.length-1;a>=0;a--);var w=this.vertices.length-n.length;return this.vertices=n,w},computeVertexNormals:function(e){var r,i,s,o,u,a;if(this.__tmpVertices===t){this.__tmpVertices=new Array(this.vertices.length),a=this.__tmpVertices;for(r=0,i=this.vertices.length;r<i;r++)a[r]=new n.Vec3;for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],u.vertexNormals=[new n.Vec3,new n.Vec3,new n.Vec3]}else{a=this.__tmpVertices;for(r=0,i=this.vertices.length;r<i;r++)a[r].set(0,0,0)}if(e){var f={},l={},c,h,p,d,v=new n.Vec3,m=new n.Vec3,g=new n.Vec3,y=new n.Vec3,b=new n.Vec3,w;for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],c=this.vertices[u.a],h=this.vertices[u.b],p=this.vertices[u.c],v.subVectors(p,h),m.subVectors(c,h),v.cross(m),a[u.a].add(v),a[u.b].add(v),a[u.c].add(v),u.d!=t&&a[u.d].add(v)}else for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],a[u.a].add(u.normal),a[u.b].add(u.normal),a[u.c].add(u.normal);for(r=0,i=this.vertices.length;r<i;r++)a[r].normalize();for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],u.vertexNormals[0].copy(a[u.a]),u.vertexNormals[1].copy(a[u.b]),u.vertexNormals[2].copy(a[u.c]),u.d!=t&&(u.vertexNormals[3]=a[u.d].clone())},computeCentroids:function(){var e,t,n;for(e=0,t=this.faces.length;e<t;e++)n=this.faces[e],n.centroid=n.centroid||new f,n.centroid==null&&console.log("fdasfdsa"),n.centroid.set||(n.centroid=new f),n.centroid.set(0,0,0),n instanceof O?(n.centroid.add(this.vertices[n.a]),n.centroid.add(this.vertices[n.b]),n.centroid.add(this.vertices[n.c]),n.centroid.divideScalar(3)):n instanceof M&&(n.centroid.add(this.vertices[n.a]),n.centroid.add(this.vertices[n.b]),n.centroid.add(this.vertices[n.c]),n.centroid.add(this.vertices[n.d]),n.centroid.divideScalar(4))},computeFaceNormals:function(){var e,t,n,r,i,s,o,u,a,l,c,h=new f,p=new f;for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],a=this.vertices[u.a],l=this.vertices[u.b],c=this.vertices[u.c],h.subVectors(c,l),p.subVectors(a,l),h.cross(p),h.normalize(),u.normal.copy||(u.normal=new f),u.normal.copy(h)},computeLineDistances:function(){var e=0,t=this.vertices;for(var n=0,r=t.length;n<r;n++)n>0&&(e+=t[n].distanceTo(t[n-1])),this.lineDistances[n]=e},computeVertex:function(){},computePrimitive:function(){},generalteGroup:function(){},getMatetial:function(){return this.material},computeNodeMaterial:function(e){},cacheNodeMaterial:function(e){},needComputeVertexNormal:function(){return!0},needComputeLineDistance:function(){return!1},computeNodeData:function(e){if(this.computed===!1){var t=this.generatePrimitiveKey();this._attachId&&(t+="_"+this._attachId);var r=n.PrimitiveCache.getPrimitive(t),i=!1;if(!r){var s=this.computeData();this.needComputeVertexNormal()&&(n.Node.prototype.mergeVertices.call(s),n.Node.prototype.computeFaceNormals.call(s),n.Node.prototype.computeVertexNormals.call(s,!0));if(s.uv2s==null||s.uv2s.length==0){s.uv2s=[];if(s.uvs!=null&&s.uvs.length>0)for(var o=0;o<s.uvs.length;o++){var u=[],a=s.uvs[o];for(var f=0;f<a.length;f++)u.push(a[f].clone());s.uv2s.push(u)}}r=new n.Primitive(s,t),n.PrimitiveCache.setPrimitive(t,r),this.cacheNodeMaterial(r),i=!0}else this.primitive&&n.PrimitiveCache.unUsePrimitive(r),this.computeNodeMaterial(r);return n.PrimitiveCache.usePrimitive(r),this.primitive=r,this.data=r.data,this.vertices=r.vertices,this.faces=r.faces,this.uvs=r.uvs,this.uv2s=r.uv2s,this.colors=r.colors,this.needComputeLineDistance()&&(this.computeLineDistances(),this.data.lineDistances=this.lineDistances),this.computed=!0,i}},computeData:function(){var e={vertices:[],faces:[],uv2s:[],uvs:[]};return this.vertices=e.vertices,this.uvs=e.uvs,this.faces=e.faces,this.data=e,e},setMaterial:function(e,t,n){var r=t.getUniqueCode?t.getUniqueCode():null,i=ii.getMaterial(r);i?(this.material.materials[e]=i,ii.useMaterial(i)):(this.material.materials[e]=t,ii.setMaterial(r,t),ii.useMaterial(t)),ii.unUseMaterial(n)},onMaterialMapping:function(){this.groups=t},getMaterialSize:function(){return this.materialSize||1},startBatch:function(){this.batch=!0},endBatch:function(){this.materialMappingChanges!==t&&(this.onSizeChanged(),this.onMaterialMapping(),this.firePropertyChange("materialMapping",this.materialMappingChanges[0],this.materialMappingChanges[1]),this.materialMappingChanges=t),this.batch=!1},compareAndSetMaterial:function(e,t,n){this.setMaterial(n,t,e)},cloneStyle:function(e){if(this.getClassName()!=e.getClassName()){console.warn("ApplyStyle fail, the source with not the same class");return}var t=this.getMaterialMapping();for(var r=0;r<this.getMaterialSize();r++){var i=this.material.materials[r],s=e.material.materials[r];this.compareAndSetMaterial(i,s,r)}var o=this.getMaterialMapping();n.Utils.isSame(t,o)||(this.batch?this.materialMappingChanges=[t,o]:(this.onSizeChanged(),this.onMaterialMapping(),this.firePropertyChange("materialMapping",t,o)))},_considerArray:function(e,t){if(!e.startsWith("envmap.image"))return H.isArray(t);var n=!1;if(H.isArray(t))for(var r=0;r<t.length;r++)if(H.isArray(t[r])){n=!0;break}return n},setMaterialStyles:function(e){var t=this.getMaterialMapping(),r,i,s,o,u,a,f,l,c,t=this.getMaterialMapping();for(var h=0;h<this.getMaterialSize();h++){o=this.material.materials[h],u=o.clone();var p=!1;for(var d in e){var v=!1;if(d.startsWith("m."))f=d.substr(d.indexOf(".")+1);else if(this.getSideIndexMapping()&&this.isSideStyle(d)){var m=d.substr(0,d.indexOf(".")),l=this.getSideMaterialIndex(m);if(l!=h)continue;v=!0,c=d.substr(d.indexOf(".")+1),f=c.substr(c.indexOf(".")+1)}var g=e[d];s=g[0],s==null?s=n.Styles.getStyle(d):this._considerArray(f,s)&&(s=s[h]),this._A97(u,f,s),p=!0}p&&this.compareAndSetMaterial(o,u,h)}this.changeMapping(t)},setMaterialStyle:function(e,t,r){var t,i,s,o,u,a,f=e;e.startsWith("m.")&&(f=e.substr(e.indexOf(".")+1));if(r==null&&!n.Utils.isArray(t)){var l=[];for(h=0;h<this.getMaterialSize();h++)l.push(t);this.styleMap[e]=l,t=l}var c=!1;if(f.startsWith("envmap.image")&&t&&H.isArray(t))for(var h=0;h<t.length;h++){if(!!H.isArray(t[h])){c=!1;break}c=!0}var p=this.getMaterialMapping();if(r==null&&(!n.Utils.isArray(t)||c)){var d=[];for(var h=0;h<this.getMaterialSize();h++){if(d[h]===!0)continue;s=t,o=this.material.materials[h],u=o.clone(),s==null&&(s=n.Styles.getStyle(e)),this._A97(u,f,s),this.compareAndSetMaterial(o,u,h)}}else if(n.Utils.isArray(t)){i=t;for(var h=0;h<this.getMaterialSize();h++)s=i[h],o=this.material.materials[h],u=o.clone(),s==null&&(s=n.Styles.getStyle(e)),this._A97(u,f,s),this.compareAndSetMaterial(o,u,h)}else if(r!=null){var p=this.getMaterialMapping();o=this.material.materials[r],u=o.clone(),this._A97(u,f,t),this.compareAndSetMaterial(o,u,r),this.synchronizeIndexStyle(e,r,t)}this.changeMapping(p)},changeMapping:function(e){var t=this.getMaterialMapping();n.Utils.isSame(e,t)||(this.batch?this.materialMappingChanges=[e,t]:(this.onSizeChanged(),this.onMaterialMapping(),this.firePropertyChange("materialMapping",e,t)))},synchronizeSideStyle:function(e,t,n){var r=this.getMaterialIndexSide(t);r&&this.styleMap[r+"."+e]!=null&&(this.styleMap[r+"."+e]=n)},synchronizeIndexStyle:function(e,t,r){var s=this.styleMap[e];s==null&&(s=this.getStyle(e),this.styleMap[e]=s);if(n.Utils.isArray(s))s[t]=r;else{var o=[];for(i=0;i<this.getMaterialSize();i++)o.push(s);o[t]=r,this.styleMap[e]=o}},getDefaultMaterial:function(e,t){return e?e instanceof n.ArrayMaterial?e.materials.length===0?ii.DefaultMaterial:(t>=e.materials.length&&(t=e.materials.length-1),e.materials[t]):e:ii.DefaultMaterial},createMaterial:function(e){var t=new n.ArrayMaterial;this.material=t;var r=this.getMaterialSize();for(var i=0;i<r;i++)this.setMaterial(i,this.getDefaultMaterial(e,i))},onPropertyChange:function(e,t,n){this.changeProperty=e,this.oldGroups=this.groups;var r=this.isSizeChangedProperty(e);r&&this.onSizeChanged(),r&&this.onMaterialMapping(),r&&this.firePropertyChange("materialMapping",0,1)},onSizeChanged:function(){this.computed=!1,this.computeNodeData(),this.computeCentroids(),this.computeFaceNormals(),this.computeBoundingBox(),this.selectionData=null,this.boundingSphere=null,this.changeProperty=null},isSizeChangedProperty:function(e){return this.__SizePropeties.indexOf(e)!==-1||e=="vertices"||e=="faces"||e=="uvs"},isGroupChangedProperty:function(e){},getMaterialMapping:function(){var e={},t=this.material.materials;for(var n in t)e[n]=t.indexOf(t[n]);return e},getSideMaterialIndex:function(e){var t=this.getSideIndexMapping();if(t)return t[e]},getMaterialIndexSide:function(e){var t=this.getIndexSideMapping();if(t)return t[e]},getIndexSideMapping:function(){var e=this.getSideIndexMapping();if(e&&!this.IndexSideMapping){this.IndexSideMapping={};var t,n;for(t in e)n=e[t],this.IndexSideMapping[n]=t}return this.IndexSideMapping},getSideIndexMapping:function(){},disposeMaterial:function(){},getMaterial:function(){return this.material}});var A=function(e,t,r){this.normal=e instanceof n.Vec3?e:new n.Vec3,this.vertexNormals=e instanceof Array?e:[],this.color=t instanceof n.Color?t:new n.Color,this.vertexColors=t instanceof Array?t:[],this.materialIndex=r?r:0,this.centroid=new n.Vec3,this.needVertexNormal=!1};n.Face=A,A.prototype={constructor:n.Face,subClone:function(){},clone:function(){var e=this.subClone();e.normal.copy(this.normal),e.color.copy(this.color),e.centroid.copy(this.centroid),e.materialIndex=this.materialIndex;var t,n;for(t=0,n=this.vertexNormals.length;t<n;t++)e.vertexNormals.push(this.vertexNormals[t]);for(t=0,n=this.vertexColors.length;t<n;t++)e.vertexColors.push(this.vertexColors[t]);return e}};var O=function(e,t,r,i,s,o){n.Face.call(this,i,s,o),this.a=e,this.b=t,this.c=r};n.Face3=O,O.prototype=Object.create(n.Face.prototype),O.prototype.constructor=n.Face3,O.prototype.subClone=function(){var e=new O(this.a,this.b,this.c);return e},O.prototype.vertexCount=3,O.prototype.serializeJsonValue=function(){return{a:this.a,b:this.b,c:this.c}};var M=function(e,t,r,i,s,o,u){n.Face.call(this,s,o,u),this.a=e,this.b=t,this.c=r,this.d=i};n.Face4=M,M.prototype=Object.create(n.Face.prototype),M.prototype.constructor=n.Face4,M.prototype.subClone=function(){var e=new M(this.a,this.b,this.c,this.d);return e},M.prototype.splitToFace3s=function(){var e=new O(this.a,this.b,this.d,this.normal,this.color,this.materialIndex),t=new O(this.d,this.b,this.c,this.normal,this.color,this.materialIndex);return[e,t]},M.prototype.vertexCount=4,M.prototype.serializeJsonValue=function(){return{a:this.a,b:this.b,c:this.c,d:this.d}},n.Entity=function(e,r){e instanceof n.ArrayMaterial?(this.material=e,this.materialSize=this.material.materials.length||1):e instanceof n.Material?(this.material=e,this.materialSize=1):e&&(this.materialSize=e),this.materialSize=this.materialSize||1,this.createMaterial(this.material),r!=t&&this._id==null&&(this._id=r),n.Node.call(this,this._id),this.groups=null},n.extend(n.Entity,n.Node,{constructor:n.Entity,className:"TGL.Entity",__accessor:["computeVertexNormal"],__SizePropeties:["computeVertexNormal"],setUpdateFlags:function(e){this.verticesNeedUpdate=e,this.elementsNeedUpdate=e,this.uvsNeedUpdate=e,this.normalsNeedUpdate=e,this.colorsNeedUpdate=e,this.buffersNeedUpdate=e},cloneCallback:function(e){e&&this.className==="TGL.Entity"&&(this.computed=!1,this.computeNodeData())},needComputeVertexNormal:function(){return this.computeVertexNormal},computeData:function(){var e={vertices:this.vertices,faces:this.faces,uvs:this.uvs,uv2s:this.uv2s};return e},createCloneObject:function(){return this.constructor===n.Entity?new n.Entity(this.materialSize):n.Element.prototype.createCloneObject.call(this)},getMaterialSize:function(){return this.materialSize},setMaterialSize:function(e){typeof e=="number"&&(this.materialSize=e,this.createMaterial(this.material))},calculateNormals:function(e,t){var n=0,r=1,i=2,s=[];for(var o=0;o<e.length;o+=3)s[o+n]=0,s[o+r]=0,s[o+i]=0;for(var o=0;o<t.length;o+=3){var u=[],a=[],f=[];u[n]=e[3*t[o+2]+n]-e[3*t[o+1]+n],u[r]=e[3*t[o+2]+r]-e[3*t[o+1]+r],u[i]=e[3*t[o+2]+i]-e[3*t[o+1]+i],a[n]=e[3*t[o]+n]-e[3*t[o+1]+n],a[r]=e[3*t[o]+r]-e[3*t[o+1]+r],a[i]=e[3*t[o]+i]-e[3*t[o+1]+i],f[n]=u[r]*a[i]-u[i]*a[r],f[r]=u[i]*a[n]-u[n]*a[i],f[i]=u[n]*a[r]-u[r]*a[n];for(var l=0;l<3;l++)s[3*t[o+l]+n]=s[3*t[o+l]+n]+f[n],s[3*t[o+l]+r]=s[3*t[o+l]+r]+f[r],s[3*t[o+l]+i]=s[3*t[o+l]+i]+f[i]}for(var o=0;o<e.length;o+=3){var c=[];c[n]=s[o+n],c[r]=s[o+r],c[i]=s[o+i];var h=Math.sqrt(c[n]*c[n]+c[r]*c[r]+c[i]*c[i]);h==0&&(h=1),c[n]=c[n]/h,c[r]=c[r]/h,c[i]=c[i]/h,s[o+n]=c[n],s[o+r]=c[r],s[o+i]=c[i]}return new Float32Array(s)}});var _=function(){var e,t,r,i,s,o,u,a,l;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])?(u=arguments[0],e=u.width,t=u.height,r=u.depth,i=u.segmentsW,s=u.segmentsH,o=u.segmentsD,l=u.wrapMode,a=u.id):arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4],s=arguments[5],o=arguments[6],l=arguments[7]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4],o=arguments[5],l=arguments[6],a=arguments[7]),this.width=e||1,this.height=t||1,this.depth=r||1,this.segmentsW=i||1,this.segmentsH=s||1,this.segmentsD=o||1,this.wrapMode=(l||"").toLowerCase(),this.materialSize=this.wrapMode==null||this.wrapMode==""?6:1,this.offset=new f(0,0,0),this._id=a,n.Entity.call(this)};n.Cube=_,n.extend(n.Cube,n.Entity,{__accessor:["width","height","depth","wrapMode"],__SizePropeties:["width","height","depth","wrapMode"],className:"TGL.Cube",getUVs:function(){return this.uvs},setPropertyValue:function(e,t){var n=this[e];if(n===t)return!1;this[e]=t;if(e==="wrapMode"){var r=this.wrapMode,i=r=="six-each"||r=="front-other"||r=="back-other"||r=="left-other"||r=="right-other"||r=="top-other"||r=="bottom-other",s=this.wrapMode==null||this.wrapMode==""?6:1;this.setMaterialSize(s),i||(this[e]="")}return!0},getLinkOffset:function(e){var t=e.length();e.normalize();var n=e.x/this.getWidth(),r=e.y/this.getHeight(),i=e.z/this.getDepth(),s=Math.max(Math.abs(n),Math.abs(r),Math.abs(i));return s==Math.abs(n)?new f(this.getWidth()/2*(n<0?-1:1),0,0):s==Math.abs(r)?new f(0,this.getHeight()/2*(r<0?-1:1),0):new f(0,0,this.getDepth()/2*(i<0?-1:1))},getLinkExtend:function(e){var t=this.worldMatrix.clone();return t=(new mono.Mat4).extractRotation(t),this.getLinkOffset(e.applyMatrix4((new h).getInverse(t)))},computeData:function(){var e=E.buildCubeData(this.width,this.height,this.depth,this.segmentsW,this.segmentsH,this.segmentsD,this.wrapMode,this.offset||new f(0,0,0));return this.vertices=e.vertices,this.uvs=e.uvs,this.faces=e.faces,this.data=e,e},getSideIndexMapping:function(){return this.wrapMap?null:n.Cube.SideIndexMapping},generatePrimitiveKey:function(){return"cube_"+this.width+"_"+this.height+"_"+this.depth+"_"+this.segmentsW+"_"+this.segmentsH+"_"+this.segmentsD+"_"+(this.material instanceof n.ArrayMaterial?1:0)+"_"+this.wrapMode+"_"+this.offset.x+"_"+this.offset.y+"_ "+this.offset.z+"_"+n.Utils.toString(this.getMaterialMapping())},serialize:function(e){var t=e;this.width!==1&&t.serializeSimple("p","width",this.width,"number"),this.height!==1&&t.serializeSimple("p","height",this.height,"number"),this.depth!==1&&t.serializeSimple("p","depth",this.depth,"number"),this.widthSegemtns!==1&&t.serializeSimple("p","widthSegemtns",this.widthSegemtns,"number"),this.heightSegments!==1&&t.serializeSimple("p","heightSegments",this.heightSegments,"number"),this.depthSegments!==1&&t.serializeSimple("p","depthSegments",this.depthSegments,"number"),n.Element.serialize.call(this,t)}}),_.SideIndexMapping={right:0,left:1,top:2,bottom:3,front:4,back:5},n.Sphere=function(){var e,r,i,s,o,u,a;if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var f=arguments[0];e=f.radius,r=f.segmentsW,i=f.segmentsH,s=f.longitudeStart,o=f.longitudeLength,u=f.latitudeStart,this._id=f.id}else arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4],o=arguments[5],u=arguments[6],a=arguments[7]):(e=arguments[0],r=arguments[1],i=arguments[2],s=arguments[3],o=arguments[4],u=arguments[5],a=arguments[6]);this.radius=e||50,this.segmentsW=Math.max(3,Math.floor(r)||22),this.segmentsH=Math.max(2,Math.floor(i)||15),this.longitudeStart=s!==t?s:0,this.longitudeLength=o!==t?o:Math.PI*2,this.latitudeStart=u!==t?u:0,this.latitudeLength=a!==t?a:Math.PI,this.materialSize=1,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.Sphere,n.Entity,{constructor:n.Sphere,__accessor:["radius","segmentsW","segmentsH","latitudeStart","latitudeLength","longitudeStart","longitudeLength"],__SizePropeties:["radius","segmentsW","segmentsH","latitudeStart","latitudeLength","longitudeStart","longitudeLength"],className:"TGL.Sphere",computeData:function(){var e=E.bsd(this.radius,this.segmentsW,this.segmentsH,this.longitudeStart,this.longitudeLength,this.latitudeStart,this.latitudeLength);return this.vertices=e.vertices,this.uvs=e.uvs,this.faces=e.faces,this.data=e,e},generatePrimitiveKey:function(){return"sphere_"+this.radius+"_"+this.segmentsW+"_"+this.segmentsH+"_"+this.longitudeStart+"_"+this.longitudeLength+"_"+this.latitudeStart+"_"+this.latitudeLength},computeBoundingSphere:function(){this.boundingSphere===null&&(this.boundingSphere=new n.BoundingSphere(new n.Vec3,this.radius))},getLinkOffset:function(e){var t=e.length();return e.normalize(),e.multiplyScalar(this.radius)},serialize:function(e){var t=e;this.radius!==50&&t.serializeSimple(Xr,"radius",this.radius,"number"),this.widthSegments!==24&&t.serializeSimple(Xr,"widthSegments",this.widthSegments,"number"),this.heightSegments!==18&&t.serializeSimple(Xr,"heightSegments",this.heightSegments,"number"),this.phiStart!==0&&t.serializeSimple(Xr,"phiStart",this.phiStart,"number"),this.phiLength!==Math.PI*2&&t.serializeSimple(Xr,"phiLength",this.phiLength,"number"),this.thetaStart!==0&&t.serializeSimple(Xr,"thetaStart",this.thetaStart,"number"),this.thetaLength!==Math.PI&&t.serializeSimple(Xr,"thetaLength",this.thetaLength,"number")}}),n.Plane=function(){var e,t,r,i,s;arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3]),this.width=e||5,this.height=t||5,this.segmentsW=r||1,this.segmentsH=i||1,this.vertices=[],this.faces=[],this.uvs=[],this.uv2s=[],this.materialSize=1,this.computeData=function(){var e,t,r=this.width/2,i=this.height/2,s=this.segmentsW,o=this.segmentsH,u=s+1,a=o+1,f=this.width/s,l=this.height/o,c=new n.Vec3(0,0,1),h={vertices:[],faces:[],uvs:[]};for(t=0;t<a;t++)for(e=0;e<u;e++){var p=e*f-r,d=t*l-i;h.vertices.push(new n.Vec3(p,-d,0))}for(t=0;t<o;t++)for(e=0;e<s;e++){var v=e+u*t,m=e+u*(t+1),g=e+1+u*(t+1),y=e+1+u*t,b=new n.Vec2(e/s,1-t/o),w=new n.Vec2(e/s,1-(t+1)/o),E=new n.Vec2((e+1)/s,1-(t+1)/o),S=new n.Vec2((e+1)/s,1-t/o),x=new n.Face4(v,m,g,y);x.normal.copy(c),x.vertexNormals.push(c.clone(),c.clone(),c.clone(),c.clone()),h.faces.push(x),h.uvs.push([b,w,E,S])}return h},n.Entity.call(this),this.computeCentroids()},n.extend(n.Plane,n.Entity,{constructor:n.Plane,className:"TGL.Plane",__accessor:["width","height","segmentsW","segmentsH"],__SizePropeties:["width","height","segmentsW","segmentsH"],clone:function(){var e=new n.Plane(this.material,this.width,this.height,this.segmentsW,this.segmentsH);return this.superClass.clone.call(this,e),e},getSelectStyle:function(){var e=this.getStyle("select.style");if(e=="outline.normal"||e=="outline")e="outline.wireframe";return e}}),n.Cylinder=function(){var e,r,i,s,o,u,a,f,l;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])?(options=arguments[0],e=options.radiusTop,r=options.radiusBottom,i=options.height,s=options.segmentsR,o=options.segmentsH,u=options.openTop,a=options.openBottom,f=options.arcLength,l=options.arcStart,this._id=options.id):arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4],o=arguments[5],u=arguments[6],a=arguments[7],f=arguments[8],l=arguments[9]):(e=arguments[0],r=arguments[1],i=arguments[2],s=arguments[3],o=arguments[4],u=arguments[5],a=arguments[6],f=arguments[7],l=arguments[8]),this.radiusTop=e=e!==t?e:20,this.radiusBottom=r=r!==t?r:20,this.height=i=i!==t?i:100,this.segmentsR=s=s||20,this.segmentsH=o=o||1,this.openTop=u!==t?u:!1,this.openBottom=a!=t?a:!1,this.arcLength=f!==t?f:Math.PI*2,this.arcStart=l!==t?l:0,this.materialSize=3,n.Entity.call(this),this.computeNodeData(),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.Cylinder,n.Entity,{constructor:n.Cylinder,__accessor:["radiusTop","radiusBottom","height","segmentsR","segmentsH","openTop","openBottom","arcLength","arcStart"],__bool:["openTop","openBottom"],__SizePropeties:["radiusTop","radiusBottom","height","segmentsR","segmentsH","openTop","openBottom","arcLength","arcStart"],className:"TGL.Cylinder",computeData:function(){return E.bcld(this.height,this.segmentsH,this.radiusBottom,this.radiusTop,this.segmentsR,this.openTop,this.openBottom,this.arcLength,this.arcStart)},getLinkOffset:function(e){var t=e.length();e.normalize();var n=e.x,r=e.y,i=e.z,s=Math.sqrt(n*n+i*i),o=r>0?this.radiusTop:this.radiusBottom;if(Math.abs(r/s)>this.height/2/o&&t>0){var u=new f(0,this.height/2*(r>0?1:-1),0);return u}return(new f(n,0,i)).normalize().multiplyScalar((this.radiusTop+this.radiusBottom)/2)},getLinkExtend:function(e){var t=this.worldMatrix.clone();return t=(new mono.Mat4).extractRotation(t),this.getLinkOffset(e.applyMatrix4((new h).getInverse(t)))},clearLinkOrthogonal:function(e,t,n,r){r=r||0;var i=this.getHeight()/2+r,s=(this.radiusTop+this.radiusBottom)/2+r;return n=="orthogonal.x"||n=="orthogonal.x.n"?!(Math.abs(e.y-t.y)>i||Math.abs(e.z-t.z)>s):n=="orthogonal.y"||n=="orthogonal.y.n"?!(Math.abs(e.x-t.x)>s||Math.abs(e.z-t.z)>s):n=="orthogonal.z"||n=="orthogonal.z.n"?!(Math.abs(e.y-t.y)>i||Math.abs(e.z-t.z)>s):!1},clearLinkExtend:function(e,t){return t!=="extend.x"&&t==="extend.y"&&e>this.getHeight()/2?!0:!1},getSideIndexMapping:function(){return n.Cylinder.SideIndexMapping},generatePrimitiveKey:function(){return"cylinder_"+this.height+"_"+this.segmentsH+"_"+this.radiusTop+"_"+this.radiusBottom+"_"+this.segmentsR+"_"+this.openTop+"_"+this.openBottom+"_"+this.arcLength+"_"+this.arcStart+n.Utils.toString(this.getMaterialMapping())},needComputeVertexNormal:function(){return!1}}),n.Cylinder.SideIndexMapping={side:0,top:1,bottom:2},n.Circle=function(){var e,r,i,s;arguments.length===4?(e=arguments[0],r=arguments[1],i=arguments[2],s=arguments[3]):(this.material=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4]),this.radius=e=e||50,this.segments=r=r!==t?Math.max(3,r):8,this.thetaStart=i=i!==t?i:0,this.thetaLength=s=s!==t?s:Math.PI*2,this.materialSize=1,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new n.BoundingSphere(new n.Vec3,e)},n.extend(n.Circle,n.Entity,{clone:function(){var e=new n.Circle(this.material,this.radius,this.segments,this.thetaStart,this.thetaLength);return this.constructor.superClass.clone.call(this,e),e},computeData:function(){var e=this.segments,t,r=[],i=new n.Vec3,s=new n.Vec2(.5,.5),o={vertices:[],faces:[],uvs:[],uv2s:[]};o.vertices.push(i),r.push(s);for(t=0;t<=e;t++){var u=new n.Vec3,a=this.thetaStart+t/e*this.thetaLength;u.x=this.radius*Math.cos(a),u.y=this.radius*Math.sin(a),o.vertices.push(u),r.push(new n.Vec2((u.x/this.radius+1)/2,(u.y/this.radius+1)/2))}var f=new n.Vec3(0,0,1);for(t=1;t<=e;t++){var l=t,c=t+1,h=0;o.faces.push(new n.Face3(l,c,h,[f,f,f])),o.uvs.push([r[t],r[t+1],s])}return o}}),n.Torus=function(){var e,t,r,i,s;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])?(options=arguments[0],e=options.radius,t=options.tube,r=options.segmentsR,i=options.segmentsT,s=options.arc,this._id=options.id):arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4],s=arguments[5]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4]),this.materialSize=1,this.radius=e||100,this.tube=t||40,this.segmentsR=r||8,this.segmentsT=i||6,this.arc=s||Math.PI*2,n.Entity.call(this),this.computeNodeData(),this.computeCentroids()},n.extend(n.Torus,n.Entity,{__accessor:["radius","tube","segmentsR","segmentsT","arc"],__SizePropeties:["radius","tube","segmentsR","segmentsT","arc"],className:"TGL.Torus",generatePrimitiveKey:function(){return"torus_"+this.radius+"_"+this.tube+"_"+this.segmentsR+"_"+this.segmentsT+"_"+this.arc},computeData:function(){var e=new n.Vec3,t=[],r=[],i={vertices:[],faces:[],uvs:[],uv2s:[]};for(var s=0;s<=this.segmentsR;s++)for(var o=0;o<=this.segmentsT;o++){var u=o/this.segmentsT*this.arc,a=s/this.segmentsR*Math.PI*2;e.x=this.radius*Math.cos(u),e.y=this.radius*Math.sin(u);var f=new n.Vec3;f.x=(this.radius+this.tube*Math.cos(a))*Math.cos(u),f.y=(this.radius+this.tube*Math.cos(a))*Math.sin(u),f.z=this.tube*Math.sin(a),i.vertices.push(f),t.push(new n.Vec2(o/this.segmentsT,s/this.segmentsR)),r.push(f.clone().sub(e).normalize())}for(var s=1;s<=this.segmentsR;s++)for(var o=1;o<=this.segmentsT;o++){var l=(this.segmentsT+1)*s+o-1,c=(this.segmentsT+1)*(s-1)+o-1,h=(this.segmentsT+1)*(s-1)+o,p=(this.segmentsT+1)*s+o,d=new n.Face3(l,c,p,[r[l],r[c],r[p]]);d.normal.add(r[l]),d.normal.add(r[c]),d.normal.add(r[p]),d.normal.normalize(),i.faces.push(d),i.uvs.push([t[l].clone(),t[c].clone(),t[p].clone()]),d=new n.Face3(c,h,p,[r[c],r[h],r[p]]),d.normal.add(r[c]),d.normal.add(r[h]),d.normal.add(r[p]),d.normal.normalize(),i.faces.push(d),i.uvs.push([t[c].clone(),t[h].clone(),t[p].clone()])}return i}}),n.Arrow=function(){var e,t,r,i,s;arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4],s=arguments[5]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4]),this.materialSize=1,this.tailHeight=e||100,this.tailRadius=t||20,this.headHeight=r||20,this.headRadius=i||30,this.radiusSegments=s||30,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.Arrow,n.Entity,{constructor:n.Arrow,className:"TGL.Arrow",computeData:function(){var e=2,t=this.tailHeight,r=this.tailRadius,i=this.headHeight,s=this.headRadius,o=this.radiusSegments;this.headRadius<this.tailRadius&&(this.headRadius=this.tailRadius);var u=t+i,a=u/2,f,l,c=[],h=[],p=[],d=[];for(l=0;l<=e;l++){var v=[],m=[],g=l/e,y=g*s;for(f=0;f<=o;f++){var b=f/o,w=new n.Vec3;w.x=y*Math.sin(b*Math.PI*2),w.y=-g*i+a,w.z=y*Math.cos(b*Math.PI*2),this.vertices.push(w),v.push(this.vertices.length-1),m.push(new n.Vec2(b,1-g))}c.push(v),p.push(m)}this.vertices.push(new n.Vec3(0,a-i,0));for(l=0;l<=e;l++){var v=[],m=[],g=l/e,y=r;for(f=0;f<=o;f++){var b=f/o,w=new n.Vec3;w.x=y*Math.sin(b*Math.PI*2),w.y=-g*t+a-i,w.z=y*Math.cos(b*Math.PI*2),this.vertices.push(w),v.push(this.vertices.length-1),m.push(new n.Vec2(b,1-g))}h.push(v),d.push(m)}this.vertices.push(new n.Vec3(0,-a,0));var E=this.headRadius/u,S,x;for(f=0;f<o;f++){S=this.vertices[c[0][f]].clone(),x=this.vertices[c[0][f+1]].clone(),S.setY(Math.sqrt(S.x*S.x+S.z*S.z)*E).normalize(),x.setY(Math.sqrt(x.x*x.x+x.z*x.z)*E).normalize();for(l=0;l<e;l++){var T=c[l][f],N=c[l+1][f],C=c[l+1][f+1],k=c[l][f+1],L=S.clone(),A=S.clone(),O=x.clone(),M=x.clone(),_=p[l][f].clone(),D=p[l+1][f].clone(),P=p[l+1][f+1].clone(),H=p[l][f+1].clone();this.faces.push(new n.Face3(T,N,k,[L,A,M])),this.uvs.push([_,D,H]),this.faces.push(new n.Face3(N,C,k,[A,O,M])),this.uvs.push([D,P,H])}}for(f=0;f<o;f++){var T=c[l][f+1],N=c[l][f],C=c.length-1,L=new n.Vec3(0,-1,0),A=new n.Vec3(0,-1,0),O=new n.Vec3(0,-1,0),_=p[l][f+1].clone(),D=p[l][f].clone(),P=new n.Vec2(D.u,1);this.faces.push(new n.Face3(T,N,C,[L,A,O])),this.uvs.push([_,D,P])}var E=0,S,x;for(f=0;f<o;f++){S=this.vertices[h[1][f]].clone(),x=this.vertices[h[1][f+1]].clone(),S.setY(Math.sqrt(S.x*S.x+S.z*S.z)*E).normalize(),x.setY(Math.sqrt(x.x*x.x+x.z*x.z)*E).normalize();for(l=0;l<e;l++){var T=h[l][f],N=h[l+1][f],C=h[l+1][f+1],k=h[l][f+1],L=S.clone(),A=S.clone(),O=x.clone(),M=x.clone(),_=p[l][f].clone(),D=p[l+1][f].clone(),P=p[l+1][f+1].clone(),H=p[l][f+1].clone();this.faces.push(new n.Face3(T,N,k,[L,A,M])),this.uvs.push([_,D,H]),this.faces.push(new n.Face3(N,C,k,[A,O,M])),this.uvs.push([D,P,H])}}for(f=0;f<o;f++){var T=h[l][f+1],N=h[l][f],C=h.length-1,L=new n.Vec3(0,-1,0),A=new n.Vec3(0,-1,0),O=new n.Vec3(0,-1,0),_=d[l][f+1].clone(),D=d[l][f].clone(),P=new n.Vec2(D.u,1);this.faces.push(new n.Face3(T,N,C,[L,A,O])),this.uvs.push([_,D,P])}return this}}),n.BufferNode=function(){this.uuid=n.Math.generateUUID(),this.name="",this.attributes={},this.dynamic=!0,this.offsets=[],this.boundingBox=null,this.boundingSphere=null,this.materialSize=1,this.createMaterial(),n.Node.call(this)},n.extend(n.BufferNode,n.Node,{constructor:n.BufferNode,compuateBufferData:function(){if(!this.computed){var e=this.attributes.position;e&&e.array&&(e.itemSize=3,e.numItems=e.array.length,this.verticesNeedUpdate=!0);var t=this.attributes.uv;t&&t.array&&(t.itemSize=2,t.numItems=t.array.length,this.uvsNeedUpdate=!0);var n=this.attributes.index;n&&n.array&&(this.offsets=[{index:0,start:0,count:n.array.length}]),this.computed=!0}},applyMatrix:function(e){var r,i;this.attributes.position&&(r=this.attributes.position.array),this.attributes.normal&&(i=this.attributes.normal.array),r!==t&&(e.multiplyVec3Array(r),this.verticesNeedUpdate=!0);if(i!==t){var s=(new n.Matrix3).getNormalMatrix(e);s.multiplyVec3Array(i),this.normalizeNormals(),this.normalsNeedUpdate=!0}},computeBoundingBox:function(){this.boundingBox===null&&(this.boundingBox=new n.BoundingBox);var e=this.attributes.position.array;if(e){var r=this.boundingBox,i,s,o;e.length>=3&&(r.min.x=r.max.x=e[0],r.min.y=r.max.y=e[1],r.min.z=r.max.z=e[2]);for(var u=3,a=e.length;u<a;u+=3)i=e[u],s=e[u+1],o=e[u+2],i<r.min.x?r.min.x=i:i>r.max.x&&(r.max.x=i),s<r.min.y?r.min.y=s:s>r.max.y&&(r.max.y=s),o<r.min.z?r.min.z=o:o>r.max.z&&(r.max.z=o)}if(e===t||e.length===0)this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)},computeBoundingSphere:function(){var e=new n.BoundingBox,t=new n.Vec3;return function(){this.boundingSphere===null&&(this.boundingSphere=new n.BoundingSphere);var r=this.attributes.position.array;if(r){var i=this.boundingSphere.center,s=[];for(var o=0,u=r.length;o<u;o+=3)t.set(r[o],r[o+1],r[o+2]),s.push(t);e.setFromPoints(s),e.center(i);var a=0;for(var o=0,u=r.length;o<u;o+=3)t.set(r[o],r[o+1],r[o+2]),a=Math.max(a,i.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(a)}}}(),computeVertexNormals:function(){if(this.attributes.position){var e,r,i,s,o=this.attributes.position.array.length;if(this.attributes.normal===t)this.attributes.normal={itemSize:3,array:new Float32Array(o)};else for(e=0,r=this.attributes.normal.array.length;e<r;e++)this.attributes.normal.array[e]=0;var u=this.attributes.position.array,a=this.attributes.normal.array,f,l,c,h,p,d,v=new n.Vec3,m=new n.Vec3,g=new n.Vec3,y=new n.Vec3,b=new n.Vec3;if(this.attributes.index
){var w=this.attributes.index.array,E=this.offsets;for(i=0,s=E.length;i<s;++i){var S=E[i].start,x=E[i].count,T=E[i].index;for(e=S,r=S+x;e<r;e+=3)f=T+w[e],l=T+w[e+1],c=T+w[e+2],h=u[f*3],p=u[f*3+1],d=u[f*3+2],v.set(h,p,d),h=u[l*3],p=u[l*3+1],d=u[l*3+2],m.set(h,p,d),h=u[c*3],p=u[c*3+1],d=u[c*3+2],g.set(h,p,d),y.subVectors(g,m),b.subVectors(v,m),y.cross(b),a[f*3]+=y.x,a[f*3+1]+=y.y,a[f*3+2]+=y.z,a[l*3]+=y.x,a[l*3+1]+=y.y,a[l*3+2]+=y.z,a[c*3]+=y.x,a[c*3+1]+=y.y,a[c*3+2]+=y.z}}else for(e=0,r=u.length;e<r;e+=9)h=u[e],p=u[e+1],d=u[e+2],v.set(h,p,d),h=u[e+3],p=u[e+4],d=u[e+5],m.set(h,p,d),h=u[e+6],p=u[e+7],d=u[e+8],g.set(h,p,d),y.subVectors(g,m),b.subVectors(v,m),y.cross(b),a[e]=y.x,a[e+1]=y.y,a[e+2]=y.z,a[e+3]=y.x,a[e+4]=y.y,a[e+5]=y.z,a[e+6]=y.x,a[e+7]=y.y,a[e+8]=y.z;this.normalizeNormals(),this.normalsNeedUpdate=!0}},normalizeNormals:function(){var e=this.attributes.normal.array,t,n,r,i;for(var s=0,o=e.length;s<o;s+=3)t=e[s],n=e[s+1],r=e[s+2],i=1/Math.sqrt(t*t+n*n+r*r),e[s]*=i,e[s+1]*=i,e[s+2]*=i},clone:function(){var e=new n.BufferNode,t=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];for(var r in this.attributes){var i=this.attributes[r],s=i.array,o={itemSize:i.itemSize,numItems:i.numItems,array:null};for(var u=0,a=t.length;u<a;u++){var f=t[u];if(s instanceof f){o.array=new f(s);break}}e.attributes[r]=o}for(var u=0,a=this.offsets.length;u<a;u++){var l=this.offsets[u];e.offsets.push({start:l.start,index:l.index,count:l.count})}return e},dispose:function(){this.dispatchEvent({type:"dispose"})}}),n.Particle=function(e,t,r){var i;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])&&(i=arguments[0],this._id=i.id),n.Node.call(this,this._id),this.material=new n.ParticleMaterial({color:Math.random()*16777215}),this.sortParticles=!1,this.frustumCulled=!1,this.vertices=(i?i.vertices:e)||[],this.colors=(i?i.colors:t)||[],this.sizes=(i?i.sizes:r)||[],this.setUpdateFlags(!0)},n.extend(n.Particle,n.Node,{clone:function(e){return e===t&&(e=new n.Particle(this.material)),e.sortParticles=this.sortParticles,e.frustumCulled=this.frustumCulled,n.Element.prototype.clone.call(this,e),e},needUpdate:function(){return!1},setUpdateFlags:function(e){this.verticesNeedUpdate=e,this.dirtyColors=e,this.normalsNeedUpdate=e},setMaterialStyle:function(e,t){e=e.substr(e.indexOf(".")+1),this._A97(this.material,e,t)}}),n.Line=function(e){var r,i,s;this.material=new n.LineMaterial({color:16777215}),n.Node.call(this,e),this.type=this.type!==t?this.type:n.LineStrip},n.LineStrip=0,n.LinePieces=1,n.extend(n.Line,n.Node,{className:"TGL.Line",__accessor:["vertices","type","colors"],__SizePropeties:["vertices","type","colors"],clone:function(e){return e===t&&(e=new n.Line(this.material,this.type)),n.Element.prototype.clone.call(this,e,!0),e},onPropertyChange:function(e,t,n){},setMaterialStyle:function(e,t){e=e.substr(e.indexOf(".")+1),this._A97(this.material,e,t)},setMaterialStyles:function(e){n.Element.prototype.setMaterialStyles.call(this,e)}}),n.Line.createEllipse=function(e,t,r,i,s,o,u){typeof e=="number"?(u=o,o=s,s=i,i=r,r=t,t=e,e=new n.Line):e==null&&(e=new n.Line);var a=new n.EllipseCurve(0,0,t,r,s,o,u),f=[],l=i||50;for(var c=0;c<=l;c++){var h=a.getPoint(c/l);f.push(h)}return e.setVertices(f),e},n.Line.createHelix=function(e,t,r,i,s,o){typeof e=="number"?(o=s,s=i,i=r,r=t,t=e,e=new n.Line):e==null&&(e=new n.Line);var u=[],a=o||50;s=s||1;var l,c,h,p;for(var d=0;d<=a;d++)l=(r*d+t*(a-d))/a,h=s*Math.PI*2*d/a,c=i*(.5-d/a),p=new f(l*Math.sin(h),c,l*Math.cos(h)),u.push(p);return e.setVertices(u),e},n.Line.createRectangle=function(e,t,r,i){typeof e=="number"?(i=r||1,r=t,t=e,e=new n.Line):e==null&&(e=new n.Line);var s=i||50,o=(t+r)*2/s,u=[];if(o>Math.min(t,r))u.push(new f(-t/2,-r/2,0)),u.push(new f(-t/2,r/2,0)),u.push(new f(t/2,r/2,0)),u.push(new f(t/2,-r/2,0)),u.push(new f(-t/2,-r/2,0));else{var a=-t/2,l=-r/2,c;for(var h=0;h<=s;h++)a==-t/2&&l<r/2?l+o<=r/2?l+=o:(u.push(new f(-t/2,r/2,0)),u.push(new f(-t/2,r/2,0)),a+=l+o-r/2,l=r/2):l==r/2&&a<=t/2?a+o<=t/2?a+=o:(u.push(new f(t/2,r/2,0)),u.push(new f(t/2,r/2,0)),l-=a+o-t/2,a=t/2):a==t/2&&l>-r/2?l-o>=-r/2?l-=o:(u.push(new f(t/2,-r/2,0)),u.push(new f(t/2,-r/2,0)),a-=-r/2-l+o,l=-r/2):l==-r/2&&a>=-t/2&&(a-o>=-t/2?a-=o:(l+=-t/2-a+o,a=-t/2)),c=new f(a,l,0),u.push(c)}return e.setVertices(u),e},n.Line.createNurbs=function(e,t,r,i,s){toString.apply(e)==="[object Array]"?(s=i,i=r,r=t,t=e,e=new n.Line):e==null&&(e=new n.Line);if(s){var o=e.material;o.skyY=s.skyY||0,o.horizonY=s.horizonY||0,o.earthY=s.earthY||0,o.skyColor=s.skyColor||new mono.Color(16777215),o.horizonColor=s.horizonColor||new mono.Color(16777215),o.earthColor=s.earthColor||new mono.Color(16777215)}r>t.length-1&&(console.log("max degree is :",t.length-1),r=t.length-1);var u=[];for(var a=0;a<=r;a++)u.push(0);for(var a=0,f=t.length;a<f;a++){var l=(a+1)/(f-r);u.push(mono.Math.clamp(l,0,1))}var c=new mono.NurbsCurve(r,u,t);return e.setVertices(c.getPoints(t.length*i)),e},n.Line.createDottedLine=function(e,t,r,i){e instanceof Array?(r=t,t=e,e=new n.Line):e==null&&(e=new n.Line);var s=[],o=t[0];for(var u=1;u<t.length;u++){var a=t[u],f=a.distanceTo(o),i=f/(r[0]+r[1])||20,l=o.x,c=o.y,h=o.z,p=a.x,d=a.y,v=a.z,m=(p-l)/i,g=(d-c)/i,y=(v-h)/i,b=r[0]/(r[0]+r[1]),w=m*b,E=g*b,S=y*b;s.push(new mono.Vec3(l,c,h));for(var x=0;x<i;x++){var T=l+x*m,N=c+x*g,C=h+x*y;s.push(new mono.Vec3(T,N,C));var T=l+x*m+w,N=c+x*g+E,C=h+x*y+S;s.push(new mono.Vec3(T,N,C))}o=a}return e.setVertices(s),e},n.LineX=function(){var e,t,r;if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var i=arguments[0];e=i.points,t=i.colors,r=i.lineWidth,this._id=i.id||this._id}else e=arguments[0],t=arguments[1],r=arguments[2];this.material=new n.LineXMaterial({color:16777215}),this.points=e||[],this.colors=t||[],this.lineWidth=r||1,n.Entity.call(this,this.material,this._id)},n.extend(n.LineX,n.Entity,{__accessor:["points","colors","lineWidth"],__SizePropeties:["points","colors","lineWidth"],computeData:function(){var e=this.points,t=this.colors,r={vertices:[],verticesPrev:[],verticesNext:[],offset:[],faces:[]},i=t.length;i!=0&&(r.colors=[]);var s=e.length,o=r.vertices,u=r.verticesPrev,a=r.verticesNext,l=r.offset,c=r.faces,h=this.lineWidth;for(var p=0;p<s;p++){var d=e[p],v=new f(d.x,d.y,d.z);o.push(v),o.push(v.clone()),l.push(h/2),l.push(-h/2);if(r.colors){var m=Math.floor(p*i/s),g=t[m];g instanceof n.Color||(g=new n.Color(g)),r.colors.push(g),r.colors.push(g.clone())}}for(p=0;p<s;p++){var y=p*2,b=y>=2?y-2:0,w=y<s-2?y+2:s*2-1,v=o[b];u.push(v.clone()),u.push(v.clone()),v=o[w],a.push(v.clone()),a.push(v.clone())}var E=s-1;for(p=0;p<E;p++){var y=p*2,S=new O(y,y+1,y+2);S.materialIndex=0,c.push(S),S=new O(y+2,y+1,y+3),S.materialIndex=0,c.push(S)}return r},getPointAt:function(e){e==null&&console.error("LineX#getPointAt method need one argument: percent"),e=e||0,e<0?e=0:e>1&&(e=1);var t=this.lineDistances.length;t==0&&console.error("There is  no data in lineDistances");if(e==0)return this.vertices[0].clone();if(e==1)return this.vertices[t-1].clone();var n=this.lineDistances[t-1];n==0&&console.error("Total length is zero");var r=null;for(var i=0;i<t;i+=2){var s=this.lineDistances[i]/n,o=i+2<t?i+2:i,u=this.lineDistances[o]/n;if(s<=e&&e<u){var a=this.vertices[i],l=this.vertices[o],c=l.clone().sub(a).length();if(c!=0){var h=(e-s)*n/c;r=(new f).lerpVectors(a,l,h);break}r=a.clone(),console.error("There are two same points")}}return r},needComputeVertexNormal:function(){return!1},needComputeLineDistance:function(){return!0}}),n.PathLine=function(){var e,t,r;if(arguments.length===1&&arguments[0]instanceof Object&&!(arguments[0]instanceof n.Path)){var i=arguments[0];e=i.path,t=i.segments,r=i.type,this._id=i.id||this._id}else e=arguments[0],t=arguments[1],r=arguments[2],this._id=arguments[3];n.Line.call(this,{vertices:[],colors:[],type:r,id:this._id}),this.segments=t||20,this.setPath(e)},n.extend(n.PathLine,n.Line,{constructor:n.PathLine,className:"TGL.PathLine",__accessor:["path","segments"],__SizePropeties:["path","segments"],onPropertyChange:function(){this.computeNodeData()},computeNodeData:function(){this.computeData()},adjustPath:function(e){return e},computeData:function(){var e=this.path;if(!e)return;e=this.adjustPath(e);var t=e.curves.length,r=e.curves,i=[],s,o=e.getLength(),u,a,f=0,l=this.segments,c;for(m=0;m<t;m++){u=r[m],a=u.getLength();if(u instanceof n.LineCurve3){var h=f/o,p=(a+f)/o;i.push(h),i.push(p)}else{m>0?c=1:c=0;for(;c<=l;c++){var d=(a*c/l+f)/o;i.push(d)}}f+=a}var v=[];for(var m=0;m<i.length;m++)s=i[m],pos=e.getPointAt(s),v.push(pos);return this.vertices=v,[]}}),n.Polyhedron=function(){function w(e){var t=e.normalize().clone();t.index=s.vertices.push(t)-1;var r=x(e)/2/Math.PI+.5,i=T(e)/Math.PI+.5;return t.uv=new n.Vec3(r,1-i),t}function E(e,t,r){var i=new n.Face3(e.index,t.index,r.index,[e.clone(),t.clone(),r.clone()]);i.centroid.add(e).add(t).add(r).divideScalar(3),s.faces.push(i);var o=x(i.centroid);s.uvs.push([N(e.uv,e,o),N(t.uv,t,o),N(r.uv,r,o)])}function S(e,t){var n=Math.pow(2,t),r=Math.pow(4,t),i=w(s.vertices[e.a]),o=w(s.vertices[e.b]),u=w(s.vertices[e.c]),a=[];for(var f=0;f<=n;f++){a[f]=[];var l=w(i.clone().lerp(u,f/n)),c=w(o.clone().lerp(u,f/n)),h=n-f;for(var p=0;p<=h;p++)p==0&&f==n?a[f][p]=l:a[f][p]=w(l.clone().lerp(c,p/h))}for(var f=0;f<n;f++)for(var p=0;p<2*(n-f)-1;p++){var d=Math.floor(p/2);p%2==0?E(a[f][d+1],a[f+1][d],a[f][d]):E(a[f][d+1],a[f+1][d+1],a[f+1][d])}}function x(e){return Math.atan2(e.z,-e.x)}function T(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}function N(e,t,r){return r<0&&e.x===1&&(e=new n.Vec3(e.x-1,e.y)),t.x===0&&t.z===0&&(e=new n.Vec3(r/2/Math.PI+.5,e.y)),e.clone()}var e,t,r,i;arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3]),this.materialSize=1,n.Entity.call(this),r=r||1,i=i||0;var s=this;for(var o=0,u=e.length;o<u;o++)w(new n.Vec3(e[o][0],e[o][1],e[o][2]));var a=[],f=this.vertices,l=[];for(var o=0,u=t.length;o<u;o++){var c=f[t[o][0]],h=f[t[o][1]],p=f[t[o][2]];l[o]=new n.Face3(c.index,h.index,p.index,[c.clone(),h.clone(),p.clone()])}for(var o=0,u=l.length;o<u;o++)S(l[o],i);for(var o=0,u=this.uvs.length;o<u;o++){var d=this.uvs[o],v=d[0].x,m=d[1].x,g=d[2].x,y=Math.max(v,Math.max(m,g)),b=Math.min(v,Math.min(m,g));y>.9&&b<.1&&(v<.2&&(d[0].x+=1),m<.2&&(d[1].x+=1),g<.2&&(d[2].x+=1))}for(var o=0,u=this.vertices.length;o<u;o++)this.vertices[o].multiplyScalar(r);this.mergeVertices(),this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new n.BoundingSphere(new n.Vec3,r)},n.extend(n.Polyhedron,n.Entity,{}),n.Octahedron=function(e,t,r){var i=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],s=[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]];n.Polyhedron.call(this,e,i,s,t,r)},n.extend(n.Octahedron,n.Polyhedron,{clone:function(){return new n.Octahedron(this.material,this.radius,this.detail)}}),n.Axis=function(e){var t=e&&e.size||1,r=[],i=[];r.push(new n.Vec3,new n.Vec3(t,0,0),new n.Vec3,new n.Vec3(0,t,0),new n.Vec3,new n.Vec3(0,0,t)),i.push(new n.Color(16711680),new n.Color(16711680),new n.Color(65280),new n.Color(65280),new n.Color(255),new n.Color(255));var s=new n.LineMaterial({vertexColors:n.VertexColors,depthTest:!1,depthMask:!1});n.Line.call(this,{vertices:r,colors:i,type:n.LinePieces,size:t}),this.material=s,this.xAxisText=this.makeAxisText("X",16711680),this.yAxisText=this.makeAxisText("Y",65280),this.zAxisText=this.makeAxisText("Z",255),this.xAxisText.setParent(this),this.yAxisText.setParent(this),this.zAxisText.setParent(this),this.xAxisText.setPosition(t,0,0),this.yAxisText.setPosition(0,t,0),this.zAxisText.setPosition(0,0,t),this._sizeFixed=!0},n.extend(n.Axis,n.Line,{showAxisText:function(e){this.xAxisText._visible=e,this.yAxisText._visible=e,this.zAxisText._visible=e},setSize:function(e){this.vertices[1].x=e,this.vertices[3].y=e,this.vertices[5].z=e},fixSize:function(e){n.Element.prototype.fixSize.call(this,e);var t=this._scale.x,r=this._scale.y,i=this._scale.z;this.xAxisText.setScale(3,3,1),this.yAxisText.setScale(3,3,1),this.zAxisText.setScale(3,3,1)},makeAxisText:function(e,t){var r="Arial",i=36,s=n.BillboardAlignment.topLeft,o=document.createElement("canvas"),u=o.getContext("2d");u.font="Bold "+i+"px "+r,t instanceof n.Color||(t=new n.Color(t));var a=u.measureText(e),f=a.width;o.width=H.nextPowerOfTwo(f),o.height=H.nextPowerOfTwo(u.measureText("e").width*2+4),u.fillStyle="rgba("+t.r*255+", "+t.g*255+", "+t.b*255+", 1.0)",u.fillText(e,0,10);var l=new n.Texture(o),c=new n.BillboardMaterial({map:l,useScreenCoordinates:!1,alignment:s,depthTest:!1,depthMask:!1}),h=new n.Billboard;return h.material=c,h}}),n.Curve=function(){},n.Curve.prototype.getPoint=function(e){return console.log("Warning, getPoint() not implemented!"),null},n.Curve.prototype.getPointAt=function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},n.Curve.prototype.getPoints=function(e){e||(e=5);var t,n=[];for(t=0;t<=e;t++)n.push(this.getPoint(t/e));return n},n.Curve.prototype.getSpacedPoints=function(e){e||(e=5);var t,n=[];for(t=0;t<=e;t++)n.push(this.getPointAt(t/e));return n},n.Curve.prototype.getLength=function(){var e=this.getLengths();return e[e.length-1]},n.Curve.prototype.getLengths=function(e){e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200);if(this.cacheArcLengths&&this.cacheArcLengths.length==e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t=[],n,r=this.getPoint(0),i,s=0;t.push(0);for(i=1;i<=e;i++)n=this.getPoint(i/e),s+=n.distanceTo(r),t.push(s),r=n;return this.cacheArcLengths=t,t},n.Curve.prototype.updateArcLengths=function(){this.needsUpdate=!0,this.getLengths()},n.Curve.prototype.getUtoTmapping=function(e,t){var n=this.getLengths(),r=0,i=n.length,s;t?s=t:s=e*n[i-1];var o=0,u=i-1,a;while(o<=u){r=Math.floor(o+(u-o)/2),a=n[r]-s;if(a<0){o=r+1;continue}if(a>0){u=r-1;continue}u=r;break}r=u;if(n[r]==s){var f=r/(i-1);return f}var l=n[r],c=n[r+1],h=c-l,p=(s-l)/h,f=(r+p)/(i-1);return f},n.Curve.prototype.getTangent=function(e){var t=1e-4,n=e-t,r=e+t;n<0&&(n=0),r>1&&(r=1);var i=this.getPoint(n),s=this.getPoint(r),o=s.clone().sub(i);return o.normalize()},n.Curve.prototype.getTangentAt=function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},n.Curve.Utils={tangentQuadraticBezier:function(e,t,n,r){return 2*(1-e)*(n-t)+2*e*(r-n)},tangentCubicBezier:function(e,t,n,r,i){return-3*t*(1-e)*(1-e)+3*n*(1-e)*(1-e)-6*e*n*(1-e)+6*e*r*(1-e)-3*e*e*r+3*e*e*i},tangentSpline:function(e,t,n,r,i){var s=6*e*e-6*e,o=3*e*e-4*e+1,u=-6*e*e+6*e,a=3*e*e-2*e;return s+o+u+a},interpolate:function(e,t,n,r,i){var s=(n-e)*.5,o=(r-t)*.5,u=i*i,a=i*u;return(2*t-2*n+s+o)*a+(-3*t+3*n-2*s-o)*u+s*i+t}},n.Curve.create=function(e,t){return e.prototype=Object.create(n.Curve.prototype),e.prototype.getPoint=t,e},n.LineCurve=function(e,t){this.v1=e,this.v2=t},n.LineCurve.prototype=Object.create(n.Curve.prototype),n.LineCurve.prototype.getPoint=function(e){var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},n.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},n.LineCurve.prototype.getTangent=function(e){var t=this.v2.clone().sub(this.v1);return t.normalize()},n.LineCurve3=function(e,t){this.v1=e,this.v2=t,this.getPoint=function(e){var t=new n.Vec3;return t.subVectors(this.v2,this.v1),t.multiplyScalar(e),t.add(this.v1),t}},n.extend(n.LineCurve3,n.Curve,{}),n.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},n.CurvePath.prototype=Object.create(n.Curve.prototype),n.CurvePath.prototype.add=function(e){this.curves.push(e)},n.CurvePath.prototype.checkConnection=function(){},n.CurvePath.prototype.closePath=function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new n.LineCurve3(t,e))},n.CurvePath.prototype.getPoint=function(e){var t=e*this.getLength(),n=this.getCurveLengths(),r=0,i,s;while(r<n.length){if(n[r]>=t){i=n[r]-t,s=this.curves[r];var o=1-i/s.getLength();return s.getPointAt(o)}r++}return null},n.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},n.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var e=[],t=0,n,r=this.curves.length;for(n=0;n<r;n++)t+=this.curves[n].getLength(),e.push(t);return this.cacheLengths=e,e},n.CurvePath.prototype.getBoundingBox=function(){var e=this.getPoints(),t,r,i,s,o,u;t=r=Number.NEGATIVE_INFINITY,s=o=Number.POSITIVE_INFINITY;var a,f,l,c,h=e[0]instanceof n.Vec3;c=h?new n.Vec3:new n.Vec2;for(f=0,l=e.length;f<l;f++)a=e[f],a.x>t?t=a.x:a.x<s&&(s=a.x),a.y>r?r=a.y:a.y<o&&(o=a.y),h&&(a.z>i?i=a.z:a.z<u&&(u=a.z)),c.add(a);var p={minX:s,minY:o,maxX:t,maxY:r,centroid:c.divideScalar(l)};return h&&(p.maxZ=i,p.minZ=u),p},n.CurvePath.prototype.createPointsGeometry=function(e){var t=this.getPoints(e,!0);return this.createGeometry(t)},n.CurvePath.prototype.createSpacedPointsGeometry=function(e){var t=this.getSpacedPoints(e,!0);return this.createGeometry(t)},n.CurvePath.prototype.createGeometry=function(e){var t=new n.Entity;for(var r=0;r<e.length;r++)t.vertices.push(new n.Vec3(e[r].x,e[r].y,e[r].z||0));return t},n.CurvePath.prototype.addWrapPath=function(e){this.bends.push(e)},n.CurvePath.prototype.getTransformedPoints=function(e,t){var n=this.getPoints(e),r,i;t||(t=this.bends);for(r=0,i=t.length;r<i;r++)n=this.getWrapPoints(n,t[r]);return n},n.CurvePath.prototype.getTransformedSpacedPoints=function(e,t){var n=this.getSpacedPoints(e),r,i;t||(t=this.bends);for(r=0,i=t.length;r<i;r++)n=this.getWrapPoints(n,t[r]);return n},n.CurvePath.prototype.getWrapPoints=function(e,t){var n=this.getBoundingBox(),r,i,s,o,u,a;for(r=0,i=e.length;r<i;r++){s=e[r],o=s.x,u=s.y,a=o/n.maxX,a=t.getUtoTmapping(a,o);var f=t.getPoint(a),l=t.getTangent(a);l.set(-l.y,l.x).multiplyScalar(u),s.x=f.x+l.x,s.y=f.y+l.y}return e},n.EllipseCurve=function(e,t,n,r,i,s,o){this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=r,this.aStartAngle=i||0,this.aEndAngle=s||Math.PI*2,this.aClockwise=o},n.EllipseCurve.prototype=Object.create(n.Curve.prototype),n.EllipseCurve.prototype.getPoint=function(e){var t,r=this.aEndAngle-this.aStartAngle;r<0&&(r+=Math.PI*2),r>Math.PI*2&&(r-=Math.PI*2),this.aClockwise===!0?t=this.aEndAngle+(1-e)*(Math.PI*2-r):t=this.aStartAngle+e*r;var i=this.aX+this.xRadius*Math.cos(t),s=this.aY+this.yRadius*Math.sin(t);return new n.Vec3(i,s,0)},n.ArcCurve=function(e,t,r,i,s,o){n.EllipseCurve.call(this,e,t,r,r,i,s,o)},n.ArcCurve.prototype=Object.create(n.EllipseCurve.prototype),n.NurbsCurve=function(e,t,r){this.degree=e||3,this.knots=t||[],this.ctrlPoints=[];for(var i=0;i<r.length;++i){var s=r[i];this.ctrlPoints[i]=new n.Vec4(s.x,s.y,s.z,s.w)}},n.NurbsCurve.prototype=Object.create(n.Curve.prototype),n.NurbsCurve.prototype.constructor=n.NurbsCurve,n.NurbsCurve.prototype.getPoint=function(e){var t=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=n.NurbsUtils.calcBSplinePoint(this.degree,this.knots,this.ctrlPoints,t);return r.w!=1&&r.divideScalar(r.w),new n.Vec3(r.x,r.y,r.z)},n.NurbsCurve.prototype.getTangent=function(e){var t=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=n.NurbsUtils.calcNURBSDerivatives(this.degree,this.knots,this.ctrlPoints,t,1),i=r[1].clone();return i.normalize(),i},n.NurbsSurface=function(e,t,r){this.degreeU=e,this.degreeV=t,this.knotsU=this.calculateKnots(e,r.length),this.knotsV=this.calculateKnots(t,r[0].length),this.ctlPoints=[];var i=r.length,s=r[0].length;for(var o=0;o<i;++o){this.ctlPoints[o]=[];for(var u=0;u<s;++u){var a=r[o][u];this.ctlPoints[o][u]=new n.Vec4(a.x,a.y,a.z,a.w)}}},n.NurbsSurface.prototype={constructor:n.NurbsSurface,calculateKnots:function(e,t){var n=[];for(var r=0;r<=e;r++)n.push(0);for(var r=0;r<t;r++){var i=(r+1)/(t-e);n.push(mono.Math.clamp(i,0,1))}return n},getPoint:function(e,t){var r=this.knotsU[0]+e*(this.knotsU[this.knotsU.length-1]-this.knotsU[0]),i=this.knotsV[0]+t*(this.knotsV[this.knotsV.length-1]-this.knotsV[0]);return n.NurbsUtils.calcSurfacePoint(this.degreeU,this.degreeV,this.knotsU,this.knotsV,this.ctlPoints,r,i)}},n.Surface=function(e,t,r,i){this.parameters={func:function(t,n){return e.getPoint(t,n)},slices:t,stacks:r},this.ctrlCond=i,this.material=new n.SurfaceMaterial,n.Entity.call(this)},n.extend(n.Surface,n.Entity,{constructor:n.Surface,className:"TGL.Surface",createMaterial:function(e){var t=new n.ArrayMaterial;this.material=t;var r=this.ctrlCond,i=this.getMaterialSize();for(var s=0;s<i;s++){var t=this.getDefaultMaterial(e,s);r&&(t.skyY=r.skyY||0,t.horizonY=r.horizonY||0,t.earthY=r.earthY||0,t.skyColor=r.skyColor||new mono.Color(16777215),t.horizonColor=r.horizonColor||new mono.Color(16777215),t.earthColor=r.earthColor||new mono.Color(16777215)),this.setMaterial(s,t)}},setMaterial:function(e,t,n){var r=t.getUniqueCode?t.getUniqueCode():null,i=ii.getMaterial(r);i?(this.material.materials[e]=i,ii.useMaterial(i)):(this.material.materials[e]=t,ii.setMaterial(r,t),ii.useMaterial(t)),ii.unUseMaterial(n)},computeData:function(){var e={};e.faces=[],e.uvs=[],e.vertices=[];var t=this.parameters.stacks,n=this.parameters.slices,r=this.parameters.func,i=n+1,s=[],u=[],a=[],l=[];for(var c=0;c<=t;c++){var h=c/t;for(j=0;j<=n;j++){var p=j/n,d=r(p,h);a.push(new o(p,h)),e.vertices.push(new f(d.x,d.y,d.z))}}var u=[],v,m,g,y;for(c=0;c<t;c++)for(j=0;j<n;j++){v=c*i+j,m=c*i+j+1,g=(c+1)*i+j+1,y=(c+1)*i+j;var b=new M(v,m,g,y),w=e.vertices[v].clone().sub(e.vertices[m].clone()),E=e.vertices[y].clone().sub(e.vertices[m].clone()),S=w.cross(E).normalize();b.normal.copy(S),e.faces.push(b),e.uvs.push([a[v],a[m],a[g],a[y]])}return e}}),n.LensFlare=function(e){var r,i,s,o,u,a;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])?(options=arguments[0],r=options.texture,i=options.size,s=options.distance,o=options.blending,u=options.color,a=options.opacity,e=options.id):arguments[0]instanceof n.Material?(this.material=arguments[0],r=arguments[1],i=arguments[2],s=arguments[3],o=arguments[4],u=arguments[5],a=arguments[6]):(r=arguments[0],i=arguments[1],s=arguments[2],o=arguments[3],u=arguments[4],a=arguments[5],e=arguments[6]),this.texture=r||null,this.size=i||-1,this.distance=s||0,this.blending=o||n.NormalBlending,this.color=u||new n.Color(16777215),this.opacity=a||1,this.material||(this.material=new n.Material),this.lensFlares=[],n.Node.apply(this,arguments),this.positionScreen=new f,this.customUpdateCallback=t,this.texture&&this.add(this.texture,this.size,this.distance,this.blending,this.color)},n.extend(n.LensFlare,n.Node,{isLensFlare:!0,add:function(e,r,i,s,o,u){r===t&&(r=-1),i===t&&(i=0),u===t&&(u=1),o===t&&(o=new n.Color(16777215)),s===t&&(s=n.NormalBlending),i=Math.min(i,Math.max(0,i)),this.lensFlares.push({texture:e,size:r,distance:i,x:0,y:0,z:0,scale:1,rotation:0,opacity:u,color:o,blending:s})},updateLensFlares:function(){var e,t=this.lensFlares.length,n,r=-this.positionScreen.x*2,i=-this.positionScreen.y*2;for(e=0;e<t;e++)n=this.lensFlares[e],n.x=this.positionScreen.x+r*n.distance,n.y=this.positionScreen.y+i*n.distance,n.wantedRotation=n.x*Math.PI*.25,n.rotation+=(n.wantedRotation-n.rotation)*.25},copy:function(e){Cube.prototype.copy.call(this,e),this.positionScreen.copy(e.positionScreen),this.customUpdateCallback=e.customUpdateCallback;for(var t=0,n=e.lensFlares.length;t<n;t++)this.lensFlares.push(e.lensFlares[t]);return this}}),n.Path=function(e){n.CurvePath.call(this),this.actions=[],this.points=[],e&&this.fromPoints(e)},n.extend(n.Path,n.CurvePath,{constructor:n.Path,className:"TGL.Path",serializeJsonValue:function(){return{actions:this.actions,"class":"TGL.Path"}},deserializeJsonValue:function(e){var t,n,r,i;for(i=0;i<e.actions.length;i++)n=e.actions[i],t=n.action,r=n.args,this[t].apply(this,r)}}),n.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"curveTo",BEZIER_CURVE_TO:"bCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},n.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y,e[0].z);for(var t=1,n=e.length;t<n;t++)this.lineTo(e[t].x,e[t].y,e[t].z)},n.Path.prototype.closePath=function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.lineTo(e.x,e.y,e.z)},n.Path.prototype.reverse=function(){var e=new n.Path,t,r=this.actions.length,i,s,o,u,a;for(t=r-1;t>=0;t--){s=this.actions[t].args,o=s.length,t===r-1&&e.moveTo(s[o-3],s[o-2],s[o-1]);if(u!=null)switch(a){case n.PathActions.MOVE_TO:e.moveTo(s[o-3],s[o-2],s[o-1]);break;case n.PathActions.LINE_TO:e.lineTo(s[o-3],s[o-2],s[o-1]);break;case n.PathActions.QUADRATIC_CURVE_TO:e.quadraticCurveTo(u[0],u[1],u[2],s[o-3],s[o-2],s[o-1]);break;case n.PathActions.BEZIER_CURVE_TO:e.bezierCurveTo(u[3],u[4],u[5],u[0],u[1],u[2],s[o-3],s[o-2],s[o-1])}u=s,a=this.actions[t].action}return e},n.Path.prototype.moveTo=function(e,t,r){e=e||0,t=t||0,r=r||0;var i=Array.prototype.slice.call(arguments);this.actions.push({action:n.PathActions.MOVE_TO,args:i}),this.points.push(new f(e,t,r))},n.Path.prototype.lineTo=function(e,t,r){e=e||0,t=t||0,r=r||0;if(this.actions&&this.actions.length===1){var i=this.actions[0].args;i[0]===e&&i[1]===t&&i[2]===r&&(console.log("TGL.Path:lineTo the same point of moveTo"),e+=.01)}var i=Array.prototype.slice.call(arguments),s=this.actions[this.actions.length-1].args,o=s[s.length-3],u=s[s.length-2],a=s[s.length-1],l=new n.LineCurve3(new n.Vec3(o,u,a),new n.Vec3(e,t,r));this.curves.push(l),this.actions.push({action:n.PathActions.LINE_TO,args:i}),this.points.push(new f(e,t,r))},n.Path.prototype.quadraticCurveTo=function(e,t,r,i,s,o){e=e||0,t=t||0,r=r||0,i=i||0,s=s||0,o=o||0;if(this.actions&&this.actions.length===1){var u=this.actions[0].args;u[0]===i&&u[1]===s&&u[2]===o&&(console.log("TGL.Path:quadraticCurveTo the same point of moveTo"),i=.01)}var u=Array.prototype.slice.call(arguments),a=this.actions[this.actions.length-1].args,l=a[a.length-3],c=a[a.length-2],h=a[a.length-1],p=new n.QuadraticBezierCurve3(new n.Vec3(l,c,h),new n.Vec3(e,t,r),new n.Vec3(i,s,o));this.curves.push(p),this.actions.push({action:n.PathActions.QUADRATIC_CURVE_TO,args:u}),this.points.push(new f(i,s,o))},n.Path.prototype.curveTo=n.Path.prototype.quadraticCurveTo,n.Path.prototype.bezierCurveTo=function(e,t,r,i,s,o,u,a,l){var c=Array.prototype.slice.call(arguments),h=this.actions[this.actions.length-1].args,p=h[h.length-3],d=h[h.length-2],v=h[h.length-1],m=new n.CubicBezierCurve3(new n.Vec3(p,d,v),new n.Vec3(e,t,r),new n.Vec3(i,s,o),new n.Vec3(u,a,l));this.curves.push(m),this.actions.push({action:n.PathActions.BEZIER_CURVE_TO,args:c}),this.points.push(new f(u,a,l))},n.Path.prototype.isClockwise=function(){if(this.points.length<2)return t;if(this.points.length<3){var e=this.points[0],r=this.points[1];return r.x>e.x}return n.Math.isClockwise(this.points)},n.Path.prototype.bCurveTo=n.Path.prototype.bezierCurveTo,n.Path.prototype.splineThru=function(e){var t=Array.prototype.slice.call(arguments),r=this.actions[this.actions.length-1].args,i=r[r.length-2],s=r[r.length-1],o=[new n.Vec2(i,s)];Array.prototype.push.apply(o,e);var u=new n.SplineCurve(o);this.curves.push(u),this.actions.push({action:n.PathActions.CSPLINE_THRU,args:t})},n.Path.prototype.arc=function(e,t,n,r,i,s){var o=this.actions[this.actions.length-1].args,u=o[o.length-3],a=o[o.length-2];this.absarc(e+u,t+a,n,r,i,s)},n.Path.prototype.absarc=function(e,t,n,r,i,s){this.absellipse(e,t,n,n,r,i,s)},n.Path.prototype.ellipse=function(e,t,n,r,i,s,o){var u=this.actions[this.actions.length-1].args,a=u[u.length-3],f=u[u.length-2];this.absellipse(e+a,t+f,n,r,i,s,o)},n.Path.prototype.absellipse=function(e,t,r,i,s,o,u){var a=Array.prototype.slice.call(arguments),f=new n.EllipseCurve(e,t,r,i,s,o,u);this.curves.push(f);var l=f.getPoint(1);a.push(l.x),a.push(l.y),this.actions.push({action:n.PathActions.ELLIPSE,args:a})},n.Path.prototype.toArray=function(){var e,t=this.actions.length,n=[];for(e=0;e<t;e++){var r=this.actions[e];r.action==="moveTo"?(n.push("m"),n.push(r.args[0]),n.push(r.args[1]),n.push(r.args[2])):r.action==="lineTo"?(n.push("l"),n.push(r.args[0]),n.push(r.args[1]),n.push(r.args[2])):r.action==="curveTo"&&(n.push("c"),n.push(r.args[0]),n.push(r.args[1]),n.push(r.args[2]),n.push(r.args[3]),n.push(r.args[4]),n.push(r.args[5]))}return n},n.Path.prototype.getSpacedPoints=function(e,t){e||(e=40);var n=[];for(var r=0;r<e;r++)n.push(this.getPoint(r/e));return n},n.Path.prototype.getPoints=function(e,t){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(e,t);e=e||12;var r=[],i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N;for(i=0,s=this.actions.length;i<s;i++){o=this.actions[i],u=o.action,a=o.args;switch(u){case n.PathActions.MOVE_TO:r.push(new n.Vec3(a[0],a[1],a[2]));break;case n.PathActions.LINE_TO:r.push(new n.Vec3(a[0],a[1],a[2]));break;case n.PathActions.QUADRATIC_CURVE_TO:f=a[3],l=a[4],c=a[5],v=a[0],m=a[1],g=a[2],r.length>0?(E=r[r.length-1],y=E.x,b=E.y,w=E.z):(E=this.actions[i-1].args,y=E[E.length-3],b=E[E.length-2],w=E[E.length-1]);for(S=1;S<=e;S++)x=S/e,T=n.Shape.Utils.b2(x,y,v,f),N=n.Shape.Utils.b2(x,b,m,l),tz=n.Shape.Utils.b2(x,w,g,c),r.push(new n.Vec3(T,N,tz));break;case n.PathActions.BEZIER_CURVE_TO:f=a[6],l=a[7],c=a[8],v=a[0],m=a[1],g=a[2],h=a[3],p=a[4],d=a[5],r.length>0?(E=r[r.length-1],y=E.x,b=E.y,w=E.z):(E=this.actions[i-1].args,y=E[E.length-3],b=E[E.length-2],w=E[E.length-1]);for(S=1;S<=e;S++)x=S/e,T=n.Shape.Utils.b3(x,y,v,h,f),N=n.Shape.Utils.b3(x,b,m,p,l),tz=n.Shape.Utils.b3(x,w,g,d,c),r.push(new n.Vec3(T,N,tz));break;case n.PathActions.CSPLINE_THRU:E=this.actions[i-1].args;var C=new n.Vec2(E[E.length-2],E[E.length-1]),k=[C],L=e*a[0].length;k=k.concat(a[0]);var A=new n.SplineCurve(k);for(S=1;S<=L;S++)r.push(A.getPointAt(S/L));break;case n.PathActions.ARC:var O=a[0],M=a[1],_=a[2],D=a[3],P=a[4],H=!!a[5],B=P-D,j,F=e*2;for(S=1;S<=F;S++)x=S/F,H||(x=1-x),j=D+x*B,T=O+_*Math.cos(j),N=M+_*Math.sin(j),r.push(new n.Vec3(T,N));break;case n.PathActions.ELLIPSE:var O=a[0],M=a[1],I=a[2],q=a[3],D=a[4],P=a[5],H=!!a[6],B=P-D,j,F=e*2;for(S=1;S<=F;S++)x=S/F,H||(x=1-x),j=D+x*B,T=O+I*Math.cos(j),N=M+q*Math.sin(j),r.push(new n.Vec3(T,N))}}var R=r[r.length-1],U=1e-10;return Math.abs(R.x-r[0].x)<U&&Math.abs(R.y-r[0].y)<U&&r.splice(r.length-1,1),t&&r.push(r[0]),r},n.Path.prototype.toShapes=function(e){var r,i,s,o,u,a=[],f=new n.Path;for(r=0,i=this.actions.length;r<i;r++)s=this.actions[r],u=s.args,o=s.action,o==n.PathActions.MOVE_TO&&f.actions.length!=0&&(a.push(f),f=new n.Path),f[o].apply(f,u);f.actions.length!=0&&a.push(f);if(a.length==0)return[];var l,c,h,p=[];if(a.length==1)return c=a[0],h=new n.Shape,h.actions=c.actions,h.curves=c.curves,p.push(h),p;var d=!n.Shape.Utils.isClockWise(a[0].getPoints());d=e?!d:d;if(d){h=new n.Shape;for(r=0,i=a.length;r<i;r++)c=a[r],l=n.Shape.Utils.isClockWise(c.getPoints()),l=e?!l:l,l?(h.actions=c.actions,h.curves=c.curves,p.push(h),h=new n.Shape):h.holes.push(c)}else{h=t;for(r=0,i=a.length;r<i;r++)c=a[r],l=n.Shape.Utils.isClockWise(c.getPoints()),l=e?!l:l,l?(h&&p.push(h),h=new n.Shape,h.actions=c.actions,h.curves=c.curves):h.holes.push(c);p.push(h)}return p},n.Shape=function(){n.Path.apply(this,arguments),this.holes=[]},n.Shape.prototype=Object.create(n.Path.prototype),n.Shape.prototype.extrude=function(e){var t=new n.ShapeNode(this,e);return t},n.Shape.prototype.makeGeometry=function(e){var t=new n.ShapeGeometry(this,e);return t},n.Shape.prototype.getPointsHoles=function(e){var t,n=this.holes.length,r=[];for(t=0;t<n;t++)r[t]=this.holes[t].getTransformedPoints(e,this.bends);return r},n.Shape.prototype.getSpacedPointsHoles=function(e){var t,n=this.holes.length,r=[];for(t=0;t<n;t++)r[t]=this.holes[t].getTransformedSpacedPoints(e,this.bends);return r},n.Shape.prototype.extractAllPoints=function(e){return{shape:this.getTransformedPoints(e),holes:this.getPointsHoles(e)}},n.Shape.prototype.extractPoints=function(e){return this.useSpacedPoints?this.extractAllSpacedPoints(e):this.extractAllPoints(e)},n.Shape.prototype.extractAllSpacedPoints=function(e){return{shape:this.getTransformedSpacedPoints(e),holes:this.getSpacedPointsHoles(e)}},n.Shape.Utils={removeHoles:function(e,t){var r=e.concat(),i=r.concat(),s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N=[];for(p=0;p<t.length;p++){v=t[p],Array.prototype.push.apply(i,v),m=Number.POSITIVE_INFINITY;for(d=0;d<v.length;d++){b=v[d];var C=[];for(y=0;y<r.length;y++)w=r[y],g=b.distanceToSquared(w),C.push(g),g<m&&(m=g,f=d,l=y)}s=l-1>=0?l-1:r.length-1,u=f-1>=0?f-1:v.length-1;var k=[v[f],r[l],r[s]],L=n.FontUtils.Triangulate.area(k),A=[v[f],v[u],r[l]],O=n.FontUtils.Triangulate.area(A),M=1,_=-1,D=l,P=f;l+=M,f+=_,l<0&&(l+=r.length),l%=r.length,f<0&&(f+=v.length),f%=v
.length,s=l-1>=0?l-1:r.length-1,u=f-1>=0?f-1:v.length-1,k=[v[f],r[l],r[s]];var H=n.FontUtils.Triangulate.area(k);A=[v[f],v[u],r[l]];var B=n.FontUtils.Triangulate.area(A);L+O>H+B&&(l=D,f=P,l<0&&(l+=r.length),l%=r.length,f<0&&(f+=v.length),f%=v.length,s=l-1>=0?l-1:r.length-1,u=f-1>=0?f-1:v.length-1),E=r.slice(0,l),S=r.slice(l),x=v.slice(f),T=v.slice(0,f);var j=[v[f],r[l],r[s]],F=[v[f],v[u],r[l]];N.push(j),N.push(F),r=E.concat(x).concat(T).concat(S)}return{shape:r,isolatedPts:N,allpoints:i}},triangulateShape:function(e,r){var i=n.Shape.Utils.removeHoles(e,r),s=i.shape,o=i.allpoints,u=i.isolatedPts,a=n.FontUtils.Triangulate(s,!1),f,l,c,h,p,d,v={},m={};for(f=0,l=o.length;f<l;f++)p=o[f].x+":"+o[f].y,v[p]!==t&&console.log("Duplicate point",p),v[p]=f;for(f=0,l=a.length;f<l;f++){h=a[f];for(c=0;c<3;c++)p=h[c].x+":"+h[c].y,d=v[p],d!==t&&(h[c]=d)}for(f=0,l=u.length;f<l;f++){h=u[f];for(c=0;c<3;c++)p=h[c].x+":"+h[c].y,d=v[p],d!==t&&(h[c]=d)}return a.concat(u)},isClockWise:function(e){return n.FontUtils.Triangulate.area(e)<0},b2p0:function(e,t){var n=1-e;return n*n*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,n,r){return this.b2p0(e,t)+this.b2p1(e,n)+this.b2p2(e,r)},b3p0:function(e,t){var n=1-e;return n*n*n*t},b3p1:function(e,t){var n=1-e;return 3*n*n*e*t},b3p2:function(e,t){var n=1-e;return 3*n*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,n,r,i){return this.b3p0(e,t)+this.b3p1(e,n)+this.b3p2(e,r)+this.b3p3(e,i)}},n.CubicBezierCurve3=n.Curve.create(function(e,t,n,r){this.v0=e,this.v1=t,this.v2=n,this.v3=r},function(e){var t,r,i;return t=n.Shape.Utils.b3(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=n.Shape.Utils.b3(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y),i=n.Shape.Utils.b3(e,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new n.Vec3(t,r,i)}),n.QuadraticBezierCurve3=n.Curve.create(function(e,t,n){this.v0=e,this.v1=t,this.v2=n},function(e){var t,r,i;return t=n.Shape.Utils.b2(e,this.v0.x,this.v1.x,this.v2.x),r=n.Shape.Utils.b2(e,this.v0.y,this.v1.y,this.v2.y),i=n.Shape.Utils.b2(e,this.v0.z,this.v1.z,this.v2.z),new n.Vec3(t,r,i)}),n.PathNode=function(e,r,i,s,o,u,a,f,l,c){this.materialSize=1,this.closed=!1;var h;arguments.length===1&&arguments[0]instanceof Object&&!(arguments[0]instanceof n.Path)?(h=arguments[0],this.path=h.path,this.segments=h.segments||20,this.radius=h.radius||1,this.segmentsR=h.segmentsR||8,this.shape=h.shape,this.startCap=h.startCap||"plain",this.endCap=h.endCap||"plain",this.arc=h.arc!=t?h.arc:Math.PI*2,this.arcStart=h.arcStart!=t?h.arcStart:0,this.cutSurface=h.cutSurface||"none",this.startCapR=h.startCapR,this.endCapR=h.endCapR,this.startCapSize=h.startCapSize,this.endCapSize=h.endCapSize,this.binormal=h.binormal,this.startCapExtend=h.startCapExtend===t?1:h.startCapExtend,this.endCapExtend=h.endCapExtend===t?1:h.endCapExtend,this._id=h.id):(this.path=e,this.segments=r||20,this.radius=i||1,this.segmentsR=s||8,this.shape=a,this.startCap=o||"plain",this.endCap=u||"plain",this.arc=f!=t?f:Math.PI*2,this.arcStart=l!=t?l:0,this.cutSurface=c||"none"),this.shape instanceof Array&&(this.segmentsR=this.shape.length),this.startCapSize=this.startCapSize||1,this.endCapSize=this.endCapSize||1,this.segmentsCap=20,this.arc===Math.PI*2&&(this.cutSurface="none"),n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.PathNode,n.Entity,{constructor:n.PathNode,className:"TGL.PathNode",__accessor:["path","segments","radius","segmentsR","startCap","endCap","shape","startCapSize","endCapSize","segmentsCap","arc","arcStart","cutSurface","startCapR","endCapR","startCapExtend","endCapExtend","binormal"],__SizePropeties:["path","segments","radius","segmentsR","startCap","endCap","shape","startCapSize","endCapSize","segmentsCap","arc","arcStart","cutSurface","startCapR","endCapR","startCapExtend","endCapExtend","binormal"],getCrossSectionPoint:function(){},needComputeVertexNormal:function(){return!0},adjustPath:function(e,t,r){t=t||this.radius,r=r||this._adjustTimes||2;var i=new n.Path,s,o,u,a,l,c,h,p,d,v=new f,m=new f,g,y=new f,b=new f,w,E,S=e.actions.length;for(E=0;E<S;E++){u=e.actions[E],l=E+1===S?null:e.actions[E+1],a=u.args;if(u.action==="moveTo")i.moveTo(a[0],a[1],a[2]);else if(u.action==="lineTo")if(l&&l.action==="lineTo"){s=e.actions[E-1],o=s.args,c=l.args,h=new f(o[0],o[1],o[2]),p=new f(a[0],a[1],a[2]),d=new f(c[0],c[1],c[2]),v.subVectors(p,h),m.subVectors(p,d);if(m.length()==0){e.actions.splice(E,1),E-=1,S-=1;continue}g=v.angleTo(m),w=Math.min(v.length()/2,m.length()/2),w=Math.min(t*r,w),y.addVectors(p,v.normalize().multiplyScalar(-w)),b.addVectors(p,m.normalize().multiplyScalar(-w)),i.lineTo(y.x,y.y,y.z),i.curveTo(p.x,p.y,p.z,b.x,b.y,b.z)}else i.lineTo(a[0],a[1],a[2]);else u.action==="quadraticCurveTo"&&i.curveTo(a[0],a[1],a[2],a[3],a[4],a[5])}return i},_resetPath:function(){return this.path},getPointAt:function(e){return this._realPath?this._realPath.getPoint(e):null},getTangentAt:function(e){if(this._realPath){var t=this._realPath.getPoint(e),n=this._realPath.getPoint(e-.001);return t.sub(n).normalize()}return null},computeData:function(){function Y(e,t,r,i){return i.vertices.push(new n.Vec3(e,t,r))-1}this.grid=[],this.startGrid=[],this.endGrid=[];var e=this.segmentsCap,t=this,r,i,s,u,a,f,l,c,h,p,d,v,m,g,y=new n.Vec3,b,w,E,S,x,T,N,C,k,L,A,O,M={};M.faces=[],M.uvs=[],M.vertices=[];if(this.path==null)return M;var _=this._resetPath(),D=this.startCap,P=this.endCap,H=this.cutSurface;this._realPath=_,this._autoAjust==1&&(_=this.adjustPath(_));var B=_.curves.length,j=_.curves,F=[],I,q=_.getLength(),N,R,U=0,z=this.segments,w;for(b=0;b<B;b++){N=j[b],R=N.getLength();if(N instanceof n.LineCurve3){var W=(R*.001+U)/q,X=(R*.999+U)/q;F.push(W),F.push(X)}else{var V=R*.998;for(w=0;w<=z;w++){var $=(R*.001+V*w/z+U)/q;F.push($)}}U+=R}var J=this.frenetFrames(_,F,this.closed,this.binormal),K=J.tangents,Q=J.normals,G=J.binormals;this.tangents=K,this.normals=Q,this.binormals=G;var Z=0,et,tt=F.length-1,nt=tt+1,rt=0,it=0;for(b=0;b<nt;b++){this.grid[b]=[],p=F[b],g=_.getPointAt(p),r=K[b],i=Q[b],s=G[b];if(D!=="none"&&b===0)if(D==="round"||D==="arrow"){var st,ot;rt+=this.radius*this.startCapSize;var ut=g.clone().add(r.clone().multiplyScalar(-this.radius*this.startCapSize));for(var at=0;at<=e;at++){this.startGrid[at]=[];var ft=at/e*Math.PI/2;D==="round"?st=ut.clone().add(r.clone().multiplyScalar(this.radius*this.startCapSize*(1-Math.cos(ft)))):st=ut.clone().add(r.clone().multiplyScalar(this.radius*this.startCapSize*at/e));for(var w=0;w<this.segmentsR;w++)d=w/this.segmentsR*this.arc+this.arcStart,D==="round"?(v=-this.radius*Math.cos(d)*Math.sin(ft),m=this.radius*Math.sin(d)*Math.sin(ft)):(v=-this.radius*Math.cos(d)*at/e,m=this.radius*Math.sin(d)*at/e,v*=this.startCapR||1.3,m*=this.startCapR||1.3),ot=st.clone(),ot.x+=v*i.x+m*s.x,ot.y+=v*i.y+m*s.y,ot.z+=v*i.z+m*s.z,this.startGrid[at][w]=M.vertices.push(ot)-1;H==="center"&&(this.startGrid[at][this.segmentsR]=M.vertices.push(st.clone())-1)}}else Z=M.vertices.push(g);for(w=0;w<this.segmentsR;w++){et=w/(this.segmentsR-1);if(this.shape instanceof Array)v=-this.shape[w].x,m=this.shape[w].y;else if(this.shape instanceof n.Path){var lt=this.shape.getPointAt(et);v=-lt.x,m=-lt.y}else d=w/this.segmentsR*this.arc+this.arcStart,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);y.copy(g),y.x+=v*i.x+m*s.x,y.y+=v*i.y+m*s.y,y.z+=v*i.z+m*s.z,this.grid[b][w]=Y(y.x,y.y,y.z,M)}H==="center"&&(this.grid[b][this.segmentsR]=M.vertices.push(g.clone())-1);if(P!=="none"&&b===nt-1)if(P==="round"||P==="arrow"){it+=this.radius*this.endCapSize;var st,ot,ut=g.clone().add(r.clone().multiplyScalar(this.radius*this.endCapSize));for(var at=0;at<=e;at++){this.endGrid[at]=[];var ft=(1-at/e)*Math.PI/2;P==="round"?st=ut.clone().add(r.clone().multiplyScalar(-this.radius*this.endCapSize*(1-Math.cos(ft)))):st=ut.clone().add(r.clone().multiplyScalar(-this.radius*this.endCapSize*(1-at/e)));for(var w=0;w<this.segmentsR;w++)d=w/this.segmentsR*this.arc+this.arcStart,P==="round"?(v=-this.radius*Math.cos(d)*Math.sin(ft),m=this.radius*Math.sin(d)*Math.sin(ft)):(v=-this.radius*Math.cos(d)*(1-at/e),m=this.radius*Math.sin(d)*(1-at/e),v*=this.endCapR||1.3,m*=this.endCapR||1.3),ot=st.clone(),ot.x+=v*i.x+m*s.x,ot.y+=v*i.y+m*s.y,ot.z+=v*i.z+m*s.z,this.endGrid[at][w]=M.vertices.push(ot)-1;H==="center"&&(this.endGrid[at][this.segmentsR]=M.vertices.push(st)-1)}}else M.vertices.push(g)}var ct=this.segmentsR,ht=this.segmentsR;this.arc!==Math.PI*2&&(H==="center"?(ct++,ht++):H==="none"&&ct--);var pt=this.arc/Math.PI/2,dt=_.getLength(),vt=dt+rt+it,mt=0,gt=rt/vt,yt=gt,bt=dt/vt,wt=gt+bt,Et=it/vt,St=0;if(D!=="none")if(D==="plain"){x=0;for(w=0;w<this.segmentsR;w++){S=(w+1)%this.segmentsR,T=this.grid[0][w],N=this.grid[0][S],M.faces.push(new n.Face3(x,T,N)),d=w/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var k=new o(.5,.5);d=w/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var L=new o((v/this.radius+1)/2,(m/this.radius+1)/2);d=S/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var A=new o((v/this.radius+1)/2,(m/this.radius+1)/2);M.uvs.push([k,L,A])}}else for(b=0;b<=e;b++)for(w=0;w<ct;w++){E=b+1,S=(w+1)%ht,x=this.startGrid[b][w],E===e+1?(T=this.grid[0][w],N=this.grid[0][S]):(T=this.startGrid[E][w],N=this.startGrid[E][S]),C=this.startGrid[b][S];if(w>=this.segmentsR-1){var at=this.segmentsR-1,p=at/this.segmentsR*pt;ct===this.segmentsR?(k=new n.Vec2(b/e*gt+mt,p),L=new n.Vec2((b+1)/e*gt+mt,p),A=new n.Vec2((b+1)/e*gt+mt,1),O=new n.Vec2(b/e*gt+mt,1)):w>this.segmentsR-1?(k=new n.Vec2(b/e*gt+mt,(1+p)/2),L=new n.Vec2((b+1)/e*gt+mt,(1+p)/2),A=new n.Vec2((b+1)/e*gt+mt,1),O=new n.Vec2(b/e*gt+mt,1)):(k=new n.Vec2(b/e*gt+mt,p),L=new n.Vec2((b+1)/e*gt+mt,p),A=new n.Vec2((b+1)/e*gt+mt,(1+p)/2),O=new n.Vec2(b/e*gt+mt,(1+p)/2))}else k=new n.Vec2(b/e*gt+mt,w/this.segmentsR*pt),L=new n.Vec2((b+1)/e*gt+mt,w/this.segmentsR*pt),A=new n.Vec2((b+1)/e*gt+mt,(w+1)/this.segmentsR*pt),O=new n.Vec2(b/e*gt+mt,(w+1)/this.segmentsR*pt);b!==0&&(M.faces.push(new n.Face3(x,T,C,Z-1)),M.uvs.push([k,L,O])),M.faces.push(new n.Face3(T,N,C,Z-1)),M.uvs.push([L.clone(),A,O.clone()])}for(b=0;b<tt;b++)for(w=0;w<ct;w++){E=this.closed?(b+1)%tt:b+1,S=(w+1)%ht,x=this.grid[b][w],T=this.grid[E][w],N=this.grid[E][S],C=this.grid[b][S];if(w>=this.segmentsR-1){var at=this.segmentsR-1,p=at/this.segmentsR*pt;ct===this.segmentsR?(k=new n.Vec2(F[b]*bt+yt,p),L=new n.Vec2(F[b+1]*bt+yt,p),A=new n.Vec2(F[b+1]*bt+yt,1),O=new n.Vec2(F[b]*bt+yt,1)):w>this.segmentsR-1?(k=new n.Vec2(F[b]*bt+yt,(p+1)/2),L=new n.Vec2(F[b+1]*bt+yt,(p+1)/2),A=new n.Vec2(F[b+1]*bt+yt,1),O=new n.Vec2(F[b]*bt+yt,1)):(k=new n.Vec2(F[b]*bt+yt,p),L=new n.Vec2(F[b+1]*bt+yt,p),A=new n.Vec2(F[b+1]*bt+yt,(p+1)/2),O=new n.Vec2(F[b]*bt+yt,(p+1)/2))}else k=new n.Vec2(F[b]*bt+yt,w/this.segmentsR*pt),L=new n.Vec2(F[b+1]*bt+yt,w/this.segmentsR*pt),A=new n.Vec2(F[b+1]*bt+yt,(w+1)/this.segmentsR*pt),O=new n.Vec2(F[b]*bt+yt,(w+1)/this.segmentsR*pt);M.faces.push(new n.Face3(x,T,C)),M.uvs.push([k,L,O]),M.faces.push(new n.Face3(T,N,C)),M.uvs.push([L.clone(),A,O.clone()])}if(P!=="none"){x=M.vertices.length-1;var B=this.grid.length;if(P==="plain")for(w=0;w<this.segmentsR;w++){S=(w+1)%this.segmentsR,T=this.grid[B-1][w],N=this.grid[B-1][S],M.faces.push(new n.Face3(x,N,T)),d=w/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var k=new o(.5,.5);d=w/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var L=new o((v/this.radius+1)/2,(m/this.radius+1)/2);d=S/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var A=new o((v/this.radius+1)/2,(m/this.radius+1)/2);M.uvs.push([k,A,L])}else for(b=-1;b<e;b++)for(w=0;w<ct;w++){E=b+1,S=(w+1)%ht,b===-1?(x=this.grid[B-1][w],C=this.grid[B-1][S]):(x=this.endGrid[b][w],C=this.endGrid[b][S]),T=this.endGrid[E][w],N=this.endGrid[E][S];if(w>=this.segmentsR-1){var at=this.segmentsR-1,p=at/this.segmentsR*pt;ct===this.segmentsR?(k=new n.Vec2(b/e*Et+wt,p),L=new n.Vec2((b+1)/e*Et+wt,p),A=new n.Vec2((b+1)/e*Et+wt,1),O=new n.Vec2(b/e*Et+wt,1)):w>this.segmentsR-1?(k=new n.Vec2(b/e*Et+wt,(1+p)/2),L=new n.Vec2((b+1)/e*Et+wt,(1+p)/2),A=new n.Vec2((b+1)/e*Et+wt,1),O=new n.Vec2(b/e*Et+wt,1)):(k=new n.Vec2(b/e*Et+wt,p),L=new n.Vec2((b+1)/e*Et+wt,p),A=new n.Vec2((b+1)/e*Et+wt,(1+p)/2),O=new n.Vec2(b/e*Et+wt,(1+p)/2))}else k=new n.Vec2(b/e*Et+wt,w/this.segmentsR*pt),L=new n.Vec2((b+1)/e*Et+wt,w/this.segmentsR*pt),A=new n.Vec2((b+1)/e*Et+wt,(w+1)/this.segmentsR*pt),O=new n.Vec2(b/e*Et+wt,(w+1)/this.segmentsR*pt);M.faces.push(new n.Face3(x,T,C)),M.uvs.push([k,L,O]),M.faces.push(new n.Face3(T,N,C)),M.uvs.push([L.clone(),A,O.clone()])}}return M},frenetFrames:function(e,r,i,s){function C(e){l[0]=new n.Vec3,c[0]=new n.Vec3,e===t&&(e=new n.Vec3(0,0,1)),l[0].crossVectors(e,f[0]).normalize(),c[0].crossVectors(f[0],l[0]).normalize()}function k(){var t=e.getTangentAt(g);l[0]=(new n.Vec3).subVectors(t,f[0]).normalize(),c[0]=(new n.Vec3).crossVectors(f[0],l[0]),l[0].crossVectors(c[0],f[0]).normalize(),c[0].crossVectors(f[0],l[0]).normalize()}function L(){l[0]=new n.Vec3,c[0]=new n.Vec3,y=Number.MAX_VALUE,b=Math.abs(f[0].x),w=Math.abs(f[0].y),E=Math.abs(f[0].z),w<=y&&(y=w,u.set(0,1,0)),b<=y&&(y=b,u.set(1,0,0)),E<=y&&u.set(0,0,1),s&&(u=s.clone()),h.crossVectors(f[0],u).normalize(),l[0].crossVectors(f[0],h),c[0].crossVectors(f[0],l[0])}var o=new n.Vec3,u=new n.Vec3,a=new n.Vec3,f=[],l=[],c=[],h=new n.Vec3,p=new n.Mat4,d=r.length-1,v=d+1,m,g=1e-4,y,b,w,E,S,x,T,N=[];N.tangents=f,N.normals=l,N.binormals=c;for(S=0;S<v;S++){x=r[S];var T=e.getTangentAt(x);f[S]=new n.Vec3(T.x,T.y,T.z?T.z:0),f[S].normalize()}L();for(S=1;S<v;S++)l[S]=l[S-1].clone(),c[S]=c[S-1].clone(),h.crossVectors(f[S-1],f[S]),h.length()>g&&(h.normalize(),m=Math.acos(n.Math.clamp(f[S-1].dot(f[S]),-1,1)),l[S].applyMatrix4(p.makeRotationAxis(h,m))),c[S].crossVectors(f[S],l[S]);if(i){m=Math.acos(n.Math.clamp(l[0].dot(l[v-1]),-1,1)),m/=v-1,f[0].dot(h.crossVectors(l[0],l[v-1]))>0&&(m=-m);for(S=1;S<v;S++)l[S].applyMatrix4(p.makeRotationAxis(f[S],m*S)),c[S].crossVectors(f[S],l[S])}return N}}),n.PathCube=function(e,t,r,i,s){var o;arguments.length===1&&arguments[0]instanceof Object&&!(arguments[0]instanceof n.Path)?(o=arguments[0],this.path=o.path,this.width=o.width||50,this.height=o.height||100,this.curveSegements=o.curveSegements||32,this.repeat=o.repeat||20,this._id=o.id):(this.path=e,this.width=t||50,this.height=r||100,this.curveSegements=i||32,this.repeat=s||20),this.materialSize=6,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.PathCube.SideIndexMapping={bottom:0,outside:1,inside:2,top:3,aside:4,zside:5},n.extend(n.PathCube,n.Entity,{__accessor:["path","width","height","curveSegements","repeat"],__SizePropeties:["path","width","height","curveSegements","repeat"],constructor:n.PathCube,className:"TGL.PathCube",getSideIndexMapping:function(){return n.PathCube.SideIndexMapping},computeData:function(){var e={};e.vertices=[],e.faces=[],e.uvs=[],e.uv2s=[];if(this.path==null)return e;var t=this.computePoints(this.path,this.width,this.curveSegements),n=t[0],r=t[1],i=n.length,s,o=t[2],u=this.height,a=this.repeat,f=[],l=[],c=[],h=[],p=this.path.isClockwise();this.innerPoints=this.clonePoints(n),this.outerPoints=this.clonePoints(r);for(s=0;s<i;s++)this.exchangeYZ(n[s]),this.exchangeYZ(r[s]),f[s]=e.vertices.push(n[s])-1,l[s]=e.vertices.push(r[s])-1,c[s]=e.vertices.push(n[s].clone().setY(u))-1,h[s]=e.vertices.push(r[s].clone().setY(u))-1;var d=o?i:i-1;for(s=0;s<d;s++)this.generateTop(e,s,i,c,h,!0,a),this.generateBottom(e,s,i,f,l,a),this.generateSideWall(e,s,i,h,l,!0,a,p),this.generateSideWall(e,s,i,c,f,!1,a,p);return o||(this.generateEnd(e,c,f,l,h,a,!0),this.generateEnd(e,c,f,l,h,a,!1)),this.clockwise=p,e},clonePoints:function(e){var t=[];for(var n=0;n<e.length;n++)t.push(e[n].clone());return t},getInsidePoints:function(){var e=[];return this.clockwise?e=this.innerPoints:e=this.outerPoints,e},generateEnd:function(e,t,r,i,s,u,a){var f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,E,T,N,C,k,L=a?0:r.length-1;f=t[L],l=r[L],c=i[L],h=s[L],T=e.vertices[f],N=e.vertices[l],C=e.vertices[c],k=e.vertices[h],p=T.x,d=T.y,v=T.z,m=N.x,g=N.y,y=N.z,b=C.x,w=C.y,E=C.z,S=k.x,x=k.y,dz=k.z;var A=Math.abs(v-E),O=Math.abs(p-b);a?(e.faces.push(new n.Face3(f,l,h,null,null,4)),A<O?e.uvs.push([new n.Vec2(p/u,d/u),new n.Vec2(m/u,g/u),new n.Vec2(S/u,x/u)]):e.uvs.push([new n.Vec2(v/u,d/u),new n.Vec2(y/u,g/u),new n.Vec2(dz/u,x/u)]),e.uv2s.push([new o(0,1),new o(0,0),new o(1,1)]),e.faces.push(new n.Face3(l,c,h,null,null,4)),A<O?e.uvs.push([new n.Vec2(m/u,g/u),new n.Vec2(b/u,w/u),new n.Vec2(S/u,x/u)]):e.uvs.push([new n.Vec2(y/u,g/u),new n.Vec2(E/u,w/u),new n.Vec2(dz/u,x/u)]),e.uv2s.push([new o(0,0),new o(1,0),new o(1,1)])):(e.faces.push(new n.Face3(l,f,h,null,null,5)),A<O?e.uvs.push([new n.Vec2(m/u,g/u),new n.Vec2(p/u,d/u),new n.Vec2(S/u,x/u)]):e.uvs.push([new n.Vec2(y/u,g/u),new n.Vec2(v/u,d/u),new n.Vec2(dz/u,x/u)]),e.uv2s.push([new o(0,0),new o(0,1),new o(1,1)]),e.faces.push(new n.Face3(c,l,h,null,null,5)),A<O?e.uvs.push([new n.Vec2(b/u,w/u),new n.Vec2(m/u,g/u),new n.Vec2(S/u,x/u)]):e.uvs.push([new n.Vec2(E/u,w/u),new n.Vec2(y/u,g/u),new n.Vec2(dz/u,x/u)]),e.uv2s.push([new o(1,0),new o(0,0),new o(1,1)]))},generateSideWall:function(e,t,r,i,s,u,a,f){var l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,S,N,C,k,L,A;N=(t+1)%r,l=i[t],c=s[t],h=s[N],p=i[N],C=e.vertices[l],k=e.vertices[c],L=e.vertices[h],A=e.vertices[p],d=C.x,v=C.y,m=C.z,g=k.x,y=k.y,b=k.z,w=L.x,E=L.y,S=L.z,x=A.x,T=A.y,dz=A.z;var O=Math.abs(m-S),M=Math.abs(d-w),_;u?(_=f?1:2,e.faces.push(new n.Face3(l,c,p,null,null,_)),O<M?e.uvs.push([new n.Vec2(d/a,v/a),new n.Vec2(g/a,y/a),new n.Vec2(x/a,T/a)]):e.uvs.push([new n.Vec2(m/a,v/a),new n.Vec2(b/a,y/a),new n.Vec2(dz/a,T/a)]),e.uv2s.push([new o(0,1),new o(0,0),new o(1,1)]),e.faces.push(new n.Face3(c,h,p,null,null,_)),O<M?e.uvs.push([new n.Vec2(g/a,y/a),new n.Vec2(w/a,E/a),new n.Vec2(x/a,T/a)]):e.uvs.push([new n.Vec2(b/a,y/a),new n.Vec2(S/a,E/a),new n.Vec2(dz/a,T/a)]),e.uv2s.push([new o(0,0),new o(1,0),new o(1,1)])):(_=f?2:1,e.faces.push(new n.Face3(c,l,p,null,null,_)),O<M?e.uvs.push([new n.Vec2(g/a,y/a),new n.Vec2(d/a,v/a),new n.Vec2(x/a,T/a)]):e.uvs.push([new n.Vec2(b/a,y/a),new n.Vec2(m/a,v/a),new n.Vec2(dz/a,T/a)]),e.uv2s.push([new o(0,0),new o(0,1),new o(1,1)]),e.faces.push(new n.Face3(h,c,p,null,null,_)),O<M?e.uvs.push([new n.Vec2(w/a,E/a),new n.Vec2(g/a,y/a),new n.Vec2(x/a,T/a)]):e.uvs.push([new n.Vec2(S/a,E/a),new n.Vec2(b/a,y/a),new n.Vec2(dz/a,T/a)]),e.uv2s.push([new o(1,0),new o(0,0),new o(1,1)]))},generateBottom:function(e,t,n,r,i,s){this.generateTop(e,t,n,r,i,!1,s)},generateTop:function(e,t,r,i,s,u,a){var f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,E,T,N,C,k,L;T=(t+1)%r,f=i[t],l=s[t],c=s[T],h=i[T],N=e.vertices[f],C=e.vertices[l],k=e.vertices[c],L=e.vertices[h],p=N.x,d=N.y,v=N.z,m=C.x,g=C.y,y=C.z,b=k.x,w=k.y,E=k.z,S=L.x,x=L.y,dz=L.z,u?(e.faces.push(new n.Face3(f,l,h,null,null,3)),e.uvs.push([new n.Vec2(p/a,v/a),new n.Vec2(m/a,y/a),new n.Vec2(S/a,dz/a)]),e.uv2s.push([new o(0,1),new o(0,0),new o(1,1)]),e.faces.push(new n.Face3(l,c,h,null,null,3)),e.uvs.push([new n.Vec2(m/a,y/a),new n.Vec2(b/a,E/a),new n.Vec2(S/a,dz/a)]),e.uv2s.push([new o(0,0),new o(1,0),new o(1,1)])):(e.faces.push(new n.Face3(l,f,h,null,null,0)),e.uvs.push([new n.Vec2(m/a,y/a),new n.Vec2(p/a,v/a),new n.Vec2(S/a,dz/a)]),e.uv2s.push([new o(0,0),new o(0,1),new o(1,1)]),e.faces.push(new n.Face3(c,l,h,null,null,0)),e.uvs.push([new n.Vec2(b/a,E/a),new n.Vec2(m/a,y/a),new n.Vec2(S/a,dz/a)]),e.uv2s.push([new o(1,0),new o(0,0),new o(1,1)]))},exchangeYZ:function(e){var t=e.y;e.y=e.z,e.z=-t},addPoints:function(e,t,r,i,s){t.multiplyScalar(.5),r.push((new n.Vec3).subVectors(e,t)),i.push((new n.Vec3).addVectors(e,t))},computeCurvePoint:function(e,t,r,i,s,o,a,l,c){var h=i?0:1,p,d,v=new n.Vec3,m,g,y,b=l;if(e){m=e.getTangentAt(1),g=t.getTangentAt(0),concave=n.Math.isConcave(m,g,!1),g.multiplyScalar(-1),angle=m.angleTo(g),y=Math.sin(angle/2),d=t.getPoint(0),y=y==0?.1:y;var w=concave?r/y:-r/y;y==1?v.crossVectors(g,new f(0,0,1)).normalize().multiplyScalar(w):v.addVectors(m,g).normalize().multiplyScalar(w),this.addPoints(d,v,o,a,c)}else g=t.getTangentAt(h),d=t.getPoint(h),v.crossVectors(g,new n.Vec3(0,0,1)).normalize().multiplyScalar(r),this.addPoints(d,v,o,a,c);if(!(t instanceof n.LineCurve3)&&s){var E=b+1;for(j=0;j<E-2;j++)u=j/(E-1),g=t.getTangentAt(u),d=t.getPointAt(u),v.crossVectors(g,new n.Vec3(0,0,1)).normalize().multiplyScalar(r),j*t.getLength()/b>r/Math.abs(y)&&this.addPoints(d,v,o,a,c)}},computePoints:function(e,t,r){var i,s,o,u,a=new n.Vec3,f,l,c=e.isClockwise(),h,p,d=e.curves[0].getPoint(0),v=e.curves[e.curves.length-1].getPoint(1);p=d.equals(v),l=e.curves.length;var m=[],g=[],y=new n.Path,b=0,w,E=e.getLength();for(i=0;i<l;i++){var S=i-1;p&&S===-1&&(S=l-1);var x=e.curves[S],T=e.curves[i];this.computeCurvePoint(x,T,t,!0,!0,m,g,r,c),i===l-1&&!p&&this.computeCurvePoint(null,T,t,!1,!1,m,g,r,c)}return[m,g,p]}}),n.ShapeNode=function(e,t,r,i,s){if(e==null){e=[],this.materialSize=3,n.Entity.call(this);return}var o;if(!(arguments.length===1&&arguments[0]instanceof Object)||arguments[0]instanceof n.Shape||arguments[0]instanceof n.Path&&!Array.isArray(arguments[0]))this.options={curveSegments:t,amount:r,vertical:i,zMinusHalfAmount:this.zMinusHalfAmount,repeat:s||20};else{o=arguments[0],e=o.path;if(e==null){e=[],this.materialSize=3,n.Entity.call(this);return}t=o.curveSegments,r=o.amount,i=o.vertical,s=o.repeat,this.options={curveSegments:o.curveSegments,amount:o.amount,vertical:o.vertical,zMinusHalfAmount:this.zMinusHalfAmount,repeat:o.repeat||20},this._id=o.id}var u=[];e instanceof n.Path?(u=e.toShapes(),this.path=e):u=e,this.curveSegments=t,this.amount=r,this.vertical=i,this.repeat=s||20,u=u instanceof Array?u:[u],this.shapes=u,this.shapebb=u[u.length-1].getBoundingBox(),this.materialSize=3,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.ShapeNode.SideIndexMapping={bottom:0,side:1,top:2},n.extend(n.ShapeNode,n.Entity,{constructor:n.ShapeNode,className:"TGL.ShapeNode",__accessor:["path","curveSegments","amount","vertical","repeat"],__bool:["vertical"],__SizePropeties:["path","curveSegments","amount","vertical","repeat"],computeData:function(){return this.options={curveSegments:this.curveSegments,amount:this.amount,vertical:this.vertical,zMinusHalfAmount:this.zMinusHalfAmount,repeat:this.repeat||20},this.addShapes(this.path,this.options)},getSideIndexMapping:function(){return n.ShapeNode.SideIndexMapping},addShapes:function(e,t){var r=[];e instanceof n.Path?r=e.toShapes():r=e;var i={};i.vertices=[],i.uvs=[],i.uv2s=[],i.faces=[];if(!r)return i;var s=r.length;for(var o=0;o<s;o++){var u=r[o];this.addShape(u,t,i)}var a=new n.BoundingBox;a.setFromPoints(i.vertices);var f=(a.max.y-a.min.y)/2;if(t.zMinusHalfAmount)for(var l=0;l<i.vertices.length;l++)i.vertices[l].y-=f;if(t.vertical)for(var l=0;l<i.vertices.length;l++){var c=i.vertices[l].y;i.vertices[l].y=i.vertices[l].z,i.vertices[l].z=-c}return i}}),n.ShapeNode.prototype.addShape=function(e,r,i){function B(e,t,n){return t||console.log("die"),t.clone().multiplyScalar(n).add(e)}function J(e,t,n){return Q(e,t,n)}function K(e,t,r){var i=Math.atan2(t.y-e.y,t.x-e.x),s=Math.atan2(r.y-e.y,r.x-e.x);i>s&&(s+=Math.PI*2);var o=(i+s)/2,u=-Math.cos(o),a=-Math.sin(o),f=new n.Vec2(u,a);return f}function Q(e,t,r){var i=n.ShapeNode.__v1,s=n.ShapeNode.__v2,o=n.ShapeNode.__v3,u=n.ShapeNode.__v4,a=n.ShapeNode.__v5,f=n.ShapeNode.__v6,l,c,h,p,d,v;return i.set(e.x-t.x,e.y-t.y),s.set(e.x-r.x,e.y-r.y),l=i.normalize(),c=s.normalize(),o.set(-l.y,l.x),u.set(c.y,-c.x),a.copy(e).add(o),f.copy(e).add(u),a.equals(f)?u.clone():(a.copy(t).add(o),f.copy(r).add(u),h=l.dot(u),p=f.sub(a).dot(u),h===0&&(console.log("Either infinite or no solutions!"),p===0?console.log("Its finite solutions."):console.log("Too bad, no solutions.")),d=p/h,d<0?K(e,t,r):(v=l.multiplyScalar(d).add(a),v.sub(e).clone()))}function ft(){var e=i.uvs.length;if(c){var t=0,n=U*t;for(Y=0;Y<W;Y++)z=P[Y],dt(z[2]+n,z[1]+n,z[0]+n,!0);t=p+l*2,n=U*t;for(Y=0;Y<W;Y++)z=P[Y],dt(z[0]+n,z[1]+n,z[2]+n,!1)}else{for(Y=0;Y<W;Y++)z=P[Y],dt(z[2],z[1],z[0],!0);for(Y=0;Y<W;Y++)z=P[Y],dt(z[0]+U*p,z[1]+U*p,z[2]+U*p,!1)}ct(e)}function lt(){var e=i.uvs.length,t=0;ht(H,t),t+=H.length;for(C=0,k=_.length;C<k;C++)N=_[C],ht(N,t),t+=N.length;ct(e)}function ct(e){var t=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(var u=e;u<i.uvs.length;u++){var a=i.uvs[u];for(var f=0;f<a.length;f++){var l=a[f];l.x>r&&(r=l.x),l.y>s&&(s=l.y),l.x<t&&(t=l.x),l.y<n&&(n=l.y)}}var c=r-t,h=s-n;for(var u=e;u<i.uvs.length;u++){var a=i.uvs[u],p=[];for(var f=0;f<a.length;f++){var l=a[f];p.push(new o((l.x-t)/c,(l.y-n)/h))}i.uv2s.push(p)}}function ht(e,t){var n,r;Y=e.length;while(--Y>=0){n=Y,r=Y-1,r<0&&(r=e.length-1);var i=0,s=p+l*2;for(i=0;i<s;i++){var o=U*i,u=U*(i+1),a=t+n+o,f=t+r+o,c=t+r+u,h=t+n+u;vt(a,f,c,h,e,i,s,n,r)}}}function pt(e,t,r){i.vertices.push(new n.Vec3(e,t,r-(u?s/2:0)))}function dt(t,s,o,u){t+=A,s+=A,o+=A;var a=u?0:2;if(n.Math.isClockwise([i.vertices[t],i.vertices[s],i.vertices[o]]),"x","z"){i.faces.push(new n.Face3(t,s,o,null,null,a));var f=u?b.generateBottomUV(i,e,r,t,s,o):b.generateTopUV(i,e,r,t,s,o);i.uvs.push(f)}else{i.faces.push(new n.Face3(t,o,s,null,null,a));var f=u?b.generateBottomUV(i,e,r,t,o,s):b.generateTopUV(i,e,r,t,o,s);i.uvs.push(f)}}function vt(t,s,o,u,a,f,l,c,h){t+=A,s+=A,o+=A,u+=A;if(n.Math.isClockwise([i.vertices[t],i.vertices[s],i.vertices[u]]),"x","z"){i.faces.push(new n.Face3(t,s,u,null,null,y)),i.faces.push(new n.Face3(s,o,u,null,null,y));var p=b.generateSideWallUV(i,e,a,r,t,s,o,u,f,l,c,h);i.uvs.push([p[0],p[1],p[3]]),i.uvs.push([p[1],p[2],p[3]])}else{i.faces.push(new n.Face3(t,u,s,null,null,y)),i.faces.push(new n.Face3(s,u,o,null,null,y));var p=b.generateSideWallUV(i,e,a,r,t,s,o,u,f,l,c,h);i.uvs.push([p[0],p[3],p[1]]),i.uvs.push([p[1],p[3],p[2]])}}var s=r.amount!==t?r.amount:100,u=r.zMinusHalfAmount!==t?r.zMinusHalfAmount:!1,a=r.bevelThickness!==t?r.bevelThickness:6,f=r.bevelSize!==t?r.bevelSize:a-2,l=r.bevelSegments!==t?r.bevelSegments:3,c=r.bevelEnabled!==t?r.bevelEnabled:!1,h=r.curveSegments!==t?r.curveSegments:12,p=r.steps!==t?r.steps:1,d=r.extrudePath,v,m=!1,g=r.material||0,y=r.extrudeMaterial||1,b=r.UVGenerator!==t?r.UVGenerator:n.ShapeNode.WorldUVGenerator;b.repeat=r.repeat,b.amount=s;var w=this.shapebb,E,S,x,T;d&&(v=d.getSpacedPoints(p),m=!0,c=!1,E=r.frames!==t?r.frames:n.PathNode.prototype.frenetFrames(d,p,!1),S=new n.Vec3,x=new n.Vec3,T=new n.Vec3),c||(l=0,a=0,f=0);var N,C,k,L=[],A=i.vertices.length,O=e.extractPoints(h),M=O.shape,_=O.holes,D=!n.Shape.Utils.isClockWise(M);if(D){M=M.reverse();for(C=0,k=_.length;C<k;C++)N=_[C],n.Shape.Utils.isClockWise(N)&&(_[C]=N.reverse());D=!1}var P=n.Shape.Utils.triangulateShape(M,_),H=M;for(C=0,k=_.length;C<k;C++)N=_[C],M=M.concat(N);var j,F,I,q,R,U=M.length,z,W=P.length,X,V=H.length,$=180/Math.PI,G=[];for(var Y=0,Z=H.length,et=Z-1,tt=Y+1;Y<Z;Y++,et++,tt++){et===Z&&(et=0),tt===Z&&(tt=0);var nt=H[Y],rt=H[et],it=H[tt];G[Y]=J(H[Y],H[et],H[tt])}var st=[],ot,ut=G.concat();for(C=0,k=_.length;C<k;C++){N=_[C],ot=[];for(Y=0,Z=N.length,et=Z-1,tt=Y+1;Y<Z;Y++,et++,tt++)et===Z&&(et=0),tt===Z&&(tt=0),ot[Y]=J(N[Y],N[et],N[tt]);st.push(ot),ut=ut.concat(ot)}for(j=0;j<l;j++){I=j/l,q=a*(1-I),F=f*Math.sin(I*Math.PI/2);for(Y=0,Z=H.length;Y<Z;Y++)R=B(H[Y],G[Y],F),pt(R.x,R.y,-q);for(C=0,k=_.length;C<k;C++){N=_[C],ot=st[C];for(Y=0,Z=N.length;Y<Z;Y++)R=B(N[Y],ot[Y],F),pt(R.x,R.y,-q)}}F=f;for(Y=0;Y<U;Y++)R=c?B(M[Y],ut[Y],F):M[Y],m?(x.copy(E.normals[0]).multiplyScalar(R.x),S.copy(E.binormals[0]).multiplyScalar(R.y),T.copy(v[0]).add(x).add(S),pt(T.x,T.y,T.z)):pt(R.x,R.y,0);var at;for(at=1;at<=p;at++)for(Y=0;Y<U;Y++)R=c?B(M[Y],ut[Y],F):M[Y],m?(x.copy(E.normals[at]).multiplyScalar(R.x),S.copy(E.binormals[at]).multiplyScalar(R.y),T.copy(v[at]).add(x).add(S),pt(T.x,T.y,T.z)):pt(R.x,R.y,s/p*at);for(j=l-1;j>=0;j--){I=j/l,q=a*(1-I),F=f*Math.sin(I*Math.PI/2);for(Y=0,Z=H.length;Y<Z;Y++)R=B(H[Y],G[Y],F),pt(R.x,R.y,s+q);for(C=0,k=_.length;C<k;C++){N=_[C],ot=st[C];for(Y=0,Z=N.length;Y<Z;Y++)R=B(N[Y],ot[Y],F),m?pt(R.x,R.y+v[p-1].y,v[p-1].x+q):pt(R.x,R.y,s+q)}}ft(),lt()},n.ShapeNode.WorldUVGenerator={generateTopUV:function(e,t,r,i,s,o){var u=e.vertices[i].x,a=e.vertices[i].y,f=e.vertices[s].x,l=e.vertices[s].y,c=e.vertices[o].x,h=e.vertices[o].y;return[new n.Vec2(u/this.repeat,a/this.repeat),new n.Vec2(f/this.repeat,l/this.repeat),new n.Vec2(c/this.repeat,h/this.repeat)]},generateBottomUV:function(e,t,n,r,i,s){return this.generateTopUV(e,t,n,r,i,s)},uv:function(e,t,n){return new o(Math.sqrt(e*e+t*t)/this.repeat,(1-n)/this.repeat)},generateSideWallUV:function(e,t,r,i,s,o,u,a,f,l,c,h){var p=e.vertices[s].x,d=e.vertices[s].y,v=e.vertices[s].z,m=e.vertices[o].x,g=e.vertices[o].y,y=e.vertices[o].z,b=e.vertices[u].x,w=e.vertices[u].y,E=e.vertices[u].z,S=e.vertices[a].x,x=e.vertices[a].y,T=e.vertices[a].z,N=Math.abs(d-g),C=Math.abs(p-m);return N<C?[new n.Vec2(p/this.repeat,(this.amount-v)/this.repeat),new n.Vec2(m/this.repeat,(this.amount-y)/this.repeat),new n.Vec2(b/this.repeat,(this.amount-E)/this.repeat),new n.Vec2(S/this.repeat,(this.amount-T)/this.repeat)]:[new n.Vec2(d/this.repeat,(this.amount-v)/this.repeat),new n.Vec2(g/this.repeat,(this.amount-y)/this.repeat),new n.Vec2(w/this.repeat,(this.amount-E)/this.repeat),new n.Vec2(x/this.repeat,(this.amount-T)/this.repeat)]}},n.ShapeNode.__v1=new n.Vec2,n.ShapeNode.__v2=new n.Vec2,n.ShapeNode.__v3=new n.Vec2,n.ShapeNode.__v4=new n.Vec2,n.ShapeNode.__v5=new n.Vec2,n.ShapeNode.__v6=new n.Vec2,n.TextNode=function(e,r,i,s,o,u,a){var f;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])?(f=arguments[0],e=f.text,this.font=f.font||"helvetiker",this.size=f.size||150,this.weight=f.weight||"normal",this.fontStyle=f.fontStyle||"normal",this.height=f.height||50,this._id=f.id,this.curveSegments=f.curveSegments):(this.font=s||"helvetiker",this.size=r||150,this.weight=o||"normal",this.fontStyle=u||"normal",this.height=i||50,this.curveSegments=a);var l={size:this.size,height:this.height,font:this.font,weight:this.weight,style:this.fontStyle,curveSegments:this.curveSegments||30,bevelEnabled:!1,zMinusHalfAmount:!0};this.text=e;var c=n.FontUtils.generateShapes(e,l);l.amount=l.height!==t?l.height:50,l.bevelThickness===t&&(l.bevelThickness=10),l.bevelSize===t&&(l.bevelSize=8),l.bevelEnabled===t&&(l.bevelEnabled=!1),n.ShapeNode.call(this,c,l.curveSegments,this.height,!1,50,!0)},n.extend(n.TextNode,n.ShapeNode,{constructor:n.TextNode,className:"TGL.TextNode",__accessor:["text","size","height","font","weight","fontStyle"],__SizePropeties:["text","size","height","font","weight","fontStyle"],computeData:function(){var e={size:this.size,height:this.height,font:this.font,weight:this.weight,style:this.fontStyle,curveSegments:this.curveSegments||30,bevelEnabled:!1,zMinusHalfAmount:!0},t={curveSegments:this.curveSegments,amount:this.height,vertical:!1,zMinusHalfAmount:!0,repeat:20},r=n.FontUtils.generateShapes(this.text,e);return n.ShapeNode.prototype.addShapes.call(this,r,t)}}),n.LatheNode=function(e,r,i,s,o,u){this.materialSize=3;var a;arguments.length===1&&arguments[0]instanceof Object&&!(arguments[0]instanceof n.Path)?(a=arguments[0],this.path=a.path,this.segmentsH=a.segmentsH||64,this.segmentsR=a.segmentsR||20,this.arc=a.arc!=t?a.arc:Math.PI*2,this.startClosed=a.startClosed,this.endClosed=a.endClosed,this._id=a.id):(this.path=e,this.segmentsH=r||64,this.segmentsR=i||20,this.arc=s!=t?s:Math.PI*2,this.startClosed=o,this.endClosed=u),n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.LatheNode,n.Entity,{constructor:n.LatheNode,className:"TGL.LatheNode",__accessor:["path","segmentsH","segmentsR","arc","startClosed","endClosed"],__SizePropeties:["path","segmentsH","segmentsR","arc","startClosed","endClosed"],computeData:function(){function v(e){var t=e.x,r=e.z,i=((r===0?t/Math.abs(t):t/Math.abs(r))+1)/2;i=n.Math.clamp(i,0,1);var s=((t===0?r/Math.abs(r):r/Math.abs(t))+1)/2;return s=n.Math.clamp(s,0,1),new n.Vec2(i,s)}var e={},e={};e.faces=[],e.uvs=[],e.vertices=[];if(this.path==null)return e;var t=[],r=this.path,i=this.segmentsH,s=this.segmentsR,o,u,f,l,h,p,d;n.Shape.Utils.isClockWise(r.getPoints())||(r=r.reverse());for(u=0;u<=i;u++){o=r.getPoint(u/i),t[u]=[],l=Math.abs(o.x),h=o.y,this.startClosed&&u===0&&e.vertices.push(new n.Vec3(0,h,0));for(f=0;f<s;f++)d=f/s*this.arc,p=new n.Vec3(l*Math.cos(d),h,l*Math.sin(d)),t[u][f]=e.vertices.push(p)-1;this.endClosed&&u===i&&e.vertices.push(new n.Vec3(0,h,0))}var m=this.arc==Math.PI*2;if(this.startClosed){a=0;for(f=0;f<(m?s:s-1);f++)jp=(f+1)%s,b=t[0][f],c=t[0][jp],uva=new n.Vec2(.5,.5),uvb=v(e.vertices[b]),uvc=v(e.vertices[c]),e.faces.push(new n.Face3(a,b,c)),e.uvs
.push([uva,uvb,uvc])}for(u=0;u<i;u++)for(f=0;f<(m?s:s-1);f++)ip=u+1,jp=(f+1)%s,a=t[u][f],b=t[ip][f],c=t[ip][jp],Wr=t[u][jp],uva=new n.Vec2(u/i,f/s),uvb=new n.Vec2((u+1)/i,f/s),uvc=new n.Vec2((u+1)/i,(f+1)/s),uvd=new n.Vec2(u/i,(f+1)/s),e.faces.push(new n.Face3(a,b,Wr)),e.uvs.push([uva,uvb,uvd]),e.faces.push(new n.Face3(b,c,Wr)),e.uvs.push([uvb.clone(),uvc,uvd.clone()]);if(this.endClosed){a=e.vertices.length-1;for(f=0;f<(m?s:s-1);f++)jp=(f+1)%s,b=t[t.length-1][f],c=t[t.length-1][jp],uva=new n.Vec2(0,0),uvb=new n.Vec2(1,f/s),uvc=new n.Vec2(1,(f+1)/s),e.faces.push(new n.Face3(a,b,c)),e.uvs.push([uva,uvb,uvc])}return e}}),n.CurvePlane=function(e,t,r,i){this.pathH=e,this.pathV=t,this.segmentsH=r||20,this.segmentsV=i||20,n.Entity.call(this)},n.extend(n.CurvePlane,n.Entity,{constructor:n.CurvePlane,className:"TGL.CurvePlane",computeData:function(){var e={};e.faces=[],e.uvs=[],e.vertices=[];if(this.pathV==null||this.pathH==null)return e;var t=this.pathV,n=this.pathH,r=this.segmentsV,i=this.segmentsH,s,u,a=r+1,l=i+1,c,h,p,d,v,m,g,y;this.grid=[];for(s=0;s<l;s++){this.grid[s]=[];var b=n.getPointAt(s/l);for(u=0;u<a;u++){var w=t.getPointAt(u/a);this.grid[s][u]=e.vertices.push(new f(b.x,w.y,b.z+w.z))-1}}for(s=0;s<i;s++)for(u=0;u<r;u++)c=this.grid[s][u],h=this.grid[s][u+1],p=this.grid[s+1][u+1],d=this.grid[s+1][u],v=new o(s/l,u/a),m=new o(s/l,(u+1)/a),uvc=new o((s+1)/l,(u+1)/a),y=new o((s+1)/l,u/a),e.faces.push(new O(c,p,h)),e.uvs.push([v,uvc,m]),e.faces.push(new O(c,d,p)),e.uvs.push([v.clone(),y.clone(),uvc]);return e}}),n.ComboNode=function(e,t,r,i,s){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var o=e;this.combos=o.combos||[],this.operators=o.operators,this.centralized=r,this.names=s,this._id=o.id}else this.combos=e||[],this.operators=t,this.centralized=r,this._id=i,this.names=s;this.csgs=[],n.Entity.call(this)},n.extend(n.ComboNode,n.Entity,{constructor:n.ComboNode,className:"TGL.ComboNode",__accessor:["combos","operators","centralized","names"],__SizePropeties:["combos","operators","centralized"],getOffsetPosition:function(){return this._offsetPosition},getSideIndexMapping:function(){var e=this.combos,t=this.names||[],n,r,i,s,o={},u=0;if(e&&e.length)for(i=0;i<e.length;i++){n=e[i],r=t[i],r||(s=n.getClassName(),s&&s.indexOf(".")>0&&(s=s.substr(s.lastIndexOf(".")+1)),r=s+""+i,r=r.toLowerCase());var a=n.getSideIndexMapping();if(a)for(var f in a)o[r+"-"+f]=u++;else o[r]=u++}return o},computeData:function(){this.csgs=[];var e={vertices:[],faces:[],uvs:[],uv2s:[]};if(!this.combos)return e;if(this.operators==null||this.operators.length==0){var r=H.mergeElements(this.combos);this.materialSize=r.material.materials.length,this.material=r.material,this.orgMaterial=r.material,e={vertices:r.vertices,faces:r.faces,uvs:r.uvs,uv2s:r.uv2s||[]};if(this.centralized&&e.vertices){var i=new n.BoundingBox;i.setFromPoints(e.vertices);var s=i.center();for(u=0;u<e.vertices.length;u++){var o=e.vertices[u];o.sub(s)}this._offsetPosition=s}return e}this.operators=this.operators||[];var u,a,f=this.combos.length,l,c;for(u=0;u<f;u++)this.csgs.push(new n.CSG(this.combos[u]));for(u=0;u<f;u++)a==null?a=this.csgs[u]:(l=this.operators[u-1],l==="+"||l==t?a=a.union(this.csgs[u]):l==="-"?a=a.substract(this.csgs[u]):l==="^"&&(a=a.intersect(this.csgs[u])));if(!a)return e;c=a.toMesh();if(this.changeProperty!="centralized"||this.material==null)this.materialSize=c.material.materials.length,this.material=c.material,this.orgMaterial=c.material;e={vertices:c.vertices,faces:c.faces,uvs:c.uvs,uv2s:c.uv2s};if(this.centralized&&e.vertices){var i=new n.BoundingBox;i.setFromPoints(e.vertices);var s=i.center();for(u=0;u<e.vertices.length;u++){var o=e.vertices[u];o.sub(s)}this._offsetPosition=s}return c=t,e},refreshStyleMap:function(){var e=this.combos,t=this.styleMap,n=0;for(var r=0;r<e.length;r++){var i=e[r],o=i.getMaterailSize();for(s in i.styleMap){var u=t[s]||(t[s]=[]),a=i.styleMap[s];for(var f=0;f<o;f++)u[n+f]=H.isArray(a)?a[f]:a}n+=o}},computeNodeMaterial:function(e){this.material=e.material,this.materialSize=e.materialSize},cacheNodeMaterial:function(e){e.material=this.material,e.materialSize=this.materialSize},needComputeVertexNormal:function(){return!0},generatePrimitiveKey:function(){return null},changeMapping:function(e){var t=this.getMaterialMapping();n.Utils.isSame(e,t)||(this.batch?this.materialMappingChanges=[e,t]:(this.onMaterialMapping(),this.firePropertyChange("materialMapping",e,t)))},isStyleEquals:function(e,t,n){return!1},getSelectStyle:function(){var e=this.getStyle("select.style");if(e=="outline.normal"||e=="outline")e="outline.wireframe";return e},onMaterialMapping:function(){this.groups=t,this.primitive.groups=t}}),n.Terrain=function(e){e=e||{},this._id=e.id,this.width=e.width,this.depth=e.depth,this.segmentsW=e.segmentsW||30,this.segmentsD=e.segmentsD||30,this.heightMap=e.heightMap,this.heightUnit=e.heightUnit||1,this.maxHeight=e.maxHeight||255,this.minHeight=e.minHeight||0,this.baseLayerHeight=e.baseLayerHeight||0,typeof this.heightMap=="string"?(this.image=new Image,this.image.src=this.heightMap):p.isCanvas(this.heightMap)?this.canvas=this.heightMap:p.isImage(this.heightMap)&&(this.image=this.heightMap);if(this.image){var t=this;this.image.onload=function(e){var n=document.createElement("canvas");n.width=t.image.width,n.height=t.image.height;var r=n.getContext("2d");r.drawImage(t.image,0,0),t.canvas=n,t.computed=!1,t.computeNodeData(),t.firePropertyChange("width",0,1)}}this.materialSize=2,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.Terrain,n.Entity,{constructor:n.Terrain,className:"TGL.Terrain",__accessor:["width","depth","segmentsW","segmentsD","heightMap","heightUnit","maxHeight","minHeight","baseLayerHeight","smooth"],__SizePropeties:["width","depth","segmentsW","segmentsD","heightMap","heightUnit","maxHeight","minHeight","baseLayerHeight","smooth"],__bool:["smooth"],computeLayerData:function(e,t,r){var i,s,o=this.width/2,u=this.depth/2,a=r?this.segmentsW:1,f=r?this.segmentsD:1,l=a+1,c=f+1,h=this.width/a,p=this.depth/f,d=new n.Vec3(0,0,1),v=e.vertices.length;for(s=0;s<c;s++)for(i=0;i<l;i++){var m=i*h-o,g=s*p-u,y=0;r?y=r.call(this,i/l,s/c):y=this.baseLayerHeight*this.heightUnit,e.vertices.push(new n.Vec3(m,y,g))}for(s=0;s<f;s++)for(i=0;i<a;i++){var b=i+l*s+v,w=i+l*(s+1)+v,E=i+1+l*(s+1)+v,S=i+1+l*s+v,x=new n.Vec2(i/a,1-s/f),T=new n.Vec2(i/a,1-(s+1)/f),N=new n.Vec2((i+1)/a,1-(s+1)/f),C=new n.Vec2((i+1)/a,1-s/f);if(r){var k=new n.Face3(b,w,S);k.materialIndex=t,e.faces.push(k),e.uvs.push([x,T,C]),k=new n.Face3(w,E,S),k.materialIndex=t,e.faces.push(k),e.uvs.push([T.clone(),N,C.clone()])}else{var k=new n.Face4(b,w,E,S);k.normal.copy(d),k.vertexNormals.push(d.clone(),d.clone(),d.clone(),d.clone()),k.materialIndex=t,e.faces.push(k),e.uvs.push([x,T,N,C])}}},computeData:function(){var e={};return e.vertices=[],e.faces=[],e.uvs=[],this.computeLayerData(e,0),this.computeLayerData(e,1,this.getHeight),e},getFaceNormal:function(e,t){this.computeFaceNormals();var n=this.segmentsW*e,r=this.segmentsD*t,i=Math.floor(n),s=Math.floor(r),o=s*this.segmentsW+i;o=o*2+1,i!=Math.round(n)&&s!=Math.round(r)&&o++;var u=this.faces[o],a=this.vertices[u.a],f=this.vertices[u.b],l=this.vertices[u.c];return u.normal.clone()},setHeightMap:function(e){this.heightMap=e,typeof this.heightMap=="string"?(this.image=new Image,this.image.src=this.heightMap):p.isCanvas(this.heightMap)?this.canvas=this.heightMap:p.isImage(this.heightMap)&&(this.image=this.heightMap);if(this.image){var t=this;if(this.image.width){var n=document.createElement("canvas");n.width=t.image.width,n.height=t.image.height;var r=n.getContext("2d");r.drawImage(t.image,0,0),t.canvas=n,t.computed=!1,t.computeNodeData(),t.firePropertyChange("width",0,1)}else this.image.onload=function(e){var n=document.createElement("canvas");n.width=t.image.width,n.height=t.image.height;var r=n.getContext("2d");r.drawImage(t.image,0,0),t.canvas=n,t.computed=!1,t.computeNodeData(),t.firePropertyChange("width",0,1)}}},getHeight:function(e,t){if(this.canvas==null)return 0;var r=this.canvas;if(this.heightData==null){var i=r.width*r.height,s=new Float32Array(i);for(var o=0;o<i;o++)s[o]=0;var u=r.getContext("2d"),a=u.getImageData(0,0,r.width,r.height),f=a.data,l=0;for(var o=0,c=f.length;o<c;o+=4){var h=f[o]+f[o+1]+f[o+2];s[l++]=h/3}this.heightData=s}var p=e*r.width,d=t*r.height,v=Math.floor(p),m=Math.floor(d),g=[],y=[];g.push(v),p!=v&&g.push(v+1),y.push(m),d!=m&&y.push(m+1);var b=g.length*y.length,o,l,w=0,E;for(o=0;o<g.length;o++)for(l=0;l<y.length;l++)E=y[l]*r.width+g[o],w+=this.heightData[E];return w/=b,w=n.Math.clamp(w,this.minHeight,this.maxHeight),w*=this.heightUnit,w},getSideIndexMapping:function(){return n.Terrain.SideIndexMapping},refreshUniforms:function(e){e.heightUnit&&(e.heightUnit.value=this.heightUnit)}}),n.Terrain.SideIndexMapping={layer0:0,layer1:1},n.Link=function(e,t,r){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var i=arguments[0];e=i.fromNode,t=i.toNode,this._id=i.id}else this._id=r;n.Line.call(this),this.setFromNode(e),this.setToNode(t),this._editable=!1},n.extend(n.Link,n.Line,{className:"TGL.Link",___accessor:["linkType","extend","controls"],__SizePropeties:["fromNode","toNode","linkType","extend","controls"],setFromNode:function(e){if(this._fromNode!=e){var t=this._fromNode;this._fromNode=e,this.onPropertyChange(),this.firePropertyChange("fromNode",t,e),t,this._fromNode=e,t&&(t._removeFromLink(this),t.removePropertyChangeListener(this.handleNodePropertyChange)),this._fromNode&&(this._fromNode._addFromLink(this),this._fromNode.addPropertyChangeListener(this.handleNodePropertyChange,this))}},getFromNode:function(){return this._fromNode},setToNode:function(e){if(this._toNode!=e){var t=this._toNode;this._toNode=e,this.onPropertyChange(),this.firePropertyChange("toNode",t,e),t&&(t.removePropertyChangeListener(this.handleNodePropertyChange),t._removeToLink(this)),this._toNode&&(this._toNode._addToLink(this),this._toNode.addPropertyChangeListener(this.handleNodePropertyChange,this))}},getToNode:function(){return this._toNode},isLooped:function(){return this._fromNode===this._toNode&&this._fromNode!=null&&this._toNode!=null},handleNodePropertyChange:function(e){if(e.property.startsWith("position")||e.property=="worldMatrix"){var t=this.vertices;this.onPropertyChange(),this.firePropertyChange("vertices",t,this.vertices)}},computeNodeData:function(){this.computeData()},updateMatrix:function(){},updateWorldMatrix:function(){},computeData:function(){if(this._fromNode==null||this._toNode==null)return;this._extend==null&&(this._extend=0);var e=this._fromNode.worldMatrix.getPosition(),t=this._toNode.worldMatrix.getPosition(),n=[];n.push(e.clone());if(this._linkType=="orthogonal.x"){var r=Math.max(e.x,t.x),i=new f(r+this._extend,e.y,e.z);n.push(i),i=new f(r+this._extend,t.y,t.z),n.push(i)}else if(this._linkType=="orthogonal.x.n"){var s=Math.min(e.x,t.x),i=new f(s-this._extend,e.y,e.z);n.push(i),i=new f(s-this._extend,t.y,t.z),n.push(i)}else if(this._linkType=="orthogonal.y"){var o=Math.max(e.y,t.y),i=new f(e.x,o+this._extend,e.z);n.push(i),i=new f(t.x,o+this._extend,t.z),n.push(i)}else if(this._linkType=="orthogonal.y.n"){var u=Math.min(e.y,t.y),i=new f(e.x,u-this._extend,e.z);n.push(i),i=new f(t.x,u-this._extend,t.z),n.push(i)}else if(this._linkType=="orthogonal.z"){var a=Math.max(e.z,t.z),i=new f(e.x,e.y,a+this._extend);n.push(i),i=new f(t.x,t.y,a+this._extend),n.push(i)}else if(this._linkType=="orthogonal.z.n"){var l=Math.min(e.z,t.z),i=new f(e.x,e.y,l-this._extend);n.push(i),i=new f(t.x,t.y,l-this._extend),n.push(i)}else if(this._linkType=="control"){var c=this._controls;if(c&&c.length>0)for(var h=0;h<c.length;h++)c[h]instanceof f&&n.push(c[h].clone())}n.push(t.clone()),this.vertices=n},onPropertyChange:function(){this.vertices=this.vertices||[],this.computeData(),this.computeBoundingBox(),this.selectionData=null,this.boundingSphere=null}}),n.PathLink=function(e,t,r){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var i=arguments[0];e=i.fromNode,t=i.toNode,this._id=i.id}else this._id=r;n.PathNode.call(this),this._autoAjust=!0,this.setFromNode(e),this.setToNode(t)},n.PathLink.allLinkTypes=["extend.x","extend.y","extend.z","extend.x.n","extend.y.n","extend.z.n","orthogonal.x","orthogonal.y","orthogonal.z","orthogonal.x.n","orthogonal.y.n","orthogonal.z.n","flex.x","flex.y","flex.z","flex.yz","flex.xz","flex.xy"],n.extend(n.PathLink,n.PathNode,{className:"TGL.PathLink",___accessor:["linkType","extend","controls","fromOffset","toOffset"],__SizePropeties:["fromOffset","toOffset","path","segments","radius","segmentsR","startCap","endCap","shape","startCapSize","endCapSize","segmentsCap","arc","arcStart","cutSurface","startCapR","endCapR","startCapExtend","endCapExtend","fromNode","toNode","linkType","extend","controls"],setFromNode:function(e){if(this._fromNode!=e){var t=this._fromNode;this._fromNode=e,this._dirtyPath=!0,this.onPropertyChange("fromNode",t,e),this.firePropertyChange("fromNode",t,e),t,this._fromNode=e,t&&(t._removeFromLink(this),t.removePropertyChangeListener(this.handleNodePropertyChange)),this._fromNode&&(this._fromNode._addFromLink(this),this._fromNode.addPropertyChangeListener(this.handleNodePropertyChange,this))}},getFromNode:function(){return this._fromNode},setToNode:function(e){if(this._toNode!=e){var t=this._toNode;this._toNode=e,this.onPropertyChange("toNode",t,e),this.firePropertyChange("toNode",t,e),t&&(t.removePropertyChangeListener(this.handleNodePropertyChange),t._removeToLink(this)),this._toNode&&(this._toNode._addToLink(this),this._toNode.addPropertyChangeListener(this.handleNodePropertyChange,this))}},getToNode:function(){return this._toNode},isLooped:function(){return this._fromNode===this._toNode&&this._fromNode!=null&&this._toNode!=null},handleNodePropertyChange:function(e){var t=e.source,n=e.property;if(n.startsWith("position")||n.startsWith("rotation")||n.startsWith("scale")||n=="worldMatrix"||n==="linkAgent"||t.isSizeChangedProperty(n)||n==="parent"){var r=this.vertices;this._dirtyPath=!0;var i=this;P.PATH_LINK_COMPUTE_DELAY?setTimeout(function(){i._computePath()},10):i._computePath()}},_resetPath:function(){if(!this.path)return;var e=!1;if(this.endCap!=="arrow")return this.path;if(this.endCapExtend*this.endCapR>1)return this.path;e=!0;var t=this.path,r=new n.Path,i,s,o=t.actions.length,u=null,a;for(s=0;s<o-1;s++)i=t.actions[s],a=i.args,u=new n.Vec3(a[0],a[1],a[2]),i.action==="moveTo"?r.moveTo(a[0],a[1],a[2]):i.action==="lineTo"?r.lineTo(a[0],a[1],a[2]):i.action==="quadraticCurveTo"&&(r.curveTo(a[0],a[1],a[2],a[3],a[4],a[5]),u=new n.Vec3(a[3],a[4],a[5]));s=o-1,i=t.actions[s],a=i.args;if(i.action==="lineTo"){var l=new n.Vec3(a[0],a[1],a[2]),c=(new f).subVectors(l,u).normalize(),o=this.radius*this.endCapSize,h=null;(new f).subVectors(l,u).length()<o?h=u.add(c.multiplyScalar(.1)):h=l.clone().sub(c.multiplyScalar(o)),r.lineTo(h.x,h.y,h.z)}return r},_getNodeOffset:function(e,t,n){t=e.worldToLocal(t.clone()),n=e.worldToLocal(n.clone());var r=(new f).subVectors(n,t),i=r.length(),s=e.getLinkOffset(r);return s&&s.length()>i&&s.normalize().multiplyScalar(i-.1),s||new f(0,0,0)},updateMatrix:function(){},updateWorldMatrix:function(e,t){},onPropertyChange:function(e,t,r){if(e==="fromNode"||e==="toNode"||e==="linkType"||e==="extend"||e==="controls"||e==="fromOffset"||e==="toOffset")this._dirtyPath=!0;n.Node.prototype.onPropertyChange.call(this,e,t,r)},computeData:function(){return this._computePath(),n.PathNode.prototype.computeData.call(this)},_clearFromNodeExtend:function(e,t,n){},_flex:function(e,t,n,r,i){e=e.substr(e.indexOf(".")+1);var s=["x","y","z"],o,u=new f,a=new f;for(var l=0;l<3;l++)o=s[l],u[o]=o===e?r[o]:t[o],a[o]=o===e?r[o]:n[o];i.push(u,a)},_flex2:function(e,t,n,r){e=e.substr(e.indexOf(".")+1);var i=["x","y","z"],s=e[0],o=e[1];if(t[s]!=n[s]){var u=new mono.Vec3;for(var a=0;a<i.length;a++)u[i[a]]=i[a]==s?n[i[a]]:t[i[a]];r.push(u)}if(t[o]!=n[o]){var f=new mono.Vec3;for(var a=0;a<i.length;a++)f[i[a]]=i[a]==s||i[a]==o?n[i[a]]:t[i[a]];r.push(f)}},_orthogonal:function(e,t,n,r){e=e.substr(e.indexOf(".")+1);var i=!1,s=["x","y","z"],o,u=new f,a=0;e.endsWith(".n")&&(i=!0,e=e[0]);var l=i?t[e]:n[e];for(var c=0;c<s.length;c++)o=s[c],o!==e&&t[o]==n[o]&&a++;if(a===2)return;for(var c=0;c<s.length;c++)o=s[c],o!==e?u[o]=l:u[o]=i?n[o]:t[o];r.push(u)},_removeSamePoint:function(e){},computeLoopPath:function(e){var t=new mono.Path;return t.moveTo(e.x,e.y,e.z),t.lineTo(e.x,e.y+200,e.z),t.lineTo(e.x+200,e.y+200,e.z),t.lineTo(e.x+200,e.y,e.z),t.lineTo(e.x,e.y,e.z),this.setPath(t),t},_computePath:function(){if(!this._dirtyPath)return;this._dirtyPath=!1;if(this._fromNode==null||this._toNode==null)return;this._extend==null&&(this._extend=0);var e=this._fromNode.getLinkAgent()||this._fromNode,t=this._toNode.getLinkAgent()||this._toNode,r=e.localToWorld2(new f(0,0,0)),i=t.localToWorld2(new f(0,0,0));if(e==t)return this.computeLoopPath(r,i);if(r.equals(i)){this.setPath(null);return}var s,o=[],u=this.radius*this.endCapSize,a;if(this._linkType&&this._linkType.startsWith("extend")){var r,i,l,c=[],h,p,d,v;if(this._linkType==="extend.x"){l=new f(1,0,0);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.max(r.x,i.x),d=v+this._extend+u+.1,h=new f(d,r.y,r.z),p=new f(d,i.y,i.z)}else if(this._linkType==="extend.y"){l=new f(0,1,0);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.max(r.y,i.y),d=v+this._extend+u+.1,h=new f(r.x,d,r.z),p=new f(i.x,d,i.z)}else if(this._linkType==="extend.z"){l=new f(0,0,1);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.max(r.z,i.z),d=v+this._extend+u+.1,h=new f(r.x,r.y,d),p=new f(i.x,i.y,d)}else if(this._linkType==="extend.x.n"){l=new f(-1,0,0);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.min(r.x,i.x),d=v-this._extend-u-.1,h=new f(d,r.y,r.z),p=new f(d,i.y,i.z)}else if(this._linkType==="extend.y.n"){l=new f(0,-1,0);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.min(r.y,i.y),d=v-this._extend-u-.1,h=new f(r.x,d,r.z),p=new f(i.x,d,i.z)}else if(this._linkType==="extend.z.n"){l=new f(0,0,-1);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.min(r.z,i.z),d=v-this._extend-u-.1,h=new f(r.x,r.y,d),p=new f(i.x,i.y,d)}h?o.push(r,h,p,i):o.push(r,i)}else{o.push(r);if(this._linkType==="orthogonal.x"){if(r.y!=i.y||r.z!=i.z){var m=i.x,g=new f(m,r.y,r.z);o.push(g)}}else if(this._linkType==="orthogonal.x.n"){var m=r.x,g=new f(m,i.y,i.z);o.push(g)}else if(this._linkType==="orthogonal.y"){var y=i.y,g=new f(r.x,y,r.z);o.push(g)}else if(this._linkType==="orthogonal.y.n"){var y=r.y,g=new f(i.x,y,i.z);o.push(g)}else if(this._linkType==="orthogonal.z"){var g=new f(r.x,r.y,i.z);o.push(g)}else if(this._linkType==="orthogonal.z.n"){var g=new f(i.x,i.y,r.z);o.push(g)}var b=(new f(r.x+i.x,r.y+i.y,r.z+i.z)).multiplyScalar(.5);(this._linkType==="flex.x"||this._linkType==="flex.y"||this._linkType==="flex.z")&&this._flex(this._linkType,r,i,b,o),(this._linkType==="flex.yz"||this._linkType==="flex.zy"||this._linkType==="flex.xy"||this._linkType==="flex.yx"||this._linkType==="flex.xz"||this._linkType==="flex.zx")&&this._flex2(this._linkType,r,i,o);if(this._linkType==="control"){var w=this.getControls();H.isArray(w)&&(o=o.concat(w))}o.push(i),a=o.length;var E=this._getNodeOffset(e,o[0].clone(),o[1].clone()),S=this._getNodeOffset(t,o[a-1].clone(),o[a-2].clone());r=e.localToWorld2(E),i=t.localToWorld2(S),o[0]=r,o[a-1]=i}var a=o.length,x=this.getFromOffset(),T=this.getToOffset();x&&o[0].add(x),T&&o[a-1].add(T);var s=new n.Path,N;for(var C=0;C<a;C++)N=o[C],C===0?s.moveTo(N.x,N.y,N.z):s.lineTo(N.x,N.y,N.z);return this.setPath(s),s}}),mono.LoadingManager=function(e,n,r){var i=this,s=0,o=0;this.onLoad=e,this.onProgress=n,this.onError=r,this.itemStart=function(e){o++},this.itemEnd=function(e){s++,i.onProgress!==t&&i.onProgress(e,s,o),s===o&&i.onLoad!==t&&i.onLoad()}},mono.DefaultLoadingManager=new mono.LoadingManager,mono.ImageLoader=function(e){this.manager=e!==t?e:mono.DefaultLoadingManager},mono.ImageLoader.prototype={constructor:mono.ImageLoader,load:function(e,n,r,i){var s=this,o=document.createElement("img");return n!==t&&o.addEventListener("load",function(t){s.manager.itemEnd(e),n(this)},!1),r!==t&&o.addEventListener("progress",function(e){r(e)},!1),i!==t&&o.addEventListener("error",function(e){i(e)},!1),this.crossOrigin!==t&&(o.crossOrigin=this.crossOrigin),o.src=e,s.manager.itemStart(e),o},loadFile:function(e,n,r,i){var s=this,o=new FileReader;n!==t&&(o.onload=function(){n(o.result),s.manager.itemEnd(e.name)}),r!==t&&o.addEventListener("progress",function(e){r(e)},!1),i!==t&&o.addEventListener("error",function(e){i(e)},!1),o.readAsDataURL(e),s.manager.itemStart(e.name)},setCrossOrigin:function(e){this.crossOrigin=e}},mono.XHRLoader=function(e){this.manager=e!==t?e:mono.DefaultLoadingManager},mono.XHRLoader.prototype={constructor:mono.XHRLoader,load:function(e,n,r,i){var s=this,o=new XMLHttpRequest;n!==t&&o.addEventListener("load",function(t){n(t.target.responseText),s.manager.itemEnd(e)},!1),r!==t&&o.addEventListener("progress",function(e){r(e)},!1),i!==t&&o.addEventListener("error",function(e){i(e)},!1),this.crossOrigin!==t&&(o.crossOrigin=this.crossOrigin),o.open("GET",e,!0),o.send(null),s.manager.itemStart(e)},loadFile:function(e,n,r,i){if(!e)return;var s=this,o=new FileReader;n!==t&&(o.onload=function(){n(o.result),s.manager.itemEnd(e.name)}),r!==t&&o.addEventListener("progress",function(e){r(e)},!1),i!==t&&o.addEventListener("error",function(e){i(e)},!1),o.readAsText(e),s.manager.itemStart(e.name)},setCrossOrigin:function(e){this.crossOrigin=e}},mono.MTLLoader=function(e,t,n){this.baseUrl=e,this.options=t,this.crossOrigin=n},mono.extend(mono.MTLLoader,null,{constructor:mono.MTLLoader,load:function(e,t,n,r){var i=this,s=new mono.XHRLoader;s.setCrossOrigin(this.crossOrigin),s.load(e,function(e){t(i.parse(e))})},loadFile:function(e,t,n,r){var i=this,s=new mono.XHRLoader;s.loadFile(e,function(e){t(i.parse(e))})},loadText:function(e,t){t(this.parse(e))},parse:function(e){var t=e.split("\n"),n={},r=/\s+/,i={};this.baseUrl||(this.baseUrl={});for(var s=0;s<t.length;s++){var o=t[s];o=o.trim();if(o.length===0||o.charAt(0)==="#")continue;var u=o.indexOf(" "),a=u>=0?o.substring(0,u):o;a=a.toLowerCase();var f=u>=0?o.substring(u+1):"";f=f.trim();if(a==="newmtl")n={name:f},i[f]=n;else if(n)if(a==="ka"||a==="kd"||a==="ks"){var l=f.split(r,3);n[a]=[parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2])]}else if(a==="map_kd"||a==="map_ka"){var c=f,h=f;if(f.indexOf(".")>0){f=f.substring(0,f.lastIndexOf(".")).toLowerCase();var p={};if(/\-s/.test(f)){var d=/\-s( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/;p=d.exec(f);var v=f.split(p[0]);f=v[v.length-1].trim();var m=c.split(p[0]);h=m[m.length-1].trim()}if(/\-t/.test(f)){var d=/\-t( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/;p=d.exec(f);var v=f.split(p[0]);f=v[v.length-1].trim();var m=c.split(p[0]);h=m[m.length-1].trim()}}this.baseUrl[f]||(this.baseUrl[f]=h),n[a]=c}else n[a]=f}var g=new mono.MTLLoader.MaterialCreator(this.baseUrl,this.options);return g.setMaterials(i),g}}),mono.MTLLoader.MaterialCreator=function(e,t){this.baseUrl=e,this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:mono.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:mono.RepeatWrapping},mono.extend(mono.MTLLoader.MaterialCreator,mono.EventDispatcher,{constructor:mono.MTLLoader.MaterialCreator,setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var n in e){var r=e[n],i={};t[n]=i;for(var s in r){var o=!0,u=r[s],a=s.toLowerCase();switch(a){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(u=[u[0]/255,u[1]/255,u[2]/255]),this.options&&this.options.ignoreZeroRGBs&&u[0]===0&&u[1]===0&&u[1]===0&&(o=!1);break;case"d":this.options&&this.options.invertTransparency&&(u=1-u);break;default:}o&&(i[a]=u)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return this.materials[e]===t&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){var t=this,n=this.materialsInfo[e],r={name:e,side:this.side};for(var i in n){var s=n[i];switch(i.toLowerCase()){case"kd":r.diffuse=(new mono.Color).setRGB(s[0],s[1],s[2]);break;case"ka":r.ambient=(new mono.Color).setRGB(s[0],s[1],s[2]);break;case"ks":r.specular=(new mono.Color).setRGB(s[0],s[1],s[2]);break;case"map_kd":if(typeof this.baseUrl=="string")r.map={},r.map.img=this.baseUrl+s,r.map.wrapS=this.wrap,r.map.wrapT=this.wrap;else if(typeof this.baseUrl=="object"&&s.indexOf(".")>0){s=s.substring(0,s.lastIndexOf(".")).toLowerCase();var o={};if(/\-s/.test(s)){var u=/\-s( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/;o=u.exec(s);var a=s.split(o[0]);s=a[a.length-1].trim(),o.repeatR=parseInt(o[1]),o.repeatC=parseInt(o[2])}if(/\-t/.test(s)){var u=/\-t( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/;o=u.exec(s);var a=s.split(o[0]);s=a[a.length-1].trim(),o.repeatR=parseInt(o[1]),o.repeatC=parseInt(o[2])}this.baseUrl[s]&&(r.map={},r.map.img=this.baseUrl[s],r.map.wrapS=t.wrap,r.map.wrapT=t.wrap,r.map.repeatR=o.repeatR||1,r.map.repeatC=o.repeatC||1)}break;case"ns":r.shininess=s;break;case"d":s<1&&(r.transparent=!0,r.opacity=s);break;default:}}return r.diffuse&&(r.ambient||(r.ambient=r.diffuse),r.color=r.diffuse),this.materials[e]=r,this.materials[e]},loadTexture:function(e,t,n,r){var i=/\.dds$/i.test(e);if(i)var s=mono.ImageUtils.loadCompressedTexture(e,t,n,r);else{var o=new Image,s=new mono.Texture(o,t),u=new mono.ImageLoader;u.crossOrigin=this.crossOrigin,u.load(e,function(e){s.image=mono.MTLLoader.ensurePowerOfTwo_(e),s.needsUpdate=!0,n&&n(s)})}return s}}),mono.MTLLoader.ensurePowerOfTwo_=function(e){if(!mono.MTLLoader.isPowerOfTwo_(e.width)||!mono.MTLLoader.isPowerOfTwo_(e.height)){var t=document.createElement("canvas");t.width=mono.MTLLoader.nextHighestPowerOfTwo_(e.width),t.height=mono.MTLLoader.nextHighestPowerOfTwo_(e.height);var n=t.getContext("2d");return n.drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t}return e},mono.MTLLoader.isPowerOfTwo_=function(e){return(e&e-1)===0},mono.MTLLoader.nextHighestPowerOfTwo_=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},mono.OBJMTLLoader=function(){},mono.extend(mono.OBJMTLLoader,mono.MTLLoader,{constructor:mono.OBJMTLLoader,load:function(e,t,n,r,i,s){var o=this,u=new mono.MTLLoader(n);u.load(t,function(t){var i=t;i.preload();var s=new mono.XHRLoader(o.manager);s.setCrossOrigin(this.crossOrigin),s.load(e,function(t){var s=o.parse(t),u="";!n&&e.lastIndexOf("/")>0&&(u=e.substring(0,e.lastIndexOf("/")+1));for(var a=0;a<s._childList._as.length;a++){var f=s._childList._as[a];if(f.mname){var l=i.create(f.mname);o.setGeometryStyle(f,l,u)}for(var c=0;c<f._childList._as.length;c++){var h=f._childList._as[c];if(h.mname){var p=i.create(h.mname);o.setGeometryStyle(h,p,u)}}}r(s)})})},setGeometryStyle:function(e,t,r){var i={};if(t.map){r?this.loadTexture(e,r+t.map.img):this.loadTexture(e,t.map.img);var s=t.map.repeatR,o=t.map.repeatC;s&&o&&(i["m.texture.repeat"]=new mono.Vec2(s,o),i["m.texture.wrapS"]=n.RepeatWrapping,i["m.texture.wrapT"]=n.RepeatWrapping)}i["m.ambient"]=t.ambient,i["m.specular"]=t.specular,i["m.color"]=t.color,t.transparent&&(i["m.transparent"]=!0,i["m.opacity"]=t.opacity),e.s(i)},loadBase64:function(e,t,n,r,i,s){var o=this,u=mono.base64decode(t),a=mono.base64decode(e),f=new mono.MTLLoader(n);f.loadText(u,function(e){var t=e;t.preload();var i=o.parse(a),s="";!n&&url.lastIndexOf("/")>0&&(s=url.substring(0,url.lastIndexOf("/")+1));for(var u=0;u<i._childList._as.length;u++){var f=i._childList._as[u];if(f.mname){var l=t.create(f.mname);o.setGeometryStyle(f,l,s)}for(var c=0;c<f._childList._as.length;c++){var h=f._childList._as[c];if(h.mname){var p=t.create(h.mname);o.setGeometryStyle(h,p,s)}}}r(i)})},loadFiles:function(e,t,n,r,i,s){var o=this,u=new mono.MTLLoader(n);u.loadFile(t,function(t){var n=t;n.preload();var i=new mono.XHRLoader(o.manager);i.loadFile(e,function(e){var t=o.parse(e);for(var i=0;i<t._childList._as.length;i++){var s=t._childList._as[i];if(s.mname){var u=n.create(s.mname);o.setGeometryStyle(s,u)}for(var a=0;a<s._childList._as.length;a++){var f=s._childList._as[a];if(f.mname){var l=n.create(f.mname);o.setGeometryStyle(f,l)}}}r(t)})})},loadTexture:function(e,t){if(typeof t=="string")e.setStyle("m.texture.image",t);else if(e&&t){var n=new mono.ImageLoader;n.loadFile(t,function(t){e.setStyle("m.texture.image",t)})}},parse:function(e,r){function i(e,t,n){return new mono.Vec3(e,t,n)}function s(e,t){return new mono.Vec2(e,t)}function o(e,t,n,r,i){return new mono.Face3(e,t,n,r,null,i)}function u(e,t,n,r,i,s){return new mono.Face4(e,t,n,r,i,null,s)}function f(e,r){if(p.length>0){h.vertices=p,g.length>0&&(h.setMaterialSize(g.length),h.setStyle("m.normalType",n.NormalTypeSmooth)),h.computed=!1,h.computeCentroids(),h.computeFaceNormals(),h.computeBoundingSphere();if(h.faces.length>0){var i=h._name;c.addChild(h),h=new mono.Entity,h._name=i,h.setStyle("m.type","phong"),d=0}}e!==t&&(h._name=e),h.setClient("name",e),r!==t&&(h.mname=r)}function b(e,n,r,i,s){i===t?h.faces.push(o(parseInt(e)-(a+1),parseInt(n)-(a+1),parseInt(r)-(a+1))):h.faces.push(o(parseInt(e)-(a+1),parseInt(n)-(a+1),parseInt(r)-(a+1),[v[parseInt(i[0])-1].clone(),v[parseInt(i[1])-1].clone(),v[parseInt(i[2])-1].clone()],s))}function w(e,n,r,i,s,o){s===t?h.faces.push(u(parseInt(e)-(a+1),parseInt(n)-(a+1),parseInt(r)-(a+1),parseInt(i)-(a+1))):h.faces.push(u(parseInt(e)-(a+1),parseInt(n)-(a+1),parseInt(r)-(a+1),parseInt(i)-(a+1),[v[parseInt(s[0])-1].clone(),v[parseInt(s[1])-1].clone(),v[parseInt(s[2])-1].clone(),v[parseInt(s[3])-1].clone()],o))}function E(e,t,n){h.uvs.push([m[parseInt(e)-1].clone(),m[parseInt(t)-1].clone(),m[parseInt(n)-1].clone()])}function S(e,t,n,r){h.uvs.push([m[parseInt(e)-1].clone(),m[parseInt(t)-1].clone(),m[parseInt(n)-1].clone(),m[parseInt(r)-1].clone()])}function x(e,n,r){var i=g.length>0?g.indexOf(y):0;e[3]===t?(b(e[0],e[1],e[2],r,i),n!==t&&n.length>0&&E(n[0],n[1],n[2])):(r!==t&&r.length>0?(b(e[0],e[1],e[3],[r[0],r[1],r[3]],i),b(e[1],e[2],e[3],[r[1],r[2],r[3]],i)):(b(e[0],e[1],e[3]),b(e[1],e[2],e[3])),n!==t&&n.length>0&&(E(n[0],n[1],n[3]),E(n[1],n[2],n[3])))}var a=0,l=new mono.Entity,c=l,h=new mono.Entity;h.setStyle("m.type","phong");var p=[],d=0,v=[],m=[],g=[],y=0,T=/v( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,N=/vn( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,C=/vt( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,k=/f( +\d+)( +\d+)( +\d+)( +\d+)?/,L=/f( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))?/,A=/f( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))?/,O=/f( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))?/,M=/s( +(\d))?/,_=e.split("\n");for(var D=0;D<_.length;D++){var P=_[D];P=P.trim();var H;if(P.length===0||P.charAt(0)==="#"&&P.charAt(2)!="o")continue;if((H=T.exec(P))!==null)p.push(i(parseFloat(H[1]),parseFloat(H[2]),parseFloat(H[3])));else if((H=N.exec(P))!==null)v.push(i(parseFloat(H[1]),parseFloat(H[2]),parseFloat(H[3])));else if((H=C.exec(P))!==null)m.push(s(parseFloat(H[1]),parseFloat(H[2])));else if((H=k.exec(P))!==null)x([H[1],H[2],H[3],H[4]]);else if((H=L.exec(P))!==null)x([H[2],H[5],H[8],H[11]],[H[3],H[6],H[9],H[12]]);else if((H=A.exec(P))!==null)x([H[2],H[6],H[10],H[14]],[H[3],H[7],H[11],H[15]],[H[4],H[8],H[12],H[16]]);else if((H=O.exec(P))!==null)x([H[2],H[5],H[8],H[11]],[],[H[3],H[6],H[9],H[12]]);else if(P.charAt(0)==="#"&&P.charAt(2)==="o")f(),a+=p.length,p=[],c=new mono.Entity,c._name=P.substring(2).trim(),l.addChild(c);else if(/^g /.test(P))f(P.substring(2).trim(),t);else if(/^usemtl /.test(P))f(t,P.substring(7).trim());else if(/^mtllib /.test(P)){if(r){var B=P.substring(7);B=B.trim(),r(B)}}else/^s /.test(P)&&(H=M.exec(P),g.indexOf(H[2])<0&&g.push(H[2]),y=H[2])}return f(t,t),l}});var D=mono.DaeAdapter=function(){function p(e,n,r){var i=0;if(e!==t){var s=e.split("/");s.pop(),f=(s.length<1?".":s.join("/"))+"/"}var o=new XMLHttpRequest;o.onreadystatechange=function(
){if(o.readyState==4){if(o.status==0||o.status==200)if(o.responseXML)d(o.responseXML,n,e);else if(o.responseText){var t=new DOMParser,s=t.parseFromString(o.responseText,"application/xml");d(s,n,e)}else console.error("ColladaLoader: Empty or non-existing file ("+e+")")}else o.readyState==3&&r&&(i==0&&(i=o.getResponseHeader("Content-Length")),r({total:i,loaded:o.responseText.length}))},o.open("GET",e,!0),o.send(null)}function d(t,n,r){e=t,q(),o=T(),i=new b,i.parse();var s=Z();a=z(),u=X(),c=m();if(i)for(var f=0;f<i.nodes.length;f++)v(i.nodes[f]);var h={lights:s,visualScenes:i,images:a,materials:c,geometries:o,entityies:l};n&&n(h)}function v(e,t){if(!e)return;var n={};for(var r=0;r<e.geometries.length;r++){var i=e.geometries[r],s=i.instance_material,a=o[i.url],f={},h=[],p=0,d;if(a){if(!a.mesh||!a.mesh.primitives)continue;if(s)for(var m=0;m<s.length;m++){var g=s[m],y=c[g.target],b=y.instance_effect.url,w=u[b].shader,E=w.material;if(a.doubleSided){if(!(g.symbol in n)){var S=E.clone();S.side=mono.DoubleSide,n[g.symbol]=S}E=n[g.symbol]}E.opacity=E.opacity?E.opacity:1,f[g.symbol]=p,h.push(E),d=E,d.name=y.name==null||y.name===""?y.id:y.name,p++}var x=d||new mono.LambertMaterial({color:14540253,shading:mono.FlatShading,side:a.doubleSided?mono.DoubleSide:mono.FrontSide}),T=a.mesh.node3D;if(p>1){x=new mono.ArrayMaterial(h);for(m=0;m<T.faces.length;m++){var N=T.faces[m];N.materialIndex=f[N.daeMaterial]}}x instanceof mono.ArrayMaterial&&T.setMaterialSize(x.materials.length),T.createMaterial(x),T.matrix=e.matrix,T.matrix.decompose(T._position,T.quaternion,T.scale);var C=T.quaternion;if(C){var k=C.x*C.x,L=C.y*C.y,A=C.z*C.z,O=C.w*C.w;T._rotation.x=Math.atan2(2*(C.x*C.w-C.y*C.z),O-k-L+A),T._rotation.y=Math.asin(mono.Math.clamp(2*(C.x*C.z+C.y*C.w),-1,1)),T._rotation.z=Math.atan2(2*(C.z*C.w-C.x*C.y),O+k-L-A)}l.push(T)}}for(var m=0;m<e.nodes.length;m++)v(e.nodes[m],e)}function m(){var t=e.querySelectorAll("library_materials material"),n={};if(t&&t.length>0)for(var r=0;r<t.length;r++){var i=t[r];if(i){var s=(new g).parse(i);s&&(n[s.id]=s)}}return n}function g(){this.id="",this.name="",this.instance_effect=null}function y(){this.url=""}function b(){this.nodes=[],this.id="",this.name=""}function w(){this.nodes=[],this.id="",this.name="",this.sid="",this.type="",this.controllers=[],this.geometries=[],this.type="",this.layer="",this.matrix=new mono.Mat4,this.transforms=[]}function E(){this.sid="",this.type="",this.data=[]}function S(){this.url="",this.instance_material=[]}function x(){this.symbol="",this.target=""}function T(){var t={};t.entity=[];var n=e.querySelectorAll("library_geometries geometry");if(n&&n.length>0)for(var r=0;r<n.length;r++){var i=(new N).parse(n[r]);i&&(t[i.id]=i,t.entity.push(i))}return t}function N(){this.id="",this.mesh=null}function C(){this.sources={},this.primitives=[],this.vertices=null,this.node3D=null}function k(e,t){var n=[e[t],e[t+1],e[t+2]];return L(n,-1),new mono.Vec3(n[0],n[1],n[2])}function L(e,t){if(h.convertUpAxis!==!0||n===h.upAxis)return;switch(r){case"XtoY":var i=e[0];e[0]=t*e[1],e[1]=i;break;case"XtoZ":var i=e[2];e[2]=e[1],e[1]=e[0],e[0]=i;break;case"YtoX":var i=e[0];e[0]=e[1],e[1]=t*i;break;case"YtoZ":var i=e[1];e[1]=t*e[2],e[2]=i;break;case"ZtoX":var i=e[0];e[0]=e[1],e[1]=e[2],e[2]=i;break;case"ZtoY":var i=e[1];e[1]=e[2],e[2]=t*i}}function A(){this.id="",this.input={}}function O(){this.semantic="",this.offset=0,this.source="",this.set=0}function M(){this.inputs=[],this.count=0,this.p=[],this.material=""}function _(){M.call(this),this.vcount=3}function D(){this.id,this.dataType,this.technique_common={},this.accessor=null,this.data=[]}function P(){this.source="",this.count=0,this.stride=0,this.params=[]}function H(e){return e?parseInt(e,10):0}function B(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function j(e){var n=[];if(!e)return e;e=B(e);if(e.length>0){var r=e.split(/\s+/);for(var i=0;i<r.length;i++){var s=r[i];s!=t&&s!=null&&parseFloat(s)!=null&&n.push(parseFloat(s))}}return n}function F(e){var n=[];if(!e)return[];e=B(e);if(e.length>0){var r=e.split(/\s+/);for(var i=0;i<r.length;i++){var s=r[i];s!=t&&s!=null&&parseInt(s)!=null&&n.push(parseInt(s))}}return n}function I(e){var t=[];if(!e)return[];e=B(e);if(e.length>0){var n=e.split(/\s+/);for(var r=0;r<n.length;r++)t.push(n[r]=="true"||n[r]=="1"?!0:!1)}return t}function q(){if(h.convertUpAxis!==!0||n===h.upAxis)r=null;else switch(n){case"X":r=h.upAxis==="Y"?"XtoY":"XtoZ";break;case"Y":r=h.upAxis==="X"?"YtoX":"YtoZ";break;case"Z":r=h.upAxis==="X"?"ZtoX":"ZtoY"}}function R(e){if(h.convertUpAxis){var t=[e[0],e[4],e[8]];L(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],L(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],L(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],L(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],L(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],L(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],L(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return new mono.Mat4(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function U(){var t=e.querySelectorAll("scene instance_visual_scene")[0];if(t){var n=t.getAttribute("url").replace(/^#/,"");return i[n.length>0?n:"visual_scene0"]}return null}function z(){var t=e.querySelectorAll("library_images image"),n={};if(t&&t.length>0)for(var r=0;r<t.length;r++){var i=t[r];if(i){var s=(new W).parse(i);n[s.id]=s}}return n}function W(){this.id="",this.init_from=""}function X(){var t=e.querySelectorAll("library_effects effect"),n={};if(t&&t.length>0)for(var r=0;r<t.length;r++){var i=t[r];if(i){var s=(new V).parse(i);n[s.id]=s}}return n}function V(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function $(e,t){this.type=e,this.effect=t,this.material=null}function J(){this.color=new mono.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function K(e){this.effect=e,this.init_from=null,this.format=null}function Q(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function G(n){var r=e.querySelectorAll("library_nodes node");for(var i=0;i<r.length;i++){var s=r[i].attributes.getNamedItem("id");if(s&&s.value===n)return r[i]}return t}function Y(e,t){e.doubleSided=!1;var n=t.querySelectorAll("extra double_sided")[0];n&&n&&parseInt(n.textContent,10)===1&&(e.doubleSided=!0)}function Z(){var t=[],n=e.querySelectorAll("library_lights light");if(n&&n.length>0)for(var r=0;r<n.length;r++){var i=n[r],s=(new et).parse(n);t.push(s)}return t}function et(){this.id="",this.name="",this.technique=""}this.id="",this.name="",this.type="";var e=null,n="Y",r=null,i=null,s={},o={},u={},a={},f="",l=[],c={},h={};return g.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if(e.childNodes[t].nodeName=="instance_effect"){this.instance_effect=(new y).parse(e.childNodes[t]);break}return this},y.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},b.prototype.parse=function(){var t=e.querySelectorAll("library_visual_scenes visual_scene");if(!t||t.length<0)return this;this.id="",this.name="";for(var n=0;n<t.length;n++){var r=t[n];if(r&&r.childNodes&&r.childNodes.length>0)for(var i=0;i<r.childNodes.length;i++){var s=r.childNodes[i];if(s&&s.nodeName)switch(s.nodeName){case"node":this.nodes.push((new w).parse(s));break;default:}}}return this},w.prototype.parse=function(e){if(!e)return this;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type=this.type=="JOINT"?this.type:"NODE";if(e.childNodes.length>0)for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n&&n.nodeName)switch(n.nodeName){case"node":this.nodes.push((new w).parse(n));break;case"instance_camera":break;case"instance_controller":break;case"instance_geometry":this.geometries.push((new S).parse(n));break;case"instance_light":break;case"instance_node":var r=n.getAttribute("url").replace(/^#/,""),i=G(r);i&&this.nodes.push((new w).parse(i));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new E).parse(n));break;case"extra":break;default:console.log(n.nodeName)}}return this.updateMatrix(),this},w.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},E.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=j(e.textContent),this.convert(),this},E.prototype.convert=function(){switch(this.type){case"matrix":this.obj=R(this.data);break;case"rotate":this.angle=mono.Math.degToRad(this.data[3]);case"translate":L(this.data,-1),this.obj=new mono.Vec3(this.data[0],this.data[1],this.data[2]);break;case"scale":L(this.data,1),this.obj=new mono.Vec3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},E.prototype.apply=function(){var e=new mono.Mat4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),E.prototype.update=function(e,t){var n=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(!t)this.obj.copy(e);else if(t.length===1)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(t.length===2){var r="n"+(t[0]+1)+(t[1]+1);this.obj[r]=e}else console.log("Incorrect addressing of matrix in transform.");break;case"translate":case"scale":Object.prototype.toString.call(t)==="[object Array]"&&(t=n[t[0]]);switch(t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":Object.prototype.toString.call(t)==="[object Array]"&&(t=n[t[0]]);switch(t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=mono.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=mono.Math.degToRad(e[3])}}},S.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;if(n.nodeName=="bind_material"){var r=n.querySelectorAll("instance_material");for(var i=0;i<r.length;i++){var s=r[i];this.instance_material.push((new x).parse(s))}break}}return this},x.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},N.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n&&n.nodeName=="mesh"){var r=new C,i=r.parse(n);i&&(this.mesh=i)}}return this},C.prototype.parse=function(e){if(e&&e.childNodes&&e.childNodes.length>0)for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"source":var r=n.getAttribute("id");this.sources[r]=(new D).parse(n);break;case"vertices":var i=new A;this.vertices=i.parse(n);break;case"polygons":var s=(new M).parse(n);s&&this.primitives.push(s);break;case"triangles":var o=(new _).parse(n);o&&this.primitives.push(o);break;case"polylist":var u=null;this.primitives.push(u);break;default:}}this.node3D=new mono.Entity;var a=null;this.vertices&&this.vertices.input&&this.vertices.input.POSITION&&(a=this.sources[this.vertices.input.POSITION.source].data);for(t=0;t<this.primitives.length;t++){var f=this.primitives[t];f.setVertices(this.vertices),this.handlePrimitive(f,this.node3D)}for(t=0;t<a.length;t+=3)this.node3D.vertices.push(k(a,t).clone());return this.node3D.computeFaceNormals(),this},C.prototype.handlePrimitive=function(e,n){var r,i,s=e.p,o=e.inputs,u,a,f,l,c,p=0,d=3,v=0,m=[];for(r=0;r<o.length;r++){u=o[r];var g=u.offset+1;v=v<g?g:v;switch(u.semantic){case"TEXCOORD":m.push(u.set)}}for(var y=0;y<s.length;++y){var b=s[y],w=0;while(w<b.length){var E=[],S=[],x=null,T=[];e.vcount?d=e.vcount.length?e.vcount[p++]:e.vcount:d=b.length/v;for(r=0;r<d;r++)for(i=0;i<o.length;i++){u=o[i],l=this.sources[u.source],a=b[w+r*v+u.offset],c=l.accessor.params.length,f=a*c;switch(u.semantic){case"VERTEX":E.push(a);break;case"NORMAL":S.push(k(l.data,f));break;case"TEXCOORD":x=x||{},x[u.set]===t&&(x[u.set]=[]),x[u.set].push(new mono.Vec2(l.data[f],l.data[f+1]));break;case"COLOR":T.push((new mono.Color).setRGB(l.data[f],l.data[f+1],l.data[f+2]));break;default:}}if(S.length==0){u=this.vertices.input.NORMAL;if(u){l=l[u.source],c=l.accessor.params.length;for(var N=0,C=E.length;N<C;N++)S.push(k(l.data,E[N]*c))}else n.calcNormals=!0}if(!x){x={},u=this.vertices.input.TEXCOORD;if(u){m.push(u.set),l=sources[u.source],c=l.accessor.params.length;for(var N=0,C=E.length;N<C;N++)f=E[N]*c,x[u.set]===t&&(x[u.set]=[]),x[u.set].push(new mono.Vec2(l.data[f],1-l.data[f+1]))}}if(T.length==0){u=this.vertices.input.COLOR;if(u){l=sources[u.source],c=l.accessor.params.length;for(var N=0,C=E.length;N<C;N++)f=E[N]*c,T.push((new mono.Color).setRGB(l.data[f],l.data[f+1],l.data[f+2]))}}var L=null,A=[],O,M;if(d===3)A.push(new mono.Face3(E[0],E[1],E[2],S,T.length?T:new mono.Color(16711680)));else if(d===4)A.push(new mono.Face3(E[0],E[1],E[3],[S[0],S[1],S[3]],T.length?[T[0],T[1],T[3]]:new mono.Color(16711680))),A.push(new mono.Face3(E[1],E[2],E[3],[S[1],S[2],S[3]],T.length?[T[1],T[2],T[3]]:new mono.Color(16711680)));else if(d>4&&h.subdivideFaces){var _=T.length?T:new mono.Color,D,P,H,B,j,F;for(i=1;i<d-1;)A.push(new mono.Face3(E[0],E[i],E[i+1],[S[0],S[i++],S[i]],_))}if(A.length)for(var N=0,C=A.length;N<C;N++){L=A[N],L.daeMaterial=e.material,n.faces.push(L);for(i=0;i<m.length;i++)O=x[m[i]],d>4?M=[O[0],O[N+1],O[N+2]]:d===4?N===0?M=[O[0],O[1],O[3]]:M=[O[1].clone(),O[2],O[3].clone()]:M=[O[0],O[1],O[2]],n.uvs===t&&(n.uvs=[]),n.uvs.push(M)}else console.log("dropped face with vcount "+d+" for geometry with id: "+n.id);w+=v*d}}},A.prototype.parse=function(e){if(e){this.id=e.getAttribute("id");if(e.childNodes.length>0)for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n&&n.nodeName)switch(n.nodeName){case"input":var r=(new O).parse(n);this.input[r.semantic]=r;break;default:}}}return this},O.prototype.parse=function(e){return e&&(this.semantic=e.getAttribute("semantic"),this.offset=H(e.getAttribute("offset")),this.set=H(e.getAttribute("set")),this.source=e.getAttribute("source").replace(/^#/,""),this.semantic=="TEXCOORD"&&this.set<0&&(this.set=0)),this},M.prototype.parse=function(e){if(e){this.count=e.getAttribute("count"),this.material=e.getAttribute("material");if(e.childNodes.length>0)for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n&&n.nodeName)switch(n.nodeName){case"input":var r=(new O).parse(n);r&&this.inputs.push(r);break;case"p":this.p.push(F(n.textContent));break;default:}}}return this},M.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source==e.id&&(this.inputs[t].source=e.input.POSITION.source)},_.prototype=Object.create(M.prototype),D.prototype.parse=function(e){if(!e)return this;this.id=e.getAttribute("id");if(e.childNodes.length>0)for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n&&n.nodeName)switch(n.nodeName){case"float_array":this.dataType=n.nodeName,this.data=j(n.textContent);break;case"bool_array":this.dataType=n.nodeName,this.data=I(n.textContent);break;case"int_array":this.data=F(n.textContent),this.dataType=n.nodeName;break;case"technique_common":if(n.childNodes&&n.childNodes.length>0)for(var r=0;r<n.childNodes.length;r++){var i=n.childNodes[r];if(i&&i.nodeName)switch(i.nodeName){case"accessor":var s=(new P).parse(i);s.source&&(this.technique_common[s.source]=s,this.accessor=s);break;default:}}break;default:}}return this},D.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var n=0;n<this.data.length;n+=16){var r=this.data.slice(n,n+16),i=R(r);e.push(i)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},P.prototype.parse=function(e){if(!e)return this;this.source=e.getAttribute("source"),this.count=H(e.getAttribute("count")),this.stride=H(e.getAttribute("stride"));if(e.childNodes.length>0)for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n&&n.nodeName)switch(n.nodeName){case"param":var r={};r.name=n.getAttribute("name"),r.type=n.getAttribute("type"),this.params.push(r);break;default:}}return this},W.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];n.nodeName=="init_from"&&(this.init_from=n.textContent)}return this},V.prototype.create=function(){if(this.shader==null)return null},V.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),Y(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(n));break;default:}}return this},V.prototype.parseNewparam=function(e){var t=e.getAttribute("sid");for(var n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];if(r.nodeType!=1)continue;switch(r.nodeName){case"surface":this.surface[t]=(new K(this)).parse(r);break;case"sampler2D":this.sampler[t]=(new Q(this)).parse(r);break;case"extra":break;default:console.log(r.nodeName)}}},V.prototype.parseProfileCOMMON=function(e){var t;for(var n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];if(r.nodeType!=1)continue;switch(r.nodeName){case"profile_COMMON":this.parseProfileCOMMON(r);break;case"technique":t=r;break;case"newparam":this.parseNewparam(r);break;case"image":var i=(new W).parse(r);a[i.id]=i;break;case"extra":break;default:console.log(r.nodeName)}}return t},V.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=(new $(n.nodeName,this)).parse(n);break;case"extra":this.parseExtra(n);break;default:}}},V.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"technique":this.parseExtraTechnique(n);break;default:}}},V.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"bump":this.shader.parse(n);break;default:}}},$.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":this[n.nodeName]=(new J).parse(n);break;case"bump":var r=n.getAttribute("bumptype");r?r.toLowerCase()==="heightfield"?this.bump=(new J).parse(n):r.toLowerCase()==="normalmap"?this.normal=(new J).parse(n):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+r+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new J).parse(n)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new J).parse(n));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var i=n.querySelectorAll("float");i.length>0&&(this[n.nodeName]=parseFloat(i[0].textContent));break;default:}}return this.create(),this},$.prototype.create=function(){var e={},n=!1;if(this.transparency!==t&&this.transparent!==t){var r=this.transparent,i=(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency;i>0&&(n=!0,e.transparent=!0,e.opacity=1-i)}var s={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var o in this)switch(o){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var u=this[o];if(u instanceof J)if(u.isTexture()){var l=u.texture,c=this.effect.sampler[l],p=null;if(c!==t&&c.source!==t){var d=this.effect.surface[c.source];p=a[d.init_from]}else p=a[l];if(p){var v=f+p.init_from,m=new Image;m.loaded=!1;var g=new mono.Texture;g._imageSrc=v,g._image=m,g.setImage(v),g.wrapS=u.texOpts.wrapU?mono.RepeatWrapping:mono.ClampToEdgeWrapping,g.wrapT=u.texOpts.wrapV?mono.RepeatWrapping:mono.ClampToEdgeWrapping,g.offsetX=u.texOpts.offsetU,g.offsetY=u.texOpts.offsetV,g.repeatX=u.texOpts.repeatU,g.repeatY=u.texOpts.repeatV,e[s[o]]=g,o==="emission"&&(e.emissive=16777215)}}else if(o==="diffuse"||!n)o==="emission"?e.emissive=u.color.getHex():e[o]=u.color.getHex();break;case"shininess":e[o]=this[o];break;case"reflectivity":e[o]=this[o],e[o]>0&&(e.envMap=h.defaultEnvMap),e.combine=mono.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[o],this[o]!==1&&(e.envMap=h.defaultEnvMap);break;case"transparency":break;default:}e.shading=mono.SmoothShading,e.side=this.effect.doubleSided?mono.DoubleSide:mono.FrontSide;switch(this.type){case"constant":e.emissive!=t&&(e.color=e.emissive),this.material=new mono.EntityMaterial(e);break;case"phong":case"blinn":e.diffuse!=t&&(e.color=e.diffuse),this.material=new mono.EntityMaterial(e);break;case"lambert":default:e.diffuse!=t&&(e.color=e.diffuse),this.material=new mono.LambertMaterial(e)}return this.material},J.prototype.isColor=function(){return this.texture==null},J.prototype.isTexture=function(){return this.texture!=null},J.prototype.parse=function(e){e.nodeName=="transparent"&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"color":var r=j(n.textContent);this.color=new mono.Color,this.color.setRGB(r[0],r[1],r[2]),this.color.a=r[3];break;case"texture":this.texture=n.getAttribute("texture"),this.texcoord=n.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(n);break;default:}}return this},J.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&e.childNodes[1].nodeName==="extra"&&(e=e.childNodes[1],e.childNodes[1]&&e.childNodes[1].nodeName==="technique"&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[n.nodeName]=parseFloat(n.textContent);break;case"wrapU":case"wrapV":n.textContent.toUpperCase()==="TRUE"?this.texOpts[n.nodeName]=1:this.texOpts[n.nodeName]=parseInt(n.textContent);break;default:this.texOpts[n.nodeName]=n.textContent}}return this},K.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"init_from":this.init_from=n.textContent;break;case"format":this.format=n.textContent;break;default:console.log("unhandled Surface prop: "+n.nodeName)}}return this},Q.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"source":this.source=n.textContent;break;case"minfilter":this.minfilter=n.textContent;break;case"magfilter":this.magfilter=n.textContent;break;case"mipfilter":this.mipfilter=n.textContent;break;case"wrap_s":this.wrap_s=n.textContent;break;case"wrap_t":this.wrap_t=n.textContent;break;default:console.log("unhandled Sampler2D prop: "+n.nodeName)}}return this},et.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"technique_common":this.parseCommon(n);break;case"technique":this.parseTechnique(n);break;default:}}return this},et.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;var n=e.childNodes[t];for(var r=0;r<n.childNodes.length;r++){var i=n.childNodes[r];switch(i.nodeName){case"color":var s=j(i.textContent);this.color=new mono.Color(0),this.color.setRGB(s[0],s[1],s[2]),this.color.a=s[3];break;case"falloff_angle":this.falloff_angle=parseFloat(i.textContent);break;case"quadratic_attenuation":var o=parseFloat(i.textContent);this.distance=o?Math.sqrt(1/o):0}}}return this},et.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"intensity":this.intensity=parseFloat(n.textContent)}}return this},{load:p,parse:d,geometries:s,options:h}};n.DataBox=function(e){n.DataBox.superClass.constructor.apply(this,arguments),arguments.length===1&&(this._name=e),this._dataList=new C,this._dataMap={},this._rootList=new C,this._rootMap={},this._clientMap={},this._lightList=new C,this._flareList=new C,this._billboardList=new C,this._nodeList=new C,this._annotationList=new C,this._particleList=new C,this.nodes=[],this.particles=[],this.billboards=[],this._dataBoxChangeDispatcher=new n.EventDispatcher,this._dataPropertyChangeDispatcher=new n.EventDispatcher,this._groupLists={},this.selection=new C,this instanceof n.AlarmBox||(this._selectionModel=new n.SelectionModel(this),this._alarmBox=new n.AlarmBox(this),this._alarmStatePropagator=new n.AlarmStatePropagator(this),this._alarmStatePropagator.setEnable(!0)),this.batch=!1,this._clientMap={}},n.extend(n.DataBox,n.PropertyChangeDispatcher,{constructor:n.DataBox,className:"TGL.DataBox",___accessor:["name"],add:function(e,t){if(!e)return;arguments.length===1&&(t=-1);var r=e.getId();if(this._dataMap.hasOwnProperty(r)){if(this._dataMap[r]!==e)throw"Data with ID '"+r+"' already exists";return}this._dataMap[r]=e,this._dataList.add(e),e.getParent()||(this._rootMap[r]=e,t>=0?this._rootList.add(e,t):this._rootList.add(e)),e instanceof n.Billboard?this._billboardList.add(e):e instanceof n.LensFlare?this._flareList.add(e):e instanceof n.Node?this._nodeList.add(e):e instanceof n.Particle?this._particleList.add(e):e instanceof n.Annotation?this._annotationList.add(e):e instanceof n.Light&&this._lightList.add(e),this._dataBoxChangeDispatcher.fire({kind:"add",data:e,source:this}),e.getGroupId()&&this.groupElements(e,null,e.getGroupId()),e.addPropertyChangeListener(this.handleDataPropertyChange,this),e._selected=!1},onPropertyChange:function(){},firePropertyChange:function(){},addByDescendant:function(e,t){if(t&&t(e)==0)return;e&&(this.add(e),e.getChildren().size()>0&&e.getChildren().forEach(function(e){this.addByDescendant(e,t)},this))},getAlarmBox:function(){return this._alarmBox},removeById:function(e,t){var n=this.getDataById(e);this.remove(n,t)},remove:function(e,t){if(!e)return;if(!this._dataMap.hasOwnProperty(e.getId()))return;e instanceof n.Link&&(e.setFromNode(null),e.setToNode(null)),e instanceof n.Node&&e.getLinks()&&e.getLinks().toList().forEach(function(e){this.remove(e)},this),t&&(e.getChildren().forEach(function(t){e.removeChild(t)},this),e.getParent()&&e.getParent().removeChild(e)),this._dataList.remove(e);var r=e._id;delete this._dataMap[r],this._rootMap[r]&&(delete this._rootMap[r],this._rootList.remove(e)),e instanceof n.Billboard?this._billboardList.remove(e):e instanceof n.Node?this._nodeList.remove(e):e instanceof n.Particle?this._particleList.remove(e):e instanceof n.Annotation?this._annotationList.remove(e):e instanceof n.Light?this._lightList.remove(e):e instanceof n.LensFlare&&this._flareList.remove(e),e.getGroupId()&&this.groupElements(e,e.getGroupId(),null),e.removePropertyChangeListener(this.handleDataPropertyChange,this),this._dataBoxChangeDispatcher.fire({kind:"remove",data:e,source:this}),this._selectionModel&&this._selectionModel.removeSelection(e)},removeByDescendant:function(e,t,n){if(!e)return;var r=this;e.hasChildren()&&e.getChildren().forEachReverse(function(e){r.removeByDescendant(e,t,n)});if(n&&n(e)==0)return;this.remove(e,t)},containsById:function(e){return this._dataMap.hasOwnProperty(e)},contains:function(e){return e?this._dataMap[e._id]===e:!1},lightsSize:function(){return this._lightList.size()},getLights:function(){return this._lightList},getLightsArray:function(){return this._lightList.toArray()},getAnnotations:function(){return this._annotationList},clear:function(e){if(this._dataList.size()>0){var t=this._dataList.toList(function(t){return!this._lightList.contains(t)||e},this);t.forEach(function(e){e.removePropertyChangeListener(this.handleDataPropertyChange,this)},this),this._dataList.clear(),this._dataMap={},this._rootList.clear(),this._rootMap={},this._nodeList.clear(),this._billboardList.clear();if(e)this._lightList.clear(),this._flareList.clear();else{var n=this;this._lightList.forEach(function(e){n._dataList.add(e);var t=e.getId();n._dataMap[t]=e,e.getParent()==null&&(n._rootList.add(e),n._rootMap[t]=e)})}this._dataBoxChangeDispatcher.fire({kind:"clear",datas:t}),this.clearSelection()}},startBatch:function(){this.batch=!0},endBatch:function(){this.batch=!1,this._dataBoxChangeDispatcher.fire({kind:"batchEnd"})},removeSelection:function(){var e=this._selectionModel.toSelection();e.forEach(function(e){this.remove(e)},this)},clearSelection:function(){this._selectionModel&&this._selectionModel.clearSelection()},clearEditing:function(){this._nodeList.forEach(function(e){e.editing=!1}),this._billboardList.forEach(function(e){e.editing=!1})},getDataById:function(e){return this._dataMap[e]},groupElements:function(e,t,n){var r;t&&(r=this._groupLists[t],r&&(r.remove(e),r.isEmpty()&&delete this._groupLists[t])),n&&(r=this._groupLists[n],r==null&&(r=new C,this._groupLists[n]=r),r.contains(e)||r.add(e))},synchronizeGroup:function(e,t,r,i){if(this.isAdjustingGroup)return;this.isAdjustingGroup=!0;var s=e.getGroupId(),o=new n.Vec3;if(s){var u=this._groupLists[s];u&&u.size()>1&&u.forEach(function(s){s!==e&&!s.isDescendantOf(e)&&!e.isDescendantOf(s)&&(o.subVectors(r,t),s[n.setter(i)](s[n.getter(i)]().clone().add(o)))})}this.isAdjustingGroup=!1},handleDataPropertyChange:function(e){var t=e.source;if(e.property==="parent"){var n=t.getId();t.getParent()?this._rootMap[n]&&(delete this._rootMap[n],this._rootList.remove(t)):this._rootMap[n]||(this._rootMap[n]=t,this._rootList.add(t))}else if(e.property==="groupId"){var r=e.oldValue,i=e.newValue;this.groupElements(t,r,i)}else e.property==="position"||e.property==="scale"||e.property==="rotation"?this.synchronizeGroup(t,e.oldValue,e.newValue,e.property):e.property==="selected"&&(t._selected?this._selectionModel.appendSelection(t):this._selectionModel.removeSelection(t));this.onDataPropertyChanged(t,e),this._dataPropertyChangeDispatcher.fire(e)},onDataPropertyChanged:function(e,t){},addDataBoxChangeListener:function(e,t,n){this._dataBoxChangeDispatcher.add(e,t,n)},removeDataBoxChangeListener:function(e,t){this._dataBoxChangeDispatcher.remove(e,t)},addDataPropertyChangeListener:function(e,t,n){this._dataPropertyChangeDispatcher.add(e,t,n)},removeDataPropertyChangeListener:function(e,t){this._dataPropertyChangeDispatcher.remove(e,t)},allocateLights:function(){var e,t,r,i,s,o,u,r;i=s=o=u=0;var a=this._lightList;for(e=0,t=a.size();e<t;e++){r=a.get(e);if(r.onlyShadow)continue;r instanceof n.DirectionalLight&&i++,r instanceof n.PointLight&&s++,r instanceof n.SpotLight&&o++}return{directional:i,point:s,spot:o,hemi:u}},allocateShadows:function(){var e,t,r,i=0,s=this._lightList;for(e=0,t=s.size();e<t;e++){r=s.get(e);if(!r.castShadow)continue;r instanceof n.SpotLight&&i++,r instanceof n.DirectionalLight&&!r.shadowCascade&&i++}return i},allocatePointShadows:function(){var e,t,r,i=0,s=this._lightList;for(e=0,t=s.size();e<t;e++){r=s.get(e);if(!r.castShadow)continue;r instanceof n.PointLight&&i++}return i},getSelectionModel:function(){return this._selectionModel},size:function(){return this._dataList.size()},isEmpty:function(){return this._dataList.isEmpty()},getLimit:function(){return this._limit},setLimit:function(e){var t=this._limit;this._limit=e,this.firePropertyChange("limit",t,e),this._checkLimit()},_checkLimit:function(){this._limit>=0&&this.size()>this._limit&&this.removeFirst(this.size()-this._limit)},removeFirst:function(e){arguments.length===0&&(e=1);while(e>0&&this._dataList.size
()>0){var t=this._dataList.get(0);this.remove(t),e--}},getSiblings:function(e){if(!this.contains(e))throw e+" dosen't belong to this dataBox";var t=e.getParent();return t?t.getChildren():this._rootList},getRoots:function(){return this._rootList},getSiblingIndex:function(e){return e.getParent()?e.getParent().getChildren().indexOf(e):this._rootList.indexOf(e)},getNodes:function(){return this._nodeList},getBillboards:function(){return this._billboardList},getLensFlares:function(){return this._flareList},getDatas:function(){return this._dataList},getDataAt:function(e){return this._dataList.get(e)},toDatas:function(e,t){return this._dataList.toList(e,t)},forEach:function(e,t){this._dataList.forEach(e,t)},forEachReverse:function(e,t){this._dataList.forEachReverse(e,t)},forEachByDepthFirst:function(e,t,n){if(t)this._depthFirst(e,t,n);else{var r=this._rootList.size();for(var i=0;i<r;i++){var s=this._rootList.get(i);if(this._depthFirst(e,s,n)===!1)return}}},_depthFirst:function(e,t,n){var r=t.getChildrenSize();for(var i=0;i<r;i++){var s=t.getChildAt(i);if(this._depthFirst(e,s,n)===!1)return!1}if(n){if(e.call(n,t)===!1)return!1}else if(e(t)===!1)return!1},forEachByBreadthFirst:function(e,t,n){var r=new C;t?r.add(t):this._rootList.forEach(r.add,r);while(r.size()>0){t=r.removeAt(0),t.getChildren().forEach(r.add,r);if(n){if(e.call(n,t)===!1)return}else if(e(t)===!1)return}},getAlarmStatePropagator:function(){return this._alarmStatePropagator},setAlarmStatePropagator:function(e){if(this._alarmStatePropagator==e)return;this._alarmStatePropagator&&this._alarmStatePropagator.setEnable(!1),this._alarmStatePropagator=e,this._alarmStatePropagator.setEnable(!0)},setClient:function(e,t){if(e==null)return this;this._clientMap==null&&(this._clientMap=new Object);var n=this._clientMap[e];if(n===t)return;return t==null?delete this._clientMap[e]:this._clientMap[e]=t,this._clientMap[e]=t,this.firePropertyChange("C:"+e,n,t),this},getClient:function(e){return this._clientMap[e]}}),n.QuickFinder=function(e,t,r,i,s){this._map={};if(!e)throw"dataBox can not be null";if(!t)throw"propertyName can not be null";this._dataBox=e,this._propertyName=t,this._propertyType=r||"accessor",this._propertyType==="accessor"&&(this._getter=n.getter(t)),this._valueFunction=i||this.getValue,this._filterFunction=s||this.isInterested,this._dataBox.forEach(this._addData,this),this._dataBox.addDataBoxChangeListener(this.handleDataBoxChange,this,!0),this._dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this,!0)},n.extend(n.QuickFinder,Object,{_NULL_:"mono-null-key",getValueFunction:function(){return this._valueFunction},getFilterFunction:function(){return this._filterFunction},handleDataBoxChange:function(e){e.kind==="add"?this._addData(e.data):e.kind==="remove"?this._removeData(e.data):e.kind==="clear"&&(this._map={})},handleDataPropertyChange:function(e){if(!this._filterFunction.call(this,e.source))return;if(this._propertyType!=="accessor"||this._propertyName!==e.property)if(this._propertyType!=="style"||!e.source.IStyle||"S:"+this._propertyName!==e.property)if(this._propertyType!=="client"||"C:"+this._propertyName!==e.property)return;var t=this._getMap(e.oldValue);t&&t.remove(e.source),this._addData(e.source)},_getMap:function(e){return e=e==null?this._NULL_:e,this._map[e]},find:function(e){var t=this._getMap(e);return t?t.toList():new C},findFirst:function(e){var t=this._getMap(e);return!t||t.isEmpty()?null:t.get(0)},_addData:function(e){if(!this._filterFunction.call(this,e))return;var t=this._valueFunction.call(this,e),n=this._getMap(t);n||(n=new C,t=t==null?this._NULL_:t,this._map[t]=n),n.add(e)},_removeData:function(e){if(!this._filterFunction.call(this,e))return;var t=this._valueFunction.call(this,e),n=this._getMap(t);n&&(n.remove(e),n.isEmpty()&&(t=t==null?this._NULL_:t,delete this._map[t]))},dispose:function(){this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this),this._dataBox.removeDataPropertyChangeListener(this.handleDataPropertyChange,this),delete this._dataBox},getDataBox:function(){return this._dataBox},getPropertyType:function(){return this._propertyType},getPropertyName:function(){return this._propertyName},isInterested:function(e){return this._propertyType==="style"&&!e.IStyle?!1:this._propertyType==="accessor"&&this._valueFunction===this.getValue&&!e[this._getter]?!1:!0},getValue:function(e){return this._propertyType==="accessor"?e[this._getter]():this._propertyType==="style"&&e.getStyle?e.getStyle(this._propertyName):this._propertyType==="client"&&e.getClient?e.getClient(this._propertyName):null}}),n.SelectionModel=function(e){n.SelectionModel.superClass.constructor.apply(this,arguments),this._selectionMode="multipleSelection",this._selectionList=new C,this._selectionChangeDispatcher=new n.EventDispatcher,this._selectionMap={},this._setDataBox(e)},n.extend(n.SelectionModel,n.PropertyChangeDispatcher,{getSelectionMode:function(){return this._selectionMode},setSelectionMode:function(e){if(this._selectionMode===e)return;if(e!=="noneSelection"&&e!=="singleSelection"&&e!=="multipleSelection")return;this.clearSelection();var t=this._selectionMode;this._selectionMode=e,this.firePropertyChange("selectionMode",t,this._selectionMode)},getDataBox:function(){return this._dataBox},_setDataBox:function(e){if(!e)throw"dataBox can not be null";if(this._dataBox===e)return;this._dataBox&&(this.clearSelection(),this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this));var t=this._dataBox;this._dataBox=e,this._dataBox.addDataBoxChangeListener(this.handleDataBoxChange,this,!0),this.firePropertyChange("dataBox",t,this._dataBox)},dispose:function(){this.clearSelection(),this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this)},handleDataBoxChange:function(e){if(e.kind==="remove"){var t=e.data;this.contains(t)&&(this._selectionList.remove(t),delete this._selectionMap[t.getId()],this.fireSelectionChange("remove",new C(t))),t._selected=!1}else e.kind==="clear"&&this.clearSelection()},getFilterFunction:function(){return this._filterFunction},setFilterFunction:function(e){if(this._filterFunction===e)return;this.clearSelection();var t=this._filterFunction;this._filterFunction=e,this.firePropertyChange("filterFunction",t,this._filterFunction)},fireSelectionChange:function(e,t,n){n&&(this._selectionList.forEach(function(e){n.contains(e)?n.remove(e):n.add(e)}),t=n.toList()),this._selectionChangeDispatcher.fire({kind:e,datas:new C(t)})},addSelectionChangeListener:function(e,t,n){this._selectionChangeDispatcher.add(e,t,n)},removeSelectionChangeListener:function(e,t){this._selectionChangeDispatcher.remove(e,t)},_filterList:function(e,t){var n=new C(e);for(var r=0;r<n.size();r++){var i=n.get(r);if(this._filterFunction&&!this._filterFunction(i)||t&&this.contains(i)||!t&&!this.contains(i)||!this._dataBox.contains(i))n.removeAt(r),r--}return n},appendSelection:function(e){if(this._selectionMode==="noneSelection")return;var t=this._filterList(e,!0);if(t.isEmpty())return;var n=null;this._selectionMode==="singleSelection"&&(n=new C(this._selectionList),this._selectionList.forEach(function(e){e._selected=!1}),this._selectionList.clear(),this._selectionMap={},t=new C(t.get(t.size()-1)));for(var r=0;r<t.size();r++){var i=t.get(r);i._selected=!0,this._selectionList.add(i),this._selectionMap[i._id]=i}this.fireSelectionChange("append",t,n)},removeSelection:function(e){var t=this._filterList(e);if(t.size()===0)return;for(var n=0;n<t.size();n++){var r=t.get(n);r._selected=!1,this._selectionList.remove(r),delete this._selectionMap[r.getId()]}this.fireSelectionChange("remove",t)},toSelection:function(e,t){return this._selectionList.toList(e,t)},getSelection:function(){return this._selectionList},setSelection:function(e){if(this._selectionMode==="noneSelection")return;if(this._selectionList.size()===0&&e==null)return;var t=new C(this._selectionList);this._selectionList.clear(),this._selectionMap={};var n=this._filterList(e,!0);this._selectionMode==="singleSelection"&&n.size()>1&&(n=new C(n.get(n.size()-1)));for(var r=0;r<n.size();r++){var i=n.get(r);i._selected=!0,this._selectionList.add(i),this._selectionMap[i.getId()]=i}this.fireSelectionChange("set",null,t)},clearSelection:function(){if(this._selectionList.size()>0){var e=this._selectionList.toList();this._selectionList.forEach(function(e){e._selected=!1}),this._selectionList.clear(),this._selectionMap={},this.fireSelectionChange("clear",e)}},selectAll:function(){if(this._selectionMode==="noneSelection")return;var e=this._dataBox.toDatas(),t=0,n=null;if(this._filterFunction)for(t=0;t<e.size();t++)n=e.get(t),this._filterFunction(n)||(e.removeAt(t),t--);var r=new C(this._selectionList);this._selectionList.clear(),this._selectionMap={},this._selectionMode==="singleSelection"&&e.size()>1&&(e=new C(e.get(e.size()-1)));for(t=0;t<e.size();t++)n=e.get(t),this._selectionList.add(n),this._selectionMap[n.getId()]=n;this.fireSelectionChange("all",null,r)},size:function(){return this._selectionList.size()},contains:function(e){return e?this._selectionMap[e._id]!=null:!1},getLastData:function(){return this._selectionList.size()>0?this._selectionList.get(this._selectionList.size()-1):null},getFirstData:function(){return this._selectionList.size()>0?this._selectionList.get(0):null},isSelectable:function(e){return e?this._selectionMode==="noneSelection"?!1:this._filterFunction&&!this._filterFunction(e)?!1:!0:!1}}),n.AlarmSeverity=function(e,t,n,r,i){this.value=e,this.name=t,this.nickName=n,this.color=r,this.displayName=i},n.extend(n.AlarmSeverity,Object,{toString:function(){return this.displayName?this.displayName:this.name}}),function(){var e=n.AlarmSeverity;e.severities=new C,e._vm={},e._nm={},e._cp=function(e,t){if(e&&t){var n=e.value-t.value;return n>0?1:n<0?-1:0}return e&&!t?1:!e&&t?-1:0},e.forEach=function(t,n){e.severities.forEach(t,n)},e.getSortFunction=function(){return e._cp},e.setSortFunction=function(t){e._cp=t,e.severities.sort(t)},e.add=function(t,n,r,i,o){var u=new e(t,n,r,i,o);return e._vm[t]=u,e._nm[n]=u,e.severities.add(u),e.severities.sort(e._cp),u},e.remove=function(t){var n=e._nm[t];return n&&(delete e._nm[t],delete e._vm[n.value],e.severities.remove(n)),n},e.CRITICAL=e.add(500,"Critical","C","#FF0000"),e.MAJOR=e.add(400,"Major","M","#FFA000"),e.MINOR=e.add(300,"Minor","m","#FFFF00"),e.WARNING=e.add(200,"Warning","W","#00FFFF"),e.INDETERMINATE=e.add(100,"Indeterminate","N","#C800FF"),e.CLEARED=e.add(0,"Cleared","R","#00FF00"),e.isClearedAlarmSeverity=function(e){return e?e.value===0:!1},e.getByName=function(t){return e._nm[t]},e.getByValue=function(t){return e._vm[t]},e.clear=function(){e.severities.clear(),e._vm={},e._nm={}},e.compare=function(t,n){return e._cp(t,n)}}(),n.AlarmState=function(e){this._e=e,this._nm={},this._am={},this._ps=null,this._haa=null,this._hna=null,this._hoa=null,this._hta=null,this._hls=!1,this._aac=0,this._nac=0},n.extend(n.AlarmState,Object,{_ep:!0,_f:function(){this._c1(),this._c2(),this._c3(),this._c4(),this._c5(),this._c6(),this._c7(),this._e.firePropertyChange("alarmState",null,this)},getHighestAcknowledgedAlarmSeverity:function(){return this._haa},getHighestNewAlarmSeverity:function(){return this._hna},getHighestOverallAlarmSeverity:function(){return this._hoa},getHighestNativeAlarmSeverity:function(){return this._hta},hasLessSevereNewAlarms:function(){return this._hls},_c1:function(){var e=null;for(var t in this._am){t=n.AlarmSeverity.getByName(t);if(n.AlarmSeverity.isClearedAlarmSeverity(t))continue;if(this.getAcknowledgedAlarmCount(t)===0)continue;e?e=n.AlarmSeverity.compare(e,t)>0?e:t:e=t}this._haa=e},_c2:function(){var e=null;for(var t in this._nm){t=n.AlarmSeverity.getByName(t);if(n.AlarmSeverity.isClearedAlarmSeverity(t))continue;if(this.getNewAlarmCount(t)===0)continue;e?e=n.AlarmSeverity.compare(e,t)>0?e:t:e=t}this._hna=e},_c3:function(){if(!this._hna){this._hls=!1;return}for(var e in this._nm){e=n.AlarmSeverity.getByName(e);if(n.AlarmSeverity.isClearedAlarmSeverity(e))continue;if(this.getNewAlarmCount(e)===0)continue;if(n.AlarmSeverity.compare(this._hna,e)>0){this._hls=!0;return}}this._hls=!1},_c4:function(){var e=this._haa,t=this._hna,r=this._ps;this._hoa=e,n.AlarmSeverity.compare(t,this._hoa)>0&&(this._hoa=t),n.AlarmSeverity.compare(r,this._hoa)>0&&(this._hoa=r)},_c5:function(){var e=this._haa,t=this._hna;this._hta=e,n.AlarmSeverity.compare(t,this._hta)>0&&(this._hta=t)},increaseAcknowledgedAlarm:function(e,t){t==null&&(t=1);if(t===0)return;var n=this._am[e.name];n==null&&(n=0),n+=t,this._am[e.name]=n,this._f(),this._e.onAlarmChange()},increaseNewAlarm:function(e,t){t==null&&(t=1);if(t===0)return;var n=this._nm[e.name];n==null&&(n=0),n+=t,this._nm[e.name]=n,this._f(),this._e.onAlarmChange()},decreaseAcknowledgedAlarm:function(e,t){t==null&&(t=1);if(t===0)return;var n=this._am[e.name];n==null&&(n=0),n-=t;if(n<0)throw"Alarm count can not be negative";this._am[e.name]=n,this._f(),this._e.onAlarmChange()},decreaseNewAlarm:function(e,t){t==null&&(t=1);if(t===0)return;var n=this._nm[e.name];n==null&&(n=0),n-=t;if(n<0)throw"Alarm count can not be negative";this._nm[e.name]=n,this._f(),this._e.onAlarmChange()},acknowledgeAlarm:function(e){this.decreaseNewAlarm(e,1),this.increaseAcknowledgedAlarm(e,1)},acknowledgeAllAlarms:function(e){if(e){var t=this.getNewAlarmCount(e);this.decreaseNewAlarm(e,t),this.increaseAcknowledgedAlarm(e,t)}else for(var r in this._nm)this.acknowledgeAllAlarms(n.AlarmSeverity.getByName(r))},_c6:function(){this._aac=0;for(var e in this._am)e=n.AlarmSeverity.getByName(e),this._aac+=this.getAcknowledgedAlarmCount(e)},getAcknowledgedAlarmCount:function(e){if(e){var t=this._am[e.name];return t==null?0:t}return this._aac},getAlarmCount:function(e){return this.getAcknowledgedAlarmCount(e)+this.getNewAlarmCount(e)},_c7:function(){this._nac=0;for(var e in this._nm)e=n.AlarmSeverity.getByName(e),this._nac+=this.getNewAlarmCount(e)},getNewAlarmCount:function(e){if(e){var t=this._nm[e.name];return t==null?0:t}return this._nac},setNewAlarmCount:function(e,t){this._nm[e.name]=t,this._f()},removeAllNewAlarms:function(e){e?delete this._nm[e]:this._nm={},this._f()},setAcknowledgedAlarmCount:function(e,t){this._am[e.name]=t,this._f()},removeAllAcknowledgedAlarms:function(e){e?delete this._am[e.name]:this._am={},this._f()},isEmpty:function(){return this._hoa==null},clear:function(){this._am={},this._nm={},this._f()},getPropagateSeverity:function(){return this._ps},setPropagateSeverity:function(e){this._ep||(e=null);if(this._ps===e)return;var t=this._ps;this._ps=e,this._f(),this._e.onAlarmChange(),this._e.firePropertyChange("propagateSeverity",t,e)},isEnablePropagation:function(){return this._ep},setEnablePropagation:function(e){var t=this._ep;this._ep=e,this._e.firePropertyChange("enablePropagation",t,e)&&(e||this.setPropagateSeverity(null))}}),n.Alarm=function(e,t,r,i,s){n.Data.call(this,e),this._id=e!=null?e:n.id("A"),this._elementId=t,this._alarmSeverity=r,this._acked=i||!1,this._cleared=s||!1},n.extend(n.Alarm,n.Data,{IAlarm:!0,getElementId:function(){return this._elementId},___accessor:["acked","cleared","alarmSeverity"]}),n.AlarmBox=function(e){if(!e)throw"elementBox can not be null.";n.AlarmBox.superClass.constructor.call(this),this._elementBox=e,this._alarmElementMapping=new n.AlarmElementMapping(this,e),this._elementBox.addDataBoxChangeListener(this.handleElementBoxChange,this,!0),this.addDataBoxChangeListener(this.handleAlarmBoxChange,this,!0),this.addDataPropertyChangeListener(this.handleAlarmPropertyChange,this,!0)},n.extend(n.AlarmBox,n.DataBox,{__accessor:["removeAlarmWhenElementIsRemoved"],_name:"AlarmBox",_removeAlarmWhenAlarmIsCleared:!1,_removeAlarmWhenElementIsRemoved:!0,getElementBox:function(){return this._elementBox},isRemoveAlarmWhenAlarmIsCleared:function(){return this._removeAlarmWhenAlarmIsCleared},setRemoveAlarmWhenAlarmIsCleared:function(e){var t=this._removeAlarmWhenAlarmIsCleared;this._removeAlarmWhenAlarmIsCleared=e,this.firePropertyChange("removeAlarmWhenAlarmIsCleared",t,e);if(e)for(var n in this.datas){var r=this.datas[n];r.isCleard()&&this.remove(r)}},getAlarmElementMapping:function(){return this._alarmElementMapping},setAlarmElementMapping:function(e){if(!e)throw"alarmElementMapping can not be null";if(this._alarmElementMapping===e)return;var t=this._alarmElementMapping;this.getDatas().forEach(this._decreaseAlarmState,this),this._alarmElementMapping=e,this.getDatas().forEach(this._increaseAlarmState,this),this.firePropertyChange("alarmElementMapping",t,e)},handleElementBoxChange:function(e){e.kind==="add"?this.handleElementAdded(e.data):e.kind==="remove"?(this.handleElementRemoved(e.data),this._removeAlarmWhenElementIsRemoved&&this.removeAlarmsByElement(e.data)):e.kind==="clear"&&(e.datas.forEach(this.handleElementRemoved,this),this._removeAlarmWhenElementIsRemoved&&this.clear())},handleAlarmBoxChange:function(e){e.kind==="add"?this._increaseAlarmState(e.data):e.kind==="remove"?this._decreaseAlarmState(e.data):e.kind==="clear"&&e.datas.forEach(this._decreaseAlarmState,this)},handleAlarmPropertyChange:function(e){var t=e.source;t.isCleared()||(e.property==="alarmSeverity"?this.handleAlarmSeverityChange(t,e):e.property==="acked"&&this.handleAckedChange(t,e)),e.property==="cleared"&&(t.isCleared()?(this._decreaseAlarmState(t,!0),this._removeAlarmWhenAlarmIsCleared&&this.remove(t)):this._increaseAlarmState(t,!0))},handleAckedChange:function(e,t){if(!e.getAlarmSeverity())return;var n=this.getCorrespondingElements(e);if(n)for(var r=0;r<n.size();r++){var i=n.get(r);t.oldValue?i.getAlarmState().decreaseAcknowledgedAlarm(e.getAlarmSeverity()):i.getAlarmState().decreaseNewAlarm(e.getAlarmSeverity()),t.newValue?i.getAlarmState().increaseAcknowledgedAlarm(e.getAlarmSeverity()):i.getAlarmState().increaseNewAlarm(e.getAlarmSeverity())}},handleAlarmSeverityChange:function(e,t){var n=t.oldValue,r=t.newValue,i=this.getCorrespondingElements(e);if(i)for(var s=0;s<i.size();s++){var o=i.get(s);n&&(e.isAcked()?o.getAlarmState().decreaseAcknowledgedAlarm(n):o.getAlarmState().decreaseNewAlarm(n)),r&&(e.isAcked()?o.getAlarmState().increaseAcknowledgedAlarm(r):o.getAlarmState().increaseNewAlarm(r))}},getCorrespondingAlarms:function(e){return this._alarmElementMapping.getCorrespondingAlarms(e)},getCorrespondingElements:function(e){return this._alarmElementMapping.getCorrespondingElements(e)},handleElementAdded:function(e){var t=this.getCorrespondingAlarms(e);if(t)for(var n=0;n<t.size();n++){var r=t.get(n);if(r.isCleared())continue;var i=r.getAlarmSeverity();i&&(r.isAcked()?e.getAlarmState().increaseAcknowledgedAlarm(i):e.getAlarmState().increaseNewAlarm(i))}},_increaseAlarmState:function(e,t){if(e.isCleared()&&!t)return;var n=e.getAlarmSeverity();if(n){var r=this.getCorrespondingElements(e);if(r)for(var i=0;i<r.size();i++){var s=r.get(i);e.isAcked()?s.getAlarmState().increaseAcknowledgedAlarm(n):s.getAlarmState().increaseNewAlarm(n)}}},_decreaseAlarmState:function(e,t){e.isCleared||console.log();if(e.isCleared()&&!t)return;var n=e.getAlarmSeverity();if(!n)return;var r=this.getCorrespondingElements(e);if(r)for(var i=0;i<r.size();i++){var s=r.get(i);e.isAcked()?s.getAlarmState().decreaseAcknowledgedAlarm(n):s.getAlarmState().decreaseNewAlarm(n)}},handleElementRemoved:function(e){var t=this.getCorrespondingAlarms(e);t&&t.forEach(function(t){!t.isCleared()&&t.getAlarmSeverity()&&(t.isAcked()?e.getAlarmState().decreaseAcknowledgedAlarm(t.getAlarmSeverity()):e.getAlarmState().decreaseNewAlarm(t.getAlarmSeverity()))})},removeAlarmsByElement:function(e){var t=this.getCorrespondingAlarms(e);t&&t.forEach(this.remove,this)},add:function(e,t){if(!e.IAlarm)throw"Only IAlarm can be added into AlarmBox";if(this._removeAlarmWhenAlarmIsCleared&&e.isCleared())return;n.AlarmBox.superClass.add.apply(this,arguments)}}),n.AlarmElementMapping=function(e,t){if(!t)throw"ElementBox can not be null";if(!e)throw"AlarmBox can not be null";this._elementBox=t,this._alarmBox=e,this._alarmsFinder=new n.QuickFinder(e,"elementId")},n.extend(n.AlarmElementMapping,Object,{getCorrespondingAlarms:function(e){return this._alarmsFinder.find(e.getId())},getCorrespondingElements:function(e){var t=this._elementBox.getDataById(e.getElementId());return new C(t)},dispose:function(){delete this._elementBox,delete this._alarmBox,delete this._alarmsFinder}}),n.PropertyPropagator=function(e,t,r){if(!e)throw"dataBox can not be null";if(!t)throw"propertyName can not be null";this._dataBox=e,this._propertyName=t,this._propertyType=r||"accessor",this._propertyType==="accessor"&&(this._getter=n.getter(t),this._setter=n.setter(t)),this._enable=!1,this._isPropagating=!1},n.extend(n.PropertyPropagator,Object,{getDataBox:function(){return this._dataBox},getPropertyType:function(){return this._propertyType},getPropertyName:function(){return this._propertyName},isEnable:function(){return this._enable},setEnable:function(e){if(this._enable===e)return;this._enable=e;if(this._enable){this._dataBox.addDataBoxChangeListener(this.handleDataBoxChange,this),this._dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this);for(var t in this._dataBox.datas)this.propagate(this._dataBox.datas[t])}else this._dataBox.removeDataBoxChangeListener(this.handleDataBoxChange,this),this._dataBox.removeDataPropertyChangeListener(this.handleDataPropertyChange,this)},handleDataBoxChange:function(e){e.data&&this.propagate(e.data)},handleDataPropertyChange:function(e){if(this.isInterestedProperty(e))this.propagate(e.source);else if(e.property==="parent"){var t=e.oldValue;t&&this.propagate(t),this.propagate(e.source)}},isInterestedProperty:function(e){return this._propertyType==="accessor"&&this._propertyName===e.property?!0:this._propertyType==="style"&&e.IElement&&"S:"+this._propertyName===e.property?!0:this._propertyType==="client"&&"C:"+this._propertyName===e.property?!0:!1},propagate:function(e){if(!e||this._isPropagating)return;this._isPropagating=!0,this.propagateToTop(e),this._isPropagating=!1},propagateToTop:function(e){this.propagateToParent(null,e);while(e&&e.getParent())this.propagateToParent(e,e.getParent()),e=e.getParent()},propagateToParent:function(e,t){}}),n.AlarmStatePropagator=function(e){n.AlarmStatePropagator.superClass.constructor.call(this,e,"alarmState")},n.extend(n.AlarmStatePropagator,n.PropertyPropagator,{handleDataPropertyChange:function(e){e.property==="enablePropagation"?this.propagate(e.source):n.AlarmStatePropagator.superClass.handleDataPropertyChange.call(this,e)},propagateToParent:function(e,t){var r=null;t.getChildren().forEach(function(e){var t=e.getAlarmState().getHighestOverallAlarmSeverity();n.AlarmSeverity.compare(t,r)>0&&(r=t)}),t.getAlarmState&&t.getAlarmState().setPropagateSeverity(r)}});var P={KEEP_DEFAULT_FUNCTION:function(e){return e.target.keepDefault||e.target.getAttribute("keepDefault")?!0:e.target.parentNode&&(e.target.parentNode.keepDefault||e.target.parentNode.getAttribute("keepDefault"))?!0:e.shiftKey?!0:!1}};P.paintSortFunction=function(e,t){return e.z!==t.z?e.z-t.z:0},P.doubleClickToLookAtFunction=function(e){return!0},P.needSmoothNormalFunction=function(e){var t=e instanceof _||e instanceof n.TextNode||e instanceof n.PathCube||e instanceof n.ShapeNode||e instanceof n.ComboNode||e.getClassName()=="TGL.Entity";return!t},P.PATH_LINK_COMPUTE_DELAY=!1,n.Defaults=P,n.ShaderChunk={gradient_parts_fragment:["#ifdef MAX_GRADIENT","uniform vec3 gradientColor[MAX_GRADIENT];","uniform float gradientStop[MAX_GRADIENT];","uniform int gradientType;","#endif"].join("\n"),gradient_basic_fragment:["#ifdef MAX_GRADIENT","float gradientUV = 1.0;","float PI = 3.14;","if(gradientType == 1){","gradientUV = oUv.x;","} else if(gradientType == 2){","gradientUV = oUv.y;","} else if(gradientType == 3){","gradientUV = (oUv.x + oUv.y)/2.0;","} else if(gradientType == 4){","gradientUV = (oUv.x + 1.0 - oUv.y)/2.0;","} else if(gradientType == 5){","gradientUV = 1.414 * sqrt((oUv.x - 0.5) * (oUv.x - 0.5) + (oUv.y - 0.5) * (oUv.y - 0.5));","} else if(gradientType == 6){","gradientUV = (atan(oUv.y - 0.5,oUv.x - 0.5)) / (2.0 * PI);","if(gradientUV < 0.0){","gradientUV = 1.0 + gradientUV;","}","}","for( int i = 1; i < MAX_GRADIENT; i ++ ){","if(gradientStop[i - 1] <= gradientUV){","if((gradientStop[i] >= gradientUV)){","vec3 color1 = gradientColor[i-1];","vec3 color2 = gradientColor[i];","float stop1 = gradientStop[i-1];","float stop2 =gradientStop[i]; ","gl_FragColor = vec4( (color1 * (stop2 - gradientUV )  + color2 * (gradientUV - stop1))/(stop2 - stop1),opacity);","break;","}","}","}","#endif"].join("\n"),gradient_phong_fragment:["#ifdef MAX_GRADIENT","float gradientUV = 1.0;","float PI = 3.14;","if(gradientType == 1){","gradientUV = oUv.x;","} else if(gradientType == 2){","gradientUV = oUv.y;","} else if(gradientType == 3){","gradientUV = (oUv.x + oUv.y)/2.0;","} else if(gradientType == 4){","gradientUV = (oUv.x + 1.0 - oUv.y)/2.0;","} else if(gradientType == 5){","gradientUV = 1.414 * sqrt((oUv.x - 0.5) * (oUv.x - 0.5) + (oUv.y - 0.5) * (oUv.y - 0.5));","} else if(gradientType == 6){","gradientUV = (atan(oUv.y - 0.5,oUv.x - 0.5)) / (2.0 * PI);","if(gradientUV < 0.0){","gradientUV = 1.0 + gradientUV;","}","}","for( int i = 1; i < MAX_GRADIENT; i ++ ){","if(gradientStop[i - 1] < gradientUV){","if((gradientStop[i] > gradientUV)){","vec3 color1 = gradientColor[i-1];","vec3 color2 = gradientColor[i];","float stop1 = gradientStop[i-1];","float stop2 = gradientStop[i]; ","tempDiffuse = (color1 * (stop2 - gradientUV )  + color2 * (gradientUV - stop1))/(stop2 - stop1);","break;","}","}","}","#endif"].join("\n"),fog_pars_fragment:["#ifdef USE_FOG","uniform vec3 fogColor;","#ifdef FOG_EXP2","uniform float fogDensity;","#else","uniform float fogNear;","uniform float fogFar;","#endif","#endif"].join("\n"),fog_fragment:["#ifdef USE_FOG","float depth = gl_FragCoord.z / gl_FragCoord.w;","#ifdef FOG_EXP2","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","#else","float fogFactor = smoothstep( fogNear, fogFar, depth );","#endif","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","#endif"].join("\n"),envmap_pars_fragment:["#ifdef USE_ENVMAP","uniform float reflectivity;","uniform samplerCube envMap;","uniform float flipEnvMap;","uniform int combine;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","uniform bool useRefract;","uniform float refractionRatio;","#else","varying vec3 vReflect;","#endif","#endif"].join("\n"),envmap_fragment:["#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","reflectVec = refract( cameraToVertex, normal, refractionRatio );","} else { ","reflectVec = reflect( cameraToVertex, normal );","}","#else","reflectVec = vReflect;","#endif","#ifdef DOUBLE_SIDED","float flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );","vec4 cubeColor = textureCube( envMap, flipNormal * vec3( reflectVec.x*flipEnvMap,  reflectVec.y,reflectVec.z) );","#else","vec4 cubeColor = textureCube( envMap, vec3(reflectVec.x*flipEnvMap,  reflectVec.y,reflectVec.z) );","#endif","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","#ifdef PHONG","#else","float specularStrength = 1.0;","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n"),envmap_pars_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","varying vec3 vReflect;","uniform float refractionRatio;","uniform bool useRefract;","#endif"].join("\n"),worldpos_vertex:["#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP ) ","#ifdef USE_SKINNING","vec4 worldPosition = modelMatrix * skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif"].join("\n"),envmap_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, worldNormal, refractionRatio );","} else {","vReflect = reflect( cameraToVertex, worldNormal );","}","#endif"].join("\n"),map_particle_pars_fragment:["#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_particle_fragment:["#ifdef USE_MAP","gl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );","#endif"].join("\n"),map_pars_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined(MAX_GRADIENT)","varying vec2 vUv;","varying vec2 oUv;","uniform vec4 offsetRepeat;","uniform bool flipX; ","#endif"].join("\n"),map_pars_fragment:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined(MAX_GRADIENT)","varying vec2 vUv;","varying vec2 oUv;","#endif","#ifdef USE_MAP","uniform bool mapLoaded;","uniform sampler2D map;","#endif"].join("\n"),map_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined(MAX_GRADIENT)","if(flipX){","vUv.x = uv.x * offsetRepeat.z * (-1.0) + offsetRepeat.x + offsetRepeat.z;","vUv.y = uv.y * offsetRepeat.w  + offsetRepeat.y;","}else{","vUv = uv * offsetRepeat.zw  + offsetRepeat.xy;","}","oUv = uv;","#endif"].join("\n"),map_fragment:["#ifdef USE_MAP","if(mapLoaded){","vec4 texelColor = texture2D( map, vUv );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","gl_FragColor = texelColor * gl_FragColor;","}","#endif"].join("\n"),lightmap_pars_fragment:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","uniform sampler2D lightMap;","#endif"].join("\n"),lightmap_pars_vertex:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","#endif"].join("\n"),lightmap_fragment:["#ifdef USE_LIGHTMAP","gl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );","#endif"].join("\n"),lightmap_vertex:["#ifdef USE_LIGHTMAP","vUv2 = uv2;","#endif"].join("\n"),bumpmap_pars_fragment:["#ifdef USE_BUMPMAP","uniform sampler2D bumpMap;","uniform float bumpScale;","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#ifdef USE_NORMALMAP","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( vUv.st );","vec2 st1 = dFdy( vUv.st );","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","vec4 texelSpecular = texture2D( specularMap, vUv );","specularStrength = texelSpecular.r;","#else","specularStrength = uspecularStrength;","#endif"].join("\n"),lights_lambert_pars_vertex:["uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0"
,"uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif"].join("\n"),lights_lambert_vertex:["vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0 ","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_HEMI_LIGHTS > 0","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","float hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;","vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","#ifdef DOUBLE_SIDED","vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );","#endif","}","#endif","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif"].join("\n"),lights_phong_pars_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","varying vec3 vWorldPosition;","#endif"].join("\n"),lights_phong_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ","vWorldPosition = worldPosition.xyz;","#endif"].join("\n"),lights_phong_pars_fragment:["uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","varying vec3 vWorldPosition;","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),lights_phong_fragment:["vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -viewPosition, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lDistance = vPointLight[ i ].w;","#endif","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dotProduct, 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dotProduct, 0.0 );","#endif","pointDiffuse  += tempDiffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;","#else","pointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lDistance = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ]) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dotProduct, 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dotProduct, 0.0 );","#endif","spotDiffuse += tempDiffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","vec3 spotHalfVector = normalize( lVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;","#else","spotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += tempDiffuse * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += tempDiffuse * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlickSky = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","float ssao = 1.0;","#ifdef USE_SSAO","ssao = clamp(1.0 - texture2D(mapSSAO, (finalPosition.xy / finalPosition.w / 2.0 + vec2(0.5,0.5))).x,0.0,1.0);","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + (ambientLightColor * ambient * ssao) + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + (ambientLightColor * ambient) * ssao ) + totalSpecular;","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","gl_FragColor = gl_FragColor * vec4( vColor, opacity );","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","#ifdef GAMMA_INPUT","vColor = color * color;","#else","vColor = color;","#endif","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef BONE_TEXTURE","uniform sampler2D boneTexture;","mat4 getBoneMatrix( const in float i ) {","float j = i * 4.0;","float x = mod( j, N_BONE_PIXEL_X );","float y = floor( j / N_BONE_PIXEL_X );","const float dx = 1.0 / N_BONE_PIXEL_X;","const float dy = 1.0 / N_BONE_PIXEL_Y;","y = dy * ( y + 0.5 );","vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );","vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );","vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );","vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );","mat4 bone = mat4( v1, v2, v3, v4 );","return bone;","}","#else","uniform mat4 boneGlobalMatrices[ MAX_BONES ];","mat4 getBoneMatrix( const in float i ) {","mat4 bone = boneGlobalMatrices[ int(i) ];","return bone;","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHTARGETS","vec4 skinVertex = vec4( morphed, 1.0 );","#else","vec4 skinVertex = vec4( position, 1.0 );","#endif","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","#ifndef USE_MORPHNORMALS","uniform float morphTargetInfluences[ 8 ];","#else","uniform float morphTargetInfluences[ 4 ];","#endif","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#ifndef USE_MORPHNORMALS","morphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];","morphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];","morphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];","morphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];","#endif","morphed += position;","#endif"].join("\n"),default_vertex:["vec4 mvPosition;","#ifdef USE_SKINNING","mvPosition = modelViewMatrix * skinned;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( morphed, 1.0 );","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( position, 1.0 );","#endif","gl_Position = projectionMatrix * mvPosition;"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","morphedNormal += normal;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix 	+= skinWeight.y * boneMatY;","#ifdef USE_MORPHNORMALS","vec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );","#else","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif","#endif"].join("\n"),defaultnormal_vertex:["vec3 objectNormal;","#ifdef USE_SKINNING","objectNormal = skinnedNormal.xyz;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )","objectNormal = morphedNormal;","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )","objectNormal = normal;","#endif","#ifdef FLIP_SIDED","objectNormal = -objectNormal;","#endif","vec3 transformedNormal = normalMatrix * objectNormal;"].join("\n"),shadowmap_pars_fragment:["#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","uniform vec2 shadowMapSize[ MAX_SHADOWS ];","uniform float shadowDarkness[ MAX_SHADOWS ];","uniform float shadowBias[ MAX_SHADOWS ];","varying vec4 vShadowCoord[ MAX_SHADOWS ];","#endif","#ifdef USE_POINT_SHADOWMAP","uniform sampler2D pShadowMap[MAX_POINT_SHADOWS];","uniform vec2 pShadowMapSize[ MAX_POINT_SHADOWS ];","uniform float pShadowDarkness[MAX_POINT_SHADOWS];","uniform float pShadowRadius [MAX_POINT_SHADOWS];","uniform float pShadowBias [MAX_POINT_SHADOWS];","uniform vec3 pPosition[MAX_POINT_SHADOWS];","uniform float shadowCameraNear;","uniform float shadowCameraFar;","varying vec4 pWorldPosition;","vec2 cubeToUV( vec3 v, float texelSizeY ) {","	vec3 absV = abs( v );","	float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );","	absV *= scaleToCube;","	v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );","	vec2 planar = v.xy;","	float almostATexel = 1.5 * texelSizeY;","	float almostOne = 1.0 - almostATexel;","	if ( absV.z >= almostOne ) {","		if ( v.z > 0.0 )","			planar.x = 4.0 - v.x;","		} else if ( absV.x >= almostOne ) {","		 	float signX = sign( v.x );","			planar.x = v.z * signX + 2.0 * signX;","		} else if ( absV.y >= almostOne ) {","			float signY = sign( v.y );","			planar.x = v.x + 2.0 * signY + 2.0;","			planar.y = v.z * signY - 2.0;","		}","	return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );","}","float unpack (vec4 colour){","const vec4 bitShifts = vec4(1.0,1.0 / 255.0,1.0 / (255.0 * 255.0),1.0 / (255.0 * 255.0 * 255.0));","return dot(colour, bitShifts) ;","}","float texture2DCompare( sampler2D depths, vec2 uv, float compare ){","	return step( compare, unpack( texture2D( depths, uv ) ) );","}","float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec3 lightToPosition, float shadowCameraNear, float shadowCameraFar ) {","	vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );","	float dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );","	dp += shadowBias;","	vec3 bd3D = normalize( lightToPosition );","	#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )","	vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;","	return (","	texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +","	texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +","	texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +","	texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +","	texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +","	texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +","	texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +","	texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +","	texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )","	) * ( 1.0 / 9.0 );","#else","	return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );","#endif","}","#endif","#if defined(USE_SHADOWMAP) || defined(USE_POINT_SHADOWMAP)","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","#endif"].join("\n"),shadowmap_fragment:["#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","#endif","float fDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","inFrustumCount += int( inFrustum );","bvec3 frustumTestVec = bvec3(inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );","#else","bvec2 frustumTestVec = bvec2(inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest) {","shadowCoord.z += shadowBias[ i ];","#if defined( SHADOWMAP_TYPE_PCF )","float shadow = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","mat3 depthKernel;","depthKernel[0][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( depthKernel[0][0] < shadowCoord.z ) shadowKernel[0][0] = 0.25;","else shadowKernel[0][0] = 0.0;","depthKernel[0][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( depthKernel[0][1] < shadowCoord.z ) shadowKernel[0][1] = 0.25;","else shadowKernel[0][1] = 0.0;","depthKernel[0][2] = unpackDepth( texture2D( shadowMap[ i], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( depthKernel[0][2] < shadowCoord.z ) shadowKernel[0][2] = 0.25;","else shadowKernel[0][2] = 0.0;","depthKernel[1][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( depthKernel[1][0] < shadowCoord.z ) shadowKernel[1][0] = 0.25;","else shadowKernel[1][0] = 0.0;","depthKernel[1][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( depthKernel[1][1] < shadowCoord.z ) shadowKernel[1][1] = 0.25;","else shadowKernel[1][1] = 0.0;","depthKernel[1][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( depthKernel[1][2] < shadowCoord.z ) shadowKernel[1][2] = 0.25;","else shadowKernel[1][2] = 0.0;","depthKernel[2][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( depthKernel[2][0] < shadowCoord.z ) shadowKernel[2][0] = 0.25;","else shadowKernel[2][0] = 0.0;","depthKernel[2][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( depthKernel[2][1] < shadowCoord.z ) shadowKernel[2][1] = 0.25;","else shadowKernel[2][1] = 0.0;","depthKernel[2][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( depthKernel[2][2] < shadowCoord.z ) shadowKernel[2][2] = 0.25;","else shadowKernel[2][2] = 0.0;","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[i].xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if ( fDepth < shadowCoord.z )","shadowColor = shadowColor * vec3( 1.0 - shadowDarkness[ i ] );","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef GAMMA_OUTPUT","shadowColor *= shadowColor;","#endif","gl_FragColor.xyz = gl_FragColor.xyz * shadowColor;","#endif","#ifdef USE_POINT_SHADOWMAP"," ","for( int i = 0; i < MAX_POINT_SHADOWS; i ++ ) {","vec3 lightToPosition = pWorldPosition.xyz - pPosition[i];","vec2 shadowMapSize = pShadowMapSize[i];","float shadow = getPointShadow(pShadowMap[i],shadowMapSize,pShadowBias[i],pShadowRadius[i],lightToPosition,shadowCameraNear,shadowCameraFar);","float darkness = 1.0 - pShadowDarkness[i];","gl_FragColor.xyz *= (darkness + (1.0 - darkness) * shadow);","}","#endif"].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","#endif","#ifdef USE_POINT_SHADOWMAP","varying vec4 pWorldPosition;","#endif"].join("\n"),shadowmap_vertex:["#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif","#ifdef USE_POINT_SHADOWMAP","pWorldPosition = modelMatrix * vec4(position,1.0);","#endif"].join("\n"),alphatest_fragment:["#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#endif"].join("\n")},n.UniformsUtils={merge:function(e){var t,n,r,i={};for(t=0;t<e.length;t++){r=this.clone(e[t]);for(n in r)i[n]=r[n]}return i},clone:function(e){var t,r,i,s,o={};for(t in e){o[t]={};for(r in e[t])s=e[t][r],s instanceof n.Color||s instanceof n.Vec2||s instanceof n.Vec3||s instanceof n.Vec4||s instanceof n.Mat4||s instanceof n.Texture?o[t][r]=s.clone():s instanceof Array?o[t][r]=s.slice():o[t][r]=s}return o}},n.UniformsLib={outline:{diffuse:{type:"c",value:new n.Color(15658734)},outline_offset:{type:"f",value:0}},glow:{map:{type:"t",value:null}},blur:{orientation:{type:"i",value:0},texelSize:{type:"v2",value:new n.Vec2(512,512)},blurAmount:{type:"i",value:10},blurScale:{type:"f",value:1},blurStrength:{type:"f",value:.2},map:{type:"t",value:null},useBlur:{type:"i",value:1},blurGlobalAlpha:{type:"f",value:1}},deferred:{linearDepth:{type:"f",value:9e3},isNormal:{type:"i",value:1}},ssao:{map0:{type:"t",value:null},map1:{type:"t",value:null},map2:{type:"t",value:null},occluderBias:{type:"f",value:.05},samplingRadius:{type
:"f",value:20},attenuation:{type:"v2",value:new o(1,0)},texelSize:{type:"v2",value:new o(1/512,1/512)}},common:{diffuse:{type:"c",value:new n.Color(15658734)},wireframeLinecolor:{type:"c",value:new n.Color(0)},wireframeLineopacity:{type:"f",value:1},opacity:{type:"f",value:1},map:{type:"t",value:null},mapLoaded:{type:"i",value:0},offsetRepeat:{type:"v4",value:new n.Vec4(0,0,1,1)},flipX:{type:"i",value:0},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},gradient:{gradientColor:{type:"v3v",value:[]},gradientStop:{type:"fv1",value:[]},gradientType:{type:"i",value:0}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new n.Vec2(1,1)}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new n.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new n.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new n.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]},pShadowMap:{type:"tv",value:[]},pShadowMapSize:{type:"v2v",value:[]},pShadowDarkness:{type:"fv1",value:[]},pShadowRadius:{type:"fv1",value:[]},pShadowBias:{type:"fv1",value:[]},pPosition:{type:"v3v",value:[]},shadowCameraNear:{type:"f",value:.1},shadowCameraFar:{type:"f",value:1e4}},gradientramp:{skyColor:{type:"c",value:new n.Color(16777215)},horizonColor:{type:"c",value:new n.Color(16777215)},earthColor:{type:"c",value:new n.Color(16777215)},skyY:{type:"f",value:0},horizonY:{type:"f",value:0},earthY:{type:"f",value:0}}},n.ShaderLib={outline:{uniforms:n.UniformsUtils.merge([n.UniformsLib.outline]),vertexShader:["uniform float outline_offset;","void main() {","vec4 mvPosition = modelViewMatrix * vec4( position + normalize(position)  * outline_offset, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","void main() {","gl_FragColor = vec4(diffuse, 1.0 );","}"].join("\n")},blur:{uniforms:n.UniformsUtils.merge([n.UniformsLib.blur]),vertexShader:["varying vec2 vUv;","void main (){","gl_Position = vec4(position, 1.0);","vUv = uv;","}"].join("\n"),fragmentShader:["uniform vec2 texelSize;","uniform sampler2D map;","uniform int orientation;","uniform int blurAmount;","uniform float blurScale;","uniform float blurStrength;","uniform int useBlur;","uniform float blurGlobalAlpha;","uniform sampler2D depthMap;","varying vec2 vUv;","float Gaussian (float x, float deviation){","return (1.0 / sqrt(2.0 * 3.141592 * deviation)) * exp(-((x * x) / (2.0 * deviation)));","}","void main (){","float halfBlur = float(blurAmount) * 0.5;","vec4 colour = vec4(0.0);","if(useBlur == 0){","colour = texture2D(map,vUv);","}else {","vec4 texColour = vec4(0.0);","float deviation = halfBlur * 0.35;","deviation *= deviation;","float strength = 1.0 - blurStrength;","if ( orientation == 0 ){","for (int i = 0; i < 20; ++i){","if ( i >= blurAmount ){","break;","}","float offset = float(i) - halfBlur;","texColour = texture2D(map, vUv + vec2(offset / texelSize.x * blurScale, 0.0)) * Gaussian(offset * strength, deviation);","colour += texColour;","}","}else{","for (int i = 0; i < 20; ++i){","if ( i >= blurAmount )","break;","float offset = float(i) - halfBlur;","texColour = texture2D(map, vUv + vec2(0.0, offset / texelSize.y * blurScale)) * Gaussian(offset * strength, deviation);","colour += texColour;","}","}","}","gl_FragColor = clamp(colour, 0.0, 1.0);","if(useBlur == 0){","gl_FragColor.w *=  gl_FragColor.w * gl_FragColor.w * gl_FragColor.w * blurGlobalAlpha;","}","}"].join("\n")},linex:{uniforms:{near:{type:"f",value:.1},opacity:{type:"f",value:1},viewport:{type:"v4",value:new n.Vec4(0)},lineColor:{type:"c",value:new n.Color(16777215)},modelViewProjectionMatrix:{type:"m4",value:new h},useVertexColor:{type:"i",value:0},totalSize:{type:"f",value:0},dashSize:{type:"f",value:0}},vertexShader:["attribute vec3 positionPrev;","attribute vec3 positionNext;","attribute float offset;","attribute float lineDistances;","varying  vec3 vColor;","varying float vLineDistance;","uniform mat4 modelViewProjectionMatrix;","uniform vec4 viewport;","uniform float near;","vec4 clipNear(vec4 p1,vec4 p2){","	float n = (p1.w - near) / (p1.w - p2.w);","	return vec4(mix(p1.xy,p2.xy,n),-near,near);","}","void main(){"," 	vLineDistance = lineDistances;","	vec4 prevProj = modelViewProjectionMatrix * vec4(positionPrev, 1.0);","	vec4 currProj = modelViewProjectionMatrix * vec4(position, 1.0);","	vec4 nextProj = modelViewProjectionMatrix * vec4(positionNext, 1.0);","	if (currProj.w < 0.0) {","		if (prevProj.w < 0.0) {","	 		currProj = clipNear(currProj, nextProj);","		}else {","			currProj = clipNear(currProj, prevProj);","		}","	}","	vec2 prevScreen = (prevProj.xy / abs(prevProj.w) + 1.0) * 0.5 * viewport.zw;","	vec2 currScreen = (currProj.xy / abs(currProj.w) + 1.0) * 0.5 * viewport.zw;","	vec2 nextScreen = (nextProj.xy / abs(nextProj.w) + 1.0) * 0.5 * viewport.zw;","	vec2 dir;","	float len = offset;","	if(position == positionPrev){","		dir = normalize(nextScreen - currScreen);","	}else if(position == positionNext){","		dir = normalize(currScreen - prevScreen);","	}else {","		vec2 dirA = normalize(currScreen - prevScreen);","		vec2 dirB = normalize(nextScreen - currScreen);","		vec2 tanget = normalize(dirA + dirB);","		float miter = 1.0 / max(dot(tanget,dirA),0.5);","		len *= miter;","		dir = tanget;","	}","	dir = vec2(-dir.y,dir.x) * len;","	currScreen += dir;","	currProj.xy = (currScreen / viewport.zw - 0.5) * 2.0 * abs(currProj.w);","	gl_Position = currProj;","	vColor = color;","}"].join("\n"),fragmentShader:["uniform vec3 lineColor;","uniform float opacity;","uniform int useVertexColor;","uniform float totalSize;","uniform float dashSize;","varying  vec3 vColor;","varying float vLineDistance;","void main (){","	if(totalSize > dashSize && dashSize > 0.0){","	     if ( mod( vLineDistance, totalSize ) > (totalSize - dashSize) ) {","			discard;","		}","	}","	if(useVertexColor == 0){","		gl_FragColor = vec4(lineColor,opacity);","	}else{","		gl_FragColor = vec4(vColor,opacity);","	}","}"].join("\n")},lensflare:{uniforms:{renderType:{type:"i",value:2},screenPosition:{type:"v3",value:new n.Vec3(0)},scale:{type:"v2",value:new n.Vec2(0)},rotation:{type:"f",value:0},occlusionMap:{type:"t",value:null},map:{type:"t",value:null}},vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if ( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility =        visibility.r / 9.0;","vVisibility *= 1.0 - visibility.g / 9.0;","vVisibility *=       visibility.b / 9.0;","vVisibility *= 1.0 - visibility.a / 9.0;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if ( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if ( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},deferred:{uniforms:n.UniformsUtils.merge([n.UniformsLib.deferred]),vertexShader:["varying vec4 vPosition;","varying vec3 vNormal;","void main (){","vNormal = mat3(modelViewMatrix) * normal;","vPosition = modelViewMatrix * vec4(position, 1.0);","gl_Position = projectionMatrix * vPosition;","}"].join("\n"),fragmentShader:["uniform float linearDepth;","uniform int isNormal;","varying vec4 vPosition;","varying vec3 vNormal;","void main (){","float linear_depth = length(vPosition) / linearDepth;","if(isNormal == 1){","vec3 normal = normalize(vNormal);","gl_FragColor = vec4(normal.x, normal.y, normal.z, 1.0);","}else{","gl_FragColor = vec4(vPosition.x, vPosition.y, vPosition.z, linear_depth);","}","}"].join("\n")},ssao:{uniforms:n.UniformsUtils.merge([n.UniformsLib.ssao]),vertexShader:["varying vec2 vUv;","void main (){","gl_Position = vec4(position, 1.0);","vUv = uv;","}"].join("\n"),fragmentShader:["uniform sampler2D map0;","uniform sampler2D map1;","uniform sampler2D map2;","uniform vec2 texelSize;","uniform float occluderBias;","uniform float samplingRadius;","uniform vec2 attenuation;","varying vec2 vUv;","float samplePixels (vec3 srcPosition, vec3 srcNormal, vec2 uv){","vec3 dstPosition = texture2D(map0, uv).xyz;","vec3 positionVec = dstPosition - srcPosition;","float intensity = max(dot(normalize(positionVec), srcNormal) - occluderBias, 0.0);","float dist = length(positionVec);","float attenuationValue = 1.0 / (attenuation.x + (attenuation.y * dist));","return intensity * attenuationValue;","}","void main (){","vec3 srcPosition = texture2D(map0, vUv).xyz;","vec3 srcNormal = texture2D(map1, vUv).xyz;","vec2 randVec = normalize(texture2D(map2, vUv).xy * 2.0 - 1.0);","float srcDepth = texture2D(map0, vUv).w;","float kernelRadius = samplingRadius * (1.0 - srcDepth);","vec2 kernel[4];","kernel[0] = vec2(0.0, 1.0);","kernel[1] = vec2(1.0, 0.0);","kernel[2] = vec2(0.0, -1.0);","kernel[3] = vec2(-1.0, 0.0);","const float sin45 = 0.707107;","float occlusion = 0.0;","for (int i = 0; i < 4; ++i){","vec2 k1 = reflect(kernel[i], randVec);","vec2 k2 = vec2(k1.x * sin45 - k1.y * sin45,k1.x * sin45 + k1.y * sin45);","k1 *= texelSize;","k2 *= texelSize;","occlusion += samplePixels(srcPosition, srcNormal, vUv + k1 * kernelRadius);","occlusion += samplePixels(srcPosition, srcNormal, vUv + k2 * kernelRadius * 0.75);","occlusion += samplePixels(srcPosition, srcNormal, vUv + k1 * kernelRadius * 0.5);","occlusion += samplePixels(srcPosition, srcNormal, vUv + k2 * kernelRadius * 0.25);","}","occlusion /= 16.0;","occlusion = clamp(occlusion, 0.0, 1.0);","gl_FragColor =  vec4(occlusion,0.0,0.0,1.0);","}"].join("\n")},basic:{uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.gradient,n.UniformsLib.fog,n.UniformsLib.gradientramp]),vertexShader:[n.ShaderChunk.map_pars_vertex,n.ShaderChunk.lightmap_pars_vertex,n.ShaderChunk.envmap_pars_vertex,n.ShaderChunk.color_pars_vertex,n.ShaderChunk.morphtarget_pars_vertex,n.ShaderChunk.skinning_pars_vertex,n.ShaderChunk.shadowmap_pars_vertex,"varying vec3 vPosition;","void main() {",n.ShaderChunk.map_vertex,n.ShaderChunk.lightmap_vertex,n.ShaderChunk.color_vertex,n.ShaderChunk.skinbase_vertex,"#ifdef USE_ENVMAP",n.ShaderChunk.morphnormal_vertex,n.ShaderChunk.skinnormal_vertex,n.ShaderChunk.defaultnormal_vertex,"#endif",n.ShaderChunk.morphtarget_vertex,n.ShaderChunk.skinning_vertex,n.ShaderChunk.default_vertex,n.ShaderChunk.worldpos_vertex,n.ShaderChunk.envmap_vertex,n.ShaderChunk.shadowmap_vertex,"vPosition = position;","}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform vec3 wireframeLinecolor;","uniform float wireframeLineopacity;","uniform float opacity;","uniform vec3 skyColor;","uniform vec3 horizonColor;","uniform vec3 earthColor;","uniform float skyY;","uniform float horizonY;","uniform float earthY;","varying vec3 vPosition;",n.ShaderChunk.color_pars_fragment,n.ShaderChunk.map_pars_fragment,n.ShaderChunk.gradient_parts_fragment,n.ShaderChunk.lightmap_pars_fragment,n.ShaderChunk.envmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.specularmap_pars_fragment,"vec4 lerp (vec4 colora, vec4 colorb, float t) {","if(t >= 1.0){","return colorb;}","float r = mix(colora.r, colorb.r, t);","float g = mix(colora.g, colorb.g, t);","float b = mix(colora.b, colorb.b, t);","float a = mix(colora.a, colorb.a, t);","return vec4(r,g,b,a);","}","void main() {","#ifdef USE_WIREFRAME","float wireframeLineopacityValue = wireframeLineopacity * opacity;","if(skyY > earthY){","if(vPosition.y > horizonY){","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,wireframeLineopacityValue),vec4(skyColor ,wireframeLineopacityValue),dist/(skyY - horizonY));}","else{","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,wireframeLineopacityValue),vec4(earthColor ,wireframeLineopacityValue),dist/(horizonY - earthY));}","gl_FragColor = gl_FragColor * vec4( diffuse, wireframeLineopacityValue );","}","else{","gl_FragColor = vec4( wireframeLinecolor, wireframeLineopacityValue );","}","#else","if(skyY > earthY){","if(vPosition.y > horizonY){","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,opacity),vec4(skyColor ,opacity),dist/(skyY - horizonY));}","else{","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,opacity),vec4(earthColor ,opacity),dist/(horizonY - earthY));}","gl_FragColor = gl_FragColor * vec4( diffuse, opacity );","}","else{","gl_FragColor = vec4( diffuse, opacity );","}",n.ShaderChunk.gradient_basic_fragment,n.ShaderChunk.map_fragment,n.ShaderChunk.alphatest_fragment,n.ShaderChunk.lightmap_fragment,"if(skyY <= earthY){",n.ShaderChunk.color_fragment,"}",n.ShaderChunk.envmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"#endif","}"].join("\n")},lambert:{uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.fog,n.UniformsLib.lights,n.UniformsLib.shadowmap,{ambient:{type:"c",value:new n.Color(16777215)},emissive:{type:"c",value:new n.Color(0)},wrapRGB:{type:"v3",value:new n.Vec3(1,1,1)}}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",n.ShaderChunk.map_pars_vertex,n.ShaderChunk.lightmap_pars_vertex,n.ShaderChunk.envmap_pars_vertex,n.ShaderChunk.lights_lambert_pars_vertex,n.ShaderChunk.color_pars_vertex,n.ShaderChunk.morphtarget_pars_vertex,n.ShaderChunk.skinning_pars_vertex,n.ShaderChunk.shadowmap_pars_vertex,"void main() {",n.ShaderChunk.map_vertex,n.ShaderChunk.lightmap_vertex,n.ShaderChunk.color_vertex,n.ShaderChunk.morphnormal_vertex,n.ShaderChunk.skinbase_vertex,n.ShaderChunk.skinnormal_vertex,n.ShaderChunk.defaultnormal_vertex,n.ShaderChunk.morphtarget_vertex,n.ShaderChunk.skinning_vertex,n.ShaderChunk.default_vertex,n.ShaderChunk.worldpos_vertex,n.ShaderChunk.envmap_vertex,n.ShaderChunk.lights_lambert_vertex,n.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",n.ShaderChunk.color_pars_fragment,n.ShaderChunk.map_pars_fragment,n.ShaderChunk.lightmap_pars_fragment,n.ShaderChunk.envmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.shadowmap_pars_fragment,n.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",n.ShaderChunk.map_fragment,n.ShaderChunk.alphatest_fragment,n.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",n.ShaderChunk.lightmap_fragment,n.ShaderChunk.color_fragment,n.ShaderChunk.envmap_fragment,n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n")},phong:{uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.gradient,n.UniformsLib.bump,n.UniformsLib.normalmap,n.UniformsLib.fog,n.UniformsLib.lights,n.UniformsLib.shadowmap,n.UniformsLib.gradientramp,{ambient:{type:"c",value:new n.Color(16777215)},emissive:{type:"c",value:new n.Color(0)},specular:{type:"c",value:new n.Color(1118481)},uspecularStrength:{type:"f",value:1},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new n.Vec3(1,1,1)},mapSSAO:{type:"t",value:null}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec4 finalPosition;",n.ShaderChunk.map_pars_vertex,n.ShaderChunk.lightmap_pars_vertex,n.ShaderChunk.envmap_pars_vertex,n.ShaderChunk.lights_phong_pars_vertex,n.ShaderChunk.color_pars_vertex,n.ShaderChunk.morphtarget_pars_vertex,n.ShaderChunk.skinning_pars_vertex,n.ShaderChunk.shadowmap_pars_vertex,"varying vec3 vPosition;","void main() {",n.ShaderChunk.map_vertex,n.ShaderChunk.lightmap_vertex,n.ShaderChunk.color_vertex,n.ShaderChunk.morphnormal_vertex,n.ShaderChunk.skinbase_vertex,n.ShaderChunk.skinnormal_vertex,n.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",n.ShaderChunk.morphtarget_vertex,n.ShaderChunk.skinning_vertex,n.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",n.ShaderChunk.worldpos_vertex,n.ShaderChunk.envmap_vertex,n.ShaderChunk.lights_phong_vertex,n.ShaderChunk.shadowmap_vertex,"finalPosition = gl_Position;","vPosition = position;","}"].join("\n"),fragmentShader:["#define PHONG","uniform vec3 diffuse;","uniform vec3 wireframeLinecolor;","uniform float wireframeLineopacity;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float uspecularStrength;","uniform float shininess;","varying vec4 finalPosition;","uniform vec3 skyColor;","uniform vec3 horizonColor;","uniform vec3 earthColor;","uniform float skyY;","uniform float horizonY;","uniform float earthY;","varying vec3 vPosition;",n.ShaderChunk.color_pars_fragment,n.ShaderChunk.gradient_parts_fragment,n.ShaderChunk.map_pars_fragment,n.ShaderChunk.lightmap_pars_fragment,n.ShaderChunk.envmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.lights_phong_pars_fragment,n.ShaderChunk.shadowmap_pars_fragment,n.ShaderChunk.bumpmap_pars_fragment,n.ShaderChunk.normalmap_pars_fragment,n.ShaderChunk.specularmap_pars_fragment,"#ifdef USE_SSAO","uniform sampler2D mapSSAO;","#endif","vec4 lerp (vec4 colora, vec4 colorb, float t) {","if(t >= 1.0){","return colorb;}","float r = mix(colora.r, colorb.r, t);","float g = mix(colora.g, colorb.g, t);","float b = mix(colora.b, colorb.b, t);","float a = mix(colora.a, colorb.a, t);","return vec4(r,g,b,a);","}","void main() {","#ifdef USE_WIREFRAME","float wireframeLineopacityValue = wireframeLineopacity * opacity;","if(skyY > earthY){","if(vPosition.y > horizonY){","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,wireframeLineopacityValue),vec4(skyColor ,wireframeLineopacityValue),dist/(skyY - horizonY));}","else{","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,wireframeLineopacityValue),vec4(earthColor ,wireframeLineopacityValue),dist/(horizonY - earthY));}","gl_FragColor = gl_FragColor * vec4( vec3 ( 1.0 ), wireframeLineopacityValue );","}","else{","gl_FragColor = vec4( wireframeLinecolor, wireframeLineopacityValue );","}","#else","if(skyY > earthY){","if(vPosition.y > horizonY){","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,opacity),vec4(skyColor ,opacity),dist/(skyY - horizonY));}","else{","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,opacity),vec4(earthColor ,opacity),dist/(horizonY - earthY));}","gl_FragColor = gl_FragColor * vec4( vec3 ( 1.0 ), opacity );","}","else{","gl_FragColor = vec4(  vec3 ( 1.0 ), opacity );","}","vec3 tempDiffuse = diffuse;",n.ShaderChunk.gradient_phong_fragment,n.ShaderChunk.map_fragment,n.ShaderChunk.alphatest_fragment,n.ShaderChunk.specularmap_fragment,n.ShaderChunk.lights_phong_fragment,n.ShaderChunk.lightmap_fragment,n.ShaderChunk.color_fragment,n.ShaderChunk.envmap_fragment,n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"#endif","}"].join("\n")},particle_basic:{uniforms:n.UniformsUtils.merge([n.UniformsLib.particle,n.UniformsLib.shadowmap]),vertexShader:["uniform float size;","uniform float scale;",n.ShaderChunk.color_pars_vertex,n.ShaderChunk.shadowmap_pars_vertex,"void main() {",n.ShaderChunk.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * normal.x * ( scale / length( mvPosition.xyz ) );","#else","float s = normal.x;","if(s == 0.0){","   s = 1.0;","}","gl_PointSize = size * s;","#endif","gl_Position = projectionMatrix * mvPosition;",n.ShaderChunk.worldpos_vertex,n.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 psColor;","uniform float opacity;",n.ShaderChunk.color_pars_fragment,n.ShaderChunk.map_particle_pars_fragment,n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.shadowmap_pars_fragment,"void main() {","gl_FragColor = vec4( psColor, opacity );",n.ShaderChunk.map_particle_fragment,n.ShaderChunk.alphatest_fragment,n.ShaderChunk.color_fragment,n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n")},billboard:{vertexShader:["uniform int useScreenCoordinates;","uniform int sizeAttenuation;","uniform vec3 screenPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 alignment;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position + alignment;","vec2 rotatedPosition;","rotatedPosition.x = ( cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y ) * scale.x;","rotatedPosition.y = ( sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y ) * scale.y;","vec4 finalPosition;","if( useScreenCoordinates != 0 ) {","finalPosition = vec4( screenPosition.xy + rotatedPosition, screenPosition.z, 1.0 );","} else {","finalPosition = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition * ( sizeAttenuation == 1 ? 1.0 : finalPosition.z );","}","gl_Position = finalPosition;","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")},dashed:{uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.fog,{scale:{type:"f",value:1},dashSize:{type:"f",value:1},totalSize:{type:"f",value:2}},n.UniformsLib.gradientramp]),vertexShader:["uniform float scale;","attribute float lineDistance;","varying float vLineDistance;","varying vec3 vPosition;",n.ShaderChunk.color_pars_vertex,"void main() {",n.ShaderChunk.color_vertex,"vLineDistance = scale * lineDistance;","vPosition = position;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float dashSize;","uniform float totalSize;","varying float vLineDistance;","uniform vec3 skyColor;","uniform vec3 horizonColor;","uniform vec3 earthColor;","uniform float skyY;","uniform float horizonY;","uniform float earthY;","varying vec3 vPosition;",n.ShaderChunk.color_pars_fragment,n.ShaderChunk.fog_pars_fragment,"vec4 lerp (vec4 colora, vec4 colorb, float t) {","if(t >= 1.0){","return colorb;}","float r = mix(colora.r, colorb.r, t);","float g = mix(colora.g, colorb.g, t);","float b = mix(colora.b, colorb.b, t);","float a = mix(colora.a, colorb.a, t);","return vec4(r,g,b,a);","}","void main() {","if ( mod( vLineDistance, totalSize ) > dashSize ) {","discard;","}","if(skyY > earthY){","if(vPosition.y > horizonY){","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,opacity),vec4(skyColor ,opacity),dist/(skyY - horizonY));}","else{","float dist = distance(vPosition, vec3(vPosition.x , horizonY, vPosition.z));","gl_FragColor = lerp(vec4(horizonColor ,opacity),vec4(earthColor ,opacity),dist/(horizonY - earthY));}","gl_FragColor = gl_FragColor * vec4( diffuse, opacity );",n.ShaderChunk.fog_fragment,"}","else{","gl_FragColor = vec4( diffuse, opacity );",n.ShaderChunk.color_fragment,n.ShaderChunk.fog_fragment,"}","}"].join("\n")},depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","uniform float opacity;","void main() {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float color = 1.0 - smoothstep( mNear, mFar, depth );","gl_FragColor = vec4( vec3( color ), opacity );","}"].join("\n")},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:["varying vec3 vNormal;","void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vNormal;","void main() {","gl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );","}"].join("\n")},normalmap:{uniforms:n.UniformsUtils.merge([n.UniformsLib.fog,n.UniformsLib.lights,n.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new n.Vec2(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new n.Color(16777215)},uSpecularColor:{type:"c",value:new n.Color(1118481)},uSpecualarStrength:{type:"f",value:1},uAmbientColor:{type:"c",value:new n.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:.98},uReflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new n.Vec2(0,0)},uRepeat:{type:"v2",value:new n.Vec2(1,1)},wrapRGB:{type:"v3",value:new n.Vec3(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform vec3 uSpecularStrength;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse;","uniform bool enableSpecular;","uniform bool enableAO;","uniform bool enableReflection;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tAO;","uniform samplerCube tCube;","uniform vec2 uNormalScale;","uniform bool useRefract;","uniform float uRefractionRatio;","uniform float uReflectivity;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",n.ShaderChunk.shadowmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,"void main() {","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","vec3 specularTex = vec3( 1.0 );","vec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( enableDiffuse ) {","#ifdef GAMMA_INPUT","vec4 texelColor = texture2D( tDiffuse, vUv );","texelColor.xyz *= texelColor.xyz;","gl_FragColor = gl_FragColor * texelColor;","#else","gl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );","#endif","}","if( enableAO ) {","#ifdef GAMMA_INPUT","vec4 aoColor = texture2D( tAO, vUv );","aoColor.xyz *= aoColor.xyz;","gl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;","#else","gl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;","#endif","}","if( enableSpecular )","specularTex = texture2D( tSpecular, vUv ).xyz;","mat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );","vec3 finalNormal = tsb * normalTex;","#ifdef FLIP_SIDED","finalNormal = -finalNormal;","#endif","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 pointVector = lPosition.xyz + vViewPosition.xyz;","float pointDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","pointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );","pointVector = normalize( pointVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );","#endif","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;","vec3 pointHalfVector = normalize( pointVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );"
,"float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( pointVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * pointDistance * specularNormalization;","#else","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 spotVector = lPosition.xyz + vViewPosition.xyz;","float spotDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","spotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );","spotVector = normalize( spotVector );","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );","#endif","spotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect;","vec3 spotHalfVector = normalize( spotVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( spotVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * spotDistance * specularNormalization * spotEffect;","#else","spotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += uDiffuseColor * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlickSky = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += uSpecularColor * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;","#endif","if ( enableReflection ) {","vec3 vReflect;","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, normal, uRefractionRatio );","} else {","vReflect = reflect( cameraToVertex, normal );","}","vec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );","}",n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uOffset;","uniform vec2 uRepeat;","uniform bool enableDisplacement;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",n.ShaderChunk.skinning_pars_vertex,n.ShaderChunk.shadowmap_pars_vertex,"void main() {",n.ShaderChunk.skinbase_vertex,n.ShaderChunk.skinnormal_vertex,"#ifdef USE_SKINNING","vNormal = normalize( normalMatrix * skinnedNormal.xyz );","vec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );","vTangent = normalize( normalMatrix * skinnedTangent.xyz );","#else","vNormal = normalize( normalMatrix * normal );","vTangent = normalize( normalMatrix * tangent.xyz );","#endif","vBinormal = normalize( cross( vNormal, vTangent ) * tangent.w );","vUv = uv * uRepeat + uOffset;","vec3 displacedPosition;","#ifdef VERTEX_TEXTURES","if ( enableDisplacement ) {","vec3 dv = texture2D( tDisplacement, uv ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","displacedPosition = position + normalize( normal ) * df;","} else {","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","}","#else","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","#endif","vec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );","vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","gl_Position = projectionMatrix * mvPosition;","vWorldPosition = worldPosition.xyz;","vViewPosition = -mvPosition.xyz;","#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif","}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vWorldPosition;","void main() {","gl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );","}"].join("\n")},depthRGBA:{uniforms:{isCube:{type:"i",value:0},nearDistance:{type:"f",value:10},farDistance:{type:"f",value:1e4},referencePosition:{type:"v3",value:new mono.Vec3}},vertexShader:[n.ShaderChunk.morphtarget_pars_vertex,n.ShaderChunk.skinning_pars_vertex,"varying vec4 vPosition1;","void main() {",n.ShaderChunk.skinbase_vertex,n.ShaderChunk.morphtarget_vertex,n.ShaderChunk.skinning_vertex,n.ShaderChunk.default_vertex,"vPosition1 = modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform int isCube;","uniform float nearDistance;","uniform float farDistance;","varying vec4 vPosition1;","varying vec3 vPosition2;","vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = fract( depth * bit_shift );","res -= res.xxyz * bit_mask;","return res;","}","vec4 pack (float depth){","const vec4 bias = vec4(1.0 / 255.0,1.0 / 255.0,1.0 / 255.0, 0.0);","float r = depth;","float g = fract(r * 255.0);","float b = fract(g * 255.0);","float a = fract(b * 255.0);","vec4 colour = vec4(r, g, b, a);","return colour - (colour.yzww * bias);","}","void main() {","if(isCube == 1){"," 	float dist = length( vPosition1.xyz/vPosition1.w);","		dist = ( dist - nearDistance ) / ( farDistance - nearDistance );","		gl_FragData[ 0 ] = pack(dist);","}else{","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );","}","}"].join("\n")}},n.ShaderTerrain={terrain:{uniforms:n.UniformsUtils.merge([n.UniformsLib.fog,n.UniformsLib.lights,n.UniformsLib.shadowmap,{enableDiffuse1:{type:"i",value:0},enableDiffuse2:{type:"i",value:0},enableDiffuse3:{type:"i",value:0},enableDisplacement:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDetail:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tDisplacement:{type:"t",value:null},heightUnit:{type:"f",value:1},blendRange:{type:"fv1",value:null},uNormalScale:{type:"f",value:1},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new n.Color(15658734)},uSpecularColor:{type:"c",value:new n.Color(1118481)},uAmbientColor:{type:"c",value:new n.Color(328965)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},uRepeatBase:{type:"v2",value:new n.Vec2(1,1)},uRepeatOverlay:{type:"v2",value:new n.Vec2(1,1)},uOffset:{type:"v2",value:new n.Vec2(0,0)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse1;","uniform bool enableDiffuse2;","uniform bool enableDiffuse3;","uniform bool enableSpecular;","uniform bool enableDisplacement;","uniform float blendRange[2];","uniform float heightUnit;","uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDetail;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tDisplacement;","uniform float uNormalScale;","uniform vec2 uRepeatOverlay;","uniform vec2 uRepeatBase;","uniform vec2 uOffset;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec4 vPosition;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","varying vec3 vViewPosition;",n.ShaderChunk.shadowmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,"void main() {","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","vec3 specularTex = vec3( 1.0 );","vec2 uvOverlay = uRepeatOverlay * vUv + uOffset;","vec2 uvBase = uRepeatBase * vUv;","vec3 normalTex = texture2D( tDetail, uvOverlay ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( (enableDiffuse1 && enableDiffuse2)  || (enableDiffuse1 && enableDiffuse3) || (enableDiffuse2 && enableDiffuse3) ){","vec4 colDiffuse1 = texture2D( tDiffuse1, uvOverlay );","vec4 colDiffuse2 = texture2D( tDiffuse2, uvOverlay );","vec4 colDiffuse3 = texture2D( tDiffuse3, uvOverlay );","vec4 allDefiuuses[3];","allDefiuuses[0] = colDiffuse1;","allDefiuuses[1] = colDiffuse2;","allDefiuuses[2] = colDiffuse3;","#ifdef GAMMA_INPUT","colDiffuse1.xyz *= colDiffuse1.xyz;","colDiffuse2.xyz *= colDiffuse2.xyz;","colDiffuse3.xyz *= colDiffuse3.xyz;","#endif","vec4 mixColor;","if(enableDisplacement){","vec4 dis = texture2D( tDisplacement, uvBase );","if(enableDiffuse1 && enableDiffuse2 && enableDiffuse3){","float total = dis.r + dis.g + dis.b;","if(total == 0.0){","mixColor = colDiffuse1 * 1.0/3.0 + colDiffuse2 * 1.0/3.0 + colDiffuse3 * 1.0/3.0;","}else{","mixColor = colDiffuse1 * dis.r/total + colDiffuse2 * dis.g/total + colDiffuse3 * dis.b/total;","}","}","}else {","mixColor = colDiffuse2;","float y = vPosition.y;","float blend2Bottom = blendRange[1] * heightUnit * 255.0;","float percent = 0.0;","if(y < blendRange[0] * heightUnit * 255.0){","mixColor = colDiffuse1;","percent = y / (blendRange[0] * heightUnit * 255.0);","if(percent >=0.8){","mixColor = mix(colDiffuse1,colDiffuse2,(percent - 0.8) / 0.2);","}","} else if(y > blend2Bottom){","mixColor = colDiffuse3;","percent = (y - blend2Bottom) / (heightUnit * 255.0 - blend2Bottom);","if(percent <= 0.2){","mixColor = mix(colDiffuse2,colDiffuse3,percent/0.2);","}","}","}","gl_FragColor = gl_FragColor * mixColor;"," } else if( enableDiffuse1 ) {","gl_FragColor = gl_FragColor * texture2D( tDiffuse1, uvOverlay );","} else if( enableDiffuse2 ) {","gl_FragColor = gl_FragColor * texture2D( tDiffuse2, uvOverlay );","}","if( enableSpecular )","specularTex = texture2D( tSpecular, uvOverlay ).xyz;","mat3 tsb = mat3( vTangent, vBinormal, vNormal );","vec3 finalNormal = tsb * normalTex;","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDistance = lDistance;","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointDiffuseWeight = max( dot( normal, lVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","hemiDiffuse += uDiffuseColor * mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","float hemiSpecularWeight = 0.0;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","hemiSpecularWeight += specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","hemiSpecularWeight += specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );","hemiSpecular += uSpecularColor * mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight ) * hemiSpecularWeight * hemiDiffuseWeight;","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif",n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uRepeatBase;","uniform sampler2D tNormal;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec4 vPosition;","varying vec3 vViewPosition;",n.ShaderChunk.shadowmap_pars_vertex,"void main() {","vNormal = normalize( normalMatrix * normal );","vTangent = normalize( normalMatrix * tangent.xyz );","vBinormal = cross( vNormal, vTangent ) * tangent.w;","vBinormal = normalize( vBinormal );","vUv = uv;","vec2 uvBase = uv * uRepeatBase;","#ifdef VERTEX_TEXTURES","vec3 dv = texture2D( tDisplacement, uvBase ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","vec3 displacedPosition = normal * df + position;","vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","vec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );","#else","vPosition = vec4(position,1.0);","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","#endif","gl_Position = projectionMatrix * mvPosition;","vViewPosition = -mvPosition.xyz;","vec3 normalTex = texture2D( tNormal, uvBase ).xyz * 2.0 - 1.0;","vNormal = normalMatrix * normalTex;",n.ShaderChunk.shadowmap_vertex,"}"].join("\n")}},n.ShaderLib.terrain=n.ShaderTerrain.terrain,n.Fog=function(e,r,i){this.name="",this.color=new n.Color(e),this.near=r!==t?r:1,this.far=i!==t?i:1e3},n.Fog.prototype={constructor:n.Fog,clone:function(){return new n.Flog(this.color.getHex(),this.near,this.far)},refreshUniforms:function(e){e.fogNear.value=this.near,e.fogFar.value=this.far,e.fogColor.value=this.color}},n.FogExp2=function(e,r){this.name="",this.color=new n.Color(e),this.density=r!==t?r:1},n.FogExp2.prototype={DensityFactor:25e-5,constructor:n.FogExp2,clone:function(){return new n.FogExp2(this.color.getHex(),this.density)},refreshUniforms:function(e){e.fogDensity.value=this.density*this.DensityFactor,e.fogColor.value=this.color}};var H={},B=H.RADIANS_TO_DEGREES=180/Math.PI,F=H.DEGREES_TO_RADIANS=Math.PI/180;H.isPowerOfTwo=function(e){return(e&e-1)===0},H.clone=function(e,n){n==t&&(n=new e.prototype.constructor);for(var r in e){if(r==="id")continue;var i=e[r];if(i.copy&&typeof i.copy=="function")n[r].copy(i);else if(i instanceof Array){var s=i,o=n[r];o==null&&(o=[]);for(var u=0;u<s.length;u++){var a=s[u];o.push(a.clone())}}else cloneObjet[r]=i}},H.paramToGL=function(e,t){if(!t){console.error("No webgl context");return}switch(e){case n.RepeatWrapping:return t.REPEAT;case n.ClampToEdgeWrapping:return t.CLAMP_TO_EDGE;case n.MirroredRepeatWrapping:return t.MIRRORED_REPEAT;case n.NearestFilter:return t.NEAREST;case n.NearestMipMapNearestFilter:return t.NEAREST_MIPMAP_NEAREST;case n.NearestMipMapLinearFilter:return t.NEAREST_MIPMAP_LINEAR;case n.LinearFilter:return t.LINEAR;case n.LinearMipMapNearestFilter:return t.LINEAR_MIPMAP_NEAREST;case n.LinearMipMapLinearFilter:return t.LINEAR_MIPMAP_LINEAR;case n.ByteType:return t.BYTE;case n.UnsignedByteType:return t.UNSIGNED_BYTE;case n.ShortType:return t.SHORT;case n.UnsignedShortType:return t.UNSIGNED_SHORT;case n.IntType:return t.INT;case n.UnsignedIntType:return t.UNSIGNED_INT;case n.FloatType:return t.FLOAT;case n.AlphaFormat:return t.ALPHA;case n.RGBFormat:return t.RGB;case n.RGBAFormat:return t.RGBA;case n.LuminanceFormat:return t.LUMINANCE;case n.LuminanceAlphaFormat:return t.LUMINANCE_ALPHA;case n.AddEquation:return t.FUNC_ADD;case n.SubtractEquation:return t.FUNC_SUBTRACT;case n.ReverseSubtractEquation:return t.FUNC_REVERSE_SUBTRACT;case n.ZeroFactor:return t.ZERO;case n.OneFactor:return t.ONE;case n.SrcColorFactor:return t.SRC_COLOR;case n.OneMinusSrcColorFactor:return t.ONE_MINUS_SRC_COLOR;case n.SrcAlphaFactor:return t.SRC_ALPHA;case n.OneMinusSrcAlphaFactor:return t.ONE_MINUS_SRC_ALPHA;case n.DstAlphaFactor:return t.DST_ALPHA;case n.OneMinusDstAlphaFactor:return t.ONE_MINUS_DST_ALPHA;case n.DstColorFactor:return t.DST_COLOR;case n.OneMinusDstColorFactor:return t.ONE_MINUS_DST_COLOR;case n.SrcAlphaSaturateFactor:return t.SRC_ALPHA_SATURATE}return 0},H.createElement=function(e,r,i,s){var u,a,f,c,h=e.vertices.length,p=e.uvs.length,d=e.vertices,v=r.vertices,m=e.faces,g=r.faces,y=e.uvs,b=r.uvs,w=[],E=[],S=[];s===t&&(s=0),e instanceof n.Element&&(e.matrixAutoUpdate&&e.updateMatrix(),u=e.matrix,a=(new l).getNormalMatrix(u)),r instanceof n.Element&&(r.matrixAutoUpdate&&r.updateMatrix(),f=r.matrix,c=(new l).getNormalMatrix(f));for(var x=0,T=d.length;x<T;x++){var N=d[x],C=N.clone();u&&C.applyMatrix4(u),E.push(C)}for(var x=0,T=v.length;x<T;x++){var N=v[x],C=N.clone();f&&C.applyMatrix4(f),E.push(C)}for(x=0,T=m.length;x<T;x++){var k=m[x],L,A,_,D=k.vertexNormals,P=k.vertexColors;k instanceof O?L=new O(k.a,k.b,k.c):L=new M(k.a,k.b,k.c,k.d),L.normal.copy(k.normal),a&&L.normal.applyMatrix3(a).normalize();for(var H=0,B=D.length;H<B;H++)A=D[H].clone(),a&&A.applyMatrix3(a).normalize(),L.vertexNormals.push(A);L.color.copy(k.color);for(var H=0,B=P.length;H<B;H++)_=P[H],L.vertexColors.push(_.clone());L.materialIndex=k.materialIndex,L.centroid.copy(k.centroid),u&&L.centroid.applyMatrix4(u),w.push(L)}for(x=0,T=g.length;x<T;x++){var k=g[x],L,A,_,D=k.vertexNormals,P=k.vertexColors;k instanceof O?L=new O(k.a+h,k.b+h,k.c+h):L=new M(k.a+h,k.b+h,k.c+h,k.d+h),L.normal.copy(k.normal),c&&L.normal.applyMatrix3(c).normalize();for(var H=0,B=D.length;H<B;H++)A=D[H].clone(),c&&A.applyMatrix3(c).normalize(),L.vertexNormals.push(A);L.color.copy(k.color);for(var H=0,B=P.length;H<B;H++)_=P[H],L.vertexColors.push(_.clone());L.materialIndex=k.materialIndex+s,L.centroid.copy(k.centroid),f&&L.centroid.applyMatrix4(f),w.push(L)}for(x=0,T=y.length;x<T;x++){var j=y[x],F=[];for(var H=0,B=j.length;H<B;H++)F.push(new o(j[H].x,j[H].y));S.push(F)}for(x=0,T=b.length;x<T;x++){var j=b[x],F=[];for(var H=0,B=j.length;H<B;H++)F.push(new o(j[H].x,j[H].y));S.push(F)}var I=new n.Entity;return I.vertices=E,I.faces=w,I.uvs=S,I.material=i===t?e.material:i,I},H.transformElement=function(e,t){var r,i,s=e.vertices,u=e.faces,a=e.uvs,f=[],c=[],h=[];e instanceof n.Element&&(e.matrixAutoUpdate&&e.updateMatrix(),r=e.matrix,i=(new l).getNormalMatrix(r));for(var p=0,d=s.length;p<d;p++){var v=s[p],m=v.clone();r&&m.applyMatrix4(r),c.push(m)}for(p=0,d=u.length;p<d;p++){var g=u[p],y,b,w,E=g.vertexNormals,S=g.vertexColors;g instanceof O?y=new O(g.a,g.b,g.c):y=new M(g.a,g.b,g.c,g.d),y.normal.copy(g.normal),i&&y.normal.applyMatrix3(i).normalize();for(var x=0,T=E.length;x<T;x++)b=E[x].clone(),i&&b.applyMatrix3(i).normalize(),y.vertexNormals.push(b);y.color.copy(g.color);for(var x=0,T=S.length;x<T;x++)w=S[x],y.vertexColors.push(w.clone());y.materialIndex=g.materialIndex,y.centroid.copy(g.centroid),r&&y.centroid.applyMatrix4(r),f.push(y)}for(p=0,d=a.length;p<d;p++){var N=a[p],C=[];for(var x=0,T=N.length;x<T;x++)C.push(new o(N[x].x,N[x].y));h.push(C)}if(t){var k=new n.Entity(e.material);k.vertices=c,k.faces=f,k.uvs=h,k.setPosition(0,0,0),k.setRotation(0,0,0),k.setScale(1,1,1);var L={};return L.vertices=c,L.faces=f,L.uvs=h,k.primitive=new n.Primitive(L),k}e.vertices=c,e.faces=f,e.uvs=h,e.setPosition(0,0,0),e.setRotation(0,0,0),e.setScale(1,1,1);var L={};L.vertices=c,L.faces=f,L.uvs=h,e.primitive=new n.Primitive(L);for(var p in r.elements)e._attachId+=r.elements[p];return e},H.mergeElements=function(e){var t,r,i,s=0,u=0,a=0,c,h,p;for(t=0;t<e.length;t++)i=e[t],s+=i.materialSize;var d=new n.Entity(s),v={},m={},g=new f(0,0,0),y=[],b=[],w=[],E=[],S=new n.ArrayMaterial;for(t=0;t<e.length;t++){i=e[t],i.matrixAutoUpdate&&i.updateWorldMatrix(),c=i.worldMatrix.clone(),h=(new l).getNormalMatrix(c);for(r=0;r<i.vertices.length;r++)p=i.vertices[r],y.push(p.clone().applyMatrix4(c));for(r=0;r<i.faces.length;r++){var x=i.faces[r],T,N,C,k=x.vertexNormals,L=x.vertexColors;x instanceof O?T=new O(x.a+u,x.b+u,x.c+u):T=new M(x.a+u,x.b+u,x.c+u,x.d+u),T.normal.copy(x.normal),h&&T.normal.applyMatrix3(h).normalize(),T.materialIndex=x.materialIndex+a,T.centroid.copy(x.centroid),c&&T.centroid.applyMatrix4(c),b.push(T)}for(r=0,len=i.uvs.length;r<len;r++){var A=i.uvs[r],_=[];for(var D=0,P=A.length;D<P;D++)_.push(new o(A[D].x,A[D].y));w.push(_)}if(i.uv2s&&i.uv2s.length>0)for(r=0,len=i.uv2s.length;r<len;r++){var B=i.uv2s[r],j=[];for(var D=0,P=B.length;D<P;D++)j.push(new o(B[D].x,B[D].y));E.push(j)}S.materials=S.materials.concat(i.material.materials),u+=i.vertices.length,a+=i.materialSize;for(var F in i.styleMap){var I=v[F];I==null&&(I=[]);var q=i.styleMap[F],R=!0;if(H.isArray(q))for(var D=0;D<q.length;D++)I.push(q[t]),D>0&&q[D]!=q[D-1]&&(R=!1);else for(var D=0;D<i.materialSize;D++)I.push(q);if(m[F]==1||m[F]==null)m[F]=R;v[F]=I}}for(var F in m)m[F]==1&&(v[F]=v[F][0]);return d.styleMap=v,d.material=S,d.vertices=y,d.faces=b,d.setUvs(w),d.uv2s=E,d.setUpdateFlags(!0),d},H.mergeElement=function(e,r,i){var s,u,a,f,c=e.vertices.length,h=e.uvs.length,p=e.vertices,d=r.vertices,v=e.faces,m=r.faces,g=e.uvs,y=r.uvs,b=[],w=[],E=[];i===t&&(i=0),e instanceof n.Element&&(e.matrixAutoUpdate&&e.updateMatrix(),s=e.matrix,u=(new l).getNormalMatrix(s)),r instanceof n.Element&&(r.matrixAutoUpdate&&r.updateMatrix(),a=r.matrix,f=(new l).getNormalMatrix(a));for(var S=0,x=p.length;S<x;S++){var T=p[S],N=T.clone();s&&N.applyMatrix4(s),w.push(N)}for(var S=0,x=d.length;S<x;S++){var T=d[S],N=T.clone();a&&N.applyMatrix4(a),w.push(N)}for(S=0,x=v.length;S<x;S++){var C=v[S],k,L,A,_=C.vertexNormals,D=C.vertexColors;C instanceof O?k=new O(C.a,C.b,C.c):k=new M(C.a,C.b,C.c,C.d),k.normal.copy(C.normal),u&&k.normal.applyMatrix3(u).normalize();for(var P=0,H=_.length;P<H;P++)L=_[P].clone(),u&&L.applyMatrix3(u).normalize(),k.vertexNormals.push(L);k.color.copy(C.color);for(var P=0,H=D.length;P<H;P++)A=D[P],k.vertexColors.push(A.clone());k.materialIndex=C.materialIndex,k.centroid.copy(C.centroid),s&&k.centroid.applyMatrix4(s),b.push(k)}for(S=0,x=m.length;S<x;S++){var C=m[S],k,L,A,_=C.vertexNormals,D=C.vertexColors;C instanceof O?k=new O(C.a+c,C.b+c,C.c+c):k=new M(C.a+c,C.b+c,C.c+c,C.d+c),k.normal.copy(C.normal),f&&k.normal.applyMatrix3(f).normalize();for(var P=0,H=_.length;P<H;P++)L=_[P].clone(),f&&L.applyMatrix3(f).normalize(),k.vertexNormals.push(L);k.color.copy(C.color);for(var P=0,H=D.length;P<H;P++)A=D[P],k.vertexColors.push(A.clone());k.materialIndex=C.materialIndex+i,k.centroid.copy(C.centroid),a&&k.centroid.applyMatrix4(a),b.push(k)}for(S=0,x=g.length;S<x;S++){var B=g[S],j=[];for(var P=0,H=B.length;P<H;P++)j.push(new o(B[P].x,B[P].y));E.push(j)}for(S=0,x=y.length;S<x;S++){var B=y[S],j=[];for(var P=0,H=B.length;P<H;P++)j.push(new o(B[P].x,B[P].y));E.push(j)}return e.vertices=w,e.faces=b,e.uvs=E,e._position.set(0,0,0),e._rotation.set(0,0,0),e._scale.set(1,1,1),e},H.autoAdjustNetworkBounds=function(t,n,r,i,s,o){s=s||0,o=o||0,t.adjustBounds(n[r]-s,n[i]-o),!t._resizeFunction&&(t._resizeFunction=function(){t.adjustBounds(n[r]-s,n[i]-o,o,s)}),e.addEventListener("resize",t._resizeFunction,!0)},H.isEmptyObject=function(e){for(var t in e)return!1;return!0},H.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"},H.isSame=function(e,t){if(e===t)return!0;if(e==null&&t!=null)return!1;if(e!=null&&t==null)return!1;if(typeof e!=typeof t)return!1;for(var n in e)if(e[n]!=t[n])return!1;for(var n in t)if(e[n]!=t[n])return!1;return!0},H.toString=function(e){if(e){var t="";for(var n in e)t+=n+":"+e[n];return t}},H.validateLicense=function(e){Y=e,qr()},H.getLicense=function(){return Y},H.getObjectCount=function(e){if(!e)return 0;var t=0;for(var n in e)t++;return t},H.isNaN=function(e){return e===""||e===null||isNaN(e)},H.getTransformVertices=function(e,t,r){r==null&&(r=[]);var i,s;if(e instanceof n.Node||e instanceof n.Billboard){for(i=0;i<e.vertices.length;i++)s=e.vertices[i].clone(),e instanceof n.Billboard?(s.x*=e.rotation3d.x,s.y*=e.rotation3d.y,s.add(e.getPosition())):s.applyMatrix4(e.worldMatrix),r.push(s);for(var i=0;i<(e._childList?e._childList.size():0);i++){var o=e._childList.get(i);H.getTransformVertices(o,t,r)}}return r},H.getBoundingBox=function(e,t){var r,i,s,o,u;if(e==null)return null;e instanceof C?r=e._as:H.isArray(e)?r=e:r=[e];var a=[];for(i=0;i<r.length;i++)o=r[i],H.getTransformVertices(o,t,a);var f=new n.BoundingBox;return f.setFromPoints(a),f},H.mergeWrapMap=function(e){if(!(e instanceof _))return;if(e.getWrapMap())return;var t=[],n=e.getMaterialMapping(),r=e.material.materials,i;for(var s=0;s<r.length;s++)i=r[s],i.map&&t.indexOf(i.map._image)==-1&&t.push(i.map._image);e.setWrapMap(!0)},H.setWrapMap=function(e,t,n,r){H.loadImages(t,function(i){var s=mono.Utils.createWrapMapFromImages(i,n,r);s.__uniqueCode="";for(var o=0;o<t.length;o++)s.__uniqueCode+=t[o].src;for(var o in n)s.__uniqueCode+=o+":"+n[o];if(H.isArray(e))for(var o=0;o<e.length;o++)e[o].setStyle("m.texture.image",s),e[o].setClient("_originalImage",t),e[o].setClient("_wrapMapping",n);else e.setStyle("m.texture.image",s),e.setClient("_wrapMapping",n)})},H.loadImages=function(e,t)
{function i(e){e.onload=function(){e.loaded=!0,s(),e.onload=null}}function s(){for(var n=0;n<e.length;n++)if(!e[n].loaded)return;t(e)}if(e==null||e.length==0||t==null)return;for(var n=0;n<e.length;n++){var r=e[n];typeof r=="string"&&(e[n]=new Image,e[n].crossOrigin="",e[n].src=r),r=e[n],i(r)}},H.createWrapMapFromImages=function(e,t,n,r,i){if(e==null||e.length==0)return null;n=(n||"six-each").toLowerCase();var s=n=="six-each"||n=="front-other"||n=="back-other"||n=="left-other"||n=="right-other"||n=="top-other"||n=="bottom-other";if(!s)return;t==null&&(t={0:"bottom",1:"top",2:"back",3:"left",4:"front",5:"right"});var o=document.createElement("canvas"),u=o.getContext("2d"),a=0,f=0;if(n=="six-each"){var l={bottom:[0,0],top:[1/3,0],back:[2/3,0],left:[0,.5],front:[1/3,.5],right:[2/3,.5]};if(r==null||i==null)for(var c=0;c<e.length;c++)a=Math.max(e[c].width,a),f=Math.max(e[c].height,f);a*=3,f*=2,a>1024&&(a=1024),f>1024&&(f=1024);var h=["front","back","right","left","top","bottom"],p=[],d;for(var c in t){var v=t[c];v!=="other"?(p.push(v),h.splice(h.indexOf(v),1)):d=c}d!=null&&(t[d]=h),r=r||a,i=i||f,o.setAttribute("width",r),o.setAttribute("height",i);var m=Math.min(e.length,6);for(var c=0;c<6;c++){var g=t[c];if(g){var y=g;H.isArray(g)?y=g:g.indexOf(",")!=-1?y=g.split(","):y=[g];for(var b=0;b<y.length;b++){var v=y[b],w=l[v][0],E=l[v][1];u.drawImage(e[c],w*r,E*i,r/3,i/2)}}}}else{var S=n.split("-")[0];if(r==null||i==null)for(var c=0;c<e.length;c++)a+=e[c].width,f=Math.max(e[c].height,f);r=r||a,i=i||f,o.setAttribute("width",r),o.setAttribute("height",i);var x=t[S],m=Math.min(e.length,2);for(var c=0;c<2;c++){var g=t[c];g&&(g==S?u.drawImage(e[c],0,0,r/2,i):u.drawImage(e[c],r/2,0,r/2,i))}}return o},H.getVectorAngles=function(e,t){var n=e;t&&(n=t.clone().sub(e)),n=n.normalize();var r=Math.asin(n.y)*B,i=Math.atan2(n.x,n.z)*B;return[i,r]},H.getPixelFromImage=function(e,t,n){var r;p.isCanvas(e)?r=e:(r=document.createElement("canvas"),r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(e,0,0,e.width,e.height)),t-=Math.floor(t),n-=Math.floor(n),n=1-n;var i=r.getContext("2d").getImageData(e.width*t,e.height*n,1,1).data;return i},H.nextPowerOfTwo=function(e){var t=e;return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e},H.createTextBillboard=function(e,t){var n=new mono.Billboard;e=e||"",t=t||{};var r=H.createTextImage(e,t);return n.setStyle("m.texture.image",r),n.setScale(r.width,r.height,1),n},H.createTextImage=function(e,n){e=e||"";var r=n.font,i=n.color,s=n.background,o=n.powerOfTwo,u=n.canvas,a=n.drawFunction;u=u||document.createElement("canvas"),r=r||'20px "Dialog"',i=i||"white",s=s===t?"#0F90C4":s,o=o||!1;var f=n.textAlign||"center",l;H.isArray(e)?l=e:l=e.split("\n");var c=mono.Utils.getMaxTextSize(l,r),h=n.ratio||c.width/c.height,p=u.realSize={width:c.width,height:c.height};o&&(c.width=mono.Utils.nextPowerOfTwo(c.width),c.height=mono.Utils.nextPowerOfTwo(c.height));var d=u.drawRect={width:p.width/p.height>h?p.width:p.height*h,height:p.width/p.height>h?p.width/h:p.height};Number.isNaN(d.width)&&console.log("debug -- b",p.width,p.height,h),d.width=Math.min(d.width,c.width),d.height=Math.min(d.height,c.height),u.width=c.width,u.height=c.height,Number.isNaN(d.width)&&console.log("debug -- a");var v=u.getContext("2d");s&&(v.fillStyle=s);if(a)a(v,u.width,u.height);else{s&&v.fillRect(0,0,u.width,u.height),v.font=r,v.fillStyle=i,v.strokeStyle="gray",v.textBaseline="middle",v.textAlign=f;var m=l.length,g=p.height/m,y;for(var b=0;b<m;b++){H.isArray(i)&&(y=i[b],y&&(v.fillStyle=y));var w=mono.Utils.getTextSize(r,l[b]),E=w.width,S=w.height,x=u.height,T=(d.width-p.width)/2;f==="center"?T=d.width/2:f==="right"&&(T=d.width);var N=(d.height-p.height)/2+g/2+b*g+(u.height-d.height);v.strokeText(l[b],T,N),v.fillText(l[b],T,N)}}return u},H.createTextImage2=function(e,n){e=e||"",e=String(e);var r=n.font,i=n.color,s=n.background,o=n.powerOfTwo,u=n.canvas,a=n.drawFunction;u=u||document.createElement("canvas"),r=r||'20px "Dialog"',i=i||"white",s=s===t?"#0F90C4":s,o=o||!1;var f=n.align||"center",l=n.sizeScale||1,c=H.getMaxTextSize(e.split("\n"),r);u.realSize={width:c.width,height:c.height},c.width*=l,c.height*=l,o&&(c.width=H.nextPowerOfTwo(c.width),c.height=H.nextPowerOfTwo(c.height)),u.width=c.width,u.height=c.height;var h=u.getContext("2d");return s&&(h.fillStyle=s),a?a(h,u.width,u.height):(s&&h.fillRect(0,0,u.width,u.height),I(h,e,r,i,u,"center")),u},H.getMaxTextSize=function(e,t){if(e&&e.length>0){var n=e.length,r=w.getTextSize(t,e[0]),i=r.width,s=r.height*n;for(var o=0;o<n;o++){var u=w.getTextSize(t,e[o]).width;i<u&&(i=u)}return{width:i,height:s}}return null},H.getTextSize=function(e,t){return w.getTextSize(e,t)},H.playCameraAnimation=function(e,t,n,r,i){if(H.activeAnimates&&H.activeAnimates instanceof Array)for(var s=0;s<H.activeAnimates.length;s++)H.activeAnimates[s].stop();t=t||e.p(),n=n||e.getTarget();if(t.equals(e.getPosition())&&n.equals(e.target))return i&&i(),null;var o=e.getPosition().sub(e.getTarget()),u=(new mono.Vec3).addVectors(o,n);r=r||3e3;var a=mono.Utils.getVectorAngles(n,u),f=mono.Utils.getVectorAngles(n,t),l=f[0]-a[0];l>180?l-=360:l<-180&&(l+=360);var c=f[1]-a[1];c>180?c-=360:c<-180&&(c+=360);var h=e.getTarget(),p=n,d=e.getDistance(),v=(new mono.Vec3).subVectors(t,n).length(),m=a[0],g=a[1],y=f[0],b=f[1],w=new mono.Animate({from:0,to:1,repeat:1,dur:r/3,onPlay:function(){this.isPlaying=!0},onUpdate:function(t){var n=y,r=g>b?g+c*t:b,i=p,s=d+(v-d)*t,o=new mono.Vec3;o.x=i.x+s*Math.sin(n*F)*Math.cos(r*F),o.z=i.z+s*Math.cos(n*F)*Math.cos(r*F),o.y=i.y+s*Math.sin(r*F),e.p(o),e.lookAt(i)},onDone:function(){i&&i()},onStop:function(){}}),E=new mono.Animate({from:0,to:1,repeat:1,dur:r/3,onPlay:function(){this.isPlaying=!0},onUpdate:function(t){var n=m+l*t,r=g>b?g:b,i=p,s=d>v?d:v;if(b>=g)var s=v;var o=new mono.Vec3;o.x=i.x+s*Math.sin(n*F)*Math.cos(r*F),o.z=i.z+s*Math.cos(n*F)*Math.cos(r*F),o.y=i.y+s*Math.sin(r*F),e.p(o),e.lookAt(i)},onDone:function(){d=e.getDistance(),h=e.getTarget()},onStop:function(){this.isPlaying&&(delete this.isPlaying,b>=g?i&&i():w.play())}}),S=new mono.Animate({from:0,to:1,dur:r/3,onPlay:function(){this.isPlaying=!0},onUpdate:function(t){var n=m,r=g>b?g:g+c*t,i=(new mono.Vec3).lerpVectors(h,p,t),s=d+(v-d)*t;d>v&&(l!=0||b<g)&&(s=d);var o=new mono.Vec3;o.x=i.x+s*Math.sin(n*F)*Math.cos(r*F),o.z=i.z+s*Math.cos(n*F)*Math.cos(r*F),o.y=i.y+s*Math.sin(r*F),e.p(o),e.lookAt(i)},onDone:function(){},onStop:function(){this.isPlaying&&(delete this.isPlaying,l==0&&b>=g?i&&i():l!=0?E.play():w.play())}});return l==0&&b>=g?(S.dur=r,S.finish=r):l==0?(w.dur=r*2/3,w.finish=r*2/3):b<g&&(E.dur=r*2/3,E.finish=r*2/3),S.play(),H.activeAnimates=[S,E,w],[S,E,w]},H.stopAnimate=function(e,t){Oi(e,t)},H.stopAllAnimates=function(e){Mi(e)},n.Utils=H,n.NurbsUtils={findSpan:function(e,t,n){var r=n.length-e-1;if(t>=n[r])return r-1;if(t<=n[e])return e;var i=e,s=r,o=Math.floor((i+s)/2);while(t<n[o]||t>=n[o+1])t<n[o]?s=o:i=o,o=Math.floor((i+s)/2);return o},calcBasisFunctions:function(e,t,n,r){var i=[],s=[],o=[];i[0]=1;for(var u=1;u<=n;++u){s[u]=t-r[e+1-u],o[u]=r[e+u]-t;var a=0;for(var f=0;f<u;++f){var l=o[f+1],c=s[u-f],h=i[f]/(l+c);i[f]=a+l*h,a=c*h}i[u]=a}return i},calcBSplinePoint:function(e,t,r,i){var s=this.findSpan(e,i,t),o=this.calcBasisFunctions(s,i,e,t),u=new n.Vec4(0,0,0,0);for(var a=0;a<=e;++a){var f=r[s-e+a],l=o[a],c=f.w*l;u.x+=f.x*c,u.y+=f.y*c,u.z+=f.z*c,u.w+=f.w*l}return u},calcBasisFunctionDerivatives:function(e,t,n,r,i){var s=[];for(var o=0;o<=n;++o)s[o]=0;var u=[];for(var o=0;o<=r;++o)u[o]=s.slice(0);var a=[];for(var o=0;o<=n;++o)a[o]=s.slice(0);a[0][0]=1;var f=s.slice(0),l=s.slice(0);for(var c=1;c<=n;++c){f[c]=t-i[e+1-c],l[c]=i[e+c]-t;var h=0;for(var p=0;p<c;++p){var d=l[p+1],v=f[c-p];a[c][p]=d+v;var m=a[p][c-1]/a[c][p];a[p][c]=h+d*m,h=v*m}a[c][c]=h}for(var c=0;c<=n;++c)u[0][c]=a[c][n];for(var p=0;p<=n;++p){var g=0,y=1,b=[];for(var o=0;o<=n;++o)b[o]=s.slice(0);b[0][0]=1;for(var w=1;w<=r;++w){var E=0,S=p-w,x=n-w;p>=w&&(b[y][0]=b[g][0]/a[x+1][S],E=b[y][0]*a[S][x]);var T=S>=-1?1:-S,N=p-1<=x?w-1:n-p;for(var c=T;c<=N;++c)b[y][c]=(b[g][c]-b[g][c-1])/a[x+1][S+c],E+=b[y][c]*a[S+c][x];p<=x&&(b[y][w]=-b[g][w-1]/a[x+1][p],E+=b[y][w]*a[p][x]),u[w][p]=E;var c=g;g=y,y=c}}var p=n;for(var w=1;w<=r;++w){for(var c=0;c<=n;++c)u[w][c]*=p;p*=n-w}return u},calcBSplineDerivatives:function(e,t,r,i,s){var o=s<e?s:e,u=[],a=this.findSpan(e,i,t),f=this.calcBasisFunctionDerivatives(a,i,e,o,t),l=[];for(var c=0;c<r.length;++c){var h=r[c].clone(),p=h.w;h.x*=p,h.y*=p,h.z*=p,l[c]=h}for(var d=0;d<=o;++d){var h=l[a-e].clone().multiplyScalar(f[d][0]);for(var v=1;v<=e;++v)h.add(l[a-e+v].clone().multiplyScalar(f[d][v]));u[d]=h}for(var d=o+1;d<=s+1;++d)u[d]=new n.Vec4(0,0,0);return u},calcKoverI:function(e,t){var n=1;for(var r=2;r<=e;++r)n*=r;var i=1;for(var r=2;r<=t;++r)i*=r;for(var r=2;r<=e-t;++r)i*=r;return n/i},calcRationalCurveDerivatives:function(e){var t=e.length,r=[],i=[];for(var s=0;s<t;++s){var o=e[s];r[s]=new n.Vec3(o.x,o.y,o.z),i[s]=o.w}var u=[];for(var a=0;a<t;++a){var f=r[a].clone();for(var s=1;s<=a;++s)f.sub(u[a-s].clone().multiplyScalar(this.calcKoverI(a,s)*i[s]));u[a]=f.divideScalar(i[0])}return u},calcNURBSDerivatives:function(e,t,n,r,i){var s=this.calcBSplineDerivatives(e,t,n,r,i);return this.calcRationalCurveDerivatives(s)},calcSurfacePoint:function(e,t,r,i,s,o,u){var a=this.findSpan(e,o,r),f=this.findSpan(t,u,i),l=this.calcBasisFunctions(a,o,e,r),c=this.calcBasisFunctions(f,u,t,i),h=[];for(var p=0;p<=t;++p){h[p]=new n.Vec4(0,0,0,0);for(var d=0;d<=e;++d){var v=s[a-e+d][f-t+p].clone(),m=v.w;v.x*=m,v.y*=m,v.z*=m,h[p].add(v.multiplyScalar(l[d]))}}var g=new n.Vec4(0,0,0,0);for(var p=0;p<=t;++p)g.add(h[p].multiplyScalar(c[p]));return g.divideScalar(g.w),new n.Vec3(g.x,g.y,g.z)}},n.GLParameters=function(e,t,r){this.material=e,this.network=t,this.precision=t._precision,this.map=!!e.map,this.mapLoaded=!0,this.envMap=!!e.envMap,this.lightMap=!!e.lightMap,this.bumpMap=!!e.bumpMap&&e._type==="phong",this.normalMap=!!e.normalMap&&e._type==="phong",this.specularMap=!!e.specularMap,this.vertexColors=e.vertexColors,this.wireframe=e.wireframe,this.fog=t._fog,this.useFog=e.fog,this.fogExp=this.fog instanceof n.FogExp2,this.sizeAttenuation=e.sizeAttenuation,this.skinning=e.skinning,this.maxBones=t.maxBones,this.useVertexTexture=t._supportsBoneTextures&&r&&r.useVertexTexture,this.boneTextureWidth=r&&r.boneTextureWidth,this.boneTextureHeight=r&&r.boneTextureHeight,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.maxMorphTargets=t.maxMorphTargets,this.maxMorphNormals=t.maxMorphNormals,this.maxDirLights=t.maxLightCount.directional,this.maxPointLights=t.maxLightCount.point,this.maxSpotLights=t.maxLightCount.spot,this.maxHemiLights=t.maxLightCount.hemi,this.maxShadows=t.maxShadows,this.maxPointShadows=t.maxPointShadows,this.shadowMapEnable=t._shadowMapEnable&&r.receiveShadow&&this.maxShadows>0,this.pointShadowMapEnable=t._shadowMapEnable&&r.receiveShadow&&this.maxPointShadows>0,this.shadowMapType=t.shadowMapType,this.shadowMapDebug=t.shadowMapDebug,this.shadowMapCascade=t.shadowMapCascade,this.alphaTest=e.alphaTest,this.metal=e.metal,this.perPixel=e.perPixel,this.wrapAround=e.wrapAround,this.doubleSided=e.side===n.DoubleSide&&!d.isIE,this.flipSided=e.side===n.BackSide,this.useSSAO=t.isSSAOEnable()&&t.pm.isLightMaterial(e),this.gammaInput=t.gammaInput,this.gammaOutput=t.gammaOutput,this.physicallyBasedShading=t.physicallyBasedShading,this.supportsVertexTextures=!1,this.shadowMapTypeDefine="SHADOWMAP_TYPE_BASIC",this.shadowMapType===n.PCFShadowMap?this.shadowMapTypeDefine="SHADOWMAP_TYPE_PCF":this.shadowMapType===n.PCFSoftShadowMap&&(this.shadowMapTypeDefine="SHADOWMAP_TYPE_PCF_SOFT"),this.maxGrandient=H.getObjectCount(e.gradient)},n.GLParameters.prototype.getShaders=function(e){e=e===t?"":e;var n=this,r=["precision "+n.precision+" float;",e,this.supportsVertexTextures?"#define VERTEX_TEXTURES":"",n.gammaInput?"#define GAMMA_INPUT":"",n.gammaOutput?"#define GAMMA_OUTPUT":"",n.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+n.maxDirLights,"#define MAX_POINT_LIGHTS "+n.maxPointLights,"#define MAX_SPOT_LIGHTS "+n.maxSpotLights,"#define MAX_HEMI_LIGHTS "+n.maxHemiLights,"#define MAX_SHADOWS "+n.maxShadows,"#define MAX_POINT_SHADOWS "+n.maxPointShadows,"#define MAX_BONES "+n.maxBones,n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.lightMap?"#define USE_LIGHTMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.vertexColors?"#define USE_COLOR":"",n.maxGrandient>0?"#define MAX_GRADIENT "+n.maxGrandient:"",n.skinning?"#define USE_SKINNING":"",n.useVertexTexture?"#define BONE_TEXTURE":"",n.boneTextureWidth?"#define N_BONE_PIXEL_X "+n.boneTextureWidth.toFixed(1):"",n.boneTextureHeight?"#define N_BONE_PIXEL_Y "+n.boneTextureHeight.toFixed(1):"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals?"#define USE_MORPHNORMALS":"",n.perPixel?"#define PHONG_PER_PIXEL":"",n.wrapAround?"#define WRAP_AROUND":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnable?"#define USE_SHADOWMAP":"",n.shadowMapEnable||n.pointShadowMapEnable?"#define "+n.shadowMapTypeDefine:"",n.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",n.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",n.pointShadowMapEnable?"#define USE_POINT_SHADOWMAP":"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","attribute vec2 uv2;","#ifdef USE_COLOR","attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n"),i=["precision "+this.precision+" float;",n.bumpMap||n.normalMap?"#extension GL_OES_standard_derivatives : enable":"",e,"#define MAX_DIR_LIGHTS "+n.maxDirLights,"#define MAX_POINT_LIGHTS "+n.maxPointLights,"#define MAX_SPOT_LIGHTS "+n.maxSpotLights,"#define MAX_HEMI_LIGHTS "+n.maxHemiLights,"#define MAX_SHADOWS "+n.maxShadows,"#define MAX_POINT_SHADOWS "+n.maxPointShadows,n.useSSAO?"#define USE_SSAO":"",n.wireframe?"#define USE_WIREFRAME":"",n.alphaTest?"#define ALPHATEST "+n.alphaTest:"",this.gammaInput?"#define GAMMA_INPUT":"",this.gammaOutput?"#define GAMMA_OUTPUT":"",this.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.lightMap?"#define USE_LIGHTMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.maxGrandient>0?"#define MAX_GRADIENT "+n.maxGrandient:"",n.vertexColors?"#define USE_COLOR":"",n.metal?"#define METAL":"",n.perPixel?"#define PHONG_PER_PIXEL":"",n.wrapAround?"#define WRAP_AROUND":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnable?"#define USE_SHADOWMAP":"",n.shadowMapEnable||n.pointShadowMapEnable?"#define "+n.shadowMapTypeDefine:"",n.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",n.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",n.pointShadowMapEnable?"#define USE_POINT_SHADOWMAP":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",""].join("\n");return[r,i]};var q={};q.setDepthTest=function(e,t){var n=t._gl;t._oldDepthTest!==e&&(e?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),t._oldDepthTest=e)},q.setSmapleAlphaToCoverage=function(e,t){var n=t._gl;t._oldSmapleAlphaToCoverage!==e&&(e?n.enable(n.SAMPLE_ALPHA_TO_COVERAGE):n.disable(n.SAMPLE_ALPHA_TO_COVERAGE),t._oldSmapleAlphaToCoverage=e)},q.setDepthWrite=function(e,t){var n=t._gl;t._oldDepthWrite!==e&&(n.depthMask(e),t._oldDepthWrite=e)},q.clear=function(e,n,r,i){var s=i._gl,o=0;if(e===t||e)o|=s.COLOR_BUFFER_BIT;if(n===t||n)o|=s.DEPTH_BUFFER_BIT;if(r===t||r)o|=s.STENCIL_BUFFER_BIT;i._gl.clear(o)},q.setPolygonOffset=function(e,t,n,r){var i=r._gl;r._oldPolygonOffset!==e&&(e?i.enable(i.POLYGON_OFFSET_FILL):i.disable(i.POLYGON_OFFSET_FILL),r._oldPolygonOffset=e),e&&(r._oldPolygonOffsetFactor!==t||r._oldPolygonOffsetUnits!==n)&&(i.polygonOffset(t,n),r._oldPolygonOffsetFactor=t,r._oldPolygonOffsetUnits=n)},q.setBlending=function(e,t,r,i,s){var o=s._gl;e!==s._oldBlending&&(e===n.NoBlending?o.disable(o.BLEND):e===n.AdditiveBlending?(o.enable(o.BLEND),o.blendEquation(o.FUNC_ADD),o.blendFunc(o.SRC_ALPHA,o.ONE)):e===n.SubtractiveBlending?(o.enable(o.BLEND),o.blendEquation(o.FUNC_ADD),o.blendFunc(o.ZERO,o.ONE_MINUS_SRC_COLOR)):e===n.MultiplyBlending?(o.enable(o.BLEND),o.blendEquation(o.FUNC_ADD),o.blendFunc(o.ZERO,o.SRC_COLOR)):e===n.CustomBlending?o.enable(o.BLEND):(o.enable(o.BLEND),o.blendEquationSeparate(o.FUNC_ADD,o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)),s._oldBlending=e);if(e===n.CustomBlending){t!==this._oldBlendEquation&&(o.blendEquation(H.paramToGL(t)),s._oldBlendEquation=t);if(r!==_oldBlendSrc||i!==_oldBlendDst)o.blendFunc(H.paramToGL(r),H.paramToGL(i)),s._oldBlendSrc=r,s._oldBlendDst=i}else s._oldBlendEquation=null,s._oldBlendSrc=null,s._oldBlendDst=null},q.enableStencil=function(e){e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,1),e.stencilOp(e.KEEP,e.REPLACE,e.REPLACE),e.stencilMask(1),e.clearStencil(0),e.clear(e.STENCIL_BUFFER_BIT)},q.stencilTest=function(e){e.enable(e.STENCIL_TEST),e.stencilFunc(e.EQUAL,0,1),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(0)},q.disableStencil=function(e){e.disable(e.STENCIL_TEST)},q.r=function(e,t,n,r,i,s,o){e._AK47(t,n,r,i,s,o)},q.g=function(e,t,n,r,i,s){e.renderGroup(t,n,r,i,s)},n.GLUtils=q,n.GPU=function(e){var t=e._gl,n=e.webglVersion;this._glExtensionTextureFloat=n>1||t.getExtension("OES_texture_float"),this._glExtensionStandardDerivatives=n>1||t.getExtension("OES_standard_derivatives"),this._glExtensionTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this._glExtensionCompressedTextureS3TC=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),this._glExtensionTextureFloat||console.log("Float textures not supported."),this._glExtensionStandardDerivatives||console.log("Standard derivatives not supported."),this._glExtensionTextureFilterAnisotropic||console.log("Anisotropic texture filtering not supported."),this._glExtensionCompressedTextureS3TC||console.log("S3TC compressed textures not supported."),this._maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._maxCubemapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxAnisotropy=this._glExtensionTextureFilterAnisotropic?t.getParameter(this._glExtensionTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._supportsVertexTextures=this._maxVertexTextures>0,this._supportsBoneTextures=this._supportsVertexTextures&&this._glExtensionTextureFloat,this._compressedTextureFormats=this._glExtensionCompressedTextureS3TC?t.getParameter(t.COMPRESSED_TEXTURE_FORMATS):[],this._vertexShaderPrecisionHighpFloat=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),this._vertexShaderPrecisionMediumpFloat=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),this._vertexShaderPrecisionLowpFloat=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.LOW_FLOAT),this._fragmentShaderPrecisionHighpFloat=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),this._fragmentShaderPrecisionMediumpFloat=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),this._fragmentShaderPrecisionLowpFloat=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_FLOAT),this._vertexShaderPrecisionHighpInt=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_INT),this._vertexShaderPrecisionMediumpInt=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_INT),this._vertexShaderPrecisionLowpInt=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.LOW_INT),this._fragmentShaderPrecisionHighpInt=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_INT),this._fragmentShaderPrecisionMediumpInt=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_INT),this._fragmentShaderPrecisionLowpInt=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_INT);var r=this._vertexShaderPrecisionHighpFloat&&this._vertexShaderPrecisionHighpFloat.precision>0&&this._fragmentShaderPrecisionHighpFloat&&this._fragmentShaderPrecisionHighpFloat.precision>0,i=this._vertexShaderPrecisionMediumpFloat&&this._vertexShaderPrecisionMediumpFloat.precision>0&&this._fragmentShaderPrecisionMediumpFloat&&this._fragmentShaderPrecisionMediumpFloat.precision>0,s=e._precision;s==="highp"&&!r&&(i?(s="mediump",console.log("highp not supported, using mediump")):(s="lowp",console.log("highp and mediump not supported, using lowp"))),s==="mediump"&&!i&&(s="lowp",console.log("mediump not supported, using lowp")),e._precision=s},n.Program=function(e,t,n,r){this.entity=e,this.group=t,this.material=n,this.network=r},n.Program.prototype.setEntity=function(){this.entity},n.Program.prototype.buildGLProgram=function(){},n.Uniform=function(e,n,r){this.id=e,this.type=n,this.value=r,this.location=t},n.Uniform.prototype={constructor:n.Uniform,setValue:function(e){this.value=e},getUniformLocation:function(e,t){return e.getUniformLocation(this.id)}},n.Uniform.loadUniform=function(e,n,r){type=n.type,value=n.value;if(type==="i")r.uniform1i(e,value);else if(type==="f")r.uniform1f(e,value);else if(type==="v2")r.uniform2f(e,value.x,value.y);else if(type==="v3")r.uniform3f(e,value.x,value.y,value.z);else if(type==="v4")r.uniform4f(e,value.x,value.y,value.z,value.w);else if(type==="c")r.uniform3f(e,value.r,value.g,value.b);else if(type==="iv1")r.uniform1iv(e,value);else if(type==="iv")r.uniform3iv(e,value);else if(type==="fv1")r.uniform1fv(e,value);else if(type==="fv")r.uniform3fv(e,value);else if(type==="v2v"){n._array===t&&(n._array=new Float32Array(2*value.length));for(i=0,il=value.length;i<il;i++)offset=i*2,n._array[offset]=value[i].x,n._array[offset+1]=value[i].y;r.uniform2fv(e,n._array)}else if(type==="v3v"){n._array===t&&(n._array=new Float32Array(3*value.length));for(i=0,il=value.length;i<il;i++)offset=i*3,n._array[offset]=value[i].x,n._array[offset+1]=value[i].y,n._array[offset+2]=value[i].z;r.uniform3fv(e,n._array)}else if(type==="v4v"){n._array===t&&(n._array=new Float32Array(4*value.length));for(i=0,il=value.length;i<il;i++)offset=i*4,n._array[offset]=value[i].x,n._array[offset+1]=value[i].y,n._array[offset+2]=value[i].z,n._array[offset+3]=value[i].w;r.uniform4fv(e,n._array)}else if(type==="m4")n._array===t&&(n._array=new Float32Array(16)),value.flattenToArray(n._array),r.uniformMatrix4fv(e,!1,n._array);else if(type==="m4v"){n._array===t&&(n._array=new Float32Array(16*value.length));for(i=0,il=value.length;i<il;i++)value[i].flattenToArrayOffset(n._array,i*16);r.uniformMatrix4fv(e,!1,n._array)}else if(type==="t")texture=value,textureUnit=getTextureUnit(),r.uniform1i(e,textureUnit),!texture||(texture.image instanceof Array&&texture.image.length===6?setCubeTexture(texture,textureUnit):texture instanceof $CubeRenderTargetCube?setCubeTextureDynamic(texture,textureUnit):_this.setTexture(texture,textureUnit));else if(type==="tv"){n._array===t&&(n._array=[]);for(i=0,il=n.value.length;i<il;i++)n._array[i]=getTextureUnit();r.uniform1iv(e,n._array);for(i=0,il=n.value.length;i<il;i++){texture=n.value[i],textureUnit=n._array[i];if(!texture)continue;_this.setTexture(texture,textureUnit)}}},n.Uniform.loadGeneralUniforms=function(e,t,r){var i,s,o,u,a,f,l,c,h,p,d;for(h=0,p=t.length;h<p;h++){u=e.uniforms[t[h][1]];if(!u)continue;i=t[h][0],n.Uniform.loadUniform(i,r)}},n.ProgramManager=function(e){this.id=n.ProgramManagerId++,this.network=e,this.gl=this.network._gl,this.gpu=this.network.gpu,this.programs=[],this.currentProgram=null,this.currentEntity=null,this.currentGroup=null,this.currentMaterial=null,this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0},currentMaterialId:-1},this.textureCount=0,this._lightNeedsUpdate=!0,this._lights={ambient:[0,0,0],directional:{length:0,colors:new Array,positions:new Array},point:{length:0,colors:new Array,positions:new Array,distances:new Array},spot:{length:0,colors:new Array,positions:new Array,distances:new Array,directions:new Array,anglesCos:new Array,exponents:new Array},hemi:{length:0,skyColors:new Array,groundColors:new Array,positions:new Array}},this.gammaInput=!1,this.textureCount=0,this.programMap={},this.textureMap={},this.textureUpdateFlags={},this.glTextureMap={},this.textureMaterialMap={},this.unLoadedImage={},this.materialMap={},this.materialUpdateFlags={},this.handleTextureChange=function(e){if(e.property==="image"||e.property==="loaded"){var t=e.source;this.changeTextureUpdateFlags(t,!0),delete this.unLoadedImage[t._image]}else if(e.property==="disposed"){var t=e.source;this.deallocateTexture(t),t.removePropertyChangeListener(this.handleTextureChange),delete this.textureUpdateFlags[t.id],delete this.textureMap[t.id]}H.getObjectCount(this.unLoadedImage)<=0&&this.network.dirtyNetwork()},this.handleMaterialChange=function(e){if(e.property=="map"||e.property.endsWith("Map")||e.property==="needsUpdate"){var t=e.source;this.materialUpdateFlags[t.id]=!0}else if(e.property==="disposed"){var t=e.source;this.deallocateMaterial(t),t.removePropertyChangeListener(this.handleMaterialChange),delete this.materialUpdateFlags[t.id],delete this.materialMap[t.id],delete this.programMap[t.id]}H.getObjectCount(this.unLoadedImage)<=0&&this.network.dirtyNetwork()}},n.ProgramManager.prototype.addMaterial=function(e){this.materialMap[e.id]==null&&(this.materialMap[e.id]=e,e.addPropertyChangeListener(this.handleMaterialChange,this))},n.ProgramManager.prototype.dispose=function(){for(var e in this.materialMap){var t=this.materialMap[e];t.removePropertyChangeListener(this.handleMaterialChange,this)}this.materialMap={};for(var e in this.textureMap){var n=this.textureMap[e];n.removePropertyChangeListener(this.handleTextureChange,this)}this.textureMap={}},n.ProgramManager.prototype.needsUpdateMaterial=function(e){return this.materialUpdateFlags[e.id]===t||this.materialUpdateFlags[e.id]===!0?!0:e.map instanceof J||e.map instanceof K?!0:!1},n.ProgramManager.prototype.changeMaterialUpdateFlags=function(e,t){this.materialUpdateFlags[e.id]=t},n.ProgramManager.prototype.isLightMaterial=function(e){return e instanceof n.LambertMaterial||e instanceof n.PhongMaterial||e.lights||e._type==="lambert"||e._type==="phong"||e._type==="terrain"},n.ProgramManager.prototype.changeAllMaterialUpdateFlags=function(e,t,n){for(var r in this.materialMap){var i=this.materialMap[r];if(t==null||t.call(n,i))this.materialUpdateFlags[i.id]=e}},n.ProgramManager.prototype.changeAllLightMaterialUpdateFlags=function(e){this.changeAllMaterialUpdateFlags(e,this.isLightMaterial,this)},n.ProgramManager.prototype.addTexture=function(e){e.id!=null&&this.textureMap[e.id]===t&&(this.textureMap[e.id]=e,e.addPropertyChangeListener(this.handleTextureChange,this),e._image.loaded||(this.unLoadedImage[e._image]=1))},n.ProgramManager.prototype.needsUpdateTexture=function(e){return this.textureUpdateFlags[e.id]===t||this.textureUpdateFlags[e.id]===!0?!0:!1},n.ProgramManager.prototype.changeTextureUpdateFlags=function(e,t){this.textureUpdateFlags[e.id]=t;for(var n in this.materialMap){var r=this.materialMap[n];(r.map===e||r.lightMap===e||r.envMap===e||r.normalMap===e||r.specularMap===e)&&this.changeMaterialUpdateFlags(r,!0)}},n.ProgramManager.prototype.buildProgram=function(e,t,r){this.currentEntity=e,this.currentGroup=t,this.currentMaterial=r,r.shaderID||r.setupMaterialShader();var i=new n.GLParameters(this.currentMaterial,this.network,e),s,o,u,a,f=[];r.shaderID?f.push(r.shaderID):(f.push(r.vertexShader),f.push(r.fragmentShader));if(!(r instanceof n.ShaderMaterial))for(Xr in i)Xr!=="material"&&Xr!=="network"&&Xr!=="node"&&(f.push(Xr),f.push(i[Xr]));a=f.join();for(s=0,o=this.programs.length;s<o;s++)if(this.programs[s].code===a){r.program=this.programs[s].program,r.uniformsList=[];for(d in r.uniforms)r.uniformsList.push([r.uniforms[d],d]);return this.programs[s].usedTimes++,this.programs[s].program}u=this.gl.createProgram();var l=i.getShaders(),c=l[1],h=l[0];this.gl.attachShader(u,W("fragment",c+r.fragmentShader,this.gl)),this.gl.attachShader(u,W("vertex",h+r.vertexShader,this.gl)),this.gl.linkProgram(u),!this.gl.getProgramParameter(u,this.gl.LINK_STATUS)&&!this.gl.isContextLost()&&console.log("Could not initialise shader\nVALIDATE_STATUS: "+this.gl.getProgramParameter(u,this.gl.VALIDATE_STATUS)+", gl error ["+this.gl.getError()+"]");if(!u)return u;u.uniforms={},u.attributes={};var p,d,v,s;p=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition","boneGlobalMatrices","morphTargetInfluences"];for(d in r.uniforms)p.push(d);this.attachGLLocations(u,p,"uniform"),p=["position","normal","uv","uv2","tangent","color","skinVertexA","skinVertexB","skinIndex","skinWeight"];for(s=0;s<i.maxMorphTargets;s++)p.push("morphTarget"+s);for(s=0;s<i.maxMorphNormals;s++)p.push("morphNormal"+s);for(v in r.attributes)p.push(v);this.attachGLLocations(u,p,"attribute"),u.id=this.programs.length,this.programs.push({program:u,code:a,usedTimes:1}),this.info.memory.programCount=this.programs.length,r.program=u,r.uniformsList=[];for(d in r.uniforms)r.uniformsList.push([r.uniforms[d],d]);return u},n.ProgramManager.prototype.enableAttribute=function(e,n){var r=n.program.attributes;r.position>=0&&_gl.enableVertexAttribArray(r.position),r.color>=0&&_gl.enableVertexAttribArray(r.color),r.normal>=0&&_gl.enableVertexAttribArray(r.normal);if(n.attributes)for(a in n.attributes)r[a]!==t&&r[a]>=0&&_gl.enableVertexAttribArray(r[a])},n.ProgramManager.prototype.attachGLLocations=function(e,t,n){var r,i,s,o=this.gl;if(n==="uniform")for(r=0,i=t.length;r<i;r++)s=t[r],e.uniforms[s]=o.getUniformLocation(e,s);else if(n==="attribute")for(r=0,i=t.length;r<i;r++)s=t[r],e.attributes[s]=o.getAttribLocation(e,s)},n.ProgramManager.prototype.setProgram=function(e,t,r,i,s,o){this.textureCount=0,this.addMaterial(i);if(this.needsUpdateMaterial(i)){i.setupMaterialShader(),this.programMap[i.id]&&this.deallocateMaterial(i);var u=this.buildProgram(o,s,i);this.programMap[i.id]=u,this.changeMaterialUpdateFlags(i,!1)}var a=!1,f=this.programMap[i.id];if(!f)return f;var l=f.uniforms,c=i.uniforms;f!=this.currentProgram&&(this.gl.useProgram(f),this.currentProgram=f,a=!0),i.id!==this.currentMaterialId&&(this.currentMaterialId=i.id,a=!0);if(a||e!==this.network._currentCamera)this.gl.uniformMatrix4fv(l.projectionMatrix,!1,e.projectionMatrix.elements),e!==this.network._currentCamera&&(this.network._currentCamera=e);r&&i.fog&&r.refreshUniforms(c);if(i.lights||i._type==="phong"||i._type==="lambert"||i._type==="terrain")this._lightNeedsUpdate&&(this.setupLights(f,t),this._lightNeedsUpdate=!1),X(c,this._lights);return a&&i.refreshUniforms(!1,{camera:this.network._camera,network:this.network}),o.receiveShadow&&!i._shadowPass&&this.network.isShadowable()&&(R(c,t),U(c,t)),a&&this.loadUniformsGeneric(f,i.uniformsList,i),i.loadCameraPosition(l,e,this.gl),(i.skinning||i._type==="phong"||i._type==="lambert"||i._type==="terrain"||i instanceof n.ShaderMaterial)&&l.viewMatrix!==null&&this.gl.uniformMatrix4fv(l.viewMatrix,!1,e.worldMatrixInverse.elements),z(l,o,this.gl,this.network),l.modelMatrix!=null&&this.gl.uniformMatrix4fv(l.modelMatrix,!1,o.worldMatrix.elements),this.network._baseRender&&this.loadSSAOUniforms(l,i,a),f},n.ProgramManager.prototype.loadSSAOUniforms=function(e,t,n){if(e.mapSSAO!=null&&this.network._sSAOEnable){var r=e.mapSSAO,i=n?this.getTextureUnit():t._ssaoSlot;this.gl.uniform1i(r,i),this.setTexture(this.network.finalSSAOTarget,i),t._ssaoSlot=i}},n.ProgramManager.prototype.onTextureDispose=function(e){var t=e.target;t.removeEventListener("dispose",onTextureDispose),deallocateTexture(t),this.info.memory.textures--},n.ProgramManager.prototype.deallocateTexture=function(e){var t=this
.gl;if(e._image&&e._image.__webglTextureCube)t.deleteTexture(e._image.__webglTextureCube);else{if(!e.__webglInit)return;e.__webglInit=!1,t.deleteTexture(e.__webglTexture)}},n.ProgramManager.prototype.setTextureParameters=function(e,t,r,i){var s=this.gl,o=this.gpu,u=n.Utils.paramToGL;r&&!i?(s.texParameteri(e,s.TEXTURE_WRAP_S,u(t.wrapS,s)),s.texParameteri(e,s.TEXTURE_WRAP_T,u(t.wrapT,s)),s.texParameteri(e,s.TEXTURE_MAG_FILTER,u(t.magFilter,s)),s.texParameteri(e,s.TEXTURE_MIN_FILTER,u(t.minFilter,s))):(s.texParameteri(e,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(e,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(e,s.TEXTURE_MAG_FILTER,this.filterFallback(t.magFilter)),s.texParameteri(e,s.TEXTURE_MIN_FILTER,this.filterFallback(t.minFilter))),o._glExtensionTextureFilterAnisotropic&&t.type!==n.FloatType&&(t.anisotropy>1||t.__oldAnisotropy)&&(s.texParameterf(e,o._glExtensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,o._maxAnisotropy)),t.__oldAnisotropy=t.anisotropy)},n.ProgramManager.prototype.setCubeTexture=function(e,r){var i=this.gl;this.addTexture(e);var s=e.id;if(e._image.length===6){if(!e._image.loaded)return;var o=n.Utils.isPowerOfTwo,u=n.Utils.paramToGL;if(this.needsUpdateTexture(e)){this.glTextureMap[s]===t&&(this.glTextureMap[s]=i.createTexture(),this.info.memory.texture++),this.changeTextureUpdateFlags(e,!1),i.activeTexture(i.TEXTURE0+r),i.bindTexture(i.TEXTURE_CUBE_MAP,this.glTextureMap[s]),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,e.flipY);var a=e instanceof n.CompressedTexture,f=[];for(var l=0;l<6;l++)this.autoScaleCubemaps&&!a?f[l]=clampToMaxSize(e._image[l],_maxCubemapSize):f[l]=e._image[l];var c=f[0],h=o(c.width)&&o(c.height),p=u(e.format,i),d=u(e.type,i);this.setTextureParameters(i.TEXTURE_CUBE_MAP,e,h);for(var l=0;l<6;l++)if(a){var v,m=f[l].mipmaps;for(var g=0,y=m.length;g<y;g++)v=m[g],i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,p,v.width,v.height,0,v.data)}else i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,p,p,d,f[l]);e.generateMipmaps&&h&&i.generateMipmap(i.TEXTURE_CUBE_MAP),e.needsUpdate=!1,e.onUpdate&&e.onUpdate()}else i.activeTexture(i.TEXTURE0+r),i.bindTexture(i.TEXTURE_CUBE_MAP,this.glTextureMap[s])}},n.ProgramManager.prototype.setCubeTextureDynamic=function(e,t){var n=this.gl;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_CUBE_MAP,e.__webglTexture)},n.ProgramManager.prototype.loadUniformsGeneric=function(e,r,i){var s=this.gl,o,u,a,f,l,c,h,p,d,v,m;for(d=0,v=r.length;d<v;d++){f=e.uniforms[r[d][1]];if(!f)continue;o=r[d][0],a=o.type,u=o.value;if(a==="i")s.uniform1i(f,u);else if(a==="f")s.uniform1f(f,u);else if(a==="v2")s.uniform2f(f,u.x,u.y);else if(a==="v3")s.uniform3f(f,u.x,u.y,u.z);else if(a==="v4")s.uniform4f(f,u.x,u.y,u.z,u.w);else if(a==="c")s.uniform3f(f,u.r,u.g,u.b);else if(a==="iv1")s.uniform1iv(f,u);else if(a==="iv")s.uniform3iv(f,u);else if(a==="fv1")s.uniform1fv(f,u);else if(a==="fv")s.uniform3fv(f,u);else if(a==="v2v"){o._array===t&&(o._array=new Float32Array(2*u.length));for(h=0,p=u.length;h<p;h++)m=h*2,o._array[m]=u[h].x,o._array[m+1]=u[h].y;s.uniform2fv(f,o._array)}else if(a==="v3v"){o._array===t&&(o._array=new Float32Array(3*u.length));for(h=0,p=u.length;h<p;h++)m=h*3,u[h]instanceof n.Color?(o._array[m]=u[h].r,o._array[m+1]=u[h].g,o._array[m+2]=u[h].b):(o._array[m]=u[h].x,o._array[m+1]=u[h].y,o._array[m+2]=u[h].z);s.uniform3fv(f,o._array)}else if(a==="v4v"){o._array===t&&(o._array=new Float32Array(4*u.length));for(h=0,p=u.length;h<p;h++)m=h*4,o._array[m]=u[h].x,o._array[m+1]=u[h].y,o._array[m+2]=u[h].z,o._array[m+3]=u[h].w;s.uniform4fv(f,o._array)}else if(a==="m4")o._array===t&&(o._array=new Float32Array(16)),u.flattenToArray(o._array),s.uniformMatrix4fv(f,!1,o._array);else if(a==="m4v"){o._array===t&&(o._array=new Float32Array(16*u.length));for(h=0,p=u.length;h<p;h++)u[h].flattenToArrayOffset(o._array,h*16);s.uniformMatrix4fv(f,!1,o._array)}else if(a==="t"){l=u,c=this.getTextureUnit(),s.uniform1i(f,c);if(!l)continue;if(l._image instanceof Array&&l._image.length===6)this.setCubeTexture(l,c);else{var g=l._image;this.setTexture(l,c,g?!g.loaded:!0)}}else if(a==="tv"){o._array===t&&(o._array=[]);for(h=0,p=o.value.length;h<p;h++)o._array[h]=this.getTextureUnit();if(o._array.length==0)return;s.uniform1iv(f,o._array);for(h=0,p=o.value.length;h<p;h++){l=o.value[h],c=o._array[h];if(!l)continue;var g=l._image;l instanceof K?this.setCubeTextureDynamic(l,c):this.setTexture(l,c,g?!g.loaded:!0)}}}},n.ProgramManager.prototype.setTexture=function(e,r,i){var s=this.gl,o=n.Utils.isPowerOfTwo,u=e.id;this.addTexture(e);if(!this.needsUpdateTexture(e)||e instanceof J)s.activeTexture(s.TEXTURE0+r),e instanceof J?s.bindTexture(s.TEXTURE_2D,e.__webglTexture):s.bindTexture(s.TEXTURE_2D,this.glTextureMap[u]);else{if(!e._image)return;this.glTextureMap[u]===t&&(this.glTextureMap[u]=s.createTexture(),this.info.memory.textures++),this.changeTextureUpdateFlags(e,!1),s.activeTexture(s.TEXTURE0+r),s.bindTexture(s.TEXTURE_2D,this.glTextureMap[u]),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!e.flipY),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),s.pixelStorei(s.UNPACK_ALIGNMENT,e.unpackAlignment);var a=n.Utils.paramToGL,f=i?n.ImageCache.Logo:e._image,l=o(f.width)&&o(f.height),c=a(e.format,s),h=a(e.type,s);this.setTextureParameters(s.TEXTURE_2D,e,l,i);var p,d=e.mipmaps;if(e instanceof n.PixelsTexture)if(d.length>0&&l){for(var v=0,m=d.length;v<m;v++)p=d[v],s.texImage2D(s.TEXTURE_2D,v,c,p.width,p.height,0,c,h,p.data);e.generateMipmaps=!1}else s.texImage2D(s.TEXTURE_2D,0,c,f.width,f.height,0,c,h,f.data);else if(e instanceof n.CompressedTexture)for(var v=0,m=d.length;v<m;v++)p=d[v],s.compressedTexImage2D(s.TEXTURE_2D,v,c,p.width,p.height,0,p.data);else if(d.length>0&&l){for(var v=0,m=d.length;v<m;v++)p=d[v],s.texImage2D(s.TEXTURE_2D,v,c,c,h,p);e.generateMipmaps=!1}else try{s.texImage2D(s.TEXTURE_2D,0,c,c,h,f)}catch(g){console.log(g)}e.generateMipmaps&&l&&s.generateMipmap(s.TEXTURE_2D),e.onUpdate&&e.onUpdate()}},n.ProgramManager.prototype.getTextureUnit=function(){var e=this.textureCount;return e>=this.gpu._maxTextures&&console.warn("Network3D: trying to use "+e+" texture units while this GPU supports only "+this.gpu._maxTextures),this.textureCount++,e},n.ProgramManager.prototype.deallocateMaterial=function(e){var n=e.program;if(n===t)return;e.program=t;var r,i,s,o=!1;for(r=0,i=this.programs.length;r<i;r++){s=this.programs[r];if(s.program===n){s.usedTimes--,s.usedTimes===0&&(o=!0);break}}if(o===!0){var u=[];for(r=0,i=this.programs.length;r<i;r++)s=this.programs[r],s.program!==n&&u.push(s);this.programs=u,this.gl.deleteProgram(n),this.info.memory.programs--}},n.ProgramManager.prototype.filterFallback=function(e){return e===n.NearestFilter||e===n.NearestMipMapNearestFilter||e===n.NearestMipMapLinearFilter?this.gl.NEAREST:this.gl.LINEAR},n.ProgramManager.prototype.setupLights=function(e,t){var r,i,s,o,u=0,a=0,f=0,l,c,h,p,d,v,m,g=this._lights,y=g.directional.colors,b=g.directional.positions,w=g.point.colors,E=g.point.positions,S=g.point.distances,x=g.spot.colors,T=g.spot.positions,N=g.spot.distances,C=g.spot.directions,k=g.spot.anglesCos,L=g.spot.exponents,A=g.hemi.skyColors,O=g.hemi.groundColors,M=g.hemi.positions,_=0,D=0,P=0,H=0,B=0,j=0,F=0,I=0,q=0,R=0,U=0,z=0,W=new n.Vec3;for(r=0,i=t.size();r<i;r++){s=t.get(r);if(s.onlyShadow)continue;l=s.color,p=s.intensity*this.network.lightIntensityRatio,m=s.distance,s.updateWorldMatrix(!0);if(s instanceof n.AmbientLight){if(!s._visible)continue;this.gammaInput?(u+=l.r*l.r,a+=l.g*l.g,f+=l.b*l.b):(u+=l.r,a+=l.g,f+=l.b)}else if(s instanceof n.DirectionalLight){B+=1;if(!s._visible)continue;s.direction?W.copy(s.direction):(W.copy(s.worldMatrix.getPosition()),W.sub(s.target.worldMatrix.getPosition())),W.normalize();if(W.x===0&&W.y===0&&W.z===0)continue;q=_*3,b[q]=W.x,b[q+1]=W.y,b[q+2]=W.z,this.gammaInput?$(y,q,l,p*p):V(y,q,l,p),_+=1}else if(s instanceof n.PointLight){j+=1;if(!s._visible)continue;R=D*3,this.gammaInput?$(w,R,l,p*p):V(w,R,l,p),v=s.worldMatrix.getPosition(),E[R]=v.x,E[R+1]=v.y,E[R+2]=v.z,S[D]=m,D+=1}else if(s instanceof n.SpotLight){F+=1;if(!s._visible)continue;U=P*3,this.gammaInput?$(x,U,l,p*p):V(x,U,l,p),v=s.worldMatrix.getPosition(),T[U]=v.x,T[U+1]=v.y,T[U+2]=v.z,N[P]=m,W.copy(v),W.sub(s.target.worldMatrix.getPosition()),W.normalize(),C[U]=W.x,C[U+1]=W.y,C[U+2]=W.z,k[P]=Math.cos(s.angle),L[P]=s.exponent,P+=1}else if(s instanceof n.HemisphereLight){I+=1;if(!s._visible)continue;W.copy(s.worldMatrix.getPosition()),W.normalize();if(W.x===0&&W.y===0&&W.z===0)continue;z=H*3,M[z]=W.x,M[z+1]=W.y,M[z+2]=W.z,c=s.color,h=s.groundColor,this.gammaInput?(d=p*p,$(A,z,c,d),$(O,z,h,d)):(V(A,z,c,p),V(O,z,h,p)),H+=1}}for(r=_*3,i=Math.max(y.length,B*3);r<i;r++)y[r]=0;for(r=D*3,i=Math.max(w.length,j*3);r<i;r++)w[r]=0;for(r=P*3,i=Math.max(x.length,F*3);r<i;r++)x[r]=0;for(r=H*3,i=Math.max(A.length,I*3);r<i;r++)A[r]=0;for(r=H*3,i=Math.max(O.length,I*3);r<i;r++)O[r]=0;g.directional.length=_,g.point.length=D,g.spot.length=P,g.hemi.length=H,g.ambient[0]=u,g.ambient[1]=a,g.ambient[2]=f},n.ProgramManagerId=0;var J=function(e,r,i){this.width=e,this.height=r,i=i||{},this.wrapS=i.wrapS!==t?i.wrapS:n.ClampToEdgeWrapping,this.wrapT=i.wrapT!==t?i.wrapT:n.ClampToEdgeWrapping,this.magFilter=i.magFilter!==t?i.magFilter:n.LinearFilter,this.minFilter=i.minFilter!==t?i.minFilter:n.LinearMipMapLinearFilter,this.anisotropy=i.anisotropy!==t?i.anisotropy:1,this.offset=new n.Vec2(0,0),this.repeat=new n.Vec2(1,1),this.format=i.format!==t?i.format:n.RGBAFormat,this.type=i.type!==t?i.type:n.UnsignedByteType,this.depthBuffer=i.depthBuffer!==t?i.depthBuffer:!0,this.stencilBuffer=i.stencilBuffer!==t?i.stencilBuffer:!0,this.generateMipmaps=!0,this.shareDepthFrom=null,this.flipY=!0};J.prototype={constructor:J,clone:function(){var e=new J(this.width,this.height);return e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.format=this.format,e.type=this.type,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e.generateMipmaps=this.generateMipmaps,e.shareDepthFrom=this.shareDepthFrom,e},getUniqueCode:function(){return this._id},dispose:function(){this.dispatchEvent({type:"dispose"})}};var K=function(e,t,n){J.call(this,e,t,n),this.activeCubeFace=0};n.extend(K,J,{}),n.Network3D=function(r,i,s,o){n.Element.call(this);var u=this;this.id=n.Network3DId++,this._interactionDispatcher=new n.EventDispatcher,o=o||{},this.helperBox=new n.DataBox,this.helperBox.addDataBoxChangeListener(this.handleDataBoxChange,this),this._rootView=p.createView("hidden"),this._canvas=s=this.initCanvas(s),this._topCanvas=p.createCanvas(this),this._bottomCanvas=p.createCanvas(this);var a=this._canvas.parentNode;a&&(a.removeChild(this._canvas),a.appendChild(this._rootView),this.adjustRootViewBounds(0,0,this._canvas.width,this._canvas.height)),this._rootView.appendChild(this._bottomCanvas),this._rootView.appendChild(this._canvas),this._rootView.appendChild(this._topCanvas),this.setCanvasPropety(),this._camera=i||new n.PerspectiveCamera,this._camera.addPropertyChangeListener(this.dirtyNetwork,this),this._clearColor=o.clearColor!==t?o.clearColor:new n.Color(16777215),this._clearAlpha=o.clearAlpha!=t?o.clearAlpha:1,this._precision=o.precision!==t?o.precision:"mediump",this.__fog=new n.FogExp2,this.devicePixelRatio=o.devicePixelRatio!==t?o.devicePixelRatio:e.devicePixelRatio!==t?e.devicePixelRatio:1,this._premultipliedAlpha=o.premultipliedAlpha==null?!0:o.premultipliedAlpha,this.lightIntensityRatio=1,d.isIOS||d.isAndroid?(this._antialias=!1,this._preserveDrawingBuffer=!1,this.lightIntensityRatio=.1):(this._preserveDrawingBuffer=o.preserveDrawingBuffer==null?!0:o.preserveDrawingBuffer,this._antialias=o.antialias==t?!0:o.antialias),this._useWebgl2=o.useWebgl2||!1,s.addEventListener("webglcontextlost",function(t){console.log("webgl context lost"),t.preventDefault(),u._animateId&&((u._vrDisplay&&u._vrDisplay.isPresenting?u._vrDisplay:e).cancelAnimationFrame(u._animateId),u._animateId=null)}),s.addEventListener("webglcontextrestored",function(e){console.log("webgl context restored"),u._currentProgram=null,u.billboardRenderer=null,u.pm.dispose(),ii.clear(),u._enabledAttributes={},u._currentGroupHash=null,u._oldLineWidth=null,u.gpu=new n.GPU(u),u.pm=new n.ProgramManager(u),u.setDefaultGLState(),u.dirtyNetwork(),u._clearNodeCache(),Q(u)}),this._gl=this.initGL(),this._currentProgram=null,this.overrideMaterial=null,this._maxLights=o.maxLights!==t?o.maxLights:4,this._projScreenMatrix=new h,this._projScreenMatrixPS=new h,this._frustum=new n.Frustum,this._vector3=new f,this._oldDoubleSided=-1,this._oldFlipSided=-1,this._oldBlending=null,this._oldBlendEquation=null,this._oldBlendSrc=null,this._oldBlendDst=null,this._currentCamera=null,this._enabledAttributes={},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.gpu=new n.GPU(this),this.pm=new n.ProgramManager(this),this.setDefaultGLState(),this.paintSortFunction=n.Defaults.paintSortFunction,this.sortNodes=!0,this.sortOpaqueOrderByMaterial=!0,this.glNodeList=[],this.helperGLNodeList=[],this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0},currentMaterialId:-1},this.projector=new n.Projector,this.up=new n.Vec3(0,1,0),this.position=new n.Vec3(0,0,0),this.seletionMaterial=new n.BasicMaterial,this.seletionMaterial.wireframe=!0,this.seletionMaterial.wireframeLinewidth=1,this.seletionMaterial.color=new n.Color(65280),this.selectionCube=new _,this.selectionCube.material=this.seletionMaterial,this.outlineMaterialMap={},this.selectionCube._modelViewMatrix=new h,this.selectionCube._normalMatrix=new l,this.selectionCube.name="select",this.alarmMaterial=new n.BasicMaterial,this.alarmMaterial.wireframe=!0,this.alarmMaterial.wireframeLinewidth=1,this.alarmMaterial.color=new n.Color(16711680),this.alarmCube=new _,this.alarmCube.material=this.alarmMaterial,this.alarmCube._modelViewMatrix=new h,this.alarmCube._normalMatrix=new l,this.alarmCube.name="alarm";var c=512;this._glowSurface=new n.Plane(2,2),this._glowSurface2=new n.Plane(c,c),this._glowSurface.target=new J(c,c,{type:n.UnsignedByteType}),this._glowSurface.target1=new J(c,c,{type:n.UnsignedByteType}),this._glowSurface.target2=new J(c,c,{type:n.UnsignedByteType}),this._glowSurfaceMaterial=new n.BlurMaterial,this._blurMaterialH=new n.BlurMaterial,this._blurMaterialH.orientation=1,this._blurMaterialV=new n.BlurMaterial,this.deferredPostionMaterial=new n.DeferredMaterial,this.deferredNormalMaterial=new n.DeferredMaterial({isNormal:1}),this.ssaoMaterial=new n.SSAOMaterial,this.ssaoMaterial.map2=new n.Texture(k.ssaoNormalImage);var v=1024;this.deferredPostionTarget=new J(v,v,{type:n.FloatType,magFilter:n.NearestFilter,minFilter:n.NearestFilter}),this.deferredNormalTarget=new J(v,v,{type:n.FloatType,magFilter:n.NearestFilter,minFilter:n.NearestFilter,format:n.RGBFormat}),this.ssaoTarget=new J(v,v,{type:n.FloatType,magFilter:n.NearestFilter,minFilter:n.NearestFilter}),this.ssaoTarget1=new J(c,c,{type:n.UnsignedByteType}),this.ssaoTarget2=new J(c,c,{type:n.UnsignedByteType}),this.finalSSAOTarget=null,this._interactions=null,this.billboardRenderer=null,this.flareRenderer=null,this._groupCounter=0,this.groupMap={},this.groupCountMap={},this.bufferNodeMap={},this.lineMap={},this.particleMap={},this.normalNodeMap={},this.showAxis=!1,this.axisSize=20,this.axisPosition=new n.Vec3(0,0,0),this.axis=new n.Axis({size:this.axisSize}),this.alarmBillboards=[],this.areaPickingRect={},this.setDataBox(r===t?new n.DataBox:r),this.renderCallback=null,this.beforeRenderFunction=null,this.dirtyNetwork(),this.prepareData(),this.autoUpdateCameraAspect=!0,this.shadowMapRenderer=null,this.shadowMapType=n.PCFSoftShadowMap,this.shadowMapCullFace=n.CullFaceFront,this.adjustBounds(this._canvas.width,this._canvas.height,0,0),this.getRootView().addEventListener("mousedown",function(e){u.handleMouseDown(e)}),this.getRootView().addEventListener("mouseup",function(e){u.handleClick(e)}),this.setInteractions([new n.DefaultInteraction(this),new n.SelectionInteraction(this)]),this.doubleClickToLookAtFunction=P.doubleClickToLookAtFunction,Q(this),this.initSurfaceGroup(),this.materialRenderListMap={},this._selectTransparencyThreshold=0,this._pickingTexturePixel=!0,this._dynamicBatchDraw=!1,this._dynamicBatchDrawCountLimit=1024,this.needSmoothNormalFunction=P.needSmoothNormalFunction,this._annotationMap={},this._activeAnnotation=null},n.extend(n.Network3D,n.Data,{___accessor:["shadowMapEnable","editableFunction","keyboardRemoveEnabled","selectTransparencyThreshold","pickingTexturePixel","dynamicBatchDraw","showFps"],setUseFog:function(e){this._useFog=e,this._useFog?this._fog=this.__fog:this._fog=null},setOverloadMaterial:function(e){this._overloadMaterial=e},setFogColor:function(e){this.__fog.color=e},setFogDensity:function(e){this.__fog.density=e},setDataBox:function(e){if(!e)throw"DataBox can not be null";if(this.dataBox===e)return;var t=this.dataBox;t&&(this._clearDataBox(t),t.removeDataBoxChangeListener(this.handleDataBoxChange,this),t.removeDataPropertyChangeListener(this.handleDataPropertyChange,this),t.getAlarmBox().removeDataBoxChangeListener(this.dirtyNetwork,this),t.getSelectionModel().removeSelectionChangeListener(this.dirtyNetwork,this)),this.dataBox=e,this.dataBox.addDataBoxChangeListener(this.handleDataBoxChange,this),this.dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this),this.dataBox.getAlarmBox().addDataBoxChangeListener(this.dirtyNetwork,this),this.dataBox.getSelectionModel().addSelectionChangeListener(this.dirtyNetwork,this),this.firePropertyChange("dataBox",t,this._box),this.glNodeList=[],this.dirtyNetwork(),this._clearNodeCache()},setRenderCallback:function(e){this.renderCallback=e},setBeforeRenderFunction:function(e){this.beforeRenderFunction=e},getDataBox:function(){return this.dataBox},getClearColor:function(){return this._clearColor},setClearColor:function(e){arguments.length==3?(this._clearColor=new n.Color,this._clearColor.setRGB(arguments[0],arguments[1],arguments[2])):(this._clearColor=e,this._clearColor instanceof n.Color||(this._clearColor=new n.Color(e))),this._gl.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearAlpha),this.dirtyNetwork()},setClearAlpha:function(e){this._clearAlpha=e,this._gl.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearAlpha),this.dirtyNetwork()},getClearAlpha:function(){return this._clearAlpha},getPrecision:function(){return this._precision},setPrecision:function(e){this._precesion=e},setSSAOBlur:function(e){this._ssaoBlur=e},setSSAOEnable:function(e){return e&&!this.isFloatTextureSupport()?!1:(this._sSAOEnable=e,this._dirty=!0,!0)},isSSAOEnable:function(){return this._sSAOEnable&&this._baseRender},setSSAOOccluderBias:function(e){this._occluderBias=e,this._dirty=!0},setSSAOSamplingRadius:function(e){this._samplingRadius=e,this._dirty=!0},setSSAOAttenuation:function(e){this._attenuation=e,this._dirty=!0},isFloatTextureSupport:function(){return this._glExtensionTextureFloat!=null},getCamera:function(){return this._camera},setCamera:function(e,t){if(this._camera!=e){var n=this._camera;n.removePropertyChangeListener(this.dirtyNetwork),this._camera=e,this._camera.addPropertyChangeListener(this.dirtyNetwork,this);if(this.autoUpdateCameraAspect){this._camera.setAspect&&this._camera.setAspect(n.aspect);var r=this.getDefaultInteraction();r&&(r.object=this._camera)}t&&(this._camera.p(n.p()),this._camera.lookAt(n.getTarget())),this.dirtyNetwork()}},isVisible:function(e){if(e){if(e instanceof n.Link||e instanceof n.PathLink){if(!e.isVisible())return!1;if(!this.isVisible(e._fromNode))return!1;if(!this.isVisible(e._toNode))return!1}if(!e.isVisible())return!1;if(e._parent)return this.isVisible(e._parent);if(this.visibleFunction)return this.visibleFunction(e)}return!0},setCanvasPropety:function(){this._canvas&&(this._canvas.setAttribute("tabindex",this.id),this._canvas.style.outline="none",this._canvas.style.position="absolute")},initCanvas:function(e){return e===t?document.createElement("canvas"):(typeof e=="string"&&(e=document.getElementById(e)),e)},initGL2:function(e){if(!this._useWebgl2)return;var t=this._canvas.gl;if(!t)try{t=this._canvas.getContext("webgl2",e)||this._canvas.getContext("experimental-webgl2",e)}catch(n){console.log(n)}if(t)return this.webglVersion=2,t;this.webglVersion=1},initGL:function(){var e={preserveDrawingBuffer:this._preserveDrawingBuffer,premultipliedAlpha:this._premultipliedAlpha,antialias:this._antialias,stencil:!0},t=this.initGL2(e);if(t)return t;var n=this._canvas.gl;if(!n)try{n=this._canvas.getContext("webgl",e)||this._canvas.getContext("experimental-webgl",e)}catch(r){console.log(r)}this._initVR(),n||console.error("Can not init webgl context"),this._glExtensionTextureFloat=n.getExtension("OES_texture_float"),this._glExtensionStandardDerivatives=n.getExtension("OES_standard_derivatives"),this._glExtensionTextureFilterAnisotropic=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this._glExtensionCompressedTextureS3TC=n.getExtension("WEBGL_compressed_texture_s3tc")||n.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),this._glExtensionTextureFloat||console.log("TGL.Network3D: Float textures not supported."),this._glExtensionStandardDerivatives||console.log("TGL.Network3D: Standard derivatives not supported."),this._glExtensionTextureFilterAnisotropic||console.log("TGL.Network3D: Anisotropic texture filtering not supported."),this._glExtensionCompressedTextureS3TC||console.log("TGL.Network3D: S3TC compressed textures not supported.");if(!!n)return n;console.log("Error: Your browser does not support WebGL.")},resetRenderInfo:function(){this.info.render.calls=0,this.info.render.vertices=0,this.info.render.faces=0,this.info.render.points=0,this.info.currentMaterialId=-1},_clearDataBox:function(e,t){var n=null;e===this.helperBox?n=this.helperGLNodeList:n=this.glNodeList;for(var r=n.length-1;r>=0;r--){var i=n[r];n.splice(r,1)}n=[],this.prepareData(),this.pm._lightNeedsUpdate=!0,this.pm.changeAllLightMaterialUpdateFlags(!0);var s=this;t=t||e.getDatas(),t.forEach(function(e){s._clearNodeCache(e)}),this.deleteCloneNode()},handleDataBoxChange:function(e){var t=e.kind,r=e.data,i=e.source,s=null;i===this.helperBox?s=this.helperGLNodeList:s=this.glNodeList,t==="add"?r instanceof n.Light?(this.pm._lightNeedsUpdate=!0,this.pm.changeAllLightMaterialUpdateFlags(!0),this.prepareData()):r instanceof n.Annotation?this._createAnnotationDiv(r):(this.addNodeMaterials(r),this.addNode(r,s),r._alarmBillboard&&this.alarmBillboards.push(r._alarmBillboard)):t==="remove"?r instanceof n.Light?(this.pm._lightNeedsUpdate=!0,this.pm.changeAllLightMaterialUpdateFlags(!0),this.prepareData()):r instanceof n.Annotation?this._removeAnnotationDiv(r):(this.removeNode(r,s),this.deleteCloneNode(r)):t==="clear"&&this._clearDataBox(i,e.datas),this.boundingBox=null,this.shadowMapRenderer&&this.shadowMapRenderer.handleDataBoxChange(e),this.dirtyNetwork()},removeNode:function(e,t){for(var n=t.length-1;n>=0;n--){var r=t[n];r.node===e&&t.splice(n,1)}this._clearNodeCache(e)},_clearNodeCache:function(e){if(e){e.oldGroups=e.groups||e.oldGroups;if(e.oldGroups!=null)for(var t in e.oldGroups){var r=e.oldGroups[t],i=this.groupCountMap[r.id];i!=null&&(i--,i<=0?(delete this.groupCountMap[r.id],delete this.groupMap[r.id]):this.groupCountMap[r.id]=i)}for(var s=0;s<this.alarmBillboards.length;s++){var o=this.alarmBillboards[s];o.getParent()===e&&(this.alarmBillboards.splice(s,1),s--)}e instanceof n.Annotation&&this._removeAnnotationDiv(e)}else{for(var u in this.groupMap){var a=this.groupMap[u],f=a._nodeId;this.helperBox.containsById(f)||delete this.groupMap[u]}this.alarmBillboards.splice(0),this.glNodeList=[]}for(var u in this._annotationMap)this._removeAnnotationDiv(u)},addNode:function(e,t){var n=this.addWebGLNode(t,e);for(var r=0;r<n.length;r++){var i=n[r];this.updateWebGLNode(i)}},addNodeMaterials:function(e){var t=e.material,r;if(t instanceof n.Material)this.addMaterial(t);else if(t instanceof n.ArrayMaterial){var i=t.materials,s=i.length;for(r=0;r<s;r++)this.addMaterial(i[r])}},addMaterial:function(e){this.pm.addMaterial(e),e.map&&this.pm.addTexture(e.map)},handleDataPropertyChange:function(e){var t=e.source;if(t instanceof n.Node){var r=e.property;if(t.isSizeChangedProperty(r)||r===n.Styles.MaterailType||r===n.Styles.NormalType){if(t instanceof n.Line){t.verticesNeedUpdate=!0;var i=this.lineMap[t._id];this.initLineBuffers(t),E.buildLineBufferData(t,this._gl.DYNAMIC_DRAW,this._gl,i)}else if(t.groups){t.verticesNeedUpdate=!0;if(r===n.Styles.MaterailType||r===n.Styles.NormalType)t.normalsNeedUpdate=!0;for(var s in t.groups){var o=t.groups[s],i=this.groupMap[o.id],u=E.getMaterial(t,o.materialIndex);t.normalsNeedUpdate&&this.initGroupBuffer(t,o,i,!0),E.buildGroupBufferData(o,t,this._gl.DYNAMIC_DRAW,!t.dynamic,u,this._gl,i,this)}}}else if(r==="materialMapping")this._currentGroupHash=null,this.removeNode(t,this.glNodeList),this.addNode(t,this.glNodeList);else if(r==="alarmBillboard"){var a=e.oldValue,f=e.newValue;this._addNodeAlarmBillboard(t,a,f)}this.addNodeMaterials(t)}else t instanceof n.Light&&(this.pm._lightNeedsUpdate=!0);if(t.isSizeChangedProperty&&t.isSizeChangedProperty(r)||r=="parent"||t.isSpaceChangedProperty(r))this.deleteCloneNode(t),this.boundingBox=null;this.shadowMapRenderer&&this.shadowMapRenderer.handleDataPropertyChange(e),this.dirtyNetwork()},deleteCloneNode:function(e){if(e){var t=e.getId?e.getId():e,n=this.normalNodeMap[t];if(n!=null){n.setParent(null);for(var r in n.groups){var i=n.groups[r];delete this.groupMap[i.id]}}delete this.normalNodeMap[t]}else for(var t in this.normalNodeMap)this.deleteCloneNode(t)},setBlurAmount:function(e){this._blurAmount=e},setBlurScale:function(e){this._blurScale=e},setBlurStrength:function(e){this._blurStrength=e},setBlurGlobalAlpha:function(e){this._blurGlobalAlpha=e},dirtyNetwork:function(e){this.dataBox.batch||(this._dirty=!0)},dirtyShadowMap:function(e){this.shadowMapRenderer&&this.shadowMapRenderer.dirtyShadowMap()},_addNodeAlarmBillboard:function(e,n,r){r===t&&(r=e._alarmBillboard);if(n!=null&&this.alarmBillboards.indexOf(n)!==-1){var i=this.alarmBillboards.indexOf(n);this.alarmBillboards.splice(i,1),n.removePropertyChangeListener(this.dirtyNetwork,this)}r&&this.alarmBillboards.indexOf(r)===-1&&(this.alarmBillboards.push(r),r.addPropertyChangeListener(this.dirtyNetwork,this))},initWebGLNodes:function(e,t){var n=e.getNodes(),r,i;for(r=0,i=n.size();r<i;r++){var s=n.get(r);s.renderSelected=!1,this.addWebGLNode(t,s)}for(r=0,i=t.length;r<i;r++)this.updateWebGLNode(t[r])},updateWebGLNode:function(e){var t=e.node,r=t,i,s,o;if(t instanceof n.Entity){for(var u in t.groups){i=t.groups[u],o=E.getMaterial(t,i.materialIndex);if(t.buffersNeedUpdate){var a=this.groupMap[i.id];this.initGroupBuffer(t,i,a),E.buildGroupBufferData(i,t,this._gl.DYNAMIC_DRAW,!t.dynamic,o,this._gl,a,this)}}t.setUpdateFlags(!1),t.buffersNeedUpdate=!1}else if(t instanceof n.BufferNode)this.setBufferNodeData(t,this._gl.DYNAMIC_DRAW,!t.dynamic);else if(t instanceof n.Line){var a=this.lineMap[t._id];E.buildLineBufferData(t,this._gl.DYNAMIC_DRAW,this._gl,a)}else if(t instanceof n.Particle){var a=this.particleMap[t._id];T(t,this._gl.DYNAMIC_DRAW,this._gl,a)}},addWebGLNode:function(e,r){var i,s,o,u=[],a;this._addNodeAlarmBillboard(r),r._modelViewMatrix=new h,r._normalMatrix=new l;if(r instanceof n.Entity){r.groups==t&&x(r);for(i in r.groups){s=r.groups[i],s.id=s.id===t?n.Network3D.GroupCache._groupCounter++:s.id;var f=this.groupCountMap[s.id]||0;f++,this.groupCountMap[s.id]=f,this.groupMap[s.id]===t&&(this.groupMap[s.id]={});var c=this.groupMap[s.id];c._nodeId=r.getId(),c.__webglVertexBuffer||(this.createGroupBuffer(s,c),this.initGroupBuffer(r,s,c),r.setUpdateFlags(!0))}}else if(r instanceof n.Line){this.lineMap[r._id]==null&&(this.lineMap[r._id]={});var c=this.lineMap[r._id];c._nodeId=r.getId(),c.__webglVertexBuffer||(this.createLineBuffers(r),this.initLineBuffers(r),r.verticesNeedUpdate=!0,r.colorsNeedUpdate=!0,r.lineDistancesNeedUpdate=!0)}else if(r instanceof n.Particle){this.particleMap[r._id]==null&&(this.particleMap[r._id]={});var c=this.particleMap[r._id];c._nodeId=r.getId(),c.__webglVertexBuffer||(this.createParticleBuffers(r),this.initParticleBuffers(r),r.verticesNeedUpdate=!0,r.colorsNeedUpdate=!0)}else r instanceof n.BufferNode?this.initBufferNode(r):r instanceof n.Annotation&&this._createAnnotationDiv(r);if(r instanceof n.Entity){for(i in r.groups)s=r.groups[i],o=E.getMaterial(r,s.materialIndex),a={group:s,node:r,opaque:o.transparent?null:o,transparent:o.transparent?o:null},e.push(a),u.push(a);r.groups===null}else r instanceof n.Line||r instanceof n.LensFlare?(o=r.material,a={group:r,node:r,opaque:o.transparent?null:o,transparent:o.transparent?o:null},e.push(a),u.push(a)):r instanceof n.Particle?(o=r.material,a={group:r,node:r,opaque:o.transparent?null:o,transparent:o.transparent?o:null},e.push(a),u.push(a)):r instanceof n.BufferNode&&(o=r.material instanceof n.ArrayMaterial?r.material.materials[0]:r.material,a={group:r,node:r,opaque:o.transparent?null:o,transparent:o.transparent?o:null},e.push(a),u.push(a));return r.glActive=!0,u},onElementDispose:function(e){var t=e.target;t.removeEventListener("dispose",this.onElementDispose),deallocateElement(t),this.info.memory.geometries--},deallocateElement:function(e){},_AK47:function(e,r,i,s,o,u){var a=this._fog;e.parent===t&&e.updateWorldMatrix(!0,!1),!this._isPresenting&&e.worldMatrixInverse.getInverse(e.worldMatrix),this._projScreenMatrix.multiply(e.projectionMatrix,e.worldMatrixInverse),this._frustum.setFromMatrix(this._projScreenMatrix),i.length===0&&(this.initWebGLNodes(r,i),this.prepareData());var f,l,c,h;if(!u)for(f=0,l=i.length;f<l;f++){c=i[f],h=c.node,h.renderSelected=!1,c.render=!1;if(this.isVisible(h)){this.unrollBufferMaterial(c),this.setupMatrices(h,e);if(!(h instanceof n.Entity||h instanceof n.Particle)||!h.frustumCulled||this._frustum.intersectsObject(h))c.render=!0,this.sortNodes&&(this._vector3.copy(h.worldMatrix.getPosition()),this._vector3.applyProjection(this._projScreenMatrix),h.renderDepth!=null?c.z=h.renderDepth+this._vector3.z:c.z=this._vector3.z)}}var p=new C;p.addAll(s);if(!o&&!u){for(var d=this.alarmBillboards.length-1;d>=0;d--){var v=this.alarmBillboards[d];v.getParent()==null&&this.alarmBillboards.splice(d,1)}p.addAll(this.alarmBillboards)}var m=this;!u&&p.forEach(function(e){e.renderDepth?e.z=e.renderDepth:(m._vector3.copy(e.worldMatrix.getPosition()),m._vector3.applyProjection(m._projScreenMatrix),e.z=m._vector3.z)}),p.size()>0&&!u&&this.billboardRenderer==null&&(this.billboardRenderer=new n.BillboardRenderer);var g=r.getLensFlares();g.size()>0&&!u&&this.flareRenderer==null&&(this.flareRenderer=new n.FlareRenderer);var y=[].concat(i).concat(p._as),b=this.sortNodesFunc(y);this.setBlending(n.NoBlending),this.renderNodes(b,!1,"opaque",e,r.getLights(),!1,null,u,this.sortOpaqueOrderByMaterial),this.renderNodes(b,!0,"transparent",e,r.getLights(),!0,null,u),this.setDepthTest(!0),this.setDepthWrite(!0)},unrollBufferMaterial:function(e){var t=e.node,r=e.group,i,s,o;o=t.material,o instanceof n.ArrayMaterial?(s=r.materialIndex||0,i=o.materials[s],i.transparent?(e.transparent=i,e.opaque=null):(e.opaque=i,e.transparent=null)):(i=o,i&&(i.transparent?(e.transparent=i,e.opaque=null):(e.opaque=i,e.transparent=null)))},renderLicense:function(){},isShadowable:function(){return this.isShadowMapEnable()&&(this.maxShadows>0||this.maxPointShadows>0)},render:function(){if(!this._dirty)return;this.resetRenderInfo(),this._dirty=!1,this.beforeRenderFunction!=null&&this.beforeRenderFunction.call(this);if(this.isShadowable()){this.shadowMapRender(),this.setRenderTarget(t);if(this.debugPointLight)return}Rr.twm(this),this.paintBottom(this._bottomCanvas),this.getShowFps()&&(this.__time=(new Date).getTime()),this.innerRender(this._camera,!0),this.renderAnnotations(this._camera),this.extendRender(this._camera),this.paintTopCanvas();if(this.getShowFps()){this._tpf=(new Date).getTime()-this.__time;var e=this._topCanvas.getContext("2d"),n=(1e3/this._tpf).toFixed(0);n>500&&(n="> 500");var r="FPS:"+n+",TPF:"+this._tpf+" ms";e.font="20px Arial sans-serif",e.fontWeight="bold",e.lineWith=2,e.fillStyle="rgba(0, 0, 0, 1)",e.fillText(r,10,25)}if(this._xyz!=t){var i=this._xyz,s=i.markText,o=i.type,u=i.expired,r=i.innerHTML,a=0,f=0,l,c=this._topCanvas.getBoundingClientRect(),e=this._topCanvas.getContext("2d");s!=t&&s!=null&&s!=""||o=="2"?(e.font="24px Arial sans-serif"
,l=w.getTextSize(e.font,r),e.fillStyle="red",a=this._canvas.width-l.width-20,f=this._canvas.height-l.height-10):(e.font="15px Arial sans-serif",e.fillStyle="rgba(240, 120, 25, 0.6)",l=w.getTextSize(e.font,r),a=this._canvas.width-l.width-20,f=this._canvas.height-l.height-10),e.fillText(r,a,f)}this.renderCallback!=null&&this.renderCallback.call(this)},getTextSize:function(e,t){return w.getTextSize(e,t)},shadowMapRender:function(){this.shadowMapRenderer==null&&(this.shadowMapRenderer=new ui,this.shadowMapRenderer.init(this)),this.glNodeList.length===0&&(this.initWebGLNodes(this.dataBox,this.glNodeList),this.prepareData()),this.shadowMapRenderer.render(this.dataBox,this._camera)},handleMouseDown:function(e){var t=e.target;this.lastX=e.clientX,this.lastY=e.clientY,t.getAttribute("class")=="tgl_annotation"&&t.style.opacity=="1"&&(e.stop=!0,e.stopPropagation())},handleClick:function(e){var t=e.clientX-this.lastX,n=e.clientY-this.lastY;if(Math.abs(t)<.1&&Math.abs(n)<.1){var r=e.target;if(r.getAttribute("clazz")!="tgl_annotation")this._activeAnnotation&&(this._activeAnnotation=null,this.dirtyNetwork());else if(r.style.opacity=="1"){var i=r.getAttribute("id"),s=this.getDataBox().getDataById(i),o=this._annotationMap[i];this.handleDefaultAnnotationClick(s,o),this.handleAnnotationClick(s,o),this.dirtyNetwork()}}},handleDefaultAnnotationClick:function(e,t){this._activeAnnotation!=e&&(this._activeAnnotation=e)},handleAnnotationClick:function(e,t){},renderAnnotations:function(e){var t=this.dataBox.getAnnotations(),n=this;t&&(t.forEach(function(t){n.renderAnnotation(e,t)}),this._createAnnotationStyle());if(this._activeAnnotation){this._createAnnotationToolTipDiv();var r=this._annotationToolTipDiv;r.innerHTML=this._activeAnnotation.getText();var i=this._annotationMap[this._activeAnnotation.getId()];r.parentNode!=i&&i.appendChild(r),r.style.opacity=i.style.opacity}},getAnnotationDiv:function(e){return this._annotationMap[e.getId()]},renderAnnotation:function(e,t){var n=this._annotationMap[t.getId()];n==null&&(n=this._createAnnotationDiv(t)),n.innerHTML=t._label,t.updateWorldMatrix();var r=t.worldMatrix.getPosition(),i=t.getStyle("annotation.class");n.setAttribute("class",i);var s=this.getViewPosition(r),o=this._annotationToolTipDiv;n.style.left=s.x+"px",n.style.top=s.y+"px",n.style.opacity="1";var u=r.distanceTo(e.getPosition()),a=this.getElementByScreenPoint(s,!1);if(a&&a.length>0){var f=a[0];f.distance<u&&(n.style.opacity="0.03")}},_addCSSRule:function(e,t,n,r){r=r||(e.cssRules||e.rules).length,e.insertRule?e.insertRule(t+"{"+n+"}",r):e.addRule&&e.addRule(t,n,r)},_createAnnotationStyle:function(){if(!this._annotationStyle){var e=document.createElement("style");e.appendChild(document.createTextNode("")),document.head.appendChild(e);var t=e.sheet;this._addCSSRule(t,".tgl_annotation","position:absolute;width:16px;height:16px;border-radius:10px;text-align:center;border : 2px solid gray;"),this._addCSSRule(t,".tgl_annotation:hover","border : 2px solid black;"),this._annotationStyle=e}},_removeAnnotationDiv:function(e){var t=e.getId?e.getId():e,n=this._annotationMap[t];n!=null&&this.getRootView().removeChild(n)},_createAnnotationDiv:function(e){var t=document.createElement("div"),n=this,r=e.getStyle("annotation.class");return t.setAttribute("id",e.getId()),t.setAttribute("class",r),t.setAttribute("clazz","tgl_annotation"),this._annotationMap[e.getId()]=t,this.getRootView().appendChild(t),t},_createAnnotationToolTipDiv:function(){if(this._annotationToolTipDiv==null){var e=document.createElement("div");e.setAttribute("class","tgl_annotation_tooltip");var t=document.createElement("style");t.appendChild(document.createTextNode("")),document.head.appendChild(t);var n=t.sheet,r="position: absolute;border: 3px solid #333; background-color: #ccd; padding: 3px;text-align: left;width: 220px;height: 'auto';border-radius: 10px;bottom:35px;left:-13px;";this._addCSSRule(n,".tgl_annotation_tooltip",r),r="content: ' ';position: absolute;top: 100%; border: 1px solid;",this._addCSSRule(n,".tgl_annotation_tooltip:after, .tgl_annotation_tooltip:before",r),r="border-color: #333 transparent transparent transparent;border-width: 16px 17px 0 7px;left: 10px;",this._addCSSRule(n,".tgl_annotation_tooltip:before",r),r="border-color: #ccd transparent transparent transparent;border-width: 12px 11px 0 4px;left: 14px;",this._addCSSRule(n,".tgl_annotation_tooltip:after",r),this._annotationToolTipDiv=e}},extendRender:function(e){},innerRender:function(e,n){e===t&&(e=this._camera);if(e===null){console.log(" no camera");return}this.debug&&console.log("inner Render");if((!this._vrDisplay||!this._vrDisplay.isPresenting)&&this.autoClear){var r=this._clearColor;this._gl.clearColor(r.r,r.g,r.b,this._clearAlpha),q.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil,this)}if(n)for(var i=0;i<this._interactions.length;i++){var s=this._interactions[i];s.update&&s.update()}this.billboardRenderer&&this.billboardRenderer.disable(),this.flareRenderer&&this.flareRenderer.disable(),this._vrDisplay||this._gl.viewport(0,0,this._canvas.width,this._canvas.height);if(this._sSAOEnable){this.linearDepth=e.far-e.near,this.ssaoing=!0,this._renderDeferredTarget(e,this.deferredPostionMaterial,this.deferredPostionTarget),this._renderDeferredTarget(e,this.deferredNormalMaterial,this.deferredNormalTarget),this._setSSAOMaterial(),this._overloadMaterial=null,this._renderSurface(e,this.ssaoTarget,this.ssaoMaterial);var u=this._canvas.width/this._canvas.height;this._ssaoBlur?(this._renderBlurTarget(e,this._blurMaterialH,this.ssaoTarget,this.ssaoTarget1,u),this._renderBlurTarget(e,this._blurMaterialV,this.ssaoTarget1,this.ssaoTarget2,u),this.finalSSAOTarget=this.ssaoTarget2):this.finalSSAOTarget=this.ssaoTarget,this.setRenderTarget(t),this.ssaoing=!1}this.renderOutline=!1,this.renderOutlineGlow=!1,q.enableStencil(this._gl),this._baseRender=!0,q.r(this,e,this.dataBox,this.glNodeList,this.dataBox.getBillboards()),this._baseRender=!1,q.stencilTest(this._gl),this.renderOutline&&q.r(this,e,this.dataBox,this.glNodeList,this.dataBox.getBillboards(),!1,"stencil");if(this.renderOutlineGlow){var a=this._glowSurface.target,f=this._glowSurface.target1,c=this._glowSurface.target2;q.disableStencil(this._gl),this.setRenderTarget(a),a._id=a._id||(new Date).getTime()+"0",f._id=f._id||(new Date).getTime()+"1",c._id=c._id||(new Date).getTime()+"2",this._gl.viewport(0,0,a.width,a.height),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._gl.colorMask(!1,!1,!1,!1),q.r(this,e,this.dataBox,this.glNodeList,[],!1,"glow.unselect"),this._gl.colorMask(!0,!0,!0,!0),q.r(this,e,this.dataBox,this.glNodeList,[],!1,"glow.select");var p,d;this.setRenderTarget(f),this._gl.viewport(0,0,f.width,f.height),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._blurMaterialH.setMap(a);var u=this._canvas.width/this._canvas.height;this._blurMaterialH.texelSize=new o(a.width,a.height/u),this._blurMaterialH.blurAmount=this._blurAmount||5,this._blurMaterialH.blurScale=this._blurScale||1,this._blurMaterialH.blurStrength=this._blurStrength||1,this._blurMaterialH.orientation=1;for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._blurMaterialH,d,this._glowSurface2);this.setRenderTarget(c),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._blurMaterialV.setMap(f),this._blurMaterialV.texelSize=new o(f.width,f.height/u),this._blurMaterialV.blurAmount=this._blurAmount||5,this._blurMaterialV.blurScale=this._blurScale||1,this._blurMaterialV.blurStrength=this._blurStrength||1,this._blurMaterialV.orientation=0;for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._blurMaterialV,d,this._glowSurface2);this.setRenderTarget(t),this._glowSurface._modelViewMatrix=new h,this._glowSurface._normalMatrix=new l,this.setupMatrices(this._glowSurface,e),this._glowSurfaceMaterial.setMap(c),this._glowSurfaceMaterial.useBlur=0,this._glowSurfaceMaterial.blurGlobalAlpha=this._blurGlobalAlpha||1,q.setBlending(this._glowSurfaceMaterial.blendMode,this._glowSurfaceMaterial.blendEquation,this._glowSurfaceMaterial.blendSrc,this._glowSurfaceMaterial.blendDst,this),this._gl.enable(this._gl.STENCIL_TEST);for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._glowSurfaceMaterial,d,this._glowSurface);this.setRenderTarget(f),this._gl.viewport(0,0,f.width,f.height),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._blurMaterialH.setMap(a);var u=this._canvas.width/this._canvas.height;this._blurMaterialH.texelSize=new o(a.width,a.height/u),this._blurMaterialH.blurAmount=this._blurAmount||10,this._blurMaterialH.blurScale=this._blurScale||1,this._blurMaterialH.blurStrength=this._blurStrength||1,this._blurMaterialH.orientation=0;for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._blurMaterialH,d,this._glowSurface2);this.setRenderTarget(c),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._blurMaterialV.setMap(f),this._blurMaterialV.texelSize=new o(f.width,f.height/u),this._blurMaterialV.blurAmount=this._blurAmount||10,this._blurMaterialV.blurScale=this._blurScale||1,this._blurMaterialV.blurStrength=this._blurStrength||1,this._blurMaterialV.orientation=1;for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._blurMaterialV,d,this._glowSurface2);this.setRenderTarget(t),this._glowSurface._modelViewMatrix=new h,this._glowSurface._normalMatrix=new l,this.setupMatrices(this._glowSurface,e),this._glowSurfaceMaterial.setMap(c),this._glowSurfaceMaterial.useBlur=0,this._glowSurfaceMaterial.blurGlobalAlpha=this._blurGlobalAlpha||1,q.setBlending(this._glowSurfaceMaterial.blendMode,this._glowSurfaceMaterial.blendEquation,this._glowSurfaceMaterial.blendSrc,this._glowSurfaceMaterial.blendDst,this),this._gl.enable(this._gl.STENCIL_TEST);for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._glowSurfaceMaterial,d,this._glowSurface);this._gl.clearColor(0,0,0,0)}q.disableStencil(this._gl),this.renderHelper(e)},_renderDeferredTarget:function(e,t,r,i){i=i||new n.Vec4(0,0,0,0,0),t.linearDepth=this.linearDepth,this.setRenderTarget(r),this._overloadMaterial=t,this._gl.clearColor(i.x,i.y,i.z,i.w),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),q.r(this,e,this.dataBox,this.glNodeList,this.dataBox.getBillboards())},_renderBlurTarget:function(e,t,r,i,s){clearColor=clearColor||new n.Vec4(0,0,0,0,0),this.setRenderTarget(i),this._gl.viewport(0,0,i.width,i.height),this._gl.clearColor(clearColor.x,clearColor.y,clearColor.z,clearColor.w),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),t.setMap(r),t.texelSize=new o(r.width,r.height/s),t.blurAmount=this._blurAmount||5,t.blurScale=this._blurScale||1,t.blurStrength=this._blurStrength||1;var u,a;for(u in this._glowSurface.groups)a=this._glowSurface.groups[u],this.renderGroup(e,[],t,a,this._glowSurface2)},_setSSAOMaterial:function(){this.ssaoMaterial.map=this.deferredPostionTarget,this.ssaoMaterial.map1=this.deferredNormalTarget,this.ssaoMaterial.attenuation=this._attenuation||new o(1,.02),this.ssaoMaterial.occluderBias=this._occluderBias||.5,this.ssaoMaterial.samplingRadius=this._samplingRadius||20,this.ssaoMaterial.texelSize=new o(1/this.deferredPostionTarget.width,1/this.deferredPostionTarget.height)},_renderSurface:function(e,t,r,i){i=i||new n.Vec4(1,1,1,1),this.setRenderTarget(t),this._gl.clearColor(i.x,i.y,i.z,i.w),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._glowSurface._modelViewMatrix=new h,this._glowSurface._normalMatrix=new l,this.setupMatrices(this._glowSurface,e);var s,o;for(o in this._glowSurface.groups)s=this._glowSurface.groups[o],this.renderGroup(e,[],r,s,this._glowSurface)},renderHelper:function(e){q.r(this,e,this.helperBox,this.helperGLNodeList,this.helperBox.getBillboards(),"stencil")},initSurfaceGroup:function(){this._glowSurface.setUpdateFlags(!0),x(this._glowSurface);for(var e in this._glowSurface.groups){var r=this._glowSurface.groups[e];r.id=r.id===t?n.Network3D.GroupCache._groupCounter++:r.id,this.groupMap[r.id]===t&&(this.groupMap[r.id]={});var i=this.groupMap[r.id];this.createGroupBuffer(r,i),this.initGroupBuffer(this._glowSurface,r,i),E.buildGroupBufferData(r,this._glowSurface,this._gl.DYNAMIC_DRAW,!1,this._glowSurfaceMaterial,this._gl,i,this)}this._glowSurface2.setUpdateFlags(!0),x(this._glowSurface2);for(var e in this._glowSurface2.groups){var r=this._glowSurface2.groups[e];r.id=r.id===t?n.Network3D.GroupCache._groupCounter++:r.id,this.groupMap[r.id]===t&&(this.groupMap[r.id]={});var i=this.groupMap[r.id];this.createGroupBuffer(r,i),this.initGroupBuffer(this._glowSurface2,r,i),E.buildGroupBufferData(r,this._glowSurface2,this._gl.DYNAMIC_DRAW,!1,this._glowSurfaceMaterial,this._gl,i,this)}},getOutlineMaterial:function(e,t){var r=(t.getStyle("select.width")||1)+1+" "+(new n.Color(t.getStyle("select.color"))).getUniqueCode()+e,i=this.outlineMaterialMap[r];return i==null&&(i=new n.EntityMaterial,e=="outline.normal"?(i._type="outline",i.outline=t.getStyle("select.width")||1):e=="outline.glow"?i._type="basic":(i.wireframe=!0,i.wireframeLinewidth=(t.getStyle("select.width")||1)+1),i.color=new n.Color(t.getStyle("select.color")),this.outlineMaterialMap[r]=i),i},renderNodes:function(e,t,r,i,s,o,u,a,f){if(a==="glow.unselect"&&o)return;var l,c,h,p,d,v,m;t?(d=e.length-1,v=-1,m=-1):(d=0,v=e.length,m=1);var g=null;for(var y=d;y!==v;y+=m){l=e[y],p=l.node?l.transparent||l.opaque:l.material;if(!p)continue;this._overloadMaterial&&(p=this._overloadMaterial);var b=this.getOverLoadMaterial(l.node?l.node:l,p);if(b){var w=b.getUniqueCode(),E=ii.getMaterial(w);E?p=E:(ii.setMaterial(w,b),p=b)}if(r=="opaque"&&p.transparent==1)continue;if(r=="transparent"&&p.transparent==0)continue;o?(q.setBlending(p.blendMode,p.blendEquation,p.blendSrc,p.blendDst,this),q.setDepthWrite(!1,this)):q.setDepthWrite(p.depthMask,this);if(l instanceof n.Billboard){var S=l.material.transparent?"transparent":"opaque";r==S&&this.billboardRenderer.render(this,[l],i,this._canvas.width*2,this._canvas.height*2,b)}else if(l.render){this.billboardRenderer&&this.billboardRenderer.disable(),this.flareRenderer&&this.flareRenderer.disable(),c=l.node,h=l.group,q.setDepthTest(p.depthTest,this),q.setPolygonOffset(p.polygonOffset,p.polygonOffsetFactor,p.polygonOffsetUnits,this),this.setGLFaces(p);if(c instanceof n.Particle){if(c.verticesNeedUpdate||c.colorsNeedUpdate||c.sortParticles){var x=this.particleMap[c._id];T(c,this._gl.DYNAMIC_DRAW,this._gl,x)}c.verticesNeedUpdate=!1,c.colorsNeedUpdate=!1}var N=a==="stencil",C=this.getSelectStyle(c);C=="outline"&&(C="outline.normal"),a?a==="glow.unselect"&&(c.isSelected()||(c instanceof n.BufferNode?this.renderBufferNode(i,s,p,h,c):q.g(this,i,s,p,h,c))):(!c.isSelected()||C!=="outline.normal"&&C!=="outline.wireframe"&&C!=="outline.glow"?this.setStencilTest(!1):(this.setStencilTest(!0),C==="outline.glow"?this.renderOutlineGlow=!0:this.renderOutline=!0),c instanceof n.BufferNode?this.renderBufferNode(i,s,p,h,c):(this._gl.stencilMask(this._oldStencilTest?1:0),q.g(this,i,s,p,h,c)));if(c.isSelected()&&this.renderSelect(c))if(C==="outline.normal"||C==="outline.wireframe"||C==="outline.glow"){if(a!=null&&a!="glow.unselect")if(C==="outline.normal"){if(c.renderSelected===!1){var k=this.getOutlineMaterial(C,c),L=this.normalNodeMap[c.getId()];if(L==null){var L=this.cloneNode(c,k);this.normalNodeMap[c.getId()]=L}this.setupMatrices(L,i);for(var A in L.groups)q.g(this,i,s,k,L.groups[A],L);c.renderSelected=!0}}else if(C!=="outline.normal"){var k=this.getOutlineMaterial(C,c);q.g(this,i,s,k,h,c)}}else c.renderSelected===!1&&(this.renderNodeSelection(i,s,c),c.renderSelected=!0);c instanceof n.LensFlare&&this.flareRenderer&&this.flareRenderer.render(this,[l],i,this._canvas.width*2,this._canvas.height*2),c.getAlarmState().getPropagateSeverity()&&this.renderAlarmBorder(c)&&this.renderNodeAlarm(i,s,c)}c&&c.setUpdateFlags(!1)}},cloneNode:function(e,t){var r=new n.Entity,i={vertices:[],uvs:[],faces:[]},s,o,u,a,f;for(s=0,o=e.vertices.length;s<o;s++)i.vertices.push(e.vertices[s].clone());for(s=0,o=e.faces.length;s<o;s++)i.faces.push(e.faces[s].clone());for(s=0,o=e.uvs.lenght;s<o;s++){var c=uvs[s],p=[];for(var d=0;d<c;d++)p.push(c[d].clone());i.uvs.push(p)}return n.Node.prototype.mergeVertices.call(i),n.Node.prototype.computeFaceNormals.call(i),n.Node.prototype.computeVertexNormals.call(i,!0),r.setPosition(e.getPosition()),r.setScale(e.getScale()),r.setRotation(e.getRotation()),r.setParent(e.getParent()),r._modelViewMatrix=new h,r._normalMatrix=new l,r.data=i,r.vertices=i.vertices,r.uvs=i.uvs,r.faces=i.faces,r.material=t,r.primitive=new n.Primitive(i),r.setUpdateFlags(!0),x(r),this.buildNodeBufferData(r),r},buildNodeBufferData:function(e){for(var r in e.groups){var i=e.groups[r];i.id=i.id===t?n.Network3D.GroupCache._groupCounter++:i.id,this.groupMap[i.id]===t&&(this.groupMap[i.id]={});var s=this.groupMap[i.id];this.createGroupBuffer(i,s),this.initGroupBuffer(e,i,s),E.buildGroupBufferData(i,e,this._gl.DYNAMIC_DRAW,!1,e.material,this._gl,s,this)}},needSmoothNormal:function(e,r){var i=r.normalType;return i!=t?i===n.NormalTypeSmooth:this.needSmoothNormalFunction?this.needSmoothNormalFunction(e):!1},renderNodeSelection:function(e,r,i){i.createSelectionCube(this.selectionCube),this.setupMatrices(this.selectionCube,e);var s=this.selectionCube.groups;this.selectionCube.material.needsUpdate=!0;for(var o in s){var u=s[o];u.id=u.id===t?n.Network3D.GroupCache._groupCounter++:u.id,this.groupMap[u.id]===t&&(this.groupMap[u.id]={});var a=this.groupMap[u.id];a.__webglVertexBuffer||(this.createGroupBuffer(u,a),this.initGroupBuffer(i,u,a)),this.selectionCube.setUpdateFlags(!0),E.buildGroupBufferData(u,this.selectionCube,this._gl.DYNAMIC_DRAW,!1,this.selectionCube.material,this._gl,a,this),this.renderGroup(e,[],this.selectionCube.material,u,this.selectionCube)}},renderNodeAlarm:function(e,r,i){i.createPropagateAlarmCube(this.alarmCube),this.setupMatrices(this.alarmCube,e);var s=this.alarmCube.groups;this.alarmCube.material.needsUpdate=!0;for(var o in s){var u=s[o];u.id=u.id===t?n.Network3D.GroupCache._groupCounter++:u.id,this.groupMap[u.id]===t&&(this.groupMap[u.id]={});var a=this.groupMap[u.id];a.__webglVertexBuffer||(this.createGroupBuffer(u,a),this.initGroupBuffer(i,u,a)),this.alarmCube.setUpdateFlags(!0),E.buildGroupBufferData(u,this.alarmCube,this._gl.DYNAMIC_DRAW,!1,this.alarmCube.material,this._gl,a,this),this.renderGroup(e,[],this.alarmCube.material,u,this.alarmCube)}},renderBufferNode:function(e,t,n,r,i,s){if(n.visible===!1)return;var o,u,a,f,l,c;o=this.pm.setProgram(e,t,this._fog,n,r,i),u=o.attributes;var h=i,p=!1,d=n.wireframe?1:0,v=r._id*16777215+o.id*2+d;if(v!==this._currentGroupHash||s)this._currentGroupHash=v,p=!0;p&&this.disableAttributes();var m=this._gl,g=h.attributes.index,y=this.bufferNodeMap[i._id];if(g){var b=h.offsets;b.length>1&&(p=!0);for(var w=0,E=b.length;w<E;w++){var S=b[w].index;if(p){var x=h.attributes.position,T=x.itemSize;m.bindBuffer(m.ARRAY_BUFFER,y.position),this.enableAttribute(u.position),m.vertexAttribPointer(u.position,T,m.FLOAT,!1,0,S*T*4);var N=h.attributes.normal;if(u.normal>=0&&N){var C=N.itemSize;m.bindBuffer(m.ARRAY_BUFFER,y.normal),this.enableAttribute(u.normal),m.vertexAttribPointer(u.normal,C,m.FLOAT,!1,0,S*C*4)}var k=h.attributes.uv;if(u.uv>=0&&k){var L=k.itemSize;m.bindBuffer(m.ARRAY_BUFFER,y.uv),this.enableAttribute(u.uv),m.vertexAttribPointer(u.uv,L,m.FLOAT,!1,0,S*L*4)}var A=h.attributes.color;if(u.color>=0&&A){var O=A.itemSize;m.bindBuffer(m.ARRAY_BUFFER,y.color),this.enableAttribute(u.color),m.vertexAttribPointer(u.color,O,m.FLOAT,!1,0,S*O*4)}m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,y.index)}m.drawElements(m.TRIANGLES,b[w].count,m.UNSIGNED_SHORT,b[w].start*2),this.info.render.calls++,this.info.render.vertices+=b[w].count,this.info.render.faces+=b[w].count/3}}else{if(p){var x=h.attributes.position,T=x.itemSize;m.bindBuffer(m.ARRAY_BUFFER,x.buffer),this.enableAttribute(u.position),m.vertexAttribPointer(u.position,T,m.FLOAT,!1,0,0);var N=h.attributes.normal;if(u.normal>=0&&N){var C=N.itemSize;m.bindBuffer(m.ARRAY_BUFFER,N.buffer),this.enableAttribute(u.normal),m.vertexAttribPointer(u.normal,C,m.FLOAT,!1,0,0)}var k=h.attributes.uv;if(u.uv>=0&&k){var L=k.itemSize;m.bindBuffer(m.ARRAY_BUFFER,k.buffer),this.enableAttribute(u.uv),m.vertexAttribPointer(u.uv,L,m.FLOAT,!1,0,0)}var A=h.attributes.color;if(u.color>=0&&A){var O=A.itemSize;m.bindBuffer(m.ARRAY_BUFFER,A.buffer),this.enableAttribute(u.color),m.vertexAttribPointer(u.color,O,m.FLOAT,!1,0,0)}}var x=h.attributes.position;m.drawArrays(m.TRIANGLES,0,x.numItems/3),this.info.render.calls++,this.info.render.vertices+=x.numItems/3,this.info.render.faces+=x.numItems/3/3}},getOverLoadMaterial:function(e,t){return null},renderGroup:function(e,t,r,i,s){r==null&&console.log("material is null");if(r.visible===!1)return;var o=this._gl,u;s instanceof n.Entity?u=this.groupMap[i.id]:s instanceof n.Line?u=this.lineMap[i._id]:s instanceof n.Particle&&(u=this.particleMap[i._id]);if(u==null){this.debug&&console.error("tempGroup for id:"+(i.id||i._id)+" is null,please check");return}var a,f,l,c,h,p,d,v;a=this.pm.setProgram(e,t,this._fog,r,i,s);if(!a)return;f=a.attributes;var m=!1,g=r.wireframe?1:0,y;i.id!=null?y=i.id*16777215+a.id*2+g:y=i._id+""+(a.id*2+g),y!==this._currentGroupHash&&(this._currentGroupHash=y,m=!0),m&&this.disableAttributes();if(m){u.__vao&&o.bindVertexArray(u.__vao);if(!u.__vao||u.__vao.dirty){f.position>=0&&m&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglVertexBuffer),this.enableAttribute(f.position),o.vertexAttribPointer(f.position,3,o.FLOAT,!1,0,0));if(u.__webglCustomAttributesList)for(d=0,v=u.__webglCustomAttributesList.length;d<v;d++)p=u.__webglCustomAttributesList[d],f[p.buffer.belongsToAttribute]>=0&&(o.bindBuffer(o.ARRAY_BUFFER,p.buffer),this.enableAttribute(f[p.buffer.belongsToAttribute]),o.vertexAttribPointer(f[p.buffer.belongsToAttribute],p.size,o.FLOAT,!1,0,0));f.color>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglColorBuffer),this.enableAttribute(f.color),o.vertexAttribPointer(f.color,3,o.FLOAT,!1,0,0)),f.normal>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglNormalBuffer),this.enableAttribute(f.normal),o.vertexAttribPointer(f.normal,3,o.FLOAT,!1,0,0)),f.uv>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglUVBuffer),this.enableAttribute(f.uv),o.vertexAttribPointer(f.uv,2,o.FLOAT,!1,0,0)),f.uv2>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglUV2Buffer),this.enableAttribute(f.uv2),o.vertexAttribPointer(f.uv2,2,o.FLOAT,!1,0,0)),f.lineDistance>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglLineDistanceBuffer),this.enableAttribute(f.lineDistance),o.vertexAttribPointer(f.lineDistance,1,o.FLOAT,!1,0,0)),u.__vao&&(u.__vao.dirty=!1)}}s instanceof n.Entity?(r.wireframe?(this.setLineWidth(r.wireframeLinewidth),this._gl.lineJoin="round",m&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,u.__webglLineBuffer),o.drawElements(o.LINES,u.__webglLineCount,o.UNSIGNED_SHORT,0)):(m&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,u.__webglFaceBuffer),o.drawElements(o.TRIANGLES,u.__webglFaceCount,o.UNSIGNED_SHORT,0)),this.info.render.calls++,this.info.render.vertices+=u.__webglFaceCount,this.info.render.faces+=u.__webglFaceCount/3):s instanceof n.Line?(c=s.type===n.LineStrip?o.LINE_STRIP:o.LINES,this.setLineWidth(r.linewidth),o.drawArrays(c,0,u.__webglLineCount),this.info.render.calls++):s instanceof n.Particle?(o.drawArrays(o.POINTS,0,u.__webglParticleCount),this.info.render.calls++,this.info.render.points+=u.__webglParticleCount):s instanceof n.Ribbon&&(o.drawArrays(o.TRIANGLE_STRIP,0,i.__webglVertexCount),this.info.render.calls++),u.__vao&&o.bindVertexArray(null)},prepareData:function(){this.maxLightCount=this.dataBox.allocateLights(this._maxLights),this.maxShadows=this.dataBox.allocateShadows(),this.maxPointShadows=this.dataBox.allocatePointShadows()},wrapBillboardMaterial:function(e){e instanceof n.Billboard&&e.material&&(e.opaque=e.material.transparent?null:e.material,e.transparent=e.material.transparent?e.material:null)},sortNodesFunc:function(e){if(this.sortNodes&&(this.paintSortFunction!==null||this.sortOpaqueOrderByMaterial)){var t=this;this.sortOpaqueOrderByMaterial?this.__st==null&&(this.__st=function(e,n){t.wrapBillboardMaterial(e),t.wrapBillboardMaterial(e);var r="opaque";if(e[r]&&n[r])return e[r].id-n[r].id;if(!e[r]&&n[r])return-1;if(e[r]&&!n[r])return 1;if(e.transparent&&n.transparent)return e.transparent.id-n.transparent.id;var i=e.node?e.node:e,s=n.node?n.node:n;i.z=e.z,s.z=n.z;if(t.paintSortFunction)return t.paintSortFunction(i,s)}):this.__st==null&&(this.__st=function(e,n){if(e.transparent||n.transparent)return e.transparent&&n.transparent?e.transparent.id-n.transparent.id:e.transparent?-1:1;var r=e.node?e.node:e,i=n.node?n.node:n;r.z=e.z,i.z=n.z;if(t.paintSortFunction)return t.paintSortFunction(r,i)}),e.sort(this.__st)}return e},renderNode:function(e,t){this.setupMatrices(e),e instanceof n.Entity&&renderEntity(e)},paintTopCanvas:function(){var e=this._topCanvas.getContext("2d");e.clearRect(0,0,this._topCanvas.width,this._topCanvas.height);var t=this.areaPickingRect;t&&(e.beginPath(),e.lineStyle="#FFffff",e.rect(t.x,t.y,t.w,t.h),e.stroke()),this.renderLicense()},setBackgroundImage:function(e){if(typeof e=="string"){var t=new Image;e.startsWith("data:image")||(t.crossOrigin="use-credentials"),t.src=e,this._backgroundImage=t;var n=this;t.onload=function(){n.dirtyNetwork()}}else this._backgroundImage=e,this.dirtyNetwork()},paintBottom:function(e){var t=e.getContext("2d");t.clearRect(0,0,e.width,e.height);var n=this._backgroundImage;n instanceof Image&&n.height&&t.drawImage(n,0,0,e.width,e.height)},initBufferNode:function(e){if(!this.bufferNodeMap[e._id]){var t={};this.bufferNodeMap[e._id]=t;var n,r,i,s=this._gl;for(n in e.attributes)n==="index"?i=s.ELEMENT_ARRAY_BUFFER:i=s.ARRAY_BUFFER,r=e.attributes[n],t[n]=s.createBuffer(),s.bindBuffer(i,t[n]),s.bufferData(i,r.array,s.STATIC_DRAW)}},setBufferNodeData:function(e,n,r){var i=this.bufferNodeMap[e._id],s=e.attributes,o=s.index,u=s.position,a=s.normal,f=s.uv,l=s.color,c=s.tangent,h=this._gl;e.elementsNeedUpdate&&o!==t&&(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,i.index),h.bufferData(h.ELEMENT_ARRAY_BUFFER,o.array,n)),e.verticesNeedUpdate&&u!==t&&(h.bindBuffer(h.ARRAY_BUFFER,i.position),h.bufferData(h.ARRAY_BUFFER,u.array,n)),e.normalsNeedUpdate&&a!==t&&(h.bindBuffer(h.ARRAY_BUFFER,i.normal),h.bufferData(h.ARRAY_BUFFER,a.array,n)),e.uvsNeedUpdate&&f!==t&&(h.bindBuffer(h.ARRAY_BUFFER,i.uv),h.bufferData(h.ARRAY_BUFFER,f.array,n)),e.colorsNeedUpdate&&l!==t&&(h.bindBuffer(h.ARRAY_BUFFER,i.color),h.bufferData(h.ARRAY_BUFFER,l.array,n));if(r)for(var p in e.attributes);},initGroupBuffer:function(e,t,n,r){var i=this._gl,s=t.faces3,o=t.faces4,u=s.length*3+o.length*4,a=s.length*1+o.length*2,f=s.length*3+o.length*4,l=E.getMaterial(e,t.materialIndex?t.materialIndex:0),c=l.needUV(),h=l.getNormalType(),p=l.isVertexColor(),d=l.isGradientColor();n.__vertexArray=new Float32Array(u*3),h&&(n.__normalArray=new Float32Array(u*3));if(r)return;p&&(n.__colorArray=new Float32Array(u*3)),d&&(n.__color2Array=new Float32Array(6)),c&&(n.__uvArray=new Float32Array(u*2),e.uv2s&&(n.__uv2Array=new Float32Array(u*2))),n.__faceArray=new Uint16Array(a*3),n.__lineArray=new Uint16Array(f*2);var v,m;if(t.numMorphTargets){n.__morphTargetsArrays=[];for(v=0,m=t.numMorphTargets;v<m;v++)n.__morphTargetsArrays.push(new Float32Array(u*3))}if(t.numMorphNormals){n.__morphNormalsArrays=[];for(v=0,m=t.numMorphNormals;v<m;v++)n.__morphNormalsArrays.push(new Float32Array(u*3))}n.__webglFaceCount=a*3,n.__webglLineCount=f*2;if(l.attributes){n.__webglCustomAttributesList=[];for(var g in l.attributes){var y=l.attributes[g],b={};for(var w in y)b[w]=y[w];if(!b.__webglInitialized||b.createUniqueBuffers){b.__webglInitialized=!0;var S=1;b.type==="v2"?S=2:b.type==="v3"?S=3:b.type==="v4"?S=4:b.type==="c"&&(S=3),b.size=S,b.array=new Float32Array(u*S),b.buffer=i.createBuffer(),b.buffer.belongsToAttribute=g,y.needsUpdate=!0,b.__original=y,b.value=e.data[b.ref]}n.__webglCustomAttributesList.push(b)}}n.__inittedArrays=!0},createLineBuffers:function(e){this.lineMap[e._id]==null&&(this.lineMap[e._id]={});var t=this.lineMap[e._id],n=this._gl;t.__webglVertexBuffer=n.createBuffer(),t.__webglColorBuffer=n.createBuffer(),t.__webglLineDistanceBuffer=n.createBuffer(),this.info.memory.geometries++},initLineBuffers:function(e){this.lineMap[e._id]==null&&(this.lineMap[e._id]={});var t=this.lineMap[e._id],n=e.vertices.length;t.__vertexArray=new Float32Array(n*3),t.__colorArray=new Float32Array(n*3),t.__color2Array=new Float32Array(6),t.__lineDistanceArray=new Float32Array(n*1),t.__webglLineCount=n},createParticleBuffers:function(e){this.particleMap[e._id]==null&&(this.particleMap[e._id]={});var t=this.particleMap[e._id],n=this._gl;t.__webglVertexBuffer=n.createBuffer(),t.__webglColorBuffer=n.createBuffer(),t.__webglNormalBuffer=n.createBuffer(),this.info.memory.geometries++},initParticleBuffers:function(e){this.particleMap[e._id]==null&&(this.particleMap[e._id]={});var t=this.particleMap[e._id],n=e.vertices.length;t.__vertexArray=new Float32Array(n*3),t.__colorArray=new Float32Array(n*3),t.__normalArray=new Float32Array(n*3),t.__sortArray=[],t.__webglParticleCount=n},createGroupBuffer:function(e,t){var n=this._gl;t.__webglVertexBuffer=n.createBuffer(),t.__webglNormalBuffer=n.createBuffer(),t.__webglColorBuffer=n.createBuffer(),t.__webglColor2Buffer=n.createBuffer(),t.__webglUVBuffer=n.createBuffer(),t.__webglUV2Buffer=n.createBuffer(),t.__webglFaceBuffer=n.createBuffer(),t.__webglLineBuffer=n.createBuffer(),this.webglVersion>1&&(t.__vao=n.createVertexArray()),this.info.memory.geometries++},setRenderTarget:function(e){var r=e instanceof K,i=this._gl;if(e&&!e.__webglFramebuffer){e.depthBuffer===t&&(e.depthBuffer=!0),e.stencilBuffer===t&&(e.stencilBuffer=!0),e.__webglTexture=i.createTexture(),this.info.memory.textures++;var s=H.isPowerOfTwo,o=s(e.width)&&s(e.height),u=H.paramToGL(e.format,i),a=H.paramToGL(e.type,i);e.type==n.FloatType;var f=u;if(r){e.__webglFramebuffer=[],e.__webglRenderbuffer=[],i.bindTexture(i.TEXTURE_CUBE_MAP,e.__webglTexture),this.pm.setTextureParameters(i.TEXTURE_CUBE_MAP,e,o);for(var l=0;l<6;l++)e.__webglFramebuffer[l]=i.createFramebuffer(),e.__webglRenderbuffer[l]=i.createRenderbuffer(),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,f,e.width,e.height,0,u,a,null),this.setupFrameBuffer(e.__webglFramebuffer[l],e,i.TEXTURE_CUBE_MAP_POSITIVE_X+l),this.setupRenderBuffer(e.__webglRenderbuffer[l],e);o&&i.generateMipmap(i.TEXTURE_CUBE_MAP)}else e.__webglFramebuffer=i.createFramebuffer(),e.shareDepthFrom?e.__webglRenderbuffer=e.shareDepthFrom.__webglRenderbuffer:e.__webglRenderbuffer=i.createRenderbuffer(),i.bindTexture(i.TEXTURE_2D,e.__webglTexture),this.pm.setTextureParameters(i.TEXTURE_2D,e,o),i.texImage2D(i.TEXTURE_2D,0,f,e.width,e.height,0,u,a,null),this.setupFrameBuffer(e.__webglFramebuffer,e,i.TEXTURE_2D),e.shareDepthFrom?e.depthBuffer&&!e.stencilBuffer?i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e.__webglRenderbuffer):e.depthBuffer&&e.stencilBuffer&&i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e.__webglRenderbuffer):this.setupRenderBuffer(e.__webglRenderbuffer,e),o&&i.generateMipmap(i.TEXTURE_2D);r?i.bindTexture(i.TEXTURE_CUBE_MAP,null):i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null)}var c,h,p,d,v;e?(r?c=e.__webglFramebuffer[e.activeCubeFace]:c=e.__webglFramebuffer,h=e.width,p=e.height,d=0,v=0):(c=null,h=this._viewportWidth,p=this._viewportHeight,d=this._viewportX,v=this._viewportY),c!==this._currentFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,c),i.viewport(d,v,h,p),this._currentFramebuffer=c),this._currentWidth=h,this._currentHeight=p},setupFrameBuffer:function(e,t,n){var r=this._gl;r.bindFramebuffer(r.FRAMEBUFFER,e),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,n,t.__webglTexture,0)},setupRenderBuffer:function(e,t){var n=this._gl;n.bindRenderbuffer(n.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,t.width,t.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,t.width,t.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,e)):n.renderbufferStorage(n.RENDERBUFFER,n.RGBA4,t.width,t.height)},setLineWidth:function(e){if(e!==this
._oldLineWidth){try{this._gl.lineWidth&&this._gl.lineWidth(e)}catch(t){}this._oldLineWidth=e}},setupMatrices:function(e,t){e.fixSize(t),e.updateWorldMatrix(),e._modelViewMatrix.multiplyMatrices(t.worldMatrixInverse,e.worldMatrix),e._normalMatrix.getNormalMatrix(e._modelViewMatrix)},setDefaultGLState:function(){var e=this._gl,t=new n.Color(this._clearColor);e.clearColor(t.r,t.g,t.b,this._clearAlpha),e.clearDepth(1),d.isIE||e.clearStencil(0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.frontFace(e.CCW),e.cullFace(e.BACK),e.enable(e.CULL_FACE),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)},clear:function(e,n,r){var i=this._gl,s=0;if(e===t||e)s|=i.COLOR_BUFFER_BIT;if(n===t||n)s|=i.DEPTH_BUFFER_BIT;if(r===t||r)s|=i.STENCIL_BUFFER_BIT;i.clear(s)},setGLFaces:function(e){var t=this._gl,r=e.side===n.DoubleSide,i=e.side===n.BackSide;this._oldDoubleSided!==r&&(r?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),this._oldDoubleSided=r),this._oldFlipSided!==i&&(i?t.frontFace(t.CW):t.frontFace(t.CCW),this._oldFlipSided=i)},getView:function(){return this._canvas},getRootView:function(){return this._rootView},setBlending:function(e,t,n,r){q.setBlending(e,t,n,r,this)},setDepthTest:function(e){q.setDepthTest(e,this)},setStencilTest:function(e){this._oldStencilTest!=e&&(e?this._gl.enable(this._gl.STENCIL_TEST):this._gl.disable(this._gl.STENCIL_TEST),this._oldStencilTest=e)},setDepthWrite:function(e){q.setDepthWrite(e,this)},getLineWidthRange:function(){var e=this._gl;return e.getParameter(e.ALIASED_LINE_WIDTH_RANGE)},setTexture:function(e,t){this.pm.setTexture(e,t)},disableAttributes:function(){for(var e in this._enabledAttributes)this._enabledAttributes[e]&&(this._gl.disableVertexAttribArray(e),this._enabledAttributes[e]=!1)},enableAttribute:function(e){this._enabledAttributes[e]||(this._gl.enableVertexAttribArray(e),this._enabledAttributes[e]=!0)},adjustRootViewBounds:function(e,t){var n=this._rootView;n.style.width=e+"px",n.style.height=t+"px"},adjustCanvasBounds:function(e,t,n,r,i){e.width=t*this.devicePixelRatio,e.height=n*this.devicePixelRatio,e.style.margin="0px",e.style.padding="0px",e.style.width=t+"px",e.style.height=n+"px"},adjustBounds:function(e,t,n,r){var i=this.getView();this.adjustRootViewBounds(e,t,n,r),this.adjustCanvasBounds(i,e,t,n,r),this.adjustCanvasBounds(this._topCanvas,e,t,n,r),this.adjustCanvasBounds(this._bottomCanvas,e,t,n,r),this.adjustCallback(e,t,n,r),this.setViewport(0,0,i.width,i.height);if(this.autoUpdateCameraAspect&&t!==0){var s=this._camera;s.aspect=e/t,s.updateProjectionMatrix(),this._currentCamera=null}this.dirtyNetwork()},adjustCallback:function(){},setViewport:function(e,n,r,i){var s=this.getView();this._viewportX=e!==t?e:0,this._viewportY=n!==t?n:0,this._viewportWidth=r!==t?r:s.width,this._viewportHeight=i!==t?i:s.height,this._gl.viewport(this._viewportX,this._viewportY,this._viewportWidth,this._viewportHeight)},setShowAxis:function(e){if(this.showAxis===e)return;this.showAxis=e,this.showAxis&&(this.helperBox.contains(this.axis)||this.helperBox.addByDescendant(this.axis)),this.axis._visible=e,this.dirtyNetwork()},setShowAxisText:function(e){this.axis.showAxisText(e),this.dirtyNetwork()},setAxisSize:function(e){this.axis.setSize(e)},onSelect:function(e){this.onSelectFunction!=null&&this.onSelectFunction(e)},setOnSelectFunction:function(e){this.onSelectFunction=e},isSelectable:function(e){return e.isSelectable()?this.selectableFunction?this.selectableFunction(e):!0:!1},setSelectableFunction:function(e){this.selectableFunction=e},setRenderSelectFunction:function(e){this.renderSelectFunction=e},renderSelect:function(e){return this.renderSelectFunction?this.renderSelectFunction(e):!0},renderAlarmBorder:function(e){return this.renderAlarmBorderFunction?this.renderAlarmBorderFunction(e):!0},selectable:function(e){return this.isVisible(e.element)&&this.isSelectable(e.element)&&this.getDataBox().getSelectionModel().isSelectable(e.element)},editable:function(e){var t=this.selectable(e);return t&&this.editableFunction!=null?this.editableFunction(e.element):t},getFirstSelectElement:function(e){if(e==null)return null;var t=0,n;while(t<e.length){var r=e[t];if(this.selectable(r)){n=r.element;break}t++}return n},getFirstEditElement:function(e){if(e==null)return null;var t=0,n;while(t<e.length){var r=e[t];if(this.editable(r)){n=r.element;break}t++}return n},toImageData:function(e,t,n,r){this.dirtyNetwork(),this.render(),e=e||"PNG",e.toUpperCase();if(e==="PNG")return g.saveAsPNG(this.getView(),t,!1,n,r);if(e==="JPEG")return g.saveAsJPEG(this.getView(),t,!1,n,r);if(e==="BMP")return g.saveAsBMP(this.getView(),t,!1,n,r);console.log("Not surport type "+e)},getPickingByEvent:function(e){var t=this._camera,r={},i=this.getView(),s=i.getBoundingClientRect(),o=e.clientX,u=e.clientY;e.touches&&e.touches.length&&(o=e.touches[0].pageX,u=e.touches[0].pageY);var a=(o-s.left)/s.width,l=(u-s.top)/s.height;r.x=a*2-1,r.y=-l*2+1;var c=new n.Vec3(r.x,r.y,.5);this.projector.unprojectVector(c,t);var h=null;if(t instanceof n.PerspectiveCamera)h=new n.Picking(t._position,c.sub(t._position).normalize(),t.up,null,null,this);else{var p=c.clone().sub(t._position),d=t.getTarget().clone().sub(t.p()).normalize(),v=d.multiplyScalar(p.clone().dot(d)),m=p.sub(v),g=(new f).addVectors(t._position,m);h=new n.Picking(g,c.sub(g).normalize(),t.up,null,null,this)}return h},getElementsByMouseEvent:function(e,t,n){var r=this.getPickingByEvent(e),i=new C;i.addAll(this.dataBox.getNodes()),i.addAll(this.dataBox.getBillboards()),n&&i.addAll(new C(this.alarmBillboards));var s=r.intersectObjects(i.toArray(),!1,t);return s},getElementByScreenPoint:function(e,t,r){var i={},s=this.getView(),o=this._camera,u=s.getBoundingClientRect();e.x&&(r=t,t=e.y,e=e.x),e/=u.width,t/=u.height,i.x=e*2-1,i.y=-t*2+1;var a=new n.Vec3(i.x,i.y,.5);this.projector.unprojectVector(a,o);var f=new n.Picking(o._position,a.sub(o._position).normalize(),o.up,null,null,this),l=new C;l.addAll(this.dataBox.getNodes()),l.addAll(this.dataBox.getBillboards());var c=f.intersectObjects(l.toArray(),!1,r);return c},getFirstElementByMouseEvent:function(e,t,n,r){var i=this.getElementsByMouseEvent(e,t,r);if(i.length)for(var s=0;s<i.length;s++){var o=i[s],u=o.element;if(n==null||n.call(null,u))return o}return null},getUnProjectVector:function(e){var t={},r=this.getView().getBoundingClientRect(),i=e.x/r.width,s=e.y/r.height;t.x=i*2-1,t.y=-s*2+1;var o=new n.Vec3(t.x,t.y,.5);return this.projector.unprojectVector(o,this._camera),o},getFrustumByBounding:function(e){var t=e,r=this.getUnProjectVector(new o(t.x,t.y)),i=this.getUnProjectVector(new o(t.x+t.w,t.y)),s=this.getUnProjectVector(new o(t.x,t.y+t.h)),u=this.getUnProjectVector(new o(t.x+t.w,t.y+t.h)),a=this.getNearFarPoints(r),f=this.getNearFarPoints(i),l=this.getNearFarPoints(s),c=this.getNearFarPoints(u),h=new n.math.Plane,p=new n.math.Plane,d=new n.math.Plane,v=new n.math.Plane,m=new n.math.Plane,g=new n.math.Plane;h.setFromCoplanarPoints(a[0],f[0],l[0]),p.setFromCoplanarPoints(a[0],a[1],f[0]),d.setFromCoplanarPoints(a[0],l[0],a[1]),v.setFromCoplanarPoints(f[0],f[1],c[0]),m.setFromCoplanarPoints(l[0],c[0],l[1]),g.setFromCoplanarPoints(a[1],l[1],f[1]);var y=new n.Frustum(h,p,d,v,m,g);return y.setPoints([a[0],f[0],l[0],c[0],a[1],f[1],l[1],c[1]]),y},getNearFarPoints:function(e){var t=this._camera,n=e.sub(t._position).normalize(),r=t.target.clone().sub(t._position),i=n.angleTo(r),s=t.getNear()/Math.acos(i),o=t.getFar()/Math.acos(i),u=t._position.clone().add(n.clone().multiplyScalar(s)),a=t._position.clone().add(n.clone().multiplyScalar(o));return[u,a]},getSpacePointOnPlane:function(e,t){var r={},i=this.getView(),s=this._camera,o=i.getBoundingClientRect(),u=e.clientX,a=e.clientY;e.touches&&e.touches.length&&(u=e.touches[0].pageX,a=e.touches[0].pageY);var f=(u-o.left)/o.width,l=(a-o.top)/o.height;r.x=f*2-1,r.y=-l*2+1;var c=new n.Vec3(r.x,r.y,.5);this.projector.unprojectVector(c,s);var h=s._position;if(s instanceof mono.OrthoCamera){var p=new n.Vec3(0,0,.5);this.projector.unprojectVector(p,s),h=h.clone().sub(p.sub(c))}var d=c.sub(h).normalize(),v=new n.Ray(h,d),m=v.distanceToPlane(t);if(m<0||Math.abs(m)<n.Picking.prototype.precision)return null;var g=v.at(m);return g},getElementsByBounding:function(e,t,r){var i=new C;i.addAll(this.dataBox.getNodes()),i.addAll(this.dataBox.getBillboards());var s=this.getFrustumByBounding(e),o=[],u=new f,a,l=this._camera;return i.forEach(function(e){if(e instanceof n.Billboard){u.setFromMatrixPosition(e.worldMatrix);var t=e.material,i=t.alignment;a=new n.Plane(1,1);if(i.x||i.y)a.setPosition(i.x,i.y,0),a=n.Utils.transformElement(a,!0);a.setPosition(u);var c=(new f).getScaleFromMatrix(e.worldMatrix);a.setScale(c.x,c.y,1);var h=l.getTarget().clone(),p=l.getPosition();h.sub(p);var d=a.getPosition().clone();t&&t.vertical&&(h.y=0),d.sub(h),a.lookAt(d),a.updateWorldMatrix(!0),s.intersectsObjectAccurate(a,r)&&o.push({element:e})}else e instanceof n.Line?s.intersectsObjectAccurate(e,r)&&o.push({element:e}):s.intersectsObjectAccurate(e,r)&&o.push({element:e})}),o},getViewPosition:function(e){var t=new f;t=this.projector.projectVector(e,this._camera,t),t.x=t.x/2+.5,t.y=-t.y/2+.5;var n={x:this._canvas.width*t.x/this.devicePixelRatio,y:this._canvas.height*t.y/this.devicePixelRatio,h:this._canvas.height};return n},setInteractions:function(e){var t=this._interactions,n,r;if(t)for(n=0;n<t.length;n++)r=t[n],r.tearDown();this._interactions=e;if(e)for(n=0;n<e.length;n++)r=e[n],r.setUp()},getDefaultInteraction:function(){if(this._interactions&&this._interactions.length>0)for(var e=0;e<this._interactions.length;e++){var t=this._interactions[e];if(t instanceof n.DefaultInteraction)return t}return null},getInteractions:function(){return this._interactions},fireInteractionEvent:function(e){this._interactionDispatcher.fire(e)},addInteractionListener:function(e,t,n){this._interactionDispatcher.add(e,t,n)},removeInteractionListener:function(e,t){this._interactionDispatcher.remove(e,t)},dispose:function(){this._animateId&&((this._vrDisplay&&this._vrDisplay.isPresenting?this._vrDisplay:e).cancelAnimationFrame(this._animateId),this._animateId=null),this.setInteractions(null),this.pm.dispose(),this._resizeFunction&&e.removeEventListener("resize",this._resizeFunction)},setRenderInterval:function(e){if(H.isNaN(e)||e<=5)e=5;this._renderInterval=e},_computeNetworkBoundingBox:function(){function c(e,t){e.applyMatrix4(t),u.push(e)}var e=this.getDataBox().size(),t=this.getDataBox().getDatas(),r,i,s,o,u=[];for(r=0;r<e;r++){i=t.get(r);if(i instanceof n.Node){s=i.getBoundingBox(),o=i.worldMatrix;var a=s.min,l=s.max;c(a.clone(),o),c(l.clone(),o),c(new f(a.x,a.y,l.z),o),c(new f(a.x,l.y,a.z),o),c(new f(l.x,a.y,a.z),o),c(new f(l.x,l.y,a.z),o),c(new f(l.x,a.y,l.z),o),c(new f(a.x,l.y,l.z),o)}}if(u.length<=1)return null;var h=new n.BoundingBox;return h.setFromPoints(u),h},getNetworkBoundingBox:function(){return this.boundingBox==null&&(this.boundingBox=this._computeNetworkBoundingBox()),this.boundingBox},getSelectStyle:function(e){return e.getSelectStyle()},setZoomStandard:function(e){this._zoomStandard=e},getZoomStandard:function(){return this._zoomStandard},zoom:function(e,t){t=t||this._zoomStandard;var n=this._camera;n.zoom(e,t)},zoomIn:function(e){this.zoom(.9,e)},zoomOut:function(e){this.zoom(1.1,e)},move:function(e,t){var n=new mono.Vec3(-e,-t,0),r=this._camera.t(),i=this._camera.p();this._camera.translateX(-e),this._camera.translateY(-t);var s=this._camera.p();r.add(s.clone().sub(i)),this._camera.lookAt(r)},moveLeft:function(e){e=e||50,this.move(-e,0)},moveRight:function(e){e=e||50,this.move(e,0)},moveUp:function(e){e=e||30,this.move(0,e)},moveDown:function(e){e=e||30,this.move(0,-e)},zoomEstimateOverview:function(e){var t=this.getNetworkBoundingBox();if(t==null)return;var n=t.center(),r=new f(0,t.max.y-t.min.y,t.max.z-t.min.z),i=new f(t.max.x-t.min.x,0,0,0),s=r.clone();s.length()<i.length()&&(s=i.clone());var o;if(e){var u=r.length();r.y=r.z*Math.tan(e/180*Math.PI),r.setLength(u)}o=(new f).addVectors(n,r.multiplyScalar(.5));var a=this._camera.fov,l=this._camera.aspect,c=s.length()/2/Math.tan(a*Math.PI/180);o.add(r.normalize().multiplyScalar(c)),this._camera.setPosition(o),this._camera.lookAt(n),this._overviewDistance=this._camera.getDistance()},_onVRRequestPresent:function(){var e=this,t=e._canvas,n=e._vrDisplay;if(n){e._oldCamera=e._camera;var r=new mono.VRCamera(e,e._oldCamera.near,e._oldCamera.far);r.setPosition(e._camera.getPosition()),e.setCamera(r),n.requestPresent([{source:t}]).then(function(){e._isPresenting=!0,e.onEnterVR()},function(e){console.log("requestPresent failed.",e)})}},onEnterVR:function(){},_onVRExitPresent:function(){var e=this,t=e._vrDisplay;if(!t||!t.isPresenting)return;t.exitPresent().then(function(){e.setCamera(e._oldCamera),e._oldCamera=null,e._isPresenting=!1},function(){console.log("exitPresent failed.")})},enterVR:function(){this._onVRRequestPresent()},_initVR:function(){var t=this,n=t._canvas,r;if(t._vrDisplay)return;navigator.getVRDisplays&&navigator.getVRDisplays().then(function(i){i&&i.length&&(r=t._vrDisplay=i[0],r.depthNear=t._camera.near,r.depthFar=t._camera.far,t.onVRRequestPresent||(t.onVRRequestPresent=function(e){t._onVRRequestPresent()}),t.onVRExitPresent||(t.onVRExitPresent=function(e){t._onVRExitPresent()}),t.onVRPresentChange||(t.onVRPresentChange=function(e){if(r.isPresenting){var i=r.getEyeParameters("left"),s=r.getEyeParameters("right");n.width=Math.max(i.renderWidth,s.renderWidth)*2,n.height=Math.max(i.renderHeight,s.renderHeight)}else t.adjustBounds(t._rootView.clientWidth,t._rootView.clientHeight)}),e.addEventListener("vrdisplaypresentchange",t.onVRPresentChange,!1),e.addEventListener("vrdisplayactivate",t.onVRRequestPresent,!1),e.addEventListener("vrdisplaydeactivate",t.onVRExitPresent,!1))})},exitVR:function(){this._onVRExitPresent()},s:function(e){this.setStyle(e)},setStyle:function(e){var t=this;if(!e)return;e.parentDom&&e.parentDom.appendChild(t.getRootView()),e.width&&e.height&&t.adjustBounds(e.width,e.height),e.autoAdjustBounds&&mono.Utils.autoAdjustNetworkBounds(t,document.documentElement,"clientWidth","clientHeight");if(e.camera){var n=t.getCamera(),r=e.camera;r.near!=null&&n.setNear(r.near),r.far!=null&&n.setFar(r.far),r.fov!=null&&n.setFov&&n.setFov(r.fov),r.width!=null&&n.setWidth&&n.setWidth(r.width),r.position!=null&&n.setPosition(r.position),r.target!=null&&n.lookAt(r.target)}if(e.lights){var i=t.getDataBox();e.lights.forEach(function(e){var t;e.type==="directional"&&(t=new mono.DirectionalLight(e.color,e.intensity),e.direction&&t.setDirection(e.direction)),e.type==="point"&&(t=new mono.PointLight(e.color,e.intensity,e.distance),e.position&&t.setPosition(e.position)),e.type==="ambient"&&(t=new mono.AmbientLight(e.color)),e.type==="spot"&&(t=new mono.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent)),t&&i.add(t)})}if(e.interactions){var s,o,u,a;t.getInteractions().forEach(function(e){e instanceof mono.DefaultInteraction&&(s=e),e instanceof mono.EditInteraction&&(o=e),e instanceof mono.SelectionInteraction&&(u=e)}),e.interactions.forEach(function(e){e.type==="default"&&(s||(s=new mono.DefaultInteraction(t)),a=s),e.type==="edit"&&(o||(o=new mono.EditInteraction(t)),a=o),e.type==="selection"&&(u||(u=new mono.SelectionInteraction(t)),a=u),Object.keys(e).forEach(function(t){t!=="type"&&(a[t]=e[t])})});var f=[];s&&f.push(s),o&&f.push(o),u&&f.push(u),t.setInteractions(f)}}}),n.Network3DId=0,n.Network3D.GroupCache={_groupCounter:0};var G=function(){function W(){if(r===s){var e=new $RenderObject;return i.push(e),s++,r++,e}return i[r++]}function X(){if(u===f){var e=new $RenderVertex;return a.push(e),f++,u++,e}return a[u++]}function V(){if(c===p){var e=new n.RenderFace3;return h.push(e),p++,c++,e}return h[c++]}function $(){if(d===m){var e=new n.RenderFace4;return v.push(e),m++,d++,e}return v[d++]}function J(){if(y===w){var e=new n.RenderLine;return b.push(e),w++,y++,e}return b[y++]}function K(){if(S===T){var e=new n.RenderableParticle;return x.push(e),T++,S++,e}return x[S++]}function Q(e,t){return t.z-e.z}function G(e,t){var n=0,r=1,i=e.z+e.w,s=t.z+t.w,o=-e.z+e.w,u=-t.z+t.w;return i>=0&&s>=0&&o>=0&&u>=0?!0:i<0&&s<0||o<0&&u<0?!1:(i<0?n=Math.max(n,i/(i-s)):s<0&&(r=Math.min(r,i/(i-s))),o<0?n=Math.max(n,o/(o-u)):u<0&&(r=Math.min(r,o/(o-u))),r<n?!1:(e.lerp(t,n),t.lerp(e,1-r),!0))}var e,r,i=[],s=0,o,u,a=[],f=0,l,c,h=[],p=0,d,v=[],m=0,g,y,b=[],w=0,E,S,x=[],T=0,N={objects:[],sprites:[],lights:[],elements:[]},C=new n.Vec3,k=new n.Vec4,L=new n.BoundingBox(new n.Vec3(-1,-1,-1),new n.Vec3(1,1,1)),A=new n.BoundingBox,O=new Array(3),M=new Array(4),_=new n.Mat4,D=new n.Mat4,P,H=new n.Mat4,B=new n.Mat3,j=new n.Mat3,F=new n.Vec3,I=new n.Frustum,q=new n.Vec4,R=new n.Vec4,U;this.projectVector=function(e,n,r){return n.worldMatrixInverse.getInverse(n.worldMatrix),D.multiplyMatrices(n.projectionMatrix,n.worldMatrixInverse),r===t?e.applyProjection(D):(r.copy(e),r.applyProjection(D))},this.unprojectVector=function(e,t){return t.projectionMatrixInverse.getInverse(t.projectionMatrix),D.multiplyMatrices(t.worldMatrix,t.projectionMatrixInverse),e.applyProjection(D)},this.pickingRay=function(e,t){e.z=-1;var r=new n.Vec3(e.x,e.y,1);return this.unprojectVector(e,t),this.unprojectVector(r,t),r.sub(e).normalize(),new n.Picking(e,r)};var z=function(t,i){r=0,N.objects.length=0,N.sprites.length=0,N.lights.length=0;var s=function(t){var r;t instanceof n.DataBox?r=t.getRoots():r=t.getChildren(),r=r.toList();for(var i=0,o=r.size();i<o;i++){var u=r.get(i);u.isSelected()&&u instanceof n.Node&&(r.add(u.createCanvasSelectionCube(),i),i++)}for(var i=0,o=r.size();i<o;i++){var u=r.get(i);if(u._visible===!1)continue;if(u instanceof n.Light)N.lights.push(u);else if(u instanceof n.Entity||u instanceof n.Line){if(u.frustumCulled===!1||I.intersectsObject(u)===!0)e=W(),e.object=u,u.renderDepth!==null?e.z=u.renderDepth:(C.copy(u.worldMatrix.getPosition()),C.applyProjection(D),e.z=C.z),N.objects.push(e)}else u instanceof n.Billboard||u instanceof n.Particle?(e=W(),e.object=u,u.renderDepth!==null?e.z=u.renderDepth:(C.copy(u.worldMatrix.getPosition()),C.applyProjection(D),e.z=C.z),N.sprites.push(e)):(e=W(),e.object=u,u.renderDepth!==null?e.z=u.renderDepth:(C.copy(u.worldMatrix.getPosition()),C.applyProjection(D),e.z=C.z),N.objects.push(e));s(u)}};return s(t),i===!0&&N.objects.sort(Q),N};this.projectDataBox=function(e,r,i,s){var f=!1,h,p,v,m,b,w,x,T,C,U,W,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt,ct,ht,pt,dt;c=0,d=0,y=0,S=0,N.elements.length=0;for(var vt=0;vt<e.getRoots().size();vt++){var mt=e.getRoots().get(vt);mt.updateWorldMatrix()}r.parent===t&&r.updateWorldMatrix(!0,!1),_.copy(r.worldMatrixInverse.getInverse(r.worldMatrix)),D.multiplyMatrices(r.projectionMatrix,_),j.getInverse(_),j.transpose(),I.setFromMatrix(D),N=z(e,i);for(h=0,p=N.objects.length;h<p;h++){Z=N.objects[h].object,P=Z.worldMatrix,u=0;if(Z instanceof n.Entity){et=Z,tt=et.vertices,it=et.faces,at=et.uvs,B.getInverse(P),B.transpose(),pt=Z.material instanceof n.ArrayMaterial,dt=pt===!0?Z.material:null;for(v=0,m=tt.length;v<m;v++)o=X(),o.positionWorld.copy(tt[v]).applyMatrix4(P),o.positionScreen.copy(o.positionWorld).applyMatrix4(D),o.positionScreen.x/=o.positionScreen.w,o.positionScreen.y/=o.positionScreen.w,o.positionScreen.z/=o.positionScreen.w,o.visible=!(o.positionScreen.x<-1||o.positionScreen.x>1||o.positionScreen.y<-1||o.positionScreen.y>1||o.positionScreen.z<-1||o.positionScreen.z>1);for(b=0,w=it.length;b<w;b++){st=it[b];var gt=pt===!0?dt.materials[st.materialIndex]:Z.material;if(gt===t)continue;var yt=gt.side;if(st instanceof n.Face3){ft=a[st.a],lt=a[st.b],ct=a[st.c],O[0]=ft.positionScreen,O[1]=lt.positionScreen,O[2]=ct.positionScreen;if(ft.visible!==!0&&lt.visible!==!0&&ct.visible!==!0&&!L.isIntersectionBox(A.setFromPoints(O)))continue;f=(ct.positionScreen.x-ft.positionScreen.x)*(lt.positionScreen.y-ft.positionScreen.y)-(ct.positionScreen.y-ft.positionScreen.y)*(lt.positionScreen.x-ft.positionScreen.x)<0;if(yt!==n.DoubleSide&&f!==(yt===n.FrontSide))continue;l=V(),l.v1.copy(ft),l.v2.copy(lt),l.v3.copy(ct)}else if(st instanceof n.Face4){ft=a[st.a],lt=a[st.b],ct=a[st.c],ht=a[st.d],M[0]=ft.positionScreen,M[1]=lt.positionScreen,M[2]=ct.positionScreen,M[3]=ht.positionScreen;if(ft.visible!==!0&&lt.visible!==!0&&ct.visible!==!0&&ht.visible!==!0&&!L.isIntersectionBox(A.setFromPoints(M)))continue;f=(ht.positionScreen.x-ft.positionScreen.x)*(lt.positionScreen.y-ft.positionScreen.y)-(ht.positionScreen.y-ft.positionScreen.y)*(lt.positionScreen.x-ft.positionScreen.x)<0||(lt.positionScreen.x-ct.positionScreen.x)*(ht.positionScreen.y-ct.positionScreen.y)-(lt.positionScreen.y-ct.positionScreen.y)*(ht.positionScreen.x-ct.positionScreen.x)<0;if(yt!==n.DoubleSide&&f!==(yt===n.FrontSide))continue;l=$(),l.v1.copy(ft),l.v2.copy(lt),l.v3.copy(ct),l.v4.copy(ht)}l.normalModel.copy(st.normal),f===!1&&(yt===n.BackSide||yt===n.DoubleSide)&&l.normalModel.negate(),l.normalModel.applyMatrix3(B).normalize(),l.normalModelView.copy(l.normalModel).applyMatrix3(j),l.centroidModel.copy(st.centroid).applyMatrix4(P),ot=st.vertexNormals;for(x=0,T=ot.length;x<T;x++){var bt=l.vertexNormalsModel[x];bt.copy(ot[x]),f===!1&&(yt===n.BackSide||yt===n.DoubleSide)&&bt.negate(),bt.applyMatrix3(B).normalize();var wt=l.vertexNormalsModelView[x];wt.copy(bt).applyMatrix3(j)}l.vertexNormalsLength=ot.length;var Et=at[b];for(W=0,Y=Et.length;W<Y;W++)l.uvs[0][W]=Et[W];l.color=st.color,l.material=gt,F.copy(l.centroidModel).applyProjection(D),l.z=F.z,N.elements.push(l)}}else if(Z instanceof n.Line){H.multiplyMatrices(D,P),tt=Z.vertices,ft=X(),ft.positionScreen.copy(tt[0]).applyMatrix4(H);var St=Z.type===n.LinePieces?2:1;for(v=1,m=tt.length;v<m;v++){ft=X(),ft.positionScreen.copy(tt[v]).applyMatrix4(H);if((v+1)%St>0)continue;lt=a[u-2],q.copy(ft.positionScreen),R.copy(lt.positionScreen),G(q,R)===!0&&(q.multiplyScalar(1/q.w),R.multiplyScalar(1/R.w),g=J(),g.v1.positionScreen.copy(q),g.v2.positionScreen.copy(R),g.z=Math.max(q.z,R.z),g.material=Z.material,N.elements.push(g))}}}for(h=0,p=N.sprites.length;h<p;h++)Z=N.sprites[h].object,P=Z.worldMatrix,Z instanceof n.Particle&&(k.set(P.elements[12],P.elements[13],P.elements[14],1),k.applyMatrix4(D),k.z/=k.w,k.z>0&&k.z<1&&(E=K(),E.object=Z,E.x=k.x/k.w,E.y=k.y/k.w,E.z=k.z,E.rotation=Z.rotation.z,E.scale.x=Z.scale.x*Math.abs(E.x-(k.x+r.projectionMatrix.elements[0])/(k.w+r.projectionMatrix.elements[12])),E.scale.y=Z.scale.y*Math.abs(E.y-(k.y+r.projectionMatrix.elements[5])/(k.w+r.projectionMatrix.elements[13])),E.material=Z.material,N.elements.push(E)));return s===!0&&N.elements.sort(Q),N}};n.Projector=G,n.Billboard=function(e){e!=null&&e.id!=null?this._id=e.id:this._id=e,n.Element.call(this,this._id),this.material=new n.BillboardMaterial,this.rotation3d=this._rotation,this.rotation=0,this.vertices=[new f(-0.5,-0.5,0),new f(.5,-0.5,0),new f(.5,.5,0),new f(-0.5,.5,0)]},n.extend(n.Billboard,n.Element,{constructor:n.Billboard,className:"TGL.Billboard",updateMatrix:function(){this.matrix.setPosition(this._position),this.rotation=this._rotation.z,this.rotation3d.set(0,0,this.rotation),this.matrix.setRotationFromEuler(this.rotation3d),(this._scale.x!==1||this._scale.y!==1)&&this.matrix.scale(this._scale),this.matrixWorldNeedsUpdate=!0},invalidateTexture:function(){var e=this.material;e instanceof n.BillboardMaterial&&this._dirtyMaterialTexture(e)},clone:function(e){return e===t&&(e=new n.Billboard(this.material)),n.Element.prototype.clone.call(this,e),e},setMaterialStyle:function(e,t){var n=this.material.clone();e=e.substr(e.indexOf(".")+1),this._A97(n,e,t);var r=n.getUniqueCode(),i=ii.getMaterial(r);i!=null?(ii.unUseMaterial(this.material),this.material=i,ii.useMaterial(i)):(ii.unUseMaterial(this.material),ii.setMaterial(r,n),this.material=n)}}),n.ShaderSprite={sprite:{vertexShader:["uniform int useScreenCoordinates;","uniform int sizeAttenuation;","uniform vec3 screenPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 alignment;","uniform vec2 uvOffset;","uniform vec2 uvScale;","uniform bool vertical;","uniform float fixedSize;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vec4 finalPosition;","finalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","vUV = uvOffset + uv * uvScale;","vec2 finalScale;","if(fixedSize != 0.0){","   finalScale = scale  * length(finalPosition.xyz) / fixedSize;","}else{","   finalScale = scale;","}","vec2 alignedPosition = (position + alignment) * finalScale;","vec2 rotatedPosition;","rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","vec4 upPosition;","vec4 rightPosition = vec4(finalScale.x,0.0,0.0,1.0);","if(vertical){","upPosition =  modelViewMatrix * vec4( 0.0, 1.0, 0.0, 1.0 ) - finalPosition;","normalize(upPosition);","}","if(vertical){","finalPosition.xyz += (rotatedPosition.x * rightPosition.xyz / finalScale.x) + (rotatedPosition.y * upPosition.xyz / scale.y);","}else{","finalPosition.xy += rotatedPosition;","}","finalPosition = projectionMatrix * finalPosition;","gl_Position = finalPosition;","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform int useMap;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","if(useMap > 0){","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","} else {","gl_FragColor = vec4( color, 1.0);","}","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")}},n.BillboardRenderer=function(){function u(t,n){var r=e.createProgram(),i=e.createShader(e.FRAGMENT_SHADER),s=e.createShader(e.VERTEX_SHADER),o="precision "+n+" float;\n";return e.shaderSource(i,o+t.fragmentShader),e.shaderSource(s,o+t.vertexShader),e.compileShader(i),e.compileShader(s),e.attachShader(r,i),e.attachShader(r,s),e.linkProgram(r),r}function a(e,t){return e.z!==t.z?t.z-e.z:1}var e,t,r,i={},s=new n.Billboard,o=new n.BillboardMaterial({color:255});this.init=function(s){this.enable=!0,s._currentGroupHash=null,e=s._gl,t=s,r=s.getPrecision(),i.vertices=new Float32Array(16),i.faces=new Uint16Array(6),i.lines=new Uint16Array(8);var o=0;i.vertices[o++]=-0.5,i.vertices[o++]=-0.5,i.vertices[o++]=0,i.vertices[o++]=0,i.vertices[o++]=.5,i.vertices[o++]=-0.5,i.vertices[o++]=1,i.vertices[o++]=0,i.vertices[o++]=.5,i.vertices[o++]=.5,i.vertices[o++]=1,i.vertices[o++]=1,i.vertices[o++]=-0.5,i.vertices[o++]=.5,i.vertices[o++]=0,i.vertices[o++]=1,o=0,i.faces[o++]=0,i.faces[o++]=1,i.faces[o++]=2,i.faces[o++]=0,i.faces[o++]=2,i.faces[o++]=3,o=0,i.lines[o++]=0,i.lines[o++]=1,i.lines[o++]=0,i.lines[o++]=3,i.lines[o++]=1,i.lines[o++]=2,i.lines[o++]=2,i.lines[o++]=3,i.vertexBuffer=e.createBuffer(),i.elementBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,i.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,i.vertices,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i.faces,e.STATIC_DRAW),i.program=u(n.ShaderSprite.sprite,r),i.attributes={},i.uniforms={},i.attributes.position=e.getAttribLocation(i.program,"position"),i.attributes.uv=e.getAttribLocation(i.program,"uv"),i.uniforms.uvOffset=e.getUniformLocation(i.program,"uvOffset"),i.uniforms.uvScale=e.getUniformLocation(i.program,"uvScale"),i.uniforms.rotation=e.getUniformLocation(i.program,"rotation"),i.uniforms.scale=e.getUniformLocation(i.program,"scale"),i.uniforms.alignment=e.getUniformLocation(i.program,"alignment"),i.uniforms.color=e.getUniformLocation(i.program,"color"),i.uniforms.useMap=e.getUniformLocation(i.program,"useMap"),i.uniforms.map=e.getUniformLocation(i.program,"map"),i.uniforms.opacity=e.getUniformLocation(i.program,"opacity"),i.uniforms.vertical=e.getUniformLocation(i.program,"vertical"),i.uniforms.fixedSize=e.getUniformLocation(i.program,"fixedSize"),i.uniforms.useScreenCoordinates=e.getUniformLocation(i.program,"useScreenCoordinates"),i.uniforms.sizeAttenuation=e.getUniformLocation(i.program,"sizeAttenuation"),i.uniforms.screenPosition=e.getUniformLocation(i.program,"screenPosition"),i.uniforms.modelViewMatrix=e.getUniformLocation(i.program,"modelViewMatrix"),i.uniforms.projectionMatrix=e.getUniformLocation(i.program,"projectionMatrix"),i.uniforms.fogType=e.getUniformLocation(i.program,"fogType"),i.uniforms.fogDensity=e.getUniformLocation(i.program,"fogDensity"),i.uniforms.fogNear=e.getUniformLocation(i.program,"fogNear"),i.uniforms.fogFar=e.getUniformLocation(i.program,"fogFar"),i.uniforms.fogColor=e.getUniformLocation(i.program,"fogColor"),i.uniforms.alphaTest=e.getUniformLocation(i.program,"alphaTest"),this.inited=!0},this.render=function(r,s,u,a,f,l){this.inited||this.init(r);var c=new C(s),h=c.size();if(!h)return;var p=i.attributes,d=i.uniforms,v=a*.5,m=f*.5,g=!1;r.pm.currentProgram!=i.program&&(e.useProgram(i.program),r.pm.currentProgram=i.program,r._currentGroupHash=null,e.enableVertexAttribArray(p.position),e.enableVertexAttribArray(p.uv),e.disable(e.CULL_FACE),e.bindBuffer(e.ARRAY_BUFFER,i.vertexBuffer),e.vertexAttribPointer(p.position,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(p.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),this.enable=!0,g=!0),e.uniformMatrix4fv(d.projectionMatrix,!1,u.projectionMatrix.elements),g&&e.activeTexture(e.TEXTURE0),g&&e.uniform1i(d.map,0);var y=0,b=0,w=r.fog;w?(e.uniform3f(d.fogColor,w.color.r,w.color.g,w.color.b),w instanceof n.Fog?(e.uniform1f(d.fogNear,w.near),e.uniform1f(d.fogFar,w.far),e.uniform1i(d.fogType,1),y=1,b=1):w instanceof n.FogExp2&&(e.uniform1f(d.fogDensity,w.density),e.uniform1i(d.fogType,2),y=2,b=2)):(y=0,b=0);var E,S,x,T,N,k,L=[];for(E=0;E<h;E++){S=c.get(E),x=l||S.material;if(!t.isVisible(S)||x.opacity===0)continue;S.updateWorldMatrix(!0,!1),x.useScreenCoordinates?S.z=-S.position.z:(S._modelViewMatrix=new n.Mat4,S._modelViewMatrix.multiplyMatrices(u.worldMatrixInverse,S.worldMatrix),S.z=-S._modelViewMatrix.elements[14])}for(E=0;E<h;E++)S=c.get(E),this.renderBillboard(S,d,r,y,b,null,l),S._selected&&(S._scale.x=S._scale.x*1.01,S._scale.y=S._scale.y*1.01,S.material.clone(o),o.map=null,o.color.set(65280),this.renderBillboard(S,d,r,y,b,o),S._scale.x=S._scale.x/1.01,S._scale.y=S._scale.y/1.01)},this.disable=function(){if(this.enable){var r=i.attributes,s=i.uniforms;e.disableVertexAttribArray(r.position),e.disableVertexAttribArray(r.uv),t._oldDoubleSided||e.enable(e.CULL_FACE),t._oldBlending===n.NoBlending&&e.disable(e.BLEND),q.setDepthWrite(!0,t),this.enable=!1,this.lastMaterialId=null,t.pm.currentProgram=null}},this.renderBillboard=function(n,r,s,o,u,a,l){var c,h,p,d,v=[],m=new f;c=a?a:l?l:n.material;if(!t.isVisible(n)||c.opacity===0)return;var g=c.id,y=g!=this.lastMaterialId;y&&e.uniform1f(r.alphaTest,c.alphaTest),y&&(c.useScreenCoordinates===!0?(e.uniform1i(r.useScreenCoordinates,1),e.uniform3f(r.screenPosition,(n.position.x*t.devicePixelRatio-halfViewportWidth)/halfViewportWidth,(halfViewportHeight-n.position.y*t.devicePixelRatio)/halfViewportHeight,Math.max(0,Math.min(1,n.position.z)))):(e.uniform1i(r.useScreenCoordinates,0),e.uniform1i(r.sizeAttenuation,c.sizeAttenuation?1:0))),c.useScreenCoordinates===!0?(v[0]=t.devicePixelRatio,v[1]=t.devicePixelRatio):(e.uniformMatrix4fv(r.modelViewMatrix,!1,n._modelViewMatrix.elements),v[0]=1,v[1]=1),s.fog&&c.fog?d=u:d=0,o!==d&&(e.uniform1i(r.fogType,d),o=d),p=1/(c.scaleByViewport?viewportHeight:1),m.getScaleFromMatrix(n.worldMatrix),v[0]*=p*m.x,v[1]*=p*m.y,y&&(e.uniform2f(r.uvScale,c.repeat.x,c.repeat.y),e.uniform2f(r.uvOffset,c.offset.x,c.offset.y),e.uniform2f(r.alignment,c.alignment.x,c.alignment.y),e.uniform1f(r.opacity,c.opacity),e.uniform1i(r.vertical,c.vertical),e.uniform1f(r.fixedSize,c.fixedSize),e.uniform3f(r.color,c.color.r,c.color.g,c.color.b),e.uniform1f(r.rotation,n.rotation)),e.uniform2fv(r.scale,v),y&&(t.setBlending(c.blending,c.blendEquation,c.blendSrc,c.blendDst),t.setDepthTest(c.depthTest),t.setDepthWrite(c.depthMask)),c.map&&c.map._image&&t.pm.addTexture(c.map),y=y||c.map&&t.pm.needsUpdateTexture(c.map),c.map&&c.map._image&&c.map._image.width?(y&&t.setTexture(c.map,0),y&&e.uniform1i(r.useMap,1))
:y&&e.uniform1i(r.useMap,0),a?(y&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),y&&e.bufferData(e.ELEMENT_ARRAY_BUFFER,i.lines,e.STATIC_DRAW),y&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),e.drawElements(e.LINES,8,e.UNSIGNED_SHORT,0)):(y&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),y&&e.bufferData(e.ELEMENT_ARRAY_BUFFER,i.faces,e.STATIC_DRAW),y&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0)),this.lastMaterialId=c.id}},n.ShaderFlare={flare:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if ( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility =        visibility.r / 9.0;","vVisibility *= 1.0 - visibility.g / 9.0;","vVisibility *=       visibility.b / 9.0;","vVisibility *= 1.0 - visibility.a / 9.0;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if ( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );","} else if ( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")}},n.FlareRenderer=function(){var e,t,r,i,s,u,a,l,c,h,p,d={};this.init=function(r){this.enable=!0,c=r._gl,h=r,p=r.getPrecision();var o=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),f=new Uint16Array([0,1,2,0,2,3]);e=c.createBuffer(),t=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,e),c.bufferData(c.ARRAY_BUFFER,o,c.STATIC_DRAW),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t),c.bufferData(c.ELEMENT_ARRAY_BUFFER,f,c.STATIC_DRAW),a=c.createTexture(),l=c.createTexture(),c.bindTexture(c.TEXTURE_2D,a),c.texImage2D(c.TEXTURE_2D,0,c.RGB,16,16,0,c.RGB,c.UNSIGNED_BYTE,null),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.bindTexture(c.TEXTURE_2D,l),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,16,16,0,c.RGBA,c.UNSIGNED_BYTE,null),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),i=this.createProgram(n.ShaderFlare.flare),s={vertex:c.getAttribLocation(i,"position"),uv:c.getAttribLocation(i,"uv")},u={renderType:c.getUniformLocation(i,"renderType"),map:c.getUniformLocation(i,"map"),occlusionMap:c.getUniformLocation(i,"occlusionMap"),opacity:c.getUniformLocation(i,"opacity"),color:c.getUniformLocation(i,"color"),scale:c.getUniformLocation(i,"scale"),rotation:c.getUniformLocation(i,"rotation"),screenPosition:c.getUniformLocation(i,"screenPosition")},this.inited=!0},this.render=function(r,p,d,v,m){this.inited||this.init(r),h=r;if(p.length===0)return;var g=new f,y=m/v,b=v*.5,w=m*.5,E=16/m,S=new o(E*y,E),x=new f(1,1,0),T=new o(1,1),N=new n.Box2;N.min.set(0,0),N.max.set(v-16,m-16);if(r.pm.currentProgram!=i){c.useProgram(i),r.pm.currentProgram=i,r._currentGroupHash=null,c.enableVertexAttribArray(s.vertex),c.enableVertexAttribArray(s.uv),c.uniform1i(u.occlusionMap,0),c.uniform1i(u.map,1),c.bindBuffer(c.ARRAY_BUFFER,e),c.vertexAttribPointer(s.vertex,2,c.FLOAT,!1,16,0),c.vertexAttribPointer(s.uv,2,c.FLOAT,!1,16,8),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t),c.disable(c.CULL_FACE),this.enable=!0;for(var C=0,k=p.length;C<k;C++){E=16/m,S.set(E*y,E);var L=p[C],A=L.node;g.set(A.worldMatrix.elements[12],A.worldMatrix.elements[13],A.worldMatrix.elements[14]),g.applyMatrix4(d.worldMatrixInverse),g.applyMatrix4(d.projectionMatrix),x.copy(g),T.x=0+x.x*b+b-8,T.y=0+x.y*w+w-8;if(N.containsPoint(T)===!0){c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,a),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,a),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.copyTexImage2D(c.TEXTURE_2D,0,c.RGB,T.x/2,T.y/2,16,16,0),c.uniform1i(u.renderType,0),c.uniform2f(u.scale,S.x,S.y),c.uniform3f(u.screenPosition,x.x,x.y,x.z),c.disable(c.BLEND),c.enable(c.DEPTH_TEST),c.drawElements(c.TRIANGLES,6,c.UNSIGNED_SHORT,0),c.uniform1i(u.renderType,1),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,l),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.copyTexImage2D(c.TEXTURE_2D,0,c.RGBA,T.x/2,T.y/2,16,16,0),c.uniform1i(u.renderType,1),c.disable(c.DEPTH_TEST),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,a),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.drawElements(c.TRIANGLES,6,c.UNSIGNED_SHORT,0),A.positionScreen=x,A.customUpdateCallback?A.customUpdateCallback(A):A.updateLensFlares(),c.uniform1i(u.renderType,2),c.enable(c.BLEND);for(var O=0,M=A.lensFlares.length;O<M;O++){var _=A.lensFlares[O];_.opacity>.001&&_.scale>.001&&(x.x=_.x,x.y=_.y,x.z=_.z,E=_.size*_.scale/m,S.x=E*y,S.y=E,c.uniform3f(u.screenPosition,x.x,x.y,x.z),c.uniform2f(u.scale,S.x,S.y),c.uniform1f(u.rotation,_.rotation),c.uniform1f(u.opacity,_.opacity),c.uniform3f(u.color,_.color.r,_.color.g,_.color.b),h.setBlending(_.blending,_.blendEquation,_.blendSrc,_.blendDst),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,a),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,_.texture),c.drawElements(c.TRIANGLES,6,c.UNSIGNED_SHORT,0))}}}c.enable(c.CULL_FACE),c.enable(c.DEPTH_TEST)}},this.createProgram=function(e){var t=c.createProgram(),n=c.createShader(c.FRAGMENT_SHADER),r=c.createShader(c.VERTEX_SHADER),i="precision "+p+" float;\n";return c.shaderSource(n,i+e.fragmentShader),c.shaderSource(r,i+e.vertexShader),c.compileShader(n),c.compileShader(r),c.attachShader(t,n),c.attachShader(t,r),c.linkProgram(t),t},this.disable=function(){this.enable&&(c.disableVertexAttribArray(s.vertex),c.disableVertexAttribArray(s.uv),h._oldDoubleSided||c.enable(c.CULL_FACE),h._oldBlending===n.NoBlending&&c.disable(c.BLEND),q.setDepthWrite(!0,h),this.enable=!1,this.lastMaterialId=null,h.pm.currentProgram=null)}};var J=function(e,r,i){this.width=e,this.height=r,i=i||{},this.wrapS=i.wrapS!==t?i.wrapS:n.ClampToEdgeWrapping,this.wrapT=i.wrapT!==t?i.wrapT:n.ClampToEdgeWrapping,this.magFilter=i.magFilter!==t?i.magFilter:n.LinearFilter,this.minFilter=i.minFilter!==t?i.minFilter:n.LinearMipMapLinearFilter,this.anisotropy=i.anisotropy!==t?i.anisotropy:1,this.offset=new n.Vec2(0,0),this.repeat=new n.Vec2(1,1),this.format=i.format!==t?i.format:n.RGBAFormat,this.type=i.type!==t?i.type:n.UnsignedByteType,this.depthBuffer=i.depthBuffer!==t?i.depthBuffer:!0,this.stencilBuffer=i.stencilBuffer!==t?i.stencilBuffer:!0,this.generateMipmaps=!0,this.shareDepthFrom=null,this.flipY=!0};J.prototype={constructor:J,clone:function(){var e=new J(this.width,this.height);return e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.format=this.format,e.type=this.type,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e.generateMipmaps=this.generateMipmaps,e.shareDepthFrom=this.shareDepthFrom,e},getUniqueCode:function(){return this._id},dispose:function(){this.dispatchEvent({type:"dispose"})}};var K=function(e,t,n){J.call(this,e,t,n),this.activeCubeFace=0};n.extend(K,J,{});var Y="l=1.0\ntype=1\ngis=0\n3d=1\nstart=2017-09-20\nend=2018-01-01\nnote=This license applies to the evaluation version of TWaver. The License is limited to noncommercial use. Noncommercial use relates only to educational, research, personal or evaluation purposes. Any other use is commercial use. You may not use the Software in connection with any business activities.And You are not permitted to modify the software or attempt to decipher, decompile, disassemble or reverse engineer this Software.\nsignature=4b5d3387b1c804f09e328970efc02856c399f68a223de3e3912bfb7029f835846b38cac4390349d8cd5782b8df18b2d7199672a05da9044963f6ac80b5ba0d48b89dc3223b280165723d7986f8860921d17308c661ee3e74eea66f33a977c8eb032c8bc5b551cd9c30f54ecc83fbce33f3159691c827bb2a0987556d8e6397582f4bc4801204119e8cdfb4212a980c55360f3cbaed34e6bd63823593add7dea33926b1443cf02e7236f30459bf93721c3c220132bc81b9d49e345c108763370611430e699c3dd24d995d1bfd7c0e6148cf751228c3ff48c6336d040620797bf52df2ed3ab6a54f54116887e6693d50e5d5013e4e94ef9cfd5752f715db00757709eb88fba1f17ba6b5d9580f07ec1e1f55a780db9511f2049ef476fdd3d8dac62f39cf1418b299d1f091bae8738655bbaf228d58386685dff89992ed6ed06061c0c67203d9b687ec1bfa875bf655b73e0409265deee9c213f34bf0a4a9f3b6d2c07b6f317ff6ac1eb623e079d9f248accf031861b1149876dcdd27ebc754af1864b918712cad43e92d0b9b607828c9db6c93e80a243313ef79dee9aa6d0445d55bd21559a8dc99ddaf0c49b69a422f12915f5bf2117e63370c3a870c7e2bea3a5b6c78f6318ea4a6b098e3ec8c16aa72fb08a146093e7203b7a1fdf63f3a99e5bfa5cd8a223b16abc087d9f8d1e1dcd130d563d2d9528ac61717748a9f912a4720e1925805e4eecaa5d0473ab3b25e308c9de18931d63dcebff0e45d535bfaa2b79306569446f8d2a4d946e77aaca343ef27cc98deb4a7873c1319874aefd808533819e424fabd2e34692ee552445790b215dc0b2a40be47f16e29d4a6415c416545c33663bfe08b717272263805b190c1010735dfc926fe08b7f6d1647e37c9",Z,et=0xdeadbeefcafe,tt=(et&16777215)==15715070;tt&&navigator.appName=="Microsoft Internet Explorer"?(nt.prototype.am=st,Z=30):tt&&navigator.appName!="Netscape"?(nt.prototype.am=it,Z=26):(nt.prototype.am=ot,Z=28),nt.prototype.DB=Z,nt.prototype.DM=(1<<Z)-1,nt.prototype.DV=1<<Z;var ut=52;nt.prototype.FV=Math.pow(2,ut),nt.prototype.F1=ut-Z,nt.prototype.F2=2*Z-ut;var at="0123456789abcdefghijklmnopqrstuvwxyz",ft=new Array,lt,ct;lt="0".charCodeAt(0);for(ct=0;ct<=9;++ct)ft[lt++]=ct;lt="a".charCodeAt(0);for(ct=10;ct<36;++ct)ft[lt++]=ct;lt="A".charCodeAt(0);for(ct=10;ct<36;++ct)ft[lt++]=ct;Pt.prototype.convert=Ht,Pt.prototype.revert=Bt,Pt.prototype.reduce=jt,Pt.prototype.mulTo=Ft,Pt.prototype.sqrTo=It,Rt.prototype.convert=Ut,Rt.prototype.revert=zt,Rt.prototype.reduce=Wt,Rt.prototype.mulTo=Vt,Rt.prototype.sqrTo=Xt,nt.prototype.copyTo=dt,nt.prototype.fromInt=vt,nt.prototype.fromString=gt,nt.prototype.clamp=yt,nt.prototype.dlShiftTo=Nt,nt.prototype.drShiftTo=Ct,nt.prototype.lShiftTo=kt,nt.prototype.rShiftTo=Lt,nt.prototype.subTo=At,nt.prototype.multiplyTo=Ot,nt.prototype.squareTo=Mt,nt.prototype.divRemTo=_t,nt.prototype.invDigit=qt,nt.prototype.isEven=$t,nt.prototype.exp=Jt,nt.prototype.toString=bt,nt.prototype.negate=wt,nt.prototype.abs=Et,nt.prototype.compareTo=St,nt.prototype.bitLength=Tt,nt.prototype.mod=Dt,nt.prototype.modPowInt=Kt,nt.ZERO=mt(0),nt.ONE=mt(1),Rn.prototype.convert=Un,Rn.prototype.revert=Un,Rn.prototype.mulTo=zn,Rn.prototype.sqrTo=Wn,Jn.prototype.convert=Kn,Jn.prototype.revert=Qn,Jn.prototype.reduce=Gn,Jn.prototype.mulTo=Zn,Jn.prototype.sqrTo=Yn;var ir=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],sr=(1<<26)/ir[ir.length-1];nt.prototype.chunkSize=en,nt.prototype.toRadix=nn,nt.prototype.fromRadix=rn,nt.prototype.fromNumber=sn,nt.prototype.bitwiseTo=ln,nt.prototype.changeBit=kn,nt.prototype.addTo=Mn,nt.prototype.dMultiply=In,nt.prototype.dAddOffset=qn,nt.prototype.multiplyLowerTo=Vn,nt.prototype.multiplyUpperTo=$n,nt.prototype.modInt=nr,nt.prototype.millerRabin=ur,nt.prototype.clone=Qt,nt.prototype.intValue=Gt,nt.prototype.byteValue=Yt,nt.prototype.shortValue=Zt,nt.prototype.signum=tn,nt.prototype.toByteArray=on,nt.prototype.equals=un,nt.prototype.min=an,nt.prototype.max=fn,nt.prototype.and=hn,nt.prototype.or=dn,nt.prototype.xor=mn,nt.prototype.andNot=yn,nt.prototype.not=bn,nt.prototype.shiftLeft=wn,nt.prototype.shiftRight=En,nt.prototype.getLowestSetBit=xn,nt.prototype.bitCount=Nn,nt.prototype.testBit=Cn,nt.prototype.setBit=Ln,nt.prototype.clearBit=An,nt.prototype.flipBit=On,nt.prototype.add=_n,nt.prototype.subtract=Dn,nt.prototype.multiply=Pn,nt.prototype.divide=Bn,nt.prototype.remainder=jn,nt.prototype.divideAndRemainder=Fn,nt.prototype.modPow=er,nt.prototype.modInverse=rr,nt.prototype.pow=Xn,nt.prototype.gcd=tr,nt.prototype.isProbablePrime=or,nt.prototype.square=Hn,ar.prototype.init=fr,ar.prototype.next=lr;var hr=256,pr,dr,vr;if(dr==null){dr=new Array,vr=0;var yr;if(navigator.appName=="Netscape"&&navigator.appVersion<"5"&&e.crypto){var br=e.crypto.random(32);for(yr=0;yr<br.length;++yr)dr[vr++]=br.charCodeAt(yr)&255}while(vr<hr)yr=Math.floor(65536*Math.random()),dr[vr++]=yr>>>8,dr[vr++]=yr&255;vr=0,gr()}Sr.prototype.nextBytes=Er;var xr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Tr="=";Mr.prototype.doPublic=Dr,Mr.prototype.setPublic=_r,Mr.prototype.encrypt=Pr,Mr.prototype.doPrivate=Fr,Mr.prototype.setPrivate=Br,Mr.prototype.setPrivateEx=jr,Mr.prototype.decrypt=Ir;var qr=function(){Rr.v(Y)},Rr={},Ur="6a384c1259bdb5e731ec96b3174683f48a2c56a85e52e7a5bb20b58711ce50c1a294bd5e1d1752e766085e9ae94bae6d217c25dbb5fcdb86a8a9a7e180fa066723d00fcb85fcf7c9d29f8cc8859f53244a49c0bc30dcc45156daf8843ce1d24fe8ebc9a3c186bb26e9d0714041aef160304c1db8cc5728cf4acb39d29755f319",zr="10001",Wr="61a921483dfa8f24e26204ace4d990b965d11e5bef5d8a5e768ebc5853a6bdd94b02369a3165207460fb91001d3fd83fbe69c6e51b8e40c8ae8a4e30a7c539dca98b44858bdc0b76f25af6803d4d13dacd9fa1a28f66cf561fa36309d4239a2cf50fe20ef0e99e01fc8701090f0685a524f411e00ca91f877d3b49d2d0052f9",Xr="b881f568eb43e7a60c256a8a90e08b7c7638fd66ce3cded9005c72e283ca4f2b8601e2edc687d7f898348a05723b515d9edeb626af7b499a56ddaea93b0c2047",Vr="9360ab3d6b678727748ea004e85120f1823ec94e6116dc5fcd7b1c9ea231d38e5d7d2d23c00607912e1645835756b71290c6c3cc2bc656e93d9a4f6b0d55619f",$r="3e61c2259d15b26693c8bac2eac4e0a44e1c6aa0adae2af2578aea54e796293a5fee9759293c98aab65b5d27063e43fe514e9f6b68fd581f54ab52f868bc6ad5",Jr="4dac2913d9c35a6be4f63647dfd8c23006a0e89fb273c5f987e656931490861b0612aef3a48489006ef5b5f51ed6c8edb3f7cdc191609af59a4df5854a25b1a9",Kr="acd9837a1472711ff2b63ba0de667fa4a4a56a8b0f4cbb0a555f73d1bc529e9ecf865b709fd8235c3db05bcf1539de1e594d3a8275fe0784a9f5241d8895b328";Rr.cross=function(e){if(e){var t="";for(var n=0;n<e.length;)n+1<e.length?(t+=e[n+1],t+=e[n]):t+=e[n],n+=2;return t}return null},Rr.reverse=function(e){if(e){var t="";for(var n=e.length;n>0;n--)t+=e[n-1];return t}return null},Rr.v=function(e){if(e){var t=Rr;t.start=null,t.beginDate=null,t.end=null,t.endDate=null,t.gis=null,t["3D"]=null,t["3d"]=null,t.l=null,t.__li__=null;if(e.indexOf("signature=")>0){var n=e.split("signature="),r=n[0],i=n[1],s=new Mr;s.setPublic(Ur,zr);var o=i,u=o.length,a=256,f=0,l="",c="";while(f<u)l=o.substr(f,a),c+=s.decrypt(l),f+=a;if(c===r)return t.i(e),!0}}return!1},Rr.i=function(e){var n=Rr;n.__li__=e;var r=e.split("\n"),i,s,o,u,a;for(i=0;i<r.length;i++)s=r[i],a=s.split("="),o=a[0],u=a[1],n[o]=u;n.start!=t&&(n.beginDate=new Date(Date.parse(n.start.replace(/-/g,"/")))),n.end!=t&&(n.endDate=new Date(Date.parse(n.end.replace(/-/g,"/"))));var f=n.gis;f!=t&&(f=parseInt(f)),f&&(n._isPermissionGIS=!0);var l=n["3D"]||n["3d"];l!=t&&(l=parseInt(l)),l&&(n._isPermission3D=!0),n.l!=t&&(n.version=n.l)};var Qr=function(e){return e.__li__!==t&&e._isPermission3D},Gr=function(e){if(!Qr(e))return!0;var t=new Date;return e.beginDate!=null&&e.beginDate.getTime()-t.getTime()>=0||e.endDate!=null&&e.endDate.getTime()-t.getTime()<=0},Yr=function(e){return e.type===2?!0:!1},Zr=function(e){return Gr(e)?!1:e._isPermissionGIS};Rr.$z=function(e){var t=new Mr;t.setPublic(Ur,zr);var n=e,r=n.length,i=256,s=0,o="",u="";while(s<r)o=n.substr(s,i),u+=t.decrypt(o),s+=i;return u},Rr.twm=function(e){var n=Rr,r=n.$z("4cd18113d0c7046bfe51f7a3fbd41c2b7cf14dd785d6ea7cec9da17710d3acfb8ce0cb9cf10839f4bd51e88819de19cdc0db09278584396156fcb65abe0353ac49d01326b30efa0ea98a07da9f8ceeb7572fc1b37b5965ba6103ccba4913b62e36e49425c6ff21a2f008830c59cff8f29058769f858c8a9f0bab3eaea7fb8a9e"),i=this.type,s=this.markText,o=n.$z("648be38cd61c870e95ffc1ea0676af40736c1365015abc326e891a4de67b4de3d4b05da70b9aebedc83ec26ecf71eb74c72f42f6d9a4be2d507d2f67d2860b7b66e3ba1d565e15923f2db335ff922eef17c01b59818b583d5656412d6cc9d9ba70001c2c88e3efd492c6b13a07fda5f325b333138a2036f4696542ec137cc341");e[o]=n.__li__;var u=e;u._xyz=null;if(i==="3"&&!Gr(Rr)&&s===t)return;e.DEBUG&&(console.log("license: "+Rr.__li__),console.log("license Type : "+i),console.log("beginDate: "+Rr.beginDate),console.log("endDate: "+Rr.endDate),console.log("mark: "+s)),e.__liLabel==t&&(e.__liLabel=document.createElement("div")),n.startDate===t&&(n.startDate=new Date);var a=(new Date).getTime()-n.startDate.getTime(),f=i==="2"?7200:300;if(a<1e3*f)return;var l=Gr(n)&&a>1e3*f,c=s;l?c=n.$z("0dd629dbd0ce341ecdd447e35ddc3135a0b46916f7571a687f38ae665cf0ae095fee885e14329caa75112d8787508da17285b0897845d8ccae73e6a2727dd19f1ca335fe139d0e60d240f9ececc78f81c2c5667f51aeed4135b9c4bb436b8acb7cd418eeeb404bc4f3bcdedb481ac0edff7644435ce2b9f2bda78c892bd56d73"):i!="2"||c!==t&&c!=""?i=="1"&&!s&&(c=r):c=n.$z("644d54bf9c59afbd8a742a9e7e2731f23f149ccb7f04c3547548c50ac2d77faea108b55f1f6261e99869f1c06b84e8abdefdf45b5170048531421f3d528123972ba2f03d70f37c33f1341dc12f986e0089e42bab517e2a05b455d12d90991bbba9bc45c715a81943062ea5fa5408c8b1b9270d260cc5a67b38ecc4178ce512fc");if(c===t)return;var h=u.__liLabel;h.innerHTML=c,h.type=i,h.mark=s,h.expired=l,u._xyz=h,l&&(u.getView().style.opacity=.1)},H.validateLicense(Y),n.Material=function(e){n.PropertyChangeDispatcher.call(this),this.id=n.MaterialIdCount++,this.type="basic",this.shaderID="",this.uniforms=t,this.vertexShader="",this.fragmentShader="",this.alarmColor=null,this.name="",this.side=n.FrontSide,this.fog=!0,this.normalType=t,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecolor=new n.Color(16777215),this.wireframeLineopacity=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=2,this.gradientColors=3,this.blendMode=n.NormalBlending,this.blendSrc=n.SrcAlphaFactor,this.blendDst=n.OneMinusSrcAlphaFactor,this.blendEquation=n.AddEquation,this.depthTest=!0,this.depthMask=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.transparent=!1,this.opacity=1,this.visible=!0,this.needsUpdate=!0,this.setValues(e),this.useCount=0,this.styleMap={},this.offset=new o(0,0),this.repeat=new o(1,1),this.gradient={},this.gradientType=1,this.gradientCenter=new o(.5,.5),this.outline=0},n.extend(n.Material,n.PropertyChangeDispatcher,{generateKey:function(){},setMap:function(e,t){t==null&&(t="map");if(this[t]===e)return;var n=this[t];this[t]=e,this.firePropertyChange(t,n,e),this.onMapChanged(n,e)},handleTextureChange:function(e){if(e.property==="image"){var t=this;this.firePropertyChange("needsUpdate",!1,!0)}else e.property==="disposed"},onPropertyChange:function(e,t,n){},onMapChanged:function(e,t){},setColor:function(e){if(this.color===e)return;var t=this.color.clone();e instanceof n.Color?this.color.copy(e):this.color.set(e),this.firePropertyChange("color",t,e)},setPropertyValue:function(e,t){if(this[e]===t)return;var r=this[e];if(r instanceof n.Color)t!=null&&(r=r.clone(),t instanceof n.Color?this[e].copy(t):this[e].set(t));else if(e=="gradient"){var i={};for(var s in t)t[s]instanceof n.Color?i[s]=t[s]:i[s]=new n.Color(t[s]);this[e]=i}else this[e]=t;this._uniqueCode=null,this.firePropertyChange(e,r,t)},isTextureStyle:function(e){return this._type==="terrain"?e.startsWith("texture1.")||e.startsWith("texture2.")||e.startsWith("textureb.")||e.startsWith("texturen.")||e.startsWith("texturebp."):e.startsWith("texture.")||e.startsWith("lightmap")||e.startsWith("envmap")||e.startsWith("normalmap")||e.startsWith("specularmap")},setNeedsUpdate:function(e){},getShaderID:function(){return this instanceof n.BasicMaterial&&(this.shaderID="basic"),this.shaderID},setupMaterialShader:function(){var e=this.getShaderID(),t=n.ShaderLib[e];t&&(this.uniforms=n.UniformsUtils.clone(t.uniforms),this.vertexShader=t.vertexShader,this.fragmentShader=t.fragmentShader)},refreshUniforms:function(e,t){this.refreshUniformsCommon(e,t),this.refreshUniformsSpecific(e,t)},loadCameraPosition:function(e,t,r){if(this instanceof n.ShaderMaterial||this instanceof n.PhongMaterial||this.envMap||this._type==="phong")if(e.cameraPosition!=null){var i=t.worldMatrix.getPosition();r.uniform3f(e.cameraPosition,i.x,i.y,i.z)}},loadViewMatrix:function(e,t,n){(this.type==="lambert"||this.type==="phong"||material.skinning)&&e.viewMatrix!==null&&n.uniformMatrix4fv(p_uniforms.viewMatrix,!1,t.worldMatrixInverse.elements)},refreshUniformsSpecific:function(e){},refreshUniformsCommon:function(e){var r=this.uniforms,i=this;r.opacity.value=i.opacity,r.wireframeLinecolor.value=i.wireframeLinecolor,r.wireframeLineopacity.value=i.wireframeLineopacity;var s=H.getObjectCount(this.gradient)>0;e?r.diffuse.value.copyGammaToLinear(this.alarmColor?this.alarmColor:this.color):r.diffuse.value=this.alarmColor?this.alarmColor:this.color;if(s){var o=[],u=[];for(var a in this.gradient)o.push(a);o.sort();for(var f=0;f<o.length;f++)u.push(this.gradient[o[f]]);r.gradientColor.value=u,r.gradientStop.value=o,r.gradientType.value=this.gradientType}r.map.value=i.map,r.lightMap.value=i.lightMap,r.specularMap.value=i.specularMap,i.bumpMap&&(r.bumpMap.value=i.bumpMap,r.bumpScale.value=i.bumpScale),i.normalMap&&i._type==="phong"&&(r.normalMap.value=i.normalMap,r.normalScale.value.copy(i.normalScale));var l;i.map?l=i.map:i.specularMap?l=i.specularMap:i.normalMap&&i._type==="phong"?l=i.normalMap:i.bumpMap&&i._type==="phong"&&(l=i.bumpMap);if(l!=t){var c=this.offset,h=this.repeat;r.offsetRepeat.value.set(c.x,c.y,h.x,h.y),r.flipX.value=l.flipX?1:0,r.mapLoaded.value=1,l._image&&!l._image.loaded&&r.offsetRepeat.value.set(0,0,1,1)}r.envMap.value=i.envMap,r.flipEnvMap.value=1,e?r.reflectivity.value=i.reflectRatio*i.reflectRatio:r.reflectivity.value=i.reflectRatio,r.refractionRatio.value=i.refractionRatio,r.combine.value=i.combine,r.useRefract.value=i.envMap&&i.envMap.mapping instanceof n.CubeRefractionMapping},loadGeneralUniforms:function(){},getNormalType:function(){var e=this&&this.normalType!==t&&this.normalType===n.NormalTypeSmooth;return e?n.SmoothShading:n.FlatShading},isVertexColor:function(){return this.vertexColors?this.vertexColors:!1},isGradientColor:function(){return this.gradientColors?this.gradientColors:!1},needUV:function(){return this.map||this.lightMap||this.bumpMap||this.normalMap||this.specularMap?!0:!0},setValues:function(e){if(e===t)return;for(var r in e){var i=e[r];if(i===t){console.warn("TGL.Material: '"+r+"' parameter is undefined.");continue}if(r in this){var s=this[r];s instanceof n.Color&&i instanceof n.Color?s.copy(i):s instanceof n.Color?s.set(i):s instanceof n.Vec3&&i instanceof n.Vec3?s.copy(i):this[r]=i}}},isCustomAttributesNeedUpdate:function(){if(!this.attributes)return!1;for(var e in this.attributes)if(this.attributes[e].needsUpdate)return!0;return!1},clearCustomAttributes:function(){if(this.attributes)for(var e in this.attributes)this.attributes[e].needsUpdate=!1},clone:function(e){return e===t&&(e=new n.Material),e.name=this.name,e.side=this.side,e.blendMode=this.blendMode,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.depthTest=this.depthTest,e.depthMask=this.depthMask,e.polygonOffset=this.polygonOffset,e.polygonOffsetFactor=this.polygonOffsetFactor,e.polygonOffsetUnits=this.polygonOffsetUnits,e.alphaTest=this.alphaTest,e.transparent=this.transparent,e.opacity=this.opacity,e.visible=this.visible,e.normalType=this.normalType,e.wireframe=this.wireframe,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecolor=this.wireframeLinecolor.clone(),e.wireframeLineopacity=this.wireframeLineopacity,e.gradient=this.gradient,e.gradientType=this.gradientType,e.outline=this.outline,e},dispose:function(){this.firePropertyChange("disposed",!1,!0)}}),n.MaterialIdCount=0,n.EntityMaterial=function(e){n.Material.call(this),this._type="basic",this.color=new n.Color(16777215),this.map=null,this.ambient=new n.Color(16777215),this.emissive=new n.Color(0),this.specular=new n.Color(1118481),this.specularStrength=1,this.shininess=30,this.wrapAround=!1,this.wrapRGB=new n.Vec3(1,1,1),this.lightMap=null,this.specularMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new n.Vec2(1,1),this.envMap=null,this.combine=n.MultiplyOperation,this.reflectRatio=1,this.refractionRatio=.98,this.fog=!0,this.shading=n.SmoothShading,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.metal=!1,this.perPixel=!0,this.map1=null,this.map2=null,this.blendMap=null,this.detailMap=null,this.specularMap=null,this.blendRange=new o(0,1),this.setValues(e),this.bakeLightMap=!1,this.metalness=0,this.roughness=0},n.extend(n.EntityMaterial,n.Material,{getShaderID:function(){return this.getType()},getUniqueCode:function(){if(this._uniqueCode!=null)return this._uniqueCode;var e=this._type+" "+this.color.r+this.color.g+this.color.b+" "+this.ambient.getUniqueCode()+" "+this.emissive.getUniqueCode()+this.specular.getUniqueCode()+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth+" "+this.wireframeLinecolor+" "+this.wireframeLineopacity+" "+this.polygonOffset+" "+this.polygonOffsetFactor+" "+this.polygonOffsetUnits+" "+this.overdraw+" "+this.shininess+" "+this.metal+" "+this.specularStrength;this.alphaTest&&(e+=this.alphaTest),e+=" "+this.normalType+" ",e+=this.repeat.x+" "+this.repeat.y+this.offset.x+" "+this.offset.y,e+=" "+this.blendRange.x+" "+this.blendRange.y,e+=" "+this.normalScale.x+" "+this.normalScale.y,e+=" "+this.reflectRatio,this.map&&(e+=this.map.getUniqueCode()),this.map1&&(e+=this.map1.getUniqueCode()),this.map2&&(e+=this.map2.getUniqueCode()),this.blendMap&&(e+=this.blendMap.getUniqueCode()),this.normalMap&&(e+=this.normalMap.getUniqueCode()),this.lightMap&&(e+=this.lightMap.getUniqueCode()),this.envMap&&(e+=this.envMap.getUniqueCode()),this.specularMap&&(e+=this.specularMap.getUniqueCode()),this.alarmColor&&(e+=" "+this.alarmColor.getUniqueCode()),this.roughness&&(e+=" "+this.roughness),this.metalness&&(e+=" "+this.metalness);if(this.gradient)for(var t in this.gradient)e+=" "+t+":"+this.gradient[t].getUniqueCode();return e+=" "+this.gradientType,e+=" "+this.outline,e+=this.combine,e+=this.bakeLightMap?" bakeLightMap ":"",this._uniqueCode=e,e},loadViewMatrix:function(e,t,n){(this._type==="lambert"||this._type==="phong"||material.skinning)&&e.viewMatrix!==null&&n.uniformMatrix4fv(p_uniforms.viewMatrix,!1,t.worldMatrixInverse.elements)},onMapChanged:function(e,t){n.TexturePool.useTexture(t),n.TexturePool.unUseTexture(e);if(t){var r=t.getUniqueCode();n.TexturePool.getTexture(r)==null&&n.TexturePool.setTexture(r,t)}},setType:function(e){if(this._type===e)return;var t=this._type;this._type=e,this.firePropertyChange("type",t,e),this.onTypeChanged(t,e)},onTypeChanged:function(){},getType:function(){return this._type},setStyle:function(e,t){if(e==null)return;this.styleMap==null&&(this.styleMap={});var r=this.styleMap[e];return t==null?delete this.styleMap[e]:this.styleMap[e]=t,this.firePropertyChange(n.Styles.PREFIX_STYLE+e,r,t),this.onStyleChanged(e,r,t),this},getStyle:function(e,t){t==null&&(t=!0);var r;return this.styleMap!=null&&(r=this.styleMap[e]),r==null&&t&&(r=n.Styles.getStyle(e)),r},clone:function(e){return e=e||new n.EntityMaterial,n.Material.prototype.clone.call(this,e),e._type=this._type,e.color.copy(this.color),e.wireframeLinecolor.copy(this.wireframeLinecolor),e.setMap(this.map,"map"),e.setMap(this.map1,"map1"),e.setMap(this.map2,"map2"),e.setMap(this.blendMap,"blendMap"),e.setMap(this.normalMap,"normalMap"),e.setMap(this.specularMap,"specularMap"),e.setMap(this.envMap,"envMap"),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.specular.copy(this.specular),e.shininess=this.shininess,e.metal=this.metal,e.perPixel=this.perPixel,e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.setMap(this.lightMap,"lightMap"),e.bumpMap=this.bumpMap,e.bumpScale=this.bumpScale,e.normalScale.copy(this.normalScale),e.combine=this.combine,e.reflectRatio=this.reflectRatio,e.refractionRatio=this.refractionRatio,e.fog=this.fog,e.shading=this.shading,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e.specularStrength=this.specularStrength,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.blendRange.copy(this.blendRange),e.metalness=this.metalness,e.roughness=this.roughness,e},refreshUniformsSpecific:function(e){var t=this.uniforms;this._type==="lambert"?(e?(t.ambient.value.copyGammaToLinear(this.ambient),t.emissive.value.copyGammaToLinear(this.emissive)):(t.ambient.value=this.ambient,t.emissive.value=this.emissive),this.wrapAround&&t.wrapRGB.value.copy(this.wrapRGB)):this._type==="phong"?(t.shininess.value=this.shininess,e?(t.ambient.value.copyGammaToLinear(this.alarmColor?this.alarmColor:this.ambient),t.emissive.value.copyGammaToLinear(this.emissive),t.specular.value.copyGammaToLinear(this.specular)):(t.ambient.value=this.alarmColor?this.alarmColor:this.ambient,t.emissive.value=this.emissive,t.specular.value=this.specular),t.uspecularStrength.value=this.specularStrength,this.wrapAround&&t.wrapRGB.value.copy(this.wrapRGB)):this._type==="physic"&&(t.metalness.value=this.metalness,t.roughness.value=this.roughness)},refreshUniformsCommon:function(e){if(this._type==="terrain"){var t=this.uniforms;t.enableDiffuse1.value=this.map?1:0,t.tDiffuse1.value=this.map,t.enableDiffuse2.value=this.map1?1:0,t.tDiffuse2.value=this.map1,t.enableDiffuse3.value=this.map2?1:0,t.tDiffuse3.value=this.map2,t.enableDisplacement.value=this.blendMap?1:0,t.tDisplacement.value=this.blendMap,t.uRepeatOverlay.value=this.repeat,this.blendRangeArray==null&&(this.blendRangeArray=[0,1]),this.blendRangeArray[0]=this.blendRange.x,this.blendRangeArray[1]=this.blendRange.y,t.blendRange.value=this.blendRangeArray,t.uOpacity.value=this.opacity}else if(this._type==="outline"){var t=this.uniforms;t.diffuse.value=this.color,t.outline_offset.value=this.outline}else n.Material.prototype.refreshUniformsCommon.call(this,e)}}),n.BlurMaterial=function(){n.Material.call(this),this.orientation=0,this.blurAmount=5,this.blurScale=1,this.blurStrength=1,this.useBlur=1,this.texelSize=new o(512,512),this.blurGlobalAlpha=1},n.extend(n.BlurMaterial,n.Material,{refreshUniformsCommon:function(e){var t=this.uniforms;t.map.value=this.map,t.orientation.value=this.orientation,t.blurAmount.value=this.blurAmount,t.blurScale.value=this.blurScale,t.blurStrength.value=this.blurStrength,t.useBlur.value=this.useBlur,t.texelSize.value=this.texelSize,t.blurGlobalAlpha.value=this.blurGlobalAlpha}
,getShaderID:function(){return"blur"}}),n.DeferredMaterial=function(e){e=e||{},n.Material.call(this,e),this.linearDepth=30,this.isNormal=e.isNormal!==t?e.isNormal:0},n.extend(n.DeferredMaterial,n.Material,{getShaderID:function(){return"deferred"},refreshUniformsCommon:function(e){var t=this.uniforms;t.linearDepth.value=this.linearDepth,t.isNormal.value=this.isNormal}}),n.SSAOMaterial=function(e){n.Material.call(this),this.map1=null,this.map2=null,this.occluderBias=.05,this.samplingRadius=20,this.attenuation=new o(1,.02),this.texelSize=new o(1/512,1/512)},n.extend(n.SSAOMaterial,n.Material,{getShaderID:function(){return"ssao"},refreshUniformsCommon:function(e){var t=this.uniforms;t.map0.value=this.map,t.map1.value=this.map1,t.map2.value=this.map2,t.occluderBias.value=this.occluderBias,t.samplingRadius.value=this.samplingRadius,t.attenuation.value=this.attenuation,t.texelSize.value=this.texelSize}}),n.BasicMaterial=function(e){n.Material.call(this),this._type="basic",this.color=new n.Color(16777215),this.map=null,this.setValues(e),this.offset=new o(0,0),this.repeat=new o(1,1)},n.extend(n.BasicMaterial,n.Material,{getShaderID:function(){return"basic"},clone:function(){var e=new n.BasicMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e},getUniqueCode:function(){var e=this.color.r+this.color.g+this.color.b+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth;return e+=this.repeat.x+" "+this.repeat.y+this.offset.x+" "+this.offset.y,this.map&&(e+=this.map.getUniqueCode()),e}}),n.LambertMaterial=function(e){n.Material.call(this),this._type="basic",this.color=new n.Color(16777215),this.ambient=new n.Color(16777215),this.emissive=new n.Color(0),this.wrapAround=!1,this.wrapRGB=new n.Vec3(1,1,1),this.map=null,this.lightMap=null,this.specularMap=null,this.envMap=null,this.combine=n.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=n.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=n.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)},n.extend(n.LambertMaterial,n.Material,{clone:function(){var e=new n.LambertMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.lightMap=this.lightMap,e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.fog=this.fog,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},getShaderID:function(){return"lambert"},refreshUniformsSpecific:function(e){var t=this.uniforms;e?(t.ambient.value.copyGammaToLinear(this.ambient),t.emissive.value.copyGammaToLinear(this.emissive)):(t.ambient.value=this.ambient,t.emissive.value=this.emissive),this.wrapAround&&t.wrapRGB.value.copy(this.wrapRGB)}}),n.PhongMaterial=function(e){n.Material.call(this),this._type="basic",this.color=new n.Color(16777215),this.ambient=new n.Color(16777215),this.emissive=new n.Color(0),this.specular=new n.Color(1118481),this.shininess=30,this.metal=!1,this.perPixel=!0,this.wrapAround=!1,this.wrapRGB=new n.Vec3(1,1,1),this.map=null,this.lightMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new n.Vec2(1,1),this.specularMap=null,this.envMap=null,this.combine=n.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=n.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=n.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e),this.offset=new o(0,0),this.repeat=new o(1,1)},n.extend(n.PhongMaterial,n.Material,{getUniqueCode:function(){var e="phong "+this.color.r+this.color.g+this.color.b+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth;return e+=this.repeat.x+" "+this.repeat.y+this.offset.x+" "+this.offset.y,this.map&&(e+=this.map.getUniqueCode()),e},clone:function(){var e=new n.PhongMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.specular.copy(this.specular),e.shininess=this.shininess,e.metal=this.metal,e.perPixel=this.perPixel,e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.lightMap=this.lightMap,e.bumpMap=this.bumpMap,e.bumpScale=this.bumpScale,e.normalMap=this.normalMap,e.normalScale.copy(this.normalScale),e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.fog=this.fog,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},getShaderID:function(){return"phong"},refreshUniformsSpecific:function(e){var t=this.uniforms;t.shininess.value=this.shininess,e?(t.ambient.value.copyGammaToLinear(this.ambient),t.emissive.value.copyGammaToLinear(this.emissive),t.specular.value.copyGammaToLinear(this.specular)):(t.ambient.value=this.ambient,t.emissive.value=this.emissive,t.specular.value=this.specular),this.wrapAround&&t.wrapRGB.value.copy(material.wrapRGB)}}),n.LineMaterial=function(e){n.Material.call(this),this.color=new n.Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.dashed=!0,this.scale=1,this.dashSize=3,this.gapSize=1,this.skyY=0,this.horizonY=0,this.earthY=0,this.skyColor=new n.Color(16777215),this.horizonColor=new n.Color(16777215),this.earthColor=new n.Color(16777215),this.vertexColors=!1,this.gradientColors=!0,this.fog=!0,this.setValues(e)},n.extend(n.LineMaterial,n.Material,{getUniqueCode:function(){var e=this.color.getUniqueCode+" "+this.linewidth+" "+this.dashed+" "+this.visible;return e+=this.transparent+" "+this.opacity,e+=this.skyY+" "+this.horizonY+" "+this.earthY,e+=this.skyColor.getUniqueCode(),e+=this.horizonColor.getUniqueCode(),e+=this.earthColor.getUniqueCode(),e},clone:function(){var e=new n.LineMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.linewidth=this.linewidth,e.linecap=this.linecap,e.linejoin=this.linejoin,e.dashed=this.dashed,e.scale=this.scale,e.dashSize=this.dashSize,e.gapSize=this.gapSize,e.vertexColors=this.vertexColors,e.fog=this.fog,e},getShaderID:function(){return this.dashed?"dashed":"basic"},refreshUniforms:function(e){ei(this.uniforms,this),this.dashed&&ti(this.uniforms,this)}}),n.LineXMaterial=function(e){n.Material.call(this),this.color=new n.Color(16777215),this.side=n.DoubleSide,this.attributes={positionPrev:{type:"v3",ref:"verticesPrev"},positionNext:{type:"v3",ref:"verticesNext"},offset:{type:"f",ref:"offset"},lineDistances:{type:"f",ref:"lineDistances"}},this.useVertexColor=!1,this.totalSize=0,this.dashSize=0},n.extend(n.LineXMaterial,n.Material,{getUniqueCode:function(){var e=this.color.getUniqueCode()+this.visible;return e+=this.transparent+" "+this.opacity,e+=this.side,e+=this.useVertexColor,this.totalSize&&(e+=this.totalSize),this.dashSize&&(e+=this.dashSize),e},clone:function(){var e=new n.LineXMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.useVertexColor=this.useVertexColor,e.dashSize=this.dashSize,e.totalSize=this.totalSize,e},getShaderID:function(){return"linex"},refreshUniforms:function(e,t){this.uniforms.lineColor.value=this.color,this.uniforms.opacity.value=this.opacity;if(t.network){var r=t.network.getView();this.uniforms.viewport.value=new n.Vec4(0,0,r.width,r.height)}t.camera&&(this.uniforms.near.value=t.camera.near||1),this.uniforms.useVertexColor.value=this.useVertexColor?1:0,this.uniforms.dashSize.value=this.dashSize,this.uniforms.totalSize.value=this.totalSize}}),n.SurfaceMaterial=function(e){n.EntityMaterial.call(this),this.skyY=0,this.horizonY=0,this.earthY=0,this.skyColor=new n.Color(16777215),this.horizonColor=new n.Color(16777215),this.earthColor=new n.Color(16777215)},n.extend(n.SurfaceMaterial,n.EntityMaterial,{getUniqueCode:function(){var e=n.EntityMaterial.prototype.getUniqueCode.call(this);return this.skyColor&&(e+=" "+this.skyColor.getUniqueCode()),this.horizonColor&&(e+=" "+this.horizonColor.getUniqueCode()),this.earthColor&&(e+=" "+this.earthColor.getUniqueCode()),e+=" "+this.skyY,e+=" "+this.horizonY,e+=" "+this.earthY,this._uniqueCode=e,e},clone:function(){var e=new n.SurfaceMaterial;return n.EntityMaterial.prototype.clone.call(this,e),e.skyY=this.skyY,e.horizonY=this.horizonY,e.earthY=this.earthY,e.skyColor=this.skyColor,e.horizonColor=this.horizonColor,e.earthColor=this.earthColor,e},refreshUniforms:function(e){n.EntityMaterial.prototype.refreshUniforms.call(this,e),ni(this.uniforms,this)}}),n.ArrayMaterial=function(e){this.materials=e||[]},n.extend(n.ArrayMaterial,Object,{clone:function(){var e=new n.ArrayMaterial;for(var t=0;t<this.materials.length;t++){var r=this.materials[t],i=this.materials.indexOf(r);e.materials[i]!=null?e.materials.push(e.materials[i]):e.materials.push(r.clone())}return e}}),n.BillboardMaterial=function(e){n.Material.call(this),this.alignment=n.BillboardAlignment.center.clone(),this.fog=!1,this.color=new n.Color(16777215),this.map=null,this.rotation=0,this.fog=!1,this.offset=new n.Vec2(0,0),this.repeat=new n.Vec2(1,1),this.transparent=!0,this.setValues(e),this.depthMask=!0,this.vertical=!1,this.fixedSize=0,this.alphaTest=0},n.extend(n.BillboardMaterial,n.Material,{clone:function(e){return e=e?e:new n.BillboardMaterial,n.Material.prototype.clone.call(this,e),e.alignment.copy(this.alignment),e.color.copy(this.color),e.map=this.map,e.rotation=this.rotation,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.fog=this.fog,e.vertical=this.vertical,e.transparent=this.transparent,e.alphaTest=this.alphaTest,e.blendMode=this.blendMode,e.fixedSize=this.fixedSize,e},getUniqueCode:function(){var e="Billboard "+this.color.r+this.color.g+this.color.b+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth;return e+=this.vertical+" "+this.alphaTest+" "+this.alignment.x+" "+this.alignment.y,e+=this.fixedSize,e+=this.repeat.x+" "+this.repeat.y,e+=this.offset.x+" "+this.offset.y,e+=" "+this.blendMode,this.map&&(e+=this.map.getUniqueCode()),e}}),n.BillboardAlignment={},n.BillboardAlignment.topLeft=new n.Vec2(.5,-0.5),n.BillboardAlignment.topCenter=new n.Vec2(0,-0.5),n.BillboardAlignment.topRight=new n.Vec2(-0.5,-0.5),n.BillboardAlignment.centerLeft=new n.Vec2(.5,0),n.BillboardAlignment.center=new n.Vec2(0,0),n.BillboardAlignment.centerRight=new n.Vec2(-0.5,0),n.BillboardAlignment.bottomLeft=new n.Vec2(.5,.5),n.BillboardAlignment.bottomCenter=new n.Vec2(0,.5),n.BillboardAlignment.bottomRight=new n.Vec2(-0.5,.5);var ri=function(e){n.Material.call(this),this.fragmentShader="void main() {}",this.vertexShader="void main() {}",this.uniforms=e.uniforms||{},this.defines={},this.attributes=null,this.shaderID=e.shaderID||"depth",this._type="shader",this.shading=n.SmoothShading,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.vertexColors=n.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName="position",this.setValues(e)};n.ShaderMaterial=ri,n.extend(n.ShaderMaterial,n.Material,{clone:function(){var e=new n.ShaderMaterial;return n.Material.prototype.clone.call(this,e),e.fragmentShader=this.fragmentShader,e.vertexShader=this.vertexShader,e.uniforms=n.UniformsUtils.clone(this.uniforms),e.attributes=this.attributes,e.defines=this.defines,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.fog=this.fog,e.lights=this.lights,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},setupMaterialShader:function(){},needUV:function(){return!0},getShaderID:function(){return this.shaderID},refreshUniformsCommon:function(e,t){}}),n.TransformGizmoMaterial=function(e){n.BasicMaterial.call(this),this.depthTest=!1,this.depthMask=!1,this.side=n.DoubleSide,this.transparent=!0,this.setValues(e)},n.extend(n.TransformGizmoMaterial,n.BasicMaterial,{getUniqueCode:function(){var e=this.id+"TransformGizmo "+this.color.r+this.color.g+this.color.b+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth;return this.map&&(e+=this.map.getUniqueCode()),e}});var ii={pools:{},useTimes:{},size:0,getMaterial:function(e){return ii.pools[e]},setMaterial:function(e,t){ii.size++,ii.pools[e]=t},useMaterial:function(e){if(e){var t=e.id,n=ii.useTimes[t]||0;n++,ii.useTimes[t]=n}},unUseMaterial:function(e){if(e){var t=e.id,n=ii.useTimes[t]||0;n--,ii.useTimes[t]=n;if(n<=0){var r=e.getUniqueCode();delete ii.pools[r],ii.size--,e.dispose()}}},clear:function(){this.pools={},this.useTimes={},this.size=0}};n.MaterialPool=ii,ii.DefaultMaterial=new n.EntityMaterial,ii.TestMaterial=new n.EntityMaterial,ii.DefaultBillBoardMaterial=new n.BillboardMaterial,ii.DefaultLineMaterial=new n.LineMaterial,n.ParticleMaterial=function(e){n.Material.call(this),this.color=new n.Color(16777215),this.map=null,this.size=2,this.sizeAttenuation=!1,this.vertexColors=!1,this.fog=!0,this.setValues(e)},n.extend(n.ParticleMaterial,n.Material,{clone:function(){var e=new n.ParticleMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.size=this.size,e.sizeAttenuation=this.sizeAttenuation,e.vertexColors=this.vertexColors,e.fog=this.fog,e},getShaderID:function(){return this.shaderID="particle_basic",this.shaderID},getUniqueCode:function(){var e=this.color.getUniqueCode();return e+=map?map.getUniqueCode():"",e+=" "+this.size,e+=" "+this.fog,e+=" "+this.sizeAttenuation,e+=" "+this.transparent,e+=" "+this.opacity,e+=" "+this.depthTest,e+=" "+this.alphaTest,e},refreshUniforms:function(e){si(this.uniforms,this)}}),n.Light=function(e,t){n.Element.call(this,t),this.color=new n.Color(e),this.ambient=new n.Color,this.diffuse=new n.Color,this.specular=new n.Color,this.castShadow=!1,this.onlyShadow=!1},n.extend(n.Light,n.Element,{__accessor:["color","ambient","diffuse","specular"],constructor:n.Light,className:"TGL.Light",setCastShadow:function(e){this.castShadow=e},setOnlyShadow:function(e){this.onlyShadow=e},refreshShadowUniforms:function(e,t){var r=this;if(e.shadowMatrix&&r.castShadow)if(r instanceof n.SpotLight||r instanceof n.DirectionalLight&&!r.shadowCascade)return e.shadowMap.value[t]=r.shadowMap,e.shadowMapSize.value[t]=r.shadowMapSize,e.shadowMatrix.value[t]=r.shadowMatrix,e.shadowDarkness.value[t]=r.shadowDarkness,e.shadowBias.value[t]=r.shadowBias,!0},refreshUniformsPointShadow:function(e,t){var r=this;if(e.pShadowMap&&r.castShadow&&r instanceof n.PointLight)return e.pShadowMap.value[t]=r.shadowMap,e.pShadowMapSize.value[t]=r.shadowMapSize,e.pShadowDarkness.value[t]=r.shadowDarkness||.5,e.pPosition.value[t]=r.getPosition(),e.pShadowRadius.value[t]=r.shadowRadius||1,e.shadowCameraNear.value=r.shadowCameraNear,e.shadowCameraFar.value=r.shadowCameraFar,e.pShadowBias.value[t]=r.shadowBias,!0}}),n.PointLight=function(e,r,i,s){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var o=arguments[0];e=o.hex,r=o.intensity,i=o.distance,s=o.id}n.Light.call(this,e,s),this.position=new n.Vec3(0,0,0),this.intensity=r!==t?r:1,this.distance=i!==t?i:0,this.shadowCameraNear=10,this.shadowCameraFar=1e3,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowDarkness=.5,this.shadowBias=0},n.extend(n.PointLight,n.Light,{constructor:n.PointLight,className:"TGL.PointLight",__accessor:["intensity","distance"]}),n.SpotLight=function(e,r,i,s,o){n.Light.call(this,e),this._position=new n.Vec3(0,1,0),this.target=new n.Element,this.intensity=r!==t?r:1,this.distance=i!==t?i:0,this.angle=s!==t?s:Math.PI/2,this.exponent=o!==t?o:10,this.shadowCameraNear=100,this.shadowCameraFar=5e3,this.shadowCameraFov=50,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowMap=null,this.shadowMapSize=null,this.shadowCamera=null,this.shadowMatrix=null},n.extend(n.SpotLight,n.Light,{__accessor:["color","ambient","diffuse","specular","intensity","distance","angle","exponent"],constructor:n.SpotLight,className:"TGL.SpotLight"}),n.DirectionalLight=function(e,r,i){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var s=arguments[0];e=s.hex,r=s.intensity,i=s.id}n.Light.call(this,e,i),this.direction=new n.Vec3(0,1,0),this.position=new n.Vec3(0,1,0),this.target=new n.Element,this.intensity=r!==t?r:1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraRight=500,this.shadowCameraTop=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowCascade=!1,this.shadowCascadeOffset=new n.Vec3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0],this.shadowCascadeWidth=[512,512,512],this.shadowCascadeHeight=[512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[],this.shadowMap=null,this.shadowMapSize=null,this.shadowCamera=null,this.shadowMatrix=null},n.extend(n.DirectionalLight,n.Light,{className:"TGL.DirectionalLight",__accessor:["direction"]}),n.AmbientLight=function(e,t){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var r=arguments[0];e=r.hex,t=r.id}n.Light.call(this,e,t)},n.extend(n.AmbientLight,n.Light,{constructor:n.AmbientLight,className:"TGL.AmbientLight",clone:function(){var e=new n.AmbientLight;return n.Light.prototype.clone.call(this,e),e}}),n.Camera=function(){n.Element.call(this),this.projectionMatrix=new n.Mat4,this.projectionMatrixInverse=new n.Mat4,this.worldMatrixInverse=new n.Mat4,this.target=new n.Vec3,this.setPosition(0,0,500),this.lookat=this.lookAt},n.extend(n.Camera,n.Element,{constructor:n.Camera,updateCameraMatrix:function(e){var t=this.matrix.clone();this.matrix.lookAt(this._position,this.target,this.up),this.rotationAutoUpdate&&this._rotation.setEulerFromRotationMatrix(this.matrix),!t.equals(this.matrix)&&e&&this.firePropertyChange("matrix",t,this.matrix)},lookAt:function(e,n){arguments.length===3&&e.x===t?(e=new mono.Vec3(arguments[0],arguments[1],arguments[2]),n=t):arguments.length===4&&e.x===t&&(e=new mono.Vec3(arguments[0],arguments[1],arguments[2]),n=arguments[4]),n===t&&(n=!0),this.target=e,this.updateCameraMatrix(n)},look:function(e){arguments.length===3&&e.x===t&&(e=new mono.Vec3(arguments[0],arguments[1],arguments[2])),this.lookAt(e,!0)},onUpChanged:function(e,t){this.updateCameraMatrix()},getTarget:function(){return this.target},t:function(){return this.getTarget()},getDistance:function(){return(new f).subVectors(this._position,this.target).length()},setDistance:function(e){var t=this.getDistance();this.zoom(e/t)},lookAtElement:function(e,t,r){t instanceof f?(r=t,t=this.getDistance()):r=r||new f(0,0,1),e instanceof n.Element&&(t=t?t:this.getDistance(),this.setPosition(e.worldPosition(r,t)),this.look(e.getWorldPosition()))},zoomOut:function(e){this.zoom(1.1,e)},zoomIn:function(e){this.zoom(.9,e)},zoom:function(e,t){if(e>0){var n=t||this.getDistance();n*=e;var r=(new f).addVectors(this.target,(new f).subVectors(this._position,this.target).setLength(n));this.setPosition(r)}}}),n.OrthoCamera=function(e,t,r,i){n.Camera.call(this),this.width=e||1,this.aspect=t||1,this.near=r||.1,this.far=i||1e4,this.updateProjectionMatrix()},n.extend(n.OrthoCamera,n.Camera,{constructor:n.OrthoCamera,className:"TGL.OrthoCamera",__accessor:["width","aspect","near","far"],updateProjectionMatrix:function(){var e=this.getDistance(),t=e*this.width/2,n=-t,r=e/this.aspect*this.width/2,i=-r;this.projectionMatrix.makeOrthographic(n,t,r,i,this.near,this.far)},onPropertyChange:function(){this.updateProjectionMatrix()},updateCameraMatrix:function(e){n.Camera.prototype.updateCameraMatrix.call(this,e),this.updateProjectionMatrix()}}),n.PerspectiveCamera=function(e,r,i,s){n.Camera.call(this),this.fov=e!==t?e:50,this.aspect=r!==t?r:1,this.near=i!==t?i:1,this.far=s!==t?s:5e4,this.updateProjectionMatrix()},n.extend(n.PerspectiveCamera,n.Camera,{constructor:n.PerspectiveCamera,className:"TGL.PerspectiveCamera",__accessor:["fov","aspect","near","far"],updateProjectionMatrix:function(){this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)},onPropertyChange:function(){this.updateProjectionMatrix()}}),n.VRCamera=function(e,r,i){n.Camera.call(this),this.network=e,this.vrDisplay=e._vrDisplay,this.near=r!==t?r:.01,this.far=i!==t?i:1e4,this.orientation=[0,0,0,1],this.leftPm=new h,this.rightPm=new h,this.leftVm=new h,this.leftVmInverse=new h,this.rightVm=new h,this.rightVmInverse=new h,this.speed=.01,this.lockY=!1,this.updateProjectionMatrix()},n.extend(n.VRCamera,n.Camera,{constructor:n.VRCamera,className:"TGL.VRCamera",__accessor:["near","far","lockY","speed"],updateCameraMatrix:function(e){},updateMatrix:function(){},updateWorldMatrix:function(e,t){},updateProjectionMatrix:function(){function c(){u=null,a=null,l=null;var e=navigator.getGamepads();for(var t=0;t<e.length;t++){var n=e[t];n&&n.pose&&(n.hand==="right"?a=n:u=n,n.buttons.some(function(e,t){if(e.pressed)return l=n,!0}))}}var e=new h,t=new h,n=new h,r=new f,i=new h,s=new mono.Quat,o=new mono.Quat,u,a,l;return function(){var f=this,h=f.leftVm,p=f.rightVm,d=f.leftVmInverse,v=f.rightVmInverse,m=f.leftPm,g=f.rightPm,y=f._frameData,b=f.vrDisplay;if(!b)return;y||(y=f._frameData=new VRFrameData),b.getFrameData(y),c(),i.set(b.stageParameters.sittingToStandingTransform);if(l){var w;l.buttons.some(function(e,t){if(e.pressed)return w=t,!0});if(w===2){r.set(0,0,-f.speed),o.setFromRotationMatrix(i);var E=l.pose.orientation;s.set(E[0],E[1],E[2],E[3]),s.multiplyQuaternions(o,s),r.applyQuaternion(s),f.lockY&&r.setY(0),f.getPosition(!1).add(r)}}f.network.onGamepadChanged&&f.network.onGamepadChanged(u,a,l),e.identity(),e.setPosition(f.getPosition()),e.multiplyMatrices(e,i),t.getInverse(e),n.set(y.leftViewMatrix),d.multiplyMatrices(n,t),h.getInverse(d),n.set(y.rightViewMatrix),v.multiplyMatrices(n,t),p.getInverse(v),m.set(y.leftProjectionMatrix),g.set(y.rightProjectionMatrix)}}(),onPropertyChange:function(){this.updateProjectionMatrix()}}),n.CameraHelper=function(e){function c(e,t,n){h(e,n),h(t,n)}function h(e,i){r.vertices.push(new n.Vec3),r.colors.push(new n.Color(i)),s[e]===t&&(s[e]=[]),s[e].push(r.vertices.length-1)}var r=new n.Entity,i=new n.LineMaterial({color:16777215,vertexColors:n.FaceColors}),s={},o=16755200,u=16711680,a=43775,f=16777215,l=3355443;c("n1","n2",o),c("n2","n4",o),c("n4","n3",o),c("n3","n1",o),c("f1","f2",o),c("f2","f4",o),c("f4","f3",o),c("f3","f1",o),c("n1","f1",o),c("n2","f2",o),c("n3","f3",o),c("n4","f4",o),c("p","n1",u),c("p","n2",u),c("p","n3",u),c("p","n4",u),c("u1","u2",a),c("u2","u3",a),c("u3","u1",a),c("c","t",f),c("p","c",l),c("cn1","cn2",l),c("cn3","cn4",l),c("cf1","cf2",l),c("cf3","cf4",l),n.Line.call(this,r.vertices,r.colors,i,n.LinePieces),this.camera=e,this.worldMatrix=e.worldMatrix,this.matrixAutoUpdate=!1,this.pointMap=s,this.update()},n.CameraHelper.prototype=Object.create(n.Line.prototype),n.CameraHelper.prototype.update=function(){var e=new n.Vec3,r=new n.Camera,i=new n.Projector;return function(){function u(s,o,u,a){e.set(o,u,a),i.unprojectVector(e,r);var f=n.pointMap[s];if(f!==t)for(var l=0,c=f.length;l<c;l++)n.vertices[f[l]].copy(e)}var n=this,s=1,o=1;r.projectionMatrix.copy(this.camera.projectionMatrix),u("c",0,0,-1),u("t",0,0,1),u("n1",-s,-o,-1),u("n2",s,-o,-1),u("n3",-s,o,-1),u("n4",s,o,-1),u("f1",-s,-o,1),u("f2",s,-o,1),u("f3",-s,o,1),u("f4",s,o,1),u("u1",s*.7,o*1.1,-1),u("u2",-s*.7,o*1.1,-1),u("u3",0,o*2,-1),u("cf1",-s,0,1),u("cf2",s,0,1),u("cf3",0,-o,1),u("cf4",0,o,1),u("cn1",-s,0,-1),u("cn2",s,0,-1),u("cn3",0,-o,-1),u("cn4",0,o,-1),this.verticesNeedUpdate=!0}}();var oi=function(){n.Element.call(this)};oi.prototype=Object.create(n.Element.prototype),oi.prototype.updateworldMatrix=function(e){this.matrixAutoUpdate&&this.updateMatrix();if(this.worldMatrixNeedsUpdate||e)this._parent?(this.worldMatrix.multiplyMatrices(this._parent.worldMatrix,this.matrix),this.worldMatrix.decompose(this.translationWorld,this.QuatWorld,this.scaleWorld),this.matrix.decompose(this.translationObject,this.QuatObject,this.scaleObject),this.worldMatrix.compose(this.translationWorld,this.QuatObject,this.scaleWorld)):this.worldMatrix.copy(this.matrix),this.worldMatrixNeedsUpdate=!1,e=!0;for(var t=0,n=this.getChildren().size();t<n;t++)this.getChildren().get(t).updateworldMatrix(e)},oi.prototype.translationWorld=new n.Vec3,oi.prototype.translationObject=new n.Vec3,oi.prototype.QuatWorld=new n.Quat,oi.prototype.QuatObject=new n.Quat,oi.prototype.scaleWorld=new n.Vec3,oi.prototype.scaleObject=new n.Vec3;var ui=function(){function y(e,t){var r=new n.DirectionalLight;r.isVirtual=!0,r.onlyShadow=!0,r.castShadow=!0,r.shadowCameraNear=e.shadowCameraNear,r.shadowCameraFar=e.shadowCameraFar,r.shadowCameraLeft=e.shadowCameraLeft,r.shadowCameraRight=e.shadowCameraRight,r.shadowCameraBottom=e.shadowCameraBottom,r.shadowCameraTop=e.shadowCameraTop,r.shadowCameraVisible=e.shadowCameraVisible,r.shadowDarkness=e.shadowDarkness,r.shadowBias=e.shadowCascadeBias[t],r.shadowMapWidth=e.shadowCascadeWidth[t],r.shadowMapHeight=e.shadowCascadeHeight[t],r.pointsWorld=[],r.pointsFrustum=[];var i=r.pointsWorld,s=r.pointsFrustum;for(var o=0;o<8;o++)i[o]=new n.Vec3,s[o]=new n.Vec3;var u=e.shadowCascadeNearZ[t],a=e.shadowCascadeFarZ[t];return s[0].set(-1,-1,u),s[1].set(1,-1,u),s[2].set(-1,1,u),s[3].set(1,1,u),s[4].set(-1,-1,a),s[5].set(1,-1,a),s[6].set(-1,1,a),s[7].set(1,1,a),r}function b(e,t){var n=e.shadowCascadeArray[t];n.position.copy(e.position),n.target.position.copy(e.target.position),n.lookAt(n.target),n.shadowCameraVisible=e.shadowCameraVisible,n.shadowDarkness=e.shadowDarkness,n.shadowBias=e.shadowCascadeBias[t];var r=e.shadowCascadeNearZ[t],i=e.shadowCascadeFarZ[t],s=n.pointsFrustum;s[0].z=r,s[1].z=r,s[2].z=r,s[3].z=r,s[4].z=i,s[5].z=i,s[6].z=i,s[7].z=i}function w(e,t){var n=t.shadowCamera,r=t.pointsFrustum,i=t.pointsWorld;h.set(Infinity,Infinity,Infinity),p.set(-Infinity,-Infinity,-Infinity);for(var s=0;s<8;s++){var o=i[s];o.copy(r[s]),ui.__projector.unprojectVector(o,e),o.applyMatrix4(n.worldMatrixInverse),o.x<h.x&&(h.x=o.x),o.x>p.x&&(p.x=o.x),o.y<h.y&&(h.y=o.y),o.y>p.y&&(p.y=o.y),o.z<h.z&&(h.z=o.z),o.z>p.z&&(p.z=o.z)}n.left=h.x,n.right=p.x,n.top=p.y,n.bottom=h.y,n.updateProjectionMatrix()}function E(e){return e.material instanceof n.ArrayMaterial?e.material.materials[0]:e.material}var e,r,i,s,u,a,l=new n.Frustum,c=new n.Mat4,h=new n.Vec3,p=new n.Vec3,d=new n.Vec3;this.init=function(t){e=t._gl,r=t;var o=n.ShaderLib.depthRGBA,f=n.UniformsUtils.clone(o.uniforms);i=new ri({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:f}),_depthCubeMaterial=new ri({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:f,refreshUniformsCommon:function(e){this.uniforms.isCube.value=1,this.uniforms.nearDistance.value=this.nearDistance,this.uniforms.farDistance.value=this.farDistance,this.uniforms.referencePosition.value=this.referencePosition}}),s=new ri({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:f,morphTargets:!0}),u=new ri({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:f,skinning:!0}),a=new ri({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:f,morphTargets:!0,skinning:!0}),i._shadowPass=!0,s._shadowPass=!0,u._shadowPass=!0,a._shadowPass=!0};var v=[new mono.Vec3(1,0,0),new mono.Vec3(-1,0,0),new mono.Vec3(0,0,1),new mono.Vec3(0,0,-1),new mono.Vec3(0,1,0),new mono.Vec3(0,-1,0)],m=[new mono.Vec3(0,1,0),new mono.Vec3(0,1,0),new mono.Vec3(0,1,0),new mono.Vec3(0,1,0),new mono.Vec3(0,0,1),new mono.Vec3(0,0,-1)],g=[new mono.Vec4,new mono.Vec4,new mono.Vec4,new mono.Vec4,new mono.Vec4,new mono.Vec4];this.dirty=!0,this.dirtyShadowMap=function(){this.dirty=!0},this.render=function(e,t){if(!r._shadowMapEnable)return;this.update(e,t)},this.handleDataPropertyChange=function(e){var t=e.source,n=e.property;(t.isSizeChangedProperty&&t.isSizeChangedProperty(n)||n=="parent"||t.isSpaceChangedProperty(n))&&this.dirtyShadowMap()},this.handleDataBoxChange=function(e){this.dirtyShadowMap()},this.update=function(h,p){if(!this.dirty)return;this.dirty=!1;var S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j=[],F=0,I=null;e.clearColor(1,1,1,1),e.disable(e.BLEND),e.enable(e.CULL_FACE),e.frontFace(e.CCW),r.shadowMapCullFace===n.CullFaceFront?e.cullFace(e.FRONT):e.cullFace(e.BACK),r.setDepthTest(!0);var q=h.getLights();for(S=0,x=q.size();S<x;S++){H=q.get(S);if(!H.castShadow)continue;if(H instanceof n.DirectionalLight&&H.shadowCascade)for(C=0;C<H.shadowCascadeCount;C++){var R;if(!H.shadowCascadeArray[C]){R=y(H,C),R.originalCamera=p;var U=new oi;U.position=H.shadowCascadeOffset,U.add(R),U.add(R.target),p.add(U),H.shadowCascadeArray[C]=R}else R=H.shadowCascadeArray[C];b(H,C),j[F]=R,F++}else j[F]=H,F++}for(S=0,x=j.length;S<x;S++){H=j[S];var z=H instanceof n.PointLight,W=z?6:1;if(!H.shadowMap){var X=n.NearestFilter;r.shadowMapType===n.PCFSoftShadowMap&&(X=n.NearestFilter);var V={minFilter:X,magFilter:X,format:n.RGBAFormat},$=new mono.Vec2(H.shadowMapWidth,H.shadowMapHeight);if(z){var K=$.x,Q=$.y;g[0].set(K*2,Q,K,Q),g[1].set(0,Q,K,Q),g[2].set(K*3,Q,K,Q),g[3].set(K,Q,K,Q),g[4].set(K*3,0,K,Q),g[5].set(K,0,K,Q),$.x*=4,$.y*=2,H.shadowMap=new J($.x,$.y,V),H.shadowMapSize=new o($.x,$.y),H.shadowMatrix=new n.Mat4}else H.shadowMap=new J(H.shadowMapWidth,H.shadowMapHeight,V),H.shadowMapSize=new o(H.shadowMapWidth,H.shadowMapHeight),H.shadowMatrix=new n.Mat4}if(!H.shadowCamera){if(H instanceof n.SpotLight)H.shadowCamera=new n.PerspectiveCamera(H.shadowCameraFov,H.shadowMapWidth/H.shadowMapHeight,H.shadowCameraNear,H.shadowCameraFar);else if(H instanceof n.DirectionalLight)H.shadowCamera=new n.OrthoCamera(H.shadowCameraLeft,H.shadowMapWidth/H.shadowMapHeight,H.shadowCameraNear,H.shadowCameraFar);else{if(!(H instanceof n.PointLight)){console.error("Unsupported light type for shadow");continue}H.shadowCamera=new n.PerspectiveCamera(90,1,H.shadowCameraNear,H.shadowCameraFar)}H.shadowCamera.updateWorldMatrix();var G=h.getRoots(),Y=G.size(),Z;for(var et=0;et<Y;et++)Z=G.get(et),Z.updateWorldMatrix()}H.shadowCameraVisible&&!H.cameraHelper&&(H.cameraHelper=new n.CameraHelper(H.shadowCamera),H.shadowCamera.addChild(H.cameraHelper),H.shadowCamera.updateWorldMatrix(!0),r.helperBox.add(H.shadowCamera),r.helperBox.add(H.cameraHelper)),H.isVirtual&&R.originalCamera==p&&w(p,H);var tt=[new f(1,0,0),new f(-1,0,0),new f(0,1,0),new f(0,-1,0),new f(0,0,1),new f(0,0,-1)];k=H.shadowMap,L=H.shadowMatrix,A=H.shadowCamera,r.debugPointLight==t&&r.setRenderTarget(k),r.clear();for(var F=0;F<W;F++){if(H.debugFace!=null&&F!=H.debugFace)continue;A._position.setFromMatrixPosition(H.worldMatrix),H.target?(d.setFromMatrixPosition(H.target.worldMatrix),A.lookAt(d),A.updateWorldMatrix(!0)):d=A.p().clone().add(v[F]),A.worldMatrixInverse.getInverse(A.worldMatrix),H.cameraHelper&&(H.cameraHelper.visible=H.shadowCameraVisible),H.shadowCameraVisible&&H.cameraHelper.update();if(z){L.translate(A._position.clone().negate()),A.setUp(m[F]),A.lookAt(d),A.updateWorldMatrix(!0),A.setNear(H.shadowCameraNear),A.setFar(H.shadowCameraFar),_depthCubeMaterial.nearDistance=H.shadowCameraNear,_depthCubeMaterial.farDistance=H.shadowCameraFar,_depthCubeMaterial.referencePosition=A._position.clone();var nt=g[F];A.worldMatrixInverse.getInverse(A.worldMatrix),r.setViewport(nt.x,nt.y,nt.z,nt.w)}else L.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),L.multiply(A.projectionMatrix),L.multiply(A.worldMatrixInverse);c.multiplyMatrices(A.projectionMatrix,A.worldMatrixInverse),l.setFromMatrix(c),B=r.glNodeList
;for(T=0,N=B.length;T<N;T++)D=B[T],P=D.node,D.render=!1,P._visible&&P.castShadow&&(!(P instanceof n.Node||P instanceof n.Particle)||!P.frustumCulled||l.intersectsObject(P))&&(P._modelViewMatrix.multiplyMatrices(A.worldMatrixInverse,P.worldMatrix),D.render=!0);var rt,it,st;for(T=0,N=B.length;T<N;T++)D=B[T],D.render&&(P=D.node,M=D.group,rt=E(P),it=!1,st=!1,P.customDepthMaterial?_=P.customDepthMaterial:st?_=it?a:u:it?_=s:W==1?_=i:_=_depthCubeMaterial,P instanceof n.BufferNode||r.renderGroup(A,h.getLights(),_,M,P))}}var ot=r.getClearColor(),ut=r.getClearAlpha();e.clearColor(ot.r,ot.g,ot.b,ut),e.enable(e.BLEND),r.shadowMapCullFace===n.CullFaceFront&&e.cullFace(e.BACK)}};ui.__projector=new n.Projector,n.Picking=function(e,t,r,i,s,o){this.network=o,this.origin=e,this.cameraUp=r,this.direction=t,this.near=i||0,this.far=s||Infinity,this.ray=new n.Ray(e,t),this.ray.direction.length>0&&this.ray.direction.normalize()},n.Picking.testPlane=new n.Plane(1,1),n.Picking.prototype={constructor:n.Picking,precision:1e-4,linePrecision:2,matrixPosition:new n.Vec3,set:function(e,t){this.origin=e,this.direction=t,this.ray.set(e,t),this.ray.direction.length>0&&this.ray.direction.normalize()},intersectObject:function(e,t,n){var r=[];return t===!0&&vi(e,this,r,n),di(e,this,r,n),r.sort(pi),r},intersectObjects:function(e,t,n){e._as&&(e=e._as);var r=[];for(var i=0,s=e.length;i<s;i++)di(e[i],this,r,n,this.network),t===!0&&vi(e[i],this,r,n,this.network);return r.sort(pi),r}};var ai=new n.Ray,fi=new n.Mat4,li=new n.math.Plane,ci=new n.Vec3,hi=new n.BoundingSphere,gi=function(e){arguments.length>0&&this.init(e)};gi.prototype.init=function(e){this.status=e,this.points=new Array},gi.prototype.appendPoint=function(e){this.points.push(e)},gi.prototype.appendPoints=function(e){this.points=this.points.concat(e)},gi.intersectShapes=function(e,t){var n=e.getIntersectionParams(),r=t.getIntersectionParams(),i;if(n!=null&&r!=null)if(n.name=="Path")i=gi.intersectPathShape(e,t);else if(r.name=="Path")i=gi.intersectPathShape(t,e);else{var s,o;n.name<r.name?(s="intersect"+n.name+r.name,o=n.params.concat(r.params)):(s="intersect"+r.name+n.name,o=r.params.concat(n.params));if(!(s in gi))throw new Error("Intersection not available: "+s);i=gi[s].apply(null,o)}else i=new gi("No Intersection");return i},gi.intersectPathShape=function(e,t){return e.intersectShape(t)},gi.intersectBezier2Bezier2=function(e,t,n,r,i,s){var u,a,f,l,c,h,p,d,v=new gi("No Intersection"),m;u=t.multiply(-2),f=e.add(u.add(n)),u=e.multiply(-2),a=t.multiply(2),l=u.add(a),c=new o(e.x,e.y),u=i.multiply(-2),h=r.add(u.add(s)),u=r.multiply(-2),a=i.multiply(2),p=u.add(a),d=new o(r.x,r.y);if(f.y==0){var g=f.x*(c.y-d.y),y=g-l.x*l.y,b=g+y,w=l.y*l.y;m=new Polynomial(f.x*h.y*h.y,2*f.x*p.y*h.y,f.x*p.y*p.y-h.x*w-h.y*g-h.y*y,-p.x*w-p.y*g-p.y*y,(c.x-d.x)*w+(c.y-d.y)*y)}else{var g=f.x*h.y-f.y*h.x,y=f.x*p.y-p.x*f.y,b=l.x*f.y-l.y*f.x,w=c.y-d.y,E=f.y*(c.x-d.x)-f.x*w,S=-l.y*b+f.y*E,x=b*b;m=new Polynomial(g*g,2*g*y,(-h.y*x+f.y*y*y+f.y*g*E+g*S)/f.y,(-p.y*x+f.y*y*E+y*S)/f.y,(w*x+E*S)/f.y)}var T=m.getRoots();for(var N=0;N<T.length;N++){var C=T[N];if(0<=C&&C<=1){var k=(new Polynomial(f.x,l.x,c.x-d.x-C*p.x-C*C*h.x)).getRoots(),L=(new Polynomial(f.y,l.y,c.y-d.y-C*p.y-C*C*h.y)).getRoots();if(k.length>0&&L.length>0){var A=1e-4;e:for(var O=0;O<k.length;O++){var M=k[O];if(0<=M&&M<=1)for(var _=0;_<L.length;_++)if(Math.abs(M-L[_])<A){v.points.push(h.multiply(C*C).add(p.multiply(C).add(d)));break e}}}}}return v.points.length>0&&(v.status="$Intersection"),v},gi.intersectBezier2Bezier3=function(e,t,n,r,i,s,u){var a,f,l,c,h,p,d,v,m,g,y,b=new gi("No Intersection");a=t.multiply(-2),h=e.add(a.add(n)),a=e.multiply(-2),f=t.multiply(2),p=a.add(f),d=new o(e.x,e.y),a=r.multiply(-1),f=i.multiply(3),l=s.multiply(-3),c=a.add(f.add(l.add(u))),v=new Vector2D(c.x,c.y),a=r.multiply(3),f=i.multiply(-6),l=s.multiply(3),c=a.add(f.add(l)),m=new Vector2D(c.x,c.y),a=r.multiply(-3),f=i.multiply(3),l=a.add(f),g=new Vector2D(l.x,l.y),y=new Vector2D(r.x,r.y);var w=d.x*d.x,E=d.y*d.y,S=p.x*p.x,x=p.y*p.y,T=h.x*h.x,N=h.y*h.y,C=y.x*y.x,k=y.y*y.y,L=g.x*g.x,A=g.y*g.y,O=m.x*m.x,M=m.y*m.y,_=v.x*v.x,D=v.y*v.y,P=new Polynomial(-2*h.x*h.y*v.x*v.y+T*D+N*_,-2*h.x*h.y*m.x*v.y-2*h.x*h.y*m.y*v.x+2*N*m.x*v.x+2*T*m.y*v.y,-2*h.x*g.x*h.y*v.y-2*h.x*h.y*g.y*v.x-2*h.x*h.y*m.x*m.y+2*g.x*N*v.x+N*O+T*(2*g.y*v.y+M),2*d.x*h.x*h.y*v.y+2*d.y*h.x*h.y*v.x+p.x*p.y*h.x*v.y+p.x*p.y*h.y*v.x-2*y.x*h.x*h.y*v.y-2*h.x*y.y*h.y*v.x-2*h.x*g.x*h.y*m.y-2*h.x*h.y*g.y*m.x-2*d.x*N*v.x-2*d.y*T*v.y+2*y.x*N*v.x+2*g.x*N*m.x-x*h.x*v.x-S*h.y*v.y+T*(2*y.y*v.y+2*g.y*m.y),2*d.x*h.x*h.y*m.y+2*d.y*h.x*h.y*m.x+p.x*p.y*h.x*m.y+p.x*p.y*h.y*m.x-2*y.x*h.x*h.y*m.y-2*h.x*y.y*h.y*m.x-2*h.x*g.x*h.y*g.y-2*d.x*N*m.x-2*d.y*T*m.y+2*y.x*N*m.x-x*h.x*m.x-S*h.y*m.y+L*N+T*(2*y.y*m.y+A),2*d.x*h.x*h.y*g.y+2*d.y*h.x*g.x*h.y+p.x*p.y*h.x*g.y+p.x*p.y*g.x*h.y-2*y.x*h.x*h.y*g.y-2*h.x*y.y*g.x*h.y-2*d.x*g.x*N-2*d.y*T*g.y+2*y.x*g.x*N-x*h.x*g.x-S*h.y*g.y+2*T*y.y*g.y,-2*d.x*d.y*h.x*h.y-d.x*p.x*p.y*h.y-d.y*p.x*p.y*h.x+2*d.x*h.x*y.y*h.y+2*d.y*y.x*h.x*h.y+p.x*y.x*p.y*h.y+p.x*p.y*h.x*y.y-2*y.x*h.x*y.y*h.y-2*d.x*y.x*N+d.x*x*h.x+d.y*S*h.y-2*d.y*T*y.y-y.x*x*h.x-S*y.y*h.y+w*N+E*T+C*N+T*k),H=P.getRootsInInterval(0,1);for(var B=0;B<H.length;B++){var j=H[B],F=(new Polynomial(h.x,p.x,d.x-y.x-j*g.x-j*j*m.x-j*j*j*v.x)).getRoots(),I=(new Polynomial(h.y,p.y,d.y-y.y-j*g.y-j*j*m.y-j*j*j*v.y)).getRoots();if(F.length>0&&I.length>0){var q=1e-4;e:for(var R=0;R<F.length;R++){var U=F[R];if(0<=U&&U<=1)for(var z=0;z<I.length;z++)if(Math.abs(U-I[z])<q){b.points.push(v.multiply(j*j*j).add(m.multiply(j*j).add(g.multiply(j).add(y))));break e}}}}return b.points.length>0&&(b.status="Intersection"),b},gi.intersectBezier2Circle=function(e,t,n,r,i){return gi.intersectBezier2Ellipse(e,t,n,r,i,i)},gi.intersectBezier2Ellipse=function(e,t,n,r,i,s){var u,a,f,l,c,h=new gi("No Intersection");u=t.multiply(-2),f=e.add(u.add(n)),u=e.multiply(-2),a=t.multiply(2),l=u.add(a),c=new o(e.x,e.y);var p=i*i,d=s*s,v=(new Polynomial(d*f.x*f.x+p*f.y*f.y,2*(d*f.x*l.x+p*f.y*l.y),d*(2*f.x*c.x+l.x*l.x)+p*(2*f.y*c.y+l.y*l.y)-2*(d*r.x*f.x+p*r.y*f.y),2*(d*l.x*(c.x-r.x)+p*l.y*(c.y-r.y)),d*(c.x*c.x+r.x*r.x)+p*(c.y*c.y+r.y*r.y)-2*(d*r.x*c.x+p*r.y*c.y)-p*d)).getRoots();for(var m=0;m<v.length;m++){var g=v[m];0<=g&&g<=1&&h.points.push(f.multiply(g*g).add(l.multiply(g).add(c)))}return h.points.length>0&&(h.status="Intersection"),h},gi.intersectBezier2Line=function(e,t,n,r,i){var s,u,a,f,l,c,h,p=r.min(i),d=r.max(i),v=new gi("No Intersection");s=t.multiply(-2),a=e.add(s.add(n)),s=e.multiply(-2),u=t.multiply(2),f=s.add(u),l=new o(e.x,e.y),h=new Vector2D(r.y-i.y,i.x-r.x),c=r.x*i.y-i.x*r.y,roots=(new Polynomial(h.dot(a),h.dot(f),h.dot(l)+c)).getRoots();for(var m=0;m<roots.length;m++){var g=roots[m];if(0<=g&&g<=1){var y=e.lerp(t,g),b=t.lerp(n,g),w=y.lerp(b,g);r.x==i.x?p.y<=w.y&&w.y<=d.y&&(v.status="Intersection",v.appendPoint(w)):r.y==i.y?p.x<=w.x&&w.x<=d.x&&(v.status="Intersection",v.appendPoint(w)):w.gte(p)&&w.lte(d)&&(v.status="Intersection",v.appendPoint(w))}}return v},gi.intersectBezier2Polygon=function(e,t,n,r){var i=new gi("No Intersection"),s=r.length;for(var o=0;o<s;o++){var u=r[o],a=r[(o+1)%s],f=gi.intersectBezier2Line(e,t,n,u,a);i.appendPoints(f.points)}return i.points.length>0&&(i.status="Intersection"),i},gi.intersectBezier2Rectangle=function(e,t,n,r,i){var s=r.min(i),u=r.max(i),a=new o(u.x,s.y),f=new o(s.x,u.y),l=gi.intersectBezier2Line(e,t,n,s,a),c=gi.intersectBezier2Line(e,t,n,a,u),h=gi.intersectBezier2Line(e,t,n,u,f),p=gi.intersectBezier2Line(e,t,n,f,s),d=new gi("No Intersection");return d.appendPoints(l.points),d.appendPoints(c.points),d.appendPoints(h.points),d.appendPoints(p.points),d.points.length>0&&(d.status="Intersection"),d},gi.intersectBezier3Bezier3=function(e,t,n,r,i,s,o,u){var a,f,l,c,h,p,d,v,m,g,y,b,w=new gi("No Intersection");a=e.multiply(-1),f=t.multiply(3),l=n.multiply(-3),c=a.add(f.add(l.add(r))),h=new Vector2D(c.x,c.y),a=e.multiply(3),f=t.multiply(-6),l=n.multiply(3),c=a.add(f.add(l)),p=new Vector2D(c.x,c.y),a=e.multiply(-3),f=t.multiply(3),l=a.add(f),d=new Vector2D(l.x,l.y),v=new Vector2D(e.x,e.y),a=i.multiply(-1),f=s.multiply(3),l=o.multiply(-3),c=a.add(f.add(l.add(u))),m=new Vector2D(c.x,c.y),a=i.multiply(3),f=s.multiply(-6),l=o.multiply(3),c=a.add(f.add(l)),g=new Vector2D(c.x,c.y),a=i.multiply(-3),f=s.multiply(3),l=a.add(f),y=new Vector2D(l.x,l.y),b=new Vector2D(i.x,i.y);var E=v.x*v.x,S=v.x*v.x*v.x,x=v.y*v.y,T=v.y*v.y*v.y,N=d.x*d.x,C=d.x*d.x*d.x,k=d.y*d.y,L=d.y*d.y*d.y,A=p.x*p.x,O=p.x*p.x*p.x,M=p.y*p.y,_=p.y*p.y*p.y,D=h.x*h.x,P=h.x*h.x*h.x,H=h.y*h.y,B=h.y*h.y*h.y,j=b.x*b.x,F=b.x*b.x*b.x,I=b.y*b.y,q=b.y*b.y*b.y,R=y.x*y.x,U=y.x*y.x*y.x,z=y.y*y.y,W=g.x*g.x,X=g.x*g.x*g.x,V=g.y*g.y,$=m.x*m.x,J=m.x*m.x*m.x,K=m.y*m.y,Q=m.y*m.y*m.y,G=new Polynomial(-P*Q+B*J-3*h.x*H*$*m.y+3*D*h.y*m.x*K,-6*h.x*g.x*H*m.x*m.y+6*D*h.y*g.y*m.x*m.y+3*g.x*B*$-3*P*g.y*K-3*h.x*H*g.y*$+3*D*g.x*h.y*K,-6*y.x*h.x*H*m.x*m.y-6*h.x*g.x*H*g.y*m.x+6*D*g.x*h.y*g.y*m.y+3*y.x*B*$+3*W*B*m.x+3*y.x*D*h.y*K-3*h.x*y.y*H*$-3*h.x*W*H*m.y+D*h.y*m.x*(6*y.y*m.y+3*V)+P*(-y.y*K-2*V*m.y-m.y*(2*y.y*m.y+V)),d.x*p.y*h.x*h.y*m.x*m.y-d.y*p.x*h.x*h.y*m.x*m.y+6*y.x*g.x*B*m.x+3*d.x*p.x*h.x*h.y*K+6*v.x*h.x*H*m.x*m.y-3*d.x*p.x*H*m.x*m.y-3*d.y*p.y*h.x*h.y*$-6*v.y*D*h.y*m.x*m.y-6*b.x*h.x*H*m.x*m.y+3*d.y*p.y*D*m.x*m.y-2*p.x*M*h.x*m.x*m.y-6*y.x*h.x*g.x*H*m.y-6*y.x*h.x*H*g.y*m.x-6*h.x*y.y*g.x*H*m.x+6*y.x*D*h.y*g.y*m.y+2*A*p.y*h.y*m.x*m.y+X*B-3*v.x*B*$+3*v.y*P*K+3*b.x*B*$+_*h.x*$-O*h.y*K-3*v.x*D*h.y*K+3*v.y*h.x*H*$-2*d.x*p.y*D*K+d.x*p.y*H*$-d.y*p.x*D*K+2*d.y*p.x*H*$+3*b.x*D*h.y*K-p.x*M*h.y*$-3*b.y*h.x*H*$+A*p.y*h.x*K-3*h.x*W*H*g.y+D*h.y*m.x*(6*b.y*m.y+6*y.y*g.y)+D*g.x*h.y*(6*y.y*m.y+3*V)+P*(-2*y.y*g.y*m.y-b.y*K-g.y*(2*y.y*m.y+V)-m.y*(2*b.y*m.y+2*y.y*g.y)),6*d.x*p.x*h.x*h.y*g.y*m.y+d.x*p.y*h.x*g.x*h.y*m.y+d.x*p.y*h.x*h.y*g.y*m.x-d.y*p.x*h.x*g.x*h.y*m.y-d.y*p.x*h.x*h.y*g.y*m.x-6*d.y*p.y*h.x*g.x*h.y*m.x-6*v.x*g.x*B*m.x+6*b.x*g.x*B*m.x+6*v.y*P*g.y*m.y+2*_*h.x*g.x*m.x-2*O*h.y*g.y*m.y+6*v.x*h.x*g.x*H*m.y+6*v.x*h.x*H*g.y*m.x+6*v.y*h.x*g.x*H*m.x-3*d.x*p.x*g.x*H*m.y-3*d.x*p.x*H*g.y*m.x+2*d.x*p.y*g.x*H*m.x+4*d.y*p.x*g.x*H*m.x-6*v.x*D*h.y*g.y*m.y-6*v.y*D*g.x*h.y*m.y-6*v.y*D*h.y*g.y*m.x-4*d.x*p.y*D*g.y*m.y-6*b.x*h.x*g.x*H*m.y-6*b.x*h.x*H*g.y*m.x-2*d.y*p.x*D*g.y*m.y+3*d.y*p.y*D*g.x*m.y+3*d.y*p.y*D*g.y*m.x-2*p.x*M*h.x*g.x*m.y-2*p.x*M*h.x*g.y*m.x-2*p.x*M*g.x*h.y*m.x-6*b.y*h.x*g.x*H*m.x-6*y.x*h.x*y.y*H*m.x-6*y.x*h.x*g.x*H*g.y+6*b.x*D*h.y*g.y*m.y+2*A*p.y*h.x*g.y*m.y+2*A*p.y*g.x*h.y*m.y+2*A*p.y*h.y*g.y*m.x+3*y.x*W*B+3*R*B*m.x-3*h.x*y.y*W*H-3*R*h.x*H*m.y+D*g.x*h.y*(6*b.y*m.y+6*y.y*g.y)+D*h.y*m.x*(6*b.y*g.y+3*z)+y.x*D*h.y*(6*y.y*m.y+3*V)+P*(-2*b.y*g.y*m.y-m.y*(2*b.y*g.y+z)-y.y*(2*y.y*m.y+V)-g.y*(2*b.y*m.y+2*y.y*g.y)),d.x*y.x*p.y*h.x*h.y*m.y+d.x*p.y*h.x*y.y*h.y*m.x+d.x*p.y*h.x*g.x*h.y*g.y-d.y*p.x*y.x*h.x*h.y*m.y-d.y*p.x*h.x*y.y*h.y*m.x-d.y*p.x*h.x*g.x*h.y*g.y-6*d.y*y.x*p.y*h.x*h.y*m.x-6*v.x*y.x*B*m.x+6*b.x*y.x*B*m.x+2*y.x*_*h.x*m.x+6*v.x*y.x*h.x*H*m.y+6*v.x*h.x*y.y*H*m.x+6*v.x*h.x*g.x*H*g.y+6*v.y*y.x*h.x*H*m.x-3*d.x*p.x*y.x*H*m.y-3*d.x*p.x*y.y*H*m.x-3*d.x*p.x*g.x*H*g.y+2*d.x*y.x*p.y*H*m.x+4*d.y*p.x*y.x*H*m.x-6*v.y*y.x*D*h.y*m.y-6*v.y*D*y.y*h.y*m.x-6*v.y*D*g.x*h.y*g.y-6*b.x*y.x*h.x*H*m.y-6*b.x*h.x*y.y*H*m.x-6*b.x*h.x*g.x*H*g.y+3*d.y*y.x*p.y*D*m.y-3*d.y*p.y*h.x*W*h.y+3*d.y*p.y*D*y.y*m.x+3*d.y*p.y*D*g.x*g.y-2*p.x*y.x*M*h.x*m.y-2*p.x*y.x*M*h.y*m.x-2*p.x*M*h.x*y.y*m.x-2*p.x*M*h.x*g.x*g.y-6*b.y*y.x*h.x*H*m.x-6*y.x*h.x*y.y*g.x*H+6*b.y*D*y.y*h.y*m.x+2*A*y.x*p.y*h.y*m.y+2*A*p.y*y.y*h.y*m.x+2*A*p.y*g.x*h.y*g.y-3*v.x*W*B+3*b.x*W*B+3*R*g.x*B+_*h.x*W+3*v.y*h.x*W*H+d.x*p.y*W*H+2*d.y*p.x*W*H-p.x*M*W*h.y-3*b.y*h.x*W*H-3*R*h.x*H*g.y+A*p.y*h.x*(2*y.y*m.y+V)+d.x*p.x*h.x*h.y*(6*y.y*m.y+3*V)+y.x*D*h.y*(6*b.y*m.y+6*y.y*g.y)+O*h.y*(-2*y.y*m.y-V)+v.y*P*(6*y.y*m.y+3*V)+d.y*p.x*D*(-2*y.y*m.y-V)+d.x*p.y*D*(-4*y.y*m.y-2*V)+v.x*D*h.y*(-6*y.y*m.y-3*V)+D*g.x*h.y*(6*b.y*g.y+3*z)+b.x*D*h.y*(6*y.y*m.y+3*V)+P*(-2*b.y*y.y*m.y-g.y*(2*b.y*g.y+z)-b.y*(2*y.y*m.y+V)-y.y*(2*b.y*m.y+2*y.y*g.y)),-v.x*d.x*p.y*h.x*h.y*m.y+v.x*d.y*p.x*h.x*h.y*m.y+6*v.x*d.y*p.y*h.x*h.y*m.x-6*v.y*d.x*p.x*h.x*h.y*m.y-v.y*d.x*p.y*h.x*h.y*m.x+v.y*d.y*p.x*h.x*h.y*m.x+d.x*d.y*p.x*p.y*h.x*m.y-d.x*d.y*p.x*p.y*h.y*m.x+d.x*b.x*p.y*h.x*h.y*m.y+d.x*b.y*p.y*h.x*h.y*m.x+d.x*y.x*p.y*h.x*h.y*g.y+d.x*p.y*h.x*y.y*g.x*h.y-b.x*d.y*p.x*h.x*h.y*m.y-6*b.x*d.y*p.y*h.x*h.y*m.x-d.y*p.x*b.y*h.x*h.y*m.x-d.y*p.x*y.x*h.x*h.y*g.y-d.y*p.x*h.x*y.y*g.x*h.y-6*d.y*y.x*p.y*h.x*g.x*h.y-6*v.x*b.x*B*m.x-6*v.x*y.x*g.x*B-2*v.x*_*h.x*m.x+6*b.x*y.x*g.x*B+2*b.x*_*h.x*m.x+2*y.x*_*h.x*g.x+2*v.y*O*h.y*m.y-6*v.x*v.y*h.x*H*m.x+3*v.x*d.x*p.x*H*m.y-2*v.x*d.x*p.y*H*m.x-4*v.x*d.y*p.x*H*m.x+3*v.y*d.x*p.x*H*m.x+6*v.x*v.y*D*h.y*m.y+6*v.x*b.x*h.x*H*m.y-3*v.x*d.y*p.y*D*m.y+2*v.x*p.x*M*h.x*m.y+2*v.x*p.x*M*h.y*m.x+6*v.x*b.y*h.x*H*m.x+6*v.x*y.x*h.x*H*g.y+6*v.x*h.x*y.y*g.x*H+4*v.y*d.x*p.y*D*m.y+6*v.y*b.x*h.x*H*m.x+2*v.y*d.y*p.x*D*m.y-3*v.y*d.y*p.y*D*m.x+2*v.y*p.x*M*h.x*m.x+6*v.y*y.x*h.x*g.x*H-3*d.x*b.x*p.x*H*m.y+2*d.x*b.x*p.y*H*m.x+d.x*d.y*M*h.x*m.x-3*d.x*p.x*b.y*H*m.x-3*d.x*p.x*y.x*H*g.y-3*d.x*p.x*y.y*g.x*H+2*d.x*y.x*p.y*g.x*H+4*b.x*d.y*p.x*H*m.x+4*d.y*p.x*y.x*g.x*H-2*v.x*A*p.y*h.y*m.y-6*v.y*b.x*D*h.y*m.y-6*v.y*b.y*D*h.y*m.x-6*v.y*y.x*D*h.y*g.y-2*v.y*A*p.y*h.x*m.y-2*v.y*A*p.y*h.y*m.x-6*v.y*D*y.y*g.x*h.y-d.x*d.y*A*h.y*m.y-2*d.x*k*h.x*h.y*m.x+3*b.x*d.y*p.y*D*m.y-2*b.x*p.x*M*h.x*m.y-2*b.x*p.x*M*h.y*m.x-6*b.x*b.y*h.x*H*m.x-6*b.x*y.x*h.x*H*g.y-6*b.x*h.x*y.y*g.x*H+3*d.y*b.y*p.y*D*m.x+3*d.y*y.x*p.y*D*g.y+3*d.y*p.y*D*y.y*g.x-2*p.x*b.y*M*h.x*m.x-2*p.x*y.x*M*h.x*g.y-2*p.x*y.x*M*g.x*h.y-2*p.x*M*h.x*y.y*g.x-6*b.y*y.x*h.x*g.x*H-k*p.x*p.y*h.x*m.x+2*b.x*A*p.y*h.y*m.y+6*b.y*D*y.y*g.x*h.y+2*N*d.y*h.x*h.y*m.y+N*p.x*p.y*h.y*m.y+2*A*b.y*p.y*h.y*m.x+2*A*y.x*p.y*h.y*g.y+2*A*p.y*y.y*g.x*h.y+U*B+3*E*B*m.x-3*x*P*m.y+3*j*B*m.x+L*D*m.x-C*H*m.y-d.x*k*D*m.y+N*d.y*H*m.x-3*E*h.x*H*m.y+3*x*D*h.y*m.x-N*M*h.x*m.y+k*A*h.y*m.x-3*R*h.x*y.y*H-3*j*h.x*H*m.y+3*I*D*h.y*m.x+d.x*p.x*h.x*h.y*(6*b.y*m.y+6*y.y*g.y)+O*h.y*(-2*b.y*m.y-2*y.y*g.y)+v.y*P*(6*b.y*m.y+6*y.y*g.y)+d.y*p.x*D*(-2*b.y*m.y-2*y.y*g.y)+A*p.y*h.x*(2*b.y*m.y+2*y.y*g.y)+d.x*p.y*D*(-4*b.y*m.y-4*y.y*g.y)+v.x*D*h.y*(-6*b.y*m.y-6*y.y*g.y)+b.x*D*h.y*(6*b.y*m.y+6*y.y*g.y)+y.x*D*h.y*(6*b.y*g.y+3*z)+P*(-2*b.y*y.y*g.y-I*m.y-y.y*(2*b.y*g.y+z)-b.y*(2*b.y*m.y+2*y.y*g.y)),-v.x*d.x*p.y*h.x*h.y*g.y+v.x*d.y*p.x*h.x*h.y*g.y+6*v.x*d.y*p.y*h.x*g.x*h.y-6*v.y*d.x*p.x*h.x*h.y*g.y-v.y*d.x*p.y*h.x*g.x*h.y+v.y*d.y*p.x*h.x*g.x*h.y+d.x*d.y*p.x*p.y*h.x*g.y-d.x*d.y*p.x*p.y*g.x*h.y+d.x*b.x*p.y*h.x*h.y*g.y+d.x*b.y*p.y*h.x*g.x*h.y+d.x*y.x*p.y*h.x*y.y*h.y-b.x*d.y*p.x*h.x*h.y*g.y-6*b.x*d.y*p.y*h.x*g.x*h.y-d.y*p.x*b.y*h.x*g.x*h.y-d.y*p.x*y.x*h.x*y.y*h.y-6*v.x*b.x*g.x*B-2*v.x*_*h.x*g.x+2*b.x*_*h.x*g.x+2*v.y*O*h.y*g.y-6*v.x*v.y*h.x*g.x*H+3*v.x*d.x*p.x*H*g.y-2*v.x*d.x*p.y*g.x*H-4*v.x*d.y*p.x*g.x*H+3*v.y*d.x*p.x*g.x*H+6*v.x*v.y*D*h.y*g.y+6*v.x*b.x*h.x*H*g.y-3*v.x*d.y*p.y*D*g.y+2*v.x*p.x*M*h.x*g.y+2*v.x*p.x*M*g.x*h.y+6*v.x*b.y*h.x*g.x*H+6*v.x*y.x*h.x*y.y*H+4*v.y*d.x*p.y*D*g.y+6*v.y*b.x*h.x*g.x*H+2*v.y*d.y*p.x*D*g.y-3*v.y*d.y*p.y*D*g.x+2*v.y*p.x*M*h.x*g.x-3*d.x*b.x*p.x*H*g.y+2*d.x*b.x*p.y*g.x*H+d.x*d.y*M*h.x*g.x-3*d.x*p.x*b.y*g.x*H-3*d.x*p.x*y.x*y.y*H+4*b.x*d.y*p.x*g.x*H-2*v.x*A*p.y*h.y*g.y-6*v.y*b.x*D*h.y*g.y-6*v.y*b.y*D*g.x*h.y-6*v.y*y.x*D*y.y*h.y-2*v.y*A*p.y*h.x*g.y-2*v.y*A*p.y*g.x*h.y-d.x*d.y*A*h.y*g.y-2*d.x*k*h.x*g.x*h.y+3*b.x*d.y*p.y*D*g.y-2*b.x*p.x*M*h.x*g.y-2*b.x*p.x*M*g.x*h.y-6*b.x*b.y*h.x*g.x*H-6*b.x*y.x*h.x*y.y*H+3*d.y*b.y*p.y*D*g.x+3*d.y*y.x*p.y*D*y.y-2*p.x*b.y*M*h.x*g.x-2*p.x*y.x*M*h.x*y.y-k*p.x*p.y*h.x*g.x+2*b.x*A*p.y*h.y*g.y-3*d.y*R*p.y*h.x*h.y+6*b.y*y.x*D*y.y*h.y+2*N*d.y*h.x*h.y*g.y+N*p.x*p.y*h.y*g.y+2*A*b.y*p.y*g.x*h.y+2*A*y.x*p.y*y.y*h.y-3*v.x*R*B+3*b.x*R*B+3*E*g.x*B-3*x*P*g.y+3*j*g.x*B+R*_*h.x+L*D*g.x-C*H*g.y+3*v.y*R*h.x*H-d.x*k*D*g.y+d.x*R*p.y*H+2*d.y*p.x*R*H+N*d.y*g.x*H-p.x*R*M*h.y-3*b.y*R*h.x*H-3*E*h.x*H*g.y+3*x*D*g.x*h.y-N*M*h.x*g.y+k*A*g.x*h.y-3*j*h.x*H*g.y+3*I*D*g.x*h.y+A*p.y*h.x*(2*b.y*g.y+z)+d.x*p.x*h.x*h.y*(6*b.y*g.y+3*z)+O*h.y*(-2*b.y*g.y-z)+v.y*P*(6*b.y*g.y+3*z)+d.y*p.x*D*(-2*b.y*g.y-z)+d.x*p.y*D*(-4*b.y*g.y-2*z)+v.x*D*h.y*(-6*b.y*g.y-3*z)+b.x*D*h.y*(6*b.y*g.y+3*z)+P*(-2*b.y*z-I*g.y-b.y*(2*b.y*g.y+z)),-v.x*d.x*p.y*h.x*y.y*h.y+v.x*d.y*p.x*h.x*y.y*h.y+6*v.x*d.y*y.x*p.y*h.x*h.y-6*v.y*d.x*p.x*h.x*y.y*h.y-v.y*d.x*y.x*p.y*h.x*h.y+v.y*d.y*p.x*y.x*h.x*h.y-d.x*d.y*p.x*y.x*p.y*h.y+d.x*d.y*p.x*p.y*h.x*y.y+d.x*b.x*p.y*h.x*y.y*h.y+6*d.x*p.x*b.y*h.x*y.y*h.y+d.x*b.y*y.x*p.y*h.x*h.y-b.x*d.y*p.x*h.x*y.y*h.y-6*b.x*d.y*y.x*p.y*h.x*h.y-d.y*p.x*b.y*y.x*h.x*h.y-6*v.x*b.x*y.x*B-2*v.x*y.x*_*h.x+6*v.y*b.y*P*y.y+2*b.x*y.x*_*h.x+2*v.y*O*y.y*h.y-2*O*b.y*y.y*h.y-6*v.x*v.y*y.x*h.x*H+3*v.x*d.x*p.x*y.y*H-2*v.x*d.x*y.x*p.y*H-4*v.x*d.y*p.x*y.x*H+3*v.y*d.x*p.x*y.x*H+6*v.x*v.y*D*y.y*h.y+6*v.x*b.x*h.x*y.y*H-3*v.x*d.y*p.y*D*y.y+2*v.x*p.x*y.x*M*h.y+2*v.x*p.x*M*h.x*y.y+6*v.x*b.y*y.x*h.x*H+4*v.y*d.x*p.y*D*y.y+6*v.y*b.x*y.x*h.x*H+2*v.y*d.y*p.x*D*y.y-3*v.y*d.y*y.x*p.y*D+2*v.y*p.x*y.x*M*h.x-3*d.x*b.x*p.x*y.y*H+2*d.x*b.x*y.x*p.y*H+d.x*d.y*y.x*M*h.x-3*d.x*p.x*b.y*y.x*H+4*b.x*d.y*p.x*y.x*H-6*v.x*b.y*D*y.y*h.y-2*v.x*A*p.y*y.y*h.y-6*v.y*b.x*D*y.y*h.y-6*v.y*b.y*y.x*D*h.y-2*v.y*A*y.x*p.y*h.y-2*v.y*A*p.y*h.x*y.y-d.x*d.y*A*y.y*h.y-4*d.x*b.y*p.y*D*y.y-2*d.x*k*y.x*h.x*h.y+3*b.x*d.y*p.y*D*y.y-2*b.x*p.x*y.x*M*h.y-2*b.x*p.x*M*h.x*y.y-6*b.x*b.y*y.x*h.x*H-2*d.y*p.x*b.y*D*y.y+3*d.y*b.y*y.x*p.y*D-2*p.x*b.y*y.x*M*h.x-k*p.x*y.x*p.y*h.x+6*b.x*b.y*D*y.y*h.y+2*b.x*A*p.y*y.y*h.y+2*N*d.y*h.x*y.y*h.y+N*p.x*p.y*y.y*h.y+2*A*b.y*y.x*p.y*h.y+2*A*b.y*p.y*h.x*y.y+3*E*y.x*B-3*x*P*y.y+3*j*y.x*B+L*y.x*D-C*y.y*H-3*I*P*y.y-d.x*k*D*y.y+N*d.y*y.x*H-3*E*h.x*y.y*H+3*x*y.x*D*h.y-N*M*h.x*y.y+k*A*y.x*h.y-3*j*h.x*y.y*H+3*I*y.x*D*h.y,v.x*v.y*d.x*p.y*h.x*h.y-v.x*v.y*d.y*p.x*h.x*h.y+v.x*d.x*d.y*p.x*p.y*h.y-v.y*d.x*d.y*p.x*p.y*h.x-v.x*d.x*b.y*p.y*h.x*h.y+6*v.x*b.x*d.y*p.y*h.x*h.y+v.x*d.y*p.x*b.y*h.x*h.y-v.y*d.x*b.x*p.y*h.x*h.y-6*v.y*d.x*p.x*b.y*h.x*h.y+v.y*b.x*d.y*p.x*h.x*h.y-d.x*b.x*d.y*p.x*p.y*h.y+d.x*d.y*p.x*b.y*p.y*h.x+d.x*b.x*b.y*p.y*h.x*h.y-b.x*d.y*p.x*b.y*h.x*h.y-2*v.x*b.x*_*h.x+2*v.y*O*b.y*h.y-3*v.x*v.y*d.x*p.x*H-6*v.x*v.y*b.x*h.x*H+3*v.x*v.y*d.y*p.y*D-2*v.x*v.y*p.x*M*h.x-2*v.x*d.x*b.x*p.y*H-v.x*d.x*d.y*M*h.x+3*v.x*d.x*p.x*b.y*H-4*v.x*b.x*d.y*p.x*H+3*v.y*d.x*b.x*p.x*H+6*v.x*v.y*b.y*D*h.y+2*v.x*v.y*A*p.y*h.y+2*v.x*d.x*k*h.x*h.y+2*v.x*b.x*p.x*M*h.y+6*v.x*b.x*b.y*h.x*H-3*v.x*d.y*b.y*p.y*D+2*v.x*p.x*b.y*M*h.x+v.x*k*p.x*p.y*h.x+v.y*d.x*d.y*A*h.y+4*v.y*d.x*b.y*p.y*D-3*v.y*b.x*d.y*p.y*D+2*v.y*b.x*p.x*M*h.x+2*v.y*d.y*p.x*b.y*D+d.x*b.x*d.y*M*h.x-3*d.x*b.x*p.x*b.y*H-2*v.x*A*b.y*p.y*h.y-6*v.y*b.x*b.y*D*h.y-2*v.y*b.x*A*p.y*h.y-2*v.y*N*d.y*h.x*h.y-v.y*N*p.x*p.y*h.y-2*v.y*A*b.y*p.y*h.x-2*d.x*b.x*k*h.x*h.y-d.x*d.y*A*b.y*h.y+3*b.x*d.y*b.y*p.y*D-2*b.x*p.x*b.y*M*h.x-b.x*k*p.x*p.y*h.x+3*x*d.x*p.x*h.x*h.y+3*d.x*p.x*I*h.x*h.y+2*b.x*A*b.y*p.y*h.y-3*E*d.y*p.y*h.x*h.y+2*N*d.y*b.y*h.x*h.y+N*p.x*b.y*p.y*h.y-3*j*d.y*p.y*h.x*h.y-S*B+T*P+F*B-q*P-3*v.x*j*B-v.x*L*D+3*E*b.x*B+v.y*C*H+3*v.y*I*P+b.x*L*D+E*_*h.x-3*x*b.y*P-x*O*h.y+j*_*h.x-C*b.y*H-O*I*h.y-v.x*N*d.y*H+v.y*d.x*k*D-3*v.x*x*D*h.y-v.x*k*A*h.y+v.y*N*M*h.x-d.x*k*b.y*D+3*E*v.y*h.x*H+E*d.x*p.y*H+2*E*d.y*p.x*H-2*x*d.x*p.y*D-x*d.y*p.x*D+N*b.x*d.y*H-3*v.x*I*D*h.y+3*v.y*j*h.x*H+d.x*j*p.y*H-2*d.x*I*p.y*D+b.x*k*A*h.y-d.y*p.x*I*D-E*p.x*M*h.y-3*E*b.y*h.x*H+3*x*b.x*D*h.y+x*A*p.y*h.x-N*b.y*M*h.x+2*j*d.y*p.x*H+3*b.x*I*D*h.y-j*p.x*M*h.y-3*j*b.y*h.x*H+A*I*p.y*h.x),Y=G.getRootsInInterval(0,1);for(var Z=0;Z<Y.length;Z++){var et=Y[Z],tt=(new Polynomial(h.x,p.x,d.x,v.x-b.x-et*y.x-et*et*g.x-et*et*et*m.x)).getRoots(),nt=(new Polynomial(h.y,p.y,d.y,v.y-b.y-et*y.y-et*et*g.y-et*et*et*m.y)).getRoots();if(tt.length>0&&nt.length>0){var rt=1e-4;e:for(var it=0;it<tt.length;it++){var st=tt[it];if(0<=st&&st<=1)for(var ot=0;ot<nt.length;ot++)if(Math.abs(st-nt[ot])<rt){w.points.push(m.multiply(et*et*et).add(g.multiply(et*et).add(y.multiply(et).add(b))));break e}}}}return w.points.length>0&&(w.status="Intersection"),w},gi.intersectBezier3Circle=function(e,t,n,r,i,s){return gi.intersectBezier3Ellipse(e,t,n,r,i,s,s)},gi.intersectBezier3Ellipse=function(e,t,n,r,i,s,o){var u,a,f,l,c,h,p,d,v=new gi("No Intersection");u=e.multiply(-1),a=t.multiply(3),f=n.multiply(-3),l=u.add(a.add(f.add(r))),c=new Vector2D(l.x,l.y),u=e.multiply(3),a=t.multiply(-6),f=n.multiply(3),l=u.add(a.add(f)),h=new Vector2D(l.x,l.y),u=e.multiply(-3),a=t.multiply(3),f=u.add(a),p=new Vector2D(f.x,f.y),d=new Vector2D(e.x,e.y);var m=s*s,g=o*o,y=new Polynomial(c.x*c.x*g+c.y*c.y*m,2*(c.x*h.x*g+c.y*h.y*m),2*(c.x*p.x*g+c.y*p.y*m)+h.x*h.x*g+h.y*h.y*m,2*c.x*g*(d.x-i.x)+2*c.y*m*(d.y-i.y)+2*(h.x*p.x*g+h.y*p.y*m),2*h.x*g*(d.x-i.x)+2*h.y*m*(d.y-i.y)+p.x*p.x*g+p.y*p.y*m,2*p.x*g*(d.x-i.x)+2*p.y*m*(d.y-i.y),d.x*d.x*g-2*d.y*i.y*m-2*d.x*i.x*g+d.y*d.y*m+i.x*i.x*g+i.y*i.y*m-m*g),b=y.getRootsInInterval(0,1);for(var w=0;w<b.length;w++){var E=b[w];v.points.push(c.multiply(E*E*E).add(h.multiply(E*E).add(p.multiply(E).add(d))))}return v.points.length>0&&(v.status="Intersection"),v},gi.intersectBezier3Line=function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m=i.min(s),g=i.max(s),y=new gi("No Intersection");o=e.multiply(-1),u=t.multiply(3),a=n.multiply(-3),f=o.add(u.add(a.add(r))),l=new Vector2D(f.x,f.y),o=e.multiply(3),u=t.multiply(-6),a=n.multiply(3),f=o.add(u.add(a)),c=new Vector2D(f.x,f.y),o=e.multiply(-3),u=t.multiply(3),a=o.add(u),h=new Vector2D(a.x,a.y),p=new Vector2D(e.x,e.y),v=new Vector2D(i.y-s.y,s.x-i.x),d=i.x*s.y-s.x*i.y,roots=(new Polynomial(v.dot(l),v.dot(c),v.dot(h),v.dot(p)+d)).getRoots();for(var b=0;b<roots.length;b++){var w=roots[b];if(0<=w&&w<=1){var E=e.lerp(t,w),S=t.lerp(n,w),x=n.lerp(r,w),T=E.lerp(S,w),N=S.lerp(x,w),C=T.lerp(N,w);i.x==s.x?m.y<=C.y&&C.y<=g.y&&(y.status="Intersection",y.appendPoint(C)):i.y==s.y?m.x<=C.x&&C.x<=g.x&&(y.status="Intersection",y.appendPoint(C)):C.gte(m)&&C.lte(g)&&(y.status="Intersection",y.appendPoint(C))}}return y},gi.intersectBezier3Polygon=function(e,t,n,r,i){var s=new gi("No Intersection"),o=i.length;for(var u=0;u<o;u++){var a=i[u],f=i[(u+1)%o],l=gi.intersectBezier3Line(e,t,n,r,a,f);s.appendPoints(l.points)}return s.points.length>0&&(s.status="Intersection"),s},gi.intersectBezier3Rectangle=function(e,t,n,r,i,s){var u=i.min(s),a=i.max(s),f=new o(a.x,u.y),l=new o(u.x,a.y),c=gi.intersectBezier3Line(e,t,n,r,u,f),h=gi.intersectBezier3Line(e,t,n,r,f,a),p=gi.intersectBezier3Line(e,t,n,r,a,l),d=gi.intersectBezier3Line(e,t,n,r,l,u),v=new gi("No Intersection");return v.appendPoints(c.points),v.appendPoints(h.points),v.appendPoints(p.points),v.appendPoints(d.points),v.points.length>0&&(v.status="Intersection"),v},gi.intersectCircleCircle=function(e,t,n,r){var i,s=t+r,u=Math.abs(t-r),a=e.distanceFrom(n);if(a>s)i=new gi("Outside");else if(a<u)i=new gi("Inside");else{i=new gi("Intersection");var f=(t*t-r*r+a*a)/(2*a),l=Math.sqrt(t*t-f*f),c=e.lerp(n,f/a),h=l/a;i.points.push(new o(c.x-h*(n.y-e.y),c.y+h*(n.x-e.x))),i.points.push(new o(c.x+h*(n.y-e.y),c.y-h*(n.x-e.x)))}return i},gi.intersectCircleEllipse=function(e,t,n,r,i){return gi.intersectEllipseEllipse(e,t,t,n,r,i)},gi.intersectCircleLine=function(e,t,n,r){var i,s=(r.x-n.x)*(r.x-n.x)+(r.y-n.y)*(r.y-n.y),o=2*((r.x-n.x)*(n.x-e.x)+(r.y-n.y)*(n.y-e.y)),u=e.x*e.x+e.y*e.y+n.x*n.x+n.y*n.y-2*(e.x*n.x+e.y*n.y)-t*t,a=o*o-4*s*u;if(a<0)i=new gi("Outside");else if(a==0)i=new gi("Tangent");else{var f=Math.sqrt(a),l=(-o+f)/(2*s),c=(-o-f)/(2*s);(l<0||l>1)&&(c<0||c>1)?l<0&&c<0||l>1&&c>1?i=new gi("Outside"):i=new gi("Inside"):(i=new gi("Intersection"),0<=l&&l<=1&&i.points.push(n.lerp(r,l)),0<=c&&c<=1&&i.points.push(n.lerp(r,c)))}return i},gi.intersectCirclePolygon=function(e,t,n){var r=new gi("No Intersection"),i=n.length,s;for(var o=0;o<i;o++){var u=n[o],a=n[(o+1)%i];s=gi.intersectCircleLine(e,t,u,a),r.appendPoints(s.points)}return r.points.length>0?r.status="Intersection":r.status=s.status,r},gi.intersectCircleRectangle=function(e,t,n,r){var i=n.min(r),s=n.max(r),u=new o(s.x,i.y),a=new o(i.x,s.y),f=gi.intersectCircleLine(e,t,i,u),l=gi.intersectCircleLine(e,t,u,s),c=gi.intersectCircleLine(e,t,s,a),h=gi.intersectCircleLine(e,t,a,i),p=new gi("No Intersection");return p.appendPoints(f.points),p.appendPoints(l.points),p.appendPoints(c.points),p.appendPoints(h.points),p.points.length>0?p.status="Intersection":p.status=f.status,p},gi.intersectEllipseEllipse=function(e,t,n,r,i,s){var u=[n*n,0,t*t,-2*n*n*e.x,-2*t*t*e.y,n*n*e.x*e.x+t*t*e.y*e.y-t*t*n*n],a=[s*s,0,i*i,-2*s*s*r.x,-2*i*i*r.y,s*s*r.x*r.x+i*i*r.y*r.y-i*i*s*s],f=gi.bezout(u,a),l=f.getRoots(),c=.001,h=(u[0]*u[0]+2*u[1]*u[1]+u[2]*u[2])*c,p=(a[0]*a[0]+2*a[1]*a[1]+a[2]*a[2])*c,d=new gi("No Intersection");for(var v=0;v<l.length;v++){var m=new Polynomial(u[0],u[3]+l[v]*u[1],u[5]+l[v]*(u[4]+l[v]*u[2])),g=m.getRoots();for(var y=0;y<g.length;y++){var b=(u[0]*g[y]+u[1]*l[v]+u[3])*g[y]+(u[2]*l[v]+u[4])*l[v]+u[5];Math.abs(b)<h&&(b=(a[0]*g[y]+a[1]*l[v]+a[3])*g[y]+(a[2]*l[v]+a[4])*l[v]+a[5],Math.abs(b)<p&&d.appendPoint(new o(g[y],l[v])))}}return d.points.length>0&&(d.status="Intersection"),d},gi.intersectEllipseLine=function(e,t,n,r,i){var s,o=new Vector2D(r.x,r.y),u=Vector2D.fromPoints(r,i),a=new Vector2D(e.x,e.y),f=o.subtract(a),l=new Vector2D(u.x/(t*t),u.y/(n*n)),c=new Vector2D(f.x/(t*t),f.y/(n*n)),h=u.dot(l),p=u.dot(c),e=f.dot(c)-1,d=p*p-h*e;if(d<0)s=new gi("Outside");else if(d>0){var v=Math.sqrt(d),m=(-p-v)/h,g=(-p+v)/h;(m<0||1<m)&&(g<0||1<g)?m<0&&g<0||m>1&&g>1?s=new gi("Outside"):s=new gi("Inside"):(s=new gi("Intersection"),0<=m&&m<=1&&s.appendPoint(r.lerp(i,m)),0<=g&&g<=1&&s.appendPoint(r.lerp(i,g)))}else{var y=-p/h;0<=y&&y<=1?(s=new gi("Intersection"),s.appendPoint(r.lerp(i,y))):s=new gi("Outside")}return s},gi.intersectEllipsePolygon=function(e,t,n,r){var i=new gi("No Intersection"),s=r.length;for(var o=0;o<s;o++){var u=r[o],a=r[(o+1)%s],f=gi.intersectEllipseLine(e,t,n,u,a);i.appendPoints(f.points)}return i.points.length>0&&(i.status="Intersection"),i},gi.intersectEllipseRectangle=function(e,t,n,r,i){var s=r.min(i),u=r.max(i),a=new o(u.x,s.y),f=new o(s.x,u.y),l=gi.intersectEllipseLine(e,t,n,s,a),c=gi.intersectEllipseLine(e,t,n,a,u),h=gi.intersectEllipseLine(e,t,n,u,f),p=gi.intersectEllipseLine(e,t,n,f,s),d=new gi("No Intersection");return d.appendPoints(l.points),d.appendPoints(c.points),d.appendPoints(h.points),d.appendPoints(p.points),d.points.length>0&&(d.status="Intersection"),d},gi.intersectLineLine=function(e,t,n,r){var i,s=(r.x-n.x)*(e.y-n.y)-(r.y-n.y)*(e.x-n.x),u=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),a=(r.y-n.y)*(t.x-e.x)-(r.x-n.x)*(t.y-e.y);if(a!=0){var f=s/a,l=u/a;0<=f&&f<=1&&0<=l&&l<=1?(i=new gi("Intersection"),i.points.push(new o(e.x+f*(t.x-e.x),e.y+f*(t.y-e.y)))):i=new gi("No Intersection")}else s==0||u==0?i=new gi("Coincident"):i=new gi("Parallel");return i},gi.intersectLinePolygon=function(e,t,n){var r=new gi("No Intersection"),i=n.length;for(var s=0;s<i;s++){var o=n[s],u=n[(s+1)%i],a=gi.intersectLineLine(e,t,o,u);r.appendPoints(a.points)}return r.points.length>0&&(r.status="Intersection"),r},gi.intersectLineRectangle=function(e,t,n,r){var i=n.min(r),s=n.max(r),u=new o(s.x,i.y),a=new o(i.x,s.y),f=gi.intersectLineLine(i,u,e,t),l=gi.intersectLineLine(u,s,e,t),c=gi.intersectLineLine(s,a,e,t),h=gi.intersectLineLine(a,i,e,t),p=new gi("No Intersection");return p.appendPoints(f.points),p.appendPoints(l.points),p.appendPoints(c.points),p.appendPoints(h.points),p.points.length>0&&(p.status="Intersection"),p},gi.intersectPolygonPolygon=function(e,t){var n=new gi("No Intersection"),r=e.length;for(var i=0;i<r;i++){var s=e[i],o=e[(i+1)%r],u=gi.intersectLinePolygon(s,o,t);n.appendPoints(u.points)}return n.points.length>0&&(n.status="Intersection"),n},gi.intersectPolygonRectangle=function(e,t,n){var r=t.min(n),i=t.max(n),s=new o(i.x,r.y),u=new o(r.x,i.y),a=gi.intersectLinePolygon(r,s,e),f=gi.intersectLinePolygon(s,i,e),l=gi.intersectLinePolygon(i,u,e),c=gi.intersectLinePolygon(u,r,e),h=new gi("No Intersection");return h.appendPoints(a.points),h.appendPoints(f.points),h.appendPoints(l.points),h.appendPoints(c.points),h.points.length>0&&(h.status="Intersection"),h},gi.intersectRayRay=function(e,t,n,r){var i,s=(r.x-n.x)*(e.y-n.y)-(r.y-n.y)*(e.x-n.x),u=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),a=(r.y-n.y)*(t.x-e.x)-(r.x-n.x)*(t.y-e.y);if(a!=0){var f=s/a;i=new gi("Intersection"),i.points.push(new o(e.x+f*(t.x-e.x),e.y+f*(t.y-e.y)))}else s==0||u==0?i=new gi("Coincident"):i=new gi("Parallel");return i},gi.intersectRectangleRectangle=function(e,t,n,r){var i=e.min(t),s=e.max(t),u=new o(s.x,i.y),a=new o(i.x,s.y),f=gi.intersectLineRectangle(i,u,n,r),l=gi.intersectLineRectangle(u,s,n,r),c=gi.intersectLineRectangle(s,a,n,r),h=gi.intersectLineRectangle(a,i,n,r),p=new gi("No Intersection");return p.appendPoints(f.points),p.appendPoints(l.points),p.appendPoints(c.points),p.appendPoints(h.points),p.points.length>0&&(p.status="Intersection"),p},gi.bezout=function(e,t){var n=e[0]*t[1]-t[0]*e[1],r=e[0]*t[2]-t[0]*e[2],i=e[0]*t[3]-t[0]*e[3],s=e[0]*t[4]-t[0]*e[4],o=e[0]*t[5]-t[0]*e[5],u=e[1]*t[2]-t[1]*e[2],a=e[1]*t[4]-t[1]*e[4],f=e[1]*t[5]-t[1]*e[5],l=e[2]*t[3]-t[2]*e[3],c=e[3]*t[4]-t[3]*e[4],h=e[3]*t[5]-t[3]*e[5],p=f+c,d=a-l;return new Polynomial(n*u-r*r,n*d+i*u-2*r*s,n*p+i*d-s*s-2*r*o,n*h+i*p-2*s*o,i*h-o*o)},n.Intersection=gi,n.AreaPicking=function(e,t){this.network=e,this.bounding=t,this.cache={}},n.extend(n.AreaPicking,Object,{intersectObjects:function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n];this.intersectObject(r,t)}return t},getViewPoint:function(e,t){var n=t.vertices[e].clone(),r=this.cache[t.getId()][n.x+" "+n.y+" "+n.z];return r?r:(n.applyMatrix4(t.worldMatrix),r=this.network.getViewPosition(n),r.y=r.h-r.y,r)},intersectObject:function(e,t){if(e instanceof n.Entity){this.cache[e.getId()]={};for(var r=0;r<e.vertices.length;r++){var i=e.vertices[r].clone();i.applyMatrix4(e.worldMatrix);var s=this.network.getViewPosition(i);s.y=s.h-s.y,this.cache[e.getId()][i.x+" "+i.y+" "+i.z]=s;if(s.x>this.bounding.x&&s.y>this.bounding.y&&s.x<this.bounding.x+this.bounding.w&&s.y<this.bounding.y+this.bounding.h){var o={element:e};t.push(o);return}}}}}),n.BaseInteraction=function(e){this.network=e,this.view=e.getView()||document},n.addEventListener=function(e,t,n,r){var i="_"+e+"_";if(r[i])return;var s=function(e){r[t](e)};r[i]=s,n.addEventListener(e,s,!1)},n.removeEventListener=function(e,t,n){var r="_"+e+"_",i=n[r];i&&(t.removeEventListener(e,i,!1),delete n[r])},n.extend(n.BaseInteraction,Object,{onPropertyChange:function(){},firePropertyChange:function(){},setUp:function(){},tearDown:function(){},update:function(){},addListener:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];n.addEventListener(t,"handle_"+t,this.network.getRootView(),this)}},removeListener:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];n.removeEventListener(arguments[e],this.network.getRootView(),this)}},isCtrlDown:function(e){return e.ctrlKey||e.metaKey},isFinished:function(){return!0}}),n.DefaultInteraction=function(t){n.BaseInteraction.call(this,t),this.screen={width:0,height:0,offsetLeft:0,offsetTop:0},this.radius=this.screen.width/4,this.domElement=this.network.getRootView(),this.rotateSpeed=1,this.zoomSpeed=10,this.panSpeed=3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.easing=!0,this.dynamicDampingFactor=.05,this.timeInterval=2e3,this.minDistance=0,this.maxDistance=Infinity,this.keys=[65,83,68],this.lastPosition=new n.Vec3;var r=this.STATE.NONE,i=this.STATE.NONE,s=new n.Vec3,o=new n.Vec3,u=new n.Vec3,a=new n.Vec2,l=new n.Vec2,c=0,d=0,v=new n.Vec2,m=new n.Vec2,g=0,y,b;this.object=this.network._camera,this.object.target||(this.object.target=new n.Vec3),this.movementSpeed=1,this.lookSpeed=.005,this.verticalLookRatio=.1,this.keyboardEnable=!0,this.lookVertical=!0,this.autoForward=!1,this.fpsMode=!1,this.dragMode=!0,this.activeLook=!1,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.heightMax=1,this.constrainVertical=!1,this.verticalFixed=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.autoSpeedFactor=0,this.mouseX=0,this.mouseY=0,this.lat=0,this.lon=0,this.phi=0,this.theta=0,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.freeze=!1,this.mouseDragOn=!1,this.viewHalfX=0,this.viewHalfY=0,this.lastX=0,this.lastY=0,this.touchSeq=[1,2,3],this.fpsMinDistance=100,this.network.getRootView().addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.yRistrict=!0,this.yLowerLimitAngle=-Math.PI/2,this.yUpLimitAngle=Math.PI/2,this.updateIntervalTime=0;var w=null;this.handleResize=function(){this.screen.width=e.innerWidth,this.screen.height=e.innerHeight,this.screen.offsetLeft=0,this.screen.offsetTop=0,this.radius=(this.screen.width+this.screen.height)/4},this.handleResize(),this.handle_mousedown=function(e){if(p.isCtrlDown(e))return;e.preventDefault();if(this.fpsMode){this.domElement!==document&&this.domElement.focus();if(this.activeLook)switch(e.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.lastX=e.pageX,this.lastY=e.pageY,this.mouseDragOn=!0}else r===this.STATE.NONE&&(r=e.button),r===this.
STATE.ROTATE&&!this.noRotate?(o=u=this.getMouseProjectionOnBall(e.clientX,e.clientY),y=b=this.getRotateY(e.clientX,e.clientY)):this.state===this.STATE.ZOOM&&!this.noZoom?a=l=this.getMouseOnScreen(e.clientX,e.clientY):r===this.STATE.PAN&&!this.noPan&&(v=m=this.getMouseOnScreen(e.clientX,e.clientY));this.beforeUpdate(),this.addListener("mousemove","mouseup")},this.handle_mousemove=function(e){if(e.stop)return;e.preventDefault(),this.fpsMode?this.dragMode?this.mouseDragOn?(this.mouseX=(e.pageX-this.lastX)*300,this.mouseY=(e.pageY-this.lastY)*300,this.lastX=e.pageX,this.lastY=e.pageY):(this.mouseX=0,this.mouseY=0):this.domElement===document?(this.mouseX=e.pageX-this.viewHalfX,this.mouseY=e.pageY-this.viewHalfY):(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY):r===this.STATE.ROTATE&&!this.noRotate?(u=this.getMouseProjectionOnBall(e.clientX,e.clientY),b=this.getRotateY(e.clientX,e.clientY)):r===this.STATE.ZOOM&&!this.noZoom?l=this.getMouseOnScreen(e.clientX,e.clientY):r===this.STATE.PAN&&!this.noPan&&(m=this.getMouseOnScreen(e.clientX,e.clientY));var t=(new Date).getTime();if(this._lt==null)this.update();else{if(t-this._lt<this.updateIntervalTime)return;this.update()}this._lt=t},this.handle_mouseup=function(e){e.preventDefault();if(this.fpsMode){if(this.activeLook)switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.lastX=0,this.lastY=0,this.dragMode&&(this.mouseX=0,this.mouseY=0),this.mouseDragOn=!1}else r=this.STATE.NONE;this.removeListener("mousemove","mouseup"),this.update(),this.afterHandleMouseup()},this.afterHandleMouseup=function(){},this.handle_touchstart=function(e){if(this.enabled===!1)return;switch(e.touches.length){case this.touchSeq[0]:r=this.STATE.TOUCH_ROTATE,o=this.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY),y=b=this.getRotateY(e.touches[0].pageX,e.touches[0].pageY),u.copy(o);break;case this.touchSeq[1]:r=this.STATE.TOUCH_ZOOM;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;d=c=Math.sqrt(t*t+n*n);break;case this.touchSeq[2]:r=this.STATE.TOUCH_PAN,v.copy(this.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY)),m.copy(v);break;default:r=this.STATE.NONE}this.update()},this.handle_touchmove=function(e){if(this.enabled===!1)return;e.preventDefault();switch(e.touches.length){case this.touchSeq[0]:u=this.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY,u),b=this.getRotateY(e.touches[0].pageX,e.touches[0].pageY);break;case this.touchSeq[1]:var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;d=Math.sqrt(t*t+n*n);break;case this.touchSeq[2]:m=this.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY,m);break;default:r=this.STATE.NONE}this.update()},this.handle_touchend=function(e){if(this.enabled===!1)return;switch(e.touches.length){case this.touchSeq[0]:o.copy(this.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY,u));break;case this.touchSeq[1]:c=d=0;break;case this.touchSeq[2]:m.copy(this.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY)),v.copy(m)}r=this.STATE.NONE,this.update()},this.handle_DOMMouseScroll=function(e){this.handle_mousewheel(e)},this.handle_mousewheel=function(e){e.preventDefault();var t=0;e.wheelDelta?e.wheelDelta%120===0?t=e.wheelDelta/40:Math.abs(e.wheelDelta)>=100?t=e.wheelDelta/40:t=e.wheelDelta:e.detail&&(t=-e.detail/3),t&&(a.y+=1/t*.01),this.mouseMoving=!0,this.update()},this.handle_dblclick=function(e){if(!this.isCtrlDown(e))return;var t=this.network.getElementsByMouseEvent(e);t.length>0&&(w=t[0]),this.update()},this.getMouseOnScreen=function(e,t){return new n.Vec2((e-this.screen.offsetLeft)/this.radius*.5,(t-this.screen.offsetTop)/this.radius*.5)},this.getRotateY=function(e,t){if(this.yRistrict){var n=(this.screen.height*.5+this.screen.offsetTop-t)/this.screen.height*2;return n}},this.handle_keydown=function(e){if(!this.keyboardEnable)return;switch(e.keyCode){case 38:case 87:this.moveForward=!0;break;case 37:case 65:this.moveLeft=!0;break;case 40:case 83:this.moveBackward=!0;break;case 39:case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0;break;case 81:this.freeze=!this.freeze}this.update()},this.handle_keyup=function(e){if(!this.keyboardEnable)return;switch(e.keyCode){case 38:case 87:this.moveForward=!1;break;case 37:case 65:this.moveLeft=!1;break;case 40:case 83:this.moveBackward=!1;break;case 39:case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}this.update()},this.getMouseProjectionOnBall=function(e,t){if(this.yRistrict){var r=new n.Vec3((e-this.screen.width*.5-this.screen.offsetLeft)/(this.screen.width*.5),0,0),i=r.length();return i>1?r.normalize():r.z=Math.sqrt(1-i*i),r.normalize()}var r=new n.Vec3((e-this.screen.width*.5-this.screen.offsetLeft)/this.radius,(this.screen.height*.5+this.screen.offsetTop-t)/this.radius,0),i=r.length();i>1?r.normalize():r.z=Math.sqrt(1-i*i),s.copy(this.object._position).sub(this.object.target);var o=this.object.up.clone().setLength(r.y);return o.add(this.object.up.clone().cross(s).setLength(r.x)),o.add(s.setLength(r.z)),o},this.rotateSpeedFunction=function(){return this.rotateSpeed},this.rotateCamera=function(){var e=o.dot(u)/o.length()/u.length(),t=Math.acos(e),r=!this.easing||Math.abs(t)<1e-4,i=!1,a=this.rotateSpeedFunction();if(t){var f=(new n.Vec3).crossVectors(o,u).normalize(),l=new n.Quat;l.setFromAxisAngle(f,-t*this.dynamicDampingFactor*a),r?(l.setFromAxisAngle(f,-t*a),s.applyQuaternion(l),this.object.up.applyQuaternion(l),o.copy(u)):(l.setFromAxisAngle(f,-t*this.dynamicDampingFactor*a),s.applyQuaternion(l),this.object.up.applyQuaternion(l),l.setFromAxisAngle(f,t*this.dynamicDampingFactor),o.applyQuaternion(l),i=!0)}var r=!this.easing||Math.abs(b-y)<1e-4,c=(b-y)*s.length();if(!H.isNaN(c))if(r)c&&this.yRistrict&&this.limitY(c),y=b;else{var c=c*this.dynamicDampingFactor;c&&this.yRistrict&&this.limitY(c),y+=(b-y)*this.dynamicDampingFactor,i=!0}i&&this.network.dirtyNetwork()},this.limitY=function(e){var t=s.length();Math.abs(s.x)<=.1*t&&Math.abs(s.z)<=.1*t&&(s.x=.1*t);var n=s.x,r=s.z,i=Math.sqrt(n*n+r*r),o=Math.tan(this.yLowerLimitAngle)*i,u=Math.tan(this.yUpLimitAngle)*i;s.y-=e,s.y>u?s.y=u:s.y<o&&(s.y=o)},this.getValueByTime=function(e,t){var n=(new Date).getTime(),r=n-this._timeStart;return r>this.timeInterval?t:e+(t-e)*r/this.timeInterval},this.zoomCamera=function(){if(r===this.STATE.TOUCH_ZOOM){var e=c/d;c=d,s.multiplyScalar(e)}else{var t=this.zoomSpeed;this.easing||(t*=5);var e;e=1+(l.y-a.y)*t,e!==1&&e>0&&(s.multiplyScalar(e),!this.easing||Math.abs(l.y-a.y)<.001?a.copy(l):(a.y+=(l.y-a.y)*this.dynamicDampingFactor,this.network.dirtyNetwork()))}},this.panCamera=function(){var e=m.clone().sub(v);if(e.lengthSq()){e.multiplyScalar(s.length()*this.panSpeed);var t=s.clone().cross(this.object.up).setLength(e.x),n=(new h).extractRotation(this.object.matrix),r=this.object.up.clone().applyMatrix4(n);t.add(r.setLength(e.y));var i=this.object.p().add(t);this.object.checkPosition(i)&&(this.object.p(i),this.object.target.add(t)),v=m,this.network.dirtyNetwork()}},this.checkAngles=function(){},this.checkDistances=function(){if(!this.noZoom||!this.noPan)s.lengthSq()>this.maxDistance*this.maxDistance&&this.object._position.addVectors(this.object.target,s.setLength(this.maxDistance)),s.lengthSq()<this.minDistance*this.minDistance&&this.object._position.addVectors(this.object.target,s.setLength(this.minDistance))},this.updateFPS=function(){var e=2;if(this.freeze)return;if(this.heightSpeed){var t=n.Math.clamp(this.object._position.y,this.heightMin,this.heightMax),r=t-this.heightMin;this.autoSpeedFactor=e*r*this.heightCoef}else this.autoSpeedFactor=0;var i=e*this.movementSpeed;if(this.moveForward||this.autoForward&&!this.moveBackward){var o=this.object._position.clone();this.object.translateZ(-(i+this.autoSpeedFactor));var u=this.object.target;this.verticalFixed&&this.object.setY(o.y);var a=this.object._position,l=new f,c=new f;l.subVectors(a,u),c.subVectors(o,u),l.z*c.z<=this.minDistance*this.minDistance&&this.object.target.subVectors(this.object._position,s)}if(this.moveBackward){var o=this.object._position.clone();this.object.translateZ(i),this.verticalFixed&&this.object.setY(o.y)}this.moveLeft&&(this.object.translateX(this.fpsMode?i:-i),this.object.target.subVectors(this.object._position,s)),this.moveRight&&(this.object.translateX(this.fpsMode?-i:i),this.object.target.subVectors(this.object._position,s)),this.moveUp&&(this.object.translateY(i),this.object.target.subVectors(this.object._position,s)),this.moveDown&&(this.object.translateY(-i),this.object.target.subVectors(this.object._position,s));var h=e*this.lookSpeed;!this.activeLook&&!this.dragMode&&(h=0);var p=this.verticalLookRatio;this.constrainVertical&&(p=Math.PI/(this.verticalMax-this.verticalMin)),this.lon+=this.mouseX*h,this.dragMode&&(this.mouseX=0),this.lookVertical&&(this.lat-=this.mouseY*h*p),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=n.Math.degToRad(90-this.lat),this.theta=n.Math.degToRad(this.lon),this.constrainVertical&&(this.phi=n.Math.mapLinear(this.phi,0,Math.PI,this.verticalMin,this.verticalMax));if(this.fpsMode){var d=this.object.target,a=this.object._position;length=length<this.fpsMinDistance?this.fpsMinDistance:length,d.x=a.x+length*Math.sin(this.phi)*Math.sin(this.theta),d.y=a.y+length*Math.cos(this.phi),d.z=a.z-length*Math.sin(this.phi)*Math.cos(this.theta),this.object.look(d)}},this.setCameraTarget=function(e){var t=this.Object,n=t.p()},this.update=function(){s.subVectors(this.object._position,this.object.target),!this.noRotate&&!this.fpsMode&&this.rotateCamera(),this.noZoom||this.zoomCamera(),!this.noPan&&!this.fpsMode&&this.panCamera();if(w&&w.element&&this.network.doubleClickToLookAtFunction(w.element)){this.object.target=w.point;var e=this.object._position.distanceTo(this.object.target),t=w.face.normal.clone();t=t.applyMatrix4((new n.Mat4).extractRotation(w.element.worldMatrix)),t.normalize(),s=t.multiplyScalar(e),w=null}this.object.setPosition(this.object._position.clone().addVectors(this.object.target,s)),this.updateFPS(),this.fpsMode||(this.checkDistances(),this.object.look(this.object.target)),this.lastPosition.distanceToSquared(this.object._position)>0&&this.lastPosition.copy(this.object._position)},this.handleCameraChange=function(e){var t=this.object;if(!t)return;var n=t.p(),r=t.target;if(this.fpsMode){var i=H.getVectorAngles(r,n);this.lat=-i[1],this.lon=-i[0]}}},n.extend(n.DefaultInteraction,n.BaseInteraction,{STATE:{NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5},__accessor:["rotateSpeed","zoomSpeed","panSpeed","yLowerLimitAngle","yUpLimitAngle","minDistance","maxDistance","easing","touchSeq"],__bool:["noRotate","noPan","noZoom","fpsMode","yRistrict","keyboardEnable"],setUp:function(){this.addListener("mousedown","touchstart","touchend","touchmove","mousewheel","DOMMouseScroll","dblclick","keydown","keyup"),this.object&&this.object.addPropertyChangeListener(this.handleCameraChange,this)},tearDown:function(){this.removeListener("mousedown","touchstart","touchend","touchmove","mousewheel","DOMMouseScroll","dblclick","keydown","keyup"),this.object&&this.object.removePropertyChangeListener(this.handleCameraChange,this)},beforeUpdate:function(){},setUpdateIntervalTime:function(e){this.updateIntervalTime=e}}),n.SelectionInteraction=function(e){n.BaseInteraction.call(this,e),this.selectUnVisible=!0,this.ctrlDown=!1,this.deleteTimeoutId=null,this._areaPickingLevel=1},n.extend(n.SelectionInteraction,n.BaseInteraction,{constructor:n.SelectionInteraction,setAreaPickingLevel:function(e){this._areaPickingLevel=e},getAreaPickingLevel:function(){return this._areaPickingLevel},setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown")},setFocus:function(e){if(document.activeElement===e)return;var t,n,r=document.documentElement,i=document.body,s;r&&(d.isIE||d.isOpera||r.scrollLeft||r.scrollTop)&&(t=r.scrollLeft,n=r.scrollTop,s=r),e.focus(),s&&(s.scrollLeft=t,s.scrollTop=n)},handle_mousedown:function(e){if(e.stop==1)return;if(p.isRightClick(e))return;this.setFocus(this.network.getView()),this.isCtrlDown(e)?(this.addListener("mousemove","mouseup"),this.ctrlDownEvent=e):this.network.getDataBox().clearSelection();var t=this.network.getElementsByMouseEvent(e),n=this.network.getFirstSelectElement(t);this.network.getDataBox().getSelectionModel().appendSelection(n),this.network.onSelect(n)},handle_mousemove:function(e){var t=this.getBoundingByMouseEvent(e,this.ctrlDownEvent,this.network.devicePixelRatio);this.mousemoved=!0,this.network.areaPickingRect=t,this.network.paintTopCanvas()},handle_mouseup:function(e){this.network.areaPickingRect=null,this.network.paintTopCanvas();var t=this.getBoundingByMouseEvent(e,this.ctrlDownEvent);this.removeListener("mousemove","mouseup"),this.ctrlDownEvent=null;if(t&&this.mousemoved){var n=this.network.getElementsByBounding(t,!0,this._areaPickingLevel),r=new C;if(n.length>0)for(var i=0;i<n.length;i++){var s=n[i].element;this.network.selectable(n[i])&&r.add(s)}r.size()>0&&this.network.getDataBox().getSelectionModel().appendSelection(r)}},getBoundingByMouseEvent:function(e,t,n){if(!e||!t)return;var r=this.network.getView().getBoundingClientRect(),i=e.clientX-r.left,s=e.clientY-r.top,o=t.clientX-r.left,u=t.clientY-r.top,a=n||1,f=Math.min(i,o)*a,l=Math.min(s,u)*a,c=Math.abs(i-o)*a,h=Math.abs(s-u)*a;return c===0&&h===0?null:{x:f,y:l,w:c,h:h}}}),n.TransformGizmo=function(){var e=new n.TransformGizmoMaterial({color:16711680}),r=new n.TransformGizmoMaterial({color:65280}),i=new n.TransformGizmoMaterial({color:255});this.handleGizmos={X:[new n.Cylinder(e,.005,.005,1,4,1,!1,!1),new f(.5,0,0),new f(0,0,-Math.PI/2)],Y:[new n.Cylinder(r,.005,.005,1,4,1,!1,!1),new f(0,.5,0)],Z:[new n.Cylinder(i,.005,.005,1,4,1,!1,!1),new f(0,0,.5),new f(Math.PI/2,0,0)]};var s=!1,o=!1;this.showHelpers=!0,this.showable=!0,this.init=function(){n.Element.call(this),this.handles=new n.Element,this.pickers=new n.Element,this.planes=new n.Element,this.addChild(this.handles),this.addChild(this.pickers),this.addChild(this.planes);var e=new n.BasicMaterial({wireframe:!1,color:65535,side:n.DoubleSide}),t=new n.Plane(e,5e4,5e4,2,2),r={XY:new n.Plane(e,5e4,5e4,2,2),YZ:new n.Plane(e,5e4,5e4,2,2),XZ:new n.Plane(e,5e4,5e4,2,2),XYZE:new n.Plane(e,5e4,5e4,2,2)};r.YZ._rotation.set(0,Math.PI/2,0),r.XZ._rotation.set(-Math.PI/2,0,0);for(var i in r)r[i].name=i,this.planes.addChild(r[i]),this.planes[i]=r[i],r[i]._visible=!0;for(var i in this.handleGizmos){var s=this.handleGizmos[i][0];s.name=i,this.handleGizmos[i][1]&&s._position.set(this.handleGizmos[i][1].x,this.handleGizmos[i][1].y,this.handleGizmos[i][1].z),this.handleGizmos[i][2]&&s._rotation.set(this.handleGizmos[i][2].x,this.handleGizmos[i][2].y,this.handleGizmos[i][2].z),s.mode=this.mode,this.handles.addChild(s);if(this.pickerGizmos&&this.pickerGizmos[i]){var o=this.pickerGizmos[i][0];this.pickerGizmos[i][1]&&o._position.set(this.pickerGizmos[i][1].x,this.pickerGizmos[i][1].y,this.pickerGizmos[i][1].z),this.pickerGizmos[i][2]&&o._rotation.set(this.pickerGizmos[i][2].x,this.pickerGizmos[i][2].y,this.pickerGizmos[i][2].z)}else var o=s.clone();o.mode=this.mode,o.name=i,this.pickers.addChild(o)}this.iterator(function(e){e instanceof n.Entity&&n.Utils.transformElement(e)})},this.hide=function(){this.handles.getChildren().forEach(function(e){e._visible=!1}),this.pickers.getChildren().forEach(function(e){e._visible=!1}),this.planes.getChildren().forEach(function(e){e._visible=!1})},this.show=function(){var e=this;this.handles.getChildren().forEach(function(t){t._visible=e.showHelpers&&e.showable}),this.pickers.getChildren().forEach(function(e){e._visible=s}),this.activePlane&&(this.activePlane._visible=o)},this.highlight=function(e){var r;for(var i in this.handleGizmos)r=this.handleGizmos[i][0],r.oldColor&&(r.material instanceof n.ArrayMaterial?(r.material.materials[0].color.copy(r.oldColor),r.material.materials[0].opacity=r.oldOpacity):(r.material.color.copy(r.oldColor),r.material.opacity=r.oldOpacity),r.oldColor=null);this.handleGizmos[e]&&(r=this.handleGizmos[e][0],r.material instanceof n.ArrayMaterial?(r.oldColor=r.oldColor||r.material.materials[0].color.clone(),r.oldOpacity=r.oldOpacit!==t?r.oldOpacity:r.material.materials[0].opacity,r.material.materials[0].opacity=1):(r.oldColor=r.oldColor||r.material.color.clone(),r.oldOpacity=r.material.opacity,r.setStyle("material.opacity",1)))},this.init()},n.TransformGizmo.prototype=Object.create(n.Element.prototype),n.TransformGizmo.prototype.update=function(e,t){var n=new f(0,0,0),r=new f(0,1,0),i=new h;for(var s=0;s<this.getChildren().size();s++)for(var o=0;o<this.getChildren().get(s).getChildren().size();o++){var u=this.getChildren().get(s).getChildren().get(o);u.name.search("E")!=-1?(u.quaternion.setFromRotationMatrix(i.lookAt(t,n,r)),u._rotation.setEulerFromQuaternion(u.quaternion)):(u.quaternion.setFromEuler(e),u._rotation.setEulerFromQuaternion(u.quaternion))}},n.TransformGizmoTranslate=function(){n.TransformGizmo.call(this);var e=new n.TransformGizmoMaterial({color:16711680,opacity:.2}),t=new n.TransformGizmoMaterial({color:65280,opacity:.2}),r=new n.TransformGizmoMaterial({color:255,opacity:.2}),i=new n.Arrow(e,1,.03,.2,.05,30),s=new n.Arrow(t,1,.03,.2,.05,30),o=new n.Arrow(r,1,.03,.2,.05,30),u=new n.TransformGizmoMaterial({color:255,opacity:.5}),a=new n.TransformGizmoMaterial({color:16711680,opacity:.5}),l=new n.TransformGizmoMaterial({color:65280,opacity:.5}),c=new n.TransformGizmoMaterial({color:16777215,opacity:.5}),p=new n.Circle(u,.5,10,0,Math.PI/2),d=new n.Circle(a,.5,10,0,Math.PI/2),v=new n.Circle(l,.5,10,0,Math.PI/2),m=new n.Octahedron(c,1e-4,0);this.handleGizmos={X:[i,new f(1.6,0,0),new f(0,0,-Math.PI/2)],Y:[s,new f(0,1.6,0)],Z:[o,new f(0,0,1.6),new f(Math.PI/2,0,0)],XYZ:[m],XY:[p,new f(0,0,0)],YZ:[d,new f(0,0,0),new f(Math.PI/2,Math.PI/2,0)],XZ:[v,new f(0,0,0),new f(Math.PI/2,0,0)]};var c=new n.TransformGizmoMaterial({color:16711680,opacity:.25}),g=new n.TransformGizmoMaterial({color:65280,opacity:.25}),y=new n.TransformGizmoMaterial({color:255,opacity:.25}),b=new n.Cylinder(c,.075,0,1.2,4,1,!1),w=new n.Cylinder(g,.075,0,1.2,4,1,!1),E=new n.Cylinder(y,.075,0,1.2,4,1,!1),m=new n.Octahedron(c,1e-4,0);this.pickerGizmos={X:[b,new f(1.6,0,0),new f(0,0,-Math.PI/2)],Y:[w,new f(0,1.6,0)],Z:[E,new f(0,0,1.6),new f(Math.PI/2,0,0)],XYZ:[m]},this.setActivePlane=function(e,t){var n=new h;t.applyProjection(n.getInverse(n.extractRotation(this.planes.XY.worldMatrix))),e=="X"&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),e=="Y"&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),e=="Z"&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),e=="XYZ"&&(this.activePlane=this.planes.XYZE),e=="XY"&&(this.activePlane=this.planes.XY),e=="YZ"&&(this.activePlane=this.planes.YZ),e=="XZ"&&(this.activePlane=this.planes.XZ),this.hide(),this.show()},this.init()},n.TransformGizmoTranslate.prototype=Object.create(n.TransformGizmo.prototype),n.TransformGizmoTranslate.prototype.mode="translate",n.TransformGizmoRotate=function(){n.TransformGizmo.call(this);var e=new n.TransformGizmoMaterial({color:16711680,opacity:.2}),t=new n.TransformGizmoMaterial({color:65280,opacity:.2}),r=new n.TransformGizmoMaterial({color:255,opacity:.2}),i=new n.TransformGizmoMaterial({color:16776960}),s=new n.TransformGizmoMaterial({color:7895160,opacity:.25}),s=new n.TransformGizmoMaterial({color:16711680}),o=new n.Torus(e,1,.02,4,32,Math.PI),u=new n.Torus(t,1,.02,4,32,Math.PI),a=new n.Torus(r,1,.02,4,32,Math.PI),l=new n.Torus(i,1.25,.01,4,64),c=new n.Torus(s,1,.01,4,64);this.handleGizmos={X:[o,new f(0,0,0),new f(0,-Math.PI/2,-Math.PI/2)],Y:[u,new f(0,0,0),new f(Math.PI/2,0,0)],Z:[a,new f(0,0,0),new f(0,0,-Math.PI/2)]};var p=new n.TransformGizmoMaterial({color:16711680,opacity:.25}),d=new n.TransformGizmoMaterial({color:65280,opacity:.25}),v=new n.TransformGizmoMaterial({color:255,opacity:.25}),m=new n.TransformGizmoMaterial({color:983040,opacity:.25}),g=new n.Torus(p,1,.05,4,12,Math.PI),y=new n.Torus(d,1,.05,4,12,Math.PI),b=new n.Torus(v,1,.05,4,12,Math.PI),w=new n.Torus(m,1,.05,2,24);this.pickerGizmos={X:[g,new f(0,0,0),new f(0,-Math.PI/2,-Math.PI/2)],Y:[y,new f(0,0,0),new f(Math.PI/2,0,0)],Z:[b,new f(0,0,0),new f(0,0,-Math.PI/2)]},this.setActivePlane=function(e){e=="E"&&(this.activePlane=this.planes.XYZE),e=="X"&&(this.activePlane=this.planes.YZ),e=="Y"&&(this.activePlane=this.planes.XZ),e=="Z"&&(this.activePlane=this.planes.XY),this.hide(),this.show()},this.update=function(e,t){n.TransformGizmo.prototype.update.apply(this,arguments);var r={handles:this.handles,pickers:this.pickers},i=new h,s=new n.Euler(0,0,1),o=new n.Quat,u=new f(1,0,0),a=new f(0,1,0),l=new f(0,0,1),c=new n.Quat,p=new n.Quat,d=new n.Quat,v=t.clone();s.copy(this.planes.XY._rotation),o.setFromEuler(s),i.makeRotationFromQuaternion(o).getInverse(i),v.applyProjection(i);for(var m in r)for(var g=0;g<r[m].getChildren().size;g++){var y=r[m].getChildren().get(g);o.setFromEuler(s),y.name=="X"&&(c.setFromAxisAngle(u,Math.atan2(-v.y,v.z)),o.multiplyQuaternions(o,c),y.quaternion.copy(o)),y.name=="Y"&&(p.setFromAxisAngle(a,Math.atan2(v.x,v.z)),o.multiplyQuaternions(o,p),y.quaternion.copy(o)),y.name=="Z"&&(d.setFromAxisAngle(l,Math.atan2(v.y,v.x)),o.multiplyQuaternions(o,d),y.quaternion.copy(o))}},this.init()},n.TransformGizmoRotate.prototype=Object.create(n.TransformGizmo.prototype),n.TransformGizmoRotate.prototype.mode="rotate",n.TransformGizmoScale=function(){n.TransformGizmo.call(this);var e=new n.TransformGizmoMaterial({color:11184810,opacity:1}),t=new n.TransformGizmoMaterial({color:16711680,opacity:.2}),r=new n.TransformGizmoMaterial({color:65280,opacity:.2}),i=new n.TransformGizmoMaterial({color:255,opacity:.2}),s=new n.Cube(e,.25,.25,.25),o=new n.Cylinder(null,.1,.1,1,4,1,!1),u=new n.Cube(e,.225,.225,.225),a=new n.Cylinder(null,.1,0,1,20,1,!0);a._position.y=.05;var a=n.Utils.createElement(o,a,t),l=n.Utils.createElement(o,a,r),c=n.Utils.createElement(o,a,i),p=new n.Cylinder(t,.08,0,1,4,1,!1),d=new n.Cylinder(r,.08,0,1,4,1,!1),v=new n.Cylinder(i,.08,0,1,4,1,!1),m=new n.Element;m.material=new n.BasicMaterial;var g=new n.Element;g.material=new n.BasicMaterial;var y=new n.Element;y.material=new n.BasicMaterial,this.handleGizmos={X:[p,new f(.5,0,0),new f(0,0,-Math.PI/2)],Y:[d,new f(0,.5,0)],Z:[v,new f(0,0,.5),new f(Math.PI/2,0,0)],XY:[m],YZ:[g],XZ:[y],XYZ:[s]};var b=new n.TransformGizmoMaterial({color:16711680,opacity:.25}),w=new n.TransformGizmoMaterial({color:65280,opacity:.25}),E=new n.TransformGizmoMaterial({color:255,opacity:.25}),S=new n.Cylinder(b,.125,0,1,4,1,!1),x=new n.Cylinder(w,.125,0,1,4,1,!1),T=new n.Cylinder(E,.125,0,1,4,1,!1);this.pickerGizmos={X:[S,new f(.6,0,0),new f(Math.PI/4,0,-Math.PI/2)],Y:[x,new f(0,.6,0),new f(0,Math.PI/4,0)],Z:[T,new f(0,0,.6),new f(Math.PI/2,Math.PI/4,0)],XYZ:[u]},this.setActivePlane=function(e,t){var n=new h;t.applyProjection(n.getInverse(n.extractRotation(this.planes.XY.worldMatrix))),e=="X"?(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)):e=="Y"?(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)):e=="Z"?(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)):e=="XYZ"?this.activePlane=this.planes.XYZE:this.activePlane=this.planes[e],this.hide(),this.show()},this.init()},n.TransformGizmoScale.prototype=Object.create(n.TransformGizmo.prototype),n.TransformGizmoScale.prototype.mode="scale",n.EditInteraction=function(r){function $(t){if(a.network._keyboardRemoveEnabled&&t.keyCode==46&&r.getDataBox().getSelectionModel().size()>0){var n="Delete?";e.confirm(n)&&r.getDataBox().removeSelection()}}function J(t){t.touches.length===1&&(a.deleteTimeoutId=setTimeout(function(){var n=a.network.getElementsByMouseEvent(t,a.selectUnVisible);if(n.length>0){var r=n[0],i="Delete?";e.confirm(i)&&a.network.getDataBox().remove(r.element)}},1e3))}function K(e){clearTimeout(a.deleteTimeoutId)}function Q(e){clearTimeout(a.deleteTimeoutId)}function G(e){a.update()}function Y(e){if(!a.object||l)return;e.preventDefault(),e.stopPropagation();var t=e.touches?e.touches[0]:e,n=at(t,a.filterIntersectPicker(a.pickers));if(n)a.axis=n.object.name,a.setMode(n.object.mode);else{var r=rt(e);r===a.object||r!=null&&r.editTransformToParent&&r.isDescendantOf(a.object)?(a.axis=a.getAxis(),a.setMode(a.getMode())):a.axis=!1}a.update(!0)}function tt(e){if(e.stop)return;et.set(e.clientX,e.clientY);if(!a.showHelpers||!a.axis)ut(e),Y(e);if(!a.object||l){a.network.dirtyNetwork();return}e.preventDefault(),e.stopPropagation();var n=e.touches?e.touches[0]:e;if(n.button===0||n.button==t){var i=a.filterIntersectPicker(a.pickers),s=at(n,i),o=rt(e);s||(o===a.object||o!=null&&o.editTransformToParent&&o.isDescendantOf(a.object))&&a.getDefaultPickers()&&(s={object:a.getDefaultPickers()});if(s){a.axis=s.object.name,N.copy(X).sub(U).normalize(),a.gizmo[c].setActivePlane(a.axis,N);var u=at(n,[a.gizmo[c].activePlane]);!u&&o&&(u=at(n,[o]));if(u){j.copy(a.object._position),F.copy(a.object._scale),I.extractRotation(a.object.matrix),W.extractRotation(a.object.worldMatrix);var f=a.object.getParent();f==t&&(f=r),q.extractRotation(f.worldMatrix),R.getScaleFromMatrix(C.getInverse(f.worldMatrix)),w.copy(u.point)}}}a.update(!0),l=!0}function nt(e){if(!a.object||!a.axis||!l)return;e.preventDefault(),e.stopPropagation(),e.stop=!0;var t=e.touches?e.touches[0]:e,n=at(t,[a.gizmo[c].activePlane]);n||(n=at(t,[a.object]));if(n){a.moving?r.fireInteractionEvent({kind:"liveMoveBetween",event:zr}):(r.fireInteractionEvent({kind:"liveMoveStart",event:zr}),a.moving=!0),b.copy(n.point);if(c=="translate"&&a.translateable){b.sub(w),b.multiply(R),a.space=="local"&&(b.applyMatrix4(C.getInverse(W)),a.axis.search("X")==-1&&(b.x=0),a.axis.search("Y")==-1&&(b.y=0),a.axis.search("Z")==-1&&(b.z=0),b.applyMatrix4(I),a.object.setPosition(j.clone().add(b)));if(a.space=="world"||a.axis.search("XYZ")!=-1){a.axis.search("X")==-1&&(b.x=0),a.axis.search("Y")==-1&&(b.y=0),a.axis.search("Z")==-1&&(b.z=0),b.applyMatrix4(C.getInverse(q)),a.object._position.copy(j);var i=a.object._position.clone().add(b);a.snap&&(a.axis.search("X")!=-1&&(i.x=Math.round(a.object._position.x/a.snap)*a.snap),a.axis.search("Y")!=-1&&(i.y=Math.round(a.object._position.y/a.snap)*a.snap),a.axis.search("Z")!=-1&&(i.z=Math.round(a.object._position.z/a.snap)*a.snap)),a.object.setPosition(i)}}else if(c=="scale"&&a.scaleable){b.sub(w),b.multiply(R);var s=a.object._scale.clone(),o=(a.scaleRate||1)/10;if(a.axis=="XYZ")h=1+b.y*o,s.x=F.x*h,s.y=F.y*h,s.z=F.z*h;else if(a.axis==="XY"){var u=1+b.x*o,f=1+b.y*o;if(a.forceSameScale){var h=Math.max(u,f);s.x=F.x*h,s.y=F.y*h}else s.x=F.x*u,s.y=F.y*f}else if(a.axis==="YZ"){var p=1+b.z*o,f=1+b.y*o;if(a.forceSameScale){var h=Math.max(p,f);s.z=F.z*h,s.y=F.y*h}else s.z=F.z*p,s.y=F.y*f}else if(a.axis==="XZ"){var u=1+b.x*o,p=1+b.z*o;if(a.forceSameScale){var h=Math.max(u,f);s.x=F.x*h,s.z=F.z*h}else s.x=F.x*u,s.z=F.z*p}else b.applyMatrix4(C.getInverse(W)),a.axis=="X"&&(s.x=F.x*(1+b.x*o)),a.axis=="Y"&&(s.y=F.y*(1+b.y*o)),a.axis=="Z"&&(s.z=F.z*(1+b.z*o));a.object.setScale(s)}else if(c=="rotate"&&a.rotateable){b.sub(U),b.multiply(R),k.copy(w).sub(U),k.multiply(R);if(a.axis=="E")b.applyMatrix4(C.getInverse(T)),k.applyMatrix4(C.getInverse(T)),E.set(Math.atan2(b.z,b.y),Math.atan2(b.x,b.z),Math.atan2(b.y,b.x)),S.set(Math.atan2(k.z,k.y),Math.atan2(k.x,k.z),Math.atan2(k.y,k.x)),L.setFromRotationMatrix(C.getInverse(q)),B.setFromAxisAngle(N,E.z-S.z),_.setFromRotationMatrix(W),L.multiplyQuaternions(L,B),L.multiplyQuaternions(L,_),a.object.quaternion.copy(L);else if(a.axis=="XYZE")B.setFromEuler(b.clone().cross(k).normalize()),L.setFromRotationMatrix(C.getInverse(q)),D.setFromAxisAngle(B,-b.clone().angleTo(k)),_.setFromRotationMatrix(W),L.multiplyQuaternions(L,D),L.multiplyQuaternions(L,_),a.object.quaternion.copy(L);else if(a.space=="local"){b.applyMatrix4(C.getInverse(W)),k.applyMatrix4(C.getInverse(W)),E.set(Math.atan2(b.z,b.y),Math.atan2(b.x,b.z),Math.atan2(b.y,b.x)),S.set(Math.atan2(k.z,k.y),Math.atan2(k.x,k.z),Math.atan2(k.y,k.x)),_.setFromRotationMatrix(I),D.setFromAxisAngle(A,E.x-S.x),P.setFromAxisAngle(O,E.y-S.y),H.setFromAxisAngle(M,E.z-S.z),a.axis=="X"&&_.multiplyQuaternions(_,D),a.axis=="Y"&&_.multiplyQuaternions(_,P),a.axis=="Z"&&_.multiplyQuaternions(_,H),a.object.quaternion.copy(_);var d=a.object._rotation.clone();d.setEulerFromQuaternion(_),a.object.setRotation(d)}else if(a.space=="world"){E.set(Math.atan2(b.z,b.y),Math.atan2(b.x,b.z),Math.atan2(b.y,b.x)),S.set(Math.atan2(k.z,k.y),Math.atan2(k.x,k.z),Math.atan2(k.y,k.x)),L.setFromRotationMatrix(C.getInverse(q)),D.setFromAxisAngle(A,E.x-S.x),P.setFromAxisAngle(O,E.y-S.y),H.setFromAxisAngle(M,E.z-S.z),_.setFromRotationMatrix(W),a.axis=="X"&&L.multiplyQuaternions(L,D),a.axis=="Y"&&L.multiplyQuaternions(L,P),a.axis=="Z"&&L.multiplyQuaternions(L,H),L.multiplyQuaternions(L,_),a.object.quaternion.copy(L);var d=a.object._rotation.clone();d.setEulerFromQuaternion(L),a.object.setRotation(d)}}a.changed=!0}a.update(!0),a.updateTextNote(e,a.object)}function rt(e){var t=a.network.getElementsByMouseEvent(e);return r.getFirstEditElement(t)}function it(e){if(e instanceof n.ArrayMaterial){var t=m.materials;for(var r in t)it(t[r])}else e.orignalDepthTest=e.depthTest,e.orignalDepthMask=e.depthMask,e.depthTest=!1,e.depthMask=!1}function st(e){if(e instanceof n.ArrayMaterial){var t=m.materials;for(var r in t)st(t[r])}else e.depthTest=e.orignalDepthTest,e.depthMask=e.orignalDepthMask}function ot(e){return e&&e.editTransformToParent&&e.getParent()?ot(e.getParent()):e}function ut(e){Z===null&&(Z=new o),Z.set(e.clientX,e.clientY),r.getDataBox().clearEditing();if(Z.distanceTo(et)===0){var t=a.network.getElementsByMouseEvent(e),n=r.getFirstEditElement(t);n&&(n!==a.object,a.object=n,a.translateable&&a.gizmo.translate.show(),a.rotateable&&a.gizmo.rotate.show(),a.scaleable&&a.gizmo.scale.show()),n||(a.gizmo[c].hide(),a.gizmo.translate.hide(),a.gizmo.rotate.hide(),a.gizmo.scale.hide(),a.object=null)}else a.changed&&a.onElementPropertyChanged&&(a.changed=!1,a.moving=!1,a.onElementPropertyChanged(e,a.object),r.fireInteractionEvent({kind:"liveMoveEnd",event:{e:e,source:a.object,time:(new Date).getTime()}}));a.axis=!1,l=!1,a.update(!0),a.hideTextNote()}function at(e,t){if(!t)return null;var n=a.network.getPickingByEvent(e),r=n.intersectObjects(t,!0,!0);return r[0]?r[0]:!1}n.BaseInteraction.call(this,r);var i=new n.Element,s=r.getCamera(),u=r.getRootView();u=u!==t?u:document,this.domElement=u,this.gizmo={},this.gizmo.translate=new n.TransformGizmoTranslate,this.gizmo.rotate=new n.TransformGizmoRotate,this.gizmo.scale=new n.TransformGizmoScale,i.addChild(this.gizmo.translate),i.addChild(this.gizmo.rotate),i.addChild(this.gizmo.scale),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.object=!1,this.snap=!1,this.space="local",this.size=1,this.axis=!1;var a=this;this.scaleable=!0,this.rotateable=!0,this.translateable=!0,this.setShowHelpers(!0);var l=!1,c="translate",p="XY",d={type:"change"},v=new n.Picking,g=new n.Projector,y=new f,b=new f,w=new f,E=new f,S=new f,x=1,T=new h,N=new f,C=new h,k=new f,L=new n.Quat,A=new f(1,0,0),O=new f(0,1,0),M=new f(0,0,1),_=new n.Quat,D=new n.Quat,P=new n.Quat,H=new n.Quat,B=new n.Quat,j=new f,F=new f,I=new h,q=new h,R=new f,U=new f,z=new n.Euler,W=new h,X=new f,V=new n.Euler;this.showNote=!0,this.handleDataBoxChange=function(e){e.kind=="remove"?e.data==a.object&&(a.gizmo.translate.hide(),a.gizmo.rotate.hide(),a.gizmo.scale.hide()):e.kind=="clear"&&(a.gizmo.translate.hide(),a.gizmo.rotate.hide(),a.gizmo.scale.hide())},this.network.getDataBox().addDataBoxChangeListener(this.handleDataBoxChange,this),this.network.addPropertyChangeListener(function(e){if(e.property=="dataBox"){var t=e.oldValue,n=e.value;t.removeDataBoxChangeListener(this.handleDataBoxChange),n.addDataBoxChangeListener(this.handleDataBoxChange,this)}}),this.defaultMode="TranslateXY",this.pickers=[],this.gizmo.translate.pickers.getChildren().forEach(function(e){a.pickers.push(e)}),this.gizmo.rotate.pickers.getChildren().forEach(function(e){a.pickers.push(e)}),this.gizmo.scale.pickers.getChildren().forEach(function(e){a.pickers.push(e)}),this.attach=function(e){a.object=e,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[c].show(),a.update()},this.detach=function(e){a.object=!1,this.axis=!1,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide()},this
.setMode=function(e){c=e?e:c,this.update()},this.setUp=function(){u.addEventListener("mousedown",tt,!1),u.addEventListener("touchstart",tt,!1),u.addEventListener("mousemove",Y,!1),u.addEventListener("touchmove",Y,!1),u.addEventListener("mousemove",nt,!1),u.addEventListener("touchmove",nt,!1),u.addEventListener("mouseup",ut,!1),u.addEventListener("mouseout",ut,!1),u.addEventListener("touchend",ut,!1),u.addEventListener("touchcancel",ut,!1),u.addEventListener("touchleave",ut,!1),u.addEventListener("keydown",$,!1),u.addEventListener("touchstart",J,!1),u.addEventListener("touchmove",K,!1),u.addEventListener("touchend",Q,!1),u.addEventListener("mousewheel",G,!1),a.network.helperBox.addByDescendant(i)},this.tearDown=function(){u.removeEventListener("mousedown",tt,!1),u.removeEventListener("touchstart",tt,!1),u.removeEventListener("mousemove",Y,!1),u.removeEventListener("touchmove",Y,!1),u.removeEventListener("mousemove",nt,!1),u.removeEventListener("touchmove",nt,!1),u.removeEventListener("mouseup",ut,!1),u.removeEventListener("mouseout",ut,!1),u.removeEventListener("touchend",ut,!1),u.removeEventListener("touchcancel",ut,!1),u.removeEventListener("touchleave",ut,!1),u.removeEventListener("keydown",$,!1),u.removeEventListener("touchstart",J,!1),u.removeEventListener("touchmove",K,!1),u.removeEventListener("touchend",Q,!1),u.removeEventListener("mousewheel",G,!1),a.gizmo.translate.hide(),a.gizmo.rotate.hide(),a.gizmo.scale.hide(),a.network.helperBox.removeByDescendant(i)},this.setSnap=function(e){a.snap=e},this.setSize=function(e){a.size=e,this.update()},this.setSpace=function(e){a.space=e,this.update()},this.update=function(e){if(!a.object)return;a.object.updateWorldMatrix(),U.getPositionFromMatrix(a.object.worldMatrix),z.setFromRotationMatrix(C.extractRotation(a.object.worldMatrix)),s.updateWorldMatrix(),X.getPositionFromMatrix(s.worldMatrix),V.setFromRotationMatrix(C.extractRotation(s.worldMatrix)),x=U.distanceTo(X)/12*a.size,i.setPosition(U),i.setScale(x,x,x),N.copy(X).sub(U).normalize(),this.gizmo.scale.update(z,N),a.space=="local"?(this.gizmo.translate.update(z,N),this.gizmo.rotate.update(z,N)):(this.gizmo.translate.update(new n.Euler,N),this.gizmo.rotate.update(new n.Euler,N)),this.gizmo.translate.highlight(null),this.gizmo.rotate.highlight(null),this.gizmo.scale.highlight(null),this.gizmo[c].highlight(a.axis),i.updateWorldMatrix(!0),e&&a.network.dirtyNetwork()},this.getDefaultPickers=function(){return this.defaultMode==="TranslateX"?a.gizmo.translate.pickers.getChildren().get(0):this.defaultMode==="TranslateY"?a.gizmo.translate.pickers.getChildren().get(1):this.defaultMode==="TranslateZ"?a.gizmo.translate.pickers.getChildren().get(2):this.defaultMode==="TranslateXY"?a.gizmo.translate.pickers.getChildren().get(4):this.defaultMode==="TranslateYZ"?a.gizmo.translate.pickers.getChildren().get(5):this.defaultMode==="TranslateXZ"?a.gizmo.translate.pickers.getChildren().get(6):this.defaultMode==="TranslateXYZ"?a.gizmo.translate.pickers.getChildren().get(3):this.defaultMode==="RotateX"?a.gizmo.rotate.pickers.getChildren().get(0):this.defaultMode==="RotateY"?a.gizmo.rotate.pickers.getChildren().get(1):this.defaultMode==="RotateZ"?a.gizmo.rotate.pickers.getChildren().get(2):this.defaultMode==="ScaleX"?a.gizmo.scale.pickers.getChildren().get(0):this.defaultMode==="ScaleY"?a.gizmo.scale.pickers.getChildren().get(1):this.defaultMode==="ScaleZ"?a.gizmo.scale.pickers.getChildren().get(2):this.defaultMode==="ScaleXYZ"?a.gizmo.scale.pickers.getChildren().get(6):this.defaultMode==="ScaleXY"?a.gizmo.scale.pickers.getChildren().get(3):this.defaultMode==="ScaleYZ"?a.gizmo.scale.pickers.getChildren().get(4):this.defaultMode==="ScaleXZ"?a.gizmo.scale.pickers.getChildren().get(5):null},this.getMode=function(){var e=this.defaultMode;return e.startsWith("Translate")?"translate":e.startsWith("Rotate")?"rotate":e.startsWith("Scale")?"scale":"translate"},this.getAxis=function(){var e=this.defaultMode;return e.endsWith("XYZ")?"XYZ":e.endsWith("XY")?"XY":e.endsWith("YZ")?"YZ":e.endsWith("XZ")?"XZ":e.endsWith("Y")?"X":e.endsWith("Y")?"Y":e.endsWith("Z")?"Z":""};var Z=null,et=new o;this.filterIntersectPicker=function(e){var t=[];if(!this.showHelpers)return t;for(var n=0;n<e.length;n++){var r=e[n];r.getParent()===this.gizmo.translate.pickers&&this.translateable&&t.push(r),r.getParent()===this.gizmo.rotate.pickers&&this.rotateable&&t.push(r),r.getParent()===this.gizmo.scale.pickers&&this.scaleable&&t.push(r)}return t}},n.extend(n.EditInteraction,n.BaseInteraction,{setShowHelpers:function(e){this.showHelpers=e,this.gizmo.translate.showHelpers=e,this.gizmo.rotate.showHelpers=e,this.gizmo.scale.showHelpers=e,this.resetHelpers()},onElementPropertyChanged:function(e,t){},resetHelpers:function(){this.showHelpers&&this.translateable&&this.object?this.gizmo.translate.show():this.gizmo.translate.hide(),this.showHelpers&&this.rotateable&&this.object?this.gizmo.rotate.show():this.gizmo.rotate.hide(),this.showHelpers&&this.scaleable&&this.object?this.gizmo.scale.show():this.gizmo.scale.hide(),this.update(!0)},setShowNote:function(e){this.showNote=e},setScaleable:function(e){this.scaleable=e,this.gizmo.scale.showable=e,this.resetHelpers()},setRotateable:function(e){this.rotateable=e,this.gizmo.rotate.showable=e,this.resetHelpers()},setTranslateable:function(e){this.translateable=e,this.gizmo.translate.showable=e,this.resetHelpers()},setDefaultMode:function(e){this.defaultMode=e},setScaleRate:function(e){this.scaleRate=e||1},setForceSameScale:function(e){this.forceSameScale=e},setSpaceMode:function(e){e=="world"?this.space="world":this.space="local",this.update()},createTextNote:function(){this.textNote=document.createElement("div"),this.textNote.style.position="relative",this.textNote.style.color="black",this.textNote.style.height="0px",this.textNote.style.zIndex="1000",this.domElement.appendChild(this.textNote);var e=document.createElement("table");this.noteTable=e,this.textNote.appendChild(this.noteTable);var t=e.createTHead();e.style.borderLeft="1px solid #ffa500",e.style.borderTop="1px solid #ffa500",e.style.fontSize="14px",e.style.backgroundColor="rgba(255, 170, 13, 0.5)",e.setAttribute("border",0),e.setAttribute("cellspacing",0),e.setAttribute("cellpadding",0);for(var n=0;n<4;n++){var r=document.createElement("tr");for(var i=0;i<4;i++){var s=document.createElement("td");s.style.borderRight="1px solid #ffa500",s.style.borderBottom="1px solid #ffa500",s.style.paddingLeft="5px",s.style.paddingRight="5px",s.style.paddingTop="2px",s.style.paddingBottom="2px",n==0&&i>0||n>0&&i==0?(s.style.textAlign="center",s.style.fontWeight="bold"):s.style.textAlign="right",r.appendChild(s)}e.appendChild(r)}},showTextNote:function(){if(!this.showNote)return;this.textNote==null&&this.createTextNote(),this.textNote.style.display=""},hideTextNote:function(){this.textNote&&(this.textNote.style.display="none")},updateTextNote:function(e,t){if(t==null||!this.showNote)return;var n=this.network.getRootView().getBoundingClientRect();this.showTextNote(),this.textNote.style.top=e.clientY-n.top+20+"px",this.textNote.style.left=e.clientX-n.left+20+"px";var r=t.getRotation(),i=t.getPosition(),s=t.getScale(),o=[[" ","x","y","z"],["p",i.x,i.y,i.z],["r",r.x,r.y,r.z],["s",s.x,s.y,s.z]],u=this.noteTable;for(var a=0;a<4;a++)for(var f=0;f<4;f++){var l=o[a][f];a>0&&f>0&&(a==2?l=(l*180/Math.PI).toFixed(0)+"&deg;":l=l.toFixed(2)),u.rows[a].cells[f].innerHTML=""+l}}});var yi=1e-5,bi=0,wi=1,Ei=2,Si=3;n.CSG=function(e){var t,r,i,s,u,a,f,l=[],c;if(!(e instanceof n.Element)){if(e instanceof Ni)return this.tree=e,this.matrix=new h,this;throw"TGL.CSG: Given geometry is unsupported"}e.computeNodeData&&e.computeNodeData(),e.updateWorldMatrix(!0),this.matrix=e.worldMatrix.clone();for(t=0,r=e.faces.length;t<r;t++){i=e.faces[t],u=e.uvs[t],a=e.uv2s[t],f=new xi;if(i instanceof O)s=e.vertices[i.a],s=new Ti(s.x,s.y,s.z,i.vertexNormals[0],new o(u[0].x,u[0].y),a[0].clone()),s.materialIndex=i.materialIndex,s.applyMatrix4(this.matrix),f.vertices.push(s),s=e.vertices[i.b],s=new Ti(s.x,s.y,s.z,i.vertexNormals[1],new o(u[1].x,u[1].y),a[1].clone()),s.materialIndex=i.materialIndex,s.applyMatrix4(this.matrix),f.vertices.push(s),s=e.vertices[i.c],s=new Ti(s.x,s.y,s.z,i.vertexNormals[2],new o(u[2].x,u[2].y),a[2].clone()),s.applyMatrix4(this.matrix),s.materialIndex=i.materialIndex,f.vertices.push(s);else{if(!(i instanceof M))throw"Invalid face type at index "+t;s=e.vertices[i.a],s=new Ti(s.x,s.y,s.z,i.vertexNormals[0],new o(u[0].x,u[0].y),a[0].clone()),s.materialIndex=i.materialIndex,s.applyMatrix4(this.matrix),f.vertices.push(s),s=e.vertices[i.b],s=new Ti(s.x,s.y,s.z,i.vertexNormals[1],new o(u[1].x,u[1].y),a[1].clone()),s.materialIndex=i.materialIndex,s.applyMatrix4(this.matrix),f.vertices.push(s),s=e.vertices[i.c],s=new Ti(s.x,s.y,s.z,i.vertexNormals[2],new o(u[2].x,u[2].y),a[2].clone()),s.materialIndex=i.materialIndex,s.applyMatrix4(this.matrix),f.vertices.push(s),s=e.vertices[i.d],s=new Ti(s.x,s.y,s.z,i.vertexNormals[3],new o(u[3].x,u[3].y),a[3].clone()),s.applyMatrix4(this.matrix),s.materialIndex=i.materialIndex,f.vertices.push(s)}isNaN(f.calculateProperties().w)?console.log("Not right polygon"):l.push(f)}this.tree=new Ni(l),this.tree.materialSize=e.getMaterialSize?e.getMaterialSize():0;if(e.material instanceof n.ArrayMaterial)this.tree.material=e.material;else{var p=new n.ArrayMaterial;this.tree.material=p;for(var t=0;t<this.tree.materialSize;t++)p.push(e.material)}},n.CSG.prototype.substract=function(e){var t=this.tree.clone(),r=e.tree.clone();return t.sumMateriaSize(r),t.invert(),t.clipTo(r),r.clipTo(t),r.invert(),r.clipTo(t),r.invert(),t.build(r.allPolygons()),t.invert(),t=new n.CSG(t),t.matrix=this.matrix,t},n.CSG.prototype.union=function(e){var t=this.tree.clone(),r=e.tree.clone();return t.sumMateriaSize(r),t.clipTo(r),r.clipTo(t),r.invert(),r.clipTo(t),r.invert(),t.build(r.allPolygons()),t=new n.CSG(t),t.matrix=this.matrix,t},n.CSG.prototype.intersect=function(e){var t=this.tree.clone(),r=e.tree.clone();return t.sumMateriaSize(r),t.invert(),r.clipTo(t),r.invert(),t.clipTo(r),r.clipTo(t),t.build(r.allPolygons()),t.invert(),t=new n.CSG(t),t.matrix=this.matrix,t},n.CSG.prototype.inverse=function(){var e=this.tree.clone();return e.polygons.map(function(e){e.flip()}),e=new n.CSG(e),e},n.CSG.prototype.toGeometry=function(e){var t,r,i=(new h).getInverse(this.matrix),s=new n.Entity(this.tree.material,e),u=this.tree.allPolygons(),a=u.length,l,c,p={},d,v,m,g,y,b,w;for(t=0;t<a;t++){l=u[t],c=l.vertices.length;for(r=2;r<c;r++){b=[],w=[],g=l.vertices[0],b.push(new o(g.uv.x,g.uv.y)),w.push(g.uv2.clone());var E=g.materialIndex;g=new f(g.x,g.y,g.z),typeof p[g.x+","+g.y+","+g.z]!="undefined"?d=p[g.x+","+g.y+","+g.z]:(s.vertices.push(g),d=p[g.x+","+g.y+","+g.z]=s.vertices.length-1),g=l.vertices[r-1],b.push(new o(g.uv.x,g.uv.y)),w.push(g.uv2.clone()),g=new f(g.x,g.y,g.z),typeof p[g.x+","+g.y+","+g.z]!="undefined"?v=p[g.x+","+g.y+","+g.z]:(s.vertices.push(g),v=p[g.x+","+g.y+","+g.z]=s.vertices.length-1),g=l.vertices[r],b.push(new o(g.uv.x,g.uv.y)),w.push(g.uv2.clone()),g=new f(g.x,g.y,g.z),typeof p[g.x+","+g.y+","+g.z]!="undefined"?m=p[g.x+","+g.y+","+g.z]:(s.vertices.push(g),m=p[g.x+","+g.y+","+g.z]=s.vertices.length-1),y=new O(d,v,m,new f(l.normal.x,l.normal.y,l.normal.z)),y.materialIndex=E||0,s.faces.push(y),s.uvs.push(b),s.uv2s.push(w)}}return s},n.CSG.prototype.toMesh=function(e){var t=this.toGeometry(e);return t.computeBoundingBox(),t};var xi=function(e,n,r){e instanceof Array||(e=[]),this.vertices=e,e.length>0?this.calculateProperties():this.normal=this.w=t};xi.prototype.calculateProperties=function(){var e=this.vertices[0],t=this.vertices[1],n=this.vertices[2],r=t.clone().subtract(e),i=n.clone().subtract(e);return this.normal=r.cross(i).normalize(),this.w=this.normal.clone().dot(e),this},xi.prototype.clone=function(){var e,t,n=new xi;for(e=0,t=this.vertices.length;e<t;e++)n.vertices.push(this.vertices[e].clone());return n.calculateProperties(),n},xi.prototype.flip=function(){var e,t=[];this.normal.multiplyScalar(-1),this.w*=-1;for(e=this.vertices.length-1;e>=0;e--)t.push(this.vertices[e]);return this.vertices=t,this},xi.prototype.classifyVertex=function(e){var t=this.normal.dot(e)-this.w;return t<-yi?Ei:t>yi?wi:bi},xi.prototype.classifySide=function(e){var t,n,r,i=0,s=0,o=e.vertices.length;for(t=0;t<o;t++)n=e.vertices[t],r=this.classifyVertex(n),r===wi?i++:r===Ei&&s++;return i>0&&s===0?wi:i===0&&s>0?Ei:i===0&&s===0?bi:Si},xi.prototype.splitPolygon=function(e,t,n,r,i){var s=this.classifySide(e);if(s===bi)(this.normal.dot(e.normal)>0?t:n).push(e);else if(s===wi)r.push(e);else if(s===Ei)i.push(e);else{var o,u,a,f,l,c,h,p,d,v=[],m=[];for(u=0,o=e.vertices.length;u<o;u++)a=(u+1)%o,c=e.vertices[u],h=e.vertices[a],f=this.classifyVertex(c),l=this.classifyVertex(h),f!=Ei&&v.push(c),f!=wi&&m.push(c),(f|l)===Si&&(p=(this.w-this.normal.dot(c))/this.normal.dot(h.clone().subtract(c)),d=c.interpolate(h,p),v.push(d),m.push(d));v.length>=3&&r.push((new xi(v)).calculateProperties()),m.length>=3&&i.push((new xi(m)).calculateProperties())}},n.CSG.Polygon=xi;var Ti=function(e,t,n,r,i,s){this.x=e,this.y=t,this.z=n,this.normal=r||new f,this.uv=i||new o,this.uv2=s||new o};Ti.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},Ti.prototype.clone=function(){var e=new Ti(this.x,this.y,this.z,this.normal.clone(),this.uv.clone(),this.uv2.clone());return e.materialIndex=this.materialIndex,e},Ti.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},Ti.prototype.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},Ti.prototype.multiplyScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this},Ti.prototype.cross=function(e){var t=this.x,n=this.y,r=this.z;return this.x=n*e.z-r*e.y,this.y=r*e.x-t*e.z,this.z=t*e.y-n*e.x,this},Ti.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return this.x/=e,this.y/=e,this.z/=e,this},Ti.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},Ti.prototype.lerp=function(e,t){return this.add(e.clone().subtract(this).multiplyScalar(t)),this.normal.add(e.normal.clone().sub(this.normal).multiplyScalar(t)),this.uv.add(e.uv.clone().sub(this.uv).multiplyScalar(t)),this.uv2.add(e.uv2.clone().sub(this.uv2).multiplyScalar(t)),this},Ti.prototype.interpolate=function(e,t){return this.clone().lerp(e,t)},Ti.prototype.applyMatrix4=function(e){var t=this.x,n=this.y,r=this.z,i=e.elements;return this.x=i[0]*t+i[4]*n+i[8]*r+i[12],this.y=i[1]*t+i[5]*n+i[9]*r+i[13],this.z=i[2]*t+i[6]*n+i[10]*r+i[14],this},n.CSG.Vertex=Ti;var Ni=function(e){var n,r,i=[],s=[];this.polygons=[],this.front=this.back=t;if(!(e instanceof Array&&e.length!==0))return;this.divider=e[0].clone();for(n=0,r=e.length;n<r;n++)this.divider.splitPolygon(e[n],this.polygons,this.polygons,i,s);i.length>0&&(this.front=new Ni(i)),s.length>0&&(this.back=new Ni(s))};Ni.isConvex=function(e){var t,n;for(t=0;t<e.length;t++)for(n=0;n<e.length;n++)if(t!==n&&e[t].classifySide(e[n])!==Ei)return!1;return!0},Ni.prototype.build=function(e){var t,n,r=[],i=[];this.divider||(this.divider=e[0].clone());for(t=0,n=e.length;t<n;t++)this.divider.splitPolygon(e[t],this.polygons,this.polygons,r,i);r.length>0&&(this.front||(this.front=new Ni),this.front.build(r)),i.length>0&&(this.back||(this.back=new Ni),this.back.build(i))},Ni.prototype.allPolygons=function(){var e=this.polygons.slice();return this.front&&(e=e.concat(this.front.allPolygons())),this.back&&(e=e.concat(this.back.allPolygons())),e},Ni.prototype.clone=function(){var e=new Ni;this.divider&&(e.divider=this.divider.clone()),e.polygons=this.polygons.map(function(e){return e.clone()}),e.front=this.front&&this.front.clone(),e.back=this.back&&this.back.clone(),e.materialSize=this.materialSize,e.material=new n.ArrayMaterial;if(this.material)for(var t=0;t<this.material.materials.length;t++)e.material.materials.push(this.material.materials[t]);return e},Ni.prototype.invert=function(){var e,t,n;for(e=0,t=this.polygons.length;e<t;e++)this.polygons[e].flip();return this.divider&&this.divider.flip(),this.front&&this.front.invert(),this.back&&this.back.invert(),n=this.front,this.front=this.back,this.back=n,this},Ni.prototype.clipPolygons=function(e){var t,n,r,i;if(!this.divider)return e.slice();r=[],i=[];for(t=0,n=e.length;t<n;t++)this.divider.splitPolygon(e[t],r,i,r,i);return this.front&&(r=this.front.clipPolygons(r)),this.back?i=this.back.clipPolygons(i):i=[],r.concat(i)},Ni.prototype.clipTo=function(e){this.polygons=e.clipPolygons(this.polygons),this.front&&this.front.clipTo(e),this.back&&this.back.clipTo(e)},Ni.prototype.sumMateriaSize=function(e){e.changeMaterialIndex(this.materialSize),this.materialSize=this.materialSize+e.materialSize;for(var t=0;t<e.material.materials.length;t++)this.material.materials.push(e.material.materials[t])},Ni.prototype.changeMaterialIndex=function(e){for(var t=0;t<this.polygons.length;t++){var n=this.polygons[t];for(var r=0;r<n.vertices.length;r++){var i=n.vertices[r];i.materialIndex=i.materialIndex+e}}this.front&&this.front.changeMaterialIndex(e),this.back&&this.back.changeMaterialIndex(e)},n.CSG.Node=Ni,n.XmlSerializer=function(e,t,r){this.dataBox=e,this.settings=t?t:new n.SerializationSettings,this.filterFunction=r,this.ref=0,this.refMap={},this.idMap={},this.xmlString=""},n.extend(n.XmlSerializer,Object,{serialize:function(){return this.xmlString="<TGL version='"+n.version+"' platform='html5'>\n",this.serializeBody(),this.xmlString+="</TGL>\n",this.xmlString},serializeBody:function(){this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this),this.settings.isDataBoxSerializable&&(this.xmlString+="<dataBox class='"+this.dataBox.getClassName()+"'>\n",this.dataBox.serializeXml(this,this.dataBox.newInstance()),this.xmlString+="</dataBox>\n"),this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(e){this.refMap[e.getId()]=this.ref++,e.getChildren().forEach(this.initRefs,this)},isSerializable:function(e){return this.dataBox.contains(e)?this.filterFunction&&!this.filterFunction(e)?!1:!0:!1},getPropertyType:function(e,t){var n=this.settings.getPropertyType(t);return n||e.__SizePropeties&&e.__SizePropeties.indexOf(t)!=-1&&(n="number"),n},serializeData:function(e){if(this.isSerializable(e)){var t=e.newInstance(),n=this.refMap[e.getId()];this.xmlString+="<data class='"+e.getClassName()+"' ref='"+n+"'",this.settings.getPropertyType("id")!=null&&(this.xmlString+=" id='"+e.getId()+"'"),this.xmlString+=">\n",e.serializeXml(this,t),this.xmlString+="</data>\n"}e.getChildren().forEach(this.serializeData,this)},serializePropertyXml:function(e,t,r){var i=this.getPropertyType(e,t);if(i){var s=n.getValue(e,t,i),o=n.getValue(r,t,i);s!==o&&this.serializeValue("p",t,s,o,i)}},serializeStyleXml:function(e,t,n){var r=this.settings.getStyleType(t);if(r){var i=e.getStyle(t),s=n.getStyle(t);i!=s&&this.serializeValue("s",t,i,s,r)}},serializeClientXml:function(e,t,n){var r=this.settings.getClientType(t);if(r!=null){var i=e.getClient(t),s=n.getClient(t);i!=s&&this.serializeValue("c",t,i,s,r)}},serializeValue:function(e,t,n,r,i){e==="s"&&(n=this.flattenArray(n),n instanceof Array&&i!=="string"&&i!=="color"&&i!=="number"&&(i="list."+i,n=new C(n)));if(n==null)this.xmlString+="	<"+e+" n='"+t+"' none=''/>\n";else if(i==="cdata")this.xmlString+="	<"+e+" n='"+t+"'><![CDATA["+n+"]]></"+e+">\n";else if(i==="data"){var s=this.refMap[n.getId()];s!=null&&(this.xmlString+="	<"+e+" n='"+t+"' ref='"+s+"'/>\n")}else if(i==="vec2"){if(!r||n.x!==r.x||n.y!==r.y)this.xmlString+="	<"+e+" n='"+t+"' x='"+n.x+"' y='"+n.y+"'/>\n"}else if(i==="vec3"){if(!r||n.x!==r.x||n.y!==r.y||n.z!=r.z)this.xmlString+="	<"+e+" n='"+t+"' x='"+n.x+"' y='"+n.y+"' z='"+n.z+"'/>\n"}else i==="list.vec2"?(this.xmlString+="	<"+e+" n='"+t+"'>\n",n instanceof Array&&(n=new C(n)),n.forEach(function(t){if(t instanceof Array){this.xmlString+="	<"+e+">\n";for(var n=0;n<t.length;n++){var r=t[n];this.xmlString+="		<p x='"+r.x+"' y='"+r.y+"'/>\n"}this.xmlString+="	</"+e+">\n"}else this.xmlString+="		<p x='"+t.x+"' y='"+t.y+"'/>\n"},this),this.xmlString+="	</"+e+">\n"):i==="list.vec3"?(this.xmlString+="	<"+e+" n='"+t+"'>\n",n instanceof Array&&(n=new C(n)),n.forEach(function(t){if(t instanceof Array){this.xmlString+="	<"+e+">\n";for(var n=0;n<t.length;n++){var r=t[n];this.xmlString+="	<"+e+"' x='"+r.x+"' y='"+r.y+"' z='"+r.z+"'/>\n"}this.xmlString+="	</"+e+">\n"}else this.xmlString+="		<"+e+"' x='"+t.x+"' y='"+t.y+"' z='"+t.z+"'/>\n"},this),this.xmlString+="	</"+e+">\n"):i==="list.string"||i==="list.number"||i==="list.color"?(this.xmlString+="	<"+e+" n='"+t+"'>\n",n.forEach(function(e){this.xmlString+="		<s>"+e+"</s>\n"},this),this.xmlString+="	</"+e+">\n"):this.xmlString+="	<"+e+" n='"+t+"'>"+n+"</"+e+">\n"},flattenArray:function(e){if(e instanceof Array){for(var t=0;t<e.length-1;t++)if(e[t]!=e[t+1]){if(!e[t]||!e[t].equals)return e;if(!e[t].equals(e[t+1]))return e}return e[0]}return e},deserialize:function(e,t){n.isDeserializing=!0,this.xmlString=e;var r=n.xml(e).documentElement;this.refMap={},this.idMap={};var i=new C,s=new C,o,u,a,f=r.getElementsByTagName("data"),l=f.length;for(a=0;a<l;a++){u=f[a];var c=u.getAttribute("class"),h=this.settings.getPropertyType("id");if(h&&u.hasAttribute("id")){var p=null;if(h==="string")p=u.getAttribute("id");else if(h==="int")p=parseInt(u.getAttribute("id"));else{if(h!=="number")throw"Unsupported id type '"+h+"'";p=parseFloat(u.getAttribute("id"))}if(u.getAttribute("action")==="remove"){this.dataBox.removeById(p);continue}o=this.dataBox.getDataById(p),o||(o=n.newInstance(c,p))}else o=n.newInstance(c);if(u.hasAttribute("ref")){var d=u.getAttribute("ref");this.refMap[d]=o}i.add(o),s.add(u),this.idMap[o.getId()]=o}this.dataBox.forEach(function(e){this.idMap[e.getId()]=e},this),l=i.size();for(a=0;a<l;a++){o=i.get(a);if(this.dataBox.containsById(o.getId()))continue;t&&!o.getParent()&&o.setParent(t),this.dataBox.add(o)}for(a=0;a<l;a++)o=i.get(a),u=s.get(a),o.deserializeXml(this,u);this.settings.isDataBoxSerializable&&r.getElementsByTagName("dataBox").length===1&&this.dataBox.deserializeXml(this,r.getElementsByTagName("dataBox")[0]),n.isDeserializing=!1},deserializePropertyXml:function(e,t,r){var i=this.getPropertyType(e,r);i&&n.setValue(e,r,this.deserializeValue(t,i))},deserializeStyleXml:function(e,t,n){var r=this.settings.getStyleType(n);r&&e.setStyle(n,this.deserializeValue(t,r))},deserializeClientXml:function(e,t,n){var r=this.settings.getClientType(n);r&&e.setClient(n,this.deserializeValue(t,r))},deserializePoint:function(e){var t=e.getAttribute("x")?parseFloat(e.getAttribute("x")):null,r=e.getAttribute("a")?parseFloat(e.getAttribute("a")):null;if(t!=null){var i=e.getAttribute("y")?parseFloat(e.getAttribute("y")):null,s=e.getAttribute("z")?parseFloat(e.getAttribute("z")):null,o=e.getAttribute("w")?parseFloat(e.getAttribute("w")):null;return o!=null?new n.Vec4(t,i,s,o):s!=null?new n.Vec3(t,i,s):new n.Vec2(t,i)}if(r!=null){var u=e.getAttribute("b")?parseFloat(e.getAttribute("b")):null,a=e.getAttribute("c")?parseFloat(e.getAttribute("c")):null,f=e.getAttribute("d")?parseFloat(e.getAttribute("d")):null;return f!=null?new n.Face4(r,u,a,f):new n.Face3(r,u,a)}return null},arrayStyleValue:function(e,t){var r=[];if(e.indexOf(",")){r=e.split(",");if(t==="string")return r;if(t==="number"){var i=[];for(var s=0;s<r.length;s++)i.push(parseFloat(r[s]));return i}if(t==="color"){var o=[];for(var s=0;s<r.length;s++)o.push(new n.Color(r[s]));return o}}},deserializeValue:function(e,t,r){if(e.hasAttribute("@none"))return null;var i=e.nodeName==="s",s=i&&e.textContent.indexOf(",")!==-1;if(t==="string")return s?this.arrayStyleValue(e.textContent,t):e.textContent;if(t==="color")return s?this.arrayStyleValue(e.textContent,t):e.textContent;if(t==="number")return s?this.arrayStyleValue(e.textContent,t):parseFloat(e.textContent);if(t==="boolean")return e.textContent==="true";if(t==="int")return parseInt(e.textContent);if(t==="point")return this.deserializePoint(e);if(t==="vec2"){var o=parseFloat(e.getAttribute("x")),u=parseFloat(e.getAttribute("y"));if(!isNaN(o)&&!isNaN(u)||!i)return new n.Vec2(o,u);t="list.point"}if(t==="vec3"){var o=parseFloat(e.getAttribute("x")),u=parseFloat(e.getAttribute("y")),a=parseFloat(e.getAttribute("z"));return new n.Vec3(o,u,a)}if(t==="data"){var f=e.getAttribute("ref"),l=this.refMap[f];return l?l:this.idMap[f]}var c,h,p,d;if(t==="list.point"){var v=new C,m=e.getElementsByTagName("p");c=m.length;for(d=0;d<c;d++){var g=m[d];v.add(this.deserializePoint(g))}return i?v._as:v}if(t==="list.string"){var y=new C;p=e.getElementsByTagName("s"),c=p.length;for(d=0;d<c;d++)y.add(p[d].textContent);return y}if(t==="list.number"){h=new C,p=e.getElementsByTagName("s"),c=p.length;for(d=0;d<c;d++)h.add(parseFloat(p[d].textContent));return h}if(t==="array.string")return e.textContent.split(",");if(t==="array.number"){h=e.textContent.split(","),c=h.length;for(d=0;d<c;d++)h[d]=parseFloat(h[d]);return h}return t==="rectangle"?{x:parseFloat(e.getAttribute("x")),y:parseFloat(e.getAttribute("y")),width:parseFloat(e.getAttribute("w")),height:parseFloat(e.getAttribute("h"))}:e.textContent}}),n.addMethod(n.Data,{serializeXml:function(e,t){if(this.__SizePropeties&&this.__SizePropeties.length){var n,r;for(n=0,r=this.__SizePropeties.length;n<r;n++)this.serializePropertyXml(e,this.__SizePropeties[n],t)}else this.serializePropertyXml(e,"materialSize",t),this.vertices&&this.vertices.length&&this.serializePropertyXml(e,"vertices",t),this.faces&&this.faces.length&&this.serializePropertyXml(e,"faces",t),this.uvs&&this.uvs.length&&this.serializePropertyXml(e,"uvs",t);if(e.settings.isClientSerializable&&this._clientMap)for(var i in this._clientMap)this.serializeClientXml(e,i,t);this.serializePropertyXml(e,"name",t),this.serializePropertyXml(e,"parent",t)},serializePropertyXml:function(e,t,n){e.serializePropertyXml(this,t,n)},serializeClientXml:function(e,t,n){e.serializeClientXml(this,t,n)},deserializeXml:function(e,t){var n=t.getElementsByTagName("p"),r=n.length,i,s,o,u;for(i=0;i<r;i++)s=n[i],s.hasAttribute("n")&&this.deserializePropertyXml(e,s,s.getAttribute("n"));if(e.settings.isClientSerializable){o=t.getElementsByTagName("c"),r=o.length;for(i=0;i<r;i++)u=o[i],u.hasAttribute("n")&&this.deserializeClientXml(e,u,u.getAttribute("n"))}},deserializePropertyXml:function(e,t,n){e.deserializePropertyXml(this,t,n)},deserializeClientXml:function(e,t,n){e.deserializeClientXml(this,t,n)}}),n.addMethod(n.Element,{serializeXml:function(e,t){if(e.settings.isStyleSerializable&&this.styleMap)for(var r in this.styleMap)this.isSideStyle(r)||this.serializeStyleXml(e,r,t);this.serializePropertyXml(e,"position",t),this.serializePropertyXml(e,"rotation",t),this.serializePropertyXml(e,"scale",t),n.Element.superClass.serializeXml.call(this,e,t),this._alarmState.getHighestNativeAlarmSeverity()&&e.settings.getPropertyType("alarmState")==="alarmstate"&&(e.xmlString+="	<p n='alarmState'>\n",n.AlarmSeverity.forEach(function(t){var n=this.getNewAlarmCount(t);n>0&&(e.xmlString+="		<n n='"+t.name+"' c='"+n+"'/>\n")},this._alarmState),n.AlarmSeverity.forEach(function(t){var n=this.getAcknowledgedAlarmCount(t);n>0&&(e.xmlString+="		<a n='"+t.name+"' c='"+n+"'/>\n")},this._alarmState),e.xmlString+="	</p>\n")},serializeStyleXml:function(e,t,n){e.serializeStyleXml(this,t,n)},deserializeXml:function(e,t){n.Element.superClass.deserializeXml.call(this,e,t);if(e.settings.isStyleSerializable){var r=t.getElementsByTagName("s"),i=r.length,s,o;for(s=0;s<i;s++)o=r[s],o.hasAttribute("n")&&this.deserializeStyleXml(e,o,o.getAttribute("n"))}},deserializeStyleXml:function(e,t,n){e.deserializeStyleXml(this,t,n)},deserializePropertyXml:function(e,t,r){if(r==="alarmState"){if(e.settings.getPropertyType("alarmState")==="alarmstate"){var i,s,o,u,a=t.getElementsByTagName("n");for(o=0;o<a.length;o++)u=a[o],s=mono.AlarmSeverity.getByName(u.getAttribute("n")),this._alarmState.setNewAlarmCount(s,parseInt(u.getAttribute("c")));a=t.getElementsByTagName("a");for(o=0;o<a.length;o++)u=a[o],s=mono.AlarmSeverity.getByName(u.getAttribute("n")),this._alarmState.setAcknowledgedAlarmCount(s,parseInt(u.getAttribute("c")))}}else n.Element.superClass.deserializePropertyXml.call(this,e,t,r)}}),n.addMethod(n.DataBox,{serializeXml:function(e,t){if(e.settings.isClientSerializable&&this._clientMap)for(var n in this._clientMap)this.serializeClientXml(e,n,t);this.serializePropertyXml(e,"name",t)},serializePropertyXml:function(e,t,n){e.serializePropertyXml(this,t,n)},serializeClientXml:function(e,t,n){e.serializeClientXml(this,t,n)},deserializeXml:function(e,t){var n=t.getElementsByTagName("p"),r=n.length,i,s,o,u;for(i=0;i<r;i++)s=n[i],s.hasAttribute("n")&&this.deserializePropertyXml(e,s,s.getAttribute("n"));if(e.settings.isClientSerializable){o=t.getElementsByTagName("c"),r=o.length;for(i=0;i<r;i++)u=o[i],u.hasAttribute("n")&&this.deserializeClientXml(e,u,u.getAttribute("n"))}},deserializePropertyXml:function(e,t,n){e.deserializePropertyXml(this,t,n)},deserializeClientXml:function(e,t,n){e.deserializeClientXml(this,t,n)}}),n.JsonSerializer=function(e,t,r){this.dataBox=e,this.settings=t?t:new n.SerializationSettings,this.filterFunction=r,this.ref=0,this.refMap={},this.idMap={},this.jsonObject={}},n.extend(n.JsonSerializer,Object,{constructor:n.JsonSerializer,className:"TGL.JsonSerializer",serialize:function(){return this.jsonObject={v:n.version,platform:"html5"},this.serializeBody(),JSON.stringify(this.jsonObject)},serializeBody:function(){this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this);if(this.settings.isDataBoxSerializable){var e={"class":this.dataBox.getClassName(),p:{},s:{},c:{}};this.jsonObject.dataBox=e,this.dataBox.serializeJson(this,this.dataBox.newInstance(),e),H.isEmptyObject(e.p)&&delete e.p,H.isEmptyObject(e.s)&&delete e.s,H.isEmptyObject(e.c)&&delete e.c}this.jsonObject.datas=[],this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(e){this.refMap[e.getId()]=this.ref++,e.getChildren().forEach(this.initRefs,this);if(e instanceof n.ComboNode)for(var t=0;t<e.combos.length;t++){var r=e.combos[t];this.refMap[r.getId()]||(this.refMap[r.getId()]=this.ref++)}},isSerializable:function(e){return this.dataBox.contains(e)?this.filterFunction&&!this.filterFunction(e)?!1:!0:!1},serializeData:function(e){if(this.isSerializable(e)){var t=e.newInstance(),n=this.refMap[e.getId()],r={"class":e.getClassName(),ref:n,p:{},s:{},c:{}};this.settings.getPropertyType("id")&&(this.jsonObject.id=e.getId()),this.jsonObject.datas.push(r),e.serializeJson(this,t,r),H.isEmptyObject(r.p)&&delete r.p,H.isEmptyObject(r.s)&&delete r.s,H.isEmptyObject(r.c)&&delete r.c}e.getChildren().forEach(this.serializeData,this)},serializeDataValue:function(e){var t=e.newInstance(),n=this.refMap[e.getId()],r={"class":e.getClassName(),ref:n,p:{},s:{},c:{}};return e.serializeJson(this,t,r),H.isEmptyObject(r.p)&&delete r.p,H.isEmptyObject(r.s)&&delete r.s,H.isEmptyObject(r.c)&&delete r.c,r},getPropertyType:function(e,t){var n=this.settings.getPropertyType(t);return n||(e.__bool&&e.__bool.indexOf(t)!=-1?n="boolean":e.__SizePropeties&&e.__SizePropeties.indexOf(t)!=-1&&(n="number")),n},getStyleType:function(e,t){e.isSideStyle(t)&&(t=t.substr(t.indexOf(".")+1));var n=this.settings.getStyleType(t);return n},serializePropertyJson:function(e,t,r,i){var s=this.getPropertyType(e,t);if(s){var o=n.getValue(e,t,s),u=n.getValue(r,t,s);o!==u&&(o&&o.equals?!o.equals(u)&&this.serializeValue(t,o,u,s,i.p):this.serializeValue(t,o,u,s,i.p))}},serializeStyleJson:function(e,t,n,r){var i=this.getStyleType(e,t);if(i){var s=e.getStyle(t),o=n.getStyle(t);t.startsWith("m.")&&(s=this.flattenArray(s),o=this.flattenArray(o)),t.endsWith(".image")&&(s=this.encodeURI(s),o=this.encodeURI(o)),s!=o&&(s&&s.equals?!s.equals(o)&&this.serializeValue(t,s,o,i,r.s):this.serializeValue(t,s,o,i,r.s))}},serializeClientJson:function(e,t,n,r){var i=this.settings.getClientType(t);if(i!=null){var s=e.getClient(t),o=n.getClient(t);s!=o&&(s&&s.equals?!s.equals(o)&&this.serializeValue(t,s,o,i,r.c):this.serializeValue(t,s,o,i,r.c))}},serializeValue:function(e,t,n,r,i){if(t==null)i[e]=null;else if(t instanceof C)i[e]=t._as;else if(r==="data"){var s=this.refMap[t.getId()];s!=null&&(i[e]=s)}else if(r==="data.list"){var o=[];for(var u=0;u<t.length;u++)o.push(this.serializeDataValue(t[u]));i[e]=o}else if(r==="serializeabe.list"){var o=[];for(var u=0;u<t.length;u++)o.push(t[u].serializeJsonValue());i[e]=o}else t.serializeJsonValue?i[e]=t.serializeJsonValue():i[e]=t},deserialize:function(e,t){n.isDeserializing=!0,this.jsonObject=JSON.parse(e),this.refMap={},this.idMap={};var r=new C,i=new C,s,o=this.jsonObject.datas.length;this.deserializeStartCreateData!=null&&this.deserializeStartCreateData(o);for(var u=0;u<o;u++){var a=this.jsonObject
.datas[u],f=a["class"],l=this.settings.getPropertyType("id");if(l&&a.id!=null){if(a.action==="remove"){this.dataBox.removeById(a.id);continue}s=this.dataBox.getDataById(a.id),s||(s=n.newInstance(f,a.id))}else{var c={};s=n.newInstance(f)}a.ref!=null&&(this.refMap[a.ref]=s),r.add(s),i.add(a),this.idMap[s.getId()]=s,this.deserializeCreateData&&this.deserializeCreateData(u,o)}this.dataBox.forEach(function(e){this.idMap[e.getId()]=e},this),o=r.size(),this.deserializeStartFillData&&this.deserializeStartFillData(o);for(u=0;u<o;u++)s=r.get(u),s.deserializeJson(this,i.get(u)),this.deserializeFillData&&this.deserializeFillData(u,o);this.deserializeStartAddData&&this.deserializeStartAddData(o);for(u=0;u<o;u++){s=r.get(u);if(this.dataBox.containsById(s.getId()))continue;t&&!s.getParent()&&s.setParent(t),s.getClassName()==="TGL.Entity"&&(s.computed=!1,s.computeNodeData()),this.dataBox.add(s),this.deserializeAddData&&this.deserializeAddData(u,o)}this.settings.isDataBoxSerializable&&this.jsonObject.dataBox&&this.dataBox.deserializeJson(this,this.jsonObject.dataBox),n.isDeserializing=!1},deserializePropertyJson:function(e,t,r){var i=this.getPropertyType(e,r);i&&n.setValue(e,r,this.deserializeValue(t,i))},deserializeStyleJson:function(e,t,n){var r=this.getStyleType(e,n);if(r){var i=this.deserializeValue(t,r);i._as&&(i=i._as),e.setStyle(n,i)}},deserializeClientJson:function(e,t,n){var r=this.settings.getClientType(n);r&&e.setClient(n,this.deserializeValue(t,r))},getClassName:function(e){if(e==null)return;if(e.class)return e.class;if(e.w!==t&&e.x!==t&&e.y!==t&&e.z!==t)return"TGL.Vec4";if(e.x!==t&&e.y!==t&&e.z!==t)return"TGL.Vec3";if(e.x!==t&&e.y!==t)return"TGL.Vec2";if(e.a!==t&&e.b!==t&&e.c!==t&&e.d!==t)return"TGL.Face4";if(e.a!==t&&e.b!==t&&e.c!==t)return"TGL.Face3"},translateJson:function(e){if(e==null)return;if(this.getClassName(e)!=null){var t=n.newInstance(this.getClassName(e));if(t.deserializeJsonValue)t.deserializeJsonValue(e);else for(var r in e)t[r]=e[r];return t}if(e instanceof Array)for(var i=0;i<e.length;i++)e[i]=this.translateJson(e[i]);return e},isChinese:function(e){return e=e||"",escape(e).indexOf("%u")>0},encodeURI:function(e){if(e instanceof Array){for(var t=0;t<e.length;t++)e[t]=this.encodeURI(e[t]);return e}return typeof e=="string"&&this.isChinese(e)?encodeURI(e):e},flattenArray:function(e){if(e instanceof Array){for(var t=0;t<e.length-1;t++)if(e[t]!=e[t+1]){if(!e[t]||!e[t].equals)return e;if(!e[t].equals(e[t+1]))return e}return e[0]}return e},deserializeValue:function(e,r){if(r==="data"){var i=this.refMap[e];return i?i:this.idMap[e]}if(r==="data.list"){var s=[],o,u;for(var a=0;a<e.length;a++)o=e[a],u=n.newInstance(o.class),o.ref!=null&&(this.refMap[o.ref]=u),u.deserializeJson(this,o),s.push(u);return s}if(r==="color"&&e.r!=t){var f=new n.Color;return f.setRGB(e.r,e.g,e.b),f}if(e.class==="TGL.Path"){var l=new n.Path;return l.deserializeJsonValue(e),l}if(e instanceof Array){for(var a=0;a<e.length;a++)e[a]=this.translateJson(e[a]);return e}return this.getClassName(e)!=null?this.translateJson(e):e}}),n.addMethod(n.DataBox,{serializeJson:function(e,t,n){if(e.settings.isClientSerializable&&this._clientMap)for(var r in this._clientMap)this.serializeClientJson(e,r,t,n);this.serializePropertyJson(e,"name",t,n)},serializePropertyJson:function(e,t,n,r){e.serializePropertyJson(this,t,n,r)},serializeClientJson:function(e,t,n,r){e.serializeClientJson(this,t,n,r)},deserializeJson:function(e,t){var n;for(n in t.p)this.deserializePropertyJson(e,t.p[n],n);if(e.settings.isClientSerializable)for(n in t.c)this.deserializeClientJson(e,t.c[n],n)},deserializePropertyJson:function(e,t,n){e.deserializePropertyJson(this,t,n)},deserializeClientJson:function(e,t,n){e.deserializeClientJson(this,t,n)}}),n.addMethod(n.Data,{serializeJson:function(e,t,r){if(!this.__SizePropeties||!this.__SizePropeties.length||this instanceof n.Entity)this.materialSize&&this.serializePropertyJson(e,"materialSize",t,r),this instanceof n.Entity&&(this.vertices&&this.vertices.length&&this.serializePropertyJson(e,"vertices",t,r),this.faces&&this.faces.length&&this.serializePropertyJson(e,"faces",t,r),this.uvs&&this.uvs.length&&this.serializePropertyJson(e,"uvs",t,r),this.uv2s&&this.uv2s.length&&this.serializePropertyJson(e,"uv2s",t,r));else{var i,s;for(i=0,s=this.__SizePropeties.length;i<s;i++)this.serializePropertyJson(e,this.__SizePropeties[i],t,r)}if(e.settings.isClientSerializable&&this._clientMap)for(var o in this._clientMap)this.serializeClientJson(e,o,t,r);this.serializePropertyJson(e,"name",t,r),this.serializePropertyJson(e,"parent",t,r)},serializePropertyJson:function(e,t,n,r){e.serializePropertyJson(this,t,n,r)},serializeClientJson:function(e,t,n,r){e.serializeClientJson(this,t,n,r)},deserializeJson:function(e,t){var n;for(n in t.p)this.deserializePropertyJson(e,t.p[n],n);if(e.settings.isClientSerializable)for(n in t.c)this.deserializeClientJson(e,t.c[n],n)},deserializePropertyJson:function(e,t,n){e.deserializePropertyJson(this,t,n)},deserializeClientJson:function(e,t,n){e.deserializeClientJson(this,t,n)}}),n.addMethod(n.Element,{serializeJson:function(e,t,r){if(e.settings.isStyleSerializable&&this.styleMap)for(var i in this.styleMap)this.isSideStyle(i)||this.serializeStyleJson(e,i,t,r);n.Element.superClass.serializeJson.call(this,e,t,r),this.serializePropertyJson(e,"position",t,r),this.serializePropertyJson(e,"rotation",t,r),this.serializePropertyJson(e,"scale",t,r);if(this._alarmState.getHighestNativeAlarmSeverity()&&e.settings.getPropertyType("alarmState")==="alarmstate"){var s={n:{},a:{}};r.p.alarmState=s,n.AlarmSeverity.forEach(function(e){var t=this.getNewAlarmCount(e);t>0&&(s.n[e.name]=t)},this._alarmState),n.AlarmSeverity.forEach(function(e){var t=this.getAcknowledgedAlarmCount(e);t>0&&(s.a[e.name]=t)},this._alarmState),H.isEmptyObject(s.n)&&delete s.n,H.isEmptyObject(s.a)&&delete s.a,H.isEmptyObject(s)&&delete r.p.alarmState}},serializeStyleJson:function(e,t,n,r){e.serializeStyleJson(this,t,n,r)},deserializeJson:function(e,t){n.Element.superClass.deserializeJson.call(this,e,t);if(e.settings.isStyleSerializable)for(var r in t.s)this.deserializeStyleJson(e,t.s[r],r)},deserializeStyleJson:function(e,t,n){e.deserializeStyleJson(this,t,n)},deserializePropertyJson:function(e,t,r){if(r==="alarmState"){if(e.settings.getPropertyType("alarmState")==="alarmstate"){var i;for(i in t.n)this._alarmState.setNewAlarmCount(mono.AlarmSeverity.getByName(i),t.n[i]);for(i in t.a)this._alarmState.setAcknowledgedAlarmCount(mono.AlarmSeverity.getByName(i),t.a[i])}}else n.Element.superClass.deserializePropertyJson.call(this,e,t,r)}}),n.addMethod(n.Light,{serializeJson:function(e,t,r){n.Light.superClass.serializeJson.call(this,e,t,r),this.serializePropertyJson(e,"color",t,r),this.serializePropertyJson(e,"ambient",t,r),this.serializePropertyJson(e,"diffuse",t,r),this.serializePropertyJson(e,"specular",t,r),this.serializePropertyJson(e,"castShadow",t,r),this.serializePropertyJson(e,"onlyShadow",t,r);if(t.__accessor&&t.__accessor.length)for(var i=0;i<t.__accessor.length;i++)this.serializePropertyJson(e,t.__accessor[i],t,r)}});var Ci=n.Animate=function(e){var t=this;t.type=e.type==null?"number":e.type,t.delay=e.delay==null?0:e.delay,t.dur=e.dur==null?1e3:e.dur,t.interval=e.interval==null?0:e.interval,t.finish=e.finish==null?t.delay+t.dur+t.interval:e.finish,t.repeat=e.repeat==null?1:e.repeat,t.reverse=e.reverse==null?!0:e.reverse,t.easing=e.easing==null?"easeNone":e.easing,t.onUpdate=e.onUpdate,t.onDone=e.onDone,t.onStop=e.onStop,t.onPlay=e.onPlay,t.attr=e.attr,t.source=e.source,t.filter=e.filter,t.from=e.from,t.to=e.to,t.start=null,t.time=0,t.total=0,t.count=0,t.started=!1,t.stopped=!1,t.id=Bi++};n.extend(n.Animate,Object,{play:function(){return ki(this)},stop:function(e){return Oi(this,e)},clone:function(){return new Ci(this)},chain:function(e){var t=this,n;return t.onDone?(n=t.onDone,t.onDone=function(){n.call(t),e.play()}):t.onDone=function(){e.play()},t}});var Hi={},Bi=1,ji=!1;(function Wi(e){requestAnimationFrame(Wi),ji&&(ji=!1,_i(e))})(0);if(!e.make){var Fi=e.make={},Ii={},qi={},Ri=[],Ui={};Fi.Default={path:"./",resPath:"",getImagePath:function(e){return this.path+this.resPath+"res/images/"+(e||"")},register:function(e,t,n){n=n||{},n.name=n.name||e,n.modelDefaultParameters=n.modelDefaultParameters||{},n.description=n.description||n.name,Ii[e]&&console.log(e," already exist"),Ii[e]=t;var r=n.category||"",i=qi[r]||{};i[e]=t,qi[r]=i,Ui[e]=n,Ri.indexOf(r)==-1&&Ri.push(r),this.checkModelDefaultParameters(n.modelDefaultParameters)},checkModelDefaultParameters:function(e){if(!e)return;for(var n in e){var r=e[n];r instanceof Object||(r={value:r},e[n]=r),r.propertyName=n,r.hidden=!!r.hidden,r.propertyType=r.propertyType||Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,r.type=r.type||Fi.Default.PARAMETER_TYPE_STRING,r.category=r.category||Fi.Default.PARAMETER_CATEGORY_DETAIL,r.editable=r.editable===t?!0:!!r.editable,r.index=r.index===t?100:parseInt(r.index)}},remove:function(e){if(!Ii[e])console.log(e," not exist");else{Ii[e]=t,delete Ii[e];var n=Fi.Default.getCategory(e),r=qi[n];delete r[e];var i=0;for(var s in r)s&&i++;if(i==0)for(var s=0;s<Ri.length;s++){var o=Ri.indexOf(n);o>=0&&Ri.splice(o,1)}delete Ui[e]}},getCategories:function(){return Ri},getCreatorsForCategory:function(e){return qi[e]},getCreator:function(e){return Ii[e]},getIds:function(e){var t=[];for(var n in Ii)(!e||e&&e(this.getParameters(n)))&&t.push(n);return t},getModelDefaultParameters:function(e){var t=this.getParameters(e);return t.modelDefaultParameters},getDescription:function(e){var t=this.getParameters(e);return t.description},getName:function(e){var t=this.getParameters(e);return t.name},getIcon:function(e){var t=this.getParameters(e);return this.path+t.icon},isAsync:function(e){var t=this.getParameters(e);return t.async},isCombo:function(e){var t=this.getParameters(e);return t.combo},getCategory:function(e){var t=this.getParameters(e);return t.category},getOrder:function(e){var t=this.getParameters(e);return t.order||0},getType:function(e){var t=this.getParameters(e);return t.type},getOtherParameter:function(e,t){var n=this.getParameters(e);return n[t]},registerIcon:function(e,t){var n=this.getParameters(e);if(!n)return;return n.icon=t,n.icon},registerDescription:function(e,t){var n=this.getParameters(e);return n.description=t,n.description},registerName:function(e,t){var n=this.getParameters(e);return n.name=t,n.name},registerOther:function(e,t,n){var r=i[t],i=this.getParameters(e);return i[t]=n,t==="modelDefaultParameters"&&(console.warn("rewrite modelDefaultParameters: id={0}, oldValue={}, newValue={}",e,r,n),this.checkModelDefaultParameters(n)),r},appendModelDefaultParameter:function(e,t,n,r,i,s,o){var u={name:t,category:n,propertyType:r}},getParameters:function(e){return Ui[e]||{}},load:function(e,t,n){var r=this,n=n||{},i=n.isRelation,s;if(t){var o=t;t=function(t){i&&e instanceof Array&&e.length>1&&t instanceof Array&&t.length>1&&this._relation(e,t),o(t)}}if(e instanceof Array){var u={},a=0;if(t){var f=function(n,r){var i=e.length;return function(e){n.datas=n.datas||[],n.datas.push(e),n._total===i&&t(n.datas)}(r)};u._total=0;for(var l=0;l<e.length;l++){var c=e[l];this.load(c,function(e){u._total++,f(u,e)})}return null}s=[];for(var l=0;l<e.length;l++){var c=e[l],h=this.load(c);h&&s.push(h)}}else{var p={};typeof e=="string"?p.id=e:p=e,p=this.filterJson(p),t?this._load(p,t):s=this._load(p)}return i&&s instanceof Array&&s.length>1&&this._relation(e,s),s},_relation:function(e,t){var n={};t.forEach(function(e){e.getId&&(n[e.getId()]=e)}),e.forEach(function(e){e.objectId&&e.parentId&&n[e.objectId]&&n[e.parentId]&&n[e.objectId].setParent&&n[e.objectId].setParent(n[e.parentId])})},_load:function(e,t){var n=e.id,r=this.getCreator(n);if(!r)return console.log("unknown id: ",n),null;if(!t){var i=r(e);return Fi.Default._setObjectClientId(i,n),i}r(e,function(e){Fi.Default._setObjectClientId(e,n),t&&t(e)})},_setObjectClientId:function(e,t){e&&e.setClient&&e.setClient("id",t)},copyArray:function(e,t,n){t=[];if(e){var r,i=0,s=e.length;for(;i<s;i++)r={},this.copyProperties(e[i],r),t.push(r)}return t},copyProperties:function(e,n,r){if(e&&n)for(var i in e)r&&r.indexOf(i)>=0||i.indexOf("_")==0||(n[i]===t&&(e[i]instanceof Array?n[i]=[]:e[i]instanceof Function?n[i]=e[i]:e[i]instanceof Object?n[i]={}:n[i]=e[i]),!(e[i]instanceof Function)&&e[i]instanceof Object&&n[i]instanceof Object&&Fi.Default.copyProperties(e[i],n[i]))},getModelDefaultParametersValues:function(e,t){var n=this.getModelDefaultParameters(e),r={};for(var i in n){var s=n[i];if(t&&t(s))continue;s.propertyType==Fi.Default.PARAMETER_PROPERTY_TYPE_CLIENT?(r.client=r.client||{},r.client[i]=s.value):s.propertyType==Fi.Default.PARAMETER_PROPERTY_TYPE_STYLE?(r.style=r.style||{},r.style[i]=s.value):r[i]=s.value}return r},getModelDefaultParameterProperties:function(e,t){var n=this,r=[],i=this.getModelDefaultParameters(e);if(!i)return r;t&&!i.id&&(i.id={propertyName:"id",name:"模型ID",category:Fi.Default.PARAMETER_CATEGORY_BASIC,editable:!1,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,type:Fi.Default.PARAMETER_TYPE_STRING,exportable:!1,index:-2}),t&&!i.objectId&&(i.objectId={propertyName:"objectId",name:"实例ID",category:Fi.Default.PARAMETER_CATEGORY_BASIC,editable:!1,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,type:Fi.Default.PARAMETER_TYPE_STRING,exportable:!1,index:-1});for(var s in i)r.push(i[s]);return r.sort(function(e,t){return e.index-t.index}),r=r.map(function(e){return n.modelParameterToProperty(e)}),r},_getNameFromPropertyName:function(e){var t=e.split("."),n="";for(var r=0;r<t.length;r++)t[r].length>0&&(n+=t[r].substring(0,1).toUpperCase()+t[r].substring(1,t[r].length)),r<t.length-1&&(n+=" ");return n},modelParameterToProperty:function(e){var t=new twaver.Property;return t.setCategoryName(e.category),e.name||(e.name=this._getNameFromPropertyName(e.propertyName)),t.setName(e.name),t.setEditable(e.editable),t.setPropertyType(e.propertyType),t.setPropertyName(e.propertyName),t.setValueType(e.type),t.setEnumInfo(e.enumInfo),t.isVisible=function(){return!e.hidden},t},filterJson:function(e){var n=this.getModelDefaultParameters(e.id);for(var r in n){var i=n[r].propertyType||"client",s=n[r].value;if(i==Fi.Default.PARAMETER_PROPERTY_TYPE_STYLE){if(!e.style||e.style[r]===t)e.style=e.style||{},e.style[r]=s}else if(i==Fi.Default.PARAMETER_PROPERTY_TYPE_CLIENT){if(!e.client||e.client[r]===t)e.client=e.client||{},e.client[r]=s}else e[r]===t&&(e[r]=s)}return e},UNIT_HEIGHT:4.445,EQUIPMENT_WIDTH:45.5,RACK_OFFSET_X:7.25,RACK_OFFSET_Y:6.655,RACK_WIDTH:60,getUnitHeight:function(){return this.UNIT_HEIGHT},getEquipmentWidth:function(){return this.EQUIPMENT_WIDTH},getEquipmentHeight:function(e){return parseInt(e)>0||console.error("method getEquipmentHeight's first argument scale value is zero"),this.UNIT_HEIGHT*e},getRackWidth:function(){return this.RACK_WIDTH},getRackHeight:function(e){return parseInt(e)>0||console.error("method getRackHeight's first argument scale value is zero"),this.RACK_OFFSET_Y+this.UNIT_HEIGHT*parseInt(e)+this.RACK_OFFSET_Y}},Fi.Default.toJson=function(e,t){if(e&&e.getClient){var n=e.getClient("id"),r=Fi.Default.getModelDefaultParameters(n),i={},s=null,o=null;for(var u in r){if(r[u].exportable===!1)continue;var a=r[u].propertyType,o=r[u].value;a==Fi.Default.PARAMETER_PROPERTY_TYPE_ACCESSOR?(s=e[_twaver.getter(u)](),Fi.Default.equals(s,o)||(i[u]=s)):a==Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD?(s=e[u],Fi.Default.equals(s,o)||(i[u]=s)):a==Fi.Default.PARAMETER_PROPERTY_TYPE_STYLE?(s=e.getStyle(u),Fi.Default.equals(s,o)||(i.style=i.style||{},i.style[u]=s)):a==Fi.Default.PARAMETER_PROPERTY_TYPE_CLIENT&&(s=e.getClient(u),Fi.Default.equals(s,o)||(i.client=i.client||{},i.client[u]=s))}return i.id=n,Fi.Default.EXPORT_OBJECT_ID&&(i.objectId=e.getId()),t&&(i=t(i)),i}return t&&(e=t(e)),e},Fi.Default.copy=function(e,n,r,i,s){var o=function(e,n,r,i,s){s=s||{};var o={},u={},a=Fi.Default.getParameters(n);a=Fi.Default.clone(a),Fi.Default.copyProperties(a,u),i instanceof Function?o=i(u)||{}:Fi.Default.copyProperties(i,o),s.copyDefaultParamCoverage&&delete u.modelDefaultParameters,s.copyParamCoverage||Fi.Default.copyProperties(u,o);if(s.defaultValue&&o.modelDefaultParameters)for(var f in s.defaultValue)o.modelDefaultParameters[f]!==t&&(o.modelDefaultParameters[f]instanceof Object?o.modelDefaultParameters[f].value=s.defaultValue[f]:o.modelDefaultParameters[f]=s.defaultValue[f]);Fi.Default.register(e,function(e,t){var i={id:n};r instanceof Function?r(e):Fi.Default.copyProperties(r,i),Fi.Default.copyProperties(e,i);var s=Fi.Default.load(i,t);return s},o)};o(e,n,r,i,s)},Fi.Default.PARAMETER_CATEGORY_BASIC="BASIC",Fi.Default.PARAMETER_CATEGORY_DETAIL="Detail",Fi.Default.PARAMETER_TYPE_STRING="string",Fi.Default.PARAMETER_TYPE_BOOLEAN="boolean",Fi.Default.PARAMETER_TYPE_COLOR="color",Fi.Default.PARAMETER_TYPE_INT="int",Fi.Default.PARAMETER_TYPE_NUMBER="number",Fi.Default.PARAMETER_TYPE_IMAGE="image",Fi.Default.PARAMETER_TYPE_ARRAY_STRING="array.string",Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER="array.number",Fi.Default.PARAMETER_TYPE_ARRAY_INT="array.int",Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD="field",Fi.Default.PARAMETER_PROPERTY_TYPE_ACCESSOR="accessor",Fi.Default.PARAMETER_PROPERTY_TYPE_STYLE="style",Fi.Default.PARAMETER_PROPERTY_TYPE_CLIENT="client",String.prototype.replaceAll=function(e,t,n){return RegExp.prototype.isPrototypeOf(e)?this.replace(e,t):this.replace(new RegExp(e,n?"gi":"g"),t)},String.prototype.format=function(e){var t=this;if(arguments.length>1){var n=[];for(var r=0;r<arguments.length;r++)n.push(arguments[r]);e=n}if(e){var i=typeof e;if(e instanceof Array)e.forEach(function(e,n){e instanceof Object&&(e=JSON.stringify(e)),t=t.replaceAll("{"+n+"}",e)});else{if(!(e instanceof Object))return t.replaceAll("{}",e);for(var s in e){var o=e[s];o instanceof Object&&(o=JSON.stringify(o)),t=t.replaceAll("{"+s+"}",o)}}}return t},Fi.Default.getId=function(e){return e.getClient("id")},Fi.Default.objectWrapper=function(e,t,n,r){Object.defineProperty(e,t,{get:function(){var r=e["___"+t];return n&&(r=n.call(e,r,e,t)),r},set:function(n){var i=e[t];r&&(n=r.call(e,n,e,t)),i!==n&&(e["___"+t]=n,this.firePropertyChange&&this.firePropertyChange(t,i,n))}})},Fi.Default.equals=function(e,t){return e instanceof Object&&t instanceof Object?JSON.stringify(e)==JSON.stringify(t):e==t},Fi.Default.clone=function(e){try{return JSON.parse(JSON.stringify(e))}catch(t){throw console.error(t,e),t}},Fi.Default.EXPORT_OBJECT_ID=!0}var Fi=e.make;mono.Element.prototype.direction2=function(e){var t=e.applyMatrix4((new mono.Mat4).extractRotation(this.matrix));return t.normalize(),t},Fi.Utils3D={positionFloor:"floor-top",_objMap:{},_objObject:{},_envMaps:{envmap:"envmap.jpg",envmap1:"envmap1.jpg",envmap2:"envmap2.jpg",envmap3:"envmap3.jpg",envmap4:"envmap4.jpg",envmap5:"envmap5.jpg",envmap6:"envmap6.jpg"},getEnvMap:function(e){var t=Fi.Default.getImagePath()+Fi.Default._envMaps[e];return[t,t,t,t,t,t]},getOBjPath:function(e){return e?e.indexOf("http")>=0?e:this.path+e:this.path+"obj/"},createFloorForWall:function(e){var t={type:"twaver.floor",data:e.getClient("data")},n=this.getCreator(t.type);if(n){var r=this.loadData(t);r.setParent(e)}},createCombo:function(e,t){var n=[],r=[],i=[],s=[];e&&!(e instanceof Array)&&(e=[e]);for(var o=0;o<e.length;o++){var u=e[o],a=u.op||"+",f=u.style,l=u.client,c=u.position||[0,0,0],h=u.rotation||[0,0,0],p=u.scale||[1,1,1],d=null;u.type==="cube"&&(d=this.createCube(u)),u.type==="cylinder"&&(d=this.createCylinder(u)),u.type==="sphere"&&(d=this.createSphere(u)),u.type==="polygon"&&(d=this.createPolygon(u)),u.type==="torus"&&(d=this.createTorus(u)),u.type==="path"&&(d=this.createPathCube(u)),u.type==="pathNode"&&(d=this.createPathNode(u)),u.type==="shapeNode"&&(d=this.createShapeNode(u));if(d){h&&!u.rotationAnchor&&d.setRotation(h[0],h[1],h[2]);if(u.rotationAnchor){var v=d.getPosition();c=[c[0]+v.x,c[1]+v.y,c[2]+v.z]}d.setPosition(c[0],c[1],c[2]),d.setScale(p[0],p[1],p[2]),f&&d.s(f),l&&d.c(l),u.op?(d.getChildren().size()>0&&(n=n.concat(d.getChildren().toArray())),n.push(d),d.getChildren().size()>0?d.getChildren().forEach(function(){i.push(a)}):n.length>1&&i.push(a),s.push(d.getId())):r.push(d)}}if(n.length>0){var m;return t?m=new mono.ComboNode(n,i,!1,t):m=new mono.ComboNode(n,i),m.setNames(s),m}return r.length==1?r[0]:r},setMainObject:function(e){function i(e,t){if(e){var n=e.getBoundingBox(),r=t.getBoundingBox(),i=n.min,s=n.max,o=r.min,u=r.max;if(s.x-i.x<u.x-o.x||s.z-i.z<u.z-o.z)e=t}else e=t;return e}var t=null;if(e instanceof Array){for(var n=0;n<e.length;n++){var r=e[n];if(!(r instanceof mono.Entity))continue;t=i(t,r)}for(var n=0;n<e.length;n++){var r=e[n];if(!(r instanceof mono.Entity))continue;t!=r&&e[n].setParent(t)}}else t=e;return t&&t.setClient("main",!0),t},createCube:function(e){var t=e.width,n=e.height,r=e.depth,i=e.color,s=e.position||[0,0,0],o=e.rotation||[0,0,0],u=e.rotationAnchor,a=e.topColor||i,f=e.repeatX||1,l=e.repeatY||1,c=e.image,h=e.frontImage,p=e.wrapMode,d;e.objectId?d=new mono.Cube({id:e.objectId,width:t,height:n,depth:r}):d=new mono.Cube(t,n,r),i&&d.s({"m.color":i,"m.ambient":i}),a&&d.s({"top.m.color":a,"top.m.ambient":a,"bottom.m.color":a,"bottom.m.ambient":a}),c&&d.s({"m.texture.image":c,"m.texture.repeat":new mono.Vec2(f,l),"m.texture.anisotropy":15}),h&&d.setStyle("front.m.texture.image",h),p&&d.setWrapMode(p);if(u){var v,m;u==="left"&&(v=new mono.Vec3(t/2,0,0),m=new mono.Vec3(0,1,0)),u==="right"&&(v=new mono.Vec3(-t/2,0,0),m=new mono.Vec3(0,1,0)),d.rotateFromAxis(m.clone(),v.clone(),o[1])}else d.setRotation(o[0]/180*Math.PI,o[1]/180*Math.PI,o[2]/180*Math.PI);return Fi.Default.setObject3dCSProps(d,e),d},createCylinder:function(e){var t=e.radius,n=e.topRadius||t,r=e.bottomRadius||t,i=e.height,s=e.color,o=e.image,u=new mono.Cylinder(n,r,i);return u.s({"m.normalType":mono.NormalTypeSmooth,"m.type":"phong","m.color":s,"m.ambient":s,"side.m.lightmap.image":this.getImagePath("inside_lightmap.jpg")}),o&&u.setStyle("m.texture.image",o),u},createSphere:function(e){var t=e.radius,n=e.color||"#F5F5F5",r=e.image,i=new mono.Sphere(t);return i.s({"m.normalType":mono.NormalTypeSmooth,"m.type":"phong","m.color":n,"m.ambient":n,"m.lightmap.image":this.getImagePath("inside_lightmap.jpg")}),r&&i.setStyle("m.texture.image",r),i},createPolygon:function(e){var t=e.radius||100,n=e.topRadius||t,r=e.bottomRadius||t,i=e.height||200,s=e.radialSegments||3,o=e.color||"#F5F5F5",u=e.topColor||o,a=e.smooth||!0,f=e.image,l=new mono.Cylinder(n,r,i,s,a);return l.s({"m.normalType":mono.NormalTypeSmooth,"m.type":"phong","m.color":o,"m.ambient":o,"top.m.color":u,"top.m.ambient":u,"bottom.m.color":u,"bottom.m.ambient":u,"side.m.lightmap.image":this.getImagePath("inside_lightmap.jpg")}),f&&l.setStyle("m.texture.image",f),l},createTorus:function(e){var t=e.radius||50,n=e.tube||30,r=e.tubularSegments||3,i=e.radialSegments||6,s=e.color||"#F5F5F5",o=e.image,u=new mono.Torus(t,n,r,i);return u.s({"m.normalType":mono.NormalTypeSmooth,"m.type":"phong","m.color":s,"m.ambient":s,"m.lightmap.image":this.getImagePath("outside_lightmap.jpg")}),o&&u.setStyle("m.texture.image",o),u},createBillboard:function(e){var t=e.position||[0,0,0],n=e.scale||[1,1,1],r=e.image||this.getImagePath("outside_lightmap.jpg"),i=new mono.Billboard;return i.s({"m.texture.image":r,"m.alignment":mono.BillboardAlignment.bottomCenter,"m.depthTest":!1}),i.setScale(n[0],n[1],n[2]),i.p(t[0],t[1],t[2]),i},createPathNodePath:function(e){var t;if(e[0]&&e[0]instanceof Array)for(var n=0;n<e.length;n++){var r=e[n];t?r[0]==="c"?t.quadraticCurveTo(r[1],r[2],r[3],r[4],r[5],r[6]):t.lineTo(r[0],0,r[1]):(t=new mono.Path,t.moveTo(r[0],0,r[1]))}else for(var n=0;n<e.length;n+=2)t?t.lineTo(e[n],0,e[n+1]):(t=new mono.Path,t.moveTo(e[n],0,e[n+1]));return t},createPathNode:function(e){var t=e.radius,n=e.pathImage,r=e.repeat||50,i=e.offset||new mono.Vec2(0,0),s=e.startCap||"plain",o=e.endCap||"plain",u=e.pathWidth,a=e.pathHeight,f=u/2,l=a/2,c=[{x:f,y:-l},{x:f,y:l},{x:-f,y:l},{x:-f,y:-l}],h=this.createPathNodePath(e.data),p=h.getLength(),d;return u&&a?d=new mono.PathNode({path:h,shape:c,segments:10,segmentsR:5}):(h=mono.PathNode.prototype.adjustPath(h,t,2),d=new mono.PathNode({path:h,radius:t})),d.s({"m.texture.image":n,"m.texture.repeat":new mono.Vec2(p/r,1),"m.texture.offset":i}),s&&d.setStartCap(s),o&&d.setEndCap(o),Fi.Default.setObject3dCSProps(d,e),d},createShapeNodePath:function(e){var t;if(e[0]&&e[0]instanceof Array)for(var n=0;n<e.length;n++){var r=e[n];t?r[0]==="c"?t.quadraticCurveTo(r[1],-r[2],0,r[3],-r[4],0):t.lineTo(r[0],-r[1],0):(t=new mono.Path,t.moveTo(r[0],-r[1],0))}else for(var n=0;n<e.length;n+=2)t?t.lineTo(e[n],-e[n+1],0):(t=new mono.Path,t.moveTo(e[n],-e[n+1],0));return t},createShapeNode:function(e){var n=e.repeat||100,r=e.amount||2,i=!0;if(e.vertical!==null||e.vertical!=t)i=e.vertical;var s=this.createShapeNodePath(e.data),o;return e.id?o=new mono.ShapeNode({id:e.id,path:s}):o=new mono.ShapeNode(s),e.curveSegments&&o.setCurveSegments(e.curveSegments),o.setAmount(r),o.setVertical(i),o.setRepeat(n),o},createPathCube:function(e){var t=e.width,n=e.height,r=e.data,i=e.insideColor,s=e.outsideColor,o=e.asideColor,u=e.zsideColor,a=e.topColor,f=e.bottomColor,l=e.insideImage||e.image,c=e.outsideImage||e.image,h=e.insideMap,p=e.outsideMap,d=e.repeat||e.height,v=e.closed,m=this.createShapeNodePath(r);v&&m.closePath();var g=new mono.PathCube(m,t,n);return g.s({"outside.m.color":s,"inside.m.type":"basic","inside.m.color":i,"aside.m.color":o||s,"zside.m.color":u||s,"top.m.color":a,"top.m.ambient":a,"bottom.m.color":f||a,"inside.m.lightmap.image":h,"outside.m.lightmap.image":p,"aside.m.lightmap.image":p,"zside.m.lightmap.image":p,"inside.m.texture.image":l,"outside.m.texture.image":c}),g.setRepeat(d),g},getPicInfo:function(e,t){var n={};typeof t=="string"&&(t=[t]);for(var r=0;r<t.length;r++){var i=t[r],s=i.substring(0,i.indexOf(".")).toLowerCase();i=e+i,n[s]=i}return n},getRByD:function(e){return e*Math.PI/180},getDByR:function(e){return e*180/Math.PI},getRsByDs:function(e){var t;if(e&&e.length>0){t=[];for(var n=0;n<e.length;n++)t.push(Fi.Default.getRByD(e[n]))}return t},setObject3dCSProps:function(e,t){t.client&&e.c(t.client),t.style&&e.s(t.style)},setObject3dCommonProps:function(e,t){var n=Fi.Default.getRsByDs(t.rotation)||[0,0,0],r=t.scale||[1,1,1],i=t.position||[0,0,0];e.setRotation(n[0],n[1],n[2]),e.setScale(r[0],r[1],r[2]),e.setPosition(i[0],0,i[2]),Fi.Default.setPositionY(e,i[1]),Fi.Default.setObject3dCSProps(e,t)},cloneObjElement:function(e,t){var n=Fi.Default.getRsByDs(e.rotation)||[0,0,0],r=e.scale||[1,1,1],i=e.position||[0,0,0];i[1]=parseFloat(i[1])||0;var s=this._objObject[e.name],o=s.getBoundingBoxWithChildren(),u=(o.max.y-o.min.y)/2,a=e.singleton?s:s.clonePrefab();e._id&&(a._id=e._id);if(e.client)for(var f in e.client)a.setClient(f,e.client[f]);return e.style&&a.s(e.style),a.setClient("type",e.name),a.setClient("showShadow",e.showShadow),e.showShadow&&(e.shadowType!=null?(a.setClient("shadowType",e.shadowType),a.setClient("shadowWeight",1)):e.showShadowImage&&a.setClient("shadowImage",e.shadowImage)),typeof e.interepter=="function"&&e.interepter.call(this,a),a.setClient("json",e),a.setScale(r[0],r[1],r[2]),a.setPosition(i[0],i[1]+u*r[1],i[2]),a.setRotation(n[0],n[1],n[2]),t&&t(a),a},setDefaultEnvMap:function(e){var t=this.getEnvMap("envmap5");e.setStyle("m.envmap.image",t);var n=e.getDescendants();return n.forEach(function(e){e.setStyle("m.envmap.image",t)}),e},setShadowImage:function(e,t){e.setClient("shadowImage",t),twaver.Util.registerImageByUrl(t,t)},createObj:function(e,t){var n=this;if(this._objObject[e.name]){var r=this.getOBjPath(e.path),i=e.shadowImage=r+e.name+"S.png";return this.cloneObjElement(e,t)}if(!this._objMap[e.name]){this._objMap[e.name]=[];var r=this.getOBjPath(e.path),s=r+e.name+".obj",o=r+e.name+".mtl",u=e.scale||[1,1,1];if(e.showShadow){var i=e.shadowImage=r+e.name+"S.png";e.shadowType==null&&twaver.Util.registerImageByUrl(i,i)}var a=new mono.OBJMTLLoader;a.load(s,o,null,function(t){if(e.merged)t=mono.Utils.mergeElements(t.getDescendants());else if(e.envImages){var r=Fi.Default.getEnvMap("envmap5");t.getDescendants().forEach(function(t){var n=t.getStyle("m.texture.image");if(n){var i=e.envImages;i.forEach(function(e){(n.indexOf(e)>=0||n instanceof Array&&n[0].indexOf(e)>=0)&&t.setStyle("m.envmap.image",r)})}})}n._objObject[e.name]=t,n._objMap[e.name].forEach(function(e){return n.cloneObjElement(e.json,e.callback)})})}else if(e.showShadow){var r=this.getOBjPath(e.path),i=e.shadowImage=r+e.name+"S.png";e.shadowType==null&&twaver.Util.registerImageByUrl(i,i)}this._objMap[e.name].push({json:e,callback:t})},getTextSize:function(e,t){var n=document.createElement("canvas"),r=n.getContext("2d"),i=e.split("\n"),s=0;r.font=t;for(var o=0;o<i.length;o++){var u=i[o],a=r.measureText(u).width;a>s&&(s=a)}var f=r.measureText("e").width*i.length*3+4,l={w:s,h:f};return l},generateTextCanvas:function(e,t,n,r,i,s){var o=document.createElement("canvas"),n=n||"bold 80px 微软雅黑,sans-serif",u=o.getContext("2d"),a=e.split("\n"),f=Fi.Default.getTextSize(e,n),l=f.w,c=f.h,h={width:l,height:c};o.height=mono.Utils.nextPowerOfTwo(f.h),o.width=mono.Utils.nextPowerOfTwo(f.w),r&&(u.save(),u.globalAlpha=1,u.fillStyle=i||"#FE642E",u.beginPath(),u.moveTo(0,0),u.lineTo(l,0),u.lineTo(l,c),u.lineTo(0,c),u.closePath(),u.fill()),u.restore(),u.fillStyle=t||"white",u.textBaseline="middle",u.textAlign="center",u.font=n,s||(u.shadowColor="#585858",u.shadowBlur=25,u.shadowOffsetX=10,u.shadowOffsetY=10);var p=u.measureText("o").width,d=p*2.5;for(var v=0;v<a.length;v++){var m=l/2,g=d*v+d/2+(o.height-h.height);u.fillText(a[v],m,g)}return o.drawRect=h,o},generateShadowNode:function(e,t,n){var r=null,i=e.getDescendants();if(i&&i.length>0)for(var s=0;s<i.length;s++){var o=i[s];if(o instanceof mono.Entity&&o.getClient("type")&&"floor"==o.getClient("type")){r=o;break}}if(!r)return;var u=r.getBoundingBox(),a=u.max.z-u.min.z,f=u.max.x-u.min.x,l=e.getRotation();e.setRotation(0,0,0);var c=Fi.Default.createShadowImage(e,r,t,n);return r.setStyle("top.m.lightmap.image",c),r.invalidateTexture(),Fi.Default.newcanvas=Fi.Default.newcanvas||c,e.setRotation(l),r},_getWorldRotation:function(e){var t=(new mono.Mat4).extractRotation(e.worldMatrix),n=new mono.Vec3;return n.setEulerFromRotationMatrix(t),n},createShadowImage:function(e,t,n,r){var i=r&&r.shadowColor||"#000",s=r&&r.shadowWeight||2,o=t.getBoundingBox(),u=o.max.z-o.min.z,a=o.max.x-o.min.x,f=Math.max(a,u),l=f>4096?Math.ceil(f/4096):1,c=Fi.Default.canvas||document.createElement("canvas"),h=a/l,p=u/l,d=a/h,v=u/p;c.width=h,c.height=p;var m=c.getContext("2d");m.clearRect(0,0,h,p),m.fillStyle="white",m.fillRect(0,0,h,p),m.beginPath();var g=e.getPosition(),y=e?e.getBoundingBox():null,b=-(y.max.x+y.min.x)/2-g.x,w=-(y.max.z+y.min.z)/2-g.z,E=e.getDescendants(),S;for(var x=0;x<E.length;x++){var T=E[x];if(T.getClient&&T.getClient("id")=="wallCombos"){S=T;break}}if(S){var N=S.getClient("combos");N.forEach(function(e){if(e.getClient&&!e.getClient("resetPos")){var t=e.getPosition();e.p(t.x+parseFloat(g.x),t.y+parseFloat(g.y),t.z+parseFloat(g.z)),e.setClient("resetPos",!0)}E.push(e)})}var C;for(var x=0;x<E.length;x++){var T=E[x];if(T.getClient&&T.getClient("id")=="columnCombos"){C=T;break}}if(C){var N=C.getClient("combos");N.forEach(function(e){if(e.getClient&&!e.getClient("resetPos")){var t=e.getPosition();e.p(t.x+parseFloat(g.x),t.y+parseFloat(g.y),t.z+parseFloat(g.z)),e.setClient("resetPos",!0)}E.push(e)})}E.push(e);for(var k=0;k<E.length;k++){var L=E[k],A=L.getWorldPosition(),O=h/2+A.x/d,M=p/2+A.z/v,_=Fi.Default._getWorldRotation(L),D=L.getClient("type"),P=L.getClient("showShadow");P!=0&&(P=!0);if(P&&(D=="wall"||D=="inner_wall"||D=="glass_wall")){var H=L.getClient("data"),B=L.getClient("doorData"),j=L.getClient("wallDepth")*.9;m.save(),m.translate(O,M),m.beginPath();if(H[0]&&H[0]instanceof Array){for(var F=0;F<H.length;F++)F==0?m.moveTo(H[F][0]/d+b/d,H[F][1]/v+w/v):m.lineTo(H[F][0]/d+b/d,H[F][1]/v+w/v);D=="wall"&&m.lineTo(H[0][0]/d+b/d,H[0][1]/v+w/v)}else{for(var F=0;F<H.length;F+=2)F==0?m.moveTo(H[F]/d+b/d,H[F+1]/v+w/v):m.lineTo(H[F]/d+b/d,H[F+1]/v+w/v);D=="wall"&&m.lineTo(H[0]/d+b/d,H[1]/v+w/v)}m.lineWidth=j/d,m.strokeStyle="#ccc",m.shadowColor=i;var I=Math.min(parseInt(a/15),300);m.shadowBlur=parseInt(I/d);if(D=="inner_wall"||D=="glass_wall")m.lineWidth=j/d,m.shadowBlur=parseInt(I/d);m.shadowOffsetX=0,m.shadowOffsetY=0;for(var q=0;q<3;q++)m.shadowBlur=f>=4e3?180+q*80:100+q*50,m.stroke(),q==0&&(m.shadowColor="#666",m.shadowBlur=f>=4e3?300:200,m.stroke(),m.shadowColor="#000",m.shadowBlur=10,m.stroke());if(B){m.save(),m.shadowBlur=100,m.shadowColor="#ffffff";for(var x=0;x<B.length;x+=2){var R=(B[x][0]+b)/l,U=(B[x][1]+w)/l,z=(B[x+1][0]+b)/l,W=(B[x+1
][1]+w)/l,X=50/l,V=200/l,$=m.createLinearGradient(R-X,U-V,R-X,U+V);R==z&&($=m.createLinearGradient(R-V,U-X,R+V,U-X)),R==z?(U+=8/l,W-=8/l):U==W&&(R+=8/l,z-=8/l),$.addColorStop(0,"rgba(255,255,255,0)"),$.addColorStop(.5,"rgba(255,255,255,1)"),$.addColorStop(1,"rgba(255,255,255,0)"),m.fillStyle=$,m.beginPath(),R==z?(m.moveTo(R-V,U-X),m.lineTo(R,U),m.lineTo(R+V,U-X),m.lineTo(R+V,W+X),m.lineTo(z,W),m.lineTo(R-V,W+X)):U==W&&(m.moveTo(R-X,U-V),m.lineTo(z+X,U-V),m.lineTo(z,W),m.lineTo(z+X,W+V),m.lineTo(R-X,W+V),m.lineTo(R,U)),m.closePath(),m.fill()}m.restore()}m.restore()}var P=L.getClient("showShadow");n&&(P=P&&n(L));var J=L.getClient("shadowImage"),K=L.getClient("shadowType")||0,Q=L.getClient("shadowRatio")||.99,G=L.getClient("shadowWeight")||2;if(P){var Y=L.getBoundingBox(),Z=Y.size(),et=Z.x/d*Q,j=depth=Z.z/v*Q;_.y%(Math.PI/2)==0&&(et=Z.x/v*Q,j=depth=Z.z/d*Q),_.y%Math.PI==0&&(et=Z.x/d*Q,j=depth=Z.z/v*Q);if(K==1){var tt=Math.min(Z.x,Z.z);et=tt/d*Q,j=depth=tt/v*Q,_.y%(Math.PI/2)==0&&(et=tt/v*Q,j=depth=tt/d*Q),_.y%Math.PI==0&&(et=tt/d*Q,j=depth=tt/v*Q)}if(J){_=L.getRotation();var nt=twaver.Util.getImageAsset(J);if(!nt)continue;m.save(),m.translate(O+b/d,M+w/v),m.rotate(-_.y);var rt=Math.max(et,depth)*.3,it,st,ot,ut;_.y%(Math.PI/2)==0&&(it=-et/2-rt/2,st=-depth/2-rt/2,ot=et+rt,ut=depth+rt),_.y%Math.PI==0&&(it=-et/2-rt/2,st=-depth/2-rt/2,ot=et+rt,ut=depth+rt),m.drawImage(nt.getImage(),it,st,ot,ut),m.restore()}else if(K==0){m.save(),m.translate(O+b/d,M+w/v),m.rotate(-_.y),m.beginPath(),m.moveTo(-et/2,0),m.lineTo(et/2,0),m.lineWidth=j,m.strokeStyle="gray",m.shadowColor="#333";var at=Math.min(et,depth);m.shadowBlur=at*2,m.shadowOffsetX=0,m.shadowOffsetY=0,G==1?(m.shadowBlur=at*3,m.stroke()):G==2&&(m.stroke(),m.stroke()),m.restore()}else if(K==1){var O=O+b/d,M=M+w/v,ft=L.getClient("shadowRadius");ft?ft/=v:ft=Math.sqrt(et*et+depth*depth)/2,m.save(),m.beginPath(),m.arc(O,M,ft,0,2*Math.PI,!1),m.fillStyle="gray",m.shadowColor=i,m.shadowBlur=ft*2,m.shadowOffsetX=0,m.shadowOffsetY=0,G==1?(m.shadowBlur=ft*3,m.fill()):G==2&&(m.fill(),m.fill()),m.restore()}}}Fi.Default.canvas=Fi.Default.canvas||c;var f=Math.max(2048,Math.max(a/l,u/l)),lt=f/2048,ct=Fi.Default.newcanvas||document.createElement("canvas"),h=mono.Utils.nextPowerOfTwo(a/lt),p=mono.Utils.nextPowerOfTwo(u/lt);ct.width=h,ct.height=p,ct.style.width=h,ct.style.height=p;var ht=ct.getContext("2d");return ht.clearRect(0,0,h,p),ht.fillStyle="white",ht.fillRect(0,0,h,p),ht.drawImage(c,0,0,a/l,u/l,0,0,h,p),ct},getRelativePosition:function(e,t){var n,r;n=(new mono.Mat4).getInverse(e.worldMatrix.clone()),r=(new mono.Mat4).multiplyMatrices(n,t.worldMatrix.clone());var i=main.position=(new mono.Vec3).getPositionFromMatrix(r);return i},getPathBoundingBox:function(e){var t={},n={centerPoint:{x:0,y:0},min:{x:0,y:0},max:{x:0,y:0},size:{x:0,y:0}};if(e.length==0)return n;var r,i,s,o;if(e[0]instanceof Array){r=e[0][0],i=e[0][0],s=-e[0][1],o=-e[0][1];for(var u=1;u<e.length;u++)r=Math.min(r,e[u][0]),i=Math.max(i,e[u][0]),s=Math.min(s,-e[u][1]),o=Math.max(o,-e[u][1])}else{if(e.length<2)return n;r=e[0],i=e[0],s=-e[1],o=-e[1];for(var u=2;u<e.length;u+=2)r=Math.min(r,e[u]),i=Math.max(i,e[u]),s=Math.min(s,-e[u+1]),o=Math.max(o,-e[u+1])}return t.centerPoint={x:(r+i)/2,y:(s+o)/2},t.min={x:r,y:s},t.max={x:i,y:o},t.size={x:i-r,y:o-s},t},setPositionY:function(e,t){if(typeof t=="number")e.setPositionY(t);else if(t==Fi.Default.positionFloor){var n=e.getBoundingBox().size();e.setPositionY(n.y/2)}},playAnimation:function(e,t,n){var r=t.split(":");if(r[0]==="move"){var i=r[1],s=r[2],o=parseInt(r[3])||1e3,u=parseInt(r[4]||0),a=r[5];this.animateMove(e,i,s,o,u,a,n)}if(r[0]==="rotation"){var f=r[1],l=r[2],o=parseInt(r[3])||1e3,u=parseInt(r[4]),a=r[5];this.animateRotate(e,f,l,o,u,a,n)}},animateMove:function(e,t,n,r,i,s,o){s=s||"easeInStrong";var u=e.getBoundingBox().size().multiply(e.getScale()),n=n||.8,a=new mono.Vec3(0,0,1),f=0;t==="right"&&(a=new mono.Vec3(1,0,0),f=u.x),t==="left"&&(a=new mono.Vec3(-1,0,0),f=u.x),t==="top"&&(a=new mono.Vec3(0,1,0),f=u.y),t==="bottom"&&(a=new mono.Vec3(0,-1,0),f=u.y),t==="front"&&(a=new mono.Vec3(0,0,1),f=u.z),t==="back"&&(a=new mono.Vec3(0,0,-1),f=u.z),f*=n,e.getClient("animated")&&(a=a.negate()),a=e.direction2(a);var l=e.getPosition().clone();e.setClient("animated",!e.getClient("animated")),(new twaver.Animate({from:0,to:1,dur:r,easing:s,delay:i,onUpdate:function(t){e.setPosition(l.clone().add(a.clone().multiplyScalar(f*t)))},onDone:function(){o&&o()}})).play()},animateRotate:function(e,n,r,i,s,o,u){o=o||"easeInStrong";var a=e.getBoundingBox().size().multiply(e.getScale()),f=0,l=1;e.getClient("animated")&&(l=-1),e.setClient("animated",!e.getClient("animated"));var c,h;if(n==="left"){c=new mono.Vec3(-a.x/2,0,0);var h=new mono.Vec3(0,1,0)}if(n==="right"){c=new mono.Vec3(a.x/2,0,0);var h=new mono.Vec3(0,1,0)}if(n==="center-z"){c=new mono.Vec3(0,0,0);var h=new mono.Vec3(0,0,1)}var p=new twaver.Animate({from:f,to:l,dur:i,delay:s,easing:o,onUpdate:function(n){this.lastValue===t&&(this.lastValue=0),e.rotateFromAxis(h.clone(),c.clone(),Math.PI/180*-r*(n-this.lastValue)),this.lastValue=n},onDone:function(){delete this.lastValue,u&&u()}});p.play()},animateCameraPosition:function(e,t,n,r){var i=e.getPosition(),s=new twaver.Animate({from:0,to:1,dur:n,easing:"easeBoth",onUpdate:function(n){var r=i.x+(t.x-i.x)*n,s=i.y+(t.y-i.y)*n,o=i.z+(t.z-i.z)*n,u=new mono.Vec3(r,s,o);e.setPosition(u)}});return s.onDone=r,s},playCameraAnimation:function(e,t,n,r){var i=e.getTarget(),s=e.getPosition().sub(e.getTarget()),o=new twaver.Animate({from:0,to:1,dur:500,easing:"easeBoth",onUpdate:function(r){var o=i.x+(n.x-i.x)*r,u=i.y+(n.y-i.y)*r,a=i.z+(n.z-i.z)*r,f=new mono.Vec3(o,u,a);e.lookAt(f),t.target=f;var l=(new mono.Vec3).addVectors(s,f);e.setPosition(l)}});o.onDone=r,o.play()}};for(var Xr in Fi.Utils3D)Fi.Default[Xr]=Fi.Utils3D[Xr];Fi.Default.register("twaver.cube",function(e,t){e.image&&e.image.indexOf("http")<0&&(e.image=Fi.Default.path+e.image);var n=Fi.Default.createCube(e);return e.visible==0&&n.setStyle("m.visible",!1),Fi.Default.setObject3dCommonProps(n,e),t&&t(n),n},{category:"基本模型",type:"mono.Element",name:"立方体",icon:"model/idc/icons/cube.png",description:"立方体是make里面提供的最基本的模型，可以用这种模型扩展出各种立方体形状的模型，比如箱子，柱子，盒子等。支持更改长，宽，高，贴图等基本参数",modelDefaultParameters:{width:{name:"宽",value:100,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},height:{name:"高",value:100,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},depth:{name:"深",value:100,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},color:{name:"颜色",value:"white",type:Fi.Default.PARAMETER_TYPE_COLOR,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},image:{name:"贴图",value:t,type:Fi.Default.PARAMETER_TYPE_IMAGE,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},position:{value:[0,0,0],name:"位置",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1},rotation:{value:[0,0,0],name:"旋转角度",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1}}}),Fi.Default.register("twaver.cylinder",function(e,t){var n=Fi.Default.createCylinder(e),r=e.position||[0,0,0];return n.p(r[0],0,r[2]),Fi.Default.setPositionY(n,r[1]),t&&t(n),n},{category:"基本模型",type:"mono.Element",name:"圆柱体",icon:"model/idc/icons/cylinder.png",description:"圆柱体是make中提供的最基本模型，支持更改半径，高度的参数。可以更改这些参数扩展出各个圆柱体形状的模型，比如圆形柱子，桌子腿，瓶子，圆筒等",modelDefaultParameters:{topRadius:{name:"顶半径",value:60,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},bottomRadius:{name:"底半径",value:60,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},height:{name:"高",value:100,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},color:{name:"颜色",value:"white",type:Fi.Default.PARAMETER_TYPE_COLOR,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},image:{name:"贴图",value:t,type:Fi.Default.PARAMETER_TYPE_IMAGE,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},position:{value:[0,0,0],name:"位置",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1},rotation:{value:[0,0,0],name:"旋转角度",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1}}}),Fi.Default.register("twaver.sphere",function(e,t){var n=Fi.Default.createSphere(e),r=e.position||[0,0,0];return n.p(r[0],0,r[2]),n.setClient("showShadow",!0),n.setClient("shadowType",1),n.setClient("shadowRatio",.3),Fi.Default.setPositionY(n,r[1]),t&&t(n),n},{category:"基本模型",type:"mono.Element",name:"球体",icon:"model/idc/icons/sphere.png",description:"球体是make中提供的最基本模型，支持更改半径的参数。可以更改这些参数扩展出各个球体形状的模型，比如圆球等",modelDefaultParameters:{radius:{name:"半径",value:80,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},color:{name:"颜色",value:"#F5F5F5",type:Fi.Default.PARAMETER_TYPE_COLOR,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},image:{name:"贴图",value:t,type:Fi.Default.PARAMETER_TYPE_IMAGE,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},position:{value:[0,0,0],name:"位置",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1},rotation:{value:[0,0,0],name:"旋转角度",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1}}}),Fi.Default.register("twaver.polygon",function(e,t){var n=Fi.Default.createPolygon(e),r=e.position||[0,0,0];return n.p(r[0],0,r[2]),Fi.Default.setPositionY(n,r[1]),t&&t(n),n},{category:"基本模型",type:"mono.Element",name:"多边形",icon:"model/idc/icons/polygon.png",description:"多边形是make中提供的最基本模型，支持更改半径，高度，边数的参数。可以更改这些参数扩展出各个多边形状的模型，比如多边形柱子，多边形箱子，各种支架等",modelDefaultParameters:{color:{name:"颜色",value:"white",type:Fi.Default.PARAMETER_TYPE_COLOR,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},image:{name:"贴图",value:t,type:Fi.Default.PARAMETER_TYPE_IMAGE,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},topRadius:{name:"顶半径",value:100,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},bottomRadius:{name:"底半径",value:100,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},height:{name:"高",value:200,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},radialSegments:{name:"边数",value:3,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},position:{value:[0,0,0],name:"位置",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1},rotation:{value:[0,0,0],name:"旋转角度",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1}}}),Fi.Default.register("twaver.torus",function(e,t){var n=Fi.Default.createTorus(e),r=e.position||[0,0,0];return n.p(r[0],0,r[2]),Fi.Default.setPositionY(n,r[1]),t&&t(n),n},{category:"基本模型",type:"mono.Element",name:"圆环",icon:"model/idc/icons/torus.png",description:"圆环体是make中提供的最基本模型，支持更改半径，高度，扁平程度，管半径的参数。可以更改这些参数扩展出各个圆环体形状的模型，比如轮胎等",modelDefaultParameters:{color:{name:"颜色",value:"white",type:Fi.Default.PARAMETER_TYPE_COLOR,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},image:{name:"贴图",value:t,type:Fi.Default.PARAMETER_TYPE_IMAGE,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},radius:{name:"半径",value:50,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},tube:{name:"内外径差",value:30,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},tubularSegments:{name:"扁平程度",value:3,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},radialSegments:{name:"边数",value:6,type:Fi.Default.PARAMETER_TYPE_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD},position:{value:[0,0,0],name:"位置",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1},rotation:{value:[0,0,0],name:"旋转角度",type:Fi.Default.PARAMETER_TYPE_ARRAY_NUMBER,propertyType:Fi.Default.PARAMETER_PROPERTY_TYPE_FIELD,editable:!1}}});var zi=0;Fi.Default.register("twaver.combo",function(e,t){var n="pack_"+zi++,r=e.data;if(r&&mono.Utils.isArray(r)){var i=null,s=null,o=[],u=[];for(var a=0;a<r.length;a++){s=Fi.Default.load(r[a]);if(!i)i=s;else{var f=s.getClient("type");f=="inner_wall"||f=="glass_wall"?(o.push(s),s.getChildren().size()>0&&s.getChildren().forEachReverse(function(e){e.setParent(i)})):f=="column"?u.push(s):s.setParent(i)}s.setClient?s.setClient("pack",n):(s.client=s.client||{},s.client.pack=n)}if(o&&o.length>0){var l=new mono.ComboNode(o);l.setClient("id","wallCombos"),l.setClient("combos",l.getCombos()),l.setParent(i)}if(u&&u.length>0){var l=new mono.ComboNode(u);l.setClient("id","columnCombos"),l.setClient("combos",l.getCombos()),l.setParent(i)}return t&&t(i),i}},{icon:"model/idc/icons/combo.png",category:"基本模型",type:"mono.Element",name:"组合模型",description:"组合模型，可以把多个不同的模型组合在一块，组成一个新的模型，传如参数是一个数组"}),Fi.Default.registerObj=function(e,t,n,r,i,s,o,u,a,f,l){r=r||{},r.async=!0;var c=function(e,u){return e.name=t,e.path=n,e.showShadow=i,i&&(e.showShadowImage=!0),e.shadowType=s,e.merged=o,e.envImages=f,e.singleton=l,a&&(e.style=a),e.merged==null&&(e.merged=!0),e.interepter=r.interepter,Fi.Default.createObj(e,u)};Fi.Default.register(e,c,r)},Fi.Default.register("twaver.loader",function(e,t){return Fi.Default.load(e.data,t)}),Fi.Utils3D.getRectOfPoints=function(e){if(!e||e.length/2<2)return null;var t=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,s=0,o=e.length,u=[],a=function(e,s){r=Math.min(r,e),i=Math.max(i,e),t=Math.min(t,s),n=Math.max(n,s),u.push({x:e,y:s})};if(o>0&&e[s]instanceof Array)for(;s<o;s++){var f=e[s];f.length==2?a(f[0],f[1]):f.length==5&&f[0]=="c"&&a(f[3],f[4])}else for(;s<o;s+=2)a(e[s],e[s+1]);return{min:{x:r,y:t},max:{x:i,y:n},center:function(){return{x:(r+i)/2,y:(t+n)/2}},width:i-r,height:n-t,points:u}}})(window);

(function (window, undefined) {

    /**
     *
     * @namespace
     */
    var doodle = {};
    window.doodle = doodle;

    //临时命名空间
    var nsp = {};
    nsp.edit = {};
    nsp.edit.interaction = {};
    nsp.edit.ui = {};
    nsp.edit.data = {};

    doodle._version = '1.5.4';

    /**
     * 取得doodle的版本
     * @returns {string}
     */
    doodle.getVersion = function () {
        return doodle._version;
    }

    doodle._debug = false;

    /**
     *
     * @returns {boolean}
     */
    doodle.isDebug = function () {
        return doodle._debug;
    }

    /**
     * 获取一个可以唯一识别的字符串
     * @param p {String} 前缀
     * @returns {String}
     */
    doodle.id = function (p) {
        if (doodle.isDebug()) {
            return doodle.debugId(p);
        }
        p = p || '';
        return p + _twaver.id();
    }

    /*
     * 默认从这里获取id
     */
    doodle.idIndex = 10000;
    doodle.ID_PREFIX = 'doodle'
    doodle.debugId = function (p) {
        return (p ? p : doodle.ID_PREFIX) + '-' + doodle.idIndex++;
    }

    //doodle.objectWrapper = function(object, fields) {
    //    var result = new doodle.ObjectWrapper(object);
    //    fields.forEach(function(field){
    //        result.__defineGetter__(field, function () {
    //            return result._object[field];
    //        });
    //        result.__defineSetter__(field, function (name) {
    //            this.val = name;
    //        })
    //    });
    //
    //    return result;
    //}
    //
    //var ObjectWrapper = doodle.ObjectWrapper = function(object){
    //    this._object = object;
    //    this.client = {}
    //    this.style = {}
    //}
    //mono.extend(ObjectWrapper, mono.PropertyChangeDispatcher);



    /**
     *
     * @constructor
     */
    var Utils = function () {

    };


    /**
     * check obj is not null
     *
     * if obj not in [undefined,'undefined',null,'null','']  return true
     * @param obj {*}
     * @returns {boolean}
     */
    Utils.prototype.isNotNull = function (obj) {
        return obj !== undefined && obj !== 'undefined' && obj !== null && obj !== 'null' && obj !== '';
    };

    /**
     * load file
     * call onLoad function when loaded file
     * @param url {string}
     * @param onLoad {Function} onLoad(responseText)
     */
    Utils.prototype.loadFile = function (url, onLoad) {
        if (url) {
            var request = new XMLHttpRequest();
            if (onLoad !== undefined) {
                request.addEventListener('load', function (event) {
                    onLoad(event.target.responseText);
                }, false);
            }
            request.open('GET', url, true);
            request.send(null);
        }
    };

    /**
     * is ctrl key down
     * @param evt {MouseEvent}
     * @returns {boolean|*}
     */
    Utils.prototype.isCtrlDown = function (evt) {
        return evt.ctrlKey || evt.metaKey;
    };

    /**
     * is alt key down
     * @param evt {MouseEvent}
     * @returns {boolean}
     */
    Utils.prototype.isAltDown = function (evt) {
        return evt.altKey;
    };

    /**
     * is shift key down
     * @param evt {MouseEvent}
     * @returns {boolean}
     */
    Utils.prototype.isShiftDown = function (evt) {
        return evt.shiftKey;
    };

    /**
     * load scene editor accordion data
     * @returns {object[]}
     */
    Utils.prototype.load2dSceneCategory = function () {
        var accordionData = new doodle.AccordionData();
        accordionData.filterCategory = function (category) {
            if (category == '2d房间模型' ||
                category == '2d机柜模型' ||
                category == '2d环境模型' ||
                category == '2d部件模型' ||
                category == '2d办公模型') {
                return true;
            }
            return false;
        }
        accordionData.sortCategories = function (categories) {

            return categories;
        }

        accordionData.filterModel = function (id) {
            if (id == "twaver.idc.floor.top" ||
                id == "twaver.idc.column.top") {
                return false;
            }
            return true;
        }
        return accordionData.getData();
    };

    /**
     * load rack editor accordion data
     * if you known rack type, editor will show rack model, you count not change other model
     * @param showRack {boolean} true: show all rack model
     * @returns {object[]}
     */
    Utils.prototype.load2dRackCategory = function (showRack) {
        var accordionData = new doodle.AccordionData();
        accordionData.filterCategory = function (category) {
            if (category == '基本模型') {
                return false
            }
            if (category == '') {
                return false;
            }
            if (!showRack && category != '设备2D' && category != '设备模板') {
                return false;
            }
            if (category != '机柜' && category != '设备2D' && category != '设备模板' && category != '机柜模板') {
                return false;
            }

            return true;
        }
        accordionData.filterModel = function (id) {
            if (id.indexOf('.back.') >= 0) {
                return false;
            }
        }
        return accordionData.getData();
    };

    /**
     * load device editor accordion data
     * @returns {object[]}
     */
    Utils.prototype.load2dDeviceCategory = function () {
        var accordionData = new doodle.AccordionData();
        accordionData.filterCategory = function (category) {
            if (category == '基本模型') {
                return false
            }
            if (category == '') {
                return false;
            }
            if (['设备面板', '面板部件', '面板背板', '单板面板'].indexOf(category) < 0) {
                return false;
            }
            return true;
        }
        accordionData.filterModel = function (id) {
            //过滤掉面板部件的空白部件
            if (id == 'twaver.idc.component.panel') {
                return false;
            }
            //过滤掉面板背板的空白背板
            if (id == 'twaver.idc.background.panel') {
                return false;
            }
            return true;
        }
        return accordionData.getData();
    };

    /**
     * load chassis editor accordion data
     * @returns {object[]}
     */
    Utils.prototype.load2dChassisCategory = function () {
        var accordionData = new doodle.AccordionData();
        accordionData.filterCategory = function (category) {
            if (category == '基本模型') {
                return false
            }
            if (category == '') {
                return false;
            }
            if (['设备面板', '单板'].indexOf(category) < 0) {
                return false;
            }
            return true;
        }
        return accordionData.getData();
    };

    /**
     * load circuit editor accordion data
     * @return {object[]}
     */
    Utils.prototype.load2dCircuitCategory = function () {
        var accordionData = new doodle.AccordionData();
        accordionData.filterCategory = function (category) {
            if (category == '基本模型') {
                return false;
            }
            if (category == '') {
                return false;
            }

            if (category == '基本') {
                return true;
            }
            if (['组件', ].indexOf(category) < 0) {
                return false;
            }
            return true;
        }
        return accordionData.getData();
    };


    /**
     * load model editor accordion data
     * @returns {object[]}
     */
    Utils.prototype.load3dModelCategory = function () {
        var accordionData = new doodle.AccordionData();
        accordionData.filterCategory = function (category) {
            if (category == "基本模型" || category == "机柜模型" || category == "设备模型" ||
                category == "板卡") {
                return true;
            }
            return false;
        }

        accordionData.filterModel = function (id) {
            if (id == "twaver.combo" || id.indexOf('.top') >= 0) { //组合模型为抽象模型不展示,.top为2d拓扑id也不需要展示
                return false;
            }
            return true;
        }

        return accordionData.getData();

    };

    /**
     * transformAndScaleCanvasContext
     *
     * @param canvas
     * @param force
     * @returns {CanvasRenderingContext2D}
     */
    Utils.prototype.transformAndScaleCanvasContext = function (canvas, force) {
        var context = canvas.getContext("2d");
        if (!force && canvas.isTransfor && canvas.width && canvas.height) return context;

        var devicePixelRatio = window.devicePixelRatio || 1,
            backingStoreRatio = context.webkitBackingStorePixelRatio ||
            context.mozBackingStorePixelRatio ||
            context.msBackingStorePixelRatio ||
            context.oBackingStorePixelRatio ||
            context.backingStorePixelRatio || 1,

            ratio = devicePixelRatio / backingStoreRatio;

        if (devicePixelRatio !== backingStoreRatio) {

            var oldWidth = canvas.offsetWidth;
            var oldHeight = canvas.offsetHeight;

            canvas.width = oldWidth * ratio;
            canvas.height = oldHeight * ratio;

            canvas.style.width = oldWidth + 'px';
            canvas.style.height = oldHeight + 'px';

            // now scale the context to counter
            // the fact that we've manually scaled
            // our canvas element
            context.scale(ratio, ratio);

        }
        if (canvas.width && canvas.height) canvas.isTransfor = true;
        return context;
    };

    /**
     * play move camera animate
     * call onDone function after animate finish
     * @param camera {mono.Camera}
     * @param interaction {mono.BaseInteraction}
     * @param oldPoint {Object(x, y)}
     * @param newPoint {Object(x, y)}
     * @param onDone {Function} onDone()
     */
    Utils.prototype.animateCamera = function (camera, interaction, oldPoint, newPoint, onDone) {
        var offset = camera.getPosition().sub(camera.getTarget());
        var animation = new twaver.Animate({
            from: 0,
            to: 1,
            dur: 500,
            easing: 'easeBoth',
            onUpdate: function (value) {
                var x = oldPoint.x + (newPoint.x - oldPoint.x) * value;
                var y = oldPoint.y + (newPoint.y - oldPoint.y) * value;
                var z = oldPoint.z + (newPoint.z - oldPoint.z) * value;
                var target = new mono.Vec3(x, y, z);
                camera.lookAt(target);
                interaction.target = target;
                var position = new mono.Vec3().addVectors(offset, target);
                camera.setPosition(position);
            },
        });
        animation.onDone = onDone;
        animation.play();
    };

    /**
     * find object3d from mouse event
     * if click background, return null
     * if filter function is undefined, set filter value to doodle.utils.findFirstObjectByMouseFilter
     * @param network {mono.Network}
     * @param mouseEvent {MouseEvent}
     * @param filter {Function} filter(object3d) default value is doodle.utils.findFirstObjectByMouseFilter
     * @returns {mono.Data}
     */
    Utils.prototype.findFirstObjectByMouse = function (network, mouseEvent, filter) {
        if (filter === undefined) {
            filter = this.findFirstObjectByMouseFilter;
        }
        var objects = network.getElementsByMouseEvent(mouseEvent);
        if (objects.length) {
            if (filter) {
                for (var i = 0; i < objects.length; i++) {
                    var first = objects[i];
                    var object3d = first.element;
                    if (filter(object3d)) {
                        return first;
                    }
                }
            } else {
                return objects[0];
            }
        }
        return null;
    };

    /**
     * check object3d selectable from mouse event
     * Billboard could not be selected
     * @param object3d {mono.Data}
     * @returns {boolean}
     */
    Utils.prototype.findFirstObjectByMouseFilter = function (object3d) {
        return !(object3d instanceof mono.Billboard)
    };

    /**
     * get param from window.location
     * eg:/doodle/rackEditor.html?modelClass=twaver.idc.rack42&objectId=C25
     * call function getUrlParam('modelClass') ,return 'twaver.idc.rack42'
     * @param name {string}
     * @returns {string}
     */
    Utils.prototype.getUrlParam = function (name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(decodeURIComponent(r[2]));
        return null;
    };

    /**
     * get model parameter from make
     * default property type is make.Default.PARAMETER_PROPERTY_TYPE_CLIENT
     * default property category is 'attributes'
     * @param id {string}
     * @returns {twaver.Property[]}
     */
    Utils.prototype.getModelParameter = function (id) {
        return make.Default.getModelDefaultParameters(id);
    };

    /**
     * initialize property sheet
     * @param sheet {twaver.PropertySheet}
     */
    Utils.prototype.initPropertySheet = function (sheet) {

        sheet.setEditable(true);
        var sheetBox = sheet.getPropertyBox();
    };

    /**
     * add properties into property sheet box
     * @param box {twaver.PropertyBox}  property sheet box
     * @param properties {twaver.Property[]} properties
     */
    Utils.prototype.addProperties = function (box, properties) {


        properties.forEach(function (prop) {

            box.add(prop);
        })
    };

    /**
     *  create scene network3d
     * args 中参数说明
     * renderView:
     *     传入将要渲染3d界面的html元素
     *     可以是元素本身,可以是id,也可以是className,
     *     如果不传该参数或如果前面三种方式均找不到html元素,方法内部会创建一个div,添加到body中
     * network
     *     传入mono.Network3D实例,如果不传值,内部会创建一个实例
     * initialized
     *     是否已经初始化network对象
     *     如果是null或undefined,会初始化network里面的相机等参数
     * @param args {Object(renderView,network, initialized)}
     * @returns network: mono.Network3D
     */
    Utils.prototype.createSceneNetwork3D = function (args) {

        var self = this;
        args = args || {};
        var network = args.network || new mono.Network3D();
        var box = network.getDataBox();

        if (!args.initialized) {
            var camera = new mono.PerspectiveCamera(30, 1.5, 50, 20000);
            network.setCamera(camera);
            camera.p(1328.647469988342, 2925.856952899234, 2084.0725294541244);
            camera.look(new mono.Vec3(1356.0876637604608, 255.78986100252212, -567.4369627978233));

            var interaction = network.getDefaultInteraction();
            interaction.yLowerLimitAngle = Math.PI / 180 * 2;
            interaction.yUpLimitAngle = Math.PI / 2;
            interaction.maxDistance = 10000;
            interaction.minDistance = 50;
            interaction.zoomSpeed = 3;
            interaction.panSpeed = 0.2;
            network.setInteractions([interaction]);

            var pointLight = new mono.PointLight(0xFFFFFF, 0.1);
            pointLight.setPosition(8000, 8000, 8000);
            box.add(pointLight);
            box.add(new mono.AmbientLight('white'));
        }

        var rootView = network.getRootView();
        var renderView = null;
        if (args.renderView && typeof args.renderView != 'string') {
            renderView = args.renderView;
        }
        if (!renderView) {
            renderView = document.getElementById(args.renderView)
        }
        if (!renderView) {
            renderView = document.getElementsByClassName(args.renderView)[0];
        }
        if (!renderView) {
            renderView = document.createElement('div')
            renderView.setAttribute('class', 'renderView-scene-3d');
            renderView.style.position = 'absolute';
            renderView.style.width = '100%';
            renderView.style.height = '100%';
            document.body.appendChild(renderView);
        }
        renderView.appendChild(rootView);
        mono.Utils.autoAdjustNetworkBounds(network, renderView, 'clientWidth', 'clientHeight', 0, 0);
        var oldClass = rootView.getAttribute('class');
        if (!oldClass) {
            oldClass = '';
        }
        rootView.setAttribute('class', oldClass + '  network3d-view');
        rootView.addEventListener('dblclick', function (e) {
            self.handleDoubleClick(e, network, args.handleDoubleClick);
        });
        return network;
    };

    /**
     * load scene data
     * if filter return true, do not add into box
     * @param box {mono.DataBox}
     * @param data {Object[]}
     * @param filter {Function} filter(data)
     */
    Utils.prototype.loadSceneData = function (box, data, filter) {
        var self = this;
        make.Default.load(data, function (result) {
            for (var i in result) {
                var data = result[i];
                if (filter && filter(data)) {
                    continue;
                }
                box.addByDescendant(data);
            }
        });
    };

    /**
     * load device data
     * @param box {mono.DataBox} box
     * @param rack {mono.Element} 机柜节点
     * @param data {Object[]} 设备数据
     * @param filter {Function} filter(node) 返回true,过滤当前设备
     */
    Utils.prototype.loadDeviceData = function (box, rack, data, filter) {

        var self = this;
        var parentNode = rack;
        var offsetY = make.Default.RACK_OFFSET_Y;
        var unitHeight = make.Default.getUnitHeight();
        var pbb = parentNode.getBoundingBox();
        var result = make.Default.load(data);
        for (var i in result) {
            var node = result[i];
            if (filter && filter(node)) {
                continue;
            }
            var location = data[i].client.loc;
            var bb = node.getBoundingBox();
            var y = offsetY + (location - 1) * unitHeight - (pbb.max.y - pbb.min.y) / 2 + (bb.max.y - bb.min.y) / 2;
            node.setY(y);
            node.setZ((pbb.max.z - pbb.min.z) / 2 - (bb.max.z - bb.min.z) / 2 + 1);
            node.setParent(parentNode);
            box.addByDescendant(node);
        }
    };

    /**
     * double click in 3d
     * @param e {MouseEvent}
     * @param network {mon.Network}
     * @param handler {Function} handler(element, network, firstClickObject, e);
     */
    Utils.prototype.handleDoubleClick = function (e, network, handler) {
        var camera = network.getCamera();
        var interaction = network.getDefaultInteraction();
        var firstClickObject = this.findFirstObjectByMouse(network, e);
        if (firstClickObject) {
            var element = firstClickObject.element;
            var newTarget = firstClickObject.point;
            var oldTarget = camera.getTarget();
            this.animateCamera(camera, interaction, oldTarget, newTarget, function () {
                if (element.getClient('animation')) {
                    make.Default.playAnimation(element, element.getClient('animation'));
                }
            });
            if (element.getClient('dbl.func')) {
                var func = element.getClient('dbl.func');
                func(element, network, firstClickObject, e);
            } else if (element.getClient('type') == 'rack_door') {
                var func = element.getParent().getClient('dbl.func');
                func && func(element.getParent(), network, firstClickObject, e);
            }
            handler && handler(element, network, firstClickObject, e);
        } else {
            var oldTarget = camera.getTarget();
            var newTarget = new mono.Vec3(0, 0, 0);
            this.animateCamera(camera, interaction, oldTarget, newTarget);
        }
    };

    /**
     *
     * create panel dialog
     * @returns {HTMLDivElement}
     */
    Utils.prototype.createPanelDialog = function () {

        if (window.$ && window.$.ui && window.$.ui.dialog) {

            var content = $("<div class='panel-main'></div>").appendTo(document.body);
            $(content).dialog({
                "title": "设备面板",
                "width": 1000,
                "height": 500,
                modal: true,
                close: function () {
                    content.network.dispose();
                    content.remove();
                }
            });
            return content;
        } else {
            throw 'there is not import jquery and jquery-ui.js'
        }
    };


    /**
     *  create device panel network2d
     * args 中参数说明
     * renderView:
     *     传入将要渲染3d界面的html元素
     *     可以是元素本身,可以是id,也可以是className,
     *     如果不传该参数或如果前面三种方式均找不到html元素,方法内部会创建一个div,添加到body中
     * network
     *     传入twaver.vector.Network实例,如果不传值,内部会创建一个实例
     * @param args {Object(renderView, network)}
     * @returns network {twaver.vector.Network}
     */
    Utils.prototype.createPanelNetwork2D = function (args) {

        args = args || {};

        var network = args.network || new twaver.vector.Network();
        var box = network.getElementBox();
        var view = network.getView();
        network.setMaxZoom(50);
        view.setAttribute('class', 'network-view-device-panel');
        var renderView = null;
        if (args.renderView && typeof args.renderView != 'string') {
            renderView = args.renderView;
        }
        if (!renderView) {
            renderView = document.getElementById(args.renderView)
        }
        if (!renderView) {
            renderView = document.getElementsByClassName(args.renderView)[0];
        }
        if (!renderView) {
            renderView = document.createElement('div')
            renderView.setAttribute('class', 'renderView-panel');
            renderView.style.position = 'absolute';
            renderView.style.width = '100%';
            renderView.style.height = '100%';
            document.body.appendChild(renderView);
        }
        renderView.appendChild(view);
        var w = renderView.clientWidth;
        var h = renderView.clientHeight;
        network.adjustBounds({ x: 0, y: 0, width: w, height: h });
        setTimeout(function () {
            network.zoomOverview();
        }, 500)
        return network;
    };

    /**
     * load panel data
     * @param box {twaver.ElementBox}
     * @param data {Object[]}
     * @param x {number}
     * @param y {number}
     * @param scale {number}
     */
    Utils.prototype.loadPanelData = function (box, data, x, y, scale) {
        scale = scale || 1;
        x = x || 0;
        y = y || 0;
        var node = make.Default.load({
            id: 'twaver.idc.panel.loader',
            data: data,
            scale: scale,
            x: x,
            y: y
        });
        if (node instanceof Array) {
            node.forEach(function (n) {
                box.addByDescendant(n);
            })
        } else {
            box.addByDescendant(node);
        }

    };

    /**
     * 取得场景编辑器器中3d模型id, 传入2d模型id
     * @param id {String}
     * @returns {String}
     */
    Utils.prototype.getSceneEditorModel3dId = function (id) {

        var id3 = id.replace($consts.MODEL_SUFFIX_SEPARATOR + $consts.SCENE_MODEL_SUFFIX, '');
        var id2 = id3 + $consts.MODEL_SUFFIX_SEPARATOR + $consts.SCENE_MODEL_SUFFIX;
        return $consts.sceneEditorModel2dTo3dMapping[id2] || id3;
    };

    /**
     * 取得场景编辑器器中2d模型id, 传入3d模型id
     * @param id {String}
     * @returns {String}
     */
    Utils.prototype.getSceneEditorModel2dId = function (id) {

        var id3 = id.replace($consts.MODEL_SUFFIX_SEPARATOR + $consts.SCENE_MODEL_SUFFIX, '');
        var id2 = id3 + $consts.MODEL_SUFFIX_SEPARATOR + $consts.SCENE_MODEL_SUFFIX;
        return $consts.sceneEditorModel3dTo2dMapping[id3] || id2;
    };

    /**
     * 取得机柜编辑器器中3d模型id, 传入2d模型id
     * @param id {String}
     * @returns {String}
     */
    Utils.prototype.getRackEditorModel3dId = function (id) {

        var id3 = id.replace($consts.MODEL_SUFFIX_SEPARATOR + $consts.RACK_MODEL_SUFFIX, '');
        var id2 = id3 + $consts.MODEL_SUFFIX_SEPARATOR + $consts.RACK_MODEL_SUFFIX;
        return $consts.rackEditorModel2dTo3dMapping[id2] || id3;
    };

    /**
     * 取得机柜编辑器器中3d模型id, 传入2d模型id
     * @param id {String}
     * @returns {String}
     */
    Utils.prototype.getRackEditorModel2dId = function (id) {

        var id3 = id.replace($consts.MODEL_SUFFIX_SEPARATOR + $consts.RACK_MODEL_SUFFIX, '');
        var id2 = id3 + $consts.MODEL_SUFFIX_SEPARATOR + $consts.RACK_MODEL_SUFFIX;
        return $consts.rackEditorModel3dTo2dMapping[id3] || id2;
    };

    /**
     * 取得设备编辑器器中3d模型id, 传入2d模型id
     * @param id {String}
     * @returns {String}
     */
    Utils.prototype.getDeviceEditorModel3dId = function (id) {

        var id3 = id.replace($consts.MODEL_SUFFIX_SEPARATOR + $consts.DEVICE_MODEL_SUFFIX, '');
        var id2 = id3 + $consts.MODEL_SUFFIX_SEPARATOR + $consts.DEVICE_MODEL_SUFFIX;
        return $consts.deviceEditorModel2dTo3dMapping[id2] || id3;
    };

    /**
     * 取得设设备编辑器器中3d模型id, 传入2d模型id
     * @param id {String}
     * @returns {String}
     */
    Utils.prototype.getDeviceEditorModel2dId = function (id) {

        var id3 = id.replace($consts.MODEL_SUFFIX_SEPARATOR + $consts.DEVICE_MODEL_SUFFIX, '');
        var id2 = id3 + $consts.MODEL_SUFFIX_SEPARATOR + $consts.DEVICE_MODEL_SUFFIX;
        return $consts.deviceEditorModel3dTo2dMapping[id3] || id2;
    };

    /**
     * create import dialog
     * @param title {String}
     * @param ext {String} file suffix
     * @param callback {Function} callback(fileContent)
     * @returns {nsp.edit.Dialog}
     */
    Utils.prototype.createImportDialog = function (title, ext, callback, isBuffer) {

        this.fileIndex = this.fileIndex || 1;
        var id = 'files-' + this.fileIndex;
        this.fileIndex++;
        var importDialog = new nsp.edit.Dialog(title, {
            OK: function () {
                var files = $('#' + id)[0];
                if (files.files && files.files.length > 0) {
                    var file = files.files[0];
                    if (file.name.indexOf(".") > 0) {
                        var fi = file.name.split(".");
                        if (fi[1] != ext) {
                            alert('file format should be ' + ext);
                            return;
                        }
                        var reader = new FileReader();
                        if (isBuffer) {
                            reader.readAsArrayBuffer(file);
                        } else {
                            reader.readAsText(file);
                        }
                        reader.onloadend = function () {
                            if (reader.error) {
                                console.log(reader.error);
                            } else {
                                if (callback) {
                                    callback(reader.result);
                                }
                            }
                        }
                    }
                }
                $(this).dialog("close");
            },
            Cancel: function () {
                $(this).dialog("close");
            }
        });
        importDialog.init();
        importDialog.getView().dialog("option", "width", 450);
        importDialog.getView().dialog("option", "height", 180);
        var innerHTML = "" +
            "<div" +
            "   ><label class='field'>File Path:</label>" +
            "   <input id='" + id + "' type='file' class='input' size='20'/>" +
            "</div>";
        importDialog.setData(innerHTML);
        return importDialog;
    };


    /**
     * create export dialog
     * @param text {String} export data string
     */
    Utils.prototype.createExportDialog = function (text) {
        if (text instanceof Object) {
            text = JSON.stringify(text);
        }
        var content = "<div>导出数据：<br><textarea>" + text + "</textarea></div>";
        $(content).dialog({
            "title": "导出json",
            "width": 400,
            "height": 500
        });
    };

    Utils.prototype.createJsonObject = function (jsonBox, jsons, id) {
        if (jsons.length > 0) {
            for (var i = 0; i < jsons.length; i++) {
                var json = jsons[i];
                if (id) json.dataType = id;
                var jsonData = $utils._getJsonData(json);
                jsonBox.add(jsonData);
            }
        }
    };

    Utils.prototype._getJsonData = function (json) {
        var node = new nsp.edit.data.JsonObject();
        var id = json.id;
        var datas = json.data;
        var position = json.position || [0, 0, 0];
        var width = json.width;
        var depth = json.depth;
        if (id) {
            node.id = id;
        }
        if (json.objectId) {
            node.objectId = json.objectId;
        }

        //set Data
        if (datas != null && datas.length > 0) {
            var data = [];
            if (datas[0] instanceof Array) {
                for (var i = 0; i < datas.length; i++) {
                    var data1 = datas[i],
                        length = datas[i].length;
                    if (length == 2) {
                        data.push([data1[0] - position[0], data1[1] - position[2]]);
                    } else if (length == 5) {
                        data.push([data1[0], data1[1] - position[0], data1[2] - position[2], data1[3] - position[0], data1[4] - position[2]]);
                    }
                }
            } else {
                for (var i = 0; i < datas.length; i = i + 2) {
                    data.push([datas[i] - position[0], datas[i + 1] - position[2]]);
                }
            }

            node.setData(data);
        }

        if (json.children) {
            var children = [];
            for (var i = 0; i < json.children.length; i++) {
                var childJson = json.children[i];
                var child = $utils._getJsonData(childJson);
                children.push(child);
            }

            node.setChildren(children);
        }

        if (position) {
            node.setPosition(position);
        }

        if (width) {
            node.setWidth(width);
        }

        if (depth) {
            node.setDepth(depth);
        }

        if (json.rotation) {
            node.setRotation(json.rotation);
        }

        if (json.closed) {
            node.setClosed(json.closed);
        }

        if (json.showFloor) {
            node.setShowFloor(json.showFloor);
        }

        json.client = json.client || {};
        json.client['label'] = make.Default.getName(id);
        if (json.dataType) {
            node.client['dataType'] = json.dataType;
        }
        if (json.client) {
            node.setClient(json.client);
        }

        return node;
    };

    Utils.prototype.isEditModel = function (element) {

        return true;
    };

    Utils.prototype.isMoveModel = function (element) {

        return true;
    };


    Utils.prototype.isChild = function (element) {
        var type = element.getClient('type');
        var types = ['door', 'window'];
        if (type && types.indexOf(type) >= 0) {
            return true;
        }
        return false;
    };


    Utils.prototype.stopPropagation = function (e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        if (e.preventDefault) {
            e.preventDefault();
        } else {
            e.returnValue = false;
        }
    };

    Utils.prototype.parseDxf = function (text) {

        var importDxf = new nsp.edit.ImportDxf();
        var jsons = importDxf.loadDxf(text);
        return jsons;
    };


    /**
     * object 转成json
     * @param o {Object}
     * @return {string}
     */
    Utils.prototype.o2s = function (o) {
        try {
            return JSON.stringify(o)
        } catch (e) {
            throw e;
        }
    };

    /**
     * json装成object
     * @param s {string}
     * @return {Object}
     */
    Utils.prototype.s2o = function (s) {

        try {
            return JSON.parse(s)
        } catch (e) {
            throw e;
        }
    };

    /**
     * 复制一个对象
     * @param o
     * @returns {Object}
     */
    Utils.prototype.clone = function (o) {
        if (o.clone) {
            return o.clone();
        }
        return $utils.s2o($utils.o2s(o));
    };


    /**
     * 继承
     * @param subClass {Object} child class
     * @param superClass {Object} parent class
     * @param o
     */
    Utils.prototype.ext = function (subClass, superClass, o) {
        var prototype = subClass.prototype;
        twaver.Util.ext(subClass, superClass, o);

        if (prototype && subClass.prototype) {
            for (var p in prototype) {
                subClass.prototype[p] = prototype[p];
            }
        }
    }

    Utils.prototype.addMask = function (maskId) {
        var back;
        var bWidth = parseInt(document.body.scrollWidth);
        var bHeight = parseInt(document.body.scrollHeight);
        //add mask
        back = document.createElement("div");
        if (maskId) {
            back.setAttribute('id', 'mask_' + maskId);
        } else {
            back.setAttribute('id', 'mask');
        }
        back.setAttribute("class", "mask");
        document.body.appendChild(back);
        return back;
    }

    Utils.prototype.setDialogRect = function (dialogID) {
        var mask = document.getElementById('mask');
        if (document.getElementById('mask_' + dialogID)) {
            mask = document.getElementById('mask_' + dialogID);
        }
        if (mask) {
            var windowWidth = mask.offsetWidth;
            var windowHeight = mask.offsetHeight;
            var div = document.getElementById(dialogID);
            var divWidth = div.offsetWidth;
            var divHeight = div.offsetHeight;
            div.style.left = windowWidth / 2 - divWidth / 2 + 'px';
            div.style.top = windowHeight / 2 - divHeight / 2 + 'px';
        }
    }

    /**
     * 从url中取得值
     * @param uri
     * @param val
     * @returns {*}
     *  @example
     *  http://
     */
    Utils.prototype.queryString = function (uri, val) {
        var re = new RegExp("" + val + "=([^&?]*)", "ig");
        return ((uri.match(re)) ? (uri.match(re)[0].substr(val.length + 1)) : null);
    }

    /**
     * 判断pint是否在rect中
     * @param point
     * @param rect
     * @returns {boolean}
     */
    Utils.prototype.isPointInRect = function (point, rect) {
        return (point.x > rect.x && point.x < (rect.x + rect.width)) && (point.y > rect.y && (point.y < (rect.y + rect.height)));
    };

    /**
     * 移动选中的元素
     * @param databox
     * @param type
     * @param xgap
     * @param ygap
     */
    Utils.prototype.moveSelectionElements = function (databox, type, xgap, ygap) {
        var selections = databox.getSelectionModel().getSelection();
        if (selections.size() > 0) {
            var xoffset = 0;
            var yoffset = 0;
            if (type === "left") {
                xoffset = -xgap;
            }
            if (type === "right") {
                xoffset = xgap;
            }
            if (type === "top") {
                yoffset = -ygap;
            }
            if (type === "bottom") {
                yoffset = ygap;
            }
            twaver.Util.moveElements(selections, xoffset, yoffset, false);
        }
    }

    Utils.prototype.isNodeInNode = function (parentNode, childNode) {
        var points = this.getNodePoints(parentNode);
        var point = childNode.getCenterLocation();
        return this.isPointInPolygon(points, point);
    }

    /**
     * 判断一个点是否在一堆点围成的多边形里面里面
     * @param points
     * @param point
     * @returns {boolean}
     */
    Utils.prototype.isPointInPolygon = function (points, point) {
        var i = 0,
            j = 0,
            c = false,
            size = points.length;
        for (i = 0, j = size - 1; i < size; j = i++) {
            var p1 = points[i];
            var p2 = points[j];
            if (((p1.y > point.y) != (p2.y > point.y)) && (point.x < (p2.x - p1.x) * (point.y - p1.y) / (p2.y - p1.y) + p1.x)) {
                c = !c;
            }
        }
        return c;
    }

    /**
     * 绕一个点旋转
     * @param point 将要旋转的点
     * @param angle 旋转的弧度
     * @param centerPoint 绕centerPoint旋转
     * @returns {{x: *, y: *}}
     */
    Utils.prototype.rotatePoint = function (point, angle, centerPoint) {

        var centerPoint = centerPoint || { x: 0, y: 0 };
        var rx0 = centerPoint.x;
        var ry0 = centerPoint.y;
        var x = point.x;
        var y = point.y;
        var a = angle;
        var x0 = (x - rx0) * Math.cos(a) - (y - ry0) * Math.sin(a) + rx0;
        var y0 = (x - rx0) * Math.sin(a) + (y - ry0) * Math.cos(a) + ry0;
        return { x: x0, y: y0 }
    }

    /**
     * 取得节点的边框的坐标点
     * @param node
     * @returns {Array}
     */
    Utils.prototype.getNodePoints = function (node) {
        var self = this;
        if (node instanceof twaver.ShapeNode) {
            return node.getPoints().toArray();
        }
        var center = node.getCenterLocation();
        var angle = node.getAngle() / 180 * Math.PI;
        var loc = node.getLocation();
        var size = node.getSize();
        var points = [
            { x: loc.x, y: loc.y },
            { x: loc.x + size.width, y: loc.y },
            { x: loc.x + size.width, y: loc.y + size.height },
            { x: loc.x, y: loc.y + size.height }
        ];
        var result = points.map(function (p) {
            return self.rotatePoint(p, angle, center)
        });
        return result;
    }

    var timerIdMap = {};
    Utils.prototype.runDelayTask = function (id, delay, task) {
        if (timerIdMap[id]) {
            clearTimeout(timerIdMap[id]);
        }
        timerIdMap[id] = setTimeout(function () {
            timerIdMap[id] = null;
            task && task()
        }, delay);
    }

    Utils.prototype.is = function (o, obj) {
        return Object.prototype.toString.call(o) === '[object ' + obj + ']';
    }

    Utils.prototype.padStart = function (string, length, chars) {
        string = string + '';
        chars = chars || '0';
        var strLength = length ? string.length : 0;
        return (length && strLength < length) ?
            (this.baseRepeat(chars, length - strLength) + string) :
            string;
    }
    Utils.prototype.baseRepeat = function (string, n) {
        var result = '';
        if (!string || n < 1 || n > Number.MAX_SAFE_INTEGER) {
            return result;
        }
        do {
            if (n % 2) {
                result += string;
            }
            n = Math.floor(n / 2);
            if (n) {
                string += string;
            }
        } while (n);

        return result;
    }


    var $utils = new Utils();

    //doodle.Utils 是为了兼容旧版本
    doodle.Utils = doodle.utils = $utils;




    /**
     * 左侧工具栏
     * @constructor
     */
    var AccordionData = function () {

        this._data = [];
        this.init();
    }

    AccordionData.prototype = {
        init: function () {
            this._data = [];

            var self = this;
            //查询所有的类别
            var categoriesTemp = make.Default.getCategories();
            var categories = [];

            //判断是否需要过滤
            categoriesTemp.forEach(function (category) {
                if (self.filterCategory && self.filterCategory(category) === false) {
                    return;
                }
                categories.push(category);
            })

            //排序
            if (this.sortCategories) {
                categories = this.sortCategories(categories);
            }

            categories.forEach(function (category) {

                var models = [];
                var modelMap = make.Default.getCreatorsForCategory(category);
                for (var id in modelMap) {

                    //判断是否需要过滤
                    if (self.filterModel && self.filterModel(id) === false) {
                        continue
                    }
                    var params = make.Default.getParameters(id);
                    var icon = make.Default.getIcon(id);
                    var combo = make.Default.isCombo(id);
                    models.push({
                        id: id,
                        icon: icon,
                        label: params.name,
                        category: category,
                        combo: combo,
                    })
                }

                //排序
                if (self.sortModels) {
                    models = self.sortModels(models);
                }

                if (models && models.length > 0) {
                    self._data.push({
                        title: category,
                        contents: models
                    });
                }

            })
        },

        /**
         * get result data
         * @returns {Object[]}
         */
        getData: function () {
            this.init();
            return this._data;
        },

        /**
         * 按category过滤
         * @param category {String}
         * @returns {boolean}
         */
        filterCategory: function (category) {
            if (category == '基本模型') {
                return false
            }
            if (category == '') {
                return false;
            }
            return true;
        },

        /**
         * category排序
         * @param categories  {String[]}
         * @returns {String[]}
         */
        sortCategories: function (categories) {
            return categories;
        },

        /**
         * 按注册modelId过滤
         * @param modelId {String}
         * @returns {boolean}
         */
        filterModel: function (modelId) {
            return true;
        },

        /**
         * 按注册的modelId排序
         * @param models {String[]}
         * @returns  {String[]}
         */
        sortModels: function (models) {
            return models;
        },


    }

    doodle.AccordionData = AccordionData;

    doodle.utils.ext(AccordionData, Object)
        /**
         * accordion pane
         * 组件栏 - 使用了jquery-ui中的Accordion组件
         * @constructor
         */
    var AccordionPane = function () {

        this.init();
        this._categories = [];
        this._visible = true;
        this._reset = true;
    }
    AccordionPane.prototype = {

        init: function () {
            this.paneBox = $('<div id="accordion-resizer" class="ui-widget-content"></div>');
            this.mainPane = $('<div id="accordion"></div>').appendTo(this.paneBox);
            this.mainPane.accordion({
                heightStyle: "fill",
            });
        },

        /**
         * set categories data
         * @param categories {Object[]}
         * @returns {Object[]}
         */
        setCategories: function (categories) {

            var old = this._categories;
            this._categories = categories;
            this.mainPane.accordion('destroy');
            this.mainPane.empty();
            var self = this;
            if (categories) {
                for (var i = 0; i < categories.length; i++) {
                    var category = categories[i];

                    var categoryTitleDom = $('.' + category.title);
                    if (categoryTitleDom.length == 0) {
                        categoryTitleDom = $('<h3 class="' + category.title + '">' + category.title + '</h3>').appendTo(this.mainPane)
                        $('<ul class="mn-accordion"></ul>').appendTo(this.mainPane);
                    }
                    var categoryContentDom = categoryTitleDom.next('.mn-accordion');
                    category.contents.forEach(function (data) {
                        var icon = data.icon;
                        if (!icon || icon.indexOf('undefined') >= 0) {
                            icon = 'images/cloud-up-icon.png';
                        }
                        var itemDiv = $('<li class="item-li" style="height: 108px;"></li>').appendTo(categoryContentDom);
                        var img = $('<img src=' + icon + ' title=' + (data.description || data.label) + '></img>')
                        var label = $('<div class="item-label" style="word-break: break-all; display: -webkit-box;-webkit-box-orient: vertical;-webkit-line-clamp: 2;overflow: hidden;">' + data.label + '</div>');
                        itemDiv.append(img);
                        itemDiv.append(label);
                        self.setImageDraggable(img[0], data);
                        img[0]._errCount = 0;
                        img.error(function () {
                            this._errCount++;
                            if (this._errCount <= 3) {
                                $(this).attr('src', make.Default.path + "model/idc/icons/ball-red.png");
                            }
                        })
                    });
                }
            }
            this.mainPane.accordion({
                heightStyle: "fill",
                collapsible: true //设置面板可折叠，默认为click事件折叠
            });
            this.mainPane.accordion("refresh");
            this.refresh();
            return old;
        },

        /**
         * get categories data
         * @returns {Object[]}
         */
        getCategories: function () {

            return this._categories;
        },

        /**
         * set accordion visible
         * @param v {boolean}
         */
        setVisible: function (v) {
            if (this._visible != v) {
                this._visible = v;
                if (this._visible) {

                    this.paneBox.show();
                } else {
                    this.paneBox.hide();
                }
            }
        },

        /**
         * get accordion visible
         * @returns {boolean}
         */
        isVisible: function () {
            return this._visible;
        },

        /**
         * refresh accordion widget
         */
        refresh: function () {
            var self = this;
            setTimeout(function () {
                self.mainPane.accordion("refresh");
            }, 100)
        },

        /**
         * accordion widget box
         * @returns {HTMLDIVElement}
         */
        getView: function () {
            return this.paneBox[0];
        },

        /**
         * set image draggable
         * @param image {Image}
         * @param item {Object}
         */
        setImageDraggable: function (image, item) {
            var self = this;
            nsp.edit.DragAndDrop.setDragTarget(image, item, {
                effectAllowed: 'copyMove',

                dragImage: item.dragImage || item.icon,
                ondrag: function (e) {
                    self.ondrag && self.ondrag(e, item);
                    // console.log(item,'>>>>>>');
                },
            });
        },

        /**
         * drag handler
         * @param e {DragEvent}
         * @param item {Object}
         */
        ondrag: function (e, item) {

        },

    }

    doodle.AccordionPane = nsp.edit.AccordionPane = AccordionPane;

    doodle.utils.ext(AccordionPane, Object);
    /**
     * 编辑器常量
     * @type {{}}
     */
    var $consts = {

        /**
         * 模型后缀的分隔符
         */
        MODEL_SUFFIX_SEPARATOR: '.',

        /**
         * 场景编辑器中默认后缀
         */
        SCENE_MODEL_SUFFIX: 'top', //

        /**
         * 机柜编辑器中默认后缀
         */
        RACK_MODEL_SUFFIX: 'front', //

        /**
         * 设备编辑器中默认后缀
         */
        DEVICE_MODEL_SUFFIX: 'panel', //

        /**
         * 场景编辑双击机柜是否跳到机柜编辑器
         */
        REDIRECT_RACK_EDITOR: true, //

        /**
         * 机柜编辑器双击设备,是否跳到设备编辑器
         */
        REDIRECT_DEVICE_EDITOR: true, //

        /**
         * 场景编辑器 3d-2d映射关系
         */
        sceneEditorModel3dTo2dMapping: {},
        /**
         * 场景编辑器 2d-3d映射关系
         */
        sceneEditorModel2dTo3dMapping: {},
        /**
         *
         */
        rackEditorModel3dTo2dMapping: {},

        /**
         * 机柜编辑器 2d-3d映射关系
         */
        rackEditorModel2dTo3dMapping: {},

        /**
         * 设备编辑器 3d-2d映射关系
         */
        deviceEditorModel3dTo2dMapping: {},

        /**
         * 场景编辑器 2d-3d映射关系
         */
        deviceEditorModel2dTo3dMapping: {},

        /**
         * 电路编辑器 3d-2d映射关系
         */
        circuitEditorModel3dTo2dMapping: {},

        /**
         * 电路编辑器 2d-3d映射关系
         */
        circuitEditorModel2dTo3dMapping: {},

        /**
         * 粘帖时,x方向的偏移
         */
        pasteOffsetX: 10,

        /**
         * 粘帖时,y方向的偏移
         */
        pasteOffsetY: 10,

        /**
         * 粘帖时,z方向的偏移
         */
        pasteOffsetZ: 10,
    }

    /**
     * @namespace
     */
    doodle.consts = $consts;
    nsp.edit.Consts = $consts;


    var Dialog = nsp.edit.Dialog = function (title, buttons, params, close) {
        var title = title || 'Dialog';
        this.dialog = $('<div id="export-message" title = "' + title + '"></div>');
        this.content = $('<div class="inner" ></div>');
        this.dialog.append(this.content);
        this.buttons = buttons;
        this.params = params || {};
    }


    Dialog.prototype.setData = function (data) {
        if (typeof (data) === "string") {
            this.content.html(data);
        } else {
            this.content.append(data);
        }

    }

    Dialog.prototype.getView = function () {
        return this.dialog;
    }

    Dialog.prototype.init = function () {
        if (!this.buttons) {
            this.buttons = {
                Ok: function () {
                    $(this).dialog("close");
                },
            }
        }
        this.dialog.dialog({
            height: 300,
            width: 350,
            autoOpen: false,
            show: {
                effect: "fade",
            },
            hide: {
                effect: "fade",
            },
            modal: true,
            buttons: this.buttons,
            close: this.params.close
        });
    }

    Dialog.prototype.show = function () {
        this.dialog.dialog("open");
    }

    Dialog.prototype.hide = function () {
            this.dialog.dialog("close");
        }
        // http://www.runoob.com/html/html5-draganddrop.html 
        // http://www.runoob.com/jsref/event-ondragend.html
        // http://www.zhangxinxu.com/wordpress/2011/02/html5-drag-drop-%E6%8B%96%E6%8B%BD%E4%B8%8E%E6%8B%96%E6%94%BE%E7%AE%80%E4%BB%8B/
        // http://www.w3cmm.com/html/drag.html
        // http://man.ddvip.com/web/dhtml/properties/effectallowed.html
    var DragAndDrop = nsp.edit.DragAndDrop = {};
    DragAndDrop.setDragImage = function (dragImage, event) {
        if (dragImage) {
            var temp = dragImage;
            if (typeof dragImage === 'string') {
                dragImage = document.createElement('img');
                dragImage.setAttribute('src', temp);
            }
            if (event.dataTransfer.setDragImage) {
                event.dataTransfer.setDragImage(dragImage, dragImage.width / 2, dragImage.height / 2);
            }
        }
    };

    DragAndDrop.setDragTarget = function (view, data, params) {
        params = params || {};
        view.setAttribute('dragable', true);
        var dragData = data;
        if (data != null && typeof dragData !== 'string') {
            dragData = JSON.stringify(dragData);
        }
        var dragImage = params.dragImage;
        view.ondragstart = function (event) {
            if (dragData) {
                event.dataTransfer.setData("Text", dragData);
            }
            if (params.effectAllowed) {
                event.dataTransfer.effectAllowed = params.effectAllowed;
            }
            DragAndDrop.setDragImage(dragImage, event);
            params.ondragstart && params.ondragstart(event);
        };
        if (params.ondragend) {
            view.ondragend = params.ondragend;
        }
        if (params.ondrag) {
            view.ondrag = params.ondrag;
        }
    };

    DragAndDrop.allowDrop = function (event) {
        event.preventDefault();
    };

    DragAndDrop.setDropTarget = function (view, params) {
        params = params || {};
        if (params.ondragenter) {
            view.ondragenter = params.ondragenter;
        }
        view.ondragover = function (event) {
            DragAndDrop.allowDrop(event);
            if (params.dropEffect) {
                event.dataTransfer.dropEffect = params.dropEffect;
            }
            var data = event.dataTransfer.getData("Text");
            params.ondragover && params.ondragover(event, data);
        };
        view.ondragleave = params.ondragleave;
        view.ondrop = function (event) {
            event.preventDefault();
            var data = event.dataTransfer.getData("Text");
            params.ondrop && params.ondrop(event, data);
        };
    };

    /**
     * 编辑器基类
     * 构造函数执行完成后,会调用_init()方法
     * @param parentView {HTMLDIVElement} network view box
     * @constructor
     */
    var Editor = function (parentView) {

        var self = this;
        this.parentView = $(parentView);
        this._accordionVisible = true;
        this._propertySheetVisible = true;
        this.accordionPane = null;
        this.ruler = null;
        this.network2d = null;
        this.bidQuickFinder = null;
        this.undoManager = null;

        this.copyFilter = function (item) {
            return item;
        }

        this.pasteFilter = function (item) {
            return item;
        }

        this.flowAndCopyFilter = function (item) {
            return item;
        }


        this.parentView.resize(function () {
            self.parentResizeHandle && self.parentResizeHandle();
        });

        this.contentPane = $('<div class="editor-container"></div>').appendTo(parentView);

        this.propertySheetBox = $('<div class="propertySheetBox right-content"></div>').appendTo(this.contentPane);

        this.accordionPaneBox = $('<div class="accordionPaneBox"></div>').appendTo(this.contentPane);

        this.networkBox = $('<div class="networkBox"></div>').appendTo(this.contentPane);

        this.adjustBounds({
            left: '0px',
            right: '0px',
            top: '0px',
            bottom: '0px'
        });

        this.flowOffsetX = 0;
        this.flowOffsetY = 0;

        this.pasteOffsetDx = $consts.pasteOffsetX;
        this.pasteOffsetDy = $consts.pasteOffsetY;
        this.pasteOffsetDz = $consts.pasteOffsetZ;

        /**
         * 粘帖时,X方向偏移量
         * @type {number}
         */
        this.pasteOffsetX = $consts.pasteOffsetX;

        /**
         * 粘帖时,Y方向偏移量
         * @type {number}
         */
        this.pasteOffsetY = $consts.pasteOffsetY;

        /**
         * 粘帖时,Z方向偏移量
         * @type {number}
         */
        this.pasteOffsetZ = $consts.pasteOffsetZ;

        /**
         * 当前复制的数据
         * @type {Array}
         * @private
         */
        this._copyAnchor = [];

        this._init();
    }
    Editor.prototype = {

        _init: function () {
            this.setPropertySheetVisible(true);
            this.setAccordionVisible(true);
            this.propertySheetBox.hide();
        },

        /**
         * set accordion visible
         * 设置左侧组件栏是否可见
         * @param v {boolean} true show, false hide
         */
        setAccordionVisible: function (v) {

            if (this._accordionVisible != v) {
                this._accordionVisible = v;
                if (v) {
                    this.accordionPaneBox.show()
                    this.networkBox.css('left', 200)
                } else {
                    this.accordionPaneBox.hide();
                    this.networkBox.css('left', 0);
                }
                this.invalidate();
            }
        },

        invalidate: function () {

        },

        /**
         *  添加键盘的上下左右移动事件
         */
        addKeyMoveListener: function (network2d) {
            var box = network2d.getElementBox();
            network2d.getView().addEventListener('keydown', function (e) {
                var myKey = false;
                var xgap = network2d.getPositionMagneticX(),
                    ygap = network2d.getPositionMagneticY();
                if (e.keyCode == 37) { //Left
                    $utils.moveSelectionElements(box, "left", xgap, ygap);
                    myKey = true;
                }
                if (e.keyCode == 38) { //Top
                    $utils.moveSelectionElements(box, "top", xgap, ygap);
                    myKey = true;
                }
                if (e.keyCode == 39) { //Right
                    $utils.moveSelectionElements(box, "right", xgap, ygap);
                    myKey = true;
                }
                if (e.keyCode == 40) { //Bottom
                    $utils.moveSelectionElements(box, "bottom", xgap, ygap);
                    myKey = true;
                }
                if (myKey) {
                    e.preventDefault();
                    e.stopPropagation();
                }

            });
        },

        /**
         * get accordion visible status
         * 返回左侧组件栏的显示状态, true 显示, false 隐藏
         * @returns {boolean}
         */
        isAccordionVisible: function () {
            return this._accordionVisible;
        },

        /**
         * set accordion visible
         * 设置属性栏是否可见
         * @param v {boolean} true show, false hide
         */
        setPropertySheetVisible: function (v) {

            if (this._propertySheetVisible != v) {
                this._propertySheetVisible = v;
                if (v) {
                    this.propertySheetBox.show()
                } else {
                    this.propertySheetBox.hide();
                }
            }
        },
        resetPropertySheetBoxSize: function (sheet) {
            var self = this;
            clearTimeout(this.resetPropertySheetBoxSizeTimer);
            this.resetPropertySheetBoxSizeTimer = setTimeout(function () {
                var height = sheet.getDataDiv().clientHeight;
                self.propertySheetBox.height(height + 1);
                var w = self.propertySheetBox.width();
                var h = self.propertySheetBox.height();
                sheet.adjustBounds({ x: 0, y: 0, width: w, height: h });
            }, 500)
        },

        /**
         * get accordion visible status
         * 返回属性栏的显示状态, true 显示, false 隐藏
         * @returns {boolean}
         */
        isPropertySheetVisible: function () {
            return this._propertySheetVisible;
        },

        /**
         * editor adjustBounds
         * 调整编辑器大小,相对于parentView来定位
         * eg:
         * adjustBounds({left: '0px',right: '0px',top: '48px',bottom: '35px'}
         * adjustBounds({left: '10px'}
         * @param position {Object}
         */
        adjustBounds: function (position) {

            for (var p in position) {
                this.contentPane.css(p, position[p]);
            }
        },

        /**
         * parent view (DIV) resize event handle
         * 编辑器容器resize事件处理
         * dependent libs/jquery.ba-resize.js
         */
        parentResizeHandle: function () {
            this.ruler && this.ruler.invalidate();
            this.accordionPane && this.accordionPane.refresh();
        },

        /**
         * get editor content bounds
         * 返回编辑器内容所在的区域
         * @returns {{x:number, y:number, width:number, height:number}}
         */
        getBounds: function () {
            if (this.parentNode) {
                var location = this.parentNode.getLocation();
                var size = this.parentNode.getSize();
                return {
                    width: size.width,
                    height: size.height,
                    x: location.x,
                    y: location.y
                }
            } else {
                var bound = this.network2d.getUnionBounds();
                var zoom = this.network2d.getZoom();
                bound.x /= zoom;
                bound.y /= zoom;
                bound.width /= zoom;
                bound.height /= zoom;
                return bound;
            }
        },

        /**
         * input new width and height, get min scale of bounds
         * 输入指定的宽度和高度, 在不拉伸network的情况下,返回最小的比率
         * @param width {number}
         * @param height {number}
         * @returns {number}
         */
        getScaleByRegion: function (width, height) {
            var bounds = this.getBounds();
            var wk = width / bounds.width;
            var hk = height / bounds.height;
            var k = Math.min(wk, hk);
            return k;
        },

        /**
         * get new canvas, a copy of network
         * 返回一个新的canvas
         * args: {{x:number|undefined, y:number|undefined, width:number|undefined,height:number|undefined,scale:number|undefined}}
         * result: {{width: number, height: number, content: Canvas}}
         * @param args {Object}
         * @returns {{width: number, height: number, content: Canvas}}
         */
        toCanvas: function (args) {
            var bounds = this.getBounds();
            var scale = args.scale || 1;
            var x = args.x || bounds.x;
            var y = args.y || bounds.y;
            var width = args.width || bounds.width;
            var height = args.height || bounds.height;
            var content = this.network2d.toCanvasByRegion({
                width: width,
                height: height,
                x: x,
                y: y
            }, scale);
            return {
                width: content._viewRect.width,
                height: content._viewRect.height,
                content: content,
            }
        },

        /**
         * get image content from network
         * 将network截图,返回一个大尺寸的图片, 图片的尺寸是2的幂.
         * @param scale {number} default value is 2
         * @returns {string}
         */
        getImage: function (scale) {
            scale = scale || 2;
            var data = this.toCanvas({ scale: scale });
            var canvas = data.content;
            var width = mono.Utils.nextPowerOfTwo(data.width);
            var height = mono.Utils.nextPowerOfTwo(data.height);
            var c = document.createElement('canvas');
            c.width = width;
            c.height = height;
            var g = c.getContext('2d');
            g.clearRect(0, 0, width, height);
            g.drawImage(canvas, 0, 0, width, height);
            return c.toDataURL();
        },

        /**
         * get icon content from network
         * 将network截图,返回一个icon图片
         * @param width {number} default value is 84
         * @param height {number} default value is 84
         * @returns {string}
         */
        getIcon: function (width, height) {
            width = width || 84;
            height = height || 84;
            var k = this.getScaleByRegion(width, height)
            var bounds = this.getBounds();
            bounds.scale = k;
            var canvas = this.toCanvas(bounds).content;
            var w = canvas.width;
            var h = canvas.height;
            var dx = (width - w) / 2;
            var dy = (height - h) / 2;
            var c = document.createElement('canvas');
            c.width = width;
            c.height = height;
            var g = c.getContext('2d');
            g.clearRect(0, 0, width, height);
            g.drawImage(canvas, dx, dy);
            return c.toDataURL();
        },

        /**
         * set show network grid
         * 设置是否显示网格 true 显示, false 隐藏
         * @param v {boolean} display status
         */
        setShowGrid: function (v) {
            this.network2d.setShowGrid(v);
        },

        /**
         * get network grid display status
         * 取得当前网格显示状态
         * @returns {*}
         */
        isShowGrid: function () {
            return this.network2d.isShowGrid();
        },

        /**
         * Set when double - click network to automatically switch to the grid display status
         * 设置双击network时,是否自动切换网格显示状态
         * @param v
         */
        setAutoShowOrHideGrid: function (v) {

            this.network2d.autoShowOrHide = v
        },

        /**
         * Get when double - click network to automatically switch to the grid display status
         * 取得双击network时,是否自动切换网格显示状态
         * @returns {boolean}
         */
        isAutoShowOrHideGrid: function () {
            return this.network2d.autoShowOrHide;
        },

        /**
         * Get the X coordinates of the smallest unit of adsorption
         * 取得x坐标的吸附最小单位
         * @returns {int}
         */
        getPositionMagneticX: function () {
            return this.network2d.getPositionMagneticX();
        },

        /**
         * Set the X coordinates of the smallest unit of adsorption
         * 设置x坐标的吸附最小单位
         * @param magnetic {int}
         * @returns {int} old value
         */
        setPositionMagneticX: function (magnetic) {
            return this.network2d.setPositionMagneticX(magnetic);
        },

        /**
         * Get the Y coordinates of the smallest unit of adsorption
         * 取得y坐标的吸附最小单位
         * @returns {int}
         */
        getPositionMagneticY: function () {
            return this.network2d.getPositionMagneticY();
        },

        /**
         * Set the Y coordinates of the smallest unit of adsorption
         * 设置y坐标的吸附最小单位
         * @param magnetic {int}
         * @returns {int} old value
         */
        setPositionMagneticY: function (magnetic) {
            return this.network2d.setPositionMagneticY(magnetic);
        },

        /**
         * Whether the adsorption function is enabled
         * 取的是否启用吸附功能
         * @returns {boolean}
         */
        isPositionMagneticEnabled: function () {
            return this.network2d.isPositionMagneticEnabled();
        },

        /**
         *
         * Whether to enable adsorption function
         * 是否启用吸附功能
         * 全局功能
         * 如果禁用,全局禁用
         * 如果启用,判断节点是否单独设置有禁用
         * @param enable {boolean}
         * @returns {boolean} old value
         */
        setPositionMagneticEnabled: function (enable) {
            return this.network2d.setPositionMagneticEnabled(enable);
        },

        /**
         * set network grids
         * @param grids {Object[]}
         * @returns {Object[]} old value
         */
        setGrids: function (grids) {
            var old = this.network2d.setGrids(grids);
            this.network2d.repaint();
            return old;
        },

        /**
         * get network grids
         * @returns {Object[]}
         */
        getGrids: function () {
            return this.network2d.getGrids();
        },

        /**
         * 视图总览
         */
        zoomOverview: function () {
            console.warn('this method[{}] is not supported'.format('zoomOverview'))
        },

        /**
         * 取的编辑器结果
         * @returns {Array}
         */
        getData: function () {
            console.warn('this method[{}] is not supported'.format('getData'))
            return [];
        },

        /**
         * 设置编辑数据
         * @param data {Object[]}
         */
        setData: function (data) {
            console.warn('this method[{}] is not supported'.format('setData'))
        },

        /**
         * 去的选中的数据
         * @returns {Array}
         */
        getSelectedData: function () {
            console.warn('this method[{}] is not supported'.format('getSelectedData'))
            return [];
        },

        /**
         * 追加数据
         * @param data{Object}
         */
        appendData: function (data) {
            console.warn('this method[{}] is not supported'.format('appendData'))
        },

        /**
         * 追加数据
         * @param data{Object}
         */
        removeData: function (data) {
            console.warn('this method[{}] is not supported'.format('appendData'))
        },


        /**
         * 清除编辑器数据
         */
        clear: function () {
            console.warn('this method[{}] is not supported'.format('clear'))
            return []
        },

        /**
         * 复制编辑器数据
         * @returns {Array}
         */
        copySelection: function (filter) {
            //console.warn('this method[{}] is not supported'.format('copySelection'))
            filter = filter || this.copyFilter;
            var selectData = this.getSelectedData();
            this._clearPasteOffset();
            if (filter) {
                selectData = filter(selectData);
            }
            this._copyAnchor = selectData;
            return this._copyAnchor;
        },

        /**
         * 粘帖编辑器数据
         * @param offset  {{x,y,z}} 位置的偏移量
         * @param filter
         * @returns  {Array|null}
         */
        pasteSelection: function (offset, filter) {
            //console.warn('this method[{}] is not supported'.format('pasteSelection'))

            filter = filter || this.pasteFilter;
            var self = this;
            if (!this._copyAnchor || this._copyAnchor.length == 0) {
                return null;
            }
            var sm = this.network2d.getSelectionModel();

            offset = offset || this._getPasteOffset();
            var items = [];
            this._copyAnchor.forEach(function (data) {
                var item = $utils.clone(data);
                item.objectId = doodle.id();
                items.push(item);
                //y不用复制
                if (item.position) {
                    var position = item.position;
                    item.position = [position[0] + offset.x, position[1], position[2] + offset.z];
                }
                if (item.location) {
                    var location = item.location;
                    if (location instanceof Array) {
                        item.location = [position[0] + offset.x, position[1] + offset.z];
                    } else {
                        item.location.x += offset.x;
                        item.location.y += offset.z;
                    }
                }
                if (item.x) {
                    item.x += offset.x;
                }
                if (item.y) {
                    item.y += offset.z;
                }
                if (filter) {
                    item = filter(item);
                }
                if (item) {
                    self.appendData(item);
                }
            })
            setTimeout(function () {
                sm.clearSelection();
                items.forEach(function (item) {
                    var node = self.network2d.getElementBox().getDataById(item.objectId);
                    sm.appendSelection(node);
                })

            }, 100)
        },

        /**
         * 均匀复制,只有选中一个元素时才有效果
         * @param type {string}  hor or ver  hor:水平复制, ver:竖直复制
         * @param count {count} 复制的次数
         * @returns {string} 返回null表示成功,否则返回错误信息
         */
        flowAndCopy: function (type, count, filter) {

            filter = filter || this.flowAndCopyFilter;
            var self = this;
            var data = this.getSelectedData(filter);
            if (data.length != 1) {
                return 'you can use this fun only select one data';
            }
            data = data[0];
            var result = [];
            var node = this.network2d.getElementBox().getDataById(data.objectId);
            if (!node.getSize) {
                return 'this fun used node';
            }
            var size = node.getSize();
            size = size || { width: 60, height: 60 }
            var w = size.width + this.flowOffsetX;
            var h = size.height + this.flowOffsetY;
            var xx = w;
            var yy = h;
            for (var i = 0; i < count; i++) {
                var item = $utils.clone(data);
                item.objectId = doodle.id();
                result.push(item);
                if (item.position) {
                    var position = item.position;
                    if (type == 'hor') {
                        position[0] += xx;
                        xx += w;
                    } else {
                        position[2] += yy;
                        yy += h;
                    }
                }
                if (filter) {
                    item = filter(item);
                }
                if (item) {
                    this.appendData(item);
                }
            }

            setTimeout(function () {
                var sm = self.network2d.getSelectionModel();
                result.forEach(function (item) {
                    var node = self.network2d.getElementBox().getDataById(item.objectId);
                    sm.appendSelection(node);
                })
            }, 100)


        },

        /**
         * 取的粘帖的偏移
         * @returns {{x: (number|*), y: (number|*), z: (number|*)}}
         * @private
         */
        _getPasteOffset: function () {

            this.pasteOffsetX += this.pasteOffsetDx;
            this.pasteOffsetY += this.pasteOffsetDy;
            this.pasteOffsetZ += this.pasteOffsetDz;
            return { x: this.pasteOffsetX, y: this.pasteOffsetY, z: this.pasteOffsetZ }
        },

        /**
         * 清除粘帖的偏移
         * @private
         */
        _clearPasteOffset: function () {
            this.pasteOffsetX = 0;
            this.pasteOffsetY = 0;
            this.pasteOffsetZ = 0;
        },
        findByBID: function (bid) {
            if (!this.bidQuickFinder)
                this.bidQuickFinder = new twaver.QuickFinder(this.network2d.getElementBox(), 'bid', 'client');
            return this.bidQuickFinder.findFirst(bid);
        },

        /**
         * 是否启用回退功能
         * @param enable
         */
        setUndoManagerEnabled: function (enable) {
            this.undoManager = this.undoManager || this.network2d.getElementBox().getUndoManager();
            this.undoManager.setEnabled(enable);
        },
        /**
         * 回退
         */
        undo: function () {
            this.undoManager = this.undoManager || this.network2d.getElementBox().getUndoManager();
            this.undoManager.undo();
        },

        /**
         * 前进
         */
        redo: function () {
            this.undoManager = this.undoManager || this.network2d.getElementBox().getUndoManager();
            this.undoManager.redo();
        },

        /**
         * 开始批处理
         */
        startBatch: function () {
            this.undoManager = this.undoManager || this.network2d.getElementBox().getUndoManager();
            this.undoManager.startBatch();
        },

        /**
         * 结束批处理
         */
        endBatch: function () {
            this.undoManager = this.undoManager || this.network2d.getElementBox().getUndoManager();
            this.undoManager.endBatch();
        },

        /**
         * 暂停Undoredo
         *
         */
        setSuspended: function (suspended) {
            this.undoManager = this.undoManager || this.network2d.getElementBox().getUndoManager();
            this.undoManager.setSuspended(suspended);
        }

    }

    doodle.utils.ext(Editor, Object);

    doodle.Editor = Editor;

























    /**
     *
     * @param elementBox
     * @private
     * @constructor
     */
    nsp.edit.GridNetwork = function (elementBox) {

        var self = this;
        elementBox = elementBox || new twaver.ElementBox();
        nsp.edit.GridNetwork.superClass.constructor.call(this, elementBox);
        this._positionMagneticEnabled = true;
        this._positionMagneticX = 10;
        this._positionMagneticY = 10;
        this.grids = [];
        this._showGrid = true;
        this.autoShowOrHide = true;

        this.grid1 = {
            width: 1000,
            height: 1000,
            visible: true,
            visibleFilter: function (zoom) {
                return zoom > 0.05
            },
            shapeColor: '#FF0000',
            shapeSize: 1,
            shape: 'line' //line point
        }

        this.grid2 = {
            width: 100,
            height: 100,
            skipX: [],
            skipY: [],
            visible: true,
            visibleFilter: function (zoom) {
                return zoom > 0.12
            },
            shapeColor: '#FFAA00',
            shapeSize: 1,
            shape: 'line' //line point
        }
        this.grid3 = {
            width: 50,
            height: 50,
            skipX: [100],
            skipY: [100],
            visible: true,
            visibleFilter: function (zoom) {
                return zoom > 1
            },
            shapeColor: '#FFFFAE',
            shapeSize: 1,
            shape: 'line' //line point
        }

        this.grid4 = {
            width: 10,
            height: 10,
            skipX: [100, 50],
            skipY: [100, 50],
            visible: true,
            visibleFilter: function (zoom) {
                return zoom > 2.0
            },
            shapeColor: '#AAFF00',
            shapeSize: 2.5,
            shape: 'point' //line point
        }

        this.initGridNetwork();
    }

    nsp.edit.GridNetwork.prototype = {

        initGridNetwork: function () {

            var self = this;

            this.setKeyboardRemoveEnabled(false);

            this._box.addDataBoxChangeListener(function (e) {
                //console.log(e);
                var kind = e.kind;
                var node = e.data;
                if (kind == 'add') {
                    self.nodePositionMagneticInit(node);
                }
            }, this);
            this.addInteractionListener(function (e) {
                //console.log(e);
                if (e.kind == 'liveMoveStart') { //开始移动

                    var nodes = self._box.getSelectionModel().getSelection();
                    self.beginMove(nodes);

                } else if (e.kind == 'liveMoveEnd') { //结束已动工

                    var nodes = self._box.getSelectionModel().getSelection();
                    self.endMove(nodes);
                } else if (e.kind == 'doubleClickBackground' && self.autoShowOrHide) {
                    self.setShowGrid(!self.isShowGrid());
                }
            }, this);

            this.addPropertyChangeListener(function (e) {
                if (e.property == "zoom") {
                    this.invalidateGrids(this.grids);
                }
            }, this);

            this.grids.push(this.grid1);
            this.grids.push(this.grid2);
            this.grids.push(this.grid3);
            this.grids.push(this.grid4);
            this.invalidateGrids(this.grids);

        },

        beginMove: function (nodes) {
            var self = this;
            if (nodes && nodes.size() > 0) {
                nodes.forEach(function (node) {
                    if (!(node instanceof twaver.Node)) {
                        return;
                    }
                    node.childNodeLiveMove = true;
                    node.childNodeLastPoint = node.getLocation();
                    node.childNodeLastPointOffset = { x: 0, y: 0 };
                })
            }
        },

        endMove: function (nodes) {
            var self = this;
            if (nodes && nodes.size() > 0) {
                nodes.forEach(function (node) {
                    delete node.childNodeLiveMove;
                    delete node.childNodeLastPoint;
                    delete node.childNodeLastPointOffset;
                })
            }
        },

        setGrids: function (grids) {
            this.grids = grids;
            this.invalidateGrids(this.grids);
        },
        getGrids: function () {
            return this.grids;
        },

        resizeCanvas: function (e) {
            this.repaint();
        },

        repaint: function () {
            this.invalidateElementUIs();
        },

        setShowGrid: function (showGrid) {
            this._showGrid = showGrid;
            this.repaint();
        },
        isShowGrid: function () {
            return this._showGrid;
        },

        setAutoShowOrHideGrid: function (autoShowOrHide) {
            this.autoShowOrHide = autoShowOrHide;
        },

        isAutoShowOrHideGrid: function () {
            return this.autoShowOrHide;
        },

        setCursorPosition: function (e) {
            this.cursorPosition = e;
            this.repaint();
        },
        getCursorPosition: function () {
            return this.cursorPosition;
        },

        /**
         * 校验所有的grid
         * 1 根据zoom判断是否显示grid
         * 2 后面的grid显示要跳过已经绘制的轨迹
         * @param grids
         */
        invalidateGrids: function (grids) {

            var zoom = this.getZoom();
            var length = grids.length;
            for (var i = 0; i < length; i++) {
                var grid = grids[i];
                grid.skipX = [];
                grid.skipY = [];
                for (var j = 0; j < i; j++) {
                    grid.skipX.push(grids[j].width)
                    grid.skipY.push(grids[j].height)
                }
                if (grid.visibleFilter) {
                    grid.visible = grid.visibleFilter(zoom);
                }
            }
        },

        /**
         * 判断当前坐标x是否需要跳过
         * @param grid
         * @param x
         * @returns {boolean}
         */
        isSkipX: function (grid, x) {

            for (var i = 0; i < grid.skipX.length; i++) {
                if (x % grid.skipX[i] == 0)
                    return true
            }
            return false;
        },

        /**
         * 绘制表格
         * 根据表格的width和height格式化grid.bound
         * 准备画布
         * x轴方向循环
         * y轴方向循环
         * @param ctx
         * @param grid
         * @param paintActionX x轴方向绘制
         * @param paintActionY y轴方向绘制
         */
        paintGridAction: function (ctx, grid, paintActionX, paintActionY) {

            var width = grid.width,
                height = grid.height,
                x = grid.bound.x,
                y = grid.bound.y,
                w = grid.bound.w,
                h = grid.bound.h,
                g = ctx,
                zoom = this.getZoom();
            var xOffset = x % (width),
                yOffset = y % (height),
                x = x - xOffset - width,
                y = y - yOffset - height,
                w = w + width * 2,
                h = h + height * 2,

                xFrom = x,
                xEnd = x + w,
                yFrom = y,
                yEnd = y + h;

            var rect = {
                xFrom: xFrom,
                xEnd: xEnd,
                yFrom: yFrom,
                yEnd: yEnd,
                width: w,
                height: h
            }
            var lineWidth = grid.shapeSize / zoom;

            g.lineWidth = lineWidth;
            g.strokeStyle = grid.shapeColor;
            //draw even lines
            var offset = lineWidth / 2;
            grid.offset = offset;
            for (var i = xFrom; i < xEnd; i += width) {

                if (!this.isSkipX(grid, i)) {
                    paintActionX.call(this, grid, g, rect, i)
                }
            }

            for (var j = yFrom; j < yEnd; j += height) {
                if (!this.isSkipY(grid, j)) {
                    paintActionY.call(this, grid, g, rect, j)
                }
            }

        },

        /**
         * 判断当前坐标y是否需要跳过
         * @param grid
         * @param y
         * @returns {boolean}
         */
        isSkipY: function (grid, y) {
            for (var i = 0; i < grid.skipY.length; i++) {
                if (y % grid.skipY[i] == 0)
                    return true
            }
            return false;
        },

        /**
         * 绘制point类型表格
         * @param ctx
         * @param grid
         */
        paintPointGrid: function (ctx, grid) {
            this.paintGridAction(ctx, grid, this.paintPointGridX, this.paintPointGridY)
        },

        /**
         * 绘制point类型表格,x方向, i为当前x轴坐标
         * @param grid
         * @param g
         * @param rect 为grid.bound 按照grid的width和height格式化后的值
         * @param i
         */
        paintPointGridX: function (grid, g, rect, i) {

            for (var j = rect.yFrom; j < rect.yEnd; j += grid.height) {
                if (!this.isSkipY(grid, j)) {
                    g.moveTo(i - grid.offset, j);
                    g.lineTo(i + grid.offset, j);
                    g.moveTo(i, j - grid.offset);
                    g.lineTo(i, j + grid.offset);
                }
            }
        },

        /**
         * 绘制point类型表格,y方向, j为当前y轴坐标, point时,不需要绘制
         * @param grid
         * @param g
         * @param rect 为grid.bound 按照grid的width和height格式化后的值
         * @param i
         */
        paintPointGridY: function (grid, g, rect, j) {

            //for (var i = rect.xFrom; i < rect.xEnd; i += grid.width) {
            //    if (!this.isSkipX(grid, i)) {
            //        g.moveTo(i-grid.offst, j - grid.offset);
            //        //TODO draw ball
            //    }
            //}
        },

        /**
         * 绘制line类型表格
         * @param ctx
         * @param grid
         */
        paintLineGrid: function (ctx, grid) {

            this.paintGridAction(ctx, grid, this.paintLineGridX, this.paintLineGridY)
        },

        /**
         * 绘制point类型表格,x方向, i为当前x轴坐标
         * @param grid
         * @param g
         * @param rect 为grid.bound 按照grid的width和height格式化后的值
         * @param i
         */
        paintLineGridX: function (grid, g, rect, i) {
            g.moveTo(i - grid.offset, rect.yFrom);
            g.lineTo(i - grid.offset, rect.yEnd);
        },

        /**
         * 绘制point类型表格,y方向, j为当前y轴坐标,
         * @param grid
         * @param g
         * @param rect 为grid.bound 按照grid的width和height格式化后的值
         * @param i
         */
        paintLineGridY: function (grid, g, rect, j) {
            g.moveTo(rect.xFrom, j - grid.offset);
            g.lineTo(rect.xEnd, j - grid.offset);
        },

        /**
         * 绘制表格
         * 判断是point类型还是line类型
         * @param ctx
         * @param grid
         */
        paintGrid: function (ctx, grid) {

            if (!this._showGrid || !grid.visible) {
                return;
            }
            ctx.beginPath();
            if (grid.shape == 'point') {
                this.paintPointGrid(ctx, grid);
            } else {
                this.paintLineGrid(ctx, grid);
            }
            ctx.stroke();
        },

        /**
         *
         * 绘制所有的表格
         * @param ctx
         * @param dirtyRect
         */
        paintGrids: function (ctx, dirtyRect) {

            var length = this.grids.length;
            if (length > 0) {
                var bound = this.getViewRect();
                var zoom = this.getZoom();

                var x = bound.x / zoom,
                    y = bound.y / zoom,
                    w = bound.width / zoom,
                    h = bound.height / zoom,
                    g = ctx;

                g.save();
                //g.clearRect(x, y, w, h);

                var bound = {
                    x: x,
                    y: y,
                    w: w,
                    h: h
                }

                for (var i = 0; i < length; i++) {
                    var grid = this.grids[i];
                    grid.bound = bound;
                    this.paintGrid(ctx, grid)
                }

                g.restore();
            }

        },
        paintBottom: function (ctx, dirtyRect) {
            this.paintGrids(ctx, dirtyRect);
        },

        /**
         * 取得x坐标的吸附最小单位
         * @returns {number|*}
         */
        getPositionMagneticX: function () {
            return this._positionMagneticX;
        },

        /**
         * 设置x坐标的吸附最小单位
         * @param magnetic
         */
        setPositionMagneticX: function (magnetic) {
            this._positionMagneticX = magnetic;
        },

        /**
         * 取得y坐标的吸附最小单位
         * @returns {number|*}
         */
        getPositionMagneticY: function () {
            return this._positionMagneticY;
        },

        /**
         * 设置x坐标的吸附最小单位
         * @param magnetic
         */
        setPositionMagneticY: function (magnetic) {
            this._positionMagneticY = magnetic;
        },

        /**
         * 是否启用吸附功能
         * 全局功能
         * 如果禁用,全局禁用
         * 如果启用,判断节点是否单独设置有禁用
         * @returns {boolean}
         */
        isPositionMagneticEnabled: function () {
            return !!this._positionMagneticEnabled;
        },

        setPositionMagneticEnabled: function (enable) {
            return this._positionMagneticEnabled = enable;
        },

        /**
         * 取得节点单独设置的x坐标吸附最小单位
         * 如果没有设定,默认取值network上的值
         * @param node
         * @returns {*}
         */
        getNodePositionMagneticX: function (node) {
            if (node) {
                var magnetic = node.getClient('magnetic.x');
                if (magnetic != undefined && magnetic != null) {
                    return magnetic;
                }
            }
            return this.getPositionMagneticX();
        },

        /**
         * 取得节点单独设置的y坐标吸附最小单位
         * 如果没有设定,默认取值network上的值
         * @param node
         * @returns {*}
         */
        getNodePositionMagneticY: function (node) {
            if (node) {
                var magnetic = node.getClient('magnetic.y');
                if (magnetic != undefined && magnetic != null) {
                    return magnetic;
                }
            }
            return this.getPositionMagneticY();
        },

        /**
         * 是否启用吸附功能
         * 如果节点禁用吸附, 禁止吸附
         * 如果节点启用,判断network是否启用
         * @param node
         * @returns {boolean}
         */
        isNodePositionMagneticDisabled: function (node) {
            if (node) {
                var magnetic = node.getClient('magnetic.disabled');
                if (!!magnetic) {
                    return true;
                }
            }
            return !this.isPositionMagneticEnabled();
        },

        /**
         * 设置节点坐标, 会根据吸附参数格式化坐标
         * @param node
         * @param tx
         * @param ty
         */
        setNodePositionMagnetic: function (node, tx, ty) {

            if (!this.isNodePositionMagneticDisabled(node) && !this.isEditingElement(node)) {
                var mx = this.getNodePositionMagneticX(node);
                var my = this.getNodePositionMagneticY(node);
                var tx = Math.round(tx / mx) * mx;
                var ty = Math.round(ty / my) * my;
            }
            node.originalSetLocation(tx, ty);
        },

        /**
         * 初始化节点吸附功能
         * @param node
         */
        nodePositionMagneticInit: function (node) {

            if (!(node instanceof twaver.Node)) {
                //logger.warn('');
                return;
            }
            if (node.originalSetLocation) {
                return;
            }
            var self = this;

            var oldSetLocationFun = node.setLocation;
            node.originalSetLocation = oldSetLocationFun;
            node.setLocation = function (tx, ty) {
                if (arguments.length == 1) {
                    var arg0 = tx;
                    tx = arg0.x;
                    ty = arg0.y;
                }
                self.setNodePositionMagnetic(node, tx, ty);
            }

            var oldTranslate = node.translate;
            node.translate = function (ox, oy) {
                if (node.childNodeLiveMove) {
                    node.childNodeLastPointOffset.x += ox;
                    node.childNodeLastPointOffset.y += oy;
                    var tx = node.childNodeLastPoint.x + node.childNodeLastPointOffset.x;
                    var ty = node.childNodeLastPoint.y + node.childNodeLastPointOffset.y;
                    self.setNodePositionMagnetic(node, tx, ty);
                } else {
                    oldTranslate.call(node, ox, oy);
                }
            }

            var x = node.getX();
            var y = node.getY();
            node.setLocation(x, y);
        }
    }

    doodle.utils.ext(nsp.edit.GridNetwork, twaver.vector.Network)

    nsp.edit.PropertySheetPane = function (box) {
        this.rightContent = $('<div class = "right-content"></div>');
        this.box = box || new twaver.DataBox();
        this.initPropertySheet();
    }

    twaver.Util.ext(nsp.edit.PropertySheetPane, Object, {
        element: null,
        jsonObj: null,
        initPropertySheet: function () {
            this.sheet = new CPropertySheet(this.box);
            this.sheet.setEditable(true);
            this.sheet.setSelectColor('#dadada');
            var sheetView = this.sheet.getView();
            sheetView.style.background = 'white';
            sheetView.style.position = 'absolute';
            sheetView.style.right = 0;
            sheetView.style.top = 0;
            sheetView.style.left = 0;
            sheetView.style.bottom = 0;
            this.rightContent.append($(sheetView));
            var self = this;
            this.params = null;
            var importDialog = new nsp.edit.Dialog("选择图片资源", {
                OK: function (e) {
                    if (self.params) {
                        var view = self.params.view;
                        if (view._isCommitting) {
                            return;
                        }
                        view._isCommitting = true;
                        view.commitEditValue(self.params, $('#image-url')[0]);
                    }
                    importDialog.hide();
                },
                Cancel: function (e) {
                    var view = self.params.view;
                    view._isCanceling = true;
                    view.cancelEditing();
                    importDialog.hide();
                }
            }, {
                close: function () {
                    var view = self.params.view;
                    view._isCanceling = true;
                    view.cancelEditing();
                    importDialog.hide();
                }
            });

            $('body').append(importDialog.getView());

            importDialog.init();
            importDialog.getView().dialog("option", "width", 500);
            importDialog.getView().dialog("option", "height", 400);

            var getImagePath = function (image) {
                if (image.indexOf('/') > 0) {
                    return image;
                }
                return make.Default.path + 'model/idc/images/' + image;
            }

            this.sheet.renderEditor = function (params) {
                self.params = params;
                if (params.view._currentEditor) {
                    return params.view._currentEditor;
                }
                if (params.property.getClient('dataType') == 'image') {
                    var dataCategory = params.property.getClient('dataCategory');
                    var dataId = params.property.getClient('dataId');
                    var tempId = new Date().getTime();
                    var innerHTML = "<label>选择图片资源</label><select id='image-url'>";

                    var images = self.getImageResourcesForEdit(dataCategory, dataId, params.property.getPropertyName());
                    if (images && images.length) {

                        images.forEach(function (image) {
                            if (image === params.value) {
                                innerHTML += "<option value=" + image + " selected='selected'> " + image + "</option>"
                            } else {
                                innerHTML += "<option value=" + image + "> " + image + "</option>"
                            }
                        });

                        innerHTML += "</select><br><br><br><image id = 'dialogImage'></image>";
                    } else {
                        return params.view._currentEditor;
                    }

                    importDialog.setData(innerHTML);
                    importDialog.show();
                    $('#dialogImage').attr('src', getImagePath(params.value));
                    $("#image-url").change(function (e) {
                        var src = $("#image-url").val();
                        src = getImagePath(src);
                        $('#dialogImage').attr('src', src);
                    });
                    var editor = {
                        view: $('#image-url')[0],
                        onKeyDown: [{
                            keyCode: 13,
                            handlerEvent: function (e) {
                                var view = params.view;
                                if (view._isCommitting) {
                                    return;
                                }
                                view._isCommitting = true;
                                view.commitEditValue(params, e.target);
                                importDialog.hide();
                            }
                        }, {
                            keyCode: 27,
                            handlerEvent: function (e) {
                                var view = params.view;
                                view._isCanceling = true;
                                view.cancelEditing();
                                importDialog.hide();
                            }
                        }]
                    };
                    return editor;
                }
                return null;
            }
        },

        getImageResourcesForEdit: function (category, id, propertyName) {

            var categoryImages = {
                "设备": ['equipment_front-2U.png', 'server.png', './idc_images/server001.jpg', './idc_images/server002.jpg', './idc_images/server003.jpg', './idc_images/server004.jpg', './idc_images/server005.jpg'],
                "板卡": ['./idc_images/card1.png', 'card2.png', './idc_images/card3.png', './idc_images/card4.png', './idc_images/card5.png'],
                "机柜模型": ['alternator-top.jpg', 'air-condition-side.jpg', 'battery-top.jpg']
            };
            //var className = 'ImageResourcesForEdit';
            //for (var p in categoryImages) {
            //    var where = {category: p};
            //    var result = proxy.queryFirst(where, className);
            //    var update = {images: {}};
            //    for (var i in categoryImages[p]) {
            //        update.images[categoryImages[p][i]] = categoryImages[p][i];
            //    }
            //    proxy.updateOrInsert(where, update, className)
            //}
            //var where = {category: category}
            //var info = proxy.queryFirst(where, className);
            //var result = [];
            //for (var p in info.images) {
            //    result.push(p);
            //}
            return categoryImages[category];
        },

        setElement: function (json) {
            var self = this;
            if (json) {
                this._setValued = false;

                var type = json.id;
                var items = make.Default.getModelDefaultParameterProperties(type);

                var sheetBox = this.sheet.getPropertyBox();
                sheetBox.clear();
                $utils.addProperties(sheetBox, items);

                this.jsonObj = make.Default.getModelDefaultParametersValues(type);
                this._generateNode(json, this.jsonObj);
                this._setValued = true;
            }

            setTimeout(function () {
                var height = self.sheet.getDataDiv().clientHeight;
                self.rightContent.height(height + 1);
                var w = self.rightContent.width();
                var h = self.rightContent.height();
                self.sheet.adjustBounds({ x: 0, y: 0, width: w, height: h });
            }, 500)
        },

        _generateNode: function (json, items) {

            this.box.clear();
            var node = this.node = new twaver.Node({ id: json.objectId });
            node.setClient('id', json.id)
            this.box.add(node);
            make.Default.objectWrapper(node, 'id', function () {
                return this.getClient('id');
            })
            make.Default.objectWrapper(node, 'objectId', function () {
                return this.getId();
            })
            delete items['id'];
            delete items['objectId'];
            for (var p in items) {
                make.Default.objectWrapper(node, p)
                node[p] = json[p] || items[p];
            }
            this.box.getSelectionModel().setSelection(node);
        },

        getData: function () {
            return make.Default.toJson(this.node);
        },

        show: function (id, callback) {
            // if(!this.bindedData){
            //  this.bindData();
            //  this.bindedData = true;
            // }
            var self = this;
            this.rightContent.css({
                'marginRight': 10,
                'width': 220
            });
            self.sheet.invalidate();
            setTimeout(function () {
                var height = self.sheet.getDataDiv().clientHeight;
                self.rightContent.height(height + 1);
                var w = self.rightContent.width();
                var h = self.rightContent.height();
                self.sheet.adjustBounds({ x: 0, y: 0, width: w, height: h });
            }, 500)
            if (callback) callback();

            /*this.rightContent.animate({
             'marginRight': 0,
             'width': 220
             }, 400, function(){
             self.sheet.invalidate();
             if(callback) callback();
             });*/
        },
        hide: function () {
            this.rightContent.css({
                    'marginRight': -220,
                    'width': 0
                })
                /*this.rightContent.animate({
                 'marginRight': -220,
                 'width': 0
                 });*/
        },
        getView: function () {
            return this.sheet.getView();
        },
    });


    CPropertySheet = function (dataBox) {
        CPropertySheet.superClass.constructor.call(this, dataBox);
    }

    twaver.Util.ext(CPropertySheet, twaver.controls.PropertySheet, {
        updateCurrentRowIndex: function (newIndex) {
            var count = this._rowList.size();
            if (newIndex < 0 || newIndex >= count) {
                newIndex = -1;
            }
            var oldIndex = this._currentRowIndex,
                rowInfo;
            if (newIndex !== oldIndex) {
                // clear select background color
                if (oldIndex >= 0 && oldIndex < count) {
                    rowInfo = this._rowList.get(oldIndex);
                    if (rowInfo.nameRender) {
                        rowInfo.nameRender.style.backgroundColor = '';
                    }
                }
                this._currentRowIndex = newIndex;
            }
            if (newIndex >= 0) {
                rowInfo = this._rowList.get(newIndex);
                if (rowInfo.nameRender) {
                    // update select background color
                    rowInfo.nameRender.style.backgroundColor = this.getSelectColor();
                    // update current editor
                    if (!this._currentEditor) {
                        if (rowInfo.valueRender && rowInfo.valueRender._editInfo) {
                            var editInfo = rowInfo.valueRender._editInfo;
                            var editor = this.renderEditor && this.renderEditor(rowInfo);
                            if (editor) {
                                this._currentEditor = editor.view;
                                if (editInfo.value != null) {
                                    this._currentEditor.value = editInfo.value;
                                }
                            } else if (editInfo.enumInfo) {
                                this._currentEditor = $html.createSelect(editInfo.enumInfo, editInfo.value);
                            } else {
                                this._currentEditor = document.createElement('input');
                                if (editInfo.value != null) {
                                    this._currentEditor.value = editInfo.value;
                                }
                            }
                            var self = this;
                            if (this._currentEditor) {
                                if (editor && editor.onKeyDown) {
                                    var keydownEvents = editor.onKeyDown;
                                    if (keydownEvents && Array.isArray(keydownEvents)) {
                                        self._currentEditor.addEventListener('keydown', function (e) {
                                            for (var k = 0; k < keydownEvents.length; k++) {
                                                if (keydownEvents[k].combKey) {
                                                    var evt = null;
                                                    switch (keydownEvents[k].combKey) {
                                                        case 'ctrlKey':
                                                            evt = e.ctrlKey;
                                                            break;
                                                        case 'shiftKey':
                                                            evt = e.shiftKey;
                                                            break;
                                                        case 'altKey':
                                                            evt = e.altKey;
                                                            break;
                                                    }
                                                    if (e.keyCode === keydownEvents[k].keyCode && evt) {
                                                        keydownEvents[k].handlerEvent && keydownEvents[k].handlerEvent(e);
                                                    }
                                                } else {
                                                    if (e.keyCode === keydownEvents[k].keyCode) {
                                                        keydownEvents[k].handlerEvent && keydownEvents[k].handlerEvent(e);
                                                    }
                                                }
                                            }
                                        });
                                    }
                                } else {
                                    this._currentEditor.addEventListener('keydown', function (e) {
                                        var view = e.target._editInfo.view;
                                        if (e.keyCode === 13 && e.shiftKey) {
                                            return;
                                        } else if (e.keyCode === 13) {
                                            if (view._isCommitting) {
                                                return;
                                            }
                                            view._isCommitting = true;
                                            view.commitEditValue(e.target._editInfo, e.target);
                                        } else if (e.keyCode === 27) {
                                            view._isCanceling = true;
                                            view.cancelEditing();
                                        }
                                    }, false);
                                }
                                this._currentEditor.keepDefault = true;
                                this._currentEditor._rowInfo = rowInfo;
                                this._currentEditor._editInfo = editInfo;
                                if (!this._currentEditor.parentNode) {
                                    var style = this._currentEditor.style;
                                    style.position = 'absolute';
                                    style.margin = '0px';
                                    style.border = '0px';
                                    style.padding = '0px';
                                    style.left = this._indent + this._propertyNameWidth + 'px';
                                    style.top = rowInfo.rowDiv.style.top;
                                    style.width = rowInfo.valueRender.style.width;
                                    style.height = rowInfo.valueRender.style.height;
                                    this._rootDiv.appendChild(this._currentEditor);
                                }
                                twaver.Util.setFocus(this._currentEditor);
                            }
                        }
                    }
                }
            }
        }
    });

    nsp.edit.Ruler = function (component) {
        nsp.edit.Ruler.superClass.constructor.apply(this, arguments);
        this._view = this.createElement('div');
        this._view.style.position = 'absolute';
        this._view.style.left = '0px';
        this._view.style.right = '0px';
        this._view.style.top = '0px';
        this._view.style.bottom = '0px';
        this._topRuler = this.createElement('canvas');
        this._leftRuler = this.createElement('canvas');
        this._initRuler();
        this.setComponent(component);
        this.init();
        this.invalidate();
    }
    twaver.Util.ext(nsp.edit.Ruler, twaver.controls.ViewBase, {
        _defaultGap: 10,
        _rulerWidth: 20,
        _lineColor: '#888',
        _lineIntervalLineColor: '#ccc',
        _mousePoint: null,
        _showGuides: true,
        onPropertyChanged: function (e) {
            this.invalidate();
        },
        init: function () {
            if (this._topRuler.visible) this._view.appendChild(this._topRuler);
            if (this._leftRuler.visible) this._view.appendChild(this._leftRuler);
            if (this.component.getView) {
                this._view.appendChild(this.component.getView());
            } else {
                this._view.appendChild(this.component);
            }
        },
        setComponent: function (component) {
            var oldValue = this.component;
            var self = this;
            this.component = component;
            this.firePropertyChange('component', oldValue, component);

            this.addViewPropertyChangeListener(component, this._handleViewPropertyChange);
            this.component.getView().addEventListener('mousemove', function (e) {
                if (self._showGuides) {
                    var position = self.getAbsPostion(self.component._rootCanvas);
                    self._mousePoint = { x: e.clientX - position.left, y: e.clientY - position.top };
                    self.invalidate();
                }
            });
            $(this._view).resize(function () {
                var w = $(this._view).width();
                var h = $(this._view).height();
                self.component.adjustBounds({ x: 0, y: 0, width: w, height: h });
                self.invalidate();
            });
        },
        getAbsPostion: function (div) {
            var t = 0,
                l = 0;
            while (div = div.offsetParent) {
                t += div.offsetTop;
                l += div.offsetLeft;
            }
            return { left: l, top: t }
        },
        _initRuler: function () {
            this._topRuler.visible = true;
            this._leftRuler.visible = true;
            this._topRuler.style.borderBottom = "1px solid " + this._lineColor;
            this._topRuler.style.borderLeft = "1px solid " + this._lineColor;
            this._leftRuler.style.borderRight = "1px solid " + this._lineColor;
            this._leftRuler.style.borderTop = "1px solid " + this._lineColor;
        },
        _drawRuler: function () {
            var viewRect = this.getComponentViewRect();
            var zoom = this.getComponentZoom();
            this.calculateGap(zoom);
            var gap = this.getGap();
            var x = viewRect.x;
            var y = viewRect.y;
            var w = viewRect.width;
            var h = viewRect.height;

            var xOffset = x % (gap * 5);
            var x = x - xOffset - gap * 5 - 1;
            var offsetX = Math.round((viewRect.x - xOffset - gap * 5) / zoom);
            var startX = x - viewRect.x;
            if (Math.abs(Math.round(x / (gap * 5)) % 2) === 1) {
                startX = startX - gap * 5;
                offsetX = offsetX - this._defaultGap * 5;
            }
            var endX = w + (gap * 10);

            if (viewRect && this._topRuler.visible) {
                var g = $utils.transformAndScaleCanvasContext(this._topRuler);
                this._drawHRuler(g, startX, offsetX, gap, endX, this._rulerWidth);
            }

            //draw vertical ruler
            var yOffset = y % (gap * 5);
            var y = y - yOffset - gap * 5 - 1;
            var offsetY = Math.round((viewRect.y - yOffset - gap * 5) / zoom);
            var startY = y - viewRect.y;
            if (Math.abs(Math.round(y / (gap * 5)) % 2) === 1) {
                startY = startY - gap * 5;
                offsetY = offsetY - this._defaultGap * 5;
            }
            var endY = h + (gap * 10);

            if (viewRect && this._leftRuler.visible) {
                var g = $utils.transformAndScaleCanvasContext(this._leftRuler);
                this._drawVRuler(g, startY, offsetY, gap, endY, this._rulerWidth);
            }
        },
        _drawHRuler: function (g, startX, offsetX, gap, w, h) {

            //draw h ruler border
            g.clearRect(startX, 0, w, h);

            //draw h ruler scale
            g.save();
            g.strokeStyle = this._lineIntervalLineColor;
            g.beginPath();
            g.lineWidth = 1;
            var count = 1;
            var startY = h;
            var endY = h - 6;
            var zoom = this.getComponentZoom();

            for (var i = startX + gap; i < startX + w; i += gap) {
                endY = h - 6;
                if (count % 5 == 0) {
                    endY = h - 10;
                }
                if (count % 10 !== 0) {
                    g.moveTo(i, startY);
                    g.lineTo(i, endY);
                }
                count++;
            }
            g.closePath();
            g.stroke();

            count = 1;
            g.beginPath();
            g.strokeStyle = this._lineColor;
            for (var i = startX + gap; i < startX + w; i += gap) {
                if (count % 10 === 0) {
                    endY = 1;
                    g.moveTo(i, startY);
                    g.lineTo(i, endY);
                }
                count++;
            }
            g.stroke();
            g.restore();

            //draw scale text
            g.save();
            g.textBaseline = "middle",
                g.font = "11px Arial";
            g.fillStyle = this._lineColor;
            for (var k = offsetX, j = startX; j < startX + w; j += gap * 10, k += this._defaultGap * 10) {
                g.fillText(k, j + 5, 8);
            }
            g.restore();

            //draw guides
            if (this._showGuides && this._mousePoint) {
                g.save();
                g.strokeStyle = '#f07819';
                g.lineWidth = 3;
                g.beginPath();
                g.moveTo(this._mousePoint.x, 0);
                g.lineTo(this._mousePoint.x, 20);
                g.stroke();
                g.restore();
            }
        },
        _drawVRuler: function (g, startY, offsetY, gap, h, w) {
            g.clearRect(0, startY, w, h);

            //draw hruler scale
            g.save();
            g.strokeStyle = this._lineIntervalLineColor;
            g.beginPath();
            g.lineWidth = 1;

            var count = 1;
            var startX = w;
            var endX = w - 6;
            var zoom = this.getComponentZoom();
            for (var i = startY + gap; i < startY + h; i += gap) {
                endX = w - 6;
                if (count % 5 == 0) {
                    endX = w - 10;
                }
                if (count % 10 !== 0) {
                    g.moveTo(startX, i);
                    g.lineTo(endX, i);
                }
                count++;
            }
            g.closePath();
            g.stroke();
            g.restore();

            count = 1;
            g.beginPath();
            g.strokeStyle = this._lineColor;
            for (var i = startY + gap; i < startY + h; i += gap) {
                if (count % 10 === 0) {
                    endX = 1;
                    g.moveTo(startX, i);
                    g.lineTo(endX, i);
                }
                count++;
            }
            g.stroke();
            g.restore();

            //draw scale text
            g.save();
            g.textBaseline = "middle",
                g.textAlign = "left";
            g.font = "11px Arial";
            g.fillStyle = this._lineColor;
            for (var k = offsetY, j = startY; j < startY + h; j += gap * 10, k += this._defaultGap * 10) {
                g.save();
                var size = _twaver.g.getTextSize(g.font, k);
                var rect = { x: 2, y: j - 8, width: size.width, height: size.height };
                g.translate(rect.x, rect.y);
                g.rotate(3 * Math.PI / 2);
                g.translate(-(rect.x), -(rect.y));
                g.fillText(k, 0, j - 2);
                g.restore();
            }
            g.restore();

            //draw guides
            if (this._showGuides && this._mousePoint) {
                g.save();
                g.strokeStyle = '#f07819';
                g.lineWidth = 3;
                g.beginPath();
                g.moveTo(0, this._mousePoint.y);
                g.lineTo(20, this._mousePoint.y);
                g.stroke();
                g.restore();
            }
        },
        getComponentZoom: function () {
            return this.component.getZoom() || 1;
        },
        getGap: function () {
            var zoom = this.getComponentZoom();
            return this._defaultGap * zoom;
        },
        calculateGap: function (zoom) {
            if (zoom < 0.17) {
                this._defaultGap = 50;
            } else if (zoom < 0.5) {
                this._defaultGap = 20;
            } else if (zoom < 0.9) {
                this._defaultGap = 10;
            } else if (zoom < 3.2) {
                this._defaultGap = 5;
            } else {

                this._defaultGap = 1;
            }
        },
        setShowGuides: function (showGuides) {
            var oldValue = this._showGuides;
            this._showGuides = showGuides;
            this._drawRuler();
        },
        isShowGuides: function () {
            return this._showGuides;
        },
        setShowRuler: function (showRuler) {
            var oldValue = this._topRuler.visible;
            this._topRuler.visible = showRuler;
            this._leftRuler.visible = showRuler;
            if (showRuler) {
                if (!this.hasChildNode(this._view, this._topRuler)) {
                    this._view.appendChild(this._topRuler);
                }
                if (!this.hasChildNode(this._view, this._leftRuler)) {
                    this._view.appendChild(this._leftRuler);
                }
            } else {
                if (this.hasChildNode(this._view, this._topRuler)) {
                    this._view.removeChild(this._topRuler);
                }
                if (this.hasChildNode(this._view, this._leftRuler)) {
                    this._view.removeChild(this._leftRuler);
                }
            }
            this.firePropertyChange("showRuler", oldValue, showRuler);
        },
        hasChildNode: function (parent, child) {
            var children = parent.childNodes;
            for (var i in children) {
                if (children[i] == child) {
                    return true;
                }
            }
            return false;
        },
        getComponentViewRect: function () {
            return this.component.getViewRect ? this.component.getViewRect() : null;
        },
        addViewPropertyChangeListener: function (view, handler) {
            if (view && view.addPropertyChangeListener) {
                view.addPropertyChangeListener(handler, this);
            }
        },
        _handleViewPropertyChange: function (e) {
            var self = this;
            if (e.property == 'viewRect') {
                this._drawRuler();
            }
        },
        createElement: function (type) {
            return document.createElement(type);
        },
        validateImpl: function () {
            var w = this._view.offsetWidth,
                h = this._view.offsetHeight;
            // console.log(this._view.offsetWidth, this._view.offsetHeight);
            var th = 0,
                lw = 0,
                tx = 0,
                ly = 0,
                cx = 0,
                cy = 0,
                cw = w,
                ch = h;
            if (this._topRuler.visible) {
                th = this._rulerWidth;
                ly = this._rulerWidth;
                cy = this._rulerWidth;
            }
            if (this._leftRuler.visible) {
                lw = this._rulerWidth;
                tx = this._rulerWidth;
                cx = this._rulerWidth;
            }
            cw = w - lw, ch = h - th;

            if (this._topRuler.visible) {
                this._topRuler.width = cw;
                this._topRuler.height = th;
                // console.log(tx, 0, cw, th);
                _twaver.setViewBounds(this._topRuler, { x: tx, y: 0, width: cw, height: th });
                $utils.transformAndScaleCanvasContext(this._topRuler, true);
            }
            if (this._leftRuler.visible) {
                this._leftRuler.width = lw;
                this._leftRuler.height = ch;
                _twaver.setViewBounds(this._leftRuler, { x: 0, y: ly, width: lw, height: ch });
                $utils.transformAndScaleCanvasContext(this._leftRuler, true);
            }
            if (this.component) {
                _twaver.setViewBounds(this.component, { x: cx, y: cy, width: cw, height: ch });
                $utils.transformAndScaleCanvasContext(this.component._rootCanvas, true);
            }
            this._drawRuler();
        },
        getView: function () {
            return this._view;
        },
        left: function (left) {
            this._view.style.left = left + 'px';
            this.invalidate();
        }
    });
    /**
     * 设备面板编辑器
     * @param parentView {HTMLDIVElement} 父容器
     * @constructor
     */
    var ChassisEditor = function (parentView) {

        ChassisEditor.superClass.constructor.call(this, parentView);
        this.currentItem = null;

        this.pasteOffsetDz = 0;

        /**
         * 背板
         * @type {null | twaver.Node}
         */
        this.parentNode = null;

        /**
         * 3d到2d模型转换
         * @type {Object}
         */
        this.model3dTo2dMapping = $consts.deviceEditorModel3dTo2dMapping;

        /**
         * 2d到3d模型转换
         * @type {Object}
         */
        this.model2dTo3dMapping = $consts.deviceEditorModel2dTo3dMapping;

        this.lastSelectedChildNode = null;


        this._editable = false; //
        this.isAddChildNode = false;

        this.PANEL_CATEGORY = '设备面板';

        this.init();
    }

    ChassisEditor.prototype = {
        init: function () {

            var self = this;

            //create left menu
            this.accordionPane = new doodle.AccordionPane();

            //create network2d
            this.network2dView = this._initNetwork2d();

            this.network2d.setMaxZoom(40);

            var sheet = this.sheet = new twaver.controls.PropertySheet(this.box);
            $utils.initPropertySheet(sheet);
            var w = this.propertySheetBox.width();
            var h = this.propertySheetBox.height();
            sheet.adjustBounds({ x: 0, y: 0, width: w, height: h });

            this.propertySheetBox.append(this.sheet.getView());
            this.accordionPaneBox.append(this.accordionPane.getView());
            this.networkBox.append(this.network2dView);

            $(this.network2dView).on('dblclick', function (e) {
                //console.log(e);
                self.network2d.setDefaultInteractions();
            });

            this.refreshAccordion();
        },

        _initNetwork2d: function () {

            var self = this;
            var network2d = this.network2d = new nsp.edit.GridNetwork();
            this.network2d.setPositionMagneticEnabled(false);
            //this.network2d.setDragToPan(false);

            //this.network2d.setInteractions([
            //    new twaver.vector.interaction.DefaultInteraction(network2d),
            //    //new twaver.vector.interaction.EditInteraction(network2d),
            //]);
            var box = this.box;

            var box = this.box = this.network2d.getElementBox();

            var selectionModel = this.selectionModel = this.box.getSelectionModel();
            //selectionModel.setSelectionMode('singleSelection');
            selectionModel.addSelectionChangeListener(function (e) {
                //console.log('kind:' + e.kind + ',datas:' + e.datas.toString());
                var element = selectionModel.getLastData()
                self._resetPropertySheet();
                self.lastSelectedChildNode = null;
                if (element && !self.isHost(element)) {
                    self.lastSelectedChildNode = element;
                }
                if (self.parentNode) {
                    self.setSuspended(true);
                    if (self.network2d.isSelected(self.parentNode)) {
                        self.parentNode.setStyle('whole.alpha', 1);
                    } else if (selectionModel.size() > 0) {
                        self.parentNode.setStyle('whole.alpha', 0.3);
                    } else {
                        self.parentNode.setStyle('whole.alpha', 1);
                    }
                    self.setSuspended(false);
                }
            });
            selectionModel.setFilterFunction(function (element) {
                return self.isEditable(element);
            });
            var layerBox = box.getLayerBox();
            var parentLayer = this.parentLayer = new twaver.Layer('parentLayer');
            var childrenLayer = this.childrenLayer = new twaver.Layer('childrenLayer');
            layerBox.add(parentLayer);
            layerBox.add(childrenLayer);
            layerBox.moveToTop(parentLayer);

            var view = this.network2d.getView();
            DragAndDrop.setDropTarget(view, {
                self: this,
                dropEffect: 'copy',
                ondrop: function (e, data) {

                    data = JSON.parse(data);
                    var id = data.id;

                    //判断是否需要单独处理
                    if (self.onDropHandler && self.onDropHandler(e, data, box, network2d)) {
                        return;
                    }
                    //判断是否是拖拽的面板图,直接打开面板
                    var category = make.Default.getOtherParameter(id, 'category');
                    if (category == self.PANEL_CATEGORY) {
                        self._chassisId = id;
                        self.setData(make.Default.load(id));
                        return;
                    }
                    if (!self.parentNode) {
                        alert('先加载设备面板');
                        return;
                    }
                    var slot;
                    var element = self.network2d.getElementAt(e);
                    if (element && element.getClient('slot')) {
                        slot = element.getClient('bid');
                    }
                    if (!slot) {
                        return;
                    }
                    var node = self.loadCard(id, {
                        client: {
                            loc: slot
                        }
                    });
                    if (node) {
                        self.selectionModel.clearSelection();
                        self.selectionModel.setSelection(node);
                        self._resetPropertySheet();
                    }
                },
                ondragover: function (e) {

                },
                ondragleave: function (e) {

                }
            });

            network2d.addInteractionListener(function (e) {
                if (e.kind === 'doubleClickElement') {}
                if (e.kind === 'liveMoveStart') {
                    self._card = network2d.getSelectionModel().getLastData();
                    self.setSuspended(true);
                    self._card.setStyle('whole.alpha', 0.3);
                }
                if (e.kind === 'liveMoveBetween') {}
                if (e.kind === 'liveMoveEnd') {
                    var slot;
                    var elements = network2d.getElementsAt(e);
                    var slot = null;
                    elements && elements.forEach(function (element) {
                        if (element.getClient('slot') && !element.getClient('follower')) {
                            slot = element;
                        }
                    });
                    self._card.setStyle('whole.alpha', 1);
                    if (slot) {
                        self._card.setLocation(self._card.getHost().getLocation());
                        self.setSuspended(false);
                        self.startBatch();
                        self._card.getHost().setClient('follower', null);
                        self._card.setSize(slot.getSize());
                        self._card.setLocation(slot.getLocation());
                        self._card.setClient('loc', slot.getClient('bid'));
                        slot.setClient('follower', self._card);
                        self._card.setHost(slot);
                        self.endBatch();
                    } else {
                        slot = self._card.getHost();
                        self._card.setLocation(slot.getLocation());
                        self.setSuspended(false);
                    }
                    self._card = null;
                }
            });

            var ruler = this.ruler = new nsp.edit.Ruler(this.network2d);

            ruler.getView().setAttribute('class', 'room-ruler');
            ruler.setShowGuides(false);
            ruler.setShowRuler(true);
            var rulerView = $(ruler.getView());
            return rulerView;
        },

        /**
         * drop handler
         * 如果返回true,终止默认编辑器的后续操作
         * @param e {DropEvent} drop事件
         * @param data {Object} drop的data
         * @param box {twaver.ElementBox} element box
         * @param network {twaver.vector.Network} network
         */
        onDropHandler: function (e, data, box, network) {

        },
        getEditId: function (id) {
            return $utils.getDeviceEditorModel2dId(id);
        },
        isEditable: function (node) {
            return node.getClient('card');
        },
        isHost: function (node) {
            return !!node.getClient('host')
        },
        isResizeable: function (node) {
            return !!node.getClient('resizeable');
        },

        /**
         * load cards
         * @param cards {Object}
         * @returns {Array}
         */
        loadCards: function (cards) {
            var result = [];
            var self = this;
            if (cards instanceof Array) {
                cards.forEach(function (child) {
                    var node = self.loadCard(child.id, child);
                    result.push(node);
                });
            } else {
                var node = self.loadCard(cards.id, cards);
                result.push(node);
            }
            return result;
        },

        /**
         * load child
         * @param modelClass {string} 模型id
         * @param args {Object} 模型参数
         * @returns {twaver.Node}
         */
        loadChild: function (modelClass, args) {
            if (!this.parentNode) {
                console.warn('parentNode is null');
            }
            var self = this;
            modelClass = modelClass.replace('.' + $consts.DEVICE_MODEL_SUFFIX, '');
            args.id = this.getEditId(modelClass);
            args.objectId = doodle.id();
            var data = make.Default.load(args);
            if (data instanceof Array) {
                var nodes = data;
                nodes.forEach(function (node) {
                    node.setLayerId(self.childrenLayer.getId());
                    if (self.parentNode) {
                        node.setHost(self.parentNode);
                    }
                    self.box.add(node);
                })
            } else {
                var node = data;
                node.setLayerId(self.childrenLayer.getId());
                if (self.parentNode) {
                    node.setHost(self.parentNode);
                }
                self.box.add(node);
            }
            return data;
        },

        /**
         * load card
         * @param modelClass {string} 模型id
         * @param args {Object} 模型参数
         * @returns {twaver.Node}
         */
        loadCard: function (modelClass, args) {
            var self = this;
            modelClass = modelClass.replace('.' + $consts.DEVICE_MODEL_SUFFIX, '');
            args.id = this.getEditId(modelClass);
            args.objectId = doodle.id();
            var data = make.Default.load(args);
            data.setLayerId(self.childrenLayer.getId());
            var slot;
            self.box.forEach(function (child) {
                if (child.getClient('slot') && child.getClient('bid') === args.client.loc) {
                    slot = child;
                }
            });
            if (!slot) {
                alert('no slot: ' + args.client.loc);
                return;
            }
            data.setSize(slot.getSize());
            data.setLocation(slot.getLocation());
            self.startBatch();
            self.box.add(data);
            slot.setClient('follower', data);
            data.setHost(slot);
            self.endBatch();
            return data;
        },


        /**
         * 加载背板
         * @param modelClass {String} 背板模型ID
         * @param args {Object} 模版参数
         * @returns {twaver.Node} 返回背板节点
         */
        loadParent: function (modelClass, args) {
            modelClass = modelClass.replace('.' + $consts.DEVICE_MODEL_SUFFIX, '');
            args.id = this.getEditId(modelClass);
            args.objectId = doodle.id();
            var node = make.Default.load(args);
            node.setLayerId(this.parentLayer.getId());
            node.setLocation(0, 0);
            node.setMovable(false);
            this.parentNode = node;
            this.box.add(node);
            return node;
        },

        /**
         * set data
         * the first item is must be parent if jsonArray have parent
         * 如果包含背板,第一个元素必须是背板
         * @param jsonArray {Object[]}
         */
        setData: function (jsonArray) {
            var self = this;
            this.clear();
            this.startBatch();
            for (var i = 0; i < jsonArray.length; i++) {
                var data = jsonArray[i];
                if (i == 0 && make.Default.getOtherParameter(data.id, 'host')) {
                    self.loadParent(data.id, data);
                } else {
                    self.loadChild(data.id, data);
                }
            }
            this.endBatch();
        },
        clear: function () {
            this.box.clear();
            this.network2d.getElementBox().getUndoManager().clear();
        },

        _resetPropertySheet: function () {

            if (!this.isPropertySheetVisible()) {
                return;
            }
            var self = this;
            var propBox = self.sheet.getPropertyBox();
            propBox.clear();
            var selection = this.box.getSelectionModel();
            if (selection.size() != 1) {
                propBox.clear();
                this.propertySheetBox.hide();
            } else {
                this.propertySheetBox.show();
                var node = selection.getLastData();
                $utils.addProperties(propBox, make.Default.getModelDefaultParameterProperties(make.Default.getId(node)));
                self.resetPropertySheetBoxSize(this.sheet);
            }
        },

        /**
         * 视图总览
         */
        zoomOverview: function () {
            this.network2d.zoomOverview();
        },

        /**
         * 切换编辑模式,是否允许鼠标拖拽编辑
         * @param newValue {boolean} true 允许鼠标编辑, false 禁止编辑
         */
        setMouseEditable: function (newValue) {

            var oldValue = this._editable;
            if (oldValue != newValue) {
                this._editable = newValue;
                if (this._editable) {
                    this.network2d.setInteractions([
                        new twaver.vector.interaction.DefaultInteraction(this.network2d),
                        new twaver.vector.interaction.EditInteraction(this.network2d),
                    ]);
                } else {
                    this.network2d.setInteractions([
                        new twaver.vector.interaction.DefaultInteraction(this.network2d),
                    ]);
                }
            }
        },

        /**
         * 切换鼠标拖动拖放,
         * @param status {boolean} true 整个画布拖动 , false 单个元素拖动
         */
        setDragToPan: function (status) {
            this.network2d.setDragToPan(status);
        },

        /**
         * 取得编辑结果
         * @returns {Array}
         */
        getData: function () {
            var result = [];
            var self = this;
            this.box.forEach(function (data) {
                if (data.getClient('card')) {
                    var json = make.Default.toJson(data)
                    result.push(json);
                }
            });
            return result;
        },
        appendData: function (data) {
            this.loadChildren(data);
        },
        removeData: function (data) {
            var self = this;

            if (data instanceof Array) {
                return data.map(function (item) {
                    return self.box.removeById(item.objectId)
                })
            } else {
                return self.box.removeById(data.objectId)
            }
        },
        getSelectedData: function () {

            var self = this;
            var copyNodes = [];
            var nodes = this.selectionModel.getSelection().toList();
            if (nodes && nodes.size() > 0) {

                nodes.forEach(function (node) {
                    if (self.isHost(node)) {
                        return;
                    }
                    var json = make.Default.toJson(node)
                    copyNodes.push(json);
                })
            }
            return copyNodes;
        },
        /**
         * refresh accordion
         * 刷新左侧组件栏, 默认是调用doodle.utils.load2dChassisCategory()的结果
         * @param categories {Object[]} default is the result of calling function doodle.utils.load2dChassisCategory()
         */
        refreshAccordion: function (categories) {
            categories = categories || doodle.utils.load2dChassisCategory();
            this.accordionPane.setCategories(categories);
        }
    }

    doodle.ChassisEditor = ChassisEditor;
    doodle.utils.ext(ChassisEditor, Editor)





















    /**
     * 设备面板编辑器
     * @param parentView {HTMLDIVElement} 父容器
     * @constructor
     */
    var DeviceEditor = function (parentView) {

        DeviceEditor.superClass.constructor.call(this, parentView);
        this.currentItem = null;

        this.pasteOffsetDz = 0;

        /**
         * 背板
         * @type {null | twaver.Node}
         */
        this.parentNode = null;

        /**
         * 3d到2d模型转换
         * @type {Object}
         */
        this.model3dTo2dMapping = $consts.deviceEditorModel3dTo2dMapping;

        /**
         * 2d到3d模型转换
         * @type {Object}
         */
        this.model2dTo3dMapping = $consts.deviceEditorModel2dTo3dMapping;

        this.copyChildNode = null;
        this.lastSelectedChildNode = null;


        this._editable = false; //
        this.isAddChildNode = false;

        /**
         * 快捷复制键,默认c键
         * 选中一个节点,按住c键,会出现选中节点边框,点击可以快捷复制
         * @type {number}
         */
        this.KEY_CODE_COPY_ONE = 81; // Q键
        this.PANEL_CATEGORY = '设备面板';

        this.init();
    }

    DeviceEditor.prototype = {
        init: function () {

            var self = this;

            //create left menu
            this.accordionPane = new doodle.AccordionPane();

            //create network2d
            this.network2dView = this._initNetwork2d();

            this.network2d.setMaxZoom(40);

            var sheet = this.sheet = new twaver.controls.PropertySheet(this.box);
            $utils.initPropertySheet(sheet);
            var w = this.propertySheetBox.width();
            var h = this.propertySheetBox.height();
            sheet.adjustBounds({ x: 0, y: 0, width: w, height: h });

            this.propertySheetBox.append(this.sheet.getView());
            this.accordionPaneBox.append(this.accordionPane.getView());
            this.networkBox.append(this.network2dView);
            this.copyChildNode = this._createCopyChildNode();

            this.addKeyMoveListener(this.network2d);

            $(this.network2dView).on('mousemove', function (e) {
                //console.log(e);
                if (self.copyChildNode) {
                    var endPoint = self.network2d.getLogicalPoint(e);
                    self.copyChildNode.setCenterLocation(endPoint);
                }
            });

            $(document).on('keyup', function (e) {
                //console.log(e, e.keyCode);
                if (e.keyCode == self.KEY_CODE_COPY_ONE && self.box.contains(self.copyChildNode)) { //ctrl key   copy node end
                    self.box.remove(self.copyChildNode)
                }
            });

            $(this.network2dView).on('keydown', function (e) {
                //console.log(e, e.keyCode);
                if (e.keyCode == 32) { //空格 旋转
                    var node = self.box.getSelectionModel().getLastData();
                    if (!node) {
                        return;
                    }
                    var angle = node.getAngle();
                    node.setAngle(angle + 90);
                } else if (e.keyCode == self.KEY_CODE_COPY_ONE && self.lastSelectedChildNode && !self.box.contains(self.copyChildNode)) { //ctrl key  copy node start
                    var size = self.lastSelectedChildNode.getSize();
                    var angle = self.lastSelectedChildNode.getAngle();
                    self.copyChildNode.setSize(size);
                    self.copyChildNode.setAngle(angle);
                    self.copyChildNode.setClient('id', self.lastSelectedChildNode.getClient('id'));
                    self.box.add(self.copyChildNode);
                } else if (e.keyCode == 8) { //delete node
                    e.preventDefault();
                }
            });

            $(this.network2dView).on('dblclick', function (e) {
                //console.log(e);
                self.network2d.setDefaultInteractions();
            });
            $(this.network2dView).on('click', function (e) {
                //console.log(e);
                if (self.box.contains(self.copyChildNode)) { //copy node start
                    var id = self.copyChildNode.getClient('id');
                    var endPoint = self.network2d.getLogicalPoint(e);
                    var size = self.copyChildNode.getSize();
                    var angle = self.copyChildNode.getAngle();
                    var position = [endPoint.x, endPoint.y, 0];
                    position[0] -= size.width / 2
                    position[1] -= size.height / 2;
                    var args = {
                        position: position,
                        rotation: [0, 0, angle],
                        width: size.width,
                        height: size.height,
                    };
                    self.loadChild(id, args);
                    e.preventDefault();
                    return false;
                }
            });

            this.setUndoManagerEnabled(true);

            this.refreshAccordion();
        },

        _initNetwork2d: function () {

            var self = this;
            var network2d = this.network2d = new nsp.edit.GridNetwork();
            //this.network2d.setPositionMagneticEnabled(false);
            this.network2d.setPositionMagneticX(5);
            this.network2d.setPositionMagneticY(5);
            //this.network2d.setDragToPan(false);

            //this.network2d.setInteractions([
            //    new twaver.vector.interaction.DefaultInteraction(network2d),
            //    //new twaver.vector.interaction.EditInteraction(network2d),
            //]);
            this.network2d.setEditableFunction(function (e) {

                //if (!self._editable) {
                //    return false;
                //}
                //var data = self.selectionModel.getSelection();
                //if (data && data.size() > 1) {
                //    return false;
                //}
                return (!self.isHost(e) && self.copyChildNode != e) || self.isResizeable(e);
            })
            var box = this.box;
            this.network2d.getView().addEventListener('keydown', function (e) {
                var myKey = false;
                var xgap = self.network2d.getPositionMagneticX(),
                    ygap = self.network2d.getPositionMagneticY();
                if (e.keyCode == 37) { //Left
                    $utils.moveSelectionElements(box, "left", xgap, ygap);
                    myKey = true;
                }
                if (e.keyCode == 38) { //Top
                    $utils.moveSelectionElements(box, "top", xgap, ygap);
                    myKey = true;
                }
                if (e.keyCode == 39) { //Right
                    $utils.moveSelectionElements(box, "right", xgap, ygap);
                    myKey = true;
                }
                if (e.keyCode == 40) { //Bottom
                    $utils.moveSelectionElements(box, "bottom", xgap, ygap);
                    myKey = true;
                }

                if (myKey) {
                    e.preventDefault();
                    e.stopPropagation();
                }

            });

            var box = this.box = this.network2d.getElementBox();

            var packQuickFinder = this.packQuickFinder = new twaver.QuickFinder(this.box, 'pack', 'client');

            var selectionModel = this.selectionModel = this.box.getSelectionModel();
            //selectionModel.setSelectionMode('singleSelection');
            selectionModel.addSelectionChangeListener(function (e) {
                //console.log('kind:' + e.kind + ',datas:' + e.datas.toString());
                var element = selectionModel.getLastData()
                clearTimeout(self.selectionChangeHandleTimer);
                self.selectionChangeHandleTimer = setTimeout(function () {
                    self._resetPropertySheet();
                    self.lastSelectedChildNode = null;
                    if (element && !self.isHost(element)) {
                        self.lastSelectedChildNode = element;
                    }
                    if (self.parentNode) {
                        if (self.network2d.isSelected(self.parentNode)) {
                            self.parentNode.setStyle('whole.alpha', 1);
                        } else if (selectionModel.size() > 0) {
                            self.parentNode.setStyle('whole.alpha', 0.3);
                        } else {
                            self.parentNode.setStyle('whole.alpha', 1);
                        }
                    }
                }, 100);

                //console.log(e);
                var selection = selectionModel.getSelection();
                if (!selection || selection.size() == 0) {
                    return;
                }
                var pack = element.getClient('pack');
                if (pack) {

                    var list = packQuickFinder.find(pack);

                    if (selection) {
                        for (var i = 0; i < selection.size(); i++) {
                            var item = selection.get(i);
                            if (!list.contains(item)) {
                                selectionModel.removeSelection(item);
                                i--;
                            }
                        }
                    }
                    list.forEach(function (item) {
                        if (!selectionModel.contains(item)) {
                            selectionModel.appendSelection(item);
                        }
                    }, this)
                }
            });
            selectionModel.setFilterFunction(function (element) {

                return self.isEditable(element);
            });
            var layerBox = box.getLayerBox();
            var parentLayer = this.parentLayer = new twaver.Layer('parentLayer');
            var childrenLayer = this.childrenLayer = new twaver.Layer('childrenLayer');
            layerBox.add(parentLayer);
            layerBox.add(childrenLayer);
            layerBox.moveToTop(parentLayer);

            var view = this.network2d.getView();
            DragAndDrop.setDropTarget(view, {
                self: this,
                dropEffect: 'copy',
                ondrop: function (e, data) {

                    data = JSON.parse(data);
                    var id = data.id;
                    self.startBatch();
                    //判断是否需要单独处理
                    if (self.onDropHandler && self.onDropHandler(e, data, box, network2d)) {
                        self.endBatch();
                        return;
                    }
                    //判断是否是拖拽的面板图,直接打开面板
                    var category = make.Default.getOtherParameter(id, 'category');
                    if (category == self.PANEL_CATEGORY || category == '单板面板') {
                        self.setData(make.Default.load(id));
                        self.endBatch();
                        return;
                    }
                    var endPoint = self.network2d.getLogicalPoint(e);
                    var host = make.Default.getOtherParameter(self.getEditId(id), 'host'); // 是否是host节点
                    var args = {
                        position: [endPoint.x, endPoint.y, 0],
                        centerLocation: { x: endPoint.x, y: endPoint.y }
                    };
                    var node = null;
                    if (host) {
                        node = self.loadParent(id, args);
                        setTimeout(function () {
                            self.network2d.zoomOverview();
                        }, 100)
                    } else {
                        node = self.loadChild(id, args);
                    }
                    if (node) {
                        self.selectionModel.clearSelection();
                        self.selectionModel.setSelection(node);
                        self._resetPropertySheet();
                    }
                    self.endBatch();
                },
                ondragover: function (e) {

                },
                ondragleave: function (e) {

                }
            });

            var ruler = this.ruler = new nsp.edit.Ruler(this.network2d);

            ruler.getView().setAttribute('class', 'room-ruler');
            ruler.setShowGuides(false);
            ruler.setShowRuler(true);
            var rulerView = $(ruler.getView());
            return rulerView;
        },

        /**
         * drop handler
         * 如果返回true,终止默认编辑器的后续操作
         * @param e {DropEvent} drop事件
         * @param data {Object} drop的data
         * @param box {twaver.ElementBox} element box
         * @param network {twaver.vector.Network} network
         */
        onDropHandler: function (e, data, box, network) {

        },
        getEditId: function (id) {
            return $utils.getDeviceEditorModel2dId(id);
        },
        isEditable: function (node) {

            if (node.getClient('editable') === true) {
                return true;
            }
            return !this.isHost(node);
        },
        isHost: function (node) {
            return !!node.getClient('host')
        },
        isResizeable: function (node) {
            return !!node.getClient('resizeable');
        },
        _createCopyChildNode: function () {
            var node = new twaver.Node();
            node.setLayerId(this.childrenLayer.getId());
            node.setStyle('body.type', 'vector');
            node.setStyle('vector.shape', 'rectangle');
            node.setStyle('vector.fill', false);
            node.setStyle('vector.outline.width', 2);
            node.setStyle('vector.outline.color', '#a0a819');
            return node;
        },

        /**
         * load children
         * @param children {twaver.Node}
         * @returns {Array}
         */
        loadChildren: function (children) {
            var result = [];
            var self = this;
            var linkArray = []
            if (children instanceof Array) {
                children.forEach(function (child) {
                    if (make.Default.getOtherParameter(child.id, 'link')) {
                        linkArray.push(child);
                    } else {
                        var node = self.loadChild(child.id, child);
                        result.push(node);
                    }

                });
                linkArray.forEach(function (child) {
                    var link = self.loadChild(child.id, child);
                    result.push(link);
                });
            } else {
                var node = self.loadChild(children.id, children);
                result.push(node);
            }
            return result;
        },

        /**
         * load child
         * @param modelClass {string} 模型id
         * @param args {Object} 模型参数
         * @returns {twaver.Node}
         */
        loadChild: function (modelClass, args) {

            if (!this.parentNode) {
                console.warn('parentNode is null');
            }
            if (!modelClass) return;
            var self = this;
            modelClass = modelClass.replace('.' + $consts.DEVICE_MODEL_SUFFIX, '');
            args.id = this.getEditId(modelClass);
            args.objectId = doodle.id();
            var data = make.Default.load(args);
            if (make.Default.getOtherParameter(args.id, 'link')) {
                var link = data;
                link.setFromNode(self.findByBID(args.from));
                link.setToNode(self.findByBID(args.to))
                self.box.add(link);
            } else if (data instanceof Array) {
                var nodes = data;
                nodes.forEach(function (node) {
                    node.setLayerId(self.childrenLayer.getId());
                    if (self.parentNode) {
                        node.setHost(self.parentNode);
                    }
                    self.box.add(node);
                })
            } else {
                var node = data;
                node.setLayerId(self.childrenLayer.getId());
                if (self.parentNode) {
                    node.setHost(self.parentNode);
                }
                self.box.add(node);
            }
            return data;
        },


        /**
         * 加载背板
         * @param modelClass {String} 背板模型ID
         * @param args {Object} 模版参数
         * @returns {twaver.Node} 返回背板节点
         */
        loadParent: function (modelClass, args) {

            modelClass = modelClass.replace('.' + $consts.DEVICE_MODEL_SUFFIX, '');
            args.id = this.getEditId(modelClass);
            args.objectId = doodle.id();
            this.box.clear();
            var node = make.Default.load(args);
            node.setLayerId(this.parentLayer.getId());
            //node.setEditable(false);
            node.setLocation(0, 0);
            node.setMovable(false);
            this.parentNode = node;
            this.startBatch();
            this.box.add(node);
            this.endBatch();
            return node;
        },

        /**
         * set data
         * the first item is must be parent if jsonArray have parent
         * 如果包含背板,第一个元素必须是背板
         * @param jsonArray {Object[]}
         */
        setData: function (jsonArray) {
            var self = this;
            var linkArray = [];
            for (var i = 0; i < jsonArray.length; i++) {
                var data = jsonArray[i];
                if (make.Default.getOtherParameter(data.id, 'link')) {
                    linkArray.push(data);
                } else if (i == 0 && make.Default.getOtherParameter(data.id, 'host')) {
                    self.loadParent(data.id, data);
                } else {
                    self.loadChild(data.id, data);
                }
            }
            linkArray.forEach(function (data) {
                self.loadChild(data.id, data);
            })
        },
        clear: function () {
            this.box.clear();
        },

        _resetPropertySheet: function () {

            if (!this.isPropertySheetVisible()) {
                return;
            }
            var self = this;
            var propBox = self.sheet.getPropertyBox();
            propBox.clear();
            var selection = this.box.getSelectionModel();
            if (selection.size() != 1) {
                propBox.clear();
                this.propertySheetBox.hide();
            } else {
                this.propertySheetBox.show();
                var node = selection.getLastData();
                $utils.addProperties(propBox, make.Default.getModelDefaultParameterProperties(make.Default.getId(node)));
                self.resetPropertySheetBoxSize(this.sheet);
            }
        },


        /**
         * align selected data
         * 对齐选中的元素
         * @param type{string} 枚举[left, right, top, bottom, center, middle]
         */
        align: function (type) {
            var self = this;
            if (!type) {
                return;
            }
            var data = this.selectionModel.getSelection();

            //去除选中的parent
            var list = new twaver.List();
            data.forEach(function (node) {
                if (node && !self.isHost(node)) {
                    list.add(node);
                }
            })
            if (!list || list.size() < 2) {
                return;
            }
            make.Default.align(list, type);
        },

        /**
         * flow selected data
         * 均匀分布选中的元素
         * @param type {string} 枚举[hor, ver]
         * @param padding {number} 间距
         */
        flow: function (type, padding) {
            var self = this;
            if (!type) {
                return;
            }
            var data = this.selectionModel.getSelection();
            //去除选中的parent
            var list = new twaver.List();
            data.forEach(function (node) {
                if (node && !self.isHost(node)) {
                    list.add(node);
                }
            })
            if (!list || list.size() < 2) {
                return;
            }
            make.Default.flow(list, type, padding);
        },

        /**
         * 视图总览
         */
        zoomOverview: function () {
            this.network2d.zoomOverview();
        },

        /**
         * 切换编辑模式,是否允许鼠标拖拽编辑
         * @param newValue {boolean} true 允许鼠标编辑, false 禁止编辑
         */
        setMouseEditable: function (newValue) {

            var oldValue = this._editable;
            if (oldValue != newValue) {
                this._editable = newValue;
                if (this._editable) {
                    this.network2d.setInteractions([
                        new twaver.vector.interaction.DefaultInteraction(this.network2d),
                        new twaver.vector.interaction.EditInteraction(this.network2d),
                    ]);
                } else {
                    this.network2d.setInteractions([
                        new twaver.vector.interaction.DefaultInteraction(this.network2d),
                    ]);
                }
            }
        },

        /**
         * 切换鼠标拖动拖放,
         * @param status {boolean} true 整个画布拖动 , false 单个元素拖动
         */
        setDragToPan: function (status) {
            this.network2d.setDragToPan(status);
        },

        /**
         * 取得编辑结果
         * @param relative {boolean} 是否按相对坐标位置导出, true 以所有元素的最左上角为起点, false 导出绝对坐标
         * @returns {Array}
         */
        getData: function () {

            var result = [];
            var self = this;
            this.box.forEach(function (data) {

                if (data == self.parentNode) {
                    var json = make.Default.toJson(data)
                    result.splice(0, 0, json);
                } else {
                    var json = make.Default.toJson(data)
                    result.push(json);
                }
            });
            return result;
        },
        appendData: function (data) {
            this.loadChildren(data)
        },
        removeData: function (data) {
            var self = this;

            if (data instanceof Array) {
                return data.map(function (item) {
                    return self.box.removeById(item.objectId)
                })
            } else {
                return self.box.removeById(data.objectId)
            }
        },
        getSelectedData: function () {

            var self = this;
            var copyNodes = [];
            var nodes = this.selectionModel.getSelection().toList();
            if (nodes && nodes.size() > 0) {

                nodes.forEach(function (node) {
                    if (self.isHost(node)) {
                        return;
                    }
                    var json = make.Default.toJson(node, function (obj) {
                        obj.objectId = node.getId();
                        return obj;
                    })
                    copyNodes.push(json);
                })
            }
            return copyNodes;
        },
        /**
         * refresh accordion
         * 刷新左侧组件栏, 默认是调用doodle.utils.load2dSceneCategory()的结果
         * @param categories {Object[]} default is the result of calling function doodle.utils.load2dDeviceCategory()
         */
        refreshAccordion: function (categories) {
            categories = categories || doodle.utils.load2dDeviceCategory();
            this.accordionPane.setCategories(categories);
        }
    }

    doodle.DeviceEditor = DeviceEditor;
    doodle.utils.ext(DeviceEditor, Editor)





















    CircuitCreateLinkInteraction = function (network, typeOrLinkFunction) {
        CircuitCreateLinkInteraction.superClass.constructor.call(this, network, typeOrLinkFunction);
    }

    twaver.Util.ext("CircuitCreateLinkInteraction", twaver.vector.interaction.CreateLinkInteraction, {
        paint: function (ctx) {
            ctx.beginPath();
            var rect;
            var r;
            ctx.lineWidth = this.network.getEditLineWidth();
            if (this.currentPoint) {
                this.paintLine(ctx);
            }
            ctx.closePath();
        },
        paintLine: function (ctx) {
            var lineColor = this.network.getEditLineColor();
            var x1 = this.fromNode.hotPoint.x,
                y1 = this.fromNode.hotPoint.y;
            var x2 = this.currentPoint.x,
                y2 = this.currentPoint.y;
            var rect = this.network.getViewRect();
            if (!isFoleLink) {
                ctx.strokeStyle = lineColor;
                ctx.beginPath();
                ctx.moveTo(x1 - rect.x, y1 - rect.y);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            } else {
                ctx.strokeStyle = lineColor;
                ctx.beginPath();
                ctx.moveTo(x1 - rect.x, y1 - rect.y);
                ctx.lineTo(x2, y1 - rect.y);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }
        },
        clear: function () {
            this.currentPoint = null;
            this.currentNode = null;
            this.fromNode = null;
            this.toNode = null;
            this.lastNode = null;
        },
        handle_mousedown: function (e) {
            if (!this.network.isValidEvent(e)) {
                return;
            }
            if (this.fromNode) {
                this.toNode = this.currentNode;
                if (this.toNode instanceof twaver.HorizontalLine) {
                    var link = this.createLink();
                    var offset = this.toNode.getClient('IntersectionPointOffset') || 0;
                    link.s('link.to.percent', [offset, 0]);
                    if (link) {
                        this.network.addElementByInteraction(link);
                    }
                    this.lastNode.setClient('IntersectionPoint', null);
                } else if (this.toNode instanceof twaver.VerticalLine) {
                    var link = this.createLink();
                    var offset = this.toNode.getClient('IntersectionPointOffset') || 0;
                    link.s('link.to.percent', [0, offset]);
                    if (link) {
                        this.network.addElementByInteraction(link);
                    }
                    this.lastNode.setClient('IntersectionPoint', null);
                } else if (this.toNode instanceof twaver.Node) {
                    var nodeUI = this.network.getElementUI(this.toNode);
                    if (!nodeUI) return;
                    var hp1 = nodeUI._hotPoint1;
                    var hp2 = nodeUI._hotPoint2;
                    if (!hp1 || !hp2) return;
                    var cp = this.network.getLogicalPoint2(e);
                    if (Math.pow((cp.x - hp1.x), 2) + Math.pow((cp.y - hp1.y), 2) < Math.pow((cp.x - hp2.x), 2) + Math.pow((cp.y - hp2.y), 2)) {
                        this.toNode.hotPoint = hp1;
                    } else {
                        this.toNode.hotPoint = hp2;
                    }
                    var link = this.createLink();
                    if (link) {
                        this.network.addElementByInteraction(link);
                    }
                }
                this.clear();
            } else {
                this.fromNode = this.currentNode;
                this.currentNode = null;
                this.currentPoint = null;
                this.repaint();
                var nodeUI = this.network.getElementUI(this.fromNode);
                if (!nodeUI) return;
                var hp1 = nodeUI._hotPoint1;
                var hp2 = nodeUI._hotPoint2;
                if (!hp1 || !hp2) return;
                var cp = this.network.getLogicalPoint2(e);
                if (Math.pow((cp.x - hp1.x), 2) + Math.pow((cp.y - hp1.y), 2) < Math.pow((cp.x - hp2.x), 2) + Math.pow((cp.y - hp2.y), 2)) {
                    this.fromNode.hotPoint = hp1;
                } else {
                    this.fromNode.hotPoint = hp2;
                }
            }
            if (this.lastNode) {
                var lastNode = this.lastNode;
                lastNode.setClient('drawIntersectionPoint1', false);
                lastNode.setClient('drawIntersectionPoint2', false);
                lastNode.setClient('IntersectionPoint', null);
            }
        },
        handle_mousemove: function (e) {
            var point = this.getMarkerPoint(e);
            if (!point) {
                return;
            }
            if (this.network.isMovingElement() || this.network.isEditingElement()) {
                this.clear();
                return;
            }
            var node = null;
            if (this.fromNode) {
                this.currentNode = this.getToNode(e, this.fromNode);
                this.currentPoint = point;
                this.repaint();
                if (this.currentNode instanceof twaver.HorizontalLine) {
                    var points = this.currentNode.getPoints();
                    if (points.size() !== 2) return;
                    var cp = this.network.getLogicalPoint2(e);
                    var lineLength = this.currentNode.getLineLength();
                    var xOffset = Math.abs(cp.x - points.get(0).x) / lineLength;
                    this.currentNode.setClient('IntersectionPointOffset', xOffset);
                    if (Math.abs(xOffset) > 0 && Math.abs(xOffset) < 1) {
                        xOffset *= lineLength;
                    }
                    var translatePoint = { x: points.get(0).x + xOffset, y: points.get(0).y };
                    this.currentNode.setClient('IntersectionPoint', translatePoint);
                    this.lastNode = this.currentNode;
                    this.currentNode.hotPoint = translatePoint;
                } else if (this.currentNode instanceof twaver.VerticalLine) {
                    var points = this.currentNode.getPoints();
                    if (points.size() !== 2) return;
                    var cp = this.network.getLogicalPoint2(e);
                    var lineLength = this.currentNode.getLineLength();
                    var offset = Math.abs(cp.y - points.get(0).y) / lineLength;
                    this.currentNode.setClient('IntersectionPointOffset', offset);
                    if (Math.abs(offset) > 0 && Math.abs(offset) < 1) {
                        offset *= lineLength;
                    }
                    var translatePoint = { x: points.get(0).x, y: points.get(0).y + offset };
                    this.currentNode.setClient('IntersectionPoint', translatePoint);
                    this.lastNode = this.currentNode;
                    this.currentNode.hotPoint = translatePoint;
                } else if (this.currentNode instanceof twaver.Node) {
                    if (!this.currentNode.getClient('connectable')) return;
                    var nodeUI = this.network.getElementUI(this.currentNode);
                    var hp1 = nodeUI._hotPoint1;
                    var hp2 = nodeUI._hotPoint2;
                    this.lastNode = this.currentNode;
                    if (!hp1 || !hp2) return;
                    var cp = this.network.getLogicalPoint2(e);
                    if (Math.pow((cp.x - hp1.x), 2) + Math.pow((cp.y - hp1.y), 2) < Math.pow((cp.x - hp2.x), 2) + Math.pow((cp.y - hp2.y), 2)) {
                        this.currentNode.setClient('drawIntersectionPoint1', true);
                    } else {
                        this.currentNode.setClient('drawIntersectionPoint2', true);
                    }
                } else {
                    // var line = this.network.getElementAt(e);
                    // if(line instanceof twaver.HorizontalLine){
                    //   var points = line.getPoints();
                    //   if(points.size() !== 2) return;
                    //   console.log(points);
                    // var ui = this.network.getElementUI(link);
                    // var points = ui.getLinkPoints();
                    // var cp = this.network.getLogicalPoint2(e);
                    // if (ui.getLineLength) {
                    //   lineLength = ui.getLineLength();
                    // } else {
                    //   lineLength = link.getLineLength();
                    // }
                    // var xOffset = Math.abs(cp.x - ui.getFromPoint().x)/lineLength;
                    // link.setClient('IntersectionPointOffset',xOffset);
                    // if (Math.abs(xOffset) > 0 && Math.abs(xOffset) < 1) {
                    //   xOffset *= lineLength;
                    // }
                    // var pointInfo = _twaver.math.calculatePointInfoAlongLine(points, true, xOffset, 0);
                    // var translatePoint = pointInfo.point;
                    // link.setClient('IntersectionPoint',translatePoint);
                    // this.lastNode = link;
                    // this.currentNode = link;
                    // }else{
                    //   this.lastNode && this.lastNode.setClient('IntersectionPoint',null);
                    // }
                    if (this.lastNode) {
                        var lastNode = this.lastNode;
                        lastNode.setClient('drawIntersectionPoint1', false);
                        lastNode.setClient('drawIntersectionPoint2', false);
                        lastNode.setClient('IntersectionPoint', null);
                    }
                }
            } else {
                node = this.getFromNode(e);
                if (this.currentNode !== node) {
                    this.currentNode = node;
                    if (node instanceof twaver.Node) {
                        this.lastNode = node;
                        if (!node.getClient('connectable')) return;
                        var nodeUI = this.network.getElementUI(node);
                        var hp1 = nodeUI._hotPoint1;
                        var hp2 = nodeUI._hotPoint2;
                        if (!hp1 || !hp2) return;
                        var cp = this.network.getLogicalPoint2(e);
                        if (Math.pow((cp.x - hp1.x), 2) + Math.pow((cp.y - hp1.y), 2) < Math.pow((cp.x - hp2.x), 2) + Math.pow((cp.y - hp2.y), 2)) {
                            node.setClient('drawIntersectionPoint1', true);
                        } else {
                            node.setClient('drawIntersectionPoint2', true);
                        }
                    } else {
                        if (this.lastNode) {
                            var lastNode = this.lastNode;
                            lastNode.setClient('drawIntersectionPoint1', false);
                            lastNode.setClient('drawIntersectionPoint2', false);
                        }
                    }
                }
            }
        },
        getNode: function (e, fromNode) {
            var node = this.network.getElementAt(e);
            if (node instanceof twaver.Node && this.network.isLinkable(node, fromNode) && this.network.getElementBox().getSelectionModel().isSelectable(node)) {
                return node;
            }
            return null;
        }
    });
    CircuitCreatePolyLineInteraction = function (network, typeOrLinkFunction) {
        CircuitCreatePolyLineInteraction.superClass.constructor.call(this, network, typeOrLinkFunction);
    }

    twaver.Util.ext("CircuitCreatePolyLineInteraction", twaver.vector.interaction.CreateShapeNodeInteraction, {
        handle_mousedown: function (e) {
            if (e.button !== 0) {
                return;
            }
            var point = this.network.getLogicalPoint2(e);
            if (!point) {
                return;
            }
            if (e.detail === 2 || e.timeStamp - this.timeStamp < 300) {
                if (this.points) {
                    var shapeNode = this.shapeNodeFunction(this.points);
                    this.network.addElementByInteraction(shapeNode);
                    this.clear();
                    var self = this;
                    setTimeout(function () {
                        self.network.setEditingElement(false);
                    }, 0);
                }
            } else {
                if (!this.network.isEditingElement()) {
                    this.network.setEditingElement(true);
                }
                if (!this.points) {
                    this.points = new twaver.List();
                }
                if (this.points.size() > 0) {
                    var lastPoint = this.points.get(this.points.size() - 1);
                    if (lastPoint.x === point.x && lastPoint.y === point.y) {
                        return;
                    }
                    if (Math.abs(point.x - lastPoint.x) >= Math.abs(point.y - lastPoint.y)) {
                        point.y = lastPoint.y;
                    } else {
                        point.x = lastPoint.x;
                    }
                }
                this.points.add(point);
            }
            this.timeStamp = e.timeStamp;
            this.repaint();
        },
        handle_mousemove: function (e) {
            if (this.points) {
                this.currentPoint = this.network.getLogicalPoint2(e);
                this.repaint();
            }
        }
    });

    /**
     * 电路面板编辑器
     * @param parentView {HTMLDIVElement} 父容器
     * @constructor
     */
    var CircuitEditor = function (parentView) {
        CircuitEditor.superClass.constructor.call(this, parentView);
        this.currentItem = null;

        /**
         * 背板
         * @type {null | twaver.Node}
         */
        this.parentNode = null;

        /**
         * 3d到2d模型转换
         * @type {Object}
         */
        this.model3dTo2dMapping = $consts.circuitEditorModel3dTo2dMapping;

        /**
         * 2d到3d模型转换
         * @type {Object}
         */
        this.model2dTo3dMapping = $consts.circuitEditorModel2dTo3dMapping;

        this.copyChildNode = null;
        this.lastSelectedChildNode = null;


        this._editable = false; //
        this.isAddChildNode = false;

        /**
         * 快捷复制键,默认c键
         * 选中一个节点,按住c键,会出现选中节点边框,点击可以快捷复制
         * @type {number}
         */
        this.KEY_CODE_COPY_ONE = 0;
        this.PANEL_CATEGORY = '设备面板';

        this.init();
    }

    CircuitEditor.prototype = {
        init: function () {

            var self = this;

            //create left menu
            this.accordionPane = new doodle.AccordionPane();

            //create network2d
            this.network2dView = this._initNetwork2d();

            this.network2d.setMaxZoom(40);

            var sheet = this.sheet = new twaver.controls.PropertySheet(this.box);
            $utils.initPropertySheet(sheet);
            var w = this.propertySheetBox.width();
            var h = this.propertySheetBox.height();
            sheet.adjustBounds({ x: 0, y: 0, width: w, height: h });

            this.propertySheetBox.append(this.sheet.getView());
            this.accordionPaneBox.append(this.accordionPane.getView());
            this.networkBox.append(this.network2dView);
            this.copyChildNode = this._createCopyChildNode();

            $(this.network2dView).on('mousemove', function (e) {
                //console.log(e);
                if (self.copyChildNode) {
                    var endPoint = self.network2d.getLogicalPoint(e);
                    self.copyChildNode.setCenterLocation(endPoint);
                }
            });

            $(document).on('keyup', function (e) {
                //console.log(e, e.keyCode);
                if (e.keyCode == self.KEY_CODE_COPY_ONE && self.box.contains(self.copyChildNode)) { //ctrl key   copy node end
                    self.box.remove(self.copyChildNode)
                }
            });

            $(this.network2dView).on('keydown', function (e) {
                //console.log(e, e.keyCode);
                if (e.keyCode == 32) { //空格 旋转
                    var node = self.box.getSelectionModel().getLastData();
                    if (!node) {
                        return;
                    }
                    var angle = node.getAngle();
                    node.setAngle(angle + 90);
                } else if (e.keyCode == self.KEY_CODE_COPY_ONE && self.lastSelectedChildNode && !self.box.contains(self.copyChildNode)) { //ctrl key  copy node start
                    var size = self.lastSelectedChildNode.getSize();
                    var angle = self.lastSelectedChildNode.getAngle();
                    self.copyChildNode.setSize(size);
                    self.copyChildNode.setAngle(angle);
                    self.copyChildNode.setClient('id', self.lastSelectedChildNode.getClient('id'));
                    self.box.add(self.copyChildNode);
                } else if (e.keyCode == 8) { //delete node
                    e.preventDefault();
                }
            });

            $(this.network2dView).on('dblclick', function (e) {
                //console.log(e);
                self.network2d.setDefaultInteractions();
            });
            $(this.network2dView).on('click', function (e) {
                //console.log(e);
                if (self.box.contains(self.copyChildNode)) { //copy node start
                    var id = self.copyChildNode.getClient('id');
                    var endPoint = self.network2d.getLogicalPoint(e);
                    var size = self.copyChildNode.getSize();
                    var angle = self.copyChildNode.getAngle();
                    var args = {
                        centerLocation: { x: endPoint.x, y: endPoint.y },
                        width: size.width,
                        height: size.height,
                        angle: angle,
                    };
                    self.loadChild(id, args);
                    e.preventDefault();
                    return false;
                }
            });

            this.refreshAccordion();
        },

        _initNetwork2d: function () {

            var self = this;
            var network2d = this.network2d = new nsp.edit.GridNetwork();
            this.network2d.setPositionMagneticX(5);
            this.network2d.setPositionMagneticY(5);
            this.network2d.setWheelToZoom(false);
            this.network2d.setPositionMagneticEnabled(false);
            //this.network2d.setDragToPan(false);

            //this.network2d.setInteractions([
            //    new twaver.vector.interaction.DefaultInteraction(network2d),
            //    //new twaver.vector.interaction.EditInteraction(network2d),
            //]);
            this.network2d.setEditableFunction(function (e) {

                //if (!self._editable) {
                //    return false;
                //}
                //var data = self.selectionModel.getSelection();
                //if (data && data.size() > 1) {
                //    return false;
                //}
                return (!self.isHost(e) && self.copyChildNode != e) || self.isResizeable(e);
            })

            var box = this.box = this.network2d.getElementBox();

            var selectionModel = this.selectionModel = this.box.getSelectionModel()
                //selectionModel.setSelectionMode('singleSelection');
            selectionModel.addSelectionChangeListener(function (e) {
                //console.log('kind:' + e.kind + ',datas:' + e.datas.toString());
                clearTimeout(self.selectionChangeHandleTimer);
                self.selectionChangeHandleTimer = setTimeout(function () {
                    self._resetPropertySheet();
                    self.lastSelectedChildNode = null;
                    var node = selectionModel.getLastData();
                    if (node && !self.isHost(node)) {
                        self.lastSelectedChildNode = node;
                    }
                    if (self.parentNode) {
                        if (self.network2d.isSelected(self.parentNode)) {
                            self.parentNode.setStyle('whole.alpha', 1);
                        } else if (selectionModel.size() > 0) {
                            self.parentNode.setStyle('whole.alpha', 0.3);
                        } else {
                            self.parentNode.setStyle('whole.alpha', 1);
                        }
                    }
                    self.network2d.invalidate();
                }, 100);
            });
            selectionModel.setFilterFunction(function (element) {
                return self.isEditable(element);
            });
            var layerBox = box.getLayerBox();
            var parentLayer = this.parentLayer = new twaver.Layer('parentLayer');
            var childrenLayer = this.childrenLayer = new twaver.Layer('childrenLayer');
            layerBox.add(parentLayer);
            layerBox.add(childrenLayer);
            layerBox.moveToTop(parentLayer);

            var view = this.network2d.getView();
            DragAndDrop.setDropTarget(view, {
                self: this,
                dropEffect: 'copy',
                ondrop: function (e, data) {

                    data = JSON.parse(data);
                    var id = data.id;

                    //判断是否需要单独处理
                    if (self.onDropHandler && self.onDropHandler(e, data, box, network2d)) {
                        return;
                    }
                    //判断是否是拖拽的面板图,直接打开面板
                    var category = make.Default.getOtherParameter(id, 'category');
                    if (category == self.PANEL_CATEGORY) {
                        self.setData(make.Default.load(id));
                        return;
                    }
                    var endPoint = self.network2d.getLogicalPoint(e);
                    var host = make.Default.getOtherParameter(self.getEditId(id), 'host'); // 是否是host节点
                    var args = {
                        centerLocation: { x: endPoint.x, y: endPoint.y },
                    };
                    var node = null;
                    if (host) {
                        node = self.loadParent(id, args);
                        setTimeout(function () {
                            self.network2d.zoomOverview();
                        }, 100)
                    } else {
                        node = self.loadChild(id, args);
                    }
                    if (node) {
                        self.selectionModel.clearSelection();
                        self.selectionModel.setSelection(node);
                        self._resetPropertySheet();
                    }
                },
                ondragover: function (e) {

                },
                ondragleave: function (e) {

                }
            });

            var ruler = this.ruler = new nsp.edit.Ruler(this.network2d);

            ruler.getView().setAttribute('class', 'room-ruler');
            ruler.setShowGuides(false);
            ruler.setShowRuler(true);
            var rulerView = $(ruler.getView());
            return rulerView;
        },

        /**
         * drop handler
         * 如果返回true,终止默认编辑器的后续操作
         * @param e {DropEvent} drop事件
         * @param data {Object} drop的data
         * @param box {twaver.ElementBox} element box
         * @param network {twaver.vector.Network} network
         */
        onDropHandler: function (e, data, box, network) {
            var id = data.id;
            var interaction = make.Default.getOtherParameter(id, 'interaction');
            if (interaction === 'createPolyLink') {
                network.setInteractions([
                    new CircuitCreatePolyLineInteraction(network, function (points) {
                        var node = make.Default.load(id);
                        node.setPoints(points);
                        return node;
                    }),
                    new twaver.vector.interaction.DefaultInteraction(network)
                ]);
            } else if (interaction == 'createLink') {
                isFoleLink = false;
                network.setInteractions([
                    new CircuitCreateLinkInteraction(network, function (fromNode, toNode) {
                        var fcl = fromNode.getCenterLocation();
                        var tcl = toNode.getCenterLocation();
                        var fromPencent, toPencent;
                        var linkType = "arc";

                        if (toNode instanceof twaver.HorizontalLine) {
                            if (fromNode.hotPoint) {
                                if (fromNode.hotPoint.x > fcl.x) {
                                    fromPencent = [1, 0.5];
                                } else if (fromNode.hotPoint.x < fcl.x) {
                                    fromPencent = [0, 0.5];
                                } else {
                                    if (fromNode.hotPoint.y > fcl.y) {
                                        fromPencent = [0.5, 1];
                                        var controlPoint = { x: fromNode.hotPoint.x, y: fromNode.hotPoint.y + 30 };
                                    } else {
                                        fromPencent = [0.5, 0];
                                        var controlPoint = { x: fromNode.hotPoint.x, y: fromNode.hotPoint.y - 30 };
                                    }
                                }
                            } else {
                                fromPencent = [0.5, 0.5];
                            }

                            var link = make.Default.load({
                                id: id,
                                style: {
                                    'link.from.percent': fromPencent,
                                    'link.bundle.enable': false,
                                    'link.type': 'arc',
                                    'link.corner': 'none',
                                },
                                client: {
                                    'link.type': 'HorizontalLine',
                                    'fromControlPoint': controlPoint,
                                }
                            });
                            link.setFromNode(fromNode);
                            link.setToNode(toNode);
                            return link;
                        } else if (toNode instanceof twaver.VerticalLine) {
                            if (fromNode.hotPoint) {
                                if (fromNode.hotPoint.x > fcl.x) {
                                    fromPencent = [1, 0.5];
                                } else if (fromNode.hotPoint.x < fcl.x) {
                                    fromPencent = [0, 0.5];
                                } else {
                                    if (fromNode.hotPoint.y > fcl.y) {
                                        fromPencent = [0.5, 1];
                                    } else {
                                        fromPencent = [0.5, 0];
                                    }
                                }
                            } else {
                                fromPencent = [0.5, 0.5];
                            }

                            var link = make.Default.load({
                                id: id,
                                style: {
                                    'link.from.percent': fromPencent,
                                    'link.bundle.enable': false,
                                    'link.type': 'arc',
                                    'link.corner': 'none',
                                },
                                client: {
                                    'link.type': 'VerticalLine',
                                }
                            });
                            link.setFromNode(fromNode);
                            link.setToNode(toNode);
                            return link;
                        }

                        if (fromNode.hotPoint && toNode.hotPoint) {
                            if (fromNode.hotPoint.x > fcl.x && toNode.hotPoint.x < tcl.x) {
                                linkType = "orthogonal.horizontal"
                            } else if (fromNode.hotPoint.x > fcl.x && toNode.hotPoint.x > tcl.x) {
                                linkType = "extend.right";
                            } else if (fromNode.hotPoint.x > fcl.x) {
                                linkType = "orthogonal.H.V";
                            } else if (fromNode.hotPoint.x < fcl.x && toNode.hotPoint.x < tcl.x) {
                                linkType = "extend.left"
                            } else if (fromNode.hotPoint.x < fcl.x && toNode.hotPoint.x > tcl.x) {
                                linkType = "orthogonal.horizontal";
                            } else if (fromNode.hotPoint.x < fcl.x) {
                                linkType = "orthogonal.H.V";
                            } else if (fromNode.hotPoint.y > fcl.y && toNode.hotPoint.y < tcl.y) {
                                linkType = "orthogonal.vertical";
                            } else if (fromNode.hotPoint.y > fcl.y && toNode.hotPoint.y > tcl.y) {
                                linkType = "extend.bottom";
                            } else if (fromNode.hotPoint.y > fcl.y) {
                                linkType = "orthogonal.V.H";
                            } else if (fromNode.hotPoint.y < fcl.y && toNode.hotPoint.y < tcl.y) {
                                linkType = "extend.top";
                            } else if (fromNode.hotPoint.y < fcl.y && toNode.hotPoint.y > tcl.y) {
                                linkType = "orthogonal.vertical";
                            } else if (fromNode.hotPoint.y < fcl.y) {
                                linkType = "orthogonal.V.H";
                            }
                        } else {
                            return;
                        }
                        var link = make.Default.load({
                            id: id,
                            style: {
                                'link.type': linkType,
                                'link.corner': 'none',
                            }
                        });
                        link.setFromNode(fromNode);
                        link.setToNode(toNode);
                        return link;
                    }),
                    new twaver.vector.interaction.DefaultInteraction(network),
                ]);
                return true;
            }
        },
        getEditId: function (id) {
            return $utils.getDeviceEditorModel2dId(id);
        },
        isEditable: function (node) {

            if (node.getClient('editable') === true) {
                return true;
            }
            return !this.isHost(node);
        },
        isHost: function (node) {
            return !!node.getClient('host')
        },
        isResizeable: function (node) {
            return !!node.getClient('resizeable');
        },
        _createCopyChildNode: function () {
            var node = new twaver.Node();
            node.setLayerId(this.childrenLayer.getId());
            node.setStyle('body.type', 'vector');
            node.setStyle('vector.shape', 'rectangle');
            node.setStyle('vector.fill', false);
            node.setStyle('vector.outline.width', 2);
            node.setStyle('vector.outline.color', '#a0a819');
            return node;
        },

        /**
         * load children
         * @param children {twaver.Node}
         * @returns {Array}
         */
        loadChildren: function (children) {
            var result = [];
            var self = this;
            var linkArray = []
            if (children instanceof Array) {
                children.forEach(function (child) {
                    if (make.Default.getOtherParameter(child.id, 'link')) {
                        linkArray.push(child);
                    } else {
                        var node = self.loadChild(child.id, child);
                        result.push(node);
                    }

                });
                linkArray.forEach(function (child) {
                    var link = self.loadChild(child.id, child);
                    result.push(link);
                });
            } else {
                var node = self.loadChild(children.id, children);
                result.push(node);
            }
            return result;
        },

        /**
         * load child
         * @param modelClass {string} 模型id
         * @param args {Object} 模型参数
         * @returns {twaver.Node}
         */
        loadChild: function (modelClass, args) {

            if (!this.parentNode) {
                console.warn('parentNode is null');
            }
            var self = this;
            modelClass = modelClass.replace('.' + $consts.DEVICE_MODEL_SUFFIX, '');
            args.id = this.getEditId(modelClass);
            args.objectId = doodle.id();
            var data = make.Default.load(args);
            if (make.Default.getOtherParameter(args.id, 'link')) {
                var link = data;
                link.setFromNode(self.findByBID(args.from));
                link.setToNode(self.findByBID(args.to))
                self.box.add(link);
            } else if (data instanceof Array) {
                var nodes = data;
                nodes.forEach(function (node) {
                    node.setLayerId(self.childrenLayer.getId());
                    if (self.parentNode) {
                        node.setHost(self.parentNode);
                    }
                    self.box.add(node);
                })
            } else {
                var node = data;
                node.setLayerId(self.childrenLayer.getId());
                if (self.parentNode) {
                    node.setHost(self.parentNode);
                }
                self.box.add(node);
            }
            return node;
        },


        /**
         * 加载背板
         * @param modelClass {String} 背板模型ID
         * @param args {Object} 模版参数
         * @returns {twaver.Node} 返回背板节点
         */
        loadParent: function (modelClass, args) {

            modelClass = modelClass.replace('.' + $consts.DEVICE_MODEL_SUFFIX, '');
            args.id = this.getEditId(modelClass);
            args.objectId = doodle.id();
            this.box.clear();
            var node = make.Default.load(args);
            node.setLayerId(this.parentLayer.getId());
            //node.setEditable(false);
            this.box.add(node);
            node.setLocation(0, 0);
            node.setMovable(false);
            this.parentNode = node;
            return node;
        },

        /**
         * set data
         * the first item is must be parent if jsonArray have parent
         * 如果包含背板,第一个元素必须是背板
         * @param jsonArray {Object[]}
         */
        setData: function (jsonArray) {
            var self = this;
            var linkArray = [];
            for (var i = 0; i < jsonArray.length; i++) {
                var data = jsonArray[i];
                if (make.Default.getOtherParameter(data.id, 'link')) {
                    linkArray.push(data);
                } else if (i == 0 && make.Default.getOtherParameter(data.id, 'host')) {
                    self.loadParent(data.id, data);
                } else {
                    self.loadChild(data.id, data);
                }
            }
            linkArray.forEach(function (data) {
                self.loadChild(data.id, data);
            })
        },

        _resetPropertySheet: function () {

            if (!this.isPropertySheetVisible()) {
                return;
            }
            var self = this;
            var propBox = self.sheet.getPropertyBox();
            propBox.clear();
            var selection = this.box.getSelectionModel();
            if (selection.size() != 1) {
                propBox.clear();
                this.propertySheetBox.hide();
            } else {
                this.propertySheetBox.show();
                var node = selection.getLastData();

                if (!make.Default.getId(node)) return;

                $utils.addProperties(propBox, make.Default.getModelDefaultParameterProperties(make.Default.getId(node)));
                self.resetPropertySheetBoxSize(this.sheet);
            }
        },


        /**
         * align selected data
         * 对齐选中的元素
         * @param type{string} 枚举[left, right, top, bottom, center, middle]
         */
        align: function (type) {
            var self = this;
            if (!type) {
                return;
            }
            var data = this.selectionModel.getSelection();

            //去除选中的parent
            var list = new twaver.List();
            data.forEach(function (node) {
                if (node && !self.isHost(node)) {
                    list.add(node);
                }
            })
            if (!list || list.size() < 2) {
                return;
            }
            make.Default.align(list, type);
        },

        /**
         * flow selected data
         * 均匀分布选中的元素
         * @param type {string} 枚举[hor, ver]
         * @param padding {number} 间距
         */
        flow: function (type, padding) {
            var self = this;
            if (!type) {
                return;
            }
            var data = this.selectionModel.getSelection();
            //去除选中的parent
            var list = new twaver.List();
            data.forEach(function (node) {
                if (node && !self.isHost(node)) {
                    list.add(node);
                }
            })
            if (!list || list.size() < 2) {
                return;
            }
            make.Default.flow(list, type, padding);
        },

        /**
         * 视图总览
         */
        zoomOverview: function () {
            this.network2d.zoomOverview();
        },

        /**
         * 切换编辑模式,是否允许鼠标拖拽编辑
         * @param newValue {boolean} true 允许鼠标编辑, false 禁止编辑
         */
        setMouseEditable: function (newValue) {

            var oldValue = this._editable;
            if (oldValue != newValue) {
                this._editable = newValue;
                if (this._editable) {
                    this.network2d.setInteractions([
                        new twaver.vector.interaction.DefaultInteraction(this.network2d),
                        new twaver.vector.interaction.EditInteraction(this.network2d),
                    ]);
                } else {
                    this.network2d.setInteractions([
                        new twaver.vector.interaction.DefaultInteraction(this.network2d),
                    ]);
                }
            }
        },

        /**
         * 切换鼠标拖动拖放,
         * @param status {boolean} true 整个画布拖动 , false 单个元素拖动
         */
        setDragToPan: function (status) {
            this.network2d.setDragToPan(status);
        },

        /**
         * 取得编辑结果
         * @param relative {boolean} 是否按相对坐标位置导出, true 以所有元素的最左上角为起点, false 导出绝对坐标
         * @returns {Array}
         */
        getData: function (relative) {

            var result = [];
            var parentObjectId = null;
            if (this.parentNode) {
                parentObjectId = this.parentNode.getId();
            }

            var self = this;
            var x = 0,
                y = 0;
            if (relative) {
                x = 9999999999;
                y = 9999999999;
                this.box.forEach(function (data) {

                    x = Math.min(x, data.getX());
                    y = Math.min(y, data.getY());
                });
            }
            this.box.forEach(function (data) {

                if (data == self.parentNode) {
                    var json = make.Default.toJson(data, function (d) {
                        d.x = d.x || 0;
                        d.y = d.y || 0;
                        d.x -= x;
                        d.y -= y;
                        return d;
                    })
                    result.splice(0, 0, json);
                } else {
                    var json = make.Default.toJson(data, function (d) {
                        //d.id = $utils.getDeviceEditorModel3dId(d.id);
                        d.x -= x;
                        d.y -= y;
                        d.parentObjectId = parentObjectId;
                        return d;
                    })
                    result.push(json);
                }
            });
            return result;
        },
        appendData: function (data) {
            this.loadChildren(data)
        },
        removeData: function (data) {
            var self = this;

            if (data instanceof Array) {
                return data.map(function (item) {
                    return self.box.removeById(item.objectId)
                })
            } else {
                return self.box.removeById(data.objectId)
            }
        },
        getSelectedData: function () {

            var self = this;
            var copyNodes = [];
            var nodes = this.selectionModel.getSelection().toList();
            if (nodes && nodes.size() > 0) {

                nodes.forEach(function (node) {
                    if (self.isHost(node)) {
                        return;
                    }
                    var json = make.Default.toJson(node, function (d) {
                        return d;
                    })
                    copyNodes.push(json);
                })
            }
            return copyNodes;
        },
        /**
         * refresh accordion
         * 刷新左侧组件栏, 默认是调用doodle.utils.load2dSceneCategory()的结果
         * @param categories {Object[]} default is the result of calling function doodle.utils.load2dDeviceCategory()
         */
        refreshAccordion: function (categories) {
            categories = categories || doodle.utils.load2dCircuitCategory();
            this.accordionPane.setCategories(categories);
        },
        pasteSelection: function (offset) {
            //console.warn('this method[{}] is not supported'.format('pasteSelection'))
            var self = this;
            if (!this._copyAnchor || this._copyAnchor.length == 0) {
                return null;
            }
            offset = offset || this._getPasteOffset();
            this._copyAnchor.forEach(function (data) {
                var item = $utils.clone(data);
                item.objectId = doodle.id();
                if (item.position) {
                    var position = item.position;
                    item.position = [position[0] + offset.x, position[1] + offset.y, position[2] + offset.z];
                }
                if (item.location) {
                    var location = item.location;
                    if (location instanceof Array) {
                        item.location = [position[0] + offset.x, position[1] + offset.z];
                    } else {
                        item.location.x += offset.x;
                        item.location.y += offset.z;
                    }
                }
                if (item.x) {
                    item.x += offset.x;
                }
                if (item.y) {
                    item.y += offset.z;
                }
                if (item.points) {
                    item.points._as.forEach(function (p) {
                        p.x += offset.x;
                        p.y += offset.z;
                    });
                }
                self.appendData(item);
            })
        },
    }

    doodle.CircuitEditor = CircuitEditor;
    doodle.utils.ext(CircuitEditor, Editor)





















    /**
     * 3D模型编辑器
     * @param parentView {HTMLDIVElement} 父容器
     * @constructor
     */
    var ModelEditor = function (parentView) {

        ModelEditor.superClass.constructor.call(this, parentView);

        this.jsonObj = null;
        this._modelChangeDispatcher = new mono.EventDispatcher();
        this._modelPropertyChangeDispatcher = new mono.EventDispatcher();

        this._currentModel = null;

        this.refreshAccordion();
    }

    ModelEditor.prototype = {
        _init: function () {
            var self = this;
            this.accordionPane = new doodle.AccordionPane();
            //create property sheet
            this.propertySheetPane = new nsp.edit.PropertySheetPane(this.box);
            //create network3d
            this.network3dView = this._initNetwork3d();
            //create container, add all components into the container

            this.accordionPaneBox.append(this.accordionPane.getView());
            this.propertySheetBox.append(this.propertySheetPane.getView());
            this.networkBox.append(this.network3dView);
            this.addPropertySheetListener();
            this.adjustNetwork3dBoundingBox();
        },
        parentResizeHandle: function () {
            ModelEditor.superClass.parentResizeHandle.call(this);
            this.invalidate();
        },
        addPropertySheetListener: function () {
            var box = this.propertySheetPane.box;
            box.addDataPropertyChangeListener(this._handleSheetPropertyChanged, this);
        },

        /**
         * 取的编辑的结果
         * @private
         * @returns {Object}
         */
        getJsonObject: function () {
            var result = {};
            var jsonObj = this.propertySheetPane.getData();
            return jsonObj;
        },
        setElement: function (data) {
            this.propertySheetPane.setElement(data);

            if (!this.isPropertySheetVisible()) {
                return;
            }
            this.propertySheetBox.show();
            this.resetPropertySheetBoxSize(this.propertySheetPane.sheet);
        },

        /**
         * 导入数据
         * @private
         * @param data {Object}
         */
        importJsonObject: function (data) {

            data.objectId = data.objectId || doodle.id();
            var box = this.network3d.getDataBox();
            box.clear();
            var rack = make.Default.load(data);
            box.addByDescendant(rack);
            this.setElement(data);
        },
        _handleSheetPropertyChanged: function (e) {
            if (!this.propertySheetPane._setValued) {
                return;
            }
            var jsonObj = this.propertySheetPane.getData();
            var rack = make.Default.load(jsonObj);
            this.network3d.getDataBox().clear();
            this.network3d.getDataBox().addByDescendant(rack);
            this._currentModel = rack;
            this.fireModelPropertyChange(rack, e.property, e.oldValue, e.newValue);
        },
        _initNetwork3d: function () {
            var network3d = this.network3d = new mono.Network3D();
            var camera = new mono.PerspectiveCamera(30, 1.5, 50, 5000);
            network3d.setCamera(camera);
            network3d.setClearColor('#000000');
            network3d.setClearAlpha(0);
            network3d.setBackgroundImage('./images/bg_network.jpg')
                // network3d.setShowAxis(true);
            camera.p(107, 156, 609);
            camera.look(new mono.Vec3(0, 0, 0));

            var interaction = network3d.getDefaultInteraction();
            interaction.yLowerLimitAngle = Math.PI / 180 * 2;
            interaction.yUpLimitAngle = Math.PI / 2;
            interaction.maxDistance = 1000;
            interaction.minDistance = 100;
            interaction.zoomSpeed = 3;
            interaction.panSpeed = 0.2;
            network3d.setInteractions([interaction]);

            var box = this.box = network3d.getDataBox();
            var pointLight = new mono.PointLight(0xFFFFFF, 0.1);
            pointLight.setPosition(1000, 1000, 1000);
            box.add(pointLight);

            box.add(new mono.AmbientLight('white'));

            network3d.getRootView().setAttribute('class', 'network3d-view');
            //network3d.getRootView().style.setProperty('left', '202px');
            var self = this;

            network3d.getRootView().addEventListener('dblclick', function (e) {
                self._handleDoubleClick(e, network3d);
            });

            DragAndDrop.setDropTarget(network3d.getRootView(), {
                self: this,
                ondrop: function (e, data) {

                    //判断是否需要单独处理
                    if (self.onDropHandler && self.onDropHandler(e, data, box, network3d)) {
                        return;
                    }
                    box.clear();
                    var json = JSON.parse(data);
                    json.objectId = json.objectId || doodle.id();
                    var rack = make.Default.load(json);
                    box.addByDescendant(rack);
                    // $utils.animateCamera(camera, interaction, oldTarget, newTarget);
                    mono.Utils.playCameraAnimation(camera, new mono.Vec3(107, 156, 609), new mono.Vec3(0, 0, 0), 1000);

                    self.setElement(json);

                    rack.setClient('data', data); // TODO 把相关的参数传递
                    self.fireModelChange(self._currentModel, rack);
                    self._currentModel = rack;

                }
            });
            return network3d.getRootView();
        },

        /**
         * drop handler
         * 如果返回true,终止默认编辑器的后续操作
         * @param e {DropEvent} drop事件
         * @param data {Object} drop的data
         * @param box {twaver.ElementBox} element box
         * @param network {twaver.vector.Network} network
         */
        onDropHandler: function (e, data, box, network) {

        },

        adjustNetwork3dBoundingBox: function () {
            //mono.Utils.autoAdjustNetworkBounds(this.network3d, this.contentPane, 'clientWidth', 'clientHeight', 0, 0);
            //var left = this.isAccordionVisible() ? 200 : 0;
            //this.network3d.adjustBounds(this.contentPane.clientWidth - left, this.contentPane.clientHeight)
            mono.Utils.autoAdjustNetworkBounds(this.network3d, this.networkBox[0], 'clientWidth', 'clientHeight', 0, 0);
        },

        fireModelChange: function (oldModel, newModel) {
            this._modelChangeDispatcher.fire({
                source: this,
                oldValue: oldModel,
                newValue: newModel,
            });
        },

        fireModelPropertyChange: function (source, property, oldValue, newValue) {
            this._modelPropertyChangeDispatcher.fire({
                source: source,
                property: property,
                oldValue: oldValue,
                newValue: newValue,
            });
        },

        addModelChangeListener: function (listener, scope, ahead) {
            this._modelChangeDispatcher.add(listener, scope, ahead);
        },

        removeModelChangeListener: function (listener, scope) {
            this._modelChangeDispatcher.remove(listener, scope);
        },

        addModelPropertyChangeListener: function (listener, scope, ahead) {
            this._modelPropertyChangeDispatcher.add(listener, scope, ahead);
        },

        removeModelPropertyChangeListener: function (listener, scope) {
            this._modelPropertyChangeDispatcher.remove(listener, scope);
        },

        _handleDoubleClick: function (e, network) {
            var self = this;
            var camera = network.getCamera();
            var interaction = network.getDefaultInteraction();
            var firstClickObject = $utils.findFirstObjectByMouse(network, e);
            if (firstClickObject) {
                var element = firstClickObject.element;
                var newTarget = firstClickObject.point;
                var oldTarget = camera.getTarget();
                if (element.getClient('animation')) {
                    make.Default.playAnimation(element, element.getClient('animation'));
                } else {
                    $utils.animateCamera(camera, interaction, oldTarget, newTarget);
                }

            } else {
                var oldTarget = camera.getTarget();
                var newTarget = new mono.Vec3(0, 0, 0);
                $utils.animateCamera(camera, interaction, oldTarget, newTarget);
            }
        },

        /**
         * refresh accordion
         * 刷新左侧组件栏, 默认是调用doodle.utils.load2dSceneCategory()的结果
         * @param categories {Object[]} default is the result of calling function doodle.utils.load3dModelCategory()
         */
        refreshAccordion: function (categories) {
            categories = categories || doodle.utils.load3dModelCategory();
            this.accordionPane.setCategories(categories);
        },

        invalidate: function () {
            this.adjustNetwork3dBoundingBox();
        },

        /**
         * 取得当前的3d对象
         * @returns {null|mono.Data}
         */
        getCurrentModel: function () {
            return this._currentModel;
        },
        getData: function () {
            var data = this.getJsonObject();
            if (!data) {
                return null;
            }
            return data;
        },
        setData: function (data) {
            if (data instanceof Array) {
                this.importJsonObject(data[0])
            } else {
                this.importJsonObject(data);
            }
        },
        getSelectedData: function () {
            throw 'not support this function[{}]'.format('getSelectedData')
        },
        appendData: function () {
            throw 'not support this function[{}]'.format('appendData')
        },
        copySelection: function () {
            throw 'not support this function[{}]'.format('copySelection')
        },
        pasteSelection: function () {
            throw 'not support this function[{}]'.format('pasteSelection')
        }

    }

    doodle.ModelEditor = ModelEditor;
    doodle.utils.ext(ModelEditor, Editor)
        /**
         * 机架编辑器, 目前只支持标准设备(高度是整数U), 2D和3D模型默认的映射关系是".front", 详细见dodle.consts和doodl.utils
         * 有两种方式使用机柜编辑器
         * 1 拖拽机柜,填充里面的设备
         * 2 已经存在机柜, 填充里面的设备
         * @param parentView {HTMLDIVElement} 编辑器父容器
         * @param modelClass {String} 默认的机柜类型
         * @param objectId {String} 默认的机柜实例的ID
         * @constructor
         */
    var RackEditor = function (parentView, modelClass, objectId) {

        RackEditor.superClass.constructor.call(this, parentView);

        /**
         * 默认的机柜类型
         * @type {String}
         */
        this.modelClass = modelClass;

        /**
         * 默认的机柜实例ID
         * @type {String}
         */
        this.objectId = objectId || doodle.id();

        /**
         * 机柜节点
         * @type {twaver.Node}
         */
        this.parentNode = null;
        this.dragNode = null;
        this.currentItem = null;

        /**
         * 3d到2d模型映射
         * @type {Object}
         */
        this.model3dTo2dMapping = $consts.rackEditorModel3dTo2dMapping;

        /**
         * 2d到3d模型的映射
         * @type {Object}
         */
        this.model2dTo3dMapping = $consts.rackEditorModel2dTo3dMapping;

        this.unitHeight = make.Default.getUnitHeight() || 1;
        this.offsetX = 0;
        this.offsetY = 0;
        this.isSettingLocation = false; //
        this.isAddChildNode = false;
        this.DEVICE_PATTEN = '设备模板';
        this.RACK_PATTEN = '机柜模板';

        /**
         * component bar
         * 左侧组件栏
         * @type {doodle.AccordionPane}
         */
        this.accordionPane = new doodle.AccordionPane();
        this.init();
    }

    RackEditor.prototype = {
        init: function () {

            var self = this;


            this.accordionPane.ondrag = function (e, item) {
                self.onDragHandler(e, item);
            }

            //create network2d
            this.network2dView = this._initNetwork2d();

            this.network2d.setMaxZoom(15);

            var sheet = this.sheet = new twaver.controls.PropertySheet(this.box);
            $utils.initPropertySheet(sheet);
            var w = this.propertySheetBox.width();
            var h = this.propertySheetBox.height();
            sheet.adjustBounds({ x: 0, y: 0, width: w, height: h });
            this.propertySheetBox.append(this.sheet.getView());

            this.accordionPaneBox.append(this.accordionPane.getView());

            this.networkBox.append(this.network2dView);

            $(this.network2dView).on('keydown', function (e) {
                //console.log(e, e.keyCode);
                if (e.keyCode == 8) { //delete node
                    e.preventDefault();
                }
            });

            this.refreshAccordion();
            if (this.modelClass) {
                this.loadParent(this.modelClass);
            }
        },

        _initNetwork2d: function () {

            var self = this;

            /**
             * network2d
             * @type {nsp.edit.GridNetwork}
             */
            var network2d = this.network2d = new nsp.edit.GridNetwork();
            this.network2d.setPositionMagneticEnabled();
            //this.network2d.setDragToPan(false);


            var box = this.box = this.network2d.getElementBox();

            this._setChildPositionMagnetic(box);

            var selectionModel = this.selectionModel = this.box.getSelectionModel()
            selectionModel.setSelectionMode('singleSelection');
            selectionModel.addSelectionChangeListener(function (e) {
                //console.log(e);
                self._resetPropertySheet();
                self.resetNodeName();
            });
            selectionModel.setFilterFunction(function (element) {
                return element != self.parentNode;
            });
            var layerBox = box.getLayerBox();
            var parentLayer = this.parentLayer = new twaver.Layer('parentLayer');
            var childrenLayer = this.childrenLayer = new twaver.Layer('childrenLayer');
            layerBox.add(parentLayer);
            layerBox.add(childrenLayer);
            layerBox.moveToTop(parentLayer);

            var view = this.network2d.getView();
            DragAndDrop.setDropTarget(view, {
                self: this,
                dropEffect: 'copy',
                ondrop: function (e, data) {

                    //判断是否需要单独处理
                    if (self.onDropHandler && self.onDropHandler(e, data, box, network2d)) {
                        return;
                    }
                    data = JSON.parse(data);
                    if (self.isPatten(data.id)) {

                        var category = make.Default.getOtherParameter(data.id, 'category');
                        if (category == self.RACK_PATTEN) {

                            var info = make.Default.load(data.id);
                            self.loadParent(info.parent);
                            self.setData(info.data);
                            setTimeout(function () {
                                self.zoomOverview()
                            }, 100)
                        } else if (self.parentNode) {

                            var info = make.Default.load(data.id);
                            self.setData(info);
                        } else {
                            alert('add rack first')
                        }
                        return;
                    }
                    if (!self.dragNode) {
                        self.loadParent(data.id);
                        setTimeout(function () {
                            self.network2d.zoomOverview();
                        }, 100);
                    } else {

                        box.getSelectionModel().clearSelection();
                        box.getSelectionModel().appendSelection(self.dragNode);
                        self.dragNode.setStyle('whole.alpha', 1);
                        self._resetPropertySheet();
                        self.resetChildNodeLocation(self.dragNode);
                    }
                    if (self.dragNode) {
                        self.dragNode = null;
                        self.currentItem = null;
                    }

                },
                ondragover: function (e) {

                    e.dataTransfer.dropEffect = 'copy';

                    //console.log(self.currentItem);
                    //判断拖拽的是否是子节点
                    if (self.dragNode && !self.isHost(self.dragNode)) {
                        self.propertySheetBox.hide();
                        //判断是否有剩余空间可以放置
                        var size = self.getSize(self.dragNode);
                        if (!self.parentNode || !self._haveSpace(size, self.dragNode)) {
                            e.dataTransfer.dropEffect = 'none';
                            return;
                        }
                        //如果没有添加子节点,那么添加
                        if (!self.dragNode.isAddInBox) {
                            self.dragNode.isAddInBox = true;
                            self.dragNode.setStyle('whole.alpha', 0.7);
                            self._initChildNode(self.dragNode, childrenLayer);
                            box.add(self.dragNode);
                            self.box.getSelectionModel().clearSelection();
                            self.box.getSelectionModel().appendSelection(self.dragNode);
                        }
                        var endPoint = self.network2d.getLogicalPoint(e);
                        var tx = endPoint.x;
                        var ty = endPoint.y;
                        ty -= self.dragNode.getSize().height / 2;
                        endPoint = self.formatLocation(self.dragNode, tx, ty);
                        if (endPoint) {
                            self.dragNode.setLocation(endPoint.x, endPoint.y);
                        } else {
                            self.resetChildNodeLocation(self.dragNode);
                        }
                    }

                },
                ondragleave: function (e) {
                    if (self.dragNode) {
                        if (self.dragNode.isAddInBox) {
                            box.remove(self.dragNode);
                        }
                        self.dragNode = null;
                        self.currentItem = null;
                    }
                }
            });

            var ruler = this.ruler = new nsp.edit.Ruler(this.network2d);

            ruler.getView().setAttribute('class', 'room-ruler');
            ruler.setShowGuides(false);
            ruler.setShowRuler(true);
            var rulerView = $(ruler.getView());
            return rulerView;
        },

        /**
         * drop handler
         * 如果返回true,终止默认编辑器的后续操作
         * @param e {DropEvent} drop事件
         * @param data {Object} drop的data
         * @param box {twaver.ElementBox} element box
         * @param network {twaver.vector.Network} network
         */
        onDropHandler: function (e, data, box, network) {

        },

        onDragHandler: function (e, item) {
            var self = this;
            if (self.isPatten(item.id)) {
                return;
            }
            if (!self.currentItem) {
                var id = self.getEditId(item.id);
                if (make.Default.getOtherParameter(id, 'host')) {
                    return;
                }
                self.currentItem = item;
                self.dragNode = make.Default.load({
                    id: self.getEditId(item.id),
                    objectId: doodle.id()
                });
                self.dragNode.setClient('id', item.id);
            }
        },

        isPatten: function (id) {
            var category = make.Default.getOtherParameter(id, 'category');
            return category == this.DEVICE_PATTEN || category == this.RACK_PATTEN;
        },
        getEditId: function (id) {
            return $utils.getRackEditorModel2dId(id);
        },
        isHost: function (node) {
            return !!node.getClient('host')
        },
        getSize: function (node) {
            return node.getClient('size') || 1;
        },

        /**
         * set data
         * 设置机柜原有设备的数据
         * @param children {Object[]}
         */
        setData: function (children) {
            var self = this;
            children.forEach(function (child) {
                self.loadChild(child.id, child);
            });
        },
        /**
         * 取的编辑的结果
         * @returns {Array}
         */
        getData: function () {
            if (!this.parentNode) {
                return [];
            }
            var result = [];
            var parentObjectId = this.parentNode.getId();
            var self = this;
            this.box.forEach(function (data) {

                if (data != self.parentNode) {
                    var json = make.Default.toJson(data, function (d) {
                        d.id = $utils.getRackEditorModel3dId(d.id);
                        d.parentObjectId = parentObjectId;
                        return d;
                    })
                    result.push(json);
                }
            });
            return result;
        },
        appendData: function (data) {
            if (!this.parentNode) {
                throw 'rack is empty';
            }
            this.loadChild(data.id, data)
        },
        removeData: function (data) {
            var self = this;

            if (data instanceof Array) {
                return data.map(function (item) {
                    return self.box.removeById(item.objectId)
                })
            } else {
                return self.box.removeById(data.objectId)
            }
        },

        clear: function () {
            if (this.modelClass) {

                var self = this;
                var children = [];
                this.box.forEach(function (data) {

                    if (data != self.parentNode) {
                        children.push(data);
                    }
                });
                children.forEach(function (data) {
                    self.box.remove(data);
                })
            } else {
                this.box.clear();
            }
        },

        loadChild: function (modelClass, args) {
            args.id = this.getEditId(modelClass);
            var node = make.Default.load(args);
            if (!node) return; //这里会出现unknowid
            this._initChildNode(node, this.childrenLayer);
            this.isAddChildNode = true;
            this.box.add(node);
            this.resetChildNodeLocation(node);
            return node;
        },

        _initChildNode: function (node, layer) {
            var self = this;
            node.setLayerId(layer.getId());
            node.setHost(this.parentNode);
            var oldSetLocationFun = node.setLocation;
            node.originalSetLocation = oldSetLocationFun;
            node.setLocation = function (tx, ty) {
                var endPoint = self.formatLocation(node, tx, ty);
                if (endPoint) {
                    oldSetLocationFun.call(node, endPoint.x, endPoint.y);
                } else {
                    self.resetChildNodeLocation(node);
                }
            }

            var oldTranslate = node.translate;
            node.translate = function (ox, oy) {
                if (self.childNodeLiveMove) {
                    self.childNodeLastPointOffset.x += ox;
                    self.childNodeLastPointOffset.y += oy;
                    var tx = self.childNodeLastPoint.x + self.childNodeLastPointOffset.x;
                    var ty = self.childNodeLastPoint.y + self.childNodeLastPointOffset.y;
                    var endPoint = self.formatLocation(node, tx, ty);
                    if (endPoint) {
                        oldSetLocationFun.call(node, endPoint.x, endPoint.y);
                    } else {
                        self.resetChildNodeLocation(node);
                    }
                } else {
                    oldTranslate.call(node, ox, oy);
                }
            }
            return node;
        },

        /**
         * 加载机柜
         * @param modelClass {String} 机柜模型ID
         * @returns {*}
         */
        loadParent: function (modelClass) {

            var args = {
                id: this.getEditId(modelClass),
                objectId: this.objectId,
            };
            var node = make.Default.load(args);
            this._initParentNode(node, this.parentLayer);
            this.box.clear();
            this.box.add(node);
            node.setLocation(0, 0);
            this._resetPropertySheet();
            node.setMovable(false);
            this.parentNode = node;
            return node;
        },

        _initParentNode: function (node, layer) {
            //node.setStyle('select.style', null);
            node.setLayerId(layer.getId());
            this.offsetX = node.getClient('offsetX');
            this.offsetY = node.getClient('offsetY');
            this.childrenSize = node.getClient('childrenSize');
        },

        _findChildren: function () {

            return this.box.toDatas(function (node) {
                if (this.parentNode != node) {
                    return node;
                }
            }, this);
        },

        _isEmpty: function (loc, size, selfNode) {
            var list = this._findChildren();
            if (!list || list.size() == 0) {
                return true;
            }
            var childrenSize = this.parentNode.getClient('childrenSize');
            var count = list.size();
            var min = loc;
            var max = loc + size - 1;
            if (max > childrenSize - 1) {
                return false;
            }
            for (var i = 0; i < count; i++) {

                var node = list.get(i);
                if (selfNode == node) {
                    continue
                }
                var nodeSize = node.getClient('size');
                var nodeLoc = parseInt(node.getClient('loc')) - 1;
                var minTmp = nodeLoc;
                var maxTmp = nodeLoc + nodeSize - 1;
                if (!(min > maxTmp || max < minTmp)) {
                    return false;
                }
            }
            return true;
        },

        _haveSpace: function (size, selfNode) {
            var list = this._findChildren();
            if (!list || list.size() == 0) {
                return true;
            }
            var parentSize = this.parentNode.getClient('childrenSize') || 42;
            for (var i = 0; i <= parentSize - size; i++) {
                if (this._isEmpty(i, size, selfNode)) {
                    return true;
                }
            }
            return false;
        },

        _getNextLoc: function (size, selfNode) {
            if (this._haveSpace(size, selfNode)) {
                var childrenSize = this.parentNode.getClient('childrenSize');
                for (var i = 0; i < childrenSize; i++) {
                    if (this._isEmpty(i, size, selfNode)) {
                        return i;
                    }
                }
            }
            throw 'there have not enough space for ' + size + 'U  server'
        },

        _setChildPositionMagnetic: function (box) {

            var self = this;

            box.addDataPropertyChangeListener(function (e) {
                //console.log('DataPropertyChange:');
                //console.log(e);
                var property = e.property;
                var node = e.source;
                if (!node.getClient('host')) {
                    if (property == 'C:loc') {
                        node.eventType = 'loc';
                        self.changeChildNodeHandler(node, e)
                    } else if (property == 'location') {
                        if (self.isSettingLocation) {
                            self.isSettingLocation = false;
                        } else {
                            self.moveChildNodeHandler(node, e);
                        }
                    }
                } else if ($consts.HOST_EDITABLE) { //是否可以编辑父亲节点

                }

            });

            box.addDataBoxChangeListener(function (e) {
                //console.log(e);
                var kind = e.kind;
                var node = e.data;
                if (kind == 'add' && !node.getClient('host')) {
                    self.addChildNodeHandler(node, e);
                }
            });
            this.network2d.addInteractionListener(function (e) {

                //console.log(e);
                var node = self.box.getSelectionModel().getLastData();
                if (node && !node.getClient('host')) {

                    if (e.kind == 'liveMoveStart') { //开始移动
                        self.propertySheetBox.hide();
                        self.childNodeLiveMove = true;
                        self.childNodeLastPoint = node.getLocation();
                        self.childNodeLastPointOffset = { x: 0, y: 0 };
                        node.setStyle('whole.alpha', 0.5);
                    } else if (e.kind == 'liveMoveEnd') { //结束已动工
                        self.moveChildNodeEndHandler(node, e);
                        delete self.childNodeLiveMove;
                        delete self.childNodeLastPoint;
                        delete self.childNodeLastPointOffset;
                        node.setStyle('whole.alpha', 1);
                        self.propertySheetBox.show();
                    }
                }

            });
        },

        _getLoc: function (y, physical) {

            var childrenSize = this.parentNode.getClient('childrenSize');
            var parentLocation = this.parentNode.getLocation();
            var dy = childrenSize * this.unitHeight - (y - parentLocation.y - this.offsetY);
            var loc = Math.round(dy / this.unitHeight);
            if (!physical) {
                loc = Math.max(0, loc);
                loc = Math.min(childrenSize - 1, loc);
            }
            return loc;
        },
        formatLocation: function (node, tx, ty) {

            var parentLocation = this.parentNode.getLocation();
            //限定在父亲节点内
            var childrenSize = this.parentNode.getClient('childrenSize');
            ty = Math.max(parentLocation.y + this.offsetY, ty);
            ty = Math.min(parentLocation.y + this.offsetY + childrenSize * this.unitHeight - node.getSize().height, ty);
            var size = node.getClient('size');
            //取得loc值
            var loc = this._getLoc(ty + node.getSize().height);
            if (!this._isEmpty(loc, size, node)) {
                return null;
            }
            var parentLocation = this.parentNode.getLocation();
            var tx = parentLocation.x + this.offsetX;
            var ty = parentLocation.y + (childrenSize - 1 - loc + 1) * this.unitHeight + this.offsetY - node.getSize().height;
            return { x: tx, y: ty, loc: loc }
        },

        addChildNodeHandler: function (node) {

            if (this.isAddChildNode) {
                this.isAddChildNode = false;
                return;
            }
            var location = node.getLocation();
            var loc = this._getLoc(location.y + node.getSize().height);
            node.setClient('loc', loc - 1);
        },

        resetNodeName: function () {
            var self = this;
            this.box.forEach(function (node) {
                if (self.parentNode != node) {
                    node.setName(null);
                }
            });
            var node = this.selectionModel.getLastData();
            if (node && !this.isHost(node)) {
                node.setStyle('label.position', 'right.right');
                node.setStyle('label.xoffset', 10);
                //node.setStyle('label.font', '12px arial');
                var loc = parseInt(node.getClient('loc'));
                var size = parseInt(node.getClient('size'));
                var name = '' + (loc) + 'U - ' + (loc + size - 1) + 'U';
                node.setName(name);
            }

        },

        /*
         * 修改节点 修改loc
         * 这里目前存在一个不同的实现方式,修改loc时,如果修改失败,
         * 是否应该恢复到上一次的位置上,还是重新再找一个新的位置上
         */
        changeChildNodeHandler: function (node, e) {

            this.resetNodeName(node);
            if (this.eventType == 'moveChildNodeHandler-loc') {
                this.eventType = null;
                return;
            }
            var size = node.getClient('size');
            var loc = parseInt(e.newValue) - 1;
            //恢复上一次位置 or 重新找一个位置摆设
            if (!this._isEmpty(loc, size, node)) {
                loc = this._getNextLoc(size, node);
                node.setClient('loc', loc + 1);
            } else {
                var childrenSize = this.parentNode.getClient('childrenSize');
                var parentLocation = this.parentNode.getLocation();
                var tx = parentLocation.x + this.offsetX;
                var ty = parentLocation.y + (childrenSize - 1 - loc + 1) * this.unitHeight + this.offsetY - node.getSize().height;
                this.setChildNodeLocation(node, tx, ty);
            }
        },

        /*
         * 移动节点
         * 移动过程中只控制x方向坐标,y方向坐标不控制,移动结束时判断
         */
        moveChildNodeHandler: function (node, e) {

            if (this.eventType) {
                this.eventType = null;
                return;
            }
            var self = this;
            var size = node.getClient('size');
            var cy = null;
            if (e) {
                cy = parseFloat(e.newValue.y);
            } else {
                cy = node.getLocation().y;
            }
            var loc = this._getLoc(cy + node.getSize().height);
            //如果拖拽的位置是空,那么保存新的位置,否则回到上一次位置
            //如果将要拖到的下一个位置不为空,那么禁止拖放过去
            if (this._isEmpty(loc, size, node)) {


                var oldLoc = parseInt(node.getClient('loc')) - 1;
                if (oldLoc != loc) {
                    this.eventType = 'moveChildNodeHandler-loc';
                }
                node.setClient('loc', loc + 1);
            }

            //var tx = this.parentNode.getLocation().x + this.offsetX;
            //var ty = cy;
            //setTimeout(function () {
            //    self.setChildNodeLocation(node, tx, ty);
            //}, 0)

            setTimeout(function () {
                self.resetChildNodeLocation(node);
            }, 500)

        },

        moveChildNodeEndHandler: function (node, e) {
            this.resetChildNodeLocation(node);
        },

        setChildNodeLocation: function (node, tx, ty) {

            var childrenSize = this.parentNode.getClient('childrenSize');
            var oldLoc = node.getLocation();
            var parentLocation = this.parentNode.getLocation();
            ty = Math.max(parentLocation.y + this.offsetY, ty);
            ty = Math.min(parentLocation.y + this.offsetY + childrenSize * this.unitHeight - node.getSize().height, ty);
            if (oldLoc.x != tx || oldLoc.y != ty) {
                this.isSettingLocation = true;
                node.setLocation(tx, ty);
            }
        },

        /*
         * 初始化节点位置
         */
        resetChildNodeLocation: function (node) {

            var loc = parseInt(node.getClient('loc')) - 1;
            var childrenSize = this.parentNode.getClient('childrenSize');
            var parentLocation = this.parentNode.getLocation();
            var tx = parentLocation.x + this.offsetX;
            var ty = parentLocation.y + (childrenSize - 1 - loc + 1) * this.unitHeight + this.offsetY - node.getSize().height;
            var oldLoc = node.getLocation();
            if (oldLoc.x != tx || oldLoc.y != ty) {
                this.isSettingLocation = true;
                node.originalSetLocation(tx, ty);
            }
        },

        _resetPropertySheet: function () {

            if (!this.isPropertySheetVisible()) {
                return;
            }
            var self = this;
            var propBox = self.sheet.getPropertyBox();
            propBox.clear();
            var selection = this.box.getSelectionModel();
            if (selection.size() == 0) {
                propBox.clear();
                this.propertySheetBox.hide();
            } else {
                this.propertySheetBox.show();
                var node = selection.getLastData();
                $utils.addProperties(propBox, make.Default.getModelDefaultParameterProperties(make.Default.getId(node)));
                self.resetPropertySheetBoxSize(this.sheet);
            }
        },

        /**
         * 视图总览
         */
        zoomOverview: function () {
            this.network2d.zoomOverview();
        },

        /**
         * refresh accordion
         * 刷新左侧组件栏, 默认是调用doodle.utils.load2dSceneCategory()的结果
         * @param categories {Object[]} default is the result of calling function doodle.utils.load2dRackCategory()
         */
        refreshAccordion: function (categories) {
            categories = categories || doodle.utils.load2dRackCategory(!this.modelClass);
            this.accordionPane.setCategories(categories);
        }
    }

    doodle.RackEditor = RackEditor;
    doodle.utils.ext(RackEditor, Editor)

    var idcLayer = {
        'wall': 100,
        'area': 200,
        'innerWall': 300,
        'wallChild': 400,
        'innerWallChild': 500,
        'channel': 600,
        'rack': 700,
        'default': 800
    }
    nsp.edit.BoxBridge = function (box2d, jsonBox) {
        this.box2d = box2d;
        this.jsonBox = jsonBox;
        this.binded = false;

        /**
         * jsonObject.objectId 只想2D对象
         * @type {{}}
         */
        this.refMap2d = {};

        /**
         * 2d对象的id,指向jsonObject
         * @type {{}}
         */
        this.refMapJson = {};
        this.isAdjusting = false;
    };

    twaver.Util.ext(nsp.edit.BoxBridge, Object, {
        bind: function () {
            if (this.binded) {
                return;
            }

            this.box2d.addDataBoxChangeListener(this._handle2dBoxChange, this);
            this.box2d.addDataPropertyChangeListener(this._handle2dDataChange, this);
            this.jsonBox.addDataBoxChangeListener(this._handleJsonBoxChange, this);

            this.binded = true;
        },

        unbind: function () {
            this.box2d.removeDataBoxChangeListener(this._handle2dBoxChange, this);
            this.box2d.removeDataPropertyChangeListener(this._handle2dDataChange, this);

            this.jsonBox.removeDataBoxChangeListener(this._handleJsonBoxChange, this);
            this.binded = false;
        },

        synchronizeFilter: function (node2d, jsonObject) {
            return true;
        },

        /**
         * 通过2dbox的data 生成jsonObject
         * @param data2d twaver.Node对象
         * @returns {nsp.edit.data.JsonObject}
         * @private
         */
        _getJsonData: function (data2d) {
            var node = new nsp.edit.data.JsonObject({ "objectId": data2d.getId() });
            var radius = data2d.getClient('radius');
            var centerLocation = data2d.getCenterLocation();
            var angle = data2d.getAngle();
            var id = $utils.getSceneEditorModel3dId(data2d.getClient('id'));
            var points = data2d.getPoints && data2d.getPoints();
            var name = data2d.getClient('objName');
            var width = data2d.getClient('wallWidth') || data2d.getWidth();
            var depth = data2d.getHeight();
            var height = data2d.getClient('height');
            var positionY = data2d.getClient('positionY');
            var label = data2d.getClient('label');
            var bid = data2d.getClient('bid');
            var closed = data2d.getClient('closed');
            var showFloor = data2d.getClient('showFloor');
            var wallHeight = data2d.getClient('wallHeight');

            var parentId = null;
            if (data2d.getParent()) {
                parentId = data2d.getParent();
            }
            node.setParentId(parentId);
            var pointsY = data2d.getClient('pointsY');
            var clientMap = {};

            if (radius) {
                node.setRadius(radius);
            }
            if (centerLocation) {
                node.setPosition([centerLocation.x, 0, centerLocation.y]);
            }
            if (angle) {
                node.setRotation([0, angle, 0]);
            }
            if (id) {
                node.id = id;
            }
            if (name) {
                node.setName(name);
            }
            if (width) {
                node.setWidth(width);
            }
            if (depth) {
                node.setDepth(depth);
            }
            if (height) {
                node.setHeight(height);
            }
            if (closed) {
                node.setClosed(true);
            }
            if (showFloor) {
                node.setShowFloor(true);
            }
            if (wallHeight) {
                node.setWallHeight(wallHeight);
            }
            if (positionY) {
                var position = node.getPosition() || [0, 0, 0];
                node.setPosition(position[0], positionY, position[2]);
            }
            if (points != null && points.size() > 0) {
                var data = [];
                for (var i = 0; i < points.size(); i++) {
                    if (pointsY) {
                        data.push([points.get(i).x - centerLocation.x, points[i] || 20, points.get(i).y - centerLocation.y]);
                    } else {
                        data.push([points.get(i).x - centerLocation.x, points.get(i).y - centerLocation.y]);
                    }
                }
                node.setData(data);
            }
            if (label) {
                clientMap['label'] = label;
            }
            if (bid) {
                clientMap['bid'] = bid;
            }
            node.setClient(clientMap);

            return node;
        },

        /**
         * 通过2d data 生成jsonData
         * 2d的box抛出add事件时执行
         * @param data
         * @private
         */
        _addJsonData: function (data) {
            if (this.synchronizeFilter(data, null)) {
                if (this.box2d.contains(data)) {
                    var node = this._getJsonData(data);
                    this.jsonBox.add(node);
                    this.refMapJson[data.getId()] = node;
                }
            }
        },

        //通过2d Data删除jsondata
        _removeJsonData: function (data) {
            if (data != null) {
                this.jsonBox.removeById(data.getId());
                delete this.refMapJson[data.getId()];
            }
            var type = data.getClient('type');
            if (type == 'door' || type == 'window') {
                var objectId = data.getId();
                for (var i in this.refMapJson) {
                    if (this.refMapJson[i]) {
                        var children = this.refMapJson[i].getChildren();
                        if (children && children.length > 0) {
                            for (var j = 0; j < children.length; j++) {
                                if (children[j].getObjectId() == objectId) {
                                    this.refMapJson[i].getChildren().splice(children.indexOf(children[j]), 1);
                                    console.log(this.refMapJson[i]);
                                }
                            }
                        }
                    }
                }
            }

        },

        _handle2dBoxChange: function (e) {
            if (this.isAdjusting) {
                return;
            }
            this.isAdjusting = true;
            var data = e.data;
            var kind = e.kind;
            if (kind == 'add') {
                this._addJsonData(data);
                this.resetParentAndChildren(data);
            } else if (kind == 'remove') {
                this._removeJsonData(data);
            } else if (kind == 'clear') {
                this.jsonBox.clear();
                this.refMapJson = {};
                this.refMap2d = {};
            }
            this.isAdjusting = false;
        },

        /**
         * 2D 对象属性变化
         * FIXME 需要处理好父子关系.
         * @param e
         * @private
         */
        _handle2dDataChange: function (e) {

            var self = this;
            if (this.isAdjusting) {
                return;
            }
            this.isAdjusting = true;
            var data = e.source,
                newValue = e.newValue,
                oldValue = e.oldValue,
                property = e.property;


            if (data.getParent() && (data.getClient('type') == "door" || data.getClient('type') == "window")) {
                var jsonData = this.jsonBox.getDataById(data.getParent().getId());
                var childData;
                jsonData.getChildren().forEach(function (child) {
                    if (child.getObjectId() == data.getId()) {
                        childData = child;
                    }
                });
                if (property.startsWith('C:')) {
                    p = property.substr(property.indexOf(':') + 1);
                    if (p == 'edgeIndex' || p == 'offset') {
                        childData.client = childData.client || {};
                        childData.client[p] = newValue;
                    }
                    if (p == 'length') {
                        childData.setWidth(newValue);
                    }
                    var location = data.getCenterLocation();
                    var positionY = childData.getPosition()[1];
                    childData.setPosition([location.x, positionY, location.y]);
                    var clientMap = childData.getClient() || {};
                    clientMap[p] = newValue;
                    childData.setClient(clientMap);
                }
            }
            var jsonData = this.jsonBox.getDataById(data.getId());
            if (!jsonData) {
                this.isAdjusting = false;
                return;
            }
            if (property == 'points') {
                var points = newValue;
                fixWallDatas(data, points);
            } else if (property == 'location') {
                //FIXME处理好父子关系
                var centerLocation = data.getCenterLocation();
                var size = data.getSize();
                var position = jsonData.getPosition() || [0, 0, 0];
                jsonData.setPosition([centerLocation.x, position[1], centerLocation.y]);
                fixWallDatas(data);
                //TODO 拖动位置时, 只会影响节点的父亲, 不会影响孩子
                self.resetParentAndChildren(data);
            } else if (property == 'angle') {
                jsonData.setRotation([0, -newValue, 0]);
            } else if (property == 'width') {
                jsonData.setWidth(newValue);
                var centerLocation = data.getCenterLocation();
                var position = jsonData.getPosition() || [0, 0, 0];
                jsonData.setPosition([centerLocation.x, position[1], centerLocation.y]);
            } else if (property == 'height') {
                jsonData.setDepth(newValue);
                var centerLocation = data.getCenterLocation();
                var position = jsonData.getPosition() || [0, 0, 0];
                jsonData.setPosition([centerLocation.x, position[1], centerLocation.y]);
            } else if (property.startsWith('C:')) {
                var p = property.substr(property.indexOf(':') + 1);
                if (p == 'radius') {
                    jsonData.setRadius(newValue);
                } else if (p == 'height') {
                    jsonData.setHeight(newValue);
                } else if (p == 'wallHeight') {
                    jsonData.setWallHeight(newValue);
                } else if (p == 'positionY') {
                    var position = jsonData.getPosition() || [0, 0, 0];
                    jsonData.setPosition([position[0], parseInt(newValue), position[2]]);
                } else if (p == 'pointsY') {
                    //pointsY is a map , {0: 23, 1:32}; do not deal with segments
                    var pointsY = newValue;
                    var datas = jsonData.getData();
                    for (var i = 0; i < datas.length; i++) {
                        datas[i][1] = pointsY[i];
                    }
                    jsonData.setData(datas);
                } else if (p == 'parentId') {
                    jsonData.setParentId(newValue);
                }
                var clientMap = jsonData.getClient() || {};
                clientMap[p] = newValue;
                jsonData.setClient(clientMap);
            } else if (property.startsWith('S:')) {
                var p = property.substr(property.indexOf(':') + 1);
                if (p == 'vector.outline.color') {
                    jsonData.setColor(newValue)
                }
                var styleMap = jsonData.getStyle() || {};
                styleMap[p] = newValue;
                jsonData.setStyle(styleMap);
            }
            this.isAdjusting = false;

            /*修复墙移动门窗偏移的问题*/
            function fixWallDatas(data, points) {
                if (!data.getPoints) return;
                var datas = [];
                var points = points || data.getPoints();
                var centerLocation = data.getCenterLocation();
                var pointsY = data.getClient('pointsY');
                var segments = data.getSegments();
                if (segments && segments.size() > 0 && segments.size() > points.size()) return;
                if (segments && segments.size() > 0) {
                    for (var i = 0, j = 0; i < segments.size(); i++, j++) {
                        var segment = segments.get(i);
                        var point = points.get(j);
                        if (segment == 'moveto' || segment == 'lineto') {
                            if (pointsY) {
                                datas.push([parseInt(point.x - centerLocation.x), pointsY[j], parseInt(point.y - centerLocation.y)]);
                            } else {
                                datas.push([parseInt(point.x - centerLocation.x), parseInt(point.y - centerLocation.y)]);
                            }

                        } else if (segment == 'quadto') {
                            if (pointsY) {
                                var point2 = points.get(++j);
                                var pointY2 = pointsY[j] || 0;
                                datas.push(['c', parseInt(point.x - centerLocation.x), pointsY[j], parseInt(point.y - centerLocation.y), parseInt(point2.x - centerLocation.x), pointY2, parseInt(point2.y - centerLocation.y)]);
                            } else {
                                datas.push(['c', parseInt(point.x - centerLocation.x), parseInt(point.y - centerLocation.y), parseInt(point2.x - centerLocation.x), parseInt(point2.y - centerLocation.y)]);
                            }

                        }
                    }
                } else {
                    for (var i = 0; i < points.size(); i++) {
                        if (pointsY) {
                            datas.push([points.get(i).x - centerLocation.x, pointsY[i], points.get(i).y - centerLocation.y]);
                        } else {
                            datas.push([points.get(i).x - centerLocation.x, points.get(i).y - centerLocation.y]);
                        }

                    }
                }
                jsonData.setData(datas);
            }

        },

        _handleJsonBoxChange: function (e) {
            if (this.isAdjusting) {
                return;
            }
            this.isAdjusting = true;
            var data = e.data;
            var kind = e.kind;
            if (kind == 'add') {
                if (!this.refMapJson[data.getObjectId()]) {
                    this.refMapJson[data.getObjectId()] = data;
                }
                this._add2dData(data);
            } else if (kind == 'remove') {
                this._remove2dData(data);
            } else if (kind == 'clear') {
                this.box2d.clear();
                this.refMapJson = {};
                this.refMap2d = {};
            }
            this.isAdjusting = false;
        },

        _remove2dData: function (data) {
            if (data != null) {
                this.box2d.removeById(data.getObjectId());
                delete this.refMap2d[data.getObjectId()]
            }
        },

        /**
         * 将一个JsonObject对象序列化,并且将3D模型的ID修改成对应的2D的模型ID
         * @param data {JsonObject}
         * @returns {{}}
         * @private
         */
        _replaceMappingId: function (data) {
            var result = {};
            make.Default.copyProperties(data, result);
            this._replaceMappingIdAction(result);
            return result;
        },

        /**
         * 将所有的3D模型的ID修改成对应的2D的模型ID
         * @param json
         * @private
         */
        _replaceMappingIdAction: function (json) {
            var data2dId = $utils.getSceneEditorModel2dId(json.id);
            json.id = data2dId;
            if (json.children) {
                for (var i in json.children) {
                    var child = json.children[i];
                    this._replaceMappingIdAction(child);
                }
            }
        },

        /**
         * 新增一个jsonObject时,同步创建一个2d的node
         * @param data
         * @private
         */
        _add2dData: function (data) {
            var self = this;
            if (this.synchronizeFilter(null, data)) {
                // if (this.jsonBox.contains(data)) {
                if (!this.box2d.getDataById(data.getObjectId())) {
                    var json = this._replaceMappingId(data);
                    //2D 和 3D 的旋转相反
                    if (json.rotation) {
                        json.rotation[1] *= -1;
                    }
                    var node = make.Default.load(json);
                    node.setClient('id', data.id);
                    this.box2d.add(node);
                    if (node.getChildren && node.getChildren().size() > 0) {
                        node.setClient('magnetic.disabled', node.getClient('magnetic.disabled') ? true : false);
                        var children = node.getChildren();
                        var self = this;
                        children.forEach(function (child) {
                            if (!self.box2d.getDataById(child.getId())) {
                                child.setClient('magnetic.disabled', true);
                                self.box2d.add(child);
                            }
                        });
                    }
                    this.refMap2d[data.getObjectId()] = node;
                    self.resetParentAndChildren(node);
                }
                // }
            }
        },

        resetParentAndChildren: function (data) {
            var self = this;
            var id = data.getId();
            var mid = make.Default.getId(data)
            var type = make.Default.getType(mid);
            if (type == 'door' || type == 'window') {
                return;
            }
            $utils.runDelayTask(id, 1, function () {
                self._resetParentAndChildren(data);
            })
        },

        _resetParentAndChildren: function (data) {

            this.resetParent(data);
            this.resetChildren(data);
        },

        resetParent: function (data) {

            var self = this;
            //console.log('resetParent ********************', data)
            //1 找到data的父亲
            if (data.getHost && data.setHost) {
                var parent = this.getParent(data);
                //console.log('parent', parent);
                if (parent) {
                    if (parent != data.getHost()) {
                        //console.log('set parent ');
                        data.setHost(parent);
                        data.setClient('parentId', parent.getId());
                        var jsonObject = this.refMapJson[data.getId()];
                        if (jsonObject) {
                            jsonObject.setParentId(parent.getId())
                        } else {
                            console.warn('2D对象参数与jsonObject不匹配, id2d=' + data.getId(), data, this.refMapJson);
                        }
                    }
                } else {
                    //console.log('clear parent ');
                    //data.setParent(null);
                    data.setHost(null);
                    data.setClient('parentId', null);
                    this.refMapJson[data.getId()].setParentId(null)
                }
            }
        },

        resetChildren: function (data) {

            var self = this;
            //2 找到data的孩子
            var children = this.getChildren(data);
            //console.log('children', children);
            children.forEach(function (child) {
                if (child.getHost && child.setHost) {
                    if (data != child.getHost()) {
                        //console.log('child change parent ', child);
                        child.setHost(data);
                        child.setClient('parentId', data.getId());
                        self.refMapJson[child.getId()].setParentId(data.getId())
                    }
                }
            })
        },


        getParent: function (node) {
            var parent = this._getParent(node);
            if (!parent) {
                //如果不存在父亲节点,并且不是外墙,将外墙设置为父亲节点
            }
            return parent;
        },

        /**
         * 是否是父亲层, 只有楼层, 机房, 通道有孩子
         * @param id
         * @returns {boolean}
         * @private
         */
        _isFatherLayer: function (id) {
            return id == idcLayer.wall || id == idcLayer.area || id == idcLayer.channel;
        },

        _getParent: function (node) {

            var centerLocation = node.getCenterLocation();
            var layerId = node.getLayerId();
            var layerBox = this.box2d.getLayerBox();
            var layerBoxSize = layerBox.size();
            //外墙的孩子(柱子之类)或者内墙的孩子(水浸线)的父亲必须是外墙
            var isWallChild = (layerId == idcLayer.area) ||
                (layerId == idcLayer.innerWall) ||
                (layerId == idcLayer.wallChild) ||
                (layerId == idcLayer.innerWallChild);
            if (isWallChild) {
                for (var j = 0; j < this.box2d.size(); j++) {
                    var data = this.box2d.getDataAt(j);
                    if (data.getLayerId() == idcLayer.wall) {

                        if ($utils.isNodeInNode(data, node)) {
                            return data;
                        }
                    }
                }
            } else {
                for (var i = layerBoxSize - 1; i >= 0; i--) {
                    var layer = layerBox.getDataAt(i);
                    //如果是上层或当前层,跳过
                    if (layer.getId() >= layerId) {
                        continue;
                    }
                    //只有楼层, 机房, 通道有孩子
                    if (!this._isFatherLayer(layer.getId())) {
                        continue
                    }
                    //不能为外墙的孩子(柱子,门窗) 内墙的孩子(门窗) 内墙的孩子
                    if (layer.getId() == idcLayer.wallChild ||
                        layer.getId() == idcLayer.innerWallChild ||
                        layer.getId() == idcLayer.innerWall) {
                        continue;
                    }
                    for (var j = 0; j < this.box2d.size(); j++) {
                        var data = this.box2d.getDataAt(j);
                        if (data.getLayerId() == layer.getId()) {
                            if ($utils.isNodeInNode(data, node)) {
                                return data;
                            }
                        }
                    }
                }
            }
        },

        getChildren: function (node) {
            var layerId = node.getLayerId();
            //只有楼层, 机房, 通道有孩子
            if (!this._isFatherLayer(layerId)) {
                return [];
            }
            var children = this._getChildren(node);
            //children 要过滤掉 父亲不是node的节点
            return children;
        },

        _getChildren: function (node) {

            var result = [];
            var location = node.getLocation();
            var size = node.getSize();
            var rect = {
                x: location.x,
                y: location.y,
                width: size.width,
                height: size.height
            }
            var layerId = node.getLayerId();
            var layerBox = this.box2d.getLayerBox();
            var layerBoxSize = layerBox.size();
            for (var i = 0; i < layerBoxSize; i++) {
                var layer = layerBox.getDataAt(i);
                //如果更底层或当前层,跳过
                if (layer.getId() <= layerId) {
                    continue;
                }
                //外墙的孩子(柱子,门窗) 内墙的孩子(门窗) 内墙的等元素没有孩子
                if (layer.getId() == idcLayer.wallChild ||
                    layer.getId() == idcLayer.innerWallChild ||
                    layer.getId() == idcLayer.innerWall) {
                    continue;
                }
                for (var j = 0; j < this.box2d.size(); j++) {
                    var data = this.box2d.getDataAt(j);
                    var centerLocation = data.getCenterLocation();
                    if (data.getLayerId() == layer.getId()) {

                        //if ($utils.isPointInRect(centerLocation, rect)) {
                        //    var p = this.getParent(data);
                        //    if (p == node) {
                        //        result.push(data);
                        //    }
                        //}
                        if ($utils.isNodeInNode(node, data)) {
                            var p = this.getParent(data);
                            if (p == node) {
                                result.push(data);
                            }
                        }
                    }
                }
            }
            return result;
        }
    });

    nsp.edit.Edit2D = function (jsonBox, editor) {
        this.jsonBox = jsonBox || new nsp.edit.JsonBox();
        this.editor = editor;
        this._init();
        this.loadDataFlag = false;

    }
    nsp.edit.Edit2D.CONTAINER_CLASS = 'edit2d-container';
    twaver.Util.ext(nsp.edit.Edit2D, Object, {
        _init: function () {
            //create left menu
            this.accordionPane = new doodle.AccordionPane();
            var self = this;
            /*this.accordionPane.ondrag = function (e, item) {
             if (!self.currentItem) {
             self.currentItem = item;
             self.dragNode = make.Default.load(item.id);
             self.dragNode.setClient('id', item.id);
             }
             }*/

            this.network2d = new nsp.edit.GridNetwork();
            this.network2d.setMinZoom(0.1);
            this.network2d.setMaxZoom(5);
            this.box = this.network2d.getElementBox();
            //create property sheet
            var sheet = this.sheet = new twaver.controls.PropertySheet(this.box);
            $utils.initPropertySheet(sheet);

            //create network2d
            this.network2dView = this._initNetwork2d();
            // this._initLayers2d();

            this.clientBidQuickFinder = new twaver.QuickFinder(this.box, 'bid', 'client');
            var bridge = new nsp.edit.BoxBridge(this.box, this.jsonBox);
            bridge.bind();
            //register image
            //this._registerImage();
            //this.addPropertySheetListener();
            // this.setDragAndDropImage(this.network2d.getView());


            this.network2d.addInteractionListener(function (e) {
                //console.log(e);
                if (e.kind == 'doubleClickElement') {
                    this.doubleClickRackHandler && this.doubleClickRackHandler(e.element, this.box);
                }
            }, this);

            this.box.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange, this);

            this.editor.propertySheetBox.append(this.sheet.getView());
            this.editor.accordionPaneBox.append(this.accordionPane.getView());
            this.editor.networkBox.append(this.network2dView);
        },

        createNodesByJson: function (jsons) {
            $utils.createJsonObject(this.jsonBox, jsons);
            this.box.getSelectionModel().clearSelection();
        },
        zoomOverview: function () {
            this.network2d.zoomOverview();
        },
        setDragAndDropImage: function (view) {
            var self = this;
            DragAndDrop.setDropTarget(view, {
                dropEffect: 'copyMove',
                ondrop: function (e, data) {
                    // if (self.isHost(self.dragNode)) {
                    //     var endPoint = self.network2d.getLogicalPoint(e);
                    //     var node = self.loadParent('', {location: [endPoint.x, endPoint.y]}, self.dragNode);
                    //     setTimeout(function () {
                    //         self.network2d.zoomOverview();
                    //     }, 10);
                    // } else {

                    //     box.getSelectionModel().clearSelection();
                    //     box.getSelectionModel().appendSelection(self.dragNode);
                    //     self.dragNode.setStyle('whole.alpha', 1);
                    //     self._resetPropertySheet();
                    //     self.resetChildNodeLocation(self.dragNode);
                    // }
                    if (self.dragNode) {
                        self.dragNode = null;
                        self.currentItem = null;
                    }

                },
                ondragover: function (e) {
                    e.preventDefault();
                    // e.dataTransfer.dropEffect = 'move';
                    // DragAndDrop.setDragImage('./images/bbb.png',e);
                    // e.dataTransfer.setDragImage('./images/bbb.png',0.5, 0.5);

                    //console.log(self.currentItem);
                    //判断拖拽的是否是子节点
                    if (self.dragNode) {

                        //判断是否有剩余空间可以放置
                        // var size = self.getSize(self.dragNode);
                        // if (!self.parentNode || !self._haveSpace(size, self.dragNode)) {
                        //     e.dataTransfer.dropEffect = 'none';
                        //     return;
                        // }
                        //如果没有添加子节点,那么添加
                        if (!self.dragNode.isAddInBox) {
                            self.dragNode.isAddInBox = true;
                            self.dragNode.setStyle('whole.alpha', 0.7);
                            self.box.add(self.dragNode);
                        }
                        var endPoint = self.network2d.getLogicalPoint(e);
                        var tx = endPoint.x;
                        var ty = endPoint.y;
                        ty -= self.dragNode.getSize().height / 2;
                        self.dragNode.setLocation(tx, ty);
                        // endPoint = self.formatLocation(self.dragNode, tx, ty);
                        // if (endPoint) {

                        // } else {
                        //     self.resetChildNodeLocation(self.dragNode);
                        // }
                    }

                },
                ondragleave: function (e) {
                    if (self.dragNode) {
                        if (self.dragNode.isAddInBox) {
                            self.box.remove(self.dragNode);
                        }
                        self.dragNode = null;
                        self.currentItem = null;
                    }

                }
            });

        },
        //addPropertySheetListener: function () {
        //    var box = this.sheet.box;
        //    box.addDataPropertyChangeListener(this._handleSheetPropertyChanged, this);
        //},
        //_registerImage: function () {
        //
        //},
        /*_initLayers2d: function () {
         var box2d = this.network2d.getElementBox();
         var layerBox = box2d.getLayerBox();
         var defaultLayers = ["floorLayer"];
         for (var i = 0; i < defaultLayers.length; i++) {
         var layerId = defaultLayers[i];
         if (!layerBox.getDataById(layerId)) {
         var layer = new twaver.Layer(layerId);
         layerBox.add(layer);
         }
         }
         },*/
        _initNetwork2d: function () {
            var listener = new nsp.edit.interaction.RoomListener(this.network2d, this.propertySheetPane, this.jsonBox);
            listener.initRoomSettings();
            var self = this;
            var ruler = this.ruler = new nsp.edit.Ruler(this.network2d);

            ruler.getView().setAttribute('class', 'room-ruler');
            ruler.setShowGuides(false);
            ruler.setShowRuler(true);
            this.network2d.getLabel = function (data) {
                if ($utils.isEditModel(data)) {
                    var bid = data.getClient('bid');
                    if (bid && bid.trim().length > 0) {
                        return bid;
                    }
                    return data.getClient("label");
                }
            }
            return ruler.getView();
        },
        layoutGUI: function () {
            this.ruler.invalidate();
        },

        getJsonBox: function () {
            return this.jsonBox;
        },
        getRegionJson: function (id) {
            var result = null;
            var self = this;
            result = this.jsonBox.toJson(function (d) {
                return self._isRegion(d, id);
            });
            return result;
        },
        _isRegion: function (data, id) {
            var type = data.type;
            if (id && id != data.getId()) {
                return false;
            }
            if (type == 'area-rect' || type == 'area-round' || type == 'area-polygon') {
                return true;
            }
            return false;
        },
        loadData: function () {
            var box = this.network2d.getElementBox();
            if (!this.loadDataFlag) {
                this.loadDataFlag = true;

                nsp.edit.model.model2d.loadData(box, JSON.parse(window.localStorage.getItem('scene')) || []);
                //nsp.edit.model.model2d.loadData(box, JSON.parse(window.localStorage.getItem('region')) || []);
            }
            var regions = [];
            box.forEach(function (data) {
                if (data.getClient('type') == 'area') {
                    regions.push(data);
                }
            });
            regions.forEach(function (region) {
                box.remove(region);
            });
            nsp.edit.model.model2d.loadData(box, JSON.parse(window.localStorage.getItem('region')) || []);
        },
        getObject2dById: function (id) {
            return id ? this.clientBidQuickFinder.findFirst(id) : null;
        },
        //_handleSheetPropertyChanged: function (e) {
        //    if (!this.propertySheetPane._setValued) {
        //        return;
        //    }
        //    this.jsonObj = this.propertySheetPane.jsonObj;
        //    var p = e.property, newValue = e.newValue;
        //    if (p.startsWith('C:')) {
        //        p = p.replace('C:', '');
        //        this.jsonObj[p] = newValue;
        //    }
        //
        //    // var rack = make.Default.load(this.jsonObj);
        //    // this.network3d.getDataBox().clear();
        //    // this.network3d.getDataBox().addByDescendant(rack);
        //    // this._currentModel = rack;
        //    // rack.setClient('data',this.jsonObj);
        //    this.fireModelPropertyChange(rack, p, e.oldValue, e.newValue);
        //},
        doubleClickRackHandler: function (element, box) {

        },
        handleSelectionChange: function () {

            //if(!this.editor.isPropertySheetVisible()){
            //    return;
            //}
            //var data = this.box.getSelectionModel().getLastData();
            //if (data) {
            //    var eleId = $utils.getSceneEditorModel2dId(data.getClient('id'));
            //    var result = this.propertySheetPane.setElementId(data.getClient('modelId') || eleId);
            //    if (result) {
            //        this.editor.propertySheetBox.show();
            //        this.editor.resetPropertySheetBoxSize(this.propertySheetPane.sheet);
            //    } else {
            //        this.editor.propertySheetBox.hide();
            //    }
            //} else {
            //    this.editor.propertySheetBox.hide();
            //}
            if (!this.editor.isPropertySheetVisible()) {
                return;
            }
            var self = this;
            var propBox = self.sheet.getPropertyBox();
            propBox.clear();
            var selection = this.box.getSelectionModel();
            if (selection.size() != 1) {
                propBox.clear();
                this.editor.propertySheetBox.hide();
            } else {
                this.editor.propertySheetBox.show();
                var node = selection.getLastData();
                var id = make.Default.getId(node);
                id = $utils.getSceneEditorModel2dId(id);
                $utils.addProperties(propBox, make.Default.getModelDefaultParameterProperties(id));
                self.editor.resetPropertySheetBoxSize(this.sheet);
            }
        },
    })
    nsp.edit.Edit3D = function (jsonBox, editor) {
        this.jsonBox = jsonBox || new nsp.edit.JsonBox();
        this.editor = editor;
        this._init();
        this.isZoom = false;
        this.afterRefreshNetwork3d = null;

    }
    twaver.Util.ext(nsp.edit.Edit3D, Object, {
        _init: function () {
            //create network3d
            this.network3dView = this._initNetwork3d();
            //create container, add all components into the container

            this.jsonBox.addDataBoxChangeListener(this._handleJsonBoxChange, this);

            this.editor.contentPane3d.append(this.network3dView);
        },
        _initNetwork3d: function () {
            var network3d = this.network3d = new mono.Network3D();
            var camera = new mono.PerspectiveCamera(30, 1.5, 50, 20000);
            network3d.setCamera(camera);
            camera.p(638, 2571, 2763);

            network3d.setClearColor('#000000');
            network3d.setClearAlpha(0);
            network3d.setBackgroundImage('./images/bg_network.jpg')
                // camera.look(new mono.Vec3(922, 0, 385));

            var interaction = network3d.getDefaultInteraction();
            interaction.yLowerLimitAngle = Math.PI / 180 * 2;
            interaction.yUpLimitAngle = Math.PI / 2;
            interaction.maxDistance = 10000;
            interaction.minDistance = 50;
            interaction.zoomSpeed = 3;
            interaction.panSpeed = 0.2;
            network3d.setInteractions([interaction]);
            // network3d.setShowAxis(true);

            var box = this.box = network3d.getDataBox();
            var pointLight = new mono.PointLight(0xFFFFFF, 0.1);
            pointLight.setPosition(8000, 8000, 8000);
            box.add(pointLight);

            box.add(new mono.AmbientLight('white'));

            network3d.getRootView().setAttribute('class', 'network3d-view');
            var self = this;
            var handleDoubleClick = function (e, network) {
                var self = this;
                var camera = network.getCamera();
                var interaction = network.getDefaultInteraction();
                var firstClickObject = $utils.findFirstObjectByMouse(network, e);
                if (firstClickObject) {
                    var element = firstClickObject.element;
                    var newTarget = firstClickObject.point;
                    var oldTarget = camera.getTarget();
                    if (element.getClient('animation')) {

                        //close rack door
                        if (element.getClient('type') == 'rack_door' && element.getClient('animated')) {
                            //move in equipment
                            var equipments = element.getParent().getChildren().toList(function (item) {
                                return element != item && item.getClient('animated');
                            });
                            var size = equipments.size();
                            var currCount = 0;
                            if (size > 0) {
                                equipments.forEach(function (equipment) {
                                    make.Default.playAnimation(equipment, equipment.getClient('animation'), function () {
                                        currCount++;
                                        if (currCount == size) {
                                            make.Default.playAnimation(element, element.getClient('animation'));
                                        }
                                    });
                                })
                            } else {
                                make.Default.playAnimation(element, element.getClient('animation'));
                            }
                        } else {
                            make.Default.playAnimation(element, element.getClient('animation'));
                        }
                    } else {
                        $utils.animateCamera(camera, interaction, oldTarget, newTarget);
                    }
                    if (element.getClient('dbl.func')) {
                        var func = element.getClient('dbl.func');
                        func(element, network, firstClickObject, e);
                    } else if (element.getParent() && element.getParent().getClient('dbl.func')) {
                        var func = element.getParent().getClient('dbl.func');
                        func && func(element.getParent(), network, firstClickObject, e);
                    }
                } else {
                    var oldTarget = camera.getTarget();
                    var newTarget = new mono.Vec3(0, 0, 0);
                    $utils.animateCamera(camera, interaction, oldTarget, newTarget);
                }
            }

            network3d.getRootView().addEventListener('dblclick', function (e) {
                handleDoubleClick(e, network3d);
            });

            return network3d.getRootView();
        },

        refreshNetwork3d: function () {
            var self = this;
            var box = this.network3d.getDataBox();
            box.clear();
            var datas = this.jsonBox.toJson();
            var object3ds = make.Default.load(datas, function (object3ds) {
                if (object3ds && object3ds.length > 0) {
                    for (var i = 0; i < object3ds.length; i++) {
                        var object3d = object3ds[i];
                        box.addByDescendant(object3d);
                        object3d.setClient('dbl.func', function (element, network) {
                            self.doubleClickHandler(element, box);
                        })
                    }
                    //FIXME 目前box.clear()后, object.clonePrefab()的复制对象,添加到box中无法显示,采用新加入一个cube然后在移除的方式规避问题
                    setTimeout(function () {
                        var cube = new mono.Cube(0.1, 0.1, 0.1)
                        box.add(cube);
                        setTimeout(function () {
                            box.remove(cube);
                        }, 500)
                    }, 500)
                    if (self.afterRefreshNetwork3d) self.afterRefreshNetwork3d();
                }
            });
            if (!this.isZoom) {
                this.zoomToOverview();
            }
        },

        findByBID: function (bid) {
            if (!this.bidQuickFinder)
                this.bidQuickFinder = new mono.QuickFinder(this.network3d.getDataBox(), 'bid', 'client');
            return this.bidQuickFinder.findFirst(bid);
        },
        doubleClickHandler: function (element, box) {

        },
        zoomToOverview: function () {
            this.isZoom = true;
            this.network3d.zoomEstimateOverview(45);

            var bb = this.network3d.getNetworkBoundingBox();
            console.log(bb);

            var camera = this.network3d.getCamera();
            var p = camera.p();
            var t = camera.t();
            camera.setPosition(p.x + 2500, p.y + 3500, p.z + 3500);
            setTimeout(function () {
                mono.Utils.playCameraAnimation(camera, new mono.Vec3(p.x + 500, p.y + 500, p.z + 500), t, 500);
            }, 1000);
        },
        getView: function () {
            return this.network3dView;
        },
        getJsonBox: function () {
            return this.jsonBox;
        },
        _handleJsonBoxChange: function (e) {
            kind = e.kind;
            if (kind == 'clear') {
                this.network3d.getDataBox().clear();
            }
        },
    })
    nsp.edit.EditDrop = function () {
        this.dropFunctionMap = {};
        this.registerDropFunction("model", this.onModelDrop);
        this.registerDropFunction("default", this.onDefaultDrop);
    };

    twaver.Util.ext(nsp.edit.EditDrop, Object, {
        registerDropFunction: function (dragType, func) {
            this.dropFunctionMap[dragType] = func;
        },
        onDrop: function (network, dragData) {
            if (typeof dragData === 'string') {
                dragData = JSON.parse(dragData);
            }
            var dragType = dragData.dragType;
            var func = this.dropFunctionMap[dragType];
            if (func) {
                func(network, dragData);
            } else {
                this.onDefaultDrop(network, dragData);
            }
        },

        onModelDrop: function (network, dragData) {
            var model = dragData.model;
            if (model) {
                console.log("load model : " + model);
            }
        },

        onDefaultDrop: function (network, dragData) {
            console.log("onDefaultDrop");
            network.setInteractions([new nsp.edit.interaction.RoomDragInteraction(network)]);
        },
    });

    doodle.ImportDxf = nsp.edit.ImportDxf = function (scale) {
        this.scale = scale || 1;
    }

    twaver.Util.ext(nsp.edit.ImportDxf, Object, {
        loadDxf: function (data, autoCreateId) {
            var self = this;
            if (data instanceof File) {
                if (data.name.match(/\.dxf$/i)) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        self.loadDxf(e.target.result, autoCreateId);
                    };
                    reader.readAsText(data);
                } else {
                    alert('Only dxf file is supported');
                }
            } else {
                return self._loadDxfFile(data, autoCreateId);
            }
        },

        _loadDxfFile: function (data, autoCreateId) {
            var self = this;
            self.data = data;
            var returnDatas = [];
            var parser = self.parser = new dxf.Dxf();
            parser.parse(data);
            var minY = Number.POSITIVE_INFINITY,
                maxY = Number.NEGATIVE_INFINITY,
                minX = Number.POSITIVE_INFINITY,
                maxX = Number.NEGATIVE_INFINITY,
                walls = [];

            function computeMaxMin(entity) {
                var type = make.Default.getType(entity.attrib.layer);
                if (type && (type == 'wall')) {
                    if (entity instanceof dxf.LineData) {
                        minY = entity.y1 < minY ? entity.y1 : minY;
                        minY = entity.y2 < minY ? entity.y2 : minY;
                        maxY = entity.y1 > maxY ? entity.y1 : maxY;
                        maxY = entity.y2 > maxY ? entity.y2 : maxY;
                        minX = entity.x1 < minX ? entity.x1 : minX;
                        minX = entity.x2 < minX ? entity.x2 : minX;
                        maxX = entity.x1 > maxX ? entity.x1 : maxX;
                        maxX = entity.x2 > maxX ? entity.x2 : maxX;
                    } else if (entity instanceof dxf.PolylineData) {
                        entity.points.forEach(function (vertex) {
                            minY = vertex.y < minY ? vertex.y : minY;
                            maxY = vertex.y > maxY ? vertex.y : maxY;
                            minX = vertex.x < minX ? vertex.x : minX;
                            maxX = vertex.x > maxX ? vertex.x : maxX;
                        });
                    } else if (entity instanceof dxf.InsertData) {

                    }
                } else if (entity instanceof dxf.InsertData) { //后续添加
                    if (entity.name === 'road') {
                        var datas = self.getEntitiesFromInsertData(entity);
                        datas.forEach(function (data) {
                            computeMaxMin(data);
                        });
                    }
                }
            };

            parser.sections.entities.forEach(function (entity) {
                computeMaxMin(entity);
            });

            self.minY = minY, self.maxY = maxY, self.minX = minX, self.maxX = maxX;


            //封装json数据,遍历所有的json对象
            var jsons = [];
            //1.wall
            var walls = self.walls = [];
            parser.sections.entities.forEach(function (entity) {
                var layerName = entity.attrib.layer;
                var type = make.Default.getType(layerName);
                if (type == 'wall' || type == 'innerWall') {
                    self.createJsonArray(entity, jsons, layerName);
                }
            });

            //2.door, window
            parser.sections.entities.forEach(function (entity) {
                var layerName = entity.attrib.layer;
                var type = make.Default.getType(layerName);
                if (type == 'door') {
                    self.createBlockJson(entity, layerName, walls, 10);
                } else if (type == 'window') {
                    self.createBlockJson(entity, layerName, walls, 50);
                }
            });

            var texts = [];
            var scale = self.scale;
            //3. text entity instanceof dxf.MTextData
            parser.sections.entities.forEach(function (entity) {
                var layerName = entity.attrib.layer;
                if (entity instanceof dxf.MTextData) {
                    var x = (entity.ipx + entity.width / 2 * Math.cos(entity.angle)) * scale;
                    var y = -(entity.ipy + entity.height / 2 * Math.sin(entity.angle)) * scale;
                    texts.push({
                        id: layerName,
                        point: {
                            x: x,
                            y: y,
                        },
                        text: entity.text,
                        entity: entity,
                    })
                } else if (entity instanceof dxf.TextData) {
                    var x = (entity.ipx) * scale;
                    var y = -(entity.ipy) * scale;
                    texts.push({
                        id: layerName,
                        point: {
                            x: x,
                            y: y,
                        },
                        text: entity.text,
                        entity: entity,
                    })
                }
            });


            //4. other
            parser.sections.entities.forEach(function (entity) {
                var layerName = entity.attrib.layer;
                var type = make.Default.getType(layerName);
                if (type == 'wall' || type == 'innerWall' || type == 'door' || type == 'window') {} else {
                    self.createJsonArray(entity, jsons, layerName, texts);
                }
            });
            //console.log(texts);
            if (autoCreateId && jsons && jsons.length > 0) {
                var typeIdMap = {};
                jsons.forEach(function (item) {
                    if (!item.client || item.client.bid) {
                        var id = item.id;
                        if (!typeIdMap[id]) {
                            typeIdMap[id] = 1;
                        }
                        var oid = id + '_' + typeIdMap[id]++;
                        item.objectId = oid;
                        item.client = item.client || {};
                        item.client.bid = oid;
                    }
                })
            }
            return jsons;
        },

        createBlockJson: function (entity, id, walls, height) {
            var self = this;
            var p1 = this.translatePoint({ x: entity.x1, y: entity.y1 });
            var p2 = this.translatePoint({ x: entity.x2, y: entity.y2 });
            var wall;
            walls.some(function (item) {
                index = self.getPointIndex(item, p1)
                if (index < 0) {
                    index = self.getPointIndex(item, p2);
                }
                if (index >= 0) {
                    wall = item;
                }
                return wall != null;
            });
            if (wall == null || index < 0) {
                return;
            }

            var point = { x: (p1.x + p2.x) / 2, y: (p1.y + p2.y) / 2 };
            var offset = this.getPointOffset(wall, point, index);
            var rotateY = Math.atan((p1.y - p2.y) / (p1.x - p2.x));
            wall.children = wall.children || [];
            var width = Math.sqrt((p1.x - p2.x) * (p1.x - p2.x) + (p1.y - p2.y) * (p1.y - p2.y));
            var wallChild = {
                id: id,
                position: [point.x, height, point.y],
                rotation: [0, rotateY, 0],
                width: width,
                client: { edgeIndex: index, offset: offset },
            };
            wall.children.push(wallChild);
        },

        createJsonArray: function (entity, jsons, id, texts) {

            var self = this;
            var str = entity.attrib.layer.split('#');
            var type = make.Default.getType(id);

            var points = this.getEntityPoints(entity, entity.flags === 1);
            // console.log(points);
            var json = {};
            if (type == 'wall' || type == 'innerWall' || type == 'floor' || type == 'area' || type == 'watercable') {
                json = {
                    id: id,
                    data: points,
                }
                if (type == 'wall') {
                    if (points[0].toString() == points[points.length - 1].toString()) {
                        points = points.slice(0, points.length - 1);
                        json.data = points;
                        json.closed = true;
                        json.showFloor = true;
                    }
                }
                if (type == 'area') {
                    var rect = this.getRectOfPoints(points);
                    if (!rect) {
                        return null;
                    }
                    var text = self.getText(id, rect.points, texts);
                    if (text) {
                        json.objectId = text;
                        json.client = json.client || {};
                        json.client.bid = text;
                    }
                }
            } else {
                var rect = this.getRectOfPoints(points);
                if (!rect) {
                    return null;
                }
                var width = rect.max.x - rect.min.x;
                var depth = rect.max.y - rect.min.y;
                var center = rect.center();
                var angle = 0;
                if (entity instanceof dxf.InsertData) {
                    angle = entity.angle;
                }
                json = {
                    id: id,
                    width: width,
                    depth: depth,
                    rotation: [0, angle, 0],
                    position: [center.x, 'floor-top', center.y],
                };

                var ps = self.rotatePoints(rect.points, angle, center);
                var text = self.getText(id, ps, texts);
                if (text) {
                    json.objectId = text;
                    json.client = json.client || {};
                    json.client.bid = text;
                }
            }
            jsons.push(json);
            if (type == 'wall' || type == 'innerWall') {
                this.walls.push(json);
            }
        },
        rotatePoints: function (points, angle, cp) {

            //x0= (x - rx0)*cos(a) - (y - ry0)*sin(a) + rx0 ;

            //y0= (x - rx0)*sin(a) + (y - ry0)*cos(a) + ry0 ;
            var rx0 = cp.x;
            var ry0 = cp.y;
            var cos = Math.cos(angle / 180 * Math.PI);
            var sin = Math.sin(angle / 180 * Math.PI);
            var ps = [];
            points.forEach(function (p) {
                ps.push({
                    x: (p.x - rx0) * cos - (p.y - ry0) * sin + rx0,
                    y: (p.x - rx0) * sin + (p.y - ry0) * cos + ry0,
                });
            });
            return ps;
        },

        getText: function (id, points, texts) {

            for (var i = 0; i < texts.length; i++) {
                var text = texts[i];
                if (text.id == id) {
                    var p = text.point;
                    if (this.isPointInPolygon(points, p)) {
                        var r = text.text;
                        texts.splice(i, 1);
                        return r;
                    }
                }
            }
        },

        translatePoint: function (point) {
            var self = this;
            // var minX = self.minX,minY = self.minY,maxX = self.maxX,maxY = self.maxY;
            var minX = 0,
                minY = 0,
                maxX = 0,
                maxY = 0;
            var w = maxX - minX;
            var h = maxY - minY;
            var hgap = 0,
                vgap = 0,
                scale = this.scale;
            return { x: (point.x - minX - w / 2) * scale + hgap, y: (-point.y + maxY - h / 2) * scale + vgap };

        },

        getFixedNumber: function (num) {
            return parseFloat(num.toFixed(0));
        },

        getEntitiesPoints: function (entities, offsetX, offsetY) {
            var points = [],
                self = this;
            entities.forEach(function (entity) {
                var pts = self.getEntityPoints(entity, entity.flags === 1, offsetX, offsetY)
                var len = points.length;
                if (len >= 4) {
                    if (points[len - 2] === pts[0] && points[len - 1] === pts[1]) {
                        pts.shift(), pts.shift();
                    }
                }
                points.push.apply(points, pts);
            });

            return points;
        },

        getRectOfPoints: function (points) {
            if (!points || points.length / 2 < 2) {
                return null;
            }
            var minY = Number.POSITIVE_INFINITY,
                maxY = Number.NEGATIVE_INFINITY,
                minX = Number.POSITIVE_INFINITY,
                maxX = Number.NEGATIVE_INFINITY;
            var i = 0,
                len = points.length,
                ps = [];
            var compareMinMax = function (x, y) {
                minX = Math.min(minX, x);
                maxX = Math.max(maxX, x);
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
                ps.push({ x: x, y: y });
            }
            if (len > 0 && points[i] instanceof Array) {
                for (; i < len; i++) {
                    var point = points[i];
                    if (point.length == 2) {
                        compareMinMax(point[0], point[1]);
                    } else if (point.length == 5 && point[0] == 'c') {
                        // compareMinMax(point[1], point[2]);
                        compareMinMax(point[3], point[4]);
                    }
                }
            } else {
                for (; i < len; i += 2) {
                    compareMinMax(points[i], points[i + 1]);
                }
            }

            return {
                min: {
                    x: minX,
                    y: minY,
                },
                max: {
                    x: maxX,
                    y: maxY
                },
                center: function () {
                    return {
                        x: (this.min.x + this.max.x) / 2,
                        y: (this.min.y + this.max.y) / 2,
                    };
                },
                points: ps
            };
        },

        getBulgeVertex: function (bulge, vertex1, vertex2) {
            var point1 = { x: vertex1.x, y: vertex1.y };
            var point2 = { x: vertex2.x, y: vertex2.y };
            var newVertex = {};
            var result = (point1.x - point2.x) * (point1.y - point2.y) * bulge;
            if (result > 0) {
                newVertex = { x: point2.x, y: point1.y };
            } else if (result < 0) {
                newVertex = { x: point1.x, y: point2.y };
            }
            return newVertex;
        },

        getEntityPoints: function (entity, closed, offsetX, offsetY) {
            offsetX = offsetX || 0, offsetY = offsetY || 0;
            var points = [],
                self = this;
            if (entity instanceof dxf.LineData) {
                var point = self.translatePoint({ x: entity.x1 + offsetX, y: entity.y1 + offsetY });
                points.push(this.getFixedNumber(point.x), this.getFixedNumber(point.y));
                point = self.translatePoint({ x: entity.x2 + offsetX, y: entity.y2 + offsetY });
                points.push(this.getFixedNumber(point.x), this.getFixedNumber(point.y));
            } else if (entity instanceof dxf.PolylineData) {
                for (var i = 0; i < entity.points.length; i++) {
                    var vertex = entity.points[i];
                    var point = self.translatePoint({ x: vertex.x + offsetX, y: vertex.y + offsetY });
                    points.push([self.getFixedNumber(point.x), self.getFixedNumber(point.y)]);
                    if (vertex.bulge && Math.abs(vertex.bulge.toFixed(3)) == 0.414) {
                        closed = false;
                        var vertex2 = entity.points[++i] || entity.points[0];;
                        var bulgeVertex = self.getBulgeVertex(vertex.bulge.toFixed(3), vertex, vertex2);
                        var point2 = self.translatePoint({ x: vertex2.x + offsetX, y: vertex2.y + offsetY });
                        var bulgePoint = self.translatePoint({ x: bulgeVertex.x + offsetX, y: bulgeVertex.y + offsetY });
                        points.push(['c', self.getFixedNumber(bulgePoint.x), self.getFixedNumber(bulgePoint.y), self.getFixedNumber(point2.x), self.getFixedNumber(point2.y)]);
                    }
                }

            } else if (entity instanceof dxf.InsertData) {
                var name = entity.name,
                    block = null;
                var blocks = self.parser.sections.blocks;
                var ipx = entity.ipx + offsetX,
                    ipy = entity.ipy + offsetY;
                block = blocks[name];
                points = self.getEntitiesPoints(block.entities, ipx, ipy)
            }
            if (closed) {
                var len = points.length;
                if (points[len - 2] != points[0] || points[len - 1] != points[1]) {
                    points.push(points[0]);
                }
            }
            return points;
        },

        pointArrayToPointObjects: function (pointArray) {
            var i = 0,
                len = pointArray.length;
            var points = [];
            if (pointArray[0] instanceof Array) {
                for (; i < len; i++) {
                    points.push({
                        x: pointArray[i][0],
                        y: pointArray[i][1],
                    });
                }
            } else {
                for (; i < len; i += 2) {
                    points.push({
                        x: pointArray[i],
                        y: pointArray[i + 1],
                    });
                }
            }

            return points;
        },

        isPointOnLine: function (point, point1, point2, width) {
            if (width < 0) {
                width = 0;
            }
            var distance = this.getDistanceFromPointToLine(point, point1, point2);
            return distance <= width &&
                (point.x >= Math.min(point1.x, point2.x) - width) &&
                (point.x <= Math.max(point1.x, point2.x) + width) &&
                (point.y >= Math.min(point1.y, point2.y) - width) &&
                (point.y <= Math.max(point1.y, point2.y) + width);
        },

        getDistanceFromPointToLine: function (point, point1, point2) {
            if (point1.x === point2.x) {
                return Math.abs(point.x - point1.x);
            }
            var lineK = (point2.y - point1.y) / (point2.x - point1.x);
            var lineC = (point2.x * point1.y - point1.x * point2.y) / (point2.x - point1.x);
            return Math.abs(lineK * point.x - point.y + lineC) / (Math.sqrt(lineK * lineK + 1));
        },

        getPointOffset: function (wallJson, point, index) {
            var pts = wallJson.data;
            var points = this.pointArrayToPointObjects(pts);
            var p1 = points[index],
                p2 = points[index + 1];
            p2 = p2 || points[0];

            var offset = 0;
            if (p1.x != p2.x) {
                offset = (point.x - p1.x) / (p2.x - p1.x);
            } else if (p1.y != p2.y) {
                offset = (point.y - p1.y) / (p2.y - p1.y);
            }

            return offset;
        },

        getPointIndex: function (wallJson, point) {
            var pts = wallJson.data;
            var points = this.pointArrayToPointObjects(pts);

            if (points.length < 2) {
                return -1;
            }
            for (var i = 0; i < points.length; i++) {
                if (_twaver.math.getDistance(point, points[i]) <= 10) {
                    return -1;
                }
            }
            var p1 = points[0],
                p2;
            for (var i = 1; i < points.length; i++) {
                p2 = points[i];
                if (this.isPointOnLine(point, p1, p2, 10)) {
                    return i - 1;
                }
                p1 = p2;
            }
            p1 = points[0];
            if (this.isPointOnLine(point, p1, p2, 10)) {
                return points.length - 1;
            }
            return -1;
        },

        isPointInPolygon: function (points, point) {
            var i = 0,
                j = 0,
                c = false,
                size = points.length;
            for (i = 0, j = size - 1; i < size; j = i++) {
                var p1 = points[i];
                var p2 = points[j];
                if (((p1.y > point.y) != (p2.y > point.y)) && (point.x < (p2.x - p1.x) * (point.y - p1.y) / (p2.y - p1.y) + p1.x)) {
                    c = !c;
                }
            }
            return c;
        },

    });


    var ImportVsdx = function (scale) {
        this.scale = scale || 2.54; // 默认保存单位是英寸, 一英寸等于24.5mm
        this.idMap = {

            "机柜": "twaver.idc.rack42",
            "外墙": "twaver.idc.wall",
            "内墙": "twaver.idc.innerWall2",
            "窗户": "twaver.idc.window",
            "门": "twaver.idc.door",
            "柱子": "twaver.idc.column"
        };
        this.positionYMap = {
            door: 10,
            window: 50,
        }
    }

    twaver.Util.ext(ImportVsdx, Object, {

        loadVsdx: function (data, callback, autoCreateId) {
            var self = this;
            if (data instanceof File) {
                if (data.name.match(/\.Vsdx$/i)) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        self.loadVsdx(e.target.result, autoCreateId);
                    };
                    reader.readAsText(data);
                } else {
                    alert('Only Vsdx file is supported');
                }
            } else {
                return self._loadVsdxFile(data, callback, autoCreateId);
            }
        },

        /**
         * 加载 vsdx 文件内容
         * @param data
         * @param autoCreateId
         * @private
         */
        _loadVsdxFile: function (data, callback, autoCreateId) {
            var self = this;
            JSZip.loadAsync(data).then(function (r) {
                //console.log(r);
                self.parseZip(r, callback);
            });
        },

        /**
         * 解析 zip 文件
         * @param zip
         */
        parseZip: function (zip, callback) {

            var self = this;
            var files = zip.files;
            var masters = 'visio/masters/masters.xml'
            var pagePatten = 'visio/pages/page';
            var pageFilePatten = 'visio/pages/pages.xml';

            var masterFile;
            var pageFiles = [];
            for (var name in files) {
                if (name.indexOf(pagePatten) == 0 && name != pageFilePatten) {
                    var pageFile = files[name];
                    pageFiles.push(pageFile);
                } else if (name == masters) {
                    masterFile = files[name];

                }
            }
            this.parseMaster(masterFile, files, function (masterMap) {
                self.masterMap = masterMap;
                var result = [];
                for (var i = 0; i < pageFiles.length; i++) {
                    var pageFile = pageFiles[i];
                    self.parsePage(pageFile, masterMap, function (json) {
                        result.push(json);
                        if (result.length == pageFiles.length) {
                            callback && callback(result);
                        }
                    });
                }
            });
        },

        parseMaster: function (masterFile, files, callback) {

            var self = this;
            //console.log(pageFile);
            masterFile.async('text').then(function (masterInfoContent) {

                var masterInfoXml = self.parseXml(masterInfoContent);
                var masterMap = {};
                var masters = masterInfoXml.childNodes[0].childNodes;
                var count = 0;
                masters.forEach(function (master, index) {

                    var id = master.getAttribute('ID');
                    var name = master.getAttribute('Name');
                    var prompt = master.getAttribute('Prompt');
                    var modelId = prompt || name;
                    modelId = self.idMap[modelId] || modelId;

                    files['visio/masters/master' + (index + 1) + '.xml'].async('text').then(function (masterContent) {

                        var masterXml = self.parseXml(masterContent);
                        var shape = masterXml.childNodes[0].childNodes[0].childNodes[0];
                        var width = self.findCellAttr(shape, 'Width');
                        var height = self.findCellAttr(shape, 'Height');
                        var scale = 1; //parseFloat(self.findCellAttr(shape, 'PageScale') || '1') * 2.54;
                        if (width && height) {
                            masterMap[id] = {
                                id: modelId,
                                width: self.toFloat(width) * scale,
                                height: self.toFloat(height) * scale,
                            }
                        }
                        count++;
                        if (count == masters.length) {
                            callback && callback(masterMap);
                        }
                    })
                })
            })
        },

        parsePage: function (pageFile, masterMap, callback) {

            var self = this;
            //console.log(pageFile);
            pageFile.async('text').then(function (pageContent) {

                var pageXml = self.parseXml(pageContent);
                var json = self.parsePageXml(pageXml, masterMap);
                callback && callback(json);
            })
        },

        /**
         * 解析所有的 page 文件
         * @param pageFile
         * @returns {*}
         */
        parsePageXml: function (pageXml, masterMap) {

            var self = this;
            //console.log(pageXml);
            //if(!pageXml.childNodes || pageXml.childNodes.length ==0){
            //    return;
            //}

            //FIXME 这里要增加必要的校验
            var shapes = pageXml.childNodes[0].childNodes[0].childNodes;

            //过滤出所有 shape 节点

            //封装json数据,遍历所有的json对象

            var jsons = [];

            //door, window
            var wallChildren = this.createWallChildren(shapes, masterMap);

            var wallPath = this.getPath(shapes, masterMap, 'wall');
            var walls = this.addWallChildren(wallPath, wallChildren, false);
            if (walls.length == 0) {
                throw '没有外墙'
            } else if (walls.length > 1) {
                throw '外墙没有闭合'
            }
            var point = this.centerPoint = this.calcCenter(walls);
            this.moveWallToCenter(walls, point);

            var innerWallPath = this.getPath(shapes, masterMap, 'innerWall');
            var innerWalls = this.addWallChildren(innerWallPath, wallChildren, true);
            this.moveWallToCenter(innerWalls, point);

            //other
            var others = this.createOther(shapes, masterMap, point);
            jsons = jsons.concat(walls);
            jsons = jsons.concat(innerWalls);
            //jsons = jsons.concat(wallChildren);
            jsons = jsons.concat(others);
            return jsons;
        },

        parseXml: function (xml) {
            if (window.DOMParser) {
                var parser = new DOMParser();
                return parser.parseFromString(xml, 'text/xml');
            } else {
                xml = xml.replace(/<!DOCTYPE svg[^>]*>/, '');
                var xmlDoc = new ActiveXObject('Microsoft.XMLDOM');
                xmlDoc.async = 'false';
                xmlDoc.loadXML(xml);
                return xmlDoc;
            }
        },

        /**
         * 计算外墙的中心点
         * @param walls
         * @returns {{x: number, y: number}}
         */
        calcCenter: function (walls) {

            var minX = 99999999,
                minY = 99999999,
                maxX = -99999999,
                maxY = -99999999;
            var len = walls.length;
            for (var i = 0; i < len; i++) {
                var wall = walls[i];
                var data = wall.data;
                for (var j = 0; j < data.length; j++) {
                    minX = Math.min(minX, data[j][0]);
                    minY = Math.min(minY, data[j][1]);
                    maxX = Math.max(maxX, data[j][0]);
                    maxY = Math.max(maxY, data[j][1]);
                }
            }
            //计算出楼层的中心点, 移动到中心点处
            var x = (minX + maxX) / 2;
            var y = (minY + maxY) / 2;
            return {
                x: x,
                y: y,
            }
        },

        /**
         * 将墙和墙的孩子移动到中心点
         * @param walls
         * @param center
         */
        moveWallToCenter: function (walls, center) {
            var len = walls.length;
            for (var i = 0; i < len; i++) {
                var wall = walls[i];

                //move point
                var data = wall.data;
                for (var j = 0; j < data.length; j++) {
                    data[j][0] -= center.x;
                    data[j][1] -= center.y;
                }
                //move children
                if (wall.children) {
                    for (var k = 0; k < wall.children.length; k++) {
                        var p = wall.children[k].position;
                        p[0] -= center.x;
                        p[2] -= center.y;
                    }
                }
            }
        },

        /**
         * 添加墙的孩子
         * @param wallPath
         * @param wallChildren
         * @returns {Array}
         */
        addWallChildren: function (wallPath, wallChildren, isInnerWall) {

            var result = [];
            for (var id in wallPath) {
                var path = wallPath[id];
                for (var i in path) {
                    var json = {
                        id: id,
                        position: [0, 0, 0],
                        children: [],
                    };
                    if (!isInnerWall) {
                        json.closed = true;
                        json.showFloor = true;
                    }
                    result.push(json);
                    var lines = path[i];
                    for (var j = 0; j < lines.length; j++) {
                        var line = lines[j];
                        if (json.data) {
                            json.data.push(line.to);
                        } else {
                            json.data = [line.from, line.to];
                        }

                        var shapeId = line.shapeId;
                        if (wallChildren[shapeId]) {
                            for (var k in wallChildren[shapeId]) {
                                var child = wallChildren[shapeId][k];
                                child.client = child.client || {};
                                child.client.edgeIndex = j;
                                if (line.reverse) {
                                    child.client.offset = 1 - child.client.offset;
                                }
                                child.position[0] = (line.to[0] - line.from[0]) * child.client.offset + line.from[0];
                                child.position[2] = (line.to[1] - line.from[1]) * child.client.offset + line.from[1];
                                json.children.push(child);
                            }
                        }
                    }
                    if (!isInnerWall && json.data && json.data.length > 1) {
                        //如果外墙最后一个点和起始点已经闭合, 去掉最后一个点
                        var p0 = json.data[0];
                        var p1 = json.data[json.data.length - 1];
                        if (p0[0] == p1[0] && p0[1] == p1[1]) {
                            json.data.splice(json.data.length - 1, 1);
                        }
                    }
                }
            }
            return result;
        },

        /**
         * 取得外墙或者内墙, 或者房间的顶点信息
         * @param shapes
         * @param masterMap
         * @param type
         */
        getPath: function (shapes, masterMap, makeType) {

            var self = this;

            var pathLineMap = {};
            var lineMap = {};
            shapes.forEach(function (shape) {

                var master = shape.getAttribute('Master');

                if (!masterMap[master]) {
                    console.error('master not exist, master=', master, '  masterMap=', masterMap, '  shape=', shape);
                    return;
                }
                var id = masterMap[master].id;
                var type = make.Default.getType(id);
                if (type == makeType) {
                    if (!pathLineMap[id]) {
                        pathLineMap[id] = [];
                    }

                    //Y 值需要取反
                    var begX = self.toFloat(self.findCellAttr(shape, 'BeginX'));
                    var begY = self.toFloat(self.findCellAttr(shape, 'BeginY')) * -1;
                    var endX = self.toFloat(self.findCellAttr(shape, 'EndX'));
                    var endY = self.toFloat(self.findCellAttr(shape, 'EndY')) * -1;
                    var width = self.toFloat(self.findCellAttr(shape, 'Width'));
                    var line = {
                        shapeId: shape.getAttribute('ID'),
                        from: [begX, begY],
                        to: [endX, endY],
                        width: width,
                        id: id,
                    };
                    //判断起始端点是否有连接到其他对象上
                    var RX1 = self.findChild(self.findChild(self.findChild(shape, 'Section', 'User'), 'Row', 'RX1'), 'Cell', 'Value');
                    var RY1 = self.findChild(self.findChild(self.findChild(shape, 'Section', 'User'), 'Row', 'RY1'), 'Cell', 'Value');
                    if (RX1 && RY1) {
                        //<Row N='RX1'>
                        //        <Cell N='Value' V='3.858267716535434' U='DL' F='Sheet.310!EndX'/>
                        //</Row>
                        var f = RX1.getAttribute('F').replace('Sheet.', '');
                        var fa = f.split('!');
                        line.fromShape = fa[0];
                        if (fa[1].indexOf('End') >= 0) {
                            line.fromTo = true;
                        } else {
                            line.fromFrom = true;
                        }

                    }
                    //判断结束端点是否有连接到其他对象上
                    var LX2 = self.findChild(self.findChild(self.findChild(shape, 'Section', 'User'), 'Row', 'LX2'), 'Cell', 'Value');
                    var LY2 = self.findChild(self.findChild(self.findChild(shape, 'Section', 'User'), 'Row', 'LY2'), 'Cell', 'Value');
                    if (LX2 && LX2) {
                        //<Row N='LX2'>
                        //        <Cell N='Value' V='7.795275590551183' U='DL' F='Sheet.317!EndX'/>
                        //</Row>
                        var f = LX2.getAttribute('F').replace('Sheet.', '');
                        var fa = f.split('!');
                        line.toShape = fa[0];
                        if (fa[1].indexOf('End') >= 0) {
                            line.toTo = true;
                        } else {
                            line.toFrom = true;
                        }
                    }
                    pathLineMap[id].push(line);
                    lineMap[line.shapeId] = line;

                    shape.dirty = true;
                }
            });

            var pathMap = {};
            //按类型分组, 拼接 line 成一条 path
            for (var id in pathLineMap) {

                var lines = pathLineMap[id];

                var path = [];
                pathMap[id] = path;
                //正向查找所有连接在一起的线路
                while (lines.length > 0) {

                    var pathLine = [];
                    var line0 = lines[0];
                    lines.splice(0, 1);
                    delete lineMap[line0.shapeId];

                    var lineModel = {
                        shapeId: line0.shapeId,
                        from: line0.from,
                        to: line0.to,
                    };
                    pathLine.push(lineModel);

                    if (lines.length > 0 && line0.fromShape && line0.toShape) {

                        //两头连接
                        walk(id, pathLine, lines, lineMap, line0, true);
                        walk(id, pathLine, lines, lineMap, line0, false);
                    } else if (lines.length > 0 && line0.fromShape) {

                        //起始点连接到其他线路
                        walk(id, pathLine, lines, lineMap, line0, false);

                    } else if (lines.length > 0 && line0.toShape) {

                        //结束点连接到其他线路
                        walk(id, pathLine, lines, lineMap, line0, true);
                    }

                    path.push(pathLine);
                }

                function reverseLine(line, isForward) {
                    var ff = line.from;
                    line.from = line.to;
                    line.to = ff;

                    if (!isForward && line.toShape) {

                        line.fromShape = line.toShape;
                        delete line.toShape;
                        line.fromFrom = line.toFrom;
                        line.fromTo = line.toTo;
                        delete line.toFrom;
                        delete line.toTo;
                    } else if (isForward && line.fromShape) {
                        line.toShape = line.fromShape;
                        delete line.fromShape;
                        line.toFrom = line.fromFrom;
                        line.toTo = line.fromTo;
                        delete line.fromFrom;
                        delete line.fromTo;
                    }
                    line.reverse = true;
                }

                /**
                 * 按指定方向, 将独立的 path 按顺序连接起来
                 * @param pathLine 保存轨迹
                 * @param lines 所有线段
                 * @param lineMap 所有线段
                 * @param line 当前线段
                 * @param isForward 正向
                 */
                function walk(id, pathLine, lines, lineMap, line, isForward) {

                    var shapeId = isForward ? line.toShape : line.fromShape;
                    if (!shapeId) {
                        return;
                    }
                    var nextLine = lineMap[shapeId];
                    if (!nextLine) {
                        return;
                    }
                    //连接的不在一个层
                    if (nextLine.id != id) {
                        return;
                    }
                    var index = lines.indexOf(nextLine);
                    lines.splice(index, 1);
                    delete lineMap[shapeId];

                    if ((isForward && line.toTo) || (!isForward && line.fromFrom)) {
                        reverseLine(nextLine, isForward);
                    }
                    var lineModel = {
                        shapeId: nextLine.shapeId,
                        from: nextLine.from,
                        to: nextLine.to,
                        reverse: nextLine.reverse,
                    };
                    if (isForward) {

                        pathLine.push(lineModel);
                    } else {
                        pathLine.splice(0, 0, lineModel);
                    }
                    walk(id, pathLine, lines, lineMap, nextLine, isForward);
                }
            }

            return pathMap;
        },

        /**
         * 创建墙的孩子
         * @param shapes
         * @param masterMap
         * @returns {Array}
         */
        createWallChildren: function (shapes, masterMap) {

            var self = this;
            var wallChildren = {};
            shapes.forEach(function (shape) {

                var master = shape.getAttribute('Master');

                if (!masterMap[master]) {
                    console.error('master not exist, master=', master, '  masterMap=', masterMap, '  shape=', shape);
                    return;
                }
                var id = masterMap[master].id;
                var type = make.Default.getType(id);
                if (type == 'door' || type == 'window') {

                    //<Cell N='Value' V='0' F='Sheet.296!User.RefLn'/>
                    var VisWallRefLn = self.findChild(self.findChild(self.findChild(shape, 'Section', 'User'), 'Row', 'VisWallRefLn'), 'Cell', 'Value');
                    var PreviousWallParam = self.findChild(self.findChild(self.findChild(shape, 'Section', 'User'), 'Row', 'PreviousWallParam'), 'Cell', 'Value');
                    var f = VisWallRefLn.getAttribute('F').replace("Sheet.", "");
                    var fa = f.split('!');
                    var parentId = fa[0];
                    var offset = parseFloat(PreviousWallParam.getAttribute('V'));
                    var positionY = self.positionYMap[type] || 0;
                    var width = self.toFloat(self.findCellAttr(shape, 'Width'));
                    var x = self.toFloat(self.findCellAttr(shape, 'PinX'));
                    var y = self.toFloat(self.findCellAttr(shape, 'PinY')) * -1;
                    //FIXME 需要计算 offset, 否则无法在 doodle 的2D 视图中显示
                    if (!wallChildren[parentId]) {
                        wallChildren[parentId] = [];
                    }
                    wallChildren[parentId].push({
                        id: id,
                        width: width,
                        position: [x, positionY, y],
                        client: {
                            offset: offset
                        }
                    });
                    shape.dirty = true;
                }
            });
            return wallChildren;
        },

        createOther: function (shapes, masterMap, center) {

            var self = this;
            var objects = [];
            shapes.forEach(function (shape) {

                var master = shape.getAttribute('Master');

                if (!masterMap[master]) {
                    console.error('master not exist, master=', master, '  masterMap=', masterMap, '  shape=', shape);
                    return;
                }
                var id = masterMap[master].id;
                var type = make.Default.getType(id);
                if (type == 'wall' || type == 'innerWall' || type == 'door' || type == 'window') {

                    //
                } else {

                    var object = {};
                    object.id = id;
                    var mp = masterMap[master];
                    var positionY = self.positionYMap[type] || 'floor-top';
                    var width = self.toFloat(self.findCellAttr(shape, 'Width')) || mp.width;
                    var height = self.toFloat(self.findCellAttr(shape, 'Height')) || mp.height;
                    var x = self.toFloat(self.findCellAttr(shape, 'PinX'));
                    var y = self.toFloat(self.findCellAttr(shape, 'PinY')) * -1;
                    var angle = self.toFloat(parseFloat(self.findCellAttr(shape, 'Angle') || '0') * 180 / Math.PI, true);
                    //angle *= -1;
                    angle = (angle + 360) % 360;
                    var Text = self.findChildByTag(shape, 'Text');
                    if (Text) {
                        var children = Text.childNodes;
                        for (var i = 0; i < children.length; i++) {
                            if (children[i].nodeType == 3) {
                                var s = children[i].textContent;
                                if (s.indexOf('\n') == s.length - 1) {
                                    s = s.substr(0, s.length - 1);
                                }
                                object.objectId = s;
                                object.client = object.client || {};
                                object.client.bid = s;
                            }
                        }
                    }
                    object.width = width;
                    object.depth = height;
                    object.position = [x - center.x, positionY, y - center.y];
                    object.rotation = [0, angle, 0];
                    objects.push(object);
                }
            });
            return objects;
        },

        /**
         * 找到指定的属性值
         * @param shape
         * @param name
         * @returns {string}
         */
        findCellAttr: function (shape, name) {

            var children = shape.childNodes;
            var length = children.length;
            for (var i = 0; i < length; i++) {
                var child = children[i];
                if (child.tagName == 'Cell' && child.getAttribute('N') == name) {
                    return child.getAttribute('V');
                }
            }
        },

        /**
         * 找到指定类型的孩子
         * @param parent
         * @param tagName
         * @param filter
         * @returns {*}
         */
        findChild: function (parent, tagName, name) {

            if (!parent) {
                return;
            }
            var children = parent.childNodes;
            if (!children) {
                return;
            }
            var length = children.length;
            for (var i = 0; i < length; i++) {
                var child = children[i];
                if (child.tagName == tagName && child.getAttribute('N') == name) {
                    return child;
                }
            }
        },

        /**
         * 找到指定类型的孩子
         * @param parent
         * @param tagName
         * @returns {*}
         */
        findChildByTag: function (parent, tagName) {

            if (!parent) {
                return;
            }
            var children = parent.childNodes;
            if (!children) {
                return;
            }
            var length = children.length;
            for (var i = 0; i < length; i++) {
                var child = children[i];
                if (child.tagName == tagName) {
                    return child;
                }
            }
        },

        toFloat: function (v, isSkip, n) {
            if (n === undefined) {
                n = 0;
            }
            var f = parseFloat(v);
            if (!isSkip) {
                f = f * this.scale;
            }
            var s = Math.pow(10, n);
            return Math.round(f * s) / (s * 1.0);
        }
    })


    nsp.edit.JsonBox = function () {
        this._dataList = new mono.List();
        this._dataMap = {};

        this._dataBoxChangeDispatcher = new TGL.EventDispatcher();
        this._dataPropertyChangeDispatcher = new TGL.EventDispatcher();
    };

    twaver.Util.ext(nsp.edit.JsonBox, Object, {
        add: function (data) {
            if (!data) {
                return;
            }
            if (arguments.length === 1) {
                index = -1;
            }
            var id = data.getObjectId();
            if (this._dataMap.hasOwnProperty(id)) {
                throw "Data with ID '" + id + "' already exists";
            }
            this._dataList.add(data);
            this._dataMap[id] = data;
            this._dataBoxChangeDispatcher.fire({
                kind: 'add',
                data: data,
                source: this
            });
            data.addPropertyChangeListener(this.handleDataPropertyChange, this);
        },

        contains: function (data) {
            if (data) {
                return this._dataMap[data.getObjectId()] === data;
            }
            return false;
        },

        remove: function (data) {
            if (!data) {
                return;
            }
            this._dataList.remove(data);
            var id = data.getObjectId();
            delete this._dataMap[id];

            this._dataBoxChangeDispatcher.fire({
                kind: 'remove',
                data: data,
                source: this
            });
            data.removePropertyChangeListener(this.handleDataPropertyChange, this);
        },

        getDataById: function (id) {
            return this._dataMap[id];
        },

        removeById: function (id) {
            var data = this.getDataById(id);
            this.remove(data);
        },

        getDatas: function () {
            return this._dataList;
        },

        clear: function (l) {
            if (this._dataList.size() > 0) {
                var datas = this._dataList.toList();
                datas.forEach(function (data) {
                    data.removePropertyChangeListener(this.handleDataPropertyChange, this);
                }, this);
                this._dataList.clear();
                this._dataMap = {};
                this._dataBoxChangeDispatcher.fire({
                    kind: 'clear',
                    datas: datas
                });

            }
        },

        toJson: function (filter) {
            var jsonObject = [];
            var datas = this._dataList;
            // return JSON.stringify(array);
            datas.forEach(function (data) {
                var id = data.getId();
                if (id == 'twaver.idc.door' || id == 'twaver.idc.window') {
                    return;
                }

                var dataObject = {};
                data.serializeJson(data, dataObject);
                if (!filter || filter(data)) {
                    jsonObject.push(dataObject);
                }
            });
            return jsonObject;
        },

        fromJson: function (datas) {

            for (var i = 0; i < datas.length; i++) {
                var dataObject = datas[i];
                var data = null;
                if (dataObject.action === "remove") {
                    this.removeById(dataObject.objectId);
                    continue;
                }
                // update old data
                data = this.getDataById(dataObject.objectId);
                // create new data
                if (!data) {
                    //data = TGL.newInstance(type, dataObject.objectId);
                    data = new nsp.edit.data.JsonObject();
                    data.id = dataObject.objectId;
                }
                data.deserializeJson(data, dataObject);
                if (dataObject.children && dataObject.children.length > 0) {
                    var childrenData = [];
                    for (var j = 0; j < dataObject.children.length; j++) {
                        var child = dataObject.children[j];
                        var childData = new nsp.edit.data.JsonObject(child.objectId);
                        childData.id = child.objectId;
                        childData.deserializeJson(childData, child);
                        childrenData.push(childData);
                    }
                    data.setChildren(childrenData);
                }
                try {
                    this.add(data);
                } catch (e) {
                    console.error(e);
                }

            }
        },

        handleDataPropertyChange: function (e) {
            var data = e.source;
            this.onDataPropertyChanged(data, e);
            this._dataPropertyChangeDispatcher.fire(e);
        },

        onDataPropertyChanged: function (data, e) {

        },

        addDataBoxChangeListener: function (listener, scope, ahead) {
            this._dataBoxChangeDispatcher.add(listener, scope, ahead);
        },

        removeDataBoxChangeListener: function (listener, scope) {
            this._dataBoxChangeDispatcher.remove(listener, scope);
        },

        addDataPropertyChangeListener: function (listener, scope, ahead) {
            this._dataPropertyChangeDispatcher.add(listener, scope, ahead);
        },

        removeDataPropertyChangeListener: function (listener, scope) {
            this._dataPropertyChangeDispatcher.remove(listener, scope);
        },
    });

    /**
     * 场景编辑器
     * 3D场景编辑器，在2D视图中编辑， 3D视图中浏览。默认2D和3D中的模型对应关系是，2D的模型的id等于3D模型的ID加上'.top',doodle.utils和doodle.consts中都有介绍。
     * @param parentView {HTMLDIVElement} 编辑器父容器
     * @constructor
     */
    var SceneEditor = function (parentView) {


        SceneEditor.superClass.constructor.call(this, parentView);

        this.pasteOffsetDy = 0;

        this.contentPane3d = $('<div class="edit3d-container"></div>').appendTo(this.parentView);

        /**
         * scene editor data box
         * 场景编辑器的数据容器
         * @type {nsp.edit.JsonBox}
         */
        this.jsonBox = new nsp.edit.JsonBox();

        /**
         * scene editor 2d view
         * 场景编辑器2d视图, 参照twaver 2D相关知识
         * @type {nsp.edit.Edit2D}
         */
        this.edit2d = this.edit2d = new nsp.edit.Edit2D(this.jsonBox, this);

        /**
         * scene editor 3d view
         * 场景编辑器的3d视图，参照twaver 3D相关知识
         * @type {nsp.edit.Edit3D}
         */
        this.edit3d = new nsp.edit.Edit3D(this.jsonBox, this);

        /**
         * 3d mapping to 2d
         * 3d模型映射到2d模型
         * @type {Object}
         */
        this.model3dTo2dMapping = $consts.sceneEditorModel3dTo2dMapping;

        /**
         * 2d mapping to 3d
         * 2d模型映射到3d模型
         * @type {Object}
         */
        this.model2dTo3dMapping = $consts.sceneEditorModel2dTo3dMapping;

        /**
         * component bar
         * 左侧组件栏
         * @type {doodle.AccordionPane}
         */
        this.accordionPane = this.edit2d.accordionPane;
        this.ruler = this.edit2d.ruler;
        this.network2d = this.edit2d.network2d;
        this.box = this.network2d.getElementBox();

        this.fileIndex = 1;

        this.init();
    }

    SceneEditor.prototype = {

        init: function () {

            var self = this;

            this.edit3d.doubleClickHandler = function (element, box) {
                self.doubleClickHandler3D(element, box);
            }
            this.edit2d.doubleClickRackHandler = function (element, box) {
                self.doubleClickHandler2D(element, box);
            }

            this.addKeyMoveListener(this.network2d);

            // this.refreshAccordion();             //这一句不需要调用在实例化的时候调用
            this.adjustNetwork3dBoundingBox();

            this.show2D();
            this.hide3D();
        },

        adjustNetwork3dBoundingBox: function () {
            mono.Utils.autoAdjustNetworkBounds(this.edit3d.network3d, this.contentPane3d[0], 'clientWidth', 'clientHeight', 0, 0);
        },


        /**
         * double click 3d handler
         * 双击3D对象事件处理
         * @param element {mono.Data} 3d 对象
         * @param box {mono.DataBox} 3d 的 DataBox
         */
        doubleClickHandler3D: function (element, box) {

        },

        /**
         * double click 2d handerl
         * 双击2D对象事件处理
         * @param element {twaver.Data} 2d 对象
         * @param box {twaver.ElementBox} 2d 的 ElementBox
         */
        doubleClickHandler2D: function (element, box) {

        },
        isHost: function (node) {
            return node.getClient('type') == 'wall';
        },

        /**
         * load dxf file
         * 加载dxf的文件内容
         * @param text {string} dxf文件内容
         */
        loadDxfFile: function (text, filter, autoCreateId) {
            var edit2d = this.edit2d;
            var importDxf = new nsp.edit.ImportDxf(0.1);

            var jsons = importDxf.loadDxf(text, autoCreateId);
            if (filter) {
                jsons = filter(jsons);
            }
            jsons.sort(function (o1, o2) {
                if (make.Default.getOtherParameter(o1.id, 'sdkCategory') == 'floor') {
                    return -1;
                } else {
                    return 1;
                }
            });
            edit2d.createNodesByJson(jsons);
            setTimeout(function () {
                edit2d.zoomOverview();
            }, 500);
        },

        loadVsdxFile: function (text, filter, autoCreateId) {
            var edit2d = this.edit2d;
            var importVsdx = new ImportVsdx();
            importVsdx.loadVsdx(text, function (result) {
                var jsons = result[0];
                if (filter) {
                    jsons = filter(jsons);
                }
                jsons.sort(function (o1, o2) {
                    if (make.Default.getOtherParameter(o1.id, 'sdkCategory') == 'floor') {
                        return -1;
                    } else {
                        return 1;
                    }
                });
                edit2d.createNodesByJson(jsons);
                setTimeout(function () {
                    edit2d.zoomOverview();
                }, 500);
            });
        },

        parentResizeHandle: function () {
            SceneEditor.superClass.parentResizeHandle.call(this);
            this.adjustNetwork3dBoundingBox();
        },

        /**
         * align selected data
         * 对齐选中的元素
         * @param type{string} 枚举[left, right, top, bottom, center, middle]
         */
        align: function (type) {
            var self = this;
            if (!type) {
                return;
            }
            var data = this.edit2d.box.getSelectionModel().getSelection();

            //去除选中的parent
            var list = new twaver.List();
            data.forEach(function (node) {
                if (node && !self.isHost(node)) {
                    list.add(node);
                }
            })
            if (!list || list.size() < 2) {
                return;
            }
            make.Default.align(list, type);
        },

        /**
         * flow selected data
         * 均匀分布选中的元素
         * @param type {string} 枚举[hor, ver]
         * @param padding {number} 间距
         */
        flow: function (type, padding) {
            var self = this;
            if (!type) {
                return;
            }
            var data = this.edit2d.box.getSelectionModel().getSelection();
            //去除选中的parent
            var list = new twaver.List();
            data.forEach(function (node) {
                if (node && !self.isHost(node)) {
                    list.add(node);
                }
            })
            if (!list || list.size() < 2) {
                return;
            }
            make.Default.flow(list, type, padding);
        },

        /**
         * refresh accordion
         * 刷新左侧组件栏, 默认是调用doodle.utils.load2dSceneCategory()的结果
         * @param categories {Object[]} default is the result of calling function doodle.utils.load2dSceneCategory()
         */
        refreshAccordion: function (categories) {
            categories = categories || doodle.utils.load2dSceneCategory();
            this.edit2d.accordionPane.setCategories(categories);
        },

        /**
         * show 2d view
         * 显示2D视图
         */
        show2D: function () {
            this.contentPane.show();
            this.edit2d.layoutGUI();
        },

        /**
         * hide 2d view
         * 隐藏2d视图
         */
        hide2D: function () {
            this.contentPane.hide();
        },

        /**
         * show 3d view
         * 显示3D视图
         */
        show3D: function () {
            this.contentPane3d.show();
            this.adjustNetwork3dBoundingBox();
            this.edit3d.refreshNetwork3d();
        },

        /**
         * hide 3d view
         * 隐藏 3d 视图
         */
        hide3D: function () {
            this.contentPane3d.hide();
            this.edit3d.box.clear();
        },

        zoomOverview: function () {
            this.edit2d.zoomOverview();
        },

        /**
         * 取得编辑结果
         * @param isRelative 是否以相对位置导出,默认用绝对位置
         * @returns {Array}
         */
        getData: function (isRelative) {

            var self = this;
            var jsonObjects = this.jsonBox.toJson();
            if (isRelative) {
                var result = [];
                jsonObjects.forEach(function (jsonObject) {
                    var item = {};
                    make.Default.copyProperties(jsonObject, item);
                    var parentId = item.parentId;
                    var parent = self.jsonBox.getDataById(parentId);
                    if (parent) {
                        parent.position = parent.position || [0, 0, 0];
                        item.position = item.position || [0, 0, 0];
                        item.position[0] -= parent.position[0];
                        item.position[2] -= parent.position[2];
                    }
                    result.push(item);
                });
                return result;
            } else {
                return jsonObjects;
            }
        },

        /**
         * 设置数据
         * @param jsonObjects
         * @param isRelative 是否以相对位置导入,默认是绝对位置
         */
        setData: function (jsonObjects, isRelative) {

            var self = this;
            var map = {};
            if (isRelative) {
                jsonObjects.forEach(function (item) {
                    if (item.objectId) {
                        map[item.objectId] = item;
                    }
                })
                jsonObjects.forEach(function (item) {
                    var parentId = item.parentId;
                    var parent = map[parentId];
                    if (!parent) {
                        parent = self.jsonBox.getDataById(parentId);
                    }
                    if (parent) {
                        parent.position = parent.position || [0, 0, 0];
                        item.position = item.position || [0, 0, 0];
                        item.position[0] += parseFloat(parent.position[0] ? parent.position[0] : 0);
                        item.position[2] += parseFloat(parent.position[2] ? parent.position[2] : 0);
                    }
                })
            }
            this.jsonBox.fromJson(jsonObjects);

            setTimeout(function () {
                self.zoomOverview();
            }, 100);
        },
        getSelectedData: function () {
            var nodes = this.edit2d.box.getSelectionModel().getSelection();
            if (!nodes || nodes.size() == 0) {
                return [];
            }
            var copyDatas = [];
            for (var i = 0; i < nodes.size(); i++) {
                var node = nodes.get(i);
                var jsonObject = this.jsonBox.getDataById(node.getId());
                if (jsonObject) {
                    copyDatas.push(jsonObject);
                } else {
                    console.warn('jsonObject is null, node.id=' + node.getId());
                }
            }
            return copyDatas;
        },
        getSelectedNode: function () {
            var nodes = this.edit2d.box.getSelectionModel().getSelection();
            if (!nodes || nodes.size() == 0) {
                return [];
            }
            return nodes.toArray();
        },
        appendData: function (data) {
            return this.jsonBox.add(data);
        },
        removeData: function (data) {
            var self = this;
            if (data instanceof Array) {
                return data.map(function (item) {
                    return self.jsonBox.removeById(item.objectId)
                })
            } else {
                return self.jsonBox.removeById(data.objectId)
            }
        },
        removeNode: function (node) {
            var self = this;
            if (node instanceof Array) {
                return node.map(function (item) {
                    return self.box.removeById(item.getId())
                })
            } else {
                return self.box.removeById(node.getId())
            }
        },
        clear: function () {
            this.jsonBox.clear();
        },
        /**
         * 批量生成编号
         * @param  type 表示编号生成的规则,默认值t-l-l，8种取值，分别是
         * t-l-l,t-l-s, t-r-l,t-r-s, b-l-l,b-l-s, b-r-l,b-r-s
         * Abbr, t: top, b: bottom, l: left, r: right, l: 表示一字形, s: 表示S形
         * @param  start 编号的起始值，默认值1
         * @param  toleRance 判断Node是否在同一行的误差范围，默认值15
         * @param  prefix 编号的前缀
         * @param  suffix 编号的后缀
         * @param  coreNumLen 编号数字部分的长度，默认2，例如01，02
         * @param  includeRow 是否包含包含排的编号，默认值true
         * @param  rowPrefix 排编号的后缀
         * @param  rowSuffix 排编号的后缀
         * @param  rowNumLen 排编号数字部分的长度，默认2，例如01，02
         * @param  separator 如果包含排的编号，那么排编号与资产之间的分隔符，默认'-'
         */
        genIds: (function (opt) {
            var autoNums = []; //缓存所有的编号，用于排除重复的编号

            return function (opt) {
                opt = opt || {};
                type = opt.type || 't-l-l';
                start = opt.start || 1;
                toleRance = opt.toleRance || 15;
                prefix = opt.prefix || '';
                suffix = opt.suffix || '';
                coreNumLen = opt.coreNumLen || 2;
                includeRow = opt.includeRow;
                rowPrefix = opt.rowPrefix || '';
                rowSuffix = opt.rowSuffix || '';
                rowNumLen = opt.rowNumLen || 2;
                separator = opt.separator || '-';

                var list = this.box.getSelectionModel().getSelection();
                if (!list.size()) return 'no selection';

                var types = type.split('-');
                var rows = {},
                    node, pv, keys, type1 = types[0],
                    p = type1 == 't' || type1 == 'b' ? 'y' : 'x';
                for (var i = 0; i < list.size(); i++) {
                    node = list.get(i);
                    pv = Math.round(node.getLocation()[p]);
                    keys = Object.keys(rows);
                    if (!keys.length) {
                        rows[pv] = [node];
                    } else {
                        var cached = false;
                        for (var key in rows) {
                            if (Math.abs(pv - parseInt(key)) <= toleRance) {
                                rows[key].push(node);
                                cached = true;
                                break;
                            }
                        }
                        if (!cached) {
                            rows[pv] = [node];
                        }
                    }
                }
                keys = Object.keys(rows);
                if (type1 == 't' || type1 == 'l') {
                    keys.sort();
                } else if (type1 == 'b' || type1 == 'r') {
                    keys.sort(function (a, b) {
                        return b - a;
                    });
                }
                var type2 = types[1],
                    p = type2 == 't' || type2 == 'b' ? 'y' : 'x';
                if (type2 == 'l' || type2 == 't') {
                    for (var key in rows) {
                        rows[key].sort(function (a, b) {
                            return a.getLocation()[p] - b.getLocation()[p];
                        });
                    }
                } else if (type2 == 'r' || type2 == 'b') {
                    for (var key in rows) {
                        rows(key).sort(function (a, b) {
                            return b.getLocation()[p] - a.getLocation()[p];
                        });
                    }
                }
                var type3 = types[2];
                if (type3 == 's') {
                    for (var i = 0; i < keys.length; i++) {
                        if (i % 2 !== 0) {
                            if (type2 == 'l' || type2 == 't') {
                                rows[keys[i]].sort(function (a, b) {
                                    return b.getLocation()[p] - a.getLocation()[p];
                                });
                            } else if (type2 == 'r' || type2 == 'b') {
                                rows[keys[i]].sort(function (a, b) {
                                    return a.getLocation()[p] - b.getLocation()[p];
                                });
                            }

                        }
                    }
                }
                var rowId = '';

                keys.forEach(function (key, index) {
                    row = rows[key];
                    if (includeRow) {
                        rowId = rowPrefix + $utils.padStart(index + 1, rowNumLen) + rowSuffix;
                    }
                    row.forEach(function (node) {
                        var bidNum = prefix + (includeRow ? rowId + separator : "") + ($utils.padStart(start++, coreNumLen)) + suffix;
                        if (autoNums.indexOf(bidNum) >= 0) {
                            layer.msg(it.util.i18n('Admin_sceneEditor_UniqueNum'), { icon: 2 });
                            return;
                        }
                        node.setClient('bid', bidNum);
                        autoNums.push(bidNum);
                    });
                });
            }

        }())
    }

    doodle.SceneEditor = SceneEditor;

    doodle.utils.ext(SceneEditor, Editor);
    var $JsonObject = nsp.edit.data.JsonObject = function (params) {
        twaver.PropertyChangeDispatcher.call(this);
        params = params || {};
        this.objectId = params.objectId || doodle.id("JsonObject")
        this.name = params.name;
        this.id = params.id;
        this.radius = params.radius;
        this.width = params.width;
        this.height = params.height;
        this.depth = params.depth;
        this.position = params.position;
        this.rotation = params.rotation;
        this.color = params.color;
        this.data = params.data;
        this.client = params.client || {};
        this.style = params.style || {};
        this.children = params.children;
        this.parentId = params.parentId; //节点的父亲节点
    };

    twaver.Util.ext($JsonObject, twaver.PropertyChangeDispatcher, {
        _init: function () {

        },
        _a: function () {

        },
        getObjectId: function () {
            return this.objectId;
        },

        getId: function () {
            return this.id;
        },

        setId: function (id) {
            var oldValue = this.id;
            if (oldValue != id) {
                this.id = id;
                this.firePropertyChange("id", oldValue, id);
            }
        },

        getColor: function () {
            return this.color;
        },

        setColor: function (newValue) {
            var oldValue = this.color;
            if (oldValue != newValue) {
                this.color = newValue;
                this.firePropertyChange("radius", oldValue, newValue);
            }
        },

        getParentId: function () {
            return this.parentId;
        },

        setParentId: function (newValue) {
            var oldValue = this.parentId;
            if (oldValue != newValue) {
                this.parentId = newValue;
                this.firePropertyChange("parentId", oldValue, newValue);
            }
        },

        getWidth: function () {
            return this.width;
        },

        setWidth: function (width) {
            var oldValue = this.width;
            if (oldValue != width) {
                this.width = width;
                this.firePropertyChange("width", oldValue, width);
            }
        },

        getHeight: function () {
            return this.height;
        },

        setHeight: function (height) {
            var oldValue = this.height;
            if (oldValue != height) {
                this.height = height;
                this.firePropertyChange("height", oldValue, height);
            }
        },

        getDepth: function () {
            return this.depth;
        },

        setDepth: function (depth) {
            var oldValue = this.depth;
            if (oldValue != depth) {
                this.depth = depth;
                this.firePropertyChange("depth", oldValue, depth);
            }
        },

        getWallHeight: function () {
            return this.wallHeight;
        },

        setWallHeight: function (wallHeight) {
            var oldValue = this.wallHeight;
            if (oldValue != wallHeight) {
                this.wallHeight = wallHeight;
                this.firePropertyChange("wallHeight", oldValue, wallHeight);
            }
        },

        getName: function () {
            return this.name;
        },

        setName: function (name) {
            var oldValue = this.name;
            if (oldValue != name) {
                this.name = name;
                this.firePropertyChange("name", oldValue, name);
            }
        },

        isClosed: function () {
            return this.closed;
        },

        setClosed: function (closed) {
            var oldValue = this.closed;
            if (oldValue != closed) {
                this.closed = closed;
                this.firePropertyChange("closed", oldValue, closed);
            }
        },

        isShowFloor: function () {
            return this.showFloor;
        },

        setShowFloor: function (showFloor) {
            var oldValue = this.showFloor;
            if (oldValue != showFloor) {
                this.showFloor = showFloor;
                this.firePropertyChange("showFloor", oldValue, showFloor);
            }
        },

        getPosition: function () {
            return this.position;
        },

        setPosition: function (position) {
            var oldValue = this.position;
            if (oldValue != position) {
                this.position = position;
                this.firePropertyChange("position", oldValue, position);
            }
        },

        getRotation: function () {
            return this.rotation;
        },

        setRotation: function (rotation) {
            var oldValue = this.rotation;
            if (oldValue != rotation) {
                this.rotation = rotation;
                this.firePropertyChange("rotation", oldValue, rotation);
            }
        },

        getData: function () {
            return this.data;
        },

        setData: function (data) {
            var oldValue = this.data;
            if (oldValue != data) {
                this.data = data;
                this.firePropertyChange("data", oldValue, data);
            }
        },

        getClient: function () {
            return this.client;
        },

        setClient: function (client) {
            var oldValue = this.client;
            if (oldValue != client) {
                this.client = client;
                this.firePropertyChange("client", oldValue, client);
            }
        },

        getStyle: function () {
            return this.style;
        },

        setStyle: function (style) {
            var oldValue = this.style;
            if (oldValue != style) {
                this.style = style;
                this.firePropertyChange("style", oldValue, style);
            }
        },

        getChildren: function (children) {
            return this.children;
        },

        setChildren: function (children) {
            var oldValue = this.children;
            if (oldValue != children) {
                this.children = children;
                this.firePropertyChange("children", oldValue, children);
            }
        },

        /**
         * 序列化对象
         * @param newInstance
         * @param dataObject
         */
        serializeJson: function (newInstance, dataObject) {
            //序列化通用值
            this._serializeJsonCommon(newInstance, dataObject);

            this._serializeJsonType(dataObject);

            //删除通用的属性
            if (dataObject.client) {
                delete dataObject.client['id'];
                delete dataObject.client['objectId'];
                delete dataObject.client['parentId'];
            }
        },

        _serializeJsonCommon: function (newInstance, dataObject) {
            this.serializePropertyJson("id", newInstance, dataObject);
            this.serializePropertyJson("objectId", newInstance, dataObject);
            this.serializePropertyJson("parentId", newInstance, dataObject);
            this.serializePropertyJson("name", newInstance, dataObject);
            this.serializePropertyJson("width", newInstance, dataObject);
            this.serializePropertyJson("wallHeight", newInstance, dataObject);
            this.serializePropertyJson("height", newInstance, dataObject);
            this.serializePropertyJson("depth", newInstance, dataObject);
            if (newInstance['position'] && newInstance['position'].toString() != "0,0,0") {
                this.serializePropertyJson("position", newInstance, dataObject);
            }
            if (newInstance['rotation'] && newInstance['rotation'] != "0,0,0") {
                this.serializePropertyJson("rotation", newInstance, dataObject);
            }
            this.serializePropertyJson("data", newInstance, dataObject);
            this.serializePropertyJson("radius", newInstance, dataObject);
            this.serializePropertyJson("closed", newInstance, dataObject);
            this.serializePropertyJson("showFloor", newInstance, dataObject);
            this.serializePropertyJson("client", newInstance, dataObject);
            this.serializePropertyJson("style", newInstance, dataObject);
            this.serializePropertyJson("color", newInstance, dataObject);
            this.serializeArray("children", newInstance, dataObject);
        },

        /**
         * 按类型序列化json
         * @param dataObject
         * @private
         */
        _serializeJsonType: function (json) {
            var type = make.Default.getType(json.id);
            if (!serializeMap[type]) {
                return;
            }
            var fieldMap = serializeMap[type];
            var clientFields = fieldMap.client || {};
            var styleFields = fieldMap.style || {};

            var client = json.client || {};
            var style = json.style || {};

            for (var name in clientFields) {

                var fieldName = clientFields[name];
                if (client[name] !== undefined) {
                    json[fieldName] = client[name];
                    delete client[name];
                }
            }

            for (var name in styleFields) {

                var fieldName = styleFields[name];
                if (style[name] !== undefined) {
                    json[fieldName] = style[name];
                    delete style[name];
                }
            }
        },

        serializeArray: function (name, newInstance, dataObject) {
            var children = newInstance[name];
            var childrenDatas = [];
            if (children && children instanceof Array && children.length > 0) {
                for (var i = 0; i < children.length; i++) {
                    var childrenData = {};
                    this.serializeJson(children[i], childrenData);
                    childrenDatas.push(childrenData);
                }
                dataObject[name] = childrenDatas;
            }
        },

        serializePropertyJson: function (property, newInstance, dataObject) {
            if (newInstance[property]) {

                dataObject[property] = $utils.clone(newInstance[property]);
            }
        },

        deserializeJson: function (newInstance, json) {
            this._deserializeJsonType(json);
            for (var name in json) {

                this.deserializePropertyJson(newInstance, json[name], name);
            }

        },

        deserializePropertyJson: function (newInstance, value, property) {
            newInstance[property] = $utils.clone(value);
        },

        /**
         * 按类型反序列化json
         * @param newInstance
         * @param dataObject
         * @private
         */
        _deserializeJsonType: function (json) {
            var type = make.Default.getType(json.id);
            if (!serializeMap[type]) {
                return;
            }
            var fieldMap = serializeMap[type];
            var clientFields = fieldMap.client || {};
            var styleFields = fieldMap.style || {};

            var client = json.client || {};
            var style = json.style || {};

            for (var name in clientFields) {

                var fieldName = clientFields[name];
                if (json[fieldName] !== undefined) {
                    client[name] = json[fieldName];
                    delete json[fieldName];
                }
            }

            for (var name in styleFields) {

                var fieldName = styleFields[name];
                if (json[fieldName] !== undefined) {
                    style[name] = json[fieldName];
                    delete json[fieldName];
                }
            }
            json.client = client;
            json.style = style;
        },

        clone: function () {
            var object3d = new $JsonObject();
            make.Default.copyProperties(this, object3d);
            return object3d;
        }

    });

    /* 定义不同类型的模型需要序列化的特殊属性 */
    var serializeMap = doodle.serializeMap = {
            channel: {
                client: {
                    'rackWidth': 'rackWidth',
                    'rackDepth': 'rackDepth',
                    'rackHeight': 'rackHeight',
                    'rackNumber': 'rackNumber',
                    'isSingle': 'isSingle',
                    'side': 'side',
                    'aisleDepth': 'aisleDepth'
                },
                style: {},
                isRemain: false,
            },
            area: {
                client: { 'label': 'label', 'opacity': 'opacity' },
                style: {
                    'label.xoffset': 'labelPositionX',
                    'label.yoffset': 'labelPositionZ',
                    'label.color': 'labelColor',
                    'label.font': 'labelFont'
                },
                isRemain: false,
            },
            innerWall: {
                client: {
                    insideRepeat: 'insideRepeat',
                    outsideRepeat: 'outsideRepeat',
                    reverse: 'reverse' //墙是否需要反转
                }
            }
        }
        /**
         * @private
         * @param network
         * @param typeOrShapeNodeFunction
         * @constructor
         */
    var MyCreateShapeNodeInteraction = nsp.edit.interaction.MyCreateShapeNodeInteraction = function (network, typeOrShapeNodeFunction) {
        nsp.edit.interaction.MyCreateShapeNodeInteraction.superClass.constructor.call(this, network, typeOrShapeNodeFunction);
    }

    twaver.Util.ext(nsp.edit.interaction.MyCreateShapeNodeInteraction, twaver.vector.interaction.CreateShapeNodeInteraction, {

        handle_mousedown: function (e) {
            if (e.button !== 0) {
                return;
            }
            var point = this.currentPoint || this.network.getLogicalPoint2(e);
            if (!point) {
                return;
            }
            if (e.detail === 2) {
                if (this.points.size() > 2) {
                    var shapeNode = this.shapeNodeFunction(this.points);
                    if (!shapeNode) return;
                    this.network.addElementByInteraction(shapeNode);
                    this.clear();
                    var self = this;
                    setTimeout(function () {
                        self.network.setEditingElement(false);
                    }, 0);
                }
            } else {
                if (!this.network.isEditingElement()) {
                    this.network.setEditingElement(true);
                }
                if (!this.points) {
                    this.points = new twaver.List();
                }
                if (this.points.size() > 0) {
                    var lastPoint = this.points.get(this.points.size() - 1);
                    if (lastPoint.x === point.x && lastPoint.y === point.y) {
                        return;
                    }
                }
                this.points.add(point);
            }
            this.repaint();
        },
        handle_mousemove: function (e) {
            if (this.points) {
                var lastPoint = this.points.get(this.points.size() - 1);
                var currPoint = this.network.getLogicalPoint2(e);
                //如果按住了ctrl键,允许任意打点,否则只能水平或竖直
                if (!_twaver.isCtrlDown(e)) {
                    var dx = currPoint.x - lastPoint.x;
                    var dy = currPoint.y - lastPoint.y;
                    if (Math.abs(dx) >= Math.abs(dy)) {
                        //水平
                        currPoint.y = lastPoint.y;
                    } else {
                        //竖直
                        currPoint.x = lastPoint.x;
                    }
                }
                this.currentPoint = currPoint;
                this.repaint();
            }
        },
    });
    nsp.edit.interaction.RoomDragInteraction = function (network, propertySheetPane, jsonBox) {
        nsp.edit.interaction.RoomDragInteraction.superClass.constructor.call(this, network);
        this.propertySheetPane = propertySheetPane;
        this.jsonBox = jsonBox;
    }


    twaver.Util.ext(nsp.edit.interaction.RoomDragInteraction, twaver.vector.interaction.BaseInteraction, {
        setUp: function () {
            this.addListener('mousedown', 'mousemove', 'mouseup', 'dragover', 'drop', 'dblclick');
        },
        tearDown: function () {
            this.removeListener('mousedown', 'mousemove', 'mouseup', 'dragover', 'drop', 'dblclick');
        },

        handle_dblclick: function (e) {

        },

        //get element by mouse event, set lastElement as WallShapeNode
        handle_dragover: function (e) {
            if (e.preventDefault) {
                e.preventDefault();
            } else {
                e.returnValue = false;
            }
            e.dataTransfer.dropEffect = 'copy';

            // var element = this.network.getElementAt(e);
            var MIN_OFFSET = 300; //门窗在墙附近三百的距离吸附
            var p = this.network.getLogicalPoint(e);
            var elements = this.network.getElementsAtRect({ x: p.x - MIN_OFFSET / 2, y: p.y - MIN_OFFSET / 2, width: MIN_OFFSET, height: MIN_OFFSET }, true);
            var element;
            for (var i = 0; i < elements.size(); i++) {
                if (elements.get(i) instanceof make.Default.WallShapeNode) {
                    element = elements.get(i);
                }
            }
            if (!element) return;
            if (this.network.lastElement && this.network.lastElement !== element) {
                if (this.network.lastElement instanceof make.Default.WallShapeNode) {
                    this.network.lastElement.setClient('focusIndex', -1);
                }
                this.network.lastElement = null;
            }
            //if mouse over a shapenode side, set focus index for shapenode and set lastelement as this shapenode
            if (element instanceof make.Default.WallShapeNode) {
                var point = this.network.getLogicalPoint(e); //getLogicalPosition(e) 2015-01-04
                var index = element.getPointIndex(point, MIN_OFFSET);
                element.setClient('focusIndex', index);
                if (index >= 0) {
                    this.network.lastElement = element;
                }
            } else {
                this.network.lastElement = null;
            }
            return false;
        },

        handle_drop: function (e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            if (e.preventDefault) {
                e.preventDefault();
            } else {
                e.returnValue = false;
            }
            var text = e.dataTransfer.getData('Text');
            if (!text) {
                return false;
            }
            var obj = JSON.parse(text);
            var id = $utils.getSceneEditorModel3dId(obj.id);
            var id2d = $utils.getSceneEditorModel2dId(id);


            var element = this.network.getElementAt(e);

            if (obj.id) {
                if (obj.combo) {
                    var jsons = make.Default.load(obj.id);
                    $utils.createJsonObject(this.jsonBox, jsons, obj.id);
                } else {

                    var layerId = make.Default.getOtherParameter(id2d, 'layer') || 900;
                    var type = make.Default.getOtherParameter(id2d, 'type');
                    if (type === 'watercable' || type === 'wall' || (type === 'area' && id2d == 'twaver.idc.area.top') || type === 'innerWall' || type === 'floor') {
                        var type = function (points) {
                            var data = [];
                            points.forEach(function (p) {
                                data.push(p.x);
                                data.push(p.y);
                            });
                            var type = make.Default.getType(id);
                            if (type == 'wall' && data.length < 3 * 2) {
                                return null;
                            } else if (type == 'area' && data.length < 3 * 2) {
                                return null;
                            } else if (type == 'innerWall' && data.length < 2 * 2) {
                                return null;
                            }
                            var node = make.Default.load({ id: id2d, data: data });
                            return node;
                        };
                        this.network.setAutoShowOrHideGrid(false);
                        this._createShapeNodeInteractions(type);
                    } else if (type === 'door' || type === 'window') {
                        var p = this.network.getLogicalPoint(e);
                        var MIN_OFFSET = 300; //门窗在墙附近三百的距离吸附
                        var elements = this.network.getElementsAtRect({ x: p.x - MIN_OFFSET / 2, y: p.y - MIN_OFFSET / 2, width: MIN_OFFSET, height: MIN_OFFSET }, true);
                        for (var i = 0; i < elements.size(); i++) {
                            if (elements.get(i) instanceof make.Default.WallShapeNode) {
                                element = elements.get(i);
                                if (element && (element instanceof make.Default.WallShapeNode)) {
                                    var point = this.network.getLogicalPoint(e); //getLogicalPosition(e) 2015-01-04
                                    element.setClient('focusIndex', -1);
                                    var index = element.getPointIndex(point, MIN_OFFSET);
                                    if (index >= 0) {
                                        var points = element.getPoints(),
                                            from = points.get(index),
                                            to = points.get(index === points.size() - 1 ? 0 : index + 1),
                                            dx = to.x - from.x,
                                            dy = to.y - from.y,
                                            offset = Math.abs(dx) > Math.abs(dy) ? (point.x - from.x) / dx : (point.y - from.y) / dy;

                                        var rotateY = Math.atan((from.y - to.y) / (from.x - to.x));

                                        var newPoint = {}; /*修正门窗吸附后的偏移量*/
                                        if (Math.abs(point.x - from.x) <= MIN_OFFSET / 2) {
                                            newPoint = { x: from.x, y: Math.round(point.y / 10) * 10 }; //10为最小吸附单元，这里后期需要改进因为这里child还不是网元没有设置吸附
                                        }
                                        if (Math.abs(point.y - from.y) <= MIN_OFFSET / 2) {
                                            newPoint = { x: Math.round(point.x / 10) * 10, y: from.y };
                                        }

                                        var wallChild = new nsp.edit.data.JsonObject();
                                        wallChild.id = id;
                                        wallChild.position = [point.x, 0, point.y];
                                        if (make.Default.getOtherParameter(id2d, 'type') === 'window') {
                                            wallChild.position = [newPoint.x, 30, newPoint.y];
                                            wallChild.setWidth(120);
                                        } else if (make.Default.getOtherParameter(id2d, 'type') === 'door') {
                                            wallChild.position = [newPoint.x, 0, newPoint.y];
                                            wallChild.setWidth(205);
                                        }
                                        // wallChild.rotation = [0, -rotateY, 0];
                                        wallChild.client = { edgeIndex: index, offset: offset };
                                        wallChild.client.id = id;

                                        var wall = this.jsonBox.getDataById(element.getId());

                                        this.jsonBox.remove(wall);
                                        if (wall) {
                                            var children = wall.getChildren() || [];
                                            children.push(wallChild);
                                            wall.setChildren(children);
                                        }
                                        this.jsonBox.add(wall);
                                        // wallChild.parentId = wall.getObjectId();
                                        // this.jsonBox.add(wallChild);

                                    }
                                }
                            }
                        }

                    } else {
                        this.network.getSelectionModel().clearSelection();
                        var centerLocation = this.network.getLogicalPoint(e);
                        var position = [centerLocation.x, 'floor-top', centerLocation.y];

                        //FIXME 原来根据模型ID来判断,不合理,改成了如果注册有positionY,就修改模型position
                        var params = make.Default.getModelDefaultParameters($utils.getSceneEditorModel2dId(id));

                        //通道特殊属性
                        if (this.isChannel(id)) {
                            this._getChannelClient(params, obj);
                        }

                        if (params && params['positionY']) {

                            position[1] = params['positionY'].value;
                        }
                        var jsonData = new nsp.edit.data.JsonObject();
                        jsonData.id = id;
                        jsonData.position = position;
                        jsonData.client = obj;
                        jsonData.client.id = jsonData.id;
                        this.jsonBox.add(jsonData);
                        var box2d = this.network.getElementBox();
                        this.network.getSelectionModel().appendSelection(box2d.getDataById(jsonData.getObjectId()));

                    }
                }

            }
            this._setNetworkCreateShapeNodeCursor();
            return false;
        },
        isChannel: function (id) {
            var category = make.Default.getOtherParameter(id, 'sdkCategory');
            return category == 'channel';
        },

        _getChannelClient: function (params, obj) {
            for (var param in params) {
                if (params[param].propertyType == 'Client' || params[param].propertyType == 'field' && params[param].value) {
                    obj[param] = params[param].value;
                }
            }
            return obj;
        },

        _createShapeNodeInteractions: function (type) {
            this.network.setInteractions([
                new MyCreateShapeNodeInteraction(this.network, type),
                new twaver.vector.interaction.DefaultInteraction(this.network)
            ]);
        },

        _setNetworkCreateShapeNodeCursor: function () {
            var self = this;
            this.network.getInteractions().forEach(function (handler) {
                if (handler instanceof twaver.vector.interaction.CreateShapeNodeInteraction) {
                    self.network.getView().style.cursor = 'crosshair';
                }
            });
        },

        handle_mousedown: function (e) {
            // $utils.stopPropagation(e);   
            this.mouseDown = true;
            this.lastLogicalPoint = this.network.getLogicalPoint(e); //getLogicalPosition(e) 2015-01-04
            if (!this.lastLogicalPoint) return;
            //        alert(this.lastLogicalPoint.x + " ; " + this.lastLogicalPoint.y);
            var element = this.network.getElementAt(e);
            if (element && !$utils.isMoveModel(element)) {
                //判断是否是禁止移动的对象
                return;
            }
            if (element instanceof make.Default.WallShapeNode) {
                resize = this.network.getElementUI(element).isPointOnBorderLine(this.lastLogicalPoint);
                if (resize !== null) {
                    this.lastElement = element;
                    this.network.isMovable = function (element) {
                        return false;
                    };
                } else {
                    var index = element.getPointIndex(this.network.getLogicalPoint(e)); ////getLogicalPosition(e) 2015-01-04
                    if (index >= 0) {
                        this.lastIndex = index;
                        this.lastElement = element;
                        this.network.isMovable = function (element) {
                            return false;
                        };
                    }
                }
            }
            if (element instanceof make.Default.Block) {
                this.block = element;
            }
        },

        handle_mousemove: function (e) {
            // $utils.stopPropagation(e);
            // if(lock2d) {
            //   return;
            // }
            var resize;
            this._setNetworkCreateShapeNodeCursor();
            if (this.mouseDown) {
                var point = this.network.getLogicalPoint(e); //getLogicalPosition(e) 2015-01-04
                if (!point) {
                    this.network.getView().scrollTop += 10;
                    this.network.getView().scrollLeft += 10;
                    return;
                }
                if (this.lastElement && !$utils.isMoveModel(this.lastElement)) {
                    //判断是否是禁止移动的对象
                    return;
                }
                if (this.block && !$utils.isMoveModel(this.block)) {
                    //判断是否是禁止移动的对象
                    return;
                }
                offsetX = this.lastLogicalPoint ? point.x - this.lastLogicalPoint.x : 0;
                offsetY = this.lastLogicalPoint ? point.y - this.lastLogicalPoint.y : 0;
                if (this.lastIndex >= 0) {
                    $utils.stopPropagation(e);
                    var points = this.lastElement.getPoints(),
                        from = points.get(this.lastIndex),
                        to = points.get(this.lastIndex === points.size() - 1 ? 0 : this.lastIndex + 1);
                    if (!this.network.enableSingleOrientationMove) {
                        if (!this.mouseMoved && _twaver.isCtrlDown(e)) {
                            this.horizontal = Math.abs(offsetX) >= Math.abs(offsetY);
                            this.vertical = !this.horizontal;
                            this.mouseMoved = true;
                        }
                    } else if (!this.mouseMoved) {
                        this.horizontal = from.x == to.x;
                        this.vertical = !this.horizontal;
                        this.mouseMoved = true;
                    }
                    //                if (!this.mouseMoved && _twaver.isCtrlDown(e)) {
                    //                    this.horizontal = Math.abs(offsetX) >= Math.abs(offsetY);
                    //                    this.vertical = !this.horizontal;
                    //                    this.mouseMoved = true;
                    //                }
                    if (!this.vertical) {
                        from.x += offsetX;
                        to.x += offsetX;
                    }
                    if (!this.horizontal) {
                        from.y += offsetY;
                        to.y += offsetY;
                    }
                    this.lastElement.firePointsChange(null, this.lastElement.getPoints());
                    this.lastLogicalPoint = point;
                }
                if (this.block) {
                    var index = this.block.getClient('edgeIndex'),
                        length = this.block.getClient('length'),
                        offset = this.block.getClient('offset'),
                        points = this.block.getParent().getPoints(),
                        from = points.get(index),
                        to = points.get(index === points.size() - 1 ? 0 : index + 1),
                        dx = to.x - from.x,
                        dy = to.y - from.y,
                        h = Math.abs(dx) > Math.abs(dy),
                        change = h ? offsetX : offsetY,
                        move = change;
                    if (this.block.getClient('focusLeft')) {
                        if (h) {
                            if (dx > 0) {
                                move = -move;
                            }
                        } else {
                            if (dx >= 0 && dy < 0) {
                                change = -change;
                            }
                            if (dx >= 0 && dy > 0) {
                                move = -move;
                            }
                            if (dx < 0 && dy > 0) {
                                change = -change;
                                move = -move;
                            }
                        }
                        this.block.setClient('length', length - change);
                        this.block.setClient('offset', offset - move / Math.abs(h ? dx : dy) / 2);
                    } else if (this.block.getClient('focusRight')) {
                        if (h) {
                            if (dx < 0) {
                                move = -move;
                            }
                        } else {
                            if (dx >= 0 && dy < 0) {
                                change = -change;
                                move = -move;
                            }
                            if (dx < 0 && dy > 0) {
                                change = -change;
                            }
                            if (dx < 0 && dy < 0) {
                                move = -move;
                            }
                        }
                        this.block.setClient('length', length + change);
                        this.block.setClient('offset', offset + move / Math.abs(h ? dx : dy) / 2);
                    } else {
                        var offset = Math.abs(dx) > Math.abs(dy) ? (point.x - this.lastLogicalPoint.x) / dx : (point.y - this.lastLogicalPoint.y) / dy;
                        this.block.setClient('offset', this.block.getClient('offset') + offset);
                    }
                    this.lastLogicalPoint = point;
                }
                if (resize !== null && this.lastElement) {
                    if (resize === 0) {
                        this.lastElement.setLocation(this.lastElement.getX() + offsetX, this.lastElement.getY() + offsetY);
                        this.lastElement.setSize(this.lastElement.getWidth() - offsetX, this.lastElement.getHeight() - offsetY);
                    } else if (resize === 1) {
                        this.lastElement.setLocation(this.lastElement.getX(), this.lastElement.getY() + offsetY);
                        this.lastElement.setSize(this.lastElement.getWidth() + offsetX, this.lastElement.getHeight() - offsetY);
                    } else if (resize === 2) {
                        this.lastElement.setSize(this.lastElement.getWidth() + offsetX, this.lastElement.getHeight() + offsetY);
                    } else if (resize === 3) {
                        this.lastElement.setLocation(this.lastElement.getX() + offsetX, this.lastElement.getY());
                        this.lastElement.setSize(this.lastElement.getWidth() - offsetX, this.lastElement.getHeight() + offsetY);
                    }
                    this.lastLogicalPoint = point;
                }
            } else {
                var element = this.network.getElementAt(e),
                    point = this.network.getLogicalPoint(e); //getLogicalPosition(e) 2015-01-04
                if (element && !$utils.isMoveModel(element)) {
                    //判断是否是禁止移动的对象
                    return;
                }
                if (this.lastElement && this.lastElement !== element) {
                    if (this.lastElement instanceof make.Default.WallShapeNode) {
                        this.lastElement.setClient('focusIndex', -1);
                        this.network.getView().style.cursor = 'default';
                    }
                    if (this.lastElement instanceof make.Default.Block) {
                        this.lastElement.setClient('focus', false);
                        this.lastElement.setClient('focusLeft', false);
                        this.lastElement.setClient('focusRight', false);
                        this.network.getView().style.cursor = 'default';
                    }
                    this.lastElement = null;
                }
                if (element instanceof make.Default.WallShapeNode) {
                    resize = this.network.getElementUI(element).isPointOnBorderLine(point);
                    if (resize !== null) {
                        this.lastElement = element;
                        this.network.getView().style.cursor = 'move';
                    } else {
                        var index = element.getPointIndex(point);
                        element.setClient('focusIndex', index);
                        if (index >= 0) {
                            this.lastElement = element;
                            if (_twaver.isAltDown(e)) {
                                this.network.getView().style.cursor = this.addPointCursor;
                            } else {
                                this.network.getView().style.cursor = 'move';
                            }
                        } else {
                            if (!element.isPointOnPoints(point)) {
                                this.network.getView().style.cursor = 'default';
                            }
                        }
                    }
                } else if (element instanceof make.Default.Block) {
                    element.setClient('focus', true);
                    if (this.network.getSelectionModel().contains(element) && _twaver.math.getDistance(point, element.getClient('leftPoint')) <= 10) {
                        element.setClient('focusLeft', true);
                        element.setClient('focusRight', false);
                        this.network.getView().style.cursor = 'move';
                    } else if (this.network.getSelectionModel().contains(element) && _twaver.math.getDistance(point, element.getClient('rightPoint')) <= 10) {
                        element.setClient('focusLeft', false);
                        element.setClient('focusRight', true);
                        this.network.getView().style.cursor = 'move';
                    } else {
                        element.setClient('focusLeft', false);
                        element.setClient('focusRight', false);
                        this.network.getView().style.cursor = 'default';
                    }
                    this.lastElement = element;
                } else {
                    this.lastElement = null;
                }
            }

        },

        handle_mouseup: function (e) {
            this.mouseDown = false;
            this.mouseMoved = false;
            this.horizontal = false;
            this.vertical = false;
            this.lastIndex = -1;
            this.lastElement = null;
            this.lastLogicalPoint = null;
            this.block = null;
            this.resize = false;
            this.network.getView().style.cursor = 'default';
            delete this.network.isMovable;
        },

        getAllElementsAt: function (point) {
            var rect = {
                x: point.x - 1,
                y: point.y - 1,
                width: 2,
                height: 2
            };
            var elements = this.network.getElementsAtRect(rect, true, null, false);
            return elements;
        },
        findFirstFloorAt: function (point) {
            var elements = this.getAllElementsAt(point);
            if (elements) {
                for (var i = 0; i < elements.size(); i++) {
                    if (elements.get(i) instanceof nsp.edit.data.FloorShapeNode) {
                        return elements.get(i);
                    }
                }
            }
        }

    });
    nsp.edit.interaction.RoomEditInteraction = function (network, lazyMode) {
        nsp.edit.interaction.RoomEditInteraction.superClass.constructor.call(this, network);
    }

    twaver.Util.ext(nsp.edit.interaction.RoomEditInteraction, twaver.vector.interaction.EditInteraction, {
        deletePointCursor: "url('data:image/png;base64,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'),auto",
        setUp: function () {
            nsp.edit.interaction.RoomEditInteraction.superClass.setUp.apply(this, arguments);
            // this.addListener('keydown','keyup');
            //        this.oldCursor = this.network.getView().style.cursor;
            //        this.network.setHasEditInteraction(true);
        },
        tearDown: function () {
            nsp.edit.interaction.RoomEditInteraction.superClass.setUp.apply(this, arguments);
            // this.removeListener('keydown','keyup');
            //        this.network.getView().style.cursor = this.oldCursor;
            //        this.network.setHasEditInteraction(false);
            //this.clear();
        },
        // handle_keydown: function(e) {
        //     this.currentKeyEvent = e;
        //     this.showSnap = true;
        // },
        // handle_keyup: function(e) {
        //     this.currentKeyEvent = null;
        //     this.showSnap = false;
        // },
        handle_mouseup: function (e) {
            if (this.isStart) {
                var point = _twaver.clone(this._endLogical);
                if (this.resizingRect) {
                    if (this.lazyMode) {
                        if (this.network.isResizeAnimate()) {
                            var self = this;
                            var animate = new twaver.animate.AnimateBounds(this.node, this.resizingRect, function () {
                                self.network.fireInteractionEvent({
                                    kind: 'lazyResizeEnd',
                                    event: e,
                                    element: self.node,
                                    resizeDirection: self.resizeDirection
                                });
                            });
                            twaver.animate.AnimateManager.start(animate);
                        } else {
                            this.node.setLocation(this.resizingRect.x, this.resizingRect.y);
                            this.node.setSize(this.resizingRect.width, this.resizingRect.height);
                            this.network.fireInteractionEvent({
                                kind: 'lazyResizeEnd',
                                event: e,
                                element: this.node,
                                resizeDirection: this.resizeDirection
                            });
                        }
                    } else {
                        this.node.setLocation(this.resizingRect.x, this.resizingRect.y);
                        this.node.setSize(this.resizingRect.width, this.resizingRect.height);
                        this.network.fireInteractionEvent({
                            kind: 'liveResizeEnd',
                            event: e,
                            element: this.node,
                            resizeDirection: this.resizeDirection
                        });
                    }
                } else if (this.shapeNode && this.pointIndex >= 0 && point) {
                    var oldPoint = this.shapeNode.getPoints().get(this.pointIndex);
                    if (this.horizontal) {
                        point.y = oldPoint.y;
                    }
                    if (this.vertical) {
                        point.x = oldPoint.x;
                    }
                    /*if(this.currentKeyEvent && this.currentKeyEvent.keyCode === 83) {
                     var snapGrid = parseInt(localStorage.getItem(SNAPGRID)) || 10;
                     point.x = parseInt(point.x / snapGrid) * snapGrid + ((point.x % snapGrid) < (snapGrid / 2) ? 0 : snapGrid);
                     point.y = parseInt(point.y / snapGrid) * snapGrid + ((point.y % snapGrid) < (snapGrid / 2) ? 0 : snapGrid);
                     }*/
                    this.shapeNode.setPoint(this.pointIndex, point);
                    this.network.fireInteractionEvent({
                        kind: 'liveMovePointEnd',
                        event: e,
                        element: this.shapeNode,
                        pointIndex: this.pointIndex
                    });
                } else if (this.shapeLink && this.pointIndex >= 0 && point) {
                    var oldPoint = this.shapeLink.getPoints().get(this.pointIndex);
                    if (this.horizontal) {
                        point.y = oldPoint.y;
                    }
                    if (this.vertical) {
                        point.x = oldPoint.x;
                    }
                    this.shapeLink.setPoint(this.pointIndex, point);
                    this.network.fireInteractionEvent({
                        kind: 'liveMovePointEnd',
                        event: e,
                        element: this.shapeLink,
                        pointIndex: this.pointIndex
                    });
                } else if (this.linkUI && point) {
                    this.linkUI.setControlPoint(point);
                    this.network.fireInteractionEvent({ kind: 'liveMovePointEnd', event: e, element: this.linkUI._element });
                }
            }
            this._handle_mouseup(e);
            this.clear();
        },
        _isEditingShapeNode: function (point, e) {
            if (this.node instanceof twaver.ShapeNode) {
                this.shapeNode = this.node;
                var points = this.shapeNode.getPoints();
                var editPointSize = this.network.getEditPointSize();
                for (var i = 0, n = points.size(); i < n; i++) {
                    var p = points.get(i);
                    if (this._contains(point, p, editPointSize)) {
                        if (_twaver.isAltDown(e)) {
                            this._setCursor(this.deletePointCursor);
                        } else {
                            this._setCrossCursor();
                        }
                        this.pointIndex = i;
                        return true;
                    }
                }
                if (!this.shapeNode.getPointIndex) {
                    return false;
                }
                if (this.shapeNode.getPointIndex(point) != null && this.shapeNode.getPointIndex(point) >= 0) {
                    return true;
                }
            }
            this.pointIndex = -1;
            return false;
        },
        _resetShapeNodePoints: function (point) {
            //如果按住了ctrl键,允许任意打点,否则只能水平或竖直
            if (this.lastPoint) {
                if (!_twaver.isCtrlDown(event)) {
                    var dx = point.x - this.lastPoint.x;
                    var dy = point.y - this.lastPoint.y;
                    if (Math.abs(dx) >= Math.abs(dy)) {
                        //水平
                        point.y = this.lastPoint.y;
                    } else {
                        //竖直
                        point.x = this.lastPoint.x;
                    }
                }
            } else {
                this.lastPoint = point;
            }
            nsp.edit.interaction.RoomEditInteraction.superClass._resetShapeNodePoints.call(this, point);
        },
        handle_mousemove: function (e) {
            if (!this.network.isValidEvent(e)) {
                return;
            }
            if (this.isStartRotate) {
                if (this.node) {
                    this._handleRotateElement(e, this.node);
                    if (this.network.isShowRotateScale()) {
                        this.repaint();
                    }
                    return;
                }
            }
            if (this.isStart) {
                if (this.shapeNode && this.pointIndex >= 0) {
                    this._handleMovingShapeNodePoint(e);
                    var scalePoint = {};
                    return;
                }
                if (this.shapeLink && this.pointIndex >= 0) {
                    this._handleMovingShapeLinkPoint(e);
                    return;
                }
                if (this.node && this.resizeDirection) {
                    this._handleResizing(e);
                    return;
                }
                if (this.linkUI) {
                    this._handleMovingLinkControlPoint(e);
                    return;
                }
                var point = this.network.getLogicalPoint2(e);
                if (this.node &&
                    (this.node instanceof twaver.ShapeNode) &&
                    this.node.getPointIndex(point) &&
                    this.node.getPointIndex(point) >= 0) {
                    this.network._dragToPan = false;
                    return;
                }
                return;
            }

            this.lastPoint = null;

            var element = this.network.getElementAt(e);
            if (element && !$utils.isMoveModel(element)) {
                //判断是否是禁止移动的对象
                return;
            }

            if (this.network.isSelectingElement() || this.network.isMovingElement() || this.network.getSelectionModel().size() === 0) {
                this.clear();
                return;
            }

            //        var element = this.network.getElementAt(e);
            var elementUI = this.network.getElementUI(element);
            if (!elementUI || !elementUI.getEditAttachment()) {
                this.clear();
                return;
            }

            var point = this.network.getLogicalPoint2(e); //this.network.getLogicalPoint(e);
            if (element instanceof twaver.ShapeNode) {
                point = this.network.getLogicalPoint(e); //getLogicalPosition(e) 2015-01-04
            }
            if (element instanceof twaver.Node) {
                this.node = element;
                if (this.node instanceof make.Default.Block) {
                    this.network._dragToPan = false;
                    //                var logical_point = this.network.getLogicalPoint(e);
                    //                if(this._isResizingNode(logical_point)){
                    //                    this.network.setEditingElement(true);
                    //                }
                    this.isStart = true;
                    //                this.resizeDirection = true;
                    return;
                }
                if (this._isEditingShapeNode(point, e) || this._isResizingNode(point)) {
                    this.network.setEditingElement(true);
                    return;
                }
                if (this._isRotatingElement(point)) {
                    this.network.setRotatingElement(true);
                    this.network.setEditingElement(true)
                    return;
                }
            } else if (element instanceof twaver.ShapeLink) {
                this.shapeLink = element;
                if (this._isEditingShapeLink(point)) {
                    this.network.setEditingElement(true);
                    return;
                }
            } else if (elementUI instanceof twaver.network.LinkUI) {
                if (twaver.Link.isOrthogonalLink(elementUI._element)) {
                    this.linkUI = elementUI;
                    var controlPoint = this.linkUI.getControlPoint();
                    if (controlPoint && this._contains(point, controlPoint)) {
                        this._setCrossCursor();
                        this.network.setEditingElement(true);
                    }
                    return;
                }
            }
            this.clear();

        },
        handle_mousedown: function (e) {
            if (e.button !== 0) {
                return;
            }

            if (_twaver.isAltDown(e) && !this.network.isEditingElement()) {
                var element = this.network.getElementAt(e);
                var point = this.network.getLogicalPoint(e); //getLogicalPosition(e) 2015-01-04
                if (element instanceof twaver.ShapeNode) {
                    var pointIndex = this.getPointIndex(element.getPoints(), point, true);
                    if (pointIndex > 0) {
                        this._handle_mousedown(e);
                        this.pointIndex = pointIndex;
                        this.shapeNode = element;
                        element.addPoint(point, pointIndex);
                        this._setCrossCursor();
                        this.network.setEditingElement(true);
                        this.isStart = true;
                        this.network.fireInteractionEvent({
                            kind: 'addPoint',
                            event: e,
                            element: element,
                            pointIndex: pointIndex
                        });
                        this.network.fireInteractionEvent({
                            kind: 'liveMovePointStart',
                            event: e,
                            element: element,
                            pointIndex: pointIndex
                        });
                    }
                }
                if (element instanceof twaver.ShapeLink) {
                    var points = new twaver.List(element.getPoints());
                    var shapeLinkUI = this.network.getElementUI(element);
                    points.add(shapeLinkUI.getFromPoint(), 0);
                    points.add(shapeLinkUI.getToPoint());
                    var pointIndex = this.getPointIndex(points, point) - 1;
                    if (pointIndex > 0) {
                        this._handle_mousedown(e);
                        this.pointIndex = pointIndex;
                        this.shapeLink = element;
                        element.addPoint(point, pointIndex);
                        this._setCrossCursor();
                        this.network.setEditingElement(true);
                        this.isStart = true;
                        this.network.fireInteractionEvent({
                            kind: 'addPoint',
                            event: e,
                            element: element,
                            pointIndex: pointIndex
                        });
                        this.network.fireInteractionEvent({
                            kind: 'liveMovePointStart',
                            event: e,
                            element: element,
                            pointIndex: pointIndex
                        });
                    }
                }
                return;
            }

            //        var billboard = this.network.getElementAt(e);
            //        if(billboard && (billboard instanceof twaver.Node)
            //            && billboard.getClient('className')
            //            && billboard.getClient('className') == "mono.Billboard"){ // add 2015-01-06
            //            this.network.setRotatePointSize(0);
            //            return;
            //        }

            if (!this.network.isEditingElement() || this.isStart || this.isStartRotate) {
                return;
            }
            if (this.node && this.resizeDirection) {
                this.isStart = true;
                this._handle_mousedown(e);
                this.network.fireInteractionEvent({
                    kind: this.lazyMode ? 'lazyResizeStart' : 'liveResizeStart',
                    event: e,
                    element: this.node,
                    resizeDirection: this.resizeDirection
                });
            } else if (this.shapeNode && this.pointIndex >= 0) {
                var pointsSize = this.shapeNode.getPoints()._as.length;
                var self = this;
                if (_twaver.isAltDown(e)) {
                    if (pointsSize == 2) {
                        layer.confirm('You will delete the entire wall, Sure to Delete', function index() {
                            self.shapeNode.removeAt(0);
                            self.shapeNode.removeAt(1);
                            self.network.fireInteractionEvent({ kind: 'removePoint', event: e, element: self.shapeNode });
                            self.network.invalidateElementUI(self.shapeNode);
                            layer.close(index);
                        })
                    } else {
                        layer.confirm('Sure to Delete', function (index) {
                            if (pointsSize == 3) {
                                self.shapeNode.setClient("closed", false);
                            }
                            self.shapeNode.removeAt(self.pointIndex);
                            self.shapeNode.getSegments().removeAt(self.pointIndex);
                            self.network.fireInteractionEvent({ kind: 'removePoint', event: e, element: self.shapeNode });
                            layer.close(index);
                        });
                    }
                } else {
                    this.isStart = true;
                    this._handle_mousedown(e);
                    this.network.fireInteractionEvent({
                        kind: 'liveMovePointStart',
                        event: e,
                        element: this.shapeNode,
                        pointIndex: this.pointIndex
                    });
                }
            } else if (this.shapeLink && this.pointIndex >= 0) {
                if (_twaver.isAltDown(e)) {
                    this.shapeLink.removeAt(this.pointIndex);
                    this.network.fireInteractionEvent({ kind: 'removePoint', event: e, element: this.shapeLink });
                } else {
                    this.isStart = true;
                    this._handle_mousedown(e);
                    this.network.fireInteractionEvent({
                        kind: 'liveMovePointStart',
                        event: e,
                        element: this.shapeLink,
                        pointIndex: this.pointIndex
                    });
                }
            } else if (this.linkUI) {
                this.isStart = true;
                this._handle_mousedown(e);
                this.network.fireInteractionEvent({ kind: 'liveMovePointStart', event: e, element: this.linkUI._element });
            } else if (this.shapeNode) {
                this.isStart = true;
            } else if (this.node) {
                if (this.node.getClient('className') && this.node.getClient('className') == "mono.Billboard") { // add 2015-01-06
                    //                this.network.setRotatePointSize(0);
                } else {
                    this.isStartRotate = true;
                    this._handle_mousedown(e);
                }
            }
        },

        clear: function () {
            nsp.edit.interaction.RoomEditInteraction.superClass.clear.apply(this, arguments);
            //this.network._dragToPan = true;                 //
            this.network.setRotatePointSize(twaver.Defaults.NETWORK_ROTATE_POINT_SIZE);
        }
    });

    nsp.edit.interaction.RoomListener = function (network, propertySheetPane, jsonBox) {
        nsp.edit.interaction.RoomListener.superClass.constructor.apply(this, arguments);
        this.network = network;
        this.propertySheetPane = propertySheetPane;
        this.jsonBox = jsonBox;
        this.box2d = this.network.getElementBox();

        this.initLayer();

    }
    twaver.Util.ext(nsp.edit.interaction.RoomListener, Object, {
        initLayer: function () {
            var layerBox = this.box2d.getLayerBox();
            for (var i = 100; i <= 900; i += 100) {
                var layer = new twaver.Layer(i);
                layerBox.add(layer);
            }
        },

        initRoomSettings: function () {
            this.network.enableSingleOrientationMove = false;
            this.network.getView().setAttribute('draggable', 'true');
            this.network.setEditPointFillColor('yellow');
            this.network.setEditPointOutlineColor('#333333');
            this.network.setEditPointOutlineWidth(1);
            this.network.setEditPointSize(10);
            this.network.setResizePointSize(0);
            this.network.setToolTipEnabled(false);
            // this.network.setZoomManager(new twaver.vector.LogicalZoomManager(this.network, true));
            //this.network.setMaxZoom(3);
            //this.network.setMinZoom(0.2);
            // this.network.setViewRect(-500, -300);

            this.network.setKeyboardRemoveEnabled(false);
            this.network.setRotatePointFillColor('yellow');

            this.interactions2d = [
                new nsp.edit.interaction.RoomDragInteraction(this.network, this.propertySheetPane, this.jsonBox),
                new nsp.edit.interaction.RoomEditInteraction(this.network),
                new twaver.vector.interaction.DefaultInteraction(this.network)
            ];
            this.network.setInteractions(this.interactions2d);

            this.installNetwork2dFunctions(this.network);
            this.installNetwork2dListeners(this.network);
        },

        installNetwork2dFunctions: function (network) {
            var self = this;
            network.isRotatable = function (element) {
                //门窗,禁止默认的编辑,移动等操作
                if ($utils.isChild(element)) {
                    return false;
                }
                return $utils.isEditModel(element);
            }

            network.isEditable = function () {
                return true
            };

            network.setMovableFunction(function (element) {
                //门窗,禁止默认的编辑,移动等操作
                if ($utils.isChild(element)) {
                    return false;
                }
                return $utils.isMoveModel(element);
            });

            network.setEditableFunction(function (element) {
                //门窗,禁止默认的编辑,移动等操作
                if ($utils.isChild(element)) {
                    return false;
                }
                return $utils.isEditModel(element);
            });
        },

        installNetwork2dListeners: function (network) {
            var self = this;
            //network.getElementBox().getSelectionModel().addSelectionChangeListener(this.handleSelectionChange, this);
            network.getElementBox().addDataBoxChangeListener(this.handleDataBoxChange, this);

            network.addElementByInteraction = function (element) {
                twaver.vector.Network.prototype.addElementByInteraction.call(this, element);
                setTimeout(function () {
                    self.network.setInteractions(self.interactions2d);
                }, 100);
            };

        },

        /**
         * 2D的dataBox change事件
         * 将node挪到制定的层
         * 如果是墙体,overview
         * @param e
         */
        handleDataBoxChange: function (e) {
            var self = this;
            var kind = e.kind,
                data = e.data;
            if (kind === 'add') {
                var id2d = $utils.getSceneEditorModel2dId(data.getClient('id'));
                data.setLayerId(make.Default.getOtherParameter(id2d, 'layer') || 900);
                var type = make.Default.getOtherParameter(id2d, 'type');
                if (type && type.indexOf('wall') >= 0) {
                    //setTimeout(function () {
                    //    self.network.zoomOverview();
                    //}, 100)
                }
            }
        },

    });
})(window);
(function(window, undefined) {

var it = {};
window.it = it;
it.version = "v1.0.0";
var $Util = it.Util = {};
$Util._debug = true;
$Util.dropImg = new Image();
$Util.dropImg.src = "data:image/png;base64,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";
$Util.dropImg.client = {width:318,height:442,size:50,lineWidth:5,color:'#FFFFFF',startX:100,startY:300,withUnit:true}
$Util._blue = new Image();
$Util._blue.src = "data:image/png;base64,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";
$Util._green = new Image();
$Util._green.src = "data:image/png;base64,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";
$Util._yellow = new Image();
$Util._yellow.src = "data:image/png;base64,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";
$Util._red = new Image();
$Util._red.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIgAAADMCAYAAACoc+soAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAKY9JREFUeNrsfQuQHMd5XvfM7O7d4Q44vI8EQIAvgKIoBpRsiyYpKWEcqVQxLcuOEseOaIemoyjlSpzQIiNbDHiAKIs0DyLtxFVKiork6BlaVpUcuuTIisVQpViiKFM0LQkkxIcAEIcXD7jXPmamO/3//f8zPXt7h8PhHrt73VV7+97bnf7m+7//0X9LrbXww4/ZRuAPgTNGhv/YHwQPkLnGe/0h8ACZjT1u9wfBA2SusU9XpwAoE/5QeIC0HgYgOk37/YHwAGk1dspaXYjpaWCRt/vD4QEy81jEsRCNmtBK/bk/HB4ghaG1luavkLUq3An9EfEAmTmUEiJuCFGb9jERD5CmMXEWmINAEoNY/Rf+oHiAOOzhpByqxsykiTQsMugB4geYk6+KJMnuyobxZhoNo0jEUQ8QP2C8RaRpfi81YEmMR6PSNR4gfoAHU5EACHeAmYkTYJdPe4B470UUGCQzM9MgVn/ZA2R164+dAmIfABJ3gJlJQbhqEKtv8ABZveMJ0hszn0EzE0Nk9bseIKtXf+wUSdryOWtmanAz8gBZrcNoD2lB0OK5xMZHgEUO7j/iAbL69MdBkcYIgNmGxKCZeT5JtnuArDbzotS/FfVaa/3BA9gFAKQVAOrLq+0YRWJ1jxBNSLMH02SCrEdjXiPT2zyDrB7zci8yQ6123peimalPC23f93seIKvDvNwnkob1VM43oAQA0JEkEDi7xwNkdfi3ASbo0uT8rwUT1GhYsWoIZTVVwK9OgIwMf9cm5Bq2BmQeQ1anDUhiyyIq/aQHSDeTR5reAPoDi5TnOyDaqolNNLLIL3ovpjvZ43acZJhw0BYXMGTNCNVImqMWmjvysdVwgq06BjHi9JMIEJXM7d62GhAzgQSecY2xyHkVsEiwythjp4CJbVSFnK5e+PshoAbCFoJntn71MQ+Q7mKP53GCMb/SWNBnSFieCUEzI3KJRX7NA6R72KMsVGy9lws1L25MBDUMucha/3cPkO5gj0PWPMQLMy8ui9SrlJ/R8LkAvo96gHQ+e1Qw4abFgs1LNnD1naAcTXdHV4NVwh7P42QacYkBr4v+QG1rSIhF8KGD+7/mAdKZ7HEzag/0OsBVrS7O58LyTPg8dJfRu7nVA6QTh1JPIjggKRdfhDhtHlwGAOF3/EyjR0aGj3mAdBZ77ENXFPMuanHMiytWpycLLCLT9FLUOx4gHcMe99mzvJ6vllvMkVClGbGItl7NYQ+QThCmHzvwLPaAhUuS2gDXEgw5PUHh99RetI66KXjWnQABmo/jN9i4R92C5GJd29kG1IkwixAgjdv7CQ+Q9jYtL9INyx7TS9u4EANnwCIYF8ECaGnc3ic9QNqTPT6qsVoszpNqjcbS/k/I8kpByycsi8gkuaUbBGvQZeAYxKgmpvMhNqGXnD2s4NGUxNN5dNUK1uc9QNrLtBy31zFpg2Vgj1YsgtFVLAcoG9D+pgdI+5iWHptlVZjSXxb2aMkiFESzIPnDTj6ssiu2A4FeYkqNYWYVJgaa4cKa2/GxZT6aUujBjfZ2b6+5b86/KBIiDE/Iu/YNeQZZqZiHUqc0nrVxZlKWlT2aWSTLGCt0gWWabjUgfo8HyEqA42P7v4zBKWXNCpgYGdvlCSsyQIsAQhL6PilEWLGD0Rc8QJbftFwv4+Q2e8pCMKxub06v4IYNGYsocnuVDZ5pLfXB4b/zAFle0/IMaiiIeWCuBeo0qouXsb0YFtGayhLTvHtAqq41oH6nB8hygOPg/uMGCBInAFij3rAsssgZ2wXr1eqkvcG9RzBXoyAM/7gHyNKblvtkkgxh3AEonPItmH5vF6/MiGWJ2sOG+5HVJHxhY2oeuu+wB8jSgWOnOQv35aYltfkWTuu305hmFqGgHS/f1PrKTvFqOg4gRne8hEeZTUuD8h88Ge00YP1v6qzDAZZT1vU1v+N/dkIv+I4CiB4ZHjXAkFziZ0sIzUGH6zRtzy+NZo/MjE6hM0BeFiDFjzxAFs+0/D4GnMCOK6ceFDTI9FT7fm+I6HIlG7MdgVkm6Qbzu/a382HvjFC7cQ2N7vjzLEsLA9pCQR0onKHLlZBb8FGWQq9bb8/HSsmG3wO4SPOUeSwIdom79r3iGWRh4Bg0dGzBwVlS7EyIIez2BwfaRt7qLLFuLyYTFWmqtK3rWIP2P7Z6VLO+gAOcWK8Fx1QHbXFrACLBL3czvfQ7jHCN9MH9T3iAXCg4Dg5/25xplWyrMEV2HBJgEM5e6YjpBQvWKZvhjSFflFj9lKJHAxVob21H17d9ATIyfI85eD9pFb9CD8AW46QgnCgp1mHDeFuS2END5pm3QQsCrEATbej6Bm0KjuvNEftopjuAMRKVh62nOnj3dPjumtpHxFQRjybULp0Ak+oBcj5RqtJnUHfgWWVbRenY5loktoFKOxcgYE5AWIO7njI4KE8DKsWYVP2xA1/xAJlNdyh1Qiu7yTGCA6Ol9kzD1EubJOMuahgXXbLpBFZUIvPQ0OgkyTvaJevbVgDRI8N/a0BQzkQp2W3BbDI1Kbpj6Dy4p1S+XCJV2WOY9W0DPdI+ABkZ3m/o9TrNwMBSPWU3FtQUTl/stbVtIlht0pHKE/NKOEMyatQDxILjLeasuTcDh7Kg0A3SHXjGTYuuG5PAiJKWbtp+8GhktA2kSS0qK92YJmgDcAwaYDyhOQGHZ5W0B4yKbMTUlH2u24Z2WlLgxkb1fHv4QKLrK1V6qzlGd6xagEBFOvYu1WyDtaVe1B1Eud1kWppHvWpLAKw4zV1e8tS03c/m0ZXSIysKED2y/2UJFelZwtBWguvY7kIp4eHqlOj6AYlHSVMRZ0VFtGdeyss4T68qgOiHP/zHUiU7cUkABYmgQEIwY2hyabXufoCY3ys56QjHgSvjACBBYEW61qEeOXB4dQDE+Pgyjt8L9InpbnbvcEW+PThoZuKGWDXDMGVmalIyrZqOCZQLAKOq5Er1yP0PLufXWv56EEzfqzGdqlyQgdaAaqtaAz0YNC0T51YHe7ijVBa6t8+yRhAK0dNjI658HybM3n+ruGvfk13JIMaWntGUY8EfS81tre5IVpdpaRUb0YrcXDI1vOmisuIVT+g0fWK5ROuyAgRqSiU0d9Hk/oNSB5Dg3i02QCThQKwm09I8uCSAlkxIrmHNamJolZ4Uh7sKIOqRD/8XY2O3YiBIimyvONQaiY0oIqNMTYlVPaCGFXbiBJCAB8P9Rji5x/GTVG3EdcldoUFspPT/Zl0HKVJoI4h1ykVI3NFJ1OvCDwOGgbVCh4E1uVFJiErFPhWGy6pHlh4gYCvT9DX4NZqjpJjCFzZymFCuBcAyfs5jg4cBhe5bgxFVIQ0gKmUDDtpBDoqeedoMSGQYrjcgOduRJsYI0lEGogTkp47WoAQVjq7J1C5ibCSriaFqOi6gipPc+7PZmyVrAb6kANEH938DtuFgrwUZBNe1mNsJeS1gWrATcupB0UKwossvqFMABtOk1XBwgVJFOH5a9+mPHfhqZwFkZPgOI0pvlkSDnFvJGsslpDtwRX7Vg6EwK0EmRvE4gQYBU8MVdlwdr6yW09A0J0l+xhzzn+0MDcI9w7LP1nnHH15krWwFlQSvZTW7tYXZIBAAIEqlXJT2g2AN6bkwj43A61mXBLYIb7H1yJLsmwuFLjLzVES2XQbb1gwcSeLB0QyQcsWKULikTp6qVLZggeMFEdawhOt+ITyvyWyjxpPyiHnTQNuaGKM7vm4MRwVsI1IlfHlJ7i16LSmtctfdUV+6mOCIaFkmMgeBBAADk88MsmYAH5PAMIMbhQaw4PsDu39emvbrhw98rj1NDNhApf4MI6RsMxMrTIEtNJoWqvkAHeIB4nB5ZFkC22aaS6XHHr+Q8jDwWH8/sYWyzwOgwLuBfYCnqtgsT2LeBk7KxYmPLB5ASHegt5IJLCp+gUuDt0LXtjr93DnRlVViC+LxkPupCgGxD7gGsKDmoMchsmqu9Zo19vUABDi+a/rtcR03smNq2jYxQjkilWGdjRerRxbNxGBuAMGhqaSfgAHfOHarwiR5LR4c+SxIeymXM3OBACg7wTEwKeZxGZUtQABAJTJJcDKuHRRi0yY8vtqG5gPDNt9sCw0CNQpGU2zEKeflhHlnv3zZAlKWar9WUSutPdgbQVMSOs8FuTZhjwbMC+gOAEgPmRno7jyw1raU2GhBAiepTNPXXazre/Emhl1aW5JNlWHC+uvwAyG3kuTbh0qImHZzjemFDjQnZpLLPfY2swZoDGQNAk9IZgWue/uM2xvZ+wAUeI/mvXGmhD77mpCQtpAZGy3Y9Q0W4Qw4Zhcek7aQpD/go3n7cn4pAMODo8geLEDZpKAeKeXilFkFvZpSZqYlsAf0gwcQwRIJMD19BjiVCno8kMehBSNCB/KpFTExWP6mVF/WDIXbPnKdKSXibMWYua7VPChm82AExYsC0h8cUmfmYLYBt5c9RGSWAE2NhsfhDcYN1pdsN3pki/UebaOdqxZqahYOEGNagnr9AwwOyZ4LCqSQkksUXi80TvGjYF4AHBQ4zOIfaFaISRgwUZSXH2KtCNXzliAmUjYMEgkJHo6iZKgxQ3Jom2GP0FbspemXlxUg5uu9xIt7sKhWcPg3sF+SW1BTfdCqWL5woeaF9Z878XwS8fNcj8pmBkwK3rYCFkEiSMia18mNW4XcsBGr9XQpsmYLWCSQ0jD+V5cHICPD/8pM/iAiX1rFbMPCsik1TS4c3/fDOcN07qUwB4dB7sUweDJwhIVioUy3QCERusc6F7xG4MotQ0KCd7Nth9CgVRQGJyGht2tpAWKXSn5cUgGtxH6f2nYAsutJLWVqu3wQ79d8xLS1e8uzEORMwZ4KX4fBTJcYPJcgyLWeJIHL+Rp6LTCIrPSiedL0dvPnuSUFiIqixxAcwBiSFhtjxNQqcmz0kib5GZAknj1mYxDWIULnQlTIosmRTeDJ8luSzLnKQRGRp9O/Fm/LdRvMJ5uTNrSeju2umK4xJ/kvLQ1ADD0hTbHpgJ/DgTGI8vG6UooOWvbwtR5z0AiZ4dBp9i9yQGTtqUQODJdhpOMFcW6GXecNm2hdTSD0ZcaqrN9gMalw4+fPLBWDfM9qJ42TD+DA1tIolLRlj8RhD++5zHHkw3yCOSXBk48bFCRFs8JsUxCsldzrYRBh0i/KA5PGk4F8jQQADQ1xhXyQPnL//YsbSeVMLbIG76JEQhRX5EMfMacIGb7sxHhLgKS1mlD1ukir5ppMEH5vPlBNJ9ksbtQMysbyOyziDdDtC3sqIjQCLeAcR7u5uJyUgzOfNUSJioV6+uh2OS8g4qhpqUT5mJIFSE+vTfJF5OVoYhU49hDJhrU2EFl9+bAQJ09QhBWBd94I67wLhsz//KIkVtA8OzqfKWQPtzDIfLl0alIkU1Mina5iG4MMABxylbboEISYdB5rFnNyNnw0gTur39S2Q0BsvlM8PkGPseMgDXB6RNjXKyKIG6zUgGMVlUhniDy5Sea6yDasS2QL91jmy0hc74Y9JN79ivXJpduFePWIFbFh8CnzinddPEBGhn9bqrRcCOg4kwPsAUyQnhwV8Wuv4eRId4LhEsmCcpeBLABCuqq+FVDEeYjFAasFA4X+tc7v02uQvQyLNc68lrmbYW+PKK1bu3xs08zcnKxjsQpmhiOsrplxwcF5Gq4j4cAaHwR4rK/fOg/QfpMzv+Y1mMxL0p/DXNocLDIvgBhR86AFufOjzA9Ix8ZEfOTHQk3ndQhwIwiDDAxSyqbbIv+xzA6BLLpyGUbOD5QMEJwspIMoGS9UnyIJKLR00YKFbsN1as609EQtmwBgmdLguqUFjOvdYVAxyrUEC1HWI+zKZvmbvEYkE7B8ALjoyMkSy81DaIr0jw5lRVwaquKj6AHz7vctGCAgZgJbZIBfIHn1mAHFEVukQpMfRA4giAYLYGi+nzGIc99lEFeHyLl4QzeZlwwtLZlEE0i4XkW7t1XxOm0YljlxIqv1LK1fJ6L+/sWmEasTyk5I3fVm4LuVuWCI0hWZx0NMASGGIM71DAvgwjHSuYbZtlOIc2eFnpy0a5Majd8QFwOQoF7/YGqETePFw3a5Atk9GdkvzYCYCY4cENlrmoHBLBFIZ/6lY2Hk3EK1JVY0kYDOw/wuGFiPKJ2xCgf80AVsBRhzaYydFY3X7E7eYIpK69YtkpvLUWha3gCTmFJcCTO1eqZZIY2XmZMgLJ5YDCh8PMo6RTKz6m2XCXHqhNCnT2IIHiSEMTMPXThAzBunn/w6GgJlvniINk5nAJCOeJItAFF4bAajzE9rXMix5hvZZ7d6upk5XHNDoGl5DZ4WTRYI3/jcOJ7F5Y3rRdTXt3AGcdkypc4GUR8tMFNFrZKdeE5BOJtzDpY5kdTsNf0DFmyTRoesXWd/C5gZqM2pVeGU+oh51UMX7ObW3/fPVWNySjZed73xpdeI4PSo6Hvh+7SqiybdAYfk4I3MnyvokDaOamruC9bMIhjrUfnjyj6ePUZrVECrVLZuscdgvoOr2HmpAzSP4aIhiHFw5Vi52RUmVxfuY2FRxZop+By4wGNlEq4cbY2pSBxAMjEu9JGXhQAGOXMKC6FlGN5gWOSZ+TPIyPDPNsYnZO2294ieN+w1H6JE/NxzIjl9XJQmz2VgyEARyJnM0kF5kYx1Ql6lYReUW/YIWrBJkIEHbkP2tHrULpEtb1g/P72SneWimL1lF1UpR6RC0pPWzXCYXVJRFq55DvI2EQVXWbeMG0EyTxsG0XQiG5cXwhhXzhsg8bFjn6+//efE4D/+eREQhU7GqVDf+brRJVOzsEgHgeI85gp/j0GLDAksqggOBAs2eLHg0SEwij1bUa8YFzpc0ycqWEg8h6vrMjiH1qUTXCyVc0DgxDSKyT5O3Ln5GwaaYI8nsBn1vjX5/wUNA0VFUB98ctR87/iKVi5vMFvOZSKqrBm47d0igDOBFHZ500aqYrIiNTAXuJZB0D3gaHmi2+hsUDK/2XgVcJF0W+KFHofHSvC8OSbmGmIt0z8+ImrHR4VulbDM9v2l0kx3BT8Lp+bt3XVTHEUGeVE4Fognecsq6QTYst5nwcyIrswchTvnlYsxP+zT6U23iHBdUxssJUUIjV8h0BJ2NyjmNEcIlghBAGBAUJSiHDDO4wAkNj/VV4+3AIougsLdyGAmrRVFaqa+6T0IuMQ+xp8pHXaJSKcAWGCFHjAKtd9AsxoEvzMvgEwfPXbz2je/pSi4gDpPnxCVibO5q7rac7EBijsLhAwoxCwuSJBRbPyCgVIwMywm+T6f1ULmk8+tuvg6JvaBa9YomTZxEn/NAwQsAKS3V0gAyCU7hNh6iRXgSbK+uTle0MK8/Epj/UYRrF07U+m/8Jx9h/QAmXFyA6uWrGlxQSIzs5MDBTLgYHrqp09TL9SkyBxsJrLywybd0ophsiZ3XNmn8pYbkrK8HInNwvQUhUXhm/2fX54TIPHo6B/ozVttIMx93Pj9pe8/48ExH1YBfdakVzKg0AXuo0Y5ckQksJOFm/p3uxpixDrIs7+cn9FqZtie1x816sWyi2Yzhet+m1wbaYubVRB+cE4vJn7x8AZx2RVYQSj5u5h/XP1//0esffVlu8rcj3lqFevyQzM68Hh0QGWY8JiCXIhETdI4dUrEZ8dFZcd2EVCRTyFrCxMfSGdJZoXqSZwoNJqUyJqcUrnoSuumehMAD+hLYD1aO4NAPHHcOFCN7bMziDEv2qAamro0xk5htE03amLymadE5Rv/u1hH6ccFilqHUTLzE6EnaOOJStRHR0Ud9An3RtXUUFY5Hgr3lnXjG5zW5+fc0oEZgQ2nMp5vA+CMHsnSGyPDe1syiDEvD2O9xIlXDWM8KepbjHgZPytK33lSlM+MzjA7fiyQUZou2AyGllcqYOsjR0VlaEgEUK/CJp2rxAAEbhknswzmbQhYwAYc83D7tAgx55p5TdVsKgzfzxneIkB+/PIm+LzKq68I8dQ3zT/pFaWx06Jy7pQ1LV5/LA5Q4ESjFf0gbnENi7HndqWAuZ1K4zGeFkG1Jspbt4isct31TAqusZoZeMOt4HW+2JsLifg14PKmtIs5drq226KR1/xuMQMghla0MS2IcvOG3pcPISgkpPLxB/m5XVwxG1hwkC6BQISOArsQCu5XSmZuU1E7eUpUtm7NtwvhupACg8jck+G1z9yAxvV8stpVqnvtH6AYiLK1xQDU40fBlG2aoUGSWvVBKdwCn7zETXLyzY/FBwrrE9QjAZqgAJYsqCSzDI2xMZFkTYZ1PuHc6ZCBge1EVb6TpkrzOEpz9DRbi0MucGSTgnaDBS05HpIBRB09+rY8HS9yYASyWIfgxxKZHXuspWEOm4eTdht6mCEz0enEBHo7WZCMTQyDIAvBq2LQjF1bjq24ArfJA2aGopt7iwxy8kTZLQ0s1m/4OVzyAb1OzdkcGFMDZj2AjgiY55KUg5NYGF4/ccI2+IcVBNzzjSOsWSyE0vvg2cCqxoazWSJuFOls6gymCxaAY4R1DTY7Rh8oDO7MAQL6o153gNEEDs8eyzNg0mHxBswKgiTFjZYkUD8mRwPUhfG5c0I14lx3sKlh8QotvmC5A4CEPR/lJPI4R8NuLkwvVrMZ07Z5iyUiKX/KZZBfkFyf12xihNcfyzay7smprReFZZOYeEuy5KgNaymjScbxkrMC7b3L5QDaAQwzS/PgivgsiBbZPiPwf+JkZwaQ+PSpXxfNdaR8O/AmZjm1iBWYvJdOil5lAEBJYzNpxDDwXBTiUhNgk0LeRTFj6CKz8EmOIfh835nCmhp3SYtW5Qwg6ckTQ5yskbwUweuP5R8c5MJJiXMGwKnQdsUgsImyXoskHRHD+h5mEa1n1nxAqSGL22Zlyp2w62SWwhJZjSCPpKqJ8aBQQV4wKR4hyzp4dSJ3po4owEWCFWNSIdodBAnWl5jXAEhKW7bkk506/eFAgIJg5fIB3vIMi4rI7Y2o7pWsBohVOTK8K8B+H9WaU2bXpEE8PlbEo8mzuXEe10gaQjZq2T4xguNW1OoLVjWix9Jo5NokddpvqNSpUFNNwTaRbzGCGMKI7S7gkb0S/6GzD0mLhU5+LKdYpTOfm8Rk2VwKQ6QxgUTR+UweCoAEhCuXMcZkVrBnS5qbGOmIYgATezOwYBxW4TkWCm7uyt/UtKLNg2NltYhyciyNRhYxtTpRWe/GsAo8B2KWBWcyQQvW3Q5GLGTR03Gq0Lg0INvxPMW4iLY1sLsClabvzr0Xhz38WHktwoGspqQclGDg4usopM4I5jYsmMeUf4z6IT512rIKJO2g/Sg0EeQ+tRyGh88Gk1Sr5b1cZOiK3L8fpBMTu13e8R5MO4GERCREQ7lajJc1ACDM5FomseF2nLI0n/j45Ek7+ZyjYebgRj9cKc/tShN7X/MaYDQxtdpm18X1HkybilUACUwsXDsCE2MloE/A1GBSOLWgEfY1KWsSZJdk7j75ARUeKZv2V6XKtYFBW7+fiTYecSMXl3BNO5XrKm3lBlHX0LrAkjwWBA08bp5XBhAKlls2R1c5A+xqnWBmQVikqtPRDKbIknZ+ftpCsHLrBwAF16TSLqISQVPFllsYY4VJh9aXOl/xqKpVXOIg4X0hg05kpirvGJAWq88AILo6HRQ9Fz8n7Wdq4nyDIU6+RVSgDGd9Yus6ZEDawZgJzbtRQb7FCNVkalJE23bYrcx4YTe3nzAso1nA8robx81tOaRHS3t5NKxFGqQlqEAI3VHFBUMNG35nc8NrYmi/YujzkgGO2SbNyw0ti6iCxon80e8gFoHYBqzwD6LcJEB/DwDGuvVOUC3Ac9+294qtl2xELJik9PQpEa5fD52BqAkvcQSIUy4P0HkHI19p2kmDhaW7sIpbkk6cIzeW3F9af8MVZrgtCPQlA0Bx+B48mslJbANhI67kNVH7iyCuf98zSKcJVkjjT0/Y7oWQZINJjsAklNCzkdRARprbGpZT4E4QZesel3vM3Ae4kq+0bbvdJJFZI6HgGSzOh4VeGCMJaoHs70/9ke+w4Bmc5eC6cgrfWc6gOfcCbi7ERiAcD1lhbKpbwwyxNmBJRl+14HB1Duds8hjYV4Kg3JO06kKj/a6Ubc4kqRWsMMC8QDdl267a9h+jSKmkGlVcNkHvgT2M1dhrAlZRZjkYeD/Ug5iLxuAbqo+zgejrPV3857Pe8aPdxvRU3oQGBsRJ4DEwJ057UckhewAMskWCc5sc+bF9fUxtNMnNRa1C+Z9IRKVJbqU5szuxD5a1/cCuiCVbXBTTyn2YwimKnkKDOxgQD4FcS1imJjYBmqPUgCYcHDRAmbQMAqIWXmtd3WeC0uDgEwW20J41Omo0qHodzEVATe3qtTyPQ9VlkOkFc6NrUzbrC9fm+eSVF2mJRJ1MlsxNzF37zoKh+TwzRgYT7U1Mx7EImIfJcWtmKF+T5VowAZciy9hsr73GfE6qRPrSS6RhSJ6Cd6NsqhcAchZbIXLHAKd/ucdHhwlXmnwUrWBiqtP5iZ5a3SFRf1CJALjLJ0dFg/u3a9pFDMxLuXzKapC79j0jn3wCV5XLQktGf8w7mlEALBXycKgYGRdQQDAM2nbCwqvYsAhoj2pVpOfOUtNCu0ZGB+EhSQwiZF+fZpE6g0X86Dwm4XgJMAi4t7VqpjEgJiJrVPVenbT1rYEUjb97zvZypwY0Qdx4mE2MiLZfdra4aIZvepB0RWCNV/6jVmlk1fFoMTgkD5okTdweI89kAAk3bvjLmfojd3X96BawqOJS2sDdkMFg6NAhLCPBWMdd+17OABJEpT/KzUvR1HiEdNmQTcCgFh+wki4dO0P73ZXG+OU2m3vXvq/DCnJdYA4HJH50GUhcYOQMguvuINQeRX9RBAiAZusljWYTo51dmvzoJny4wChuCtV4/pAIGo0HZgAk3HX5Zws6RDWxiR/d5OrMkoyVhkFqwt03JgdIFD2Cb1E5SLTSXod0pSfsyAfeFInuh+jR5iOvKDOoCddv0M3A4F2XvJnpKgLJ5rbZISlv2/abrQFiRmnPNd+aCQxHi/jRHeBQLgk4ssK213x8VoCEPb3v92am282Lyh2RbEs1ezvasXNi7h2nwMxs3qy0VkUG4U38PEg6fyhnY8Zm83LZzvc3v3xGVXu059qHsw9xTY3yZqYL6MMJXfDJT2TQ2wsE8ZnzAySKDsAqrszVbaIhPzoYH+7Jroryofz667/V6j0z18UYG1TZe8MLzfvDFkyNHx0tTrM5ZZAIKaKBgV+aH0BArPYPvD3bp6SFqfGju8Rp6erd45ycmxdA4MWlq/eM8Ydo3MxGZR+qPUg6jz1SO4/a2VmcT/7Stu3vmu2tsy69LG3b9kbNqlc3s4g3Mx3LHgCSDChKRNu2J5CsvWCAAIuUr77GskjaikU8SDqOPVIXKPaEr+y+5t1zvX3OxdvAIrDKm0VNdfOlorp+C4HFh987w3NRRVGa0glvHitffkXDEMH/WjBAkEXe+BN/w6JGGfc33nW1mL78dfk/9qOt3VqX8bUbtgAC2HXFnvN9xnnbPxj351aJ+4hoEYxPCL1mrUhuuFFUd+7ObJkfbTqUKpoXh03K17z+zGyeywUBBOIipTf9xEH4Z+XTo1ghHW4ZEvKf/Gq+XafHSJuaFt3SvEBX5dLQ0FXz+Zx5NZCJ7jlwV+mq3Q2dpCI4dlTAde/lVwn5yGe9qWlPtyVnjSbmwBP9zTcdbE7KXRRAULDuuGwPIK/80gsiOXYEm72H69YJcf/Hsy/hR3t4LexEZO5smnuipcuvjOGEn+/Hzb8FlbFXlRtvejSYnhLB4UOidso2RIuGjGez5+/ZL+WTee1hWog5BIcm+L45qUu7Lt99IZ93QT3KwrsP3Fm+9rrxyveeErUf/gBNDSzTW/Mf9omkZ8Dc93qkXcBRjIKTabnploPzEaYLBggyxtahnVGlotW3vykUrA6HDzHub+kjfwQb4dk+336sjEvr6o4mDVLafc25CzEtCwYIiJueG970tr6nviHOPf1UFnYP164TyQcfyunMj2UVpSJtcmkdcASD63Vp2/ZdC/nohbXBvGvfk5Wbb3lU/slnRAo9KWDIQPQYz2b6zrs9SJbbY0ns8VZJOgMgsAddz943vm2+XsviAIT0yMCmDd8a+9JjuVkxemTgxlvE+Ltu9yBZAXe2WZRC3qXnxpvvhhN6of/iohrpRvc9dOPgD549VXvxcL47YxiK9e/8eTHxj37Rg2Q5wEHsoYk9MhYxj1fe/NP/I7hn/+9fzL+Ri1FnGn/gfZPBhx5cg3ER/v6Nujj7hU+Jgb/6st3OM/RNnZcaHPljqSjvfdMr0Ycf3nWx/2pRZq00dOn2xv0fVKqWb1YDHX/X/dP3isl/8K7sB/ixiJpjLnBct/fUYoBj0RgEx8jw4OT41GtrfveAxHbQNFStKs598XNi4C+/SEwS+k0kLsqVTdFbAVNS0BsuOD76h1sW63/KRV3KACBpqNNrPvCfQtxwj39Y3Zibx78kBh7/LO73KqPAN2C9YHA4rOGIUgsUvSTgWHyA0Kjt/8BY+e4PDwY9FQckDTH2xFdF359+UkSxbRgvA69Lzo+Mpghps1lhQXrDm0aNWblksf+9XKrFUMnv/taJ4Hc+siVY05f/VvPDJv72uyL87H8VlTPHc5B4MpnVpGRlnq0ipIl1ZcFbiT70wO1L8R3kUq6WUw/c+/nkvf/6n5WHLsn2YoUfWx89Lmqf/rjo/8HTFiAIFI+SAjjYjMwIoadO8i0SlZ+++Q/Cew78u6X6HnLJl1OODN8x3rv20f7f+DciKDnitTotxh7/U7H28c/b5jaeTXLWKCTdnIJx5xKsG9SQ8riYIFh7AMSCZGf8o8Mvqrv3BeUdl1tPhkxO9aVDQj/6n0XlxCvEJnJ1apMmrZExh5opTEu7r6mXtm0fWmj4vP0AQiO977efnzx77uq+/3hARJs3W6CYA9A4c1pMfuXPrCsMPbNC3sVRrh5gqCZzonSRNWiHhp6b3/ql4J79v7BcX08u+4r9keH31P7m6S9M77lO9t3+66I8tB0PUu3EcVH94bOi/Fd/IXqOv0QmR3YvUAgYWZW5C4om9gA3NrzkUl255nV7DWs8u5xfU65IS4eR4cF0YuL79e8+dUntuhuE/ofvEOXNW4WasltlBS/+QPQ/+208il0HFF1cQJ1pDBcojomBKrCem275WnDPgZ9Zia8rV7Tnx8jwOxsvHHo8OXpE1nfsEunenxRi7YAQ4+eEPHNS9L5yWJRgRwJq1YjaxG3b2Inik5eypk3rVAogscApX70nKW3ffpVhjVdW6nvLtmgKMzL8ieq3/vpfwv4lqrdXNK68RuhySQRTk6J8+rgowUY3DJIwyJrACuoQ3K6eTwYGhy0YHM2tGBgYAKJgy5Duef11dxpgfGKlf4Nsp65B+oF7v1d7+jvX40Y3ZvJVpc8wrBYB7AULpiZr/FpkkhwsK8wsTuPhvK9KvkYlbw7ouK8IGPuYHFgnen7qxk/Jf/+hX2uXOZFt11bK6BOdJH9tgLJH0+5JMiQgsB6Rs4AkazEt8tt2o5QlEZnYkJb7fDltFQpgcLoicJ+3wn1zTYzxScMYd7QbC8p27jumHrj3a43nf3hremI0azifgcIFBzGLCxR7jT+RmEVk7aZpdx3CjZwLAc4WbW7DN9o21uk3Wuxxr2dtApiBw/zf8q5durTrirYwJR0JEIdV7khGj/+3xvOHAtz/RM5iXlzAECCawSFdEzQfc+Qcn+YNDloBY1YGoYYtsq9flK99/ZlwYODW5XZZuxcgjvkxfz/X+NEL70iOHpW8x5plFlEETgEYkojDeSw7AkLIFixSOC7ubUVdzlvszqXJ1Mzod9/TK8rXXBtH69f/igHFY53kfcmObW1pwfIn8bGjt8avvCyh5kS6rBHkQLDxk1yLSNfUzGZl3J0/3Q0NMu0hmjZechoOy1AE69aJ0lW7q2F//692Gii6AyAtIrRG3D6SHD82lLz6qlTVqpl3RcCQOVPwjkrzFa8F/eFoDwYOfFJkXPJNm3BLFcMSnzMP/dZy5Ek8QC6eYR40l9uSU6e2qrNjEnZ2hO0udJzY/dqkFnOjBBAgccWgLEXmUhZBf78IN2zU4aZNkwYY0Nf89zpBS3iAXDiAdpm/EL6GLjs7hN1ElAesBjtpLk+by1e6hQ0WMv6/AAMA0f6cCT1/KGUAAAAASUVORK5CYII=";
$Util._imgMaps = {};

$Util.registerImg = function(id,src,client){
	var image = new Image();
	image.src = src;
	image.client = {};
	if(client){
		for(var pro in client){
			image.client[pro] = client[pro];
		}
	}
	$Util._imgMaps[id] = image;
}

// $Util.canvas = document.createElement('canvas');
$Util.isDebug = function(){
    return $Util._debug;
}
$Util.checkNotNull = function(object,name) {
    if(object == null){
    	if(name){
    	  throw name + "can\'t be null";	
    	}else{
    		return false;
    	}
    }
    return true;
}

$Util.translateJson = function (json) {
    if (typeof json === 'string') {
        try {
            json = JSON.parse(json);
        } catch (e) {
        }

    }
    return json;
}

$Util.clone = function(obj) {
    var o;
    if (typeof obj == "object") {
        if (obj === null) {
            o = null;
        } else {
            if (obj instanceof Array) {
                o = [];
                for (var i = 0, len = obj.length; i < len; i++) {
                    o.push($Util.clone(obj[i]));
                }
            } else {
                o = {};
                for (var j in obj) {
                    if(typeof(o[j]) == 'function' || j == '_alarmState'){
                        continue;
                    }
                    o[j] = $Util.clone(obj[j]);
                }
            }
        }
    } else {
        o = obj;
    }
    return o;
};

$Util.getComputedStyle = function(element){
   return element.currentStyle? element.currentStyle : window.getComputedStyle(element, null);
};

$Util.updateEmptyBillboardContent = function (billboard, content, args) {

    var args = this.ext({
        contentX: 0,
        contentY: 0,
        contentWidth: billboard.args.width,
        contentHeight: billboard.args.height - billboard.args.arrowHeight
    }, args);
    args = this.ext(billboard.args, args);
    var bg = this.getBillboardContent(args);
    var ct = bg.getContext('2d');
    ct.drawImage(content, args.contentX, args.contentY, args.contentWidth, args.contentHeight);
    billboard.s({
        'm.texture.image': bg
    });
}

$Util.updateTextBillboardText = function (billboard, text, bgColor) {
    text = text || '';
    var content = it.Util.getTextBillboardContent(text, bgColor);
    this.updateTextBillboardContent(billboard, content)
}

$Util.updateTextBillboardContent = function (billboard, content) {

    billboard.s({
        'm.texture.image': content
    });
    billboard.contentWidth = content.width;
    billboard.contentHeight = content.height;
    billboard.setScale(content.width / 2, content.height / 2, 1);
}

$Util.updateTitleBillboardContent = function (billboard, content) {
    var width = billboard.contentWidth;
    var height = billboard.contentHeight;
    var title = billboard.title;
    var canvas = it.Util.getTitleBillboardContent(title, content, width, height, billboard.content);
    billboard.s({
        'm.texture.image': canvas
    });
}

$Util.createEmptyBillboardForNode = function (node, args) {
    var board = this.createEmptyBillboard(args)
    var bb = node.getBoundingBox();
    board.setParent(node);
    board.p(0, bb.max.y, 0);
    return board;
};

$Util.createEmptyBillboard = function (args) {
    args = it.Util.ext({
        width: 256,
        height: 128,
        radius: 16,
        arrowWidth: 16,
        arrowHeight: 16,
        bgColor: '#5B85B5',
    }, args);
    var c = this.getBillboardContent(args);
    var board = new mono.Billboard();
    board.s({
        'm.texture.image': c,
        'm.transparent': true,
        'm.alignment': mono.BillboardAlignment.bottomCenter,
        'm.vertical': false,
    });
    board.args = args;
    board.setScale(args.width, args.height, 1);
    board.setSelectable(false);
    board.contentWidth = args.width;
    board.contentHeight = args.height;
    board.isEmptyBillboard = true;
    return board;
};

$Util.createTitleBillboardForNode = function (node, args) {
    var board = this.createTitleBillboard(args);
    var bb = node.getBoundingBox();
    board.setParent(node);
    board.p(0, bb.max.y, 0);
    return board;
};

$Util.getTitleBillboardContent = function (title, content, width, height, contentBackground) {

    var canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    var context = canvas.getContext('2d');
    context.save();
    context.drawImage(title, Math.max(0, (canvas.width - title.width) / 2), 0, title.width, title.height);
    context.translate(0, title.height);
    if (contentBackground) {
        context.drawImage(contentBackground, Math.max(0, (canvas.width - contentBackground.width) / 2), 0, contentBackground.width, contentBackground.height, 0, 0, width, height - title.height);
    }
    context.drawImage(content, Math.max(0, (canvas.width - content.width) / 2), 0, content.width, content.height, 0, 0, width, height);

    return canvas;
}

$Util.createTitleBillboard = function (args) {
    args = it.Util.ext({
        title: '标题',
        titleColor: '#FFFFFF',
        titleFont: '24px LEDFont,sans-serif',
        titleBgColor: '#4a74a4',
        titleWidth: 256,
        titleHeight: 32,
        titleRadius: 16,
        width: 256,
        height: 128,
        radius: 0,
        arrowWidth: 0,
        arrowHeight: 0,
        bgColor: '#5B85B5',
    }, args);
    var title = this.getBillboardTitle(args);
    var content = this.getBillboardContent(args);
    var width = Math.max(title.width, content.width);
    var height = title.height + content.height;
    var canvas = it.Util.getTitleBillboardContent(title, content, width, height);
    var board = new mono.Billboard();
    board.title = title;
    board.content = content;
    board.s({
        'm.texture.image': canvas,
        'm.transparent': true,
        'm.alignment': mono.BillboardAlignment.bottomCenter,
        'm.vertical': false,
    });
    board.args = args;
    board.setScale(canvas.width, canvas.height, 1);
    board.setSelectable(false);
    board.contentWidth = width;
    board.contentHeight = height;
    board.isTitleBillboard = true;
    return board;
};

$Util.createTextBillboard = function (text, gbColor) { // 考虑标题header，考虑Chart图表等
    var c = this.getTextBillboardContent(text, gbColor);
    var board = new mono.Billboard();
    board.s({
        'm.texture.image': c,
        'm.transparent': true,
        'm.alignment': mono.BillboardAlignment.bottomCenter,
        'm.vertical': false,
        'm.texture.wrapS':TGL.ClampToEdgeWrapping,
        'm.texture.wrapT':TGL.ClampToEdgeWrapping
    });
    board.setScale(c.width/2, c.height/2, 1);
    board.setSelectable(false);
    board.contentWidth = c.width;
    board.contentHeight = c.height;
    board.isTextBillboard = true;
    return board;
};

$Util.createTextBillboardForNode = function (node, text, gbColor) {
    text = text || '';
    var board = this.createTextBillboard(text, gbColor);
    var bb = node.getBoundingBox();
    board.setParent(node);
    board.p(0, bb.max.y, 0);
    return board;
};

$Util.createSpecailTextBillboard = function (text, gbColor,isHumOrTemp,canvas) { // 考虑标题header，考虑Chart图表等
    var c = null;
    if (isHumOrTemp) {
    	c = this.getHumOrTempCanvas(text, null, null, gbColor,canvas);
    }else{
    	c = this.getSpecialTextBillboard(text, null, null, gbColor,canvas);
    }
    var board = new mono.Billboard();
    board.s({
        'm.texture.image': c,
        'm.transparent': true,
        'm.alignment': mono.BillboardAlignment.bottomCenter,
        'm.vertical': false,
    });
    board.setScale(c.width / 2, c.height / 2, 1);
    board.setSelectable(false);
    board.contentWidth = c.width;
    board.contentHeight = c.height;
    board.isTextBillboard = true;
    board.invalidateTexture();
    return board;
};

$Util.getImageById = function(id,value) {
	if (!id) {
		return this.dropImg;
	}
	if (this._imgMaps 
	    && this._imgMaps[id]) {
		return this._imgMaps[id];
	} else if (this[id]) {
		return this[id];
	} else {
		return this.dropImg;
	}
};

/**
 * 刷新或创建温/湿度的Canvas
 */
$Util.getHumOrTempCanvas = function(text, titleText, endText, bgcolor, canvas) {
	var image = this.getImageById(bgcolor,text);
	var canvas = canvas || document.createElement('canvas');
	if (!image) {
		return canvas;
	}
	if (!image.client) {
		image.client = {width:318,height:442,size:50,lineWidth:5,color:'#FFFFFF',startX:100,startY:300};
	};
	color = image.client['color']||'#888888';
	var width = image.width,
		height = image.height;
	var context = canvas.getContext('2d');
	width = image.client['width']||image.width * 2, height = image.client['height']||image.height * 2;
	canvas.height = height;
    canvas.width = width;
	context.drawImage(image, 0, 0, width, height);
	var x = parseInt(image.client['startX'])||(height - 50);
	var y = parseInt(image.client['startY'])||(height - 50);
	if (text) {
		var csize = parseInt(image.client['size'])||80;
		context.font = csize + 'px "Microsoft Yahei" ';
		context.strokeStyle = color;
		context.fillStyle = color;
		context.textAlign = 'left';
		context.textBaseline = 'middle';
		context.lineWidth = parseInt(image.client['lineWidth'])||8;	
		if (image.client['stroke']) {
			context.strokeText(text, x, y);
		}else{
			context.fillText(text, x, y);
		}
	}
	return canvas;
};

$Util.createHumOrTempCanvas = function(text,unit, bgcolor, canvas){
	var image = it.Util.getImageById(bgcolor, text);
        var canvas = canvas || document.createElement('canvas');
        if (!image) {
            return canvas;
        }
        if (!image.client) {
            image.client = {
                width: 256,
                height: 123,
                size: 50,
                lineWidth: 5,
                color: '#FFFFFF',
                startX: 20,
                startY: 60
            };
        };
        color = image.client['color'] || '#888888';
        var width = image.width,
            height = image.height;
        var context = canvas.getContext('2d');
        width = image.client['width'] || image.width * 2, height = image.client['height'] || image.height * 2;
        canvas.height = height;
        canvas.width = width;
        context.drawImage(image, 0, 0, width, height);
        var x = parseInt(image.client['startX']) || (height - 50);
        var y = parseInt(image.client['startY']) || (height - 50);
        if (text) {
            var csize = parseInt(image.client['size']) || 80;
            var fontFamily = image.client['fontFamily']||'"Microsoft Yahei"';
            // context.font = '80px DigifaceWide';            
            context.font = 'bold '+csize + 'px ' + fontFamily;
            context.textAlign = 'left';
            context.textBaseline = 'middle';
            context.lineWidth = parseInt(image.client['lineWidth']) || 8;
            if (image.client['stroke']) {
                context.strokeStyle = color;
                context.strokeText(text, x, y);
            } else {
                context.fillStyle = color;
                context.fillText(text, x, y);
            }
            if (image.client['withUnit'] && unit) {
                var width = context.measureText(text).width;
                var unitSize = parseInt(csize/2)||5;
                context.font = 'bold '+unitSize + 'px "Microsoft Yahei"';
                if (image.client['stroke']) {
                     context.strokeText(unit, x+width, y);
                }else{
                     context.fillText(unit, x+width, y);
                }
            }

        }
        return canvas;
};

/**
 * 目前流量的billboard用到了这个
 */
$Util.getSpecialTextBillboard = function(text,titleText,endText,bgcolor,canvas){
    var canvas = canvas || document.createElement('canvas');
    var context = canvas.getContext('2d');
    var width,height;
    // if(isHumOrTemp){
    //   width  = 318;
    //   height = 442;
    // }else{
      width = 512;
      height = 256;
    // }
    var arrowHeight = height / 4;
    var arrowWidth = width / 4;
    canvas.height = height + arrowHeight;
    canvas.width = width;
    
    this.getBillboardContent({
        width: width,
        height: height + arrowHeight,
        radius: width / 16,
        arrowWidth: arrowWidth,
        arrowHeight: arrowHeight,
        bgColor: bgcolor,
        canvas: canvas,
        // isHumOrTemp:isHumOrTemp
    });
    /*
    if(isHumOrTemp){
        text = parseInt(text)+"";
        // text = text+"";
        height= height + arrowHeight;
        var color='#888888';
        var bgImage = this.dropImg;
        if (bgcolor 
        	&& this._imgMaps 
        	&& this._imgMaps[bgcolor]) {
        	color = '#FFFFFF';
            bgImage = this._imgMaps[bgcolor];
            // context.drawImage(this._imgMaps[bgcolor],30,10,288,432);
        }else if (bgcolor && this[bgcolor]) {
            color='#FFFFFF';
            bgImage = this[bgcolor];
        	// context.drawImage(this[bgcolor],30,10,288,432); 
        }else{
            color='#888888';
            bgImage = this.dropImg;
        	// context.drawImage(this.dropImg,30,10,288,432); 
        }
        width = bgImage.width*2,height = bgImage.height*2;
        context.drawImage(bgImage,30,10,width,height); 

        if(text){
            var csize = 80;
            context.font = csize+'px "Microsoft Yahei" ';
            context.strokeStyle=color;
            // context.fillStyle = color;
            context.textAlign = 'left';
            context.textBaseline = 'middle';
            context.lineWidth=8;
            if(text.length == 2){
                context.strokeText(text, 2*height/10-10, 2*height/3-50);
            }else if(text.length <2){
                context.strokeText(text, 2*height/10+10, 2*height/3-50);
            }else{
                context.strokeText(text, 2*height/10-30, 2*height/3-50);
            }
        }
        if(endText){
            var esize = 50;
            context.font = esize+'px "Microsoft Yahei" ';
            context.fillStyle = color;
            context.textAlign = 'right';
            context.textBaseline = 'middle';
            context.fillText(endText, width-height/10, height/2+50);
        }
    }else{
    	*/
        var color='white';
        if(titleText){
            var tsize = 50;
            context.font = tsize+'px "Microsoft Yahei" ';
            context.fillStyle = color;
            context.textAlign = 'left';
            context.textBaseline = 'middle';
            context.fillText(titleText, height/10, height/5);
        }
        if(text){
            var csize = 120;
            context.font = csize+'px "Microsoft Yahei" ';
            context.fillStyle = color;
            context.textAlign = 'left';
            context.textBaseline = 'middle';
            context.fillText(text, 2*height/10, 2*height/3);
            context.strokeStyle=color;
            context.lineWidth=4;
            context.strokeText(text, 2*height/10, 2*height/3);
        }
        if(endText){
            var esize = 60;
            context.font = esize+'px "Microsoft Yahei" ';
            context.fillStyle = color;
            context.textAlign = 'right';
            context.textBaseline = 'middle';
            context.fillText(endText, width-height/10, height/2+20);
        }
    // }
    return canvas;
};

$Util.getTextBillboardContent = function (label, bgcolor, args) {

    args = args || {};
    var canvas = document.createElement('canvas');
     var context = canvas.getContext('2d');
     context.font = "120px LEDFont,sans-serif";
     
     var array = [];
     if(label.indexOf("\n")){
         array= label.split("\n");
     }else{
         array= [label]
     }
     var length = 0;
     for(var i = 0;i < array.length;i ++){
        if(i == 0){
           length = context.measureText(array[i]).width;
        }else{
           length = Math.max(context.measureText(array[i]).width,length);
        }
    }

    var size = mono.Utils.getMaxTextSize(array, context.font);
    var c_width = mono.Utils.nextPowerOfTwo(length);
    var oHeight = size.height;
    var arrowHeight = oHeight / 4;
    var arrowWidth = c_width / 4;
    var c_height = mono.Utils.nextPowerOfTwo(oHeight + arrowHeight);
   
    canvas.height = c_height;
    canvas.width = c_width;
    var lineHeight = c_height / array.length;
    var oLineHeight = oHeight / array.length;

    args = it.Util.ext({
        labelColor: 'white',
        width: c_width,
        height: c_height,
        radius: (c_width / 16),
        arrowWidth: arrowWidth,
        arrowHeight: arrowHeight,
        bgColor: bgcolor,
        canvas: canvas
    }, args);
    this.getBillboardContent(args);

    context.fillStyle = args.labelColor;
    context.textBaseline = 'middle';
    context.font = "120px LEDFont,sans-serif";
    for (var i = 0; i < array.length; i++) {
        var text = array[i];
        length = context.measureText(text).width;
        context.fillText(text, (c_width - length) / 2, lineHeight * (i + 0.5));
    }
    return canvas;
};

/**
 * 根据相关的参数画一个外边框
 * @param args
 * @returns {*}
 */
$Util.getBillboardTitle = function (args) {
    var width = args.titleWidth = mono.Utils.nextPowerOfTwo(args.titleWidth) || 192;
    var height = args.titleHeight = mono.Utils.nextPowerOfTwo(args.titleHeight) || 64;
    var radius = args.titleRadius || 8;

    var canvas = args.canvas;
    if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
    }
    var context = canvas.getContext('2d');
    context.globalAlpha = args.globalAlpha || 0.8;
    context.fillStyle = args.titleBgColor || '#5B85B5';
    context.font = args.titleFont || '120px LEDFont,sans-serif';
    var titleSizeWidth = args.titleSizeWidth = context.measureText(args.title).width;
    var titleSizeHeight = args.titleSizeHeight = mono.Utils.getMaxTextSize(args.title, args.titleFont);
    context.beginPath();
    context.moveTo(0, height);
    context.lineTo(0, radius);
    context.arcTo(0, 0, radius, 0, radius);
    context.lineTo(width - radius, 0);
    context.arcTo(width, 0, width, radius, radius);
    context.lineTo(width, height);
    context.closePath();
    context.fill();
    context.textBaseline = 'top';
    context.fillStyle = args.titleColor || '#A5855B';
    context.fillText(args.title, (width - titleSizeWidth) / 2, 2);
    context.restore();
    context.restore();
    return canvas;
}

/**
 * 根据相关的参数画一个下面有三角行的外边框
 * @param args
 * @returns {*}
 */
$Util.getBillboardContent = function (args) {

    args = it.Util.ext({width: 256, height: 128, radius: 20, arrowWidth: 50, arrowHeight: 30}, args);
    var width = args.width;
    var height = args.height;
    var radius = args.radius;
    var arrowWidth = args.arrowWidth;
    var arrowHeight = args.arrowHeight;

    var canvas = args.canvas;
    if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
    }
    if(!args.isHumOrTemp){
        var context = canvas.getContext('2d');
        context.globalAlpha = args.globalAlpha || 0.8;
        context.fillStyle = args.bgColor || '#5B85B5';
        context.save();
        context.beginPath();
        context.moveTo(radius, 0);
        context.lineTo(width - radius, 0);
        context.arcTo(width, 0, width, radius, radius);
        context.lineTo(width, height - arrowHeight - radius);
        context.arcTo(width, height - arrowHeight, width - radius, height - arrowHeight, radius);
        context.lineTo(width / 2 + arrowWidth / 2, height - arrowHeight);
        context.lineTo(width / 2, height);
        context.lineTo(width / 2 - arrowWidth / 2, height - arrowHeight);
        context.lineTo(radius, height - arrowHeight);
        context.arcTo(0, height - arrowHeight, 0, height - arrowHeight - radius, radius);
        context.lineTo(0, radius);
        context.arcTo(0, 0, radius, 0, radius);
        context.closePath();
        context.fill();
        context.restore();
    }
    return canvas;
}

/**
 * 获取node的中心点，有些时候position并不是其真正的中心点，有可能对象自身的坐标并不是从中间开始的
 * @param node
 * @returns {position}
 */
$Util.getNodeCenterPosition = function (node) {
    if (!node) return null;
    var boundingBox = node.getBoundingBox();
    var offx = (boundingBox.max.x + boundingBox.min.x)/2*node.getScaleX();
    var offy = (boundingBox.max.y + boundingBox.min.y)/2*node.getScaleY();
    var offz = (boundingBox.max.z + boundingBox.min.z)/2*node.getScaleZ();
    var position = node.getWorldPosition();
    position.setX(position.x + offx);
    position.setY(position.y + offy);
    position.setZ(position.z + offz);
    return position;
};

$Util.formatDate = function (date, format) {
    if(!date || !format){
        return null;
    }
    var o = {
        'M+': date.getMonth() + 1,
        'd+': date.getDate(),
        'h+': date.getHours(),
        'm+': date.getMinutes(),
        's+': date.getSeconds(),
        'q+': Math.floor((date.getMonth() + 3) / 3),
        'S': date.getMilliseconds()
    };
    if (/(y+)/.test(format))
        format = format.replace(RegExp.$1, (date.getFullYear() + '').substr(4 - RegExp.$1.length));
    for (var k in o)
        if (new RegExp('(' + k + ')').test(format))
            format = format.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (('00' + o[k]).substr(('' + o[k]).length)));
    return format;
};

$Util.formateDateTime = function(date) {
	if (!date) {
		return "";
	}
	if (typeof(date) == 'string') {
		var local = new Date(date);
		var utc = local.getTime() + local.getTimezoneOffset() * 60000;
		date = new Date(utc);
	}
	if (date instanceof Date) {
		return it.Util.formatDate(date, 'yyyy-MM-dd hh:mm:ss');
	} else {
		return date;
	}
};

/**
 * 第一个参数是target, 返回target
 * @returns {*|{}}
 */
$Util.ext = function () {
    /*
     　　*target被扩展的对象
     　　*length参数的数量
     　　*deep是否深度操作
     　　*/
    var options, name, src, copy, copyIsArray, clone,
        target = arguments[0] || {},
        i = 1,
        length = arguments.length,
        deep = false;

    // target为第一个参数，如果第一个参数是Boolean类型的值，则把target赋值给deep
    // deep表示是否进行深层面的复制，当为true时，进行深度复制，否则只进行第一层扩展
    // 然后把第二个参数赋值给target
    if (typeof target === "boolean") {
        deep = target;
        target = arguments[1] || {};

        // 将i赋值为2，跳过前两个参数
        i = 2;
    }

    // target既不是对象也不是函数则把target设置为空对象。
    if (typeof target !== "object" && !jQuery.isFunction(target)) {
        target = {};
    }

    // 如果只有一个参数，则把jQuery对象赋值给target，即扩展到jQuery对象上
    if (length === i) {
        target = this;

        // i减1，指向被扩展对象
        --i;
    }

    // 开始遍历需要被扩展到target上的参数

    for (; i < length; i++) {
        // 处理第i个被扩展的对象，即除去deep和target之外的对象
        if ((options = arguments[i]) != null) {
            // 遍历第i个对象的所有可遍历的属性
            for (name in options) {
                // 根据被扩展对象的键获得目标对象相应值，并赋值给src
                src = target[name];
                // 得到被扩展对象的值
                copy = options[name];

                // 这里为什么是比较target和copy？不应该是比较src和copy吗？
                if (target === copy) {
                    continue;
                }

                // 当用户想要深度操作时，递归合并
                // copy是纯对象或者是数组
                if (deep && copy && ( jQuery.isPlainObject(copy) || (copyIsArray = jQuery.isArray(copy)) )) {
                    // 如果是数组
                    if (copyIsArray) {
                        // 将copyIsArray重新设置为false，为下次遍历做准备。
                        copyIsArray = false;
                        // 判断被扩展的对象中src是不是数组
                        clone = src && jQuery.isArray(src) ? src : [];
                    } else {
                        // 判断被扩展的对象中src是不是纯对象
                        clone = src && jQuery.isPlainObject(src) ? src : {};
                    }

                    // 递归调用extend方法，继续进行深度遍历
                    target[name] = jQuery.extend(deep, clone, copy);

                    // 如果不需要深度复制，则直接把copy（第i个被扩展对象中被遍历的那个键的值）
                } else if (copy !== undefined) {
                    target[name] = copy;
                }
            }
        }
    }

    // 原对象被改变，因此如果不想改变原对象，target可传入{}
    return target;
};

$Util.jsonUtil = {
    object2String: function (obj) {
        try {
            var str = JSON.stringify(obj);
            return str;
        } catch (e) {
            if ($Util.isDebug()) {
                throw  e;
            } else {
                console.error('json对象转字符串失败', obj);
            }
        }
    },
    string2Object: function (str) {
        try {
            var obj = JSON.parse(str);
            return obj;
        } catch (e) {
            // if (Util.isDebug()) {
            //     throw  e;
            // } else {
                console.error('字符串转json对象失败', str);
            // }
        }
    }
};

$Util.o2s = function (o) {
    return $Util.jsonUtil.object2String(o);
}

$Util.s2o = function (s) {
    return $Util.jsonUtil.string2Object(s);
}

$Util.toJsonArray = function (json) {
    if (!json) {
        return [];
    }
    var jsonObject = json;
    if (typeof json === "string") {
        jsonObject = $Util.s2o(json);
    }
    var jsonObjects;
    if (jsonObject instanceof Array) {
        jsonObjects = jsonObject;
    } else {
        jsonObjects = [jsonObject];
    }
    return jsonObjects;
}

$Util.findFirstObjectByMouse = function (network, e, filter) {
    if (!filter) {
        filter = function (object3d) {
            return !(object3d instanceof mono.Billboard);
        }
    }
    var objects = network.getElementsByMouseEvent(e);
    if (objects.length) {
        for(var i=0;i<objects.length;i++){
            var first = objects[i];
            var object3d = first.element;
            if(filter(object3d)){
                return first;
            }
        }
    }
    return null;
};

$Util.compare = function(a, b) {
	if (a == b) {
		return 0;
	}

	if (a.length == 0) {
		return 1;
	}
	if (b.length == 0) {
		return -1;
	}
	if (a > b) {
		return 1;
	} else if (b > a) {
		return -1;
	} else {
		return 0;
	}

};

$Util.getEstimateOverviewPositionAndTarget = function(network,angle){
	if (!network) { 
		return null;
	}
	var camera = network.getCamera();
	var bb = network.getNetworkBoundingBox();
     if(bb == null){
        return null;
      }
      var center = bb.center();
      var sub1 = new mono.Vec3(0,bb.max.y - bb.min.y,bb.max.z - bb.min.z);
      var sub2 = new mono.Vec3(bb.max.x - bb.min.x,0,0,0);
      var sub = sub1.clone();
      if(sub.length() < sub2.length()){
          sub = sub2.clone();
      }
      var position;
      if(angle){
        var l = sub1.length();
        sub1.y = sub1.z * Math.tan(angle / 180 * Math.PI);
        sub1.setLength(l);
      }
      position = new mono.Vec3().addVectors(center,sub1.multiplyScalar(0.5));
        var fov = camera.fov,aspect = camera.aspect;
        var length = sub.length() / 2 / Math.tan(fov * Math.PI/180);
        position.add(sub1.normalize().multiplyScalar(length));
      // this._camera.setPosition(position);
      // this._camera.lookAt(center);
      return {target:center,position:position};
      // this._overviewDistance = this._camera.getDistance();
};

/**
 * 计算boudingBox
 * 这里计算时注意：这个boundingBox的相关坐标都变成了绝的坐标值，所以这里算之前重新clone了一份，然后将位置置为原点，这样boundingBox就对称了
 * @includeChildren 是计算boundingBox一定包含孩子的的
 */
$Util.getBoundingBox = function(node,includeChildren) {
	if (!node) {
		return null;
	}
	if (node instanceof mono.Billboard) {
		return null;
	}
	var box = node.getBoundingBox?node.getBoundingBox():null;
	if (!includeChildren 
		&& box
		&& box.size().x 
		&& box.size().x != -Infinity
		&& box.size().x != Infinity) {
		return box;
	}
	var vertices = [];
	var cNode = node.clonePrefab();
	cNode.setPosition(0,0,0);
	$Util.getTransformVertices(cNode, vertices);
	box = new mono.BoundingBox();
	box.setFromPoints(vertices); //虽然将移到了0，可是算出来的boundingBox的Y还是绝对的 ，注意！！！
	return box;
};

$Util.getTransformVertices = function(node, vertices) {
    if (vertices == null) {
        vertices = [];
    }
    var i, vertex;
    if ( node instanceof TGL.Node || node instanceof TGL.Billboard) {
        for ( i = 0; i < node.vertices.length; i++) {
            vertex = node.vertices[i].clone();
            if ( node instanceof TGL.Billboard) {
                vertex.x *= node.rotation3d.x;
                vertex.y *= node.rotation3d.y;
                vertex.add(node.getPosition());
            } else {
                vertex.applyMatrix4(node.worldMatrix);
            }
            vertices.push(vertex);
        }
        for (var i = 0; i < (node._childList ? node._childList.size() : 0); i++) {
            var child = node._childList.get(i);
            if (child.getClient('it_data_id') == node.getClient('it_data_id') 
            	&& node.getClient('type') != 'parkSkybox'//不是天空盒
            	) { 
            	$Util.getTransformVertices(child, vertices);
            }
        }
    }
    return vertices;
};

/**
 * 动画移动镜头
 * @method playCameraAnimation
 * @static
 * @param  {mono.Camera}   camera   镜头
 * @param  {mono.Vec3}   [pos=null]      镜头位置，如果未提供，则取镜头当前的位置
 * @param  {mono.Vec3}   [target=null]   镜头焦点，如果未提供，则取镜头当前的焦点
 * @param  {Number}   [time=2000]     动画播放的时间，默认为2000ms
 * @param  {Function} callback 动画播放完后执行的回调函数
 * 注意：改变camera的target和pos，应该尽快的让target设置到位，否则当lookAt某个对象时，target差的较多的话，会一直看不到对象
 * play的过程：
 *       1、移动camera的target设置成新的target,并且distance最大的(跟最终的camera的distance比较)；
 *       2、旋转Camera(离地面最高点)至pos的上面；
 *       3、拉近
 * 有可能一个动画只有1，2，3中的一步或两步
 */
$Util.playCameraAnimation = function(camera, pos, target, time, callback) {
  if($Util.activeAnimates && $Util.activeAnimates instanceof Array){ //先停止之前的animate，有可能还没有执行完
    for(var a = 0 ; a < $Util.activeAnimates.length ; a++){
      $Util.activeAnimates[a].stop();
    }
  }
    pos = pos || camera.p();
    target = target || camera.getTarget();
    if(pos.equals(camera.getPosition()) 
       && target.equals(camera.target)){ //位置没变就直接返回吧
        callback&&callback();
      return null;
    }
    var offset=camera.getPosition().sub(camera.getTarget());
    var t_position=new mono.Vec3().addVectors(offset, target);
    time = time || 3000;
    // time = 3000;

    var angles = mono.Utils.getVectorAngles(target, t_position);//camera.getTarget(), camera.p()
    var angles2 = mono.Utils.getVectorAngles(target, pos);
    var dha = angles2[0] - angles[0];
    if (dha > 180) {
        dha = dha - 360;
    } else if (dha < -180) {
        dha = dha + 360;
    }
    var dva = angles2[1] - angles[1];
    if (dva > 180) {
        dva = dva - 360;
    } else if (dva < -180) {
        dva = dva + 360;
    }

    var t1 = camera.getTarget();
    var t2 = target;
    var d1 = camera.getDistance(),d2 = new mono.Vec3().subVectors(pos, target).length();
    var ang00 = angles[0],ang01 = angles[1],ang10 = angles2[0],ang11 = angles2[1];

    var animate2 = new mono.Animate({
      from:0,
      to:1,
      repeat:1,
      dur:time/3,
      onPlay : function(){
        this.isPlaying = true;
      },
      onUpdate : function(value){ // 2、拉近，x,y,z都会改变，并且拉近镜头的distance
            var hAngle = ang10; // 已经变到头了
            // var vAngle = ang01 + dva * value;
            // var vAngle = ang01>ang11?(ang01 + dva * value):(ang01 + dva );
            var vAngle = ang01>ang11?(ang01 + dva * value):ang11;//:ang10(还不能直接ang10，如果180的话会多转一圈);
            // var vAngle = ang01>ang11?ang01:ang11;
            var t = t2;//new mono.Vec3().lerpVectors(t1, t2, value);
            var d = d1 + (d2 - d1) * value;
            // update 2017-09-14 Kevin 当设备平视，有可能直接从animate0到animate2 //2017-8-31没有改全，
            // var d = d1 > d2 ? d1 : d2; 
            if(d2 > d1 && dha == 0 && ang11 < ang01){ // 没走animate1，直接从animate0到animate2,d2是终止的，有可能老早就到了d2
              // d = (d1 + (d2 - d1) * value); 
               d = d2; 
            }
            var newPos = new mono.Vec3();
            newPos.x = t.x + d * Math.sin(hAngle * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(vAngle * mono.Utils.DEGREES_TO_RADIANS);
            newPos.z = t.z + d * Math.cos(hAngle * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(vAngle * mono.Utils.DEGREES_TO_RADIANS);
            newPos.y = t.y + d * Math.sin(vAngle * mono.Utils.DEGREES_TO_RADIANS);
            camera.p(newPos);
            camera.lookAt(t);
      },
      onDone : function() {
            if (callback)
                callback();
      },
      onStop : function(){
            // delete this.isPlaying;
      }
    });

    var animate1 = new mono.Animate({ // 1、旋转到正面，主要是改变x和z，镜头的distance也不变
      from: 0,
      to: 1,
      repeat: 1,
      dur: time / 3,
      onPlay: function() {
        // console.log('onplay 1');
        this.isPlaying = true;
      },
      onUpdate: function(value) {
        var hAngle = ang00 + dha * value; // 纬度变成用新的
        // var vAngle = ang01>ang11?ang01:(ang01 + dva * value);//  经度开始不变，应该用最大的，否则由近到远时(如从看到机柜到看到整个楼层)旋转有可能在内部，不能看到整个
        var vAngle = ang01 > ang11 ? ang01 : ang11;
        var t = t2; //new mono.Vec3().lerpVectors(t1, t2, value); //

        // add by Kevin 2017-06-05 ，当不需要进行animate2时(即ang11 >= ang01)时，直接用d1(目标distance)
        var d = d1 > d2 ? d1 : d2; //(d1+(d2-d1)*value); // camera的距离用最大的那个
        // if(ang11 >= ang01){
            // var d = d2;
        // }
        if(d1 > d2 && ang11 >= ang01){ // update 2017-08-31 Kevin 设备到机柜时：d1<d2 && ang11 >= ang01
            d = (d1 + (d2 - d1) * value); 
        }

        var newPos = new mono.Vec3();
        newPos.x = t.x + d * Math.sin(hAngle * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(vAngle * mono.Utils.DEGREES_TO_RADIANS);
        newPos.z = t.z + d * Math.cos(hAngle * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(vAngle * mono.Utils.DEGREES_TO_RADIANS);
        newPos.y = t.y + d * Math.sin(vAngle * mono.Utils.DEGREES_TO_RADIANS);
        camera.p(newPos);
        camera.lookAt(t);
      },
      onDone: function() {
        //     if (callback)
        //         callback();
        d1 = camera.getDistance(); // 第一步运行完后，距离重新算一下
        t1 = camera.getTarget();
      },
      onStop: function() {
        // console.log('stop1');
        if (this.isPlaying) {  // add by Kevin 2017-06-01 ，不这样有可能会有死循环，当callback中也有playCamera时，当前的animate永远是激活状态的，stop时总会调到
          delete this.isPlaying;

          if (ang11 >= ang01) {
            callback && callback();
          } else {
            animate2.play();
          }
        }
      }
    });

    // 起点是当前Camera没动之前的pos和target
    //点是pos是：在离target的距离为原始的(当前Camera)tar到pos之间和目标tar到目标pos之间的最大的距离，并且离平面高度为原始的和最终的最高的；target：最终的目标target
    var animate0 = new mono.Animate({ // 移动target，将target移至新的target
      from: 0,
      to: 1,
      dur: time / 3,
      onPlay: function() {
        this.isPlaying = true;
      },
      onUpdate: function(value) {
        var hAngle = ang00; // 纬度变成用新的
        // var vAngle = ang01;//  经度开始不变，应该用最大的，否则由近到远时(如从看到机柜到看到整个楼层)旋转有可能在内部，不能看到整个
        var vAngle = ang01 > ang11 ? ang01 : (ang01 + dva * value); //  经度开始不变，应该用最大的，否则由近到远时(如从看到机柜到看到整个楼层)旋转有可能在内部，不能看到整个
        var t = new mono.Vec3().lerpVectors(t1, t2, value); //
        // camera的距离用最大的那个，
        // add by Kevin 2017-06-05 ，可是当不需要旋转(aminate2,并且hAngle为0)时，应该直接一步到位用: (d1 + (d2 - d1) * value)
        // var d = d1 > d2 ? d1 : (d1 + (d2 - d1) * value); // camera的距离用最大的那个
        var d = (d1 + (d2 - d1) * value); 
        if(d1 > d2 && (dha != 0 || ang11 < ang01)){
            d = d1; 
        }
        var newPos = new mono.Vec3();
        newPos.x = t.x + d * Math.sin(hAngle * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(vAngle * mono.Utils.DEGREES_TO_RADIANS);
        newPos.z = t.z + d * Math.cos(hAngle * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(vAngle * mono.Utils.DEGREES_TO_RADIANS);
        newPos.y = t.y + d * Math.sin(vAngle * mono.Utils.DEGREES_TO_RADIANS);
        camera.p(newPos);
        camera.lookAt(t);
      },
      onDone: function() {

      },
	onStop: function() { // stop 一定会被执行，onDone则不一定
		// console.log('stop0');
		if (this.isPlaying) {
			delete this.isPlaying;
			if (dha == 0 && ang11 >= ang01) { // 纬度为0，并其经度已经调整到位了，直接退出  ang11 >= ang01 
				callback && callback();
			} else if (dha != 0) { //还需要调整纬度
				setTimeout(function() {
					animate1.play();
				}, 0); // onStop 是异步的 
			} else { // 纬度不需要调整了，单是经度有偏差
				setTimeout(function() {
					animate2.play();
				}, 0); // onStop 是异步的 
			}
		}
	}
 });

    // 不用动画链，因为有可能有些动画不需要执行
    // animate0.chain(animate1);
    // animate1.chain(animate2);
    if(dha == 0 && ang11 >= ang01){ //当只有一段时，时间全耗在这里
        animate0.dur = time;
        animate0.finish = time;
    }else if (dha == 0){
        animate2.dur = time*2/3; //当只有两段时，第一段移动焦点1/3,拉近2/3
        animate2.finish = time*2/3; 
    }else if (ang11 < ang01) { // else if (ang11 >= ang01) { update 2017-08-09
        animate1.dur = time*2/3; //当只有两段时，第一段移动焦点1/3,旋转2/3
        animate1.finish = time*2/3; 
    }
    animate0.play();
    $Util.activeAnimates = [animate0,animate1,animate2];
    return [animate0,animate1,animate2];
};

$Util.getZoomEstimateOverviewTargetAndPosition = function(network, angle) {
	if (!network) {
		return;
	}
	var bb = network.getNetworkBoundingBox();
	if (bb == null) {
		return;
	}
	var center = bb.center();
	var sub1 = new $Vec3(0, bb.max.y - bb.min.y, bb.max.z - bb.min.z);
	var sub2 = new $Vec3(bb.max.x - bb.min.x, 0, 0, 0);
	var sub = sub1.clone();
	if (sub.length() < sub2.length()) {
		sub = sub2.clone();
	}
	var position;
	if (angle) {
		var l = sub1.length();
		sub1.y = sub1.z * Math.tan(angle / 180 * Math.PI);
		sub1.setLength(l);
	}
	position = new $Vec3().addVectors(center, sub1.multiplyScalar(0.5));
	var fov = network._camera.fov,
		aspect = network._camera.aspect;
	var length = sub.length() / 2 / Math.tan(fov * Math.PI / 180);
	position.add(sub1.normalize().multiplyScalar(length));
	// network._camera.setPosition(position);
	// network._camera.lookAt(center);
	return {
		target: center,
		position: position
	};
	// this._overviewDistance = this._camera.getDistance();
};

var jsonUtil = window.jsonUtil = $Util.jsonUtil;


    

var $Base = function(){
	mono.PropertyChangeDispatcher.call(this);
};
it.Base = $Base;

mono.extend($Base,mono.PropertyChangeDispatcher,{
   onPropertyChange : function (property, oldValue, newValue) {
   }
});
/**
 * 类别管理
 */

var $Category = function (parameters) {
    $Base.call(this);
    parameters = parameters || {};
    if (typeof parameters === 'string') {
        parameters = {id: parameters};
    }
    this._id = parameters.id;
    this._description = parameters.description;
    this._selectable = true; // 是否有选中效果
    this._stopAlarmPropagationable = false; // 是否终止告警传播
    this._lazyLoad = false;  // 延迟加载
    this._lazyLoadScene = ""; // 延迟加载的场景 ？
    this._rotationExp = {}; // 旋转支持表达式，如：{y : "x % 2 ? Math.IP : 0"};
    this._positionExp = {}; // 
    this._visible = parameters.visible == undefined ? true : parameters.visible; //默认是否显示其对应的it.Data实例
    this._userDataMap = {}; //存储用户自定义属性
    this.handleDoubleClick = null;
    this.handleClick = null;
};

it.Category = $Category;

mono.extend($Category, $Base, {
    ___accessor: ['description', 'stopAlarmPropagationable'],
    getId: function () {
        return this._id;
    },

    setId: function (id) {
        if (this._id === undefined) {
            this._id = id;
        } else {
            throw 'Can not set id';
        }
    },

    setVisible: function (visible) {
        this._visible = visible;
    },

    isVisible: function () {
        return this._visible;
    },

    setUserData: function (key, value) {
        if (value == null) {
            delete this._userDataMap[key];
        } else {
            this._userDataMap[key] = value;
        }
    },

    getUserData: function (key) {
        return this._userDataMap[key];
    },

    fromJson: function (json) {

        if (json.selectable == undefined) {
            json.selectable == true;
        }
        this._id = json.id;
        this._description = json.description;
        this._visible = json.visible;
        this._selectable = json.selectable; // 是否有选中效果
        this._stopAlarmPropagationable = json.stopAlarmPropagationable; // 是否终止告警传播
        this._lazyLoad = json.lazyLoad;  // 延迟加载
        this._lazyLoadScene = json.lazyLoadScene || ''; // 延迟加载的场景 ？
        this._rotationExp = json.rotationExp || {}; // 旋转支持表达式，如：{y : "x % 2 ? Math.IP : 0"};
        this._positionExp = json.positionExp || {}; //
    },
});
var $Data = function (parameters) {
    $Base.call(this);
    parameters = parameters || {};
    if (typeof parameters === 'string') {
        parameters = {id: parameters};
    }
    this._ii = parameters.ii;
    this._id = parameters.id;
    this._description = parameters.description;
    this._position = parameters.position || new mono.Vec3; // 应该考虑把json格式换成mono.Vec3
    this._position2d = parameters.position2d || new mono.Vec2;
    this._rotation = parameters.rotation; // || new mono.Vec3; 空就是空，空就按express计算
    this._location = null; //基于LocationManager的管理，参考类it.Location;
    this._userDataMap = {}; //类似AssetInfo的数据，可以放在userDataMap 里面
    this._parentId = parameters.parentId;//父子关系
    this._hostId = ""; //依赖关系
    this._dataTypeId = parameters.dataTypeId;//绑定数据模型类型。
    this._businessTypeId = parameters.businessTypeId; //业务类型
    // this._parent = null;
    this._childList = new mono.List();
    this._alarmState = new it.AlarmState(this);
    this._powerParentId = ""; // 电力依赖关系
    this._allLinks = {};
    this._power = "";
    this._weight = 0;//自身重量
};

it.Data = $Data;

mono.extend($Data, $Base, {
    ___accessor: ['ii','rotation', 'parentId', 'hostId', "dataTypeId","businessTypeId", "alarmState", "description", "power", 'weight',"name","extend"],
    IT_Data: true,
    getId: function () {
        return this._id;
    },

    getLocation: function () {
        return this._location;
    },

    setLocation: function (object) {
        if (object) {
            var l = new it.Location(object);
            if (this._location) {
                if (l.x == this._location.x && l.y == this._location.y && l.z == this._location.z) {
                    return;
                }
            }
            var oldValue = this._location;
            this._location = l;
            this.firePropertyChange("location", oldValue, l);
        }
    },

    setPosition: function (x, y, z) {
        var p;
        if (arguments.length === 3) {
            p = new mono.Vec3(x, y, z);
        } else if (arguments.length === 1) {
            if (mono.Utils.isArray(x)) {
                p = new mono.Vec3(x[0], x[1], x[2]);
            } else {
                p = new mono.Vec3(x.x || 0, x.y || 0, x.z || 0);
            }
        }
        if (this._position) {
            if (p.x == this._position.x && p.y == this._position.y && p.z == this._position.z) {
                return;
            }
        }
        var oldValue = this._position;
        this._position = p;
        this.firePropertyChange("position", oldValue, p);
    },

    setPosition2d: function (x, y) {
        this._position2d = new mono.Vec2(x, y);
    },

    getValue: function (name) {
        if (!name) {
            return null;
        }
        if (this["_" + name]) {
            return this["_" + name];
        } else {
            return this.getUserData(name);
        }

    },

    getPosition: function () {
        return this._position || new mono.Vec3;
    },

    getPosition2d: function () {
        return this._position2d || new mono.Vec2;
    },

    u: function (userData) {
        if (!userData) {
            return;
        }
        for (var p in userData) {
            this.setUserData(p, userData[p]);
        }
    },

    addLink: function (link) {
        if (link && (link instanceof it.Link)
            && link.getId()
            && !this._allLinks[link.getId()]) {
            this._allLinks[link.getId()] = link;
        }
    },

    removeLink: function (link) {
        if (link && link.getId()) {
            delete this._allLinks[link.getId()];
        }
    },

    getAllLinks: function () {
        return this._allLinks;
    },

    getPosition2d: function () {
        return this._position2d;
    },

    setUserData: function (key, value) {
        if (value == null) {
            delete this._userDataMap[key];
        } else {
            this._userDataMap[key] = value;
        }
    },
    
    getUserData: function (key) {
        return this._userDataMap[key];
    },

    fromJson: function (json) {
        if (typeof json === 'string') {
            json = JSON.parse(json);
        }
        this._ii = json.ii;
        this._id = json.id;
        this._description = json.description;
        if (json.position && (json.position.x !== undefined || json.position.y !== undefined || json.position.z !== undefined)) {
            this._position = new mono.Vec3(json.position.x || 0, json.position.y || 0, json.position.z || 0);
        } else if (mono.Utils.isArray(json.position)) {
            this._position = new mono.Vec3(json.position[0] || 0, json.position[1] || 0, json.position[2] || 0);
        }
        if (json.position2d && (json.position2d.x !== undefined || json.position2d.y !== undefined)) {
            this._position2d = new mono.Vec2(json.position2d.x || 0, json.position2d.y || 0);
        } else if (mono.Utils.isArray(json.position2d)) {
            this._position2d = new mono.Vec2(json.position2d[0] || 0, json.position2d[1] || 0);
        }
        if (json.rotation && ((json.rotation.x !== undefined && json.rotation.x != '')
            || (json.rotation.y !== undefined && json.rotation.y != '')
            || (json.rotation.z !== undefined && json.rotation.z != ''))) {
            this._rotation = new mono.Vec3(json.rotation.x, json.rotation.y, json.rotation.z);
        } else if (mono.Utils.isArray(json.rotation)) {
            this._rotation = new mono.Vec3(json.rotation[0] || 0, json.rotation[1] || 0, json.rotation[2] || 0);
        }
        this.setLocation(json.location);
        this._parentId = json.parentId;
        this._dataTypeId = json.dataTypeId;
        this._businessTypeId = json.businessTypeId;
        this._hostId = json.hostId || json.groupId;
        this._power = json.power;
        this._weight = json.weight;
        this._name = json.name;
        this._extend = json.extend;
    },

    onAlarmChange: function () {

    },

    addChild: function (data) {
        if (data && !this._childList.contains(data)) {
            this._childList.add(data);//这个list竟然不去重，
        }
    },

    addChildren: function (datas) {
        if (!datas || datas.length < 1) {
            return;
        }
        for (var i = 0; i < datas.length; i++) {
            var data = datas[i];
            this.addChild(data);
        }
    },

    removeChild: function (data) {
        this._childList.remove(data);
    },

    removeChildren: function (datas) {
        if (!datas || datas.length < 1) {
            return;
        }
        for (var i = 0; i < datas.length; i++) {
            var data = datas[i];
            this.removeChild(data);
        }
    },

    getChildren: function () {
        return this._childList;
    },

    clone: function (id, cloneParentId) {
        var cloneData = new $Data(id);
        cloneData.setDataTypeId(this.getDataTypeId());
        var pos = this.getPosition(), loc = this.getLocation();
        cloneData.setPosition(pos.clone());
        if (loc) {
            cloneData.setLocation(new $Location(loc.x, loc.y, loc.z));
        }
        if (cloneParentId) {
            cloneData.setParentId(this.getParentId());
        }
        return cloneData;
    }
});
var $DataType = function (parameters) {
    $Base.call(this);
    parameters = parameters || {};
    if (typeof parameters === 'string') {
        parameters = {id: parameters};
    }
    this._id = parameters.id;
    this._categoryId = "";
    this._description = "";
    this._size = null;    // 空间  参考类 it.Size 类
    this._childrenSize = new it.Size(); // 空间类，it.Size类；


    this._model2d = "";
    this._model2dParameters = null;
    this._model2d2 = "";
    this._model2d2Parameters = null;

    this._parameters = null;
    this._model = ""; // Link to modellib.js
    this._modelParameters = null;
    this._simpleModel = ""; // 简单模型管理 LOD
    this._simpleModelParameters = null;

    this._prefabAble = parameters.prefabAble == undefined ? true : parameters.prefabAble;
    this._simplePrefabAble = parameters.simplePrefabAble == undefined ? true : parameters.simplePrefabAble;
    // this.lod = "";
    this._selectable = true; // 是否有选中效果
    this._stopAlarmPropagationable = false; // 是否终止告警传播
    this._batchable = false; //是否启用批量绘制，将在BatchManager里面管理。
    this._lazyable = false;  // 延迟加载
    // this._lazyLoadScene = ""; // 延迟加载的场景 ？
    this.handleDoubleClick = null; // for user use;
    this.handleClick = null;  // for user use;

    this._rotationExp = {}; // 旋转支持表达式，如：{y : "x % 2 ? Math.IP : 0"};
    this._positionExp = {}; //

    this._visible = true;
    this._weightRating = 0;//承重的上限值
    this._powerRating = 0; // 额定功耗
    this._subType = 'server'; // 设备类型,server-主机  network-网络设备

    //_templateDatas数组中放的是it.Data的实例，并且该Data有类型哦，所以的需要专门的表来管理
    this._templateDatas = parameters.templateDatas || []; // port001@card001

    this._templateDataMap = {};
    this._userDataMap = {}; //存储用户自定义属性
};


mono.extend($DataType, $Base, {
    ___accessor: ['categoryId', 'description', 'rotationExp', 'positionExp', 'size', 'childrenSize', 'parameters', 'model2d', 'model2dParameters','model2d2', 'model2d2Parameters',
        'model', 'modelParameters', 'simpleModel', 'simpleModelParameters', 'batchable', 'lazyable', 'selectable', 'stopAlarmPropagationable', 'prefabAble', 'noVirtualOther', 'simplePrefabAble',
        'weightRating', 'powerRating', 'subType'],
    getId: function () {
        return this._id;
    },

    setId: function (id) {
        if (this._id === undefined) {
            this._id = id;
        } else {
            throw 'Can\'t change id';
        }
    },

    getTemplateDatas: function (side) {
        side = side || false;
        var result = [];
        for(var id in this._templateDataMap){
            if(id.indexOf('@'+side)>0){
                result.push(this._templateDataMap[id]);
            }
        }
        return result;
    },

    setTemplateDatas: function (templateDatas) {
        this._templateDatas.length = 0;
        var self = this;
        if (templateDatas && templateDatas.length > 0) {
            templateDatas.forEach(function (templateData) {
                self.addTemplateData(templateData);
            });
        }
    },

    addTemplateData: function (data) {
        if (data instanceof it.Data) {
            this._templateDatas.push(data);
            this._templateDataMap[data.getId() + '@' + data.getUserData('side')] = data;
        } else {
            var itData = new it.Data();
            itData.setUserData('side', data.side);
            itData.fromJson(data);
            this._templateDatas.push(itData);
            this._templateDataMap[itData.getId() + '@' + itData.getUserData('side')] = itData;
        }
    },

    getTemplateDataById: function (id) {
        return this._templateDataMap[id];
    },

    setUserData: function (key, value) {
        if (value == null) {
            delete this._userDataMap[key];
        } else {
            this._userDataMap[key] = value;
        }
    },
    
    getUserData: function (key) {
        return this._userDataMap[key];
    },

    fromJson: function (json) {
        if (typeof json === 'string') {
            json = JSON.parse(json);
        }
        this._id = json.id;
        this._categoryId = json.categoryId;
        this._description = json.description;
        this._size = new $Size(json.size)
        this._childrenSize = new $Size(json.childrenSize);
        this._model2d = json.model2d;
        this._model2dParameters = $Util.translateJson(json.model2dParameters);
        this._model2d2 = json.model2d2;
        this._model2d2Parameters = $Util.translateJson(json.model2d2Parameters);
        this._model = json.model;
        this._modelParameters = $Util.translateJson(json.modelParameters);
        this._simpleModel = json.simpleModel;
        this._simpleModelParameters = json.simpleModelParameters;
        this._selectable = json.selectable === undefined ? true : json.selectable;
        this._stopAlarmPropagationable = !!json.stopAlarmPropagationable;
        this._batchable = !!json.batchable;
        this._prefabAble = !!json.prefabAble;
        this._simplePrefabAble = !!json.simplePrefabAble;
        this._noVirtualOther = !!json.noVirtualOther;
        this._rotationExp = json.rotationExp || {};
        this._positionExp = json.positionExp || {};
        this._lazyable = json.lazyable;
        this._weightRating = json.weightRating;
        this._powerRating = json.powerRating;
        this._subType = json.subType;
    },
});

it.DataType = $DataType;

var $BusinessType = function(parameters){
	$Base.call(this);
	parameters = parameters || {};
	this._id = parameters.id || "";
	this._parentId = parameters.parentId || "";
	this._name = parameters.name || "";
	this._description = parameters.description;
	this._userDataMap = {};
};

mono.extend($BusinessType,$Base,{
	 
	___accessor: ['id', 'name', 'parentId', 'description'],

	fromJson: function (json) {
        if (typeof json === 'string') {
            json = JSON.parse(json);
        }
        this._id = json.id;
        this._parentId = json.parentId;
	    this._name = json.name;
        this._description = json.description;
    },

    setUserData: function (key, value) {
        if (value == null) {
            delete this._userDataMap[key];
        } else {
            this._userDataMap[key] = value;
        }
    },
    
    getUserData: function (key) {
        return this._userDataMap[key];
    }

});

it.BusinessType = $BusinessType;
/*
 * terry  基于Model View Control MVC的设计
 */
var $DataManager = function(){
   this.defaultCategory = new it.Category(""); // 空分类
   this._categories = [];
   this._categoryMap = {};
   this._dataTypes = [];
   this._dataTypeMap = {};
   this._businessTypes = [];
   this._businessTypeMap = {};
   this._datas = [];
   this._dataMap = {};
   this._roots = []; // 管理最顶层的Data
   this._rootMap = {}; 

   this._links = [];
   this._linkMap = {};

   this._dataTypeDatas = {}; // 分类型管理Data
   this._categoryDatas = {}; //  分类管理Data

   this._scenes = [];
   this._sceneMap = {};
   this._rootScene = null;
   this._categorySceneMap = {};
    this._temperatureFields = {}; //温度场
    this._collectors = {}; //采集器
    this._typeCollectors = {}; //分类管理collector(采集器)
   
   // 事件管理
   this._dataManagerChangeDispatcher = new mono.EventDispatcher();
   this._dataPropertyChangeDispatcher = new mono.EventDispatcher();

   // 数据转换为场景的类，这个类可以用户定义，默认用我们的场景加载,可能
   // this.viewLoader = null; 
   // 位置管理
   // this.locationManager = null;
};

mono.extend($DataManager,mono.PropertyChangeDispatcher,{
    
    addScene : function(scene){
       if(!(scene instanceof it.Scene)){
          return false;
       }
       var id = scene.getId();
       if(this._sceneMap[id]){
           throw "Scene with id '" + id + "' already exists";
       }
       var categoryId = scene.getCategoryId();
       if(!this._categoryMap[categoryId] && !scene.isRoot()){
          throw "Scene Category with category id '" + categoryId + "' does not exist";
       }
       if(this._categorySceneMap[categoryId]){
          throw "Scene with category id '" + categoryId + "' already exists";
       }
       if(scene.isRoot()){
          if(this._rootScene != null){
            throw "Only support one root scene";
          }
          this._rootScene = scene;
       }
       this._scenes.push(scene);
       this._sceneMap[id] = scene;
       this._categorySceneMap[categoryId] = scene;
    },

    addSceneFromJson : function(scenes){
        var i = 0,len = scenes.length;
        for(;i < len;i ++){
            var scene = new it.Scene();
            scene.fromJson(scenes[i]);
            this.addScene(scene);
        }
    },

    getSceneByCategory : function(categoryOrId){
       if(!categoryOrId){
        return null;
       }
       var categoryId = categoryOrId.getId ? categoryOrId.getId() : categoryOrId;
       return this._categorySceneMap[categoryId];
    },

    getSceneByData : function(dataOrId){
      var category = this.getCategoryForData(dataOrId)
      return this.getSceneByCategory(category);
    },

    getRootScene : function(){
      return this._rootScene;
    },

    getChildrenScene : function(scene){
       
    },

    addCategory : function(category){
       var id = category.getId();
        if(!(category instanceof it.Category)){
        	throw "Can only add it.Category";
        }
        if(this._categoryMap[id]){
       	  throw "Category for id '" +id+"' already exists";
        }
        this._categories.push(category);
        this._categoryMap[id] = category;
    },

    removeCategory : function(category){
        if(!category){
          return false;
        }
        var id = category.getId();
        if(!this._categoryMap[id]){
           return false;
        }
        var index = this._categories.indexOf(category);
        if(index == -1){
        	return false;
        }
       	delete this._categoryMap[id];
       	this._categories.splice(index,1);
       	return true;
    },

    removeCategoryById : function(id){
       var category = this._categoryMap[id];
       if(category){
       	  this.removeCategory(category);
       }
    },

    addCategories : function(categories){
    	if(mono.Utils.isArray(categories)){
    		for(var i = 0;i < categories.length;i ++){
    			var category = categories[i];
    			this.addCategory(category);
    		}
    	}
    },
    
    // TODO
    addCategoryFromJson : function(json){
        var jsonObjects = json;
       if(typeof json === "string"){
          jsonObjects = JSON.parse(json);
       }     
       var i = 0,len = jsonObjects.length;
       for(;i < len;i ++){
          var jsonObject = jsonObjects[i];
          var category = new it.Category();
          category.fromJson(jsonObject);
          this.addCategory(category);
       }
    },

    addDataType : function(dataType){
      if(!dataType){
      	return;
      }
      if(!(dataType instanceof it.DataType)){
      	throw "Can only add 'it.DataType'";
      }
      var id = dataType.getId();
      if(this._dataTypeMap[id]){
          throw "DataType for id '" +id+ "' already exists";
      }
      var categoryId = dataType.getCategoryId();
      if(categoryId && !this._categoryMap[categoryId]){
         throw "Category for '" + categoryId + "' does not exist";
      }
      this._dataTypes.push(dataType);
      this._dataTypeMap[id] = dataType;
    },


    addBusinessType : function(businessType){
       if (!businessType) {
          return;
       }
       var id = businessType.getId();
        if(!(businessType instanceof it.BusinessType)){
          throw "Can only add it.BusinessType";
        }
        if(this._businessTypeMap[id]){
          throw "BusinessType for id '" +id+"' already exists";
        }
        this._businessTypes.push(businessType);
        this._businessTypeMap[id] = businessType;
    },

    removeBusinessType : function(businessType){
        if(!businessType){
           return false;
        }
        var id = businessType.getId();
        if(!this._businessTypeMap[id]){
           return false;
        }
        var index = this._businessTypes.indexOf(businessType);
        if(index == -1){
           return false;
        }
        delete this._businessTypeMap[id];
        this._businessTypes.splice(index,1);
        return true;
    },

    removeBusinessTypeById : function(id){
       var businessType = this._businessTypeMap[id];
       if(businessType){
          this.removeBusinessType(businessType);
       }
    },

    addBusinessTypes : function(businessTypes){
      if(mono.Utils.isArray(businessTypes)){
        for(var i = 0; i < businessTypes.length; i ++){
          var businessType = businessTypes[i];
          this.addBusinessType(businessType);
        }
      }
    },

    addBusinessTypeFromJson : function(json){
        var jsonObjects = json;
       if(typeof json === "string"){
          jsonObjects = JSON.parse(json);
       }     
       var i = 0,len = jsonObjects.length;
       for(;i < len;i ++){
          var jsonObject = jsonObjects[i];
          var businessType = new it.BusinessType();
          businessType.fromJson(jsonObject);
          this.addBusinessType(businessType);
       }
    },

    getBusinessTypeById : function(id){
        return this._businessTypeMap[id];
    },

    getBusinessTypeForData :function(data){
        var bid = data.getBusinessTypeId();
        if (bid) {
           return this.getBusinessTypeById(bid);
        }else{
          return null;
        }
    },

    /**
     * 转换templatedata的json数据并添加至某个DataType实例中
     * @param jsonObj
     * @returns {boolean}
     */
    addTemplateData : function(jsonObj){
        var dataTypeId  = jsonObj.parentDataTypeId||'';
        if(!dataTypeId){
            return false ;
        }
        var dataType = this._dataTypeMap[dataTypeId];
        if(!dataType){
            return false;
        }
        var data = new it.Data();
        //注意template_data中的position应该转成data中的position2d
        if(jsonObj.position){
            var pos3d = jsonObj.position;
            if(pos3d instanceof Array && pos3d.length >= 2){
                jsonObj.position2d = {x:pos3d[0],y:pos3d[1]};
            }else{
                jsonObj.position2d = pos3d;
            }
            //else if(pos3d instanceof Array && pos3d.length == 2){
            //    jsonObj.position2d = {x:pos3d[0],y:pos3d[1]};
            //}
        }
//        delete  jsonObj.position; // 免得混淆，直接去掉
        data.fromJson(jsonObj);
        data.setUserData('side', jsonObj.side);
        dataType.addTemplateData(data);
    },

    /**
     * 将json转换成templatedatas,并添加至datatype中
     * @param json
     */
    addTemplateDataFromJson : function(json){
        var jsonObjects = json;
        if(typeof json === "string"){
            jsonObjects = JSON.parse(json);
        }
        var i = 0,len = jsonObjects.length;
        for(;i < len;i ++){
            var jsonObject = jsonObjects[i];
            this.addTemplateData(jsonObject);
        }
    },

    removeDataType : function(dataType){
       if(!dataType){
          return false;
       }
       var id = dataType.getId();
       if(!this._dataTypeMap[id]){
           return false;
       }
       var index = this._dataTypes.indexOf(dataType);
       if(index === -1){
       	 return false;
       }
       if(this._dataTypeDatas[id]){ // 如果已经使用，不能删除。
       	  return false;
       }
       delete this._dataTypeMap[id];
       this._dataTypes.splice(index,1);
    },

    removeDataTypeById : function(id){
       this.removeDataType[this._dataTypeMap[id]];
    },

    getCategoryForDataType : function(dateTypeOrId){
        var dataType = dateTypeOrId;
        if(typeof dateTypeOrId === 'string'){
          dataType = this._dataTypeMap[dateTypeOrId];
        }
        if(!dataType){
            return null;
        }
        var categoryId = dataType.getCategoryId();
        return this._categoryMap[categoryId];
    },

    getCategoryForData : function(dataOrId){
        var dataType = this.getDataTypeForData(dataOrId);
        if(dataType){
          var categoryId = dataType.getCategoryId();
          return this._categoryMap[categoryId];
        }
        return null;
    },

    getDataTypeForData : function(dataOrId){
    	if(!dataOrId){
    		return;
    	}
    	var data = dataOrId;
        if(typeof data === "string"){ // 说明是id
            data = this._dataMap[data];
        }
        if(!data){
          return;
        }
        if(!(data instanceof it.Data) && !(data instanceof it.Link) ){
            return;
        }
        if(!data.getDataTypeId){
          console.log("data.getDataTypeId");
        }
        var dataTypeId = data.getDataTypeId();
        return this._dataTypeMap[dataTypeId];
    },

   getDataTypeById: function(linkId) {
      if (!linkId) {
        return null;
      }
      return this._dataTypeMap[linkId];
   },

    addDataTypeFromJson : function(dataTypes){
        var i = 0,len = dataTypes.length;
        for(;i < len;i ++){
          var dataType = new it.DataType();
          dataType.fromJson(dataTypes[i]);

          this.addDataType(dataType);
        }
    },

    /**
     * 设置data的父子关系
     * 注意：第一次加载了很多的数据的时候，这个方法执行了无数次，估计对速度有些影响
     * @param data
     * @returns {null}
     */
    setParentAndChildren : function(data){
        if(!data){
            return null;
        }
        var parentId = data.getParentId();
        if(parentId){
           var parentData =  this._dataMap[parentId];
            if(parentData){
                parentData.addChild(data);
            }
        }
        var children = this.getChildren(data);
        data.addChildren(children);
    },

    /**
     * 设置所有的data的父子关系
     * 对于一下子从后来查询了数千条数据来说，一个一个的setParentAndChildren是比较慢的，再说有很多的重复而无效的搜索和计算
     * 这里只要遍历一次，将其加入到其父亲的孩子中即可，并不需要找其的孩子
     */
    setAllParentAndChildren : function(){
        for(var id in this._dataMap){
            var data = this._dataMap[id];
            if(data && data.getParentId()){
                var parentData = this._dataMap[data.getParentId()];
                if(parentData){
                    parentData.addChild(data);
                }
            }
        }
    },

    addData : function(data,fireEvent,setParentAndChildren){
       if(!data){
       	 return;
       }
       if(fireEvent === undefined){
          fireEvent = true;
       }
        if(setParentAndChildren === undefined){
            setParentAndChildren = true;
        }
       var id = data.getId();
       var dataTypeId = data.getDataTypeId();

       if(this._dataMap[id]){
       	  throw "Data for '" + id +"' already exists";
       }
       var dataType = this.getDataTypeForData(data);
       if(!dataType){
       	 throw "DataType '" + dataTypeId + "' does not exist";
       }
       this._datas.push(data);
       this._dataMap[id] = data;
       var parentId = data.getParentId();
       if(!parentId){
       	  this._roots.push(data);
       	  this._rootMap[id] = data;
       }
        if(setParentAndChildren){
            this.setParentAndChildren(data);
        }
       // 冗余存储，方便查找
       var typeDatas = this._dataTypeDatas[dataTypeId];
       if(typeDatas == null){
       	  typeDatas = {};
       	  this._dataTypeDatas[dataTypeId] = typeDatas;
       }
       typeDatas[id] = data;
       
       // 冗余存储，方便查找
       var category = this.getCategoryForData(data);
       if(category){
         var categoryDatas = this._categoryDatas[category.getId()];
         if(categoryDatas == null){
            categoryDatas = {};
            this._categoryDatas[category.getId()] = categoryDatas;
         }
         categoryDatas[id] = data;
       }
       data.addPropertyChangeListener(this.handleDataPropertyChange, this);
       if(fireEvent){
          this._dataManagerChangeDispatcher.fire({
             kind : 'add',
             data : data,
             source : this
          });
       }

    },

    addDataFromJson : function(json){
       var jsonObjects = json;
       if(typeof json === "string"){
          jsonObjects = JSON.parse(json);
       }     
       // checkData
       var i = 0,len = jsonObjects.length;
       for(;i < len;i ++){
          var id = json.id;
          var dataTypeId = json.dataTypeId;
       } 

       for(i = 0;i < len;i ++){
          var jsonObject = jsonObjects[i];
          var data = new it.Data();
          data.fromJson(jsonObject);
          this.addData(data,true,false);
       }
        this.setAllParentAndChildren();
    },

    /**
     * 删除data
     * data是it.Data实例或id
     */
    removeData : function(data,removeChild){ // TODO
        if (!data) {
            return false;
        }
        var id = data.getId ? data.getId():data;
        if (!this._dataMap[id]) {
            return false;
        }
        var data = this._dataMap[id];
        var index = this._datas.indexOf(data);
        if (index === -1) {
            return false;
        }
        //只要从父亲中移除即可，因为其孩子不需要处理，接下来都从datamaanger中去掉了
        if (data.getParentId()) {
            var parentData = this._dataMap[data.getParentId()];
            if (parentData) {
                parentData.removeChild(data);
            }

        }
        var childArray = data.getChildren();//this.getChildren(data);
        if (childArray && childArray.size() && !removeChild) {
            return false;
        } else if (childArray && childArray.size()) {
            for (var i = 0; i < childArray.size(); i++) {
                this.removeData(childArray.get(i), removeChild);
            }
        }

        delete this._dataMap[id];
        this._datas.splice(index, 1);

        var dataTypeId = data.getDataTypeId();
        var typeDatas = this._dataTypeDatas[dataTypeId];
        if (typeDatas != null) {
            delete typeDatas[id];
        }

        var category = this.getCategoryForData(data);
        if (category) {
            var categoryDatas = this._categoryDatas[category.getId()];
            if (categoryDatas != null) {
                delete categoryDatas[id]
            }
        }
        data.removePropertyChangeListener(this.handleDataPropertyChange, this);
        this._dataManagerChangeDispatcher.fire({
            kind: 'remove',
            data: data,
            source: this
        });
        return true;
    },

    addLink : function(link){
        var id = link.getId();
        if (this._linkMap[id]) {
            return;
        }
        var fromId = link.getFromId();
        var toId = link.getToId();

        if (!this._dataMap[fromId]) {
            console.log("From Id does not exist");
            return;
        }
        if (!this._dataMap[toId]) {
            console.log("To Id does not exist");
            return;
        }
        this._linkMap[id] = link;
        this._links.push(link);

        this._dataMap[fromId].addLink(link); // 将link关联到data上
        this._dataMap[toId].addLink(link);

        this._dataManagerChangeDispatcher.fire({
            kind: 'add',
            data: link,
            source: this
        });
        return true;
    },

    removeLink : function(link){
       var id = link.getId();
       if(this._linkMap[id]){
          var index = this._links.indexOf(link);
          this._links.splice(index,1);
          delete this._linkMap[id];
       }

        var fromId = link.getFromId();
        var toId = link.getToId();

        this._dataMap[fromId].removeLink(link); // 将link关联到data上
        this._dataMap[toId].removeLink(link);

        this._dataManagerChangeDispatcher.fire({
          kind : 'remove',
          data : link,
          source : this
       });
    },

    addTemperatureField : function(field){
        if(!field){
            return ;
        }
        if(this._temperatureFields && this._temperatureFields[field.getId()]){
            throw "Temparature Field for '" + field.getId() +"' already exists";
        }
        this._temperatureFields[field.getId()] = field;
        if(this._collectors){
            for (var cid in this._collectors){
                var collector = this._collectors[cid];
                if(collector.getType() == $Collector.Type.temperature && collector.getParentId() == field.getId()){
                     field.addCollector(collector);
                }
            }
        }

    },

    addTemperatureFieldFromJson : function(json){
        var jsonObjects = json;
        if(typeof json === "string"){
            jsonObjects = JSON.parse(json);
        }
        var i = 0,len = jsonObjects.length;
        for(;i < len;i ++){
            var jsonObject = jsonObjects[i];
            var field = new $TemperatureField();
            field.fromJson(jsonObject);
            this.addTemperatureField(field);
        }
    },

    removeTemparatureField : function(field){
        if(!field){
            return ;
        }
        var collectors = field.getCollectors();
        if(collectors && collectors.size() > 0){
            var self = this;
            collectors.forEach(function(collector){
                if(collector){
                    delete self._collectors[collector.getId()];
                }
            })
        }
        delete this._temperatureFields[field.getId()];

    },

//        this._temperatureFields = {}; //温度场
//        this._collectors
    addCollector : function(collector){
        if(!collector){
            return ;
        }
        if(this._collectors && this._collectors[collector.getId()]){
            throw "Collector for '" + collector.getId() +"' already exists";
        }
        this._collectors[collector.getId()] = collector;
        // if(collector.getType() == 'temperature'){ // remove 2017-09-04，今后的传感器可能同时包含了温度和湿度的值
            var tepField = this._temperatureFields[collector.getParentId()];
            if(tepField){
                tepField.addCollector(collector);
            }
        // }
        var collectorType = collector.getType();
        var typeCollectors = this._typeCollectors[collectorType];
        if(typeCollectors == null){
            typeCollectors = {};
            this._typeCollectors[collectorType] = typeCollectors;
        }
        typeCollectors[collector.getId()] = collector;
    },

    addCollectorFromJson : function(json){
        var jsonObjects = json;
        if(typeof json === "string"){
            jsonObjects = JSON.parse(json);
        }
        var i = 0,len = jsonObjects.length;
        for(;i < len;i ++){
            var jsonObject = jsonObjects[i];
            var collector = new $Collector();
            collector.fromJson(jsonObject);
            this.addCollector(collector);
        }
    },

    removeCollector : function(collector){
        if(!collector){
            return ;
        }
        delete this._collectors[collector.getId()];
        if(collector.getType() == 'temperature'){
            var tepField = this._temperatureFields[collector.getParentId()];
            if(tepField){
                tepField.removeCollector(collector);
            }
        }
        var collectorType = collector.getType();
        var typeCollectors = this._typeCollectors[collectorType];
        if(typeCollectors){
            delete typeCollectors[collector.getId()];
        }
    },

    getParent : function(data){
        if(!data){
            return null;
        }
        if(data instanceof it.Data){
           var parentId = data.getParentId();
           return this._dataMap[parentId];
        }
    },

    getChildren : function(data,dataTypeId){
//        var now = new Date();
       var childArray = [];
       if(!data){
        return childArray;
       }
       var pId = data.getId();
       for(var id in this._dataMap){
         var data = this._dataMap[id];
         if(!dataTypeId || data.getDataTypeId() == dataTypeId){
            if(data.getParentId() === pId){
              childArray.push(data);
            }
         }
         
       }
//        console.log(" getChild-------: "+((new Date()).getTime() - now.getTime()));
       return childArray;
    },

    /**
     * 判断ancestorId是不是data的祖先id
     * @param ancestorId 祖先id
     * @param data
     */
    isAncestor : function(ancestorId,data,scop){
        if(!data || !ancestorId){
            return false;
        }
        if(data.getId() === ancestorId || data.getParentId() === ancestorId){
            return true;
        }
        var scop = scop||this;
        if(data.getParentId()){
            var parent = this._dataMap[data.getParentId()];
            if(parent){
                return scop.isAncestor(ancestorId,parent,scop);
            }
        }
        return false;
    },

    /**
     * 获取data的子孙(不仅仅只是孩子)
     * @param data
     */
    getDescendants : function(data,results,scope){
        var descendants = results || [];
        var scope = scope || this;
        if(!data){
            return descendants;
        }
//        var pId = data.getId();
//        for(var id in this._dataMap){
//            var data = this._dataMap[id];
//                if(this.isAncestor(pId,data)){
//                    descendants.push(data);
//                }
//        }
        var children = data.getChildren();
        if(children && children.size() > 0){
            children.forEach(function(child){
                descendants.push(child);
                scope.getDescendants(child,descendants,scope);
            });
        }
        return descendants;
    },



    getDataMap : function(){
      return this._dataMap;
    },

    getLinkMap : function(){
      return this._linkMap;
    },

    /**
     * 根据linkId获取link
     * @param id
     */
    getLinkById : function(id){
        if(!id){
            return null;
        }
        return this._linkMap[id];
    },

    getFromLinks : function(dataOrId){

    },

    getToLinks : function(dataOrId){

    },

    getDataMapByCategory : function(categoryOrId){
       var id = categoryOrId;
       if(id instanceof it.Category){
          it = id.getId();
       }
       return this._categoryDatas[id];
    },

    getDataById : function(id){
      if(!id){
         return null;
      }
      var data = this._dataMap[id];
      if(!data && typeof(id) === 'string' &&  id.indexOf('@') > 0){
         var ids = id.split("@");
         var childId = ids[0],parentId = ids[1]
         var parent = this.getDataById(parentId);
         if(parent){
            return null;
         }
         var dataType = this.getDataTypeForData(parent);
         if (!dataType) {
           return null;
         };
         var templateData = dataType.getTemplateDataById(childId);
         if(templateData){
            var templateDataType = this.getDataTypeForData(templateData);
            if(!templateDataType){
                return null;
            }
            var newData = templateData.clone(id);
            newData.setParentId(parentId);
            this.addData(newData);
            return newData;
         }
      }
      return data;
    },

    getCollectorById : function(cid){
       return this._collectors[cid];
    },

    getDatas : function(){
       return this._datas;
    },

    getLinks : function(){
        return this._links;
    },

    getAncestors : function(data,array){
       array = array || [];
       var parent = this.getDataById(data.getParentId());
       if(parent){
          array.push(parent);
          this.getAncestors(parent,array);
       }
       return array;
    },

    getAncestor : function(data,filterFunction){
        var dataType = this.getDataTypeForData(data);
        var category = this.getCategoryForData(data);
        if(filterFunction(data,dataType,category)){
           return data;
        }
        var parent = this.getParent(data);
        if(parent == null){
          return null;
        }else{
          return this.getAncestor(parent,filterFunction);
        }
    },

    getRootMap : function(){
       return this._rootMap;
    },

    getRoots : function(){
       return this._roots;
    },

    getTemperatureFields : function(){
        return this._temperatureFields;
    },

    isLazyable : function(data){
      if(!data){
        return false;
      }
      var dataType = this.getDataTypeForData(data);
      if(dataType.isLazyable()){
         return true;
      }
      var parentData = this.getParent(data);
      if(this.isLazyable(parentData)){ // 可是parent有可能是其他的场景了 
         return true;
      }
      return false;
    },

    fromJson : function(json){
       json = $Util.translateJson(json);
       var categories = json.categories || [];
       var dataTypes = json.dataTypes || [];
       var datas = json.datas || [];
       
       var categoryMap = {},dataTypeMap = {},i = 0;
       for(;i < categories.length;i ++){
          var  category = categories[i];
          categoryMap[category.id] = category;
       }

       for(i = 0;i < dataTypes.length;i ++){
          var dataType = dataTypes[i];
          if(dataType.categoryId && !categoryMap[dataType.categoryId] && !this._categoryMap[dataType.categoryId]){
             throw "Category for '" + dataType.categoryId + "' does not exist";
          }
          dataTypeMap[dataType.id] = dataType;
       }

       for(i = 0;i < datas.length;i ++){
           var data = datas[i];
           var dataTypeId = data.dataTypeId;
           if(!dataTypeMap[dataTypeId] && !this._dataTypeMap[dataTypeId]){
                 throw "DataType '" + dataTypeId + "' does not exist"; 
           }
       }

       if(categories && categories.length){
         this.addCategoryFromJson(categories);
       }
       if(dataTypes && dataTypes.length){
         this.addDataTypeFromJson(dataTypes);
       }
       if(datas && datas.length){
         this.addDataFromJson(datas);
       }
    },

    handleDataPropertyChange:function(event){
        var data = event.source;
        if (event.property === "parentId") {
           var oldValue = event.oldValue,newValue = event.newValue;
           if(newValue == null){
              this._roots.push(data);
              this._rootMap[data.getId()] = data;
           }else if(oldValue == null){
              delete this._rootMap[data.getId()];
              var index = this._roots.indexOf(data);
              if(index != -1){
                this._roots.splice(index,1);
              }
           }
        } 
        this.onDataPropertyChanged(data, event);
        this._dataPropertyChangeDispatcher.fire(event);
    },

    onDataPropertyChanged : function(data,event){
       
    },

    addDataPropertyChangeListener : function(listener, scope, ahead) {
        this._dataPropertyChangeDispatcher.add(listener, scope, ahead);
    },
    removeDataPropertyChangeListener : function(listener, scope) {
        this._dataPropertyChangeDispatcher.remove(listener, scope);
    },

    addDataManagerChangeListener: function (listener, scope, ahead) {
        this._dataManagerChangeDispatcher.add(listener, scope, ahead);
    },
    addDataBoxChangeListener: function (listener, scope, ahead) {
        this._dataManagerChangeDispatcher.add(listener, scope, ahead);
    },
    removeDataManagerChangeListener: function (listener, scope) {
        this._dataManagerChangeDispatcher.remove(listener, scope);
    },


    /**
     * 返回data是否阻止了告警传播
     * 默认是不阻止,返回false
     * 第一步: 判读dataType存在,并且阻止了传播,立即返回true
     * 第二步: 判断category存在,并且阻止了传播,立即返回true
     * 第三步: 返回false
     * @param data {it.Data} data对象
     * @returns {boolean}
     */
    isStopAlarmPropagation:function(data){

        if(!data){
            return false;
        }
        var dataType = this.getDataTypeForData(data);
        if (!dataType) {
            return false;
        }
        if (dataType.isStopAlarmPropagationable()) {
            return true;
        }
        var category = this.getCategoryForData(data);
        if (!category) {
            return false;
        }
        if (category.isStopAlarmPropagationable()) {
            return true;
        }
        return false;
    },
});

it.DataManager = $DataManager;
/**
 * terry 场景对象，SceneManager管理场景对象，并加载场景
 */
var $Scene = function (parameters) {
    $Base.call(this);
	parameters = parameters || {};
    if(typeof parameters === 'string'){
       parameters = {id : parameters};
    }
	this._id = parameters.id;
	this._categoryId = parameters.categoryId;
    this._root =  false || parameters.root;
	this._sceneType = parameters.sceneType || "ShowSelf";
    this._twod = parameters.twod||false; //twod
    this._withGis = parameters.withGis || false;
    this.zoomLevel = parameters.zoomLevel|| 5;
    this.center = parameters.center;
    this._description = "";
    //场景的灯光，network的背景色，镜头的角度，动画等
    this.lights = [];
    this.networkParameters = {};
    this.cameraParameters = {};
    this.animateParameters = {};
    this.showStaticInfo = parameters.showStaticInfo;
    this.defaultInteractionParameters = parameters.defaultInteractionParameters;
    this._preRender = parameters.preRender || false;
};

mono.extend($Scene,$Base,{
   ___accessor : ["categoryId","sceneType","root",'twod','withGis','description','preRender'],

    getId : function(){
     return this._id;
    },

    isRoot : function(){
      return this._root;
    },

    isShowStaticInfo : function(){
        return this.showStaticInfo;
    },

    fromJson : function(json){
        if(typeof json === 'string'){
            json = JSON.parse(json);
        }
        this._id = json.id;
        this._categoryId = json.categoryId;
        this._root =  false || json.root;
        this._sceneType = json.sceneType || "ShowSelf";
        this._twod = json.twod||false; //twod
        this._withGis = json.withGis || false;
        this.zoomLevel = json.zoomLevel|| 5;
        this.center = json.center;
        this._description = json.description;
        this.networkParameters = json.networkParameters;
        this.cameraParameters = json.cameraParameters;
        this.showStaticInfo = json.showStaticInfo;
        this.defaultInteractionParameters = json.defaultInteractionParameters;
        this._preRender = json.preRender || false;
//        this._dialog = json.dialog;
    }
});

it.Scene = $Scene;

/**
 * Create By: Bozai 
 * 自定义场景视图,方便用户扩展来定制自己的场景，包括新的视图(视图可能是新的network，或div)
 * 根据scene和rootData来创建CustomSceneView
 * 可以将ViewManager和ViewManager2D当做系统内部的两个视图
 */
var $CustomSceneView = function(sceneId, sceneManager) {
	this.sceneManager = sceneManager;
	this.sceneId = sceneId;
	// this.scene = this.sceneManager.dataManager._sceneMap[sceneId];
	this.defaultEventHandler = this.sceneManager.viewManager3d.getDefaultEventHandler();
	// this.rootData = rootData;
	// this.init();
};

mono.extend($CustomSceneView, Object, {

	// init: function() {
	// },

    /**
     * 返回自定义视图的View
     * 注意：当返回null时，表示的是更viewManager3D共用一个视图
     */
	getContainer: function() {
		return null;
	},

	getNetwork3D : function(){
		return null;
	},

	getCamera : function(){
		return null;
	},

	adjustBounds : function(w, h, left, top){
		// 调整该view的大小和位置
	},

	/**
	 * 显示该场景的view
	 */
	show: function(rootData) {

	},

	/**
	 * 卸载该场景视图
	 */
	clear: function() {
		return null;
	},

    /**
     * 自定义场景视图中处理获取焦点
     */
	setFocusNode : function(node){

	},
    
    /**
     * 自定义场景视图中的lookAt的处理
     */
	lookAt : function(node){

	},

	isLoadData : function(){
		return true;
	}

});

it.CustomSceneView = $CustomSceneView;


/**
 * 管理联系的数据
 */
var $Link = function(parameters){
    $Base.call(this);
    parameters = parameters || {};
    if (typeof parameters === 'string') {
        parameters = {id: parameters};
    }
    this._id = parameters.id;
    this._name = parameters.name || '';
    this._dataTypeId = parameters.dataTypeId || '';
    this._type = parameters.type || '';
    this._fromId = parameters.fromId;// 支持表达式 比如F01_01.1设备的第一个端口
    this._fromSide = parameters.fromSide||0; //是设备的正面还是反面，0是正面，1是反面
    this._toId = parameters.toId;
    this._toSide = parameters.toSide||0;//是设备的正面还是反面，0是正面，1是反面
    this._userDataMap = {}; //类似DataInfo的数据，可以放在userDataMap 里面
    // this._controls = null;
    this._fromControls = parameters.fromControls || null;
    this._toControls = parameters.toControls || null;
    this._radius = 2;
    this._alarmState = new it.AlarmState(this);
    this._fromPortId = parameters.fromPortId;
    this._toPortId = parameters.toPortId;
    this._routeType = parameters.routeType;
    this._fromIpAddress = parameters.fromIpAddress;
    this._toIpAddress = parameters.toIpAddress;
    // "$p0.front + $p0.depth/2","$p1"
};
mono.extend($Link,$Base,{
   ___accessor : ['name','type','dataTypeId','fromId','fromSide','toId','toSide','fromControls','toControls','radius','alarmState','fromPortId','toPortId','routeType','fromIpAddress','toIpAddress'],
    IT_Data:true,
   getId : function(){
      return this._id;
   },
   
   setId : function(id){
       if(this._id === undefined){
          this._id = id;
       }else{
          throw 'Can\'t change id';
       }
   },

   setUserData : function(key,value){
       if(value == null){
         delete this._userDataMap[key];
       }else{
         this._userDataMap[key] = value;
       }
    },
   
    getUserData  :function(key){
       return this._userDataMap[key];
    },
});
it.Link = $Link;

/**
 * 数据采集点，如：温/湿度采集器
 * 注意：如果type是湿度的话，那这个parentId就是dataId；
 *      如果type是温度的话，那这个parentId就是temperatureFieldId(即温度场id)
 * @constructor
*/

var $Collector = function(parameters){
    $Base.call(this);
    parameters = parameters || {};
    this._parentId = parameters.parentId||""; // 如温度场的id，表示该采集器在哪里
    this._id = parameters.id || "";
    this._position = parameters.position || new mono.Vec3();
    this._location = parameters.location||''; //逻辑坐标，可以是data的id
    this._value = parameters.value || "0";
    this._data = parameters.data||{}; //也是传感器的值，这个data是个obj对象，它可能包含了多个值，如：温度、湿度等
    // 采集器的长宽高
    this._width = parameters.width || 0;
    this._height = parameters.height || 0;
    this._depth = parameters.depth ||0;
    this._description = parameters.description;
    this._type = parameters.type || "temperature";
};
/**
 * 采集器的类型
 * @type {string}
 */
$Collector.Type = {};
$Collector.Type.humidity = 'humidity';
$Collector.Type.temperature = 'temperature';

mono.extend($Collector,$Base,{
    ___accessor: ['id','parentId','value','data','width',"height","depth","type","position","location"],

    fromJson : function(json){
        if(typeof json === 'string'){
            json = JSON.parse(json);
        }
        this._id = json.id;
        this._parentId = json.parentId;
        this._description = json.description;
        this._width = json.width;
        this._height = json.height;
        this._depth = json.depth;
        this._type = json.type;
        this._value = json.value;
        this._data = json.data;
        if(json.position && (json.position.x!== undefined || json.position.y!== undefined || json.position.z!== undefined)){
            this._position = new mono.Vec3(json.position.x || 0,json.position.y || 0,json.position.z || 0);
        }else if(mono.Utils.isArray(json.position)){
            this._position = new mono.Vec3(json.position[0] || 0,json.position[1] || 0,json.position[2] || 0);
        }
        this._location = json.location;
    },

});

it.Collector = $Collector;

/**
 * 采集器的类型
 * @type {string}
 */
//it.Collector.Type = {};
//it.Collector.Type.humidity = 'humidity';
//it.Collector.Type.temperature = 'temperature';
//it.Collector.Type.humidity = 'humidity';

/**
 * 温度场类，该类用来生成温度云图
 * @constructor
 */
var $TemperatureField = function(parameters){
    $Base.call(this);
//    this.sceneManager = sceneManager;
    parameters = parameters || {};
    this._parentDataId = parameters.parentDataId; // 资产id，也就是该温度场在哪里(如那个楼层，哪个area等)
    this._id = parameters.id || "";
    this._width = parameters.width || null; // 如果温度场不是矩形，那暂时没法搞了
    this._height = parameters.height || null;
    this._position = parameters.position || new mono.Vec3();
    this._description = parameters.description || "";
//    this.heatMap = null;
    //最小/大阀值，超过就通过特殊或加深颜色来特殊标识,应该放到上一层(即manager中)
    this._minValue = parameters.minValue || null;
    this._maxValue = parameters.maxValue ||null;
    this._withBg = parameters.withBg || false; //该温度云图上是不是加上蓝底

//    this.tempBillbords = {};
//    this.parentNode = this.sceneManager.getNodeByDataOrId(this._parentDataId);
    this.collectors = new mono.List(); // 采集器
//    this.dataBox = this.sceneManager.network3d.getDataBox();
    //温度云图时，通常需要虚化其他的设备,其实可以进一步封装，放到上一层，所有个温度场共用一个
//    this.isVirtualElementFunction = function(){ //默认是虚化的
//        return true;
//    };
//    this.virtualFilter = new it.VirtualManager(this.sceneManager);
//    this.sceneManager.viewManager3d.addMaterialFilter(this.virtualFilter);
//    this.tempBoard = null;
};

mono.extend($TemperatureField,$Base,{

    ___accessor: ['id',"parentDataId",'width','height',"position","minValue","maxValue","withBg"],

    fromJson : function(json){
        if(typeof json === 'string'){
            json = JSON.parse(json);
        }
        this._id = json.id;
        this._parentDataId = json.parentDataId;
        this._description = json.description;
        this._width = json.width;
        this._height = json.height;
        this._withBg = json.withBg;
        this._minValue = json.minValue;
        this._maxValue = json.maxValue;
        if(json.position && (json.position.x!== undefined || json.position.y!== undefined || json.position.z!== undefined)){
            this._position = new mono.Vec3(json.position.x || 0,json.position.y || 0,json.position.z || 0);
        }else if(mono.Utils.isArray(json.position)){
            this._position = new mono.Vec3(json.position[0] || 0,json.position[1] || 0,json.position[2] || 0);
        }
    },

    addCollector : function(collector){
        if(collector){
            this.collectors.add(collector);
        }
    },

    removeCollector : function(collector){
        if(collector){
            this.collectors.remove(collector);
        }
    },

    getCollectors : function(){
        return this.collectors;
    }

});

it.TemperatureField = $TemperatureField;

var $Light = function(params){
   var params = params||{};
   this._id = params.id||'';
   this._description = params.description;
   this._sceneId = params.sceneId;
   this._type = params.type; // 灯光类型
   this._color = params.color || 'PointLight';
   this._intensity = params.intensity;
   this._distance = params.distance;
   this._position = params.position||new mono.Vec3;
};

mono.extend($Light,$Base,{
   ___accessor: ['id','sceneId','type','color', 'intensity', "distance", "position"],
	
	fromJson: function (json) {
        if (typeof json === 'string') {
            json = JSON.parse(json);
        }
        this._id = json.id;
        this._description = json.description;
        if (json.position && (json.position.x !== undefined || json.position.y !== undefined || json.position.z !== undefined)) {
            this._position = new mono.Vec3(json.position.x || 0, json.position.y || 0, json.position.z || 0);
        } else if (mono.Utils.isArray(json.position)) {
            this._position = new mono.Vec3(json.position[0] || 0, json.position[1] || 0, json.position[2] || 0);
        }
        
        this._sceneId = json.sceneId;
        this._type = json.type;
        this._color = json.color;
        this._intensity = json.intensity;
        this._distance = json.distance;
    },
});

it.Light = $Light;

/**
 * 温度场管理器
 * @param sceneManager
 * @constructor
 */
var $TemperatureFieldManager = function(sceneManager){
    this.sceneManager = sceneManager;
    this.dataManager = this.sceneManager.dataManager;
    this.isVirtualElementFunction = function(){ //默认是虚化的
        return true;
    };
    this.virtualFilter = new it.VirtualManager(this.sceneManager);
    this.oldOpacityValue = this.virtualFilter.opacityValue;
    this.virtualFilter.opacityValue = 0.20;
    this.sceneManager.viewManager3d.addMaterialFilter(this.virtualFilter);
    this.fields = null;
    this.dataBox = this.sceneManager.network3d.getDataBox();
    this.heatMaps = {};
    this.tempBoards = {};
    this.bgMap = {}; //背景map {'blue':[minValue,maxValue]} add By Kevin 2016-11-16，因此可以考虑将TemperatureField中的_minValue和_maxValue去掉
    this.isAnimate = true; // 是不是云图从下到上循环移动
    this.deltaY = 0;
    this.billboardCanvasMap = {};//用来保存billboard上的canvas,使得刷新的时候不必重新创建canvas
    this.highestValue = 70.0;//最高温度，最高值转换成1(因为绘制温度云图时，热点的范围是0-1)，这里表示70.0对应的是温度场中的1
    this.isBillboardVertical = true;
};

mono.extend($TemperatureFieldManager,Object,{

    getAllCollectors : function(){
        return this.sceneManager.dataManager._typeCollectors[$Collector.Type.temperature];
    },

    /**
     * 显示当前场景下的温度值，没有温度场
     */
     showWithoutTempField : function(withIntervalRefresh,interval){
        this.tempBillbords = {};
        this.tempCollectors = this.getAllCollectors();//this.sceneManager.dataManager._typeCollectors[$Collector.Type.temperature];
        if(!this.tempCollectors){
            return 0;
        }
        if(this.intervalId){
            return 0;
        }
        var count = 0;
        for(var id in this.tempCollectors){
            var collector =  this.tempCollectors[id];
            if(collector){
                if(this.sceneManager.isCurrentSceneInstance(collector.getParentId())){
                    this.createBillboard(collector);
                    count++;
                }
            }
        }
        if(count < 1){
            return 0;
        }
        var self = this;
        if (withIntervalRefresh) {
            interval = parseInt(interval)||5000;
            this.intervalId = window.setInterval(function() {
                self.updateBillboards();
            }, interval);
        }else {
            this.intervalId = window.setInterval(function() { //不能没有intervalId，是否正在显示温度云图是通过是否有这个值来判断的
                // do nothing
            }, 10000);
        }
        return count;
     },

     getCollectorById : function(id){
         return this.dataManager._collectors[id];
     },

     beforeUpdateBillboards : function(){
         return;
     },

     updateBillboards : function(){
        this.beforeUpdateBillboards();
        if(!this.tempBillbords){
            return ;
        }
        for(var id in this.tempBillbords){
            var collector = this.getCollectorById(id);//this.dataManager._collectors[id];
            this.createBillboard(collector);
        }
     },

    /**
     * 显示“当前场景”下温度云场
     * “当前场景”:
     * 1、如果当前的scene不存在，那就认为是没有scene的机房，因此显示所有的tempfeild；
     * 2、如果存在scene，那就显示root下所有的field；如果root不存在（也就是一开始加载场景）该怎么整；
     */
    show : function(){
        var tempFieldSetting = [4,50];
        this.fields = this.dataManager.getTemperatureFields();
        if(this.intervalId){ // 表示已经有
            return ;
        }
        if(this.tempFieldArr && this.tempFieldArr.length){
            this.tempFieldArr.forEach(function(field){
                if(field.name.toLowerCase() == 'layernum'){
                    tempFieldSetting[0] = parseInt(field.value);
                }
                if(field.name.toLowerCase() == 'spacing'){
                    tempFieldSetting[1] = parseInt(field.value);
                }
            })
        }
        var currentFields = this.getCurrentSceneFields();
        if (!currentFields || currentFields.length < 1) {
            return ;
        }
        for(var i = 0 ; i < currentFields.length ; i++){
            this.createTempFieldByField(currentFields[i]);
        }
        this.virtualAllElement();
        this.sceneManager.network3d.dirtyNetwork();

        // 以下是3秒钟刷新一次:
        var self = this;
        this.intervalId = window.setInterval(function(){

            self.beforeRefresh();

            self.refresh(function(fid) {
                var hm = self.heatMaps[fid];
                var tempBoard = self.tempBoards[fid];
                if (self.isAnimate) {
                    var py = parseFloat(tempBoard.orgPositionY) + parseFloat(self.deltaY);
                    tempBoard.setPositionY(py);
                }
                if (tempBoard) {
                    tempBoard.setStyle('m.texture.image', hm.heatMapCanvas);
                    tempBoard.invalidateTexture();
                    // tempBoard.setStyle('m.texture.image', hm.getImage());
                    if (hm.heatMapCanvas.parentNode) {
                        document.body.removeChild(hm.heatMapCanvas);
                    }
                }
            });
            if(self.deltaY > tempFieldSetting[1]*(tempFieldSetting[0]-2)){
                self.deltaY = 0;
             }else{
                self.deltaY += tempFieldSetting[1];
            }
        },2000);
    },

    beforeRefresh : function(){

    },

    /**
     * 为了提高效率，统一刷新
     */
    refresh: function (callback) {
        var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
            window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
        var self = this;
        var fun = function(){
            for(var fid in self.heatMaps) {
                var hm = self.heatMaps[fid];
                if(self.isAnimate && self.deltaY > 0){
                    if(hm.datas && hm.datas.length > 0){
                        for(var i = 0 ; i < hm.datas.length ; i++){
                            var data = hm.datas[i];
                            if(data && data.length == 3){
                                data[2] = data[2] + 0.05; //多层变动时，上一层的比下一层高0.05
                            }
                        }
                    }
                    self.refreshColletor(self.fields[fid],hm);
                }else{// 如果同一个floor上有多个温度场，那除了最先调用的那个温度场会被清空外，其他的都不会被清空，所以deltaY++要放到refresh后
                    hm.clear();
                    self.setDataByField(self.fields[fid],hm);
                }
                document.body.appendChild(hm.getCanvas());
                if (callback) {
                    callback(fid);
                }
            }
        };
        raf(fun);
    },

    /**
     * 隐藏温度场
     */
    hide : function(){
        if(this.intervalId) {
            window.clearInterval(this.intervalId);
            delete this.intervalId;
        }else{
            return;
        }
        this.virtualFilter.clearAll();
        this.sceneManager.network3d.setSelectTransparencyThreshold(this.oldOpacityValue + 0.1); //阀值设置回去
        if(this.tempBoards){
            for(var fid in this.tempBoards){
                var board = this.tempBoards[fid];
                this.dataBox.remove(board);
                delete this.heatMaps[fid];
                delete this.tempBoards[fid];
            }
        }
        if(this.tempBillbords) {
            for (var collectorId in this.tempBillbords) {
                if (collectorId) {
                    var billboard = this.tempBillbords[collectorId];
                    if (billboard) {
                        billboard.setParent(null);
                        this.dataBox.remove(billboard);
                    }
                }
            }
            delete this.tempBillbords;
        }
        this.sceneManager.network3d.dirtyNetwork();
    },

    isShowing : function(){
        if(this.intervalId){
            return true;
        }
        return false;
    },

    /** 
     * 获取不虚化的类别
     * 显示温度场时，默认的是处理floor和room不虚幻外，其他的都虚幻
     */
    getNnVirtualCategorys : function(){
        return ['floor','room'];
    },

    virtualAllElement : function(){
        //到了查看温度场时，透明度调高了，因此点中的阀值也要适当的调高
        this.sceneManager.network3d.setSelectTransparencyThreshold(this.virtualFilter.opacityValue + 0.01);
        if(this.isVirtualElementFunction &&  this.isVirtualElementFunction()){
            this.virtualFilter.addAll();
            /*
            //但是地板和墙都不隐藏
            var categoryDatas = this.dataManager.getDataMapByCategory('floor');
            if(categoryDatas){
                for(var id in categoryDatas){
                    var data = categoryDatas[id];
                    if(data){
                        this.virtualFilter.remove(data);
                    }
                }
            }
            var roomDatas = this.dataManager.getDataMapByCategory('room');
            if(roomDatas){
                for(var id in roomDatas){
                    var data = roomDatas[id];
                    if(data){
                        this.virtualFilter.remove(data);
                    }
                }
            }
            */
            var nuVirtualCategorys = this.getNnVirtualCategorys();
            if (nuVirtualCategorys && nuVirtualCategorys.length > 0) {
                for (var i = 0; i < nuVirtualCategorys.length; i++) {
                    var cId = nuVirtualCategorys[i];
                    var categoryDatas = this.dataManager.getDataMapByCategory(cId);
                    if (categoryDatas) {
                        for (var id in categoryDatas) {
                            var data = categoryDatas[id];
                            if (data) {
                                this.virtualFilter.remove(data);
                            }
                        }
                    }
                }
            }
        }
    },

    createTempFieldByField: function (field) {
        if (!field) return null;
        var parentNode = this.sceneManager.getNodeByDataOrId(field.getParentDataId());
        if (!parentNode) { // 如果parent都没有（通常是没有加载）就不显示它了
            return null;
        }
        var position = field.getPosition();
        var withBg = field.getWithBg();
        // heatMap的位置(position)应该是相对于parent的位置，因此这里需要换算一下
//        var p_w_pos = parentNode.getWorldPosition();
        var p_w_pos = it.Util.getNodeCenterPosition(parentNode);
        var px = p_w_pos.x + position.x;
        var py = p_w_pos.z + position.y;
        var heatMap = new it.HeatMap({
            width: field.getWidth(),
            height: field.getHeight(),
            positionX: px,
            positionY: py,
            withBg : withBg,
        });
        this.setDataByField(field, heatMap);
        this.heatMaps[field.getId()] = heatMap;
        var tempBoard = heatMap.getTemperatureBoard();
        this.tempBoards[field.getId()] = tempBoard;
        var height = position.z||0;//因为y被水平用了，当初没有设计好，如今position被多个地方用到了，以及老数据的问题，所以用z来表示高度
        var bpy = parentNode.getWorldPosition().y+50+height;
        tempBoard.setPositionY(bpy);
        var parentWorldPos = parentNode.getWorldPosition();
        // tempBoard.setPositionX(parentWorldPos.x - position.x);// 有可能parentNode坐标的中心点不是其自身的中心点
        // tempBoard.setPositionZ(parentWorldPos.z - position.y);
        tempBoard.setPositionX(position.x+parentWorldPos.x);// 有可能parentNode坐标的中心点不是其自身的中心点
        tempBoard.setPositionZ(position.y+parentWorldPos.z);
        tempBoard.orgPositionY = bpy;
        tempBoard.setRotationZ(parentNode.getRotationY()*(-1));//本来是转y轴，由于所有的温度的board都已经沿X轴旋转了90度，转完后那以前的"正Y"就变成了"负Z"
        tempBoard.setClient(it.SceneManager.CLIENT_EXT_VITUAL,true);//它的透明不需要filter来处理
        this.dataBox.add(tempBoard);
        return heatMap;
    },

    setDataByField : function(field,heatMap){
        if(!field) return ;
        if(!field.collectors || field.collectors.length < 1){
            return;
        }
        this.dataBox.startBatch();
        for(var i = 0 ; i < field.collectors.size(); i++){
            var collector = field.collectors.get(i);
            if(collector){
                this.createHeatPoint(collector,heatMap,field);
            }
        }
        this.dataBox.endBatch();
    },

    refreshColletor: function(field) {
        if (!field) return;
        if (!field.collectors || field.collectors.length < 1) {
            return;
        }
        for (var i = 0; i < field.collectors.size(); i++){
            var collector = field.collectors.get(i);
            if (collector) {
                if (this.showBillboard(collector)){
                    this.createBillboard(collector, field);
                }
            }
        }
    },

    format: function (value) {
        return "温度:\n" + value.toFixed(1) + "°C";
    },

    /**
     * 是否创建billboard
     * @returns {boolean}
     */
    showBillboard : function(collector){
        return true;
    },

    getToFixed : function(){
        return 0;
    },

    /**
     * @param assetNode
     * @param humValue
    */
    createBillboard : function(collector,field){
        if(!collector) return;
        var collectorId = collector.getId();
        if(!this.tempBillbords){
            this.tempBillbords = {};
        }
        var billboard = this.tempBillbords[collectorId];
        if(!billboard){
            var parentDataId = null;
            if (field) {
                parentDataId = field.getParentDataId();
            }else{
                parentDataId = collector.getParentId();
            }
            var parentNode = this.sceneManager.getNodeByDataOrId(parentDataId);
            var position = collector.getPosition();
            var location = collector.getLocation();//这个也可以是data的id，如果是data的id的话，就以其3D对象的位置计算
            var px,pz,py;
            var p_w_pos = parentNode.getWorldPosition();
            if(location && typeof(location) == 'string' && this.dataManager.getDataById(location)){
                var dataNode = this.sceneManager.getNodeByDataOrId(location);
                if(dataNode){
                    var p_w_pos = it.Util.getNodeCenterPosition(dataNode);
                    px = p_w_pos.x;
                    pz = p_w_pos.z;
                }
            }else{
                px = p_w_pos.x + position.x; 
                pz = p_w_pos.z + position.z;
            }
            var py = p_w_pos.y + position.y;
            var pbb = parentNode.getBoundingBox();
            if(pbb){
                var height = (pbb.max.y-pbb.min.y)/2;
                if(height < 10){ //shapeNode(area)的话。太矮了
                    height = 100;
                }
                py = py + height;
            }else {
                py = py + 100;
            }
            // var canvas = this.createCanvas(collectorId,'','温度:','',null);
            // billboard = it.Util.createSpecailTextBillboard("text",null,true,canvas);//createHumidityBoard
            billboard = new mono.Billboard();
            billboard.s({
                   'm.texture.image':this.createCanvas(collectorId,0,'','',null),
                   'm.transparent': true,
                   'm.alignment': mono.BillboardAlignment.bottomCenter,
                   'm.vertical': !!this.isBillboardVertical, //tue 2017-05-16 Kevin
            }); 
            //如果创建了collector的3d对象的话，应该是该3D对象，否则的话就设置成collector的“父亲”吧(也就是collector的position是相对于那个obj)，
//            billboard.setParent(parentNode);
            billboard.setPositionX(px);
            billboard.setPositionY(py);
            billboard.setPositionZ(pz);
            this.tempBillbords[collectorId] = billboard;
            this.dataBox.add(billboard);
        }
        var value = collector.getValue()||0;
        value = Number(parseFloat(value).toFixed(this.getToFixed()));
        if (billboard._tvalue == value) { //值没有变的话就直接退出
            return;
        }
        var bg = null;
        if(this.bgMap){
            for (var color in this.bgMap) {
                var values = this.bgMap[color];
                if (!values) {
                    continue;
                }
                if (values.length == 2) {
                    if (values[0] != undefined 
                        && values[1] != undefined && value >= values[0] && value < values[1]) {
                        bg = color;
                        break;
                    }else if((values[0] == undefined || values[0] == '') 
                        && values[1] != undefined && value <= values[1]){
                        bg = color;
                        break;
                    }else if(values[0] != undefined 
                        && (values[1] == undefined || values[1] == '') && value >= values[0]){
                        bg = color;
                        break;
                    }
                }else if(values.length == 1 
                    && values[0] != undefined 
                    && value >= values[0]){
                     bg = color;
                     break;
                }
            }
        }
        billboard._tvalue = value;
        var newCanvas = this.createCanvas(collectorId,value,'温度:','°C',bg);
        billboard.setStyle('m.texture.image',newCanvas);
        // billboard.setScale(newCanvas.width / 2, newCanvas.height / 2, 1);
        this.setBillboardScale(billboard,newCanvas);
        billboard.setStyle("m.transparent",false);
        billboard.setStyle("m.alphaTest",0.5);
        var image = it.Util.getImageById(bg, value);
        var scaleX = newCanvas.width/2,scaleY = newCanvas.height/2;
        if (image && image.client) {
            if (image.client['scaleX']) {
                scaleX = parseFloat(image.client['scaleX']);
            }
            if (image.client['scaleY']) {
                scaleY = parseFloat(image.client['scaleY']);
            }
        }
        billboard.setScale(scaleX,scaleY,1);
        billboard.invalidateTexture();
        this.afterCreateBillboard(parentNode,billboard);
    },

    afterCreateBillboard : function(parentNode,billboard){
        // 便于扩展，有可能需要对创建好的billboard做一些扩展
    },

    setBillboardScale : function(billboard,canvas){
        if (billboard && canvas) {
             billboard.setScale(canvas.width / 2, canvas.height / 2, 1);
        }
    },

    createCanvas : function(collectorId,text,titleText,unit,bgcolor){
        var canvas = this.billboardCanvasMap[collectorId];
        // var newCanvas = it.Util.getSpecialTextBillboard(text,titleText,unit,bgcolor,true,canvas);
        // var newCanvas = it.Util.getHumOrTempCanvas(text,titleText,unit,bgcolor,canvas);
        // var newCanvas = this.drawCanvas(text,unit,bgcolor,canvas);
         var newCanvas = it.Util.createHumOrTempCanvas(text,unit,bgcolor,canvas);
        if (!canvas) {
           this.billboardCanvasMap[collectorId] = newCanvas; 
        }
        return newCanvas;
    },

    /*
    drawCanvas: function(text,unit,bgcolor,canvas) {
        var image = it.Util.getImageById(bgcolor, text);
        var canvas = canvas || document.createElement('canvas');
        if (!image) {
            return canvas;
        }
        if (!image.client) {
            image.client = {
                width: 256,
                height: 123,
                size: 50,
                lineWidth: 5,
                color: '#FFFFFF',
                startX: 20,
                startY: 60
            };
        };
        color = image.client['color'] || '#888888';
        var width = image.width,
            height = image.height;
        var context = canvas.getContext('2d');
        width = image.client['width'] || image.width * 2, height = image.client['height'] || image.height * 2;
        canvas.height = height;
        canvas.width = width;
        context.drawImage(image, 0, 0, width, height);
        var x = parseInt(image.client['startX']) || (height - 50);
        var y = parseInt(image.client['startY']) || (height - 50);
        if (text) {
            var csize = parseInt(image.client['size']) || 80;
            var fontFamily = parseInt(image.client['fontFamily'])||'"Microsoft Yahei"';
            // context.font = '80px DigifaceWide';            
            context.font = 'bold '+csize + 'px ' + fontFamily;
            context.textAlign = 'left';
            context.textBaseline = 'middle';
            context.lineWidth = parseInt(image.client['lineWidth']) || 8;
            if (image.client['stroke']) {
                context.strokeStyle = color;
                context.strokeText(text, x, y);
            } else {
                context.fillStyle = color;
                context.fillText(text, x, y);
            }
            if (image.client['withUnit']) {
                var width = context.measureText(text).width;
                var unitSize = parseInt(csize/2)||5;
                context.font = 'bold '+unitSize + 'px "Microsoft Yahei"';
                if (image.client['stroke']) {
                     context.strokeText('°C', x+width, y);
                }else{
                     context.fillText('°C', x+width, y);
                }
            }

        }
        return canvas;
    },
    */

    /**
    * b相对于a的位置
    * a是parent或祖宗，b是孩子或子孙
    **/
    getRelativePosition: function(a, b) {
        var m1, m2;
        m1 =  new mono.Mat4().getInverse(a.worldMatrix.clone());
        m2 =  new mono.Mat4().multiplyMatrices(m1, b.worldMatrix.clone());
        var position = new mono.Vec3().getPositionFromMatrix(m2);
        return position;
    },

    createHeatPoint : function(collector,heatMap,field){
        if(!collector || !heatMap) return;
        // var position = collector.getPosition();
        var parentNode = this.sceneManager.getNodeByDataOrId(field.getParentDataId());
        //通过setRotation来计算相对坐标的位置的方法效率非常的低，改成通过getRelativeTransform方式，可是当dataNode本身也旋转了的注意一下
        // var rotationY = parentNode.getRotationY();
        // if (!rotationY) {
        //     parentNode.setRotationY(0);//先将Y轴的旋转设置成0，算好相对位置后再设置回去。这么设置对速度有很大的影响，估计要触发很多事件
        // }
        // var wpp = it.Util.getNodeCenterPosition(parentNode);//parentNode?parentNode.getWorldPosition():new mono.Vec3();
        var rpp = parentNode.getPosition(); //parent的相对坐标

        var position = collector.getPosition();
        var location = collector.getLocation();//这个也可以是data的id，如果是data的id的话，就以其3D对象的位置计算
        var px,pz;
        if(location && typeof(location) == 'string' && this.dataManager.getDataById(location)){
            var dataNode = this.sceneManager.getNodeByDataOrId(location);
            // var rto =  parentNode.getRelativeTransform(dataNode);
            var rto = this.getRelativePosition(parentNode,dataNode);
            if(dataNode){
                var p_w_pos = it.Util.getNodeCenterPosition(dataNode);
                // p_w_pos.x = p_w_pos.x - wpp.x; //将世界坐标转换成相对与floor的中心点的坐标
                // p_w_pos.z = p_w_pos.z - wpp.z;
                p_w_pos.x = rto.x; //rto.position.x; //将世界坐标转换成相对与floor的中心点的坐标
                p_w_pos.z = rto.z; //rto.position.z;
                p_w_pos.x = p_w_pos.x + rpp.x; //因为创建温度场时是按相对与父亲的节点来算的(计算时将其减掉了)，这里需要将其加上,如果
                p_w_pos.z = p_w_pos.z + rpp.z; //是通过getRelativeTransform计算获得的就不需要再加上
                px = p_w_pos.x;
                pz = p_w_pos.z;
            }
        }else{
            var p_w_pos = it.Util.getNodeCenterPosition(parentNode);
            // p_w_pos.x = p_w_pos.x - wpp.x; //将世界坐标转换成相对与floor的中心点的坐标
            // p_w_pos.z = p_w_pos.z - wpp.z;
            // p_w_pos.x = rto.position.x; //将世界坐标转换成相对与floor的中心点的坐标
            // p_w_pos.z = rto.position.z;
            p_w_pos.x = p_w_pos.x ;//+ rpp.x; //因为创建温度场时是按相对与父亲的节点来算的(计算时将其减掉了)，这里需要将其加上
            p_w_pos.z = p_w_pos.z ;//+ rpp.z; 
            px = p_w_pos.x + position.x;
            pz = p_w_pos.z + position.z;
        }
        // if (!rotationY) {
        //    parentNode.setRotationY(rotationY);
        // }

        // p_w_pos 都是算的世界坐标，当floor发生了旋转，那这些坐标其实也发生了旋转。而温度云图最后又转了一把，
        // 解决的办法1：p_w_pos不是世界坐标，而是转换成相对与floor旋转之前的相对坐标;

        var value = collector.getValue();//这是温度值，需要将其转成0-1之间的值(当然是可以超过1的)
        if(value){
            value = parseFloat(value/(this.highestValue||70.0)); //认为70就对应1
        }

        if(px!=undefined && pz!=undefined){
//            heatMap.addPoint(px,pz,collector.getValue() || 0);
            var obj = {
                x: px || 0,
                y: pz || 0,
                w: collector.getWidth() || 0,
                l: collector.getDepth() || 0,
                value: value || 0,
//            axis:axis //旋转轴
            };
            heatMap.addPointWithArea(obj);
        }
        if(this.showBillboard(collector)){
            this.createBillboard(collector,field);
        }
    },

    /**
     * 获取当前场景中的温度场
     */
    getCurrentSceneFields : function(){
        var tFields = [];
        var fields = this.dataManager.getTemperatureFields();
        for(var fid in fields) {
            var tempField = fields[fid];
            if (!tempField) {
                continue;
            }
            if (this.sceneManager.isCurrentSceneInstance(tempField.getParentDataId(),true)) {
                tFields.push(tempField);
            }
        }
        return tFields;
    }

});

it.TemperatureFieldManager = $TemperatureFieldManager;

var $HumidityManager = function(sceneManager){
    this.sceneManager = sceneManager;
    this.dataManager = this.sceneManager.dataManager;
    this.dataBox = this.sceneManager.network3d.getDataBox();
    this.humCollectors = null;
    this.tempBillbords = {};
    this.bgMap = {}; //背景map {'blue':[minValue,maxValue]} add By Kevin 2016-11-16
    // this._minValue = null; //去掉，改用bgMap来代替
    // this._maxValue = null;
    this.billboardCanvasMap = {};
    this.isBillboardVertical = false;
};

mono.extend($HumidityManager,Object,{

    /**
     * 显示湿度：
     * 显示的是当前场景下的所有的湿度的billboard
     * @returns {number} 返回的是显示的billboard的数量
     */
    show:function(){
        this.humCollectors = this.sceneManager.dataManager._typeCollectors[$Collector.Type.humidity];
        if(!this.humCollectors){
            return 0;
        }
        if(this.intervalIndex){
            return 0;
        }
        var count = 0;
        for(var id in this.humCollectors){
            var collector =  this.humCollectors[id];
            if(collector){
                if(this.sceneManager.isCurrentSceneInstance(collector.getParentId())){
                    this.createBillboard(collector);
                    count++;
                }
            }
        }
        if(count < 1){
            return 0;
        }
        var self = this;
        this.intervalIndex = window.setInterval(function(){
            self.update();
        },5000);
        return count;
    },

    update : function(){
        if(!this.tempBillbords){
            return ;
        }
        for(var id in this.tempBillbords){
            var collector = this.dataManager._collectors[id];
            this.createBillboard(collector);
        }
    },

    hide:function(){
        if(this.intervalIndex){
            window.clearInterval(this.intervalIndex);
            delete this.intervalIndex;
        }
        if(this.tempBillbords){
            for(var id in this.tempBillbords){
                var billboard = this.tempBillbords[id];
                if(billboard){
                    this.dataBox.remove(billboard);
                }
                delete this.tempBillbords[id];
            }
        }
    },

    isShowing : function(){
        if(this.intervalIndex){
            return true;
        }
        return false;
    },

    getToFixed : function(){
        return 2;
    },

    // format: function (value) {
    //     return "湿度:\n" + value.toFixed(1) + "°";
    // },

    createBillboard:function(collector){
        if(!collector) return null;
        var collectorId = collector.getId();
        var billboard = this.tempBillbords[collectorId];
        if(!billboard){
            var parentNode = this.sceneManager.getNodeByDataOrId(collector.getParentId());
            if(!parentNode){
                console.log('parent does not exists!');
                return null;
            }
            var position = collector.getPosition();
            var p_w_pos = it.Util.getNodeCenterPosition(parentNode);
            var px = p_w_pos.x + position.x;
            var pz = p_w_pos.z + position.z;
            var py = p_w_pos.y + position.y; //应该是在parent的顶端+自己
            var pbb = parentNode.getBoundingBox();
            var height = 0;
            if(pbb){
                height =  (pbb.max.y-pbb.min.y)/2;
            }

            if (height < 10) {
                height = 100;
            }
            py = py + height;

            // var canvas = this.createCanvas(collectorId,'','湿度:','',null);
            billboard = new mono.Billboard();
            billboard.s({
                   'm.texture.image':this.createCanvas(collectorId,0,'','',null),
                   'm.transparent': true,
                   'm.alignment': mono.BillboardAlignment.bottomCenter,
                   'm.vertical': !!this.isBillboardVertical, //false
            }); 
        // billboard = it.Util.createSpecailTextBillboard("text",null,true,canvas);//createHumidityBoard
            //如果创建了collector的3d对象的话，应该是该3D对象，否则的话就设置成collector的“父亲”吧(也就是collector的position是相对于那个obj)，
            billboard.setPositionX(px);
            billboard.setPositionY(py);
            billboard.setPositionZ(pz);
            // billboard.setStyle('m.vertical', true);
            this.tempBillbords[collectorId] = billboard;
            this.dataBox.add(billboard);
        }
        var value = parseFloat(collector.getValue()||0);
         if (billboard._tvalue == value) { //值没有变的话就直接退出
            return billboard;
        }
        var bg = null;
        if(this.bgMap){
            for (var color in this.bgMap) {
                var values = this.bgMap[color];
                if (!values) {
                    continue;
                }
                if (values.length == 2) {
                    if (values[0] != undefined 
                        && values[1] != undefined && value >= values[0] && value <= values[1]) {
                        bg = color;
                        break;
                    }else if((values[0] == undefined || values[0] == '')
                        && values[1] != undefined && value <= values[1]){
                        bg = color;
                        break;
                    }else if(values[0] != undefined 
                        && (values[1] == undefined || values[1] == '') && value >= values[0]){
                        bg = color;
                        break;
                    }
                }else if(values.length == 1 
                    && values[0] != undefined 
                    && value >= values[0]){
                     bg = color;
                     break;
                }
            }
        }
        billboard._tvalue = value;
        var canvas = this.createCanvas(collectorId,value.toFixed(this.getToFixed()),'湿度:','%',bg);
        var image = it.Util.getImageById(bg, value);
        var scaleX = canvas.width/2,scaleY = canvas.height/2;
        if (image && image.client) {
            if (image.client['scaleX']) {
                scaleX = parseFloat(image.client['scaleX']);
            }
            if (image.client['scaleY']) {
                scaleY = parseFloat(image.client['scaleY']);
            }
        }
        billboard.setScale(scaleX,scaleY,1);
        // billboard.setScale(canvas.width*1.5,canvas.height*1.5,1);
        billboard.setStyle('m.texture.image',canvas);
        billboard.setStyle("m.transparent",false);
        billboard.setStyle("m.alphaTest",0.5);
        billboard.invalidateTexture();
        return billboard;
    },

    createCanvas : function(collectorId,text,titleText,unit,bgcolor){
        var canvas = this.billboardCanvasMap[collectorId];
        // var newCanvas = it.Util.getHumOrTempCanvas(text,titleText,unit,bgcolor,canvas);
        // var newCanvas = this.drawCanvas(text,unit,bgcolor,canvas);
        var newCanvas = it.Util.createHumOrTempCanvas(text,unit,bgcolor,canvas);
        if (!canvas) {
           this.billboardCanvasMap[collectorId] = newCanvas; 
        }
        return newCanvas;
    },

/*
    drawCanvas: function(text,unit, bgcolor, canvas) {
        var image = it.Util.getImageById(bgcolor, text);
        var canvas = canvas || document.createElement('canvas');
        if (!image) {
            return canvas;
        }
        if (!image.client) {
            image.client = {
                width: 256,
                height: 123,
                size: 50,
                lineWidth: 5,
                color: '#FFFFFF',
                startX: 20,
                startY: 60
            };
        };
        color = image.client['color'] || '#888888';
        var width = image.width,
            height = image.height;
        var context = canvas.getContext('2d');
        width = image.client['width'] || image.width * 2, height = image.client['height'] || image.height * 2;
        canvas.height = height;
        canvas.width = width;
        context.drawImage(image, 0, 0, width, height);
        var x = parseInt(image.client['startX']) || (height - 50);
        var y = parseInt(image.client['startY']) || (height - 50);
        if (text) {
            var csize = parseInt(image.client['size']) || 80;
            var fontFamily = parseInt(image.client['fontFamily'])||'"Microsoft Yahei"';
            // context.font = '80px DigifaceWide';            
            context.font = csize + 'px ' + fontFamily;
            context.textAlign = 'left';
            context.textBaseline = 'middle';
            context.lineWidth = parseInt(image.client['lineWidth']) || 8;
            if (image.client['stroke']) {
                context.strokeStyle = color;
                context.strokeText(text, x, y);
            } else {
                context.fillStyle = color;
                context.fillText(text, x, y);
            }
        }
        return canvas;
    },
    */

    getsCurrentCollector : function(){
        this.humCollectors = this.sceneManager.dataManager._typeCollectors[$Collector.Type.humidity];
        if(!this.humCollectors)return;
        var currentCollector = [];
        for(var id in this.humCollectors){
            var collector =  this.humCollectors[id];
            if(!collector)continue;
            if(this.sceneManager.isCurrentSceneInstance(collector.getParentId())){
                currentCollector.push(collector);
            }
        }
        return currentCollector;
    }

});


it.HumidityManager = $HumidityManager;
/**
 * terry 处理鼠标点击事件 或许应该改成EventHandler
 */
var $EventHandler = function  () {
	
}

mono.extend($EventHandler,Object,{
    getQueue : function(){
       return 1000;
    },

	shouldHandleDoubleClickElement : function(element,network,data,clickedObj){
       return false;
	},

	shouldHandleMouseUpElement : function(element,network,data,clickedObj){
		return false;
	},

	shouldPropogateDoubleClickElement : function(element,network,data,clickedObj){
       return false;
	},

	shouldHandleDoubleClickBackground : function(network, event){
		return false;
	},

	shouldHandleMouseUpBackground : function(network, event){
		return false;
	},

	shouldPropogateDoubleClickBackground : function(network){
       return false;
	},

	shouldHandleClickElement : function(element,network,data,clickedObj){
       return false;
	},
    
    shouldPropogateClickElement : function(element,network,data,clickedObj){
       return false;
    },

	shouldHandleClickBackground : function(network){
        return false;
	},

	shouldPropogateClickBackground : function(network){
		return false;
	},

	handleDoubleClickBackground : function(network){
        
	},

	handleClickBackground : function(network){
        
	},

	handleDoubleClickElement : function(element,network,data,clickedObj,callback){
	    
	}, 

    handleClickElement : function(element,network,data,clickedObj){
        
    },

    handleMouseMoveElement : function(node,network,data,clickedObj,event){

    },

    handleMouseMoveBackground : function(network){

    },

	handleMouseUpElement : function(node,network,data,clickedObj,event){

	},

	handleMouseUpBackground : function(network){

	},
});

it.EventHandler = $EventHandler;

/**
 * 管理与Network相关的一切事务
 */
var $ViewManager = function (sceneManager, network, for2d) {
    mono.PropertyChangeDispatcher.call(this);
    this.sceneManager = sceneManager;
    this.network = network || this.initView();
    this.network.getRootView().style.position = 'absolute';
    this._for2d = for2d;
    this._defaultNode = new mono.List();
    this.initResource();
    this.configView();
    this.networkParameters = {};
    this.cameraParameters = {};
    this.enableDBLClick = true; //有时想锁定交互时
    this.enableClick = false;
    this.enableMousemove = true;
    this.enableMouseup = false;
    this.visibleMap = {}; //用于缓存是否可见
};

mono.extend($ViewManager, mono.PropertyChangeDispatcher, {
    initView: function () {
        return new mono.Network3D();
    },

    initResource: function () {
        this._eventHandlers = [];
        this._materialFilters = [];
        this.visibleMap = {};
        this._visibleFilters = [];
        this._selectableFilters = [];
        this._renderCallbacks = [];
        this._focusNode = null;
    },

    initDefault: function () {
        this.defaultEventHandler = new it.DefaultEventHandler(this.sceneManager);
        this._eventHandlers.push(this.defaultEventHandler);

        this.defaultMaterialFilter = new it.VirtualManager(this.sceneManager);
        this._materialFilters.push(this.defaultMaterialFilter);

        this.defaultSelectableFilter = new it.SelectableManager(this.defaultMaterialFilter);
        this._selectableFilters.push(this.defaultSelectableFilter);

        var self = this;
        this.addPropertyChangeListener(function (event) {
            if (event.property == "focusNode") { // 注意：如果lookAt的是it.Link
                var node = event.newValue;
                if (self.isDealWithVirtual) {
                    self.dealWithVirtual(node);
                }
                /*
                if (self.defaultMaterialFilter) {
                    if(!node){ // 如果值为空的话，那就认为全部显示
                        self.defaultMaterialFilter.clear();
                    }else{
                        if (self.defaultMaterialFilter.isVirtualOther(self.getDataByNode(node))) {
                            self.defaultMaterialFilter.addAll();
                            self.defaultMaterialFilter.removeByDescendant(node);
                            if(self.sceneManager.isLink(node)){ //如果lookAt的是Link时，还要将fromNode和toNode都显示出来
                                var fromNode = node.getFromNode();
                                var toNode = node.getToNode(); 
                                //有可能是端口，所以得从业务上来获取:
                                var link = self.getDataByNode(node);
                                if (link) {
                                   if (link.getFromId()) {
                                      fromNode = self.sceneManager.getNodeByDataOrId(link.getFromId());
                                   }
                                   if (link.getToId()) {
                                      toNode = self.sceneManager.getNodeByDataOrId(link.getToId());
                                   }
                                }
                                self.defaultMaterialFilter.removeByDescendant(fromNode);
                                self.defaultMaterialFilter.removeByDescendant(toNode);
                            }
                        }else{ // 聚焦不虚幻其他时，则清空，而不是保存上一级虚幻的状态
                          self.defaultMaterialFilter.clear();
                        }
                    }
                }
                */
                /**
                 * add by kevin at 2017-05-25
                 * 这个resetCameraDistance需要谨慎处理，突然设置会导致镜头乱跳 
                 * 1、如果是maxdistance变大的话，如：从机柜跳到room或floor时，应该是先resetDistance。否则camera老是在局部变化
                 * 2、如果是maxdistance变小的话，如：从room或floor到rack时，放到移动好镜头之后。否则camera会突然跑到局部了
                 * 3、minDistance变
                 */
                // self.resetCameraDistance(node); 
                self.setCameraDistanceForBeforePlayCamere(node);
            }
        });

        /* Add 2017-08-23 setCameraDistance其实可以不用这么麻烦，在before时，min=1，max=2w。然后在lookAfter后再置成计算得到的值。
         * 如果before是min最小，max最大，然后after再整一把。这样distance永远不会超出一定的空间，但是当想在中间实现个超出这个范围的动画时，
         * 则总是出现很多的问题 —— 可以考虑这么改进，需要做些测试，确保没有问题
         */
        // 注意有些地方没有调lookAt，而是直接调setFocus，此时就永远不会执行下面的After了 ，注意，如直接进园区 2017-05-31
        // 注意：有可能是动画执行完后执行，但是切换的快的话，动画会掉用setFous时停止，
        //     此时这个会运行在setCameraDistanceForBeforePlayCamere之后执行,那在内部判断一下mainNode是不是以前的focusNode，不是的话就不执行
        this.defaultEventHandler.addAfterLookFinishedAtListener(function (mainNode, node) {
            if (self._focusNode == mainNode) {
                self.setCameraDistanceForAfterPlayCamere(mainNode);
            }
        });

        this.network.setPickingTexturePixel(false);

        // this.network.sortNodes = false; //透明叠加闪闪的问题 -- add By Kevin 2017-05-25
        this.network.sortNodes = true;

        this.tooltipManager = new it.TooltipManager(this.sceneManager);
        this.addEventHandler(this.tooltipManager);
        this.addRenderCallback(this.tooltipManager);
        this.addDefaultYRestrict();
        this.addCameraDistanceRestrict();
        this.setDefaultCamera();

        this.sceneManager.addSceneVisibleChangeListener(function (eve) {
            self.visibleMap = {};
        });
    },

    dealWithVirtual: function (node) {
        if (this.defaultMaterialFilter) {
            if (!node) { // 如果值为空的话，那就认为全部显示
                this.defaultMaterialFilter.clear();
            } else {
                if (this.defaultMaterialFilter.isVirtualOther(this.getDataByNode(node))) {
                    this.defaultMaterialFilter.addAll();
                    this.defaultMaterialFilter.removeByDescendant(node);
                    if (this.sceneManager.isLink(node)) { //如果lookAt的是Link时，还要将fromNode和toNode都显示出来
                        var fromNode = node.getFromNode();
                        var toNode = node.getToNode();
                        //有可能是端口，所以得从业务上来获取:
                        var link = this.getDataByNode(node);
                        if (link) {
                            if (link.getFromId()) {
                                fromNode = this.sceneManager.getNodeByDataOrId(link.getFromId());
                            }
                            if (link.getToId()) {
                                toNode = this.sceneManager.getNodeByDataOrId(link.getToId());
                            }
                        }
                        this.defaultMaterialFilter.removeByDescendant(fromNode);
                        this.defaultMaterialFilter.removeByDescendant(toNode);
                    }
                } else { // 聚焦不虚幻其他时，则清空，而不是保存上一级虚幻的状态
                    // this.defaultMaterialFilter.clear();

                    //聚焦不虚化其他改为不虚化它的父亲（杨兴康）
                    this.defaultMaterialFilter.addAll();
                    var data = this.sceneManager.getNodeData(node);
                    this.defaultMaterialFilter.remove(data);
                    var parentId = data._parentId;
                    var parentData = this.sceneManager.dataManager.getDataById(parentId);
                    this.defaultMaterialFilter.remove(parentData);
                }
            }
        }
    },


    getSetMethod: function (key) {
        var setMethod = 'set' + key.charAt(0).toUpperCase() + key.slice(1);
        return setMethod;
    },

    /**
     * 给network设置默认的参数
     */
    setNetworkValue: function (key, value) {
        if (!key) {
            return;
        }
        var setMethod = this.getSetMethod(key);
        if (this.network[setMethod] && (typeof (this.network[setMethod]) === 'function')) {
            this.network[setMethod](value);
        } else {
            this.network[key] = value;
        }
        this.networkParameters[key] = value;
    },

    /**
     * 设置network和camera，使之回到初始化的状态
     */
    resetNetwork: function () {
        if (this.networkParameters) {
            for (var key in this.networkParameters) {
                this.setNetworkValue(key, this.networkParameters[key]);
            }
        }
    },

    /**
     * 给camera设置默认的参数
     */
    setCameraValue: function (key, value) {
        if (!key) {
            return;
        }
        var camera = this.network.getCamera();
        var setMethod = this.getSetMethod(key);
        if (camera[setMethod] && (typeof (camera[setMethod]) === 'function')) {
            camera[setMethod](value);
        } else {
            camera[key] = value;
        }
        this.cameraParameters[key] = value;
    },

    /**
     * 设置camera，使之回到初始化的状态
     */
    resetCamera: function () {
        if (this.cameraParameters) {
            for (var key in this.cameraParameters) {
                this.setCameraValue(key, this.cameraParameters[key]);
            }
        }
    },

    // 除了保留默认的初始话的对象外，删除的其他所有的data
    clear: function () {
        this.defaultMaterialFilter.clearAll();
        var box = this.network.getDataBox();
        box.clear();
        if (this._defaultNode.size() > 0) {
            this._defaultNode.forEach(function (node) {
                if (!(node instanceof mono.Light)) {
                    box.add(node);
                }
            });
        }
    },

    addDefaultNode: function (node) {
        if (!node) {
            return;
        }
        var box = this.network.getDataBox();
        if (!(node instanceof mono.Light)) {
            this._defaultNode.add(node);
        }
        box.add(node);
    },

    initLights: function () { // 用户可以自己定义这个方法。
        var ambientLight = new mono.AmbientLight(0xFFFFFF);
        // var box = this.network.getDataBox();
        this.addDefaultNode(ambientLight);

        // var pointLight = new mono.PointLight(0xFFFFFF,0.05);                
        // pointLight.setPosition(0,1000,-1000);                              
        // this.addDefaultNode(pointLight);

        // var pointLight = new mono.PointLight(0xFFFFFF,0.05);                
        // pointLight.setPosition(0,1000,1000);                               
        //  this.addDefaultNode(pointLight);

        // var pointLight = new mono.PointLight(0xFFFFFF,0.05);                
        // pointLight.setPosition(1000,-1000,-1000);                          
        //  this.addDefaultNode(pointLight);


        var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
        pointLight.setPosition(10000, 10000, 10000);
        this.addDefaultNode(pointLight);
        pointLight = new mono.PointLight(0xFFFFFF, 0.05);
        pointLight.setPosition(-10000, 10000, -10000);
        this.addDefaultNode(pointLight);
        var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
        pointLight.setPosition(10000, 10000, -10000);
        this.addDefaultNode(pointLight);
        pointLight = new mono.PointLight(0xFFFFFF, 0.05);
        pointLight.setPosition(-10000, 10000, 10000);
        this.addDefaultNode(pointLight);
        pointLight = new mono.PointLight(0xFFFFFF, 0.05);
        pointLight.setPosition(0, 0, 10000);
        this.addDefaultNode(pointLight);
        pointLight = new mono.PointLight(0xFFFFFF, 0.05);
        pointLight.setPosition(0, 0, -10000);
        this.addDefaultNode(pointLight);
        pointLight = new mono.PointLight(0xFFFFFF, 0.05);
        pointLight.setPosition(10000, 0, 0);
        this.addDefaultNode(pointLight);
        pointLight = new mono.PointLight(0xFFFFFF, 0.05);
        pointLight.setPosition(0, 0, -10000);
        this.addDefaultNode(pointLight);
    },

    addDefaultYRestrict: function () {
        var defaultInteraction = this.getDefaultInteraction();
        if (!defaultInteraction) {
            return;
        }
        defaultInteraction.yRistrict = true;
        defaultInteraction.yLowerLimitAngle = 0; //-Math.PI/20;
        defaultInteraction.yUpLimitAngle = Math.PI / 4;
        defaultInteraction.minDistance = 200;
        defaultInteraction.maxDistance = 10000;
    },

    removeDefaultYRestrict: function () {
        var defaultInteraction = this.getDefaultInteraction();
        if (!defaultInteraction) {
            return;
        }
        defaultInteraction.yRistrict = true;
        defaultInteraction.yLowerLimitAngle = -Math.PI / 2;
        defaultInteraction.yUpLimitAngle = Math.PI / 2;
        defaultInteraction.minDistance = 0;
        defaultInteraction.maxDistance = Infinity;
    },

    setDistance: function (minDistance, maxDistance) {
        var defaultInteraction = this.getDefaultInteraction();
        if (!defaultInteraction) {
            return;
        }
        if (minDistance || minDistance == 0) {
            defaultInteraction.minDistance = 0;
        }
        if (maxDistance) {
            defaultInteraction.maxDistance = Infinity;
        }
    },

    configView: function () {
        // this.initLights(); // remove to lightManager

        //        var networkView = this.network.getView();
        //        if(networkView
        //            && networkView.parentNode
        //            && networkView.parentNode.parentNode
        //            && networkView.parentNode.parentNode == document.body){ //只有当view的parent为body时才调整一把，由于是在appendChild之前就调用了,所以这里老是null
        //            mono.Utils.autoAdjustNetworkBounds(this.network,document.documentElement,'clientWidth', 'clientHeight', 0, 35);
        //        }
        var self = this,
            mousedown = false,
            mousemove = false;
        this.network.getRootView().addEventListener('dblclick', function (e) {
            if (!self.enableDBLClick) {
                return;
            }
            var element = self.filterDoubleClickElement(e);
            if (element && self.isHandleDoubleClickable(element.element)) {
                self.handleDoubleClick(element);
            } else if (element && element.element.getClient('bid') == 'unableDBLClick') { //bid为unableDBLClick资产不处理dblclick（处理添加资产问题） --loda
                return false;
            } else {
                self.handleDoubleClickBackground();
            }
        });

        this.network.getRootView().addEventListener('click', function (e) {
            if (!self.enableClick) { //默认情况下我们的click是关闭的，如果模型的面比较复杂的话，如在我们内置的datacenter中，picker比较耗时，一般情况下我们的click是没有用到的
                return;
            }
            var element = self.filterClickElement(e);
            if (element) {
                self.handleClick(element);
            } else {
                self.handleClickBackground();
            }
        });

        this.network.getRootView().addEventListener('mousedown', function (e) {
            mousedown = true;
            mousemove = false;
        });

        this.network.getRootView().addEventListener('mouseup', function (e) {
            mousedown = false;

            if (!self.enableMouseup) { //默认情况下我们的click是关闭的，如果模型的面比较复杂的话，如在我们内置的datacenter中，picker比较耗时,目前的mousemove用于显示tooltip
                return;
            }
            e._mousemove = mousemove;
            mousemove = false;
            var element = self.filterMouseMoveElement(e); //比较耗时，鼠标一移动就去判断是不是有picker相交
            if (element) {
                var node = element.element;
                self.handleMouseUpElement(element, e);
            } else {
                self.handleMouseUpBackground(e);
            }

        });

        this.network.getRootView().addEventListener('mousemove', function (e) {
            mousemove = true;
            if (!self.enableMousemove) { //默认情况下我们的click是关闭的，如果模型的面比较复杂的话，如在我们内置的datacenter中，picker比较耗时,目前的mousemove用于显示tooltip
                return;
            }
            e._mousedown = mousedown;
            if (mousedown) {
                return;
            }
            var element = self.filterMouseMoveElement(e); //比较耗时，鼠标一移动就去判断是不是有picker相交
            if (element) {
                var node = element.element;
                self.handleMouseMoveElement(element, e);
            } else {
                self.handleMouseMoveBackground(e);
            }
        });

        this.setOverLoadMaterial();
        this.setVisibleFunction();
        this.setSelectableFunction();
        this.setNetworkRenderCallback();
    },

    /**
     * 该Element是否可以双击，默认是可以双击
     * 为了扩展，先天空盒这个node,双击它其实不应该触发handleDoubleClick，而应该触发handleDoubleClickBackground，
     *         为了处理类似这样的对象，这里提供这样的方式可供扩展。
     */
    isHandleDoubleClickable: function (node) {
        return true;
    },

    getDataByNode: function (node) {
        if (!node) {
            return null;
        }

        var data = this.sceneManager.getNodeData(node);
        if (data == null && node.getParent()) {
            var parent = node.getParent();
            data = this.sceneManager.getNodeData(parent);
            if (data == null && parent.getParent()) {
                data = this.sceneManager.getNodeData(parent.getParent());
            }
        }
        return data;
    },

    setFocusNode: function (node, dealWithVirtual) {
        if (dealWithVirtual == undefined) {
            dealWithVirtual = true;
        }
        if (this._focusNode == node) {
            return;
        }
        var data = this.getDataByNode(node);
        var category = this.sceneManager.dataManager.getCategoryForData(data);
        if (category && category.getId().indexOf('earth') >= 0) { //why？？？
            this._focusNode = null; // 至少也应该为null吧，否则在Floor场景中点击Earth回到地球时，会有混乱的情况
            return;
        }
        var oldNode = this._focusNode;
        this._focusNode = node;
        this.isDealWithVirtual = dealWithVirtual;
        this.firePropertyChange("focusNode", oldNode, node);
        this.isDealWithVirtual = true;
    },

    getFocusNode: function () {
        return this._focusNode;
    },

    getDefaultEventHandler: function () {
        return this.defaultEventHandler;
    },

    removeDefaultEventHandler: function () {
        if (this.defaultEventHandler) {
            this.removeEventHandler(this.defaultEventHandler);
            this.defaultEventHandler = null;
        }
    },

    getDefaultVirtualMaterialFilter: function () {
        return this.defaultMaterialFilter;
    },

    removeDefaultMaterialFilter: function () {
        if (this.defaultMaterialFilter) {
            this.removeMaterialFilter(this.defaultMaterialFilter);
            this.defaultMaterialFilter = null;
        }
    },

    getDefaultInteraction: function () {
        return this.network.getDefaultInteraction();
    },

    addMaterialFilter: function (materialFilter) {
        if (!this.includeMaterialFilter(materialFilter)) {
            this._materialFilters.push(materialFilter);
        }
    },

    removeMaterialFilter: function (materialFilter) {
        var index = this._materialFilters.indexOf(materialFilter);
        if (index !== -1) {
            if (materialFilter.destoryBillboard) {
                materialFilter.destoryBillboard(); // 删除materialFilter前的先clear它所设置的Billboard
            }
            if (materialFilter.destoryParticle) {
                materialFilter.destoryParticle();
            }
            this._materialFilters.splice(index, 1);
        }
    },

    includeMaterialFilter: function (materialFilter) {
        var index = this._materialFilters.indexOf(materialFilter);
        if (index !== -1) {
            return true;
        }
        return false;
    },

    addVisibleFilter: function (visibleFilter) {
        if (!this.includeVisibleFilter(visibleFilter)) {
            this.visibleMap = {};
            this._visibleFilters.push(visibleFilter);
        }
    },

    removeVisibleFilter: function (visibleFilter) {
        var index = this._visibleFilters.indexOf(visibleFilter);
        if (index !== -1) {
            this.visibleMap = {};
            this._visibleFilters.splice(index, 1);
        }
    },

    includeVisibleFilter: function (visibleFilter) {
        var index = this._visibleFilters.indexOf(visibleFilter);
        if (index !== -1) {
            return true;
        } else {
            return false;
        }
    },

    addSelectableFilter: function (selectableFilter) {
        this._selectableFilters.push(selectableFilter);
    },

    removeSelectableFilter: function (selectableFilter) {
        var index = this._selectableFilters.indexOf(selectableFilter);
        if (index !== -1) {
            this._selectableFilters.splice(index);
        }
    },

    addEventHandler: function (eventHandler, index) {
        if (eventHandler instanceof it.EventHandler) {
            if (index === undefined) {
                return this._eventHandlers.push(eventHandler);
            } else {
                return this._eventHandlers.splice(index, 0, eventHandler);
            }
        }
    },

    removeEventHandler: function (eventHandler) {
        var index = this._eventHandlers.indexOf(eventHandler);
        if (index !== -1) {
            this._eventHandlers.splice(index, 1);
        }
    },

    addRenderCallback: function (renderCallback, index) {
        if (this._renderCallbacks.indexOf(renderCallback) >= 0) { //已经加过的话，直接返回
            return;
        }
        if (renderCallback.onRenderCallback) {
            if (index === undefined) {
                return this._renderCallbacks.push(renderCallback);
            } else {
                return this._renderCallbacks.splice(index, 0, renderCallback);
            }
        }
    },

    removeRenderCallback: function (renderCallback) {
        var index = this._renderCallbacks.indexOf(renderCallback);
        if (index !== -1) {
            this._renderCallbacks.splice(index, 1);
        }
    },

    filterMouseMoveElement: function (event) {
        return this.network.getFirstElementByMouseEvent(event, false);
    },

    handleMouseMoveElement: function (element, event) {
        var node = element.element;
        var data = this.getDataByNode(node);
        var i = 0,
            eventHandler;
        for (; i < this._eventHandlers.length; i++) {
            eventHandler = this._eventHandlers[i];
            eventHandler.handleMouseMoveElement(node, this.network, data, element, event);
        }
    },

    handleMouseMoveBackground: function (event) {
        var i = 0,
            eventHandler;
        for (; i < this._eventHandlers.length; i++) {
            eventHandler = this._eventHandlers[i];
            eventHandler.handleMouseMoveBackground(this.network, event);
        }
    },

    handleMouseUpElement: function (element, event) {
        var node = element.element;
        var data = this.getDataByNode(node);
        var i = 0,
            eventHandler;
        for (; i < this._eventHandlers.length; i++) {
            eventHandler = this._eventHandlers[i];
            if (eventHandler.shouldHandleMouseUpElement(node, this.network, data, element, event)) {
                eventHandler.handleMouseUpElement(node, this.network, data, element, event);
                return;
            }
        }
    },

    handleMouseUpBackground: function (event) {
        var i = 0,
            eventHandler;
        for (; i < this._eventHandlers.length; i++) {
            eventHandler = this._eventHandlers[i];
            if (eventHandler.shouldHandleMouseUpBackground(this.network, event)) {
                eventHandler.handleMouseUpBackground(this.network, event);
                return;
            }
        }
    },

    /**
     * 是否过滤掉虚化的对象
     */
    isFilterVirtualElement: function () {
        return true;
    },

    filterDoubleClickElement: function (event) {
        var filterFunction = null;
        // 天空盒在天空盒那块已经处理好了
        // var currentScene = this.sceneManager.getCurrentScene();
        // if(currentScene && currentScene.getCategoryId().toLowerCase().indexOf('datacenter')>=0){
        //   filterFunction = function(ele){
        //       if(ele.getClient('type') == 'parkSkybox'){
        //          return false;
        //      }
        //       return true;
        //   }
        // }
        var self = this;
        if (this.isFilterVirtualElement()) {
            filterFunction = function (ele) {
                return self.isVirtual(ele);
            }
        }
        return this.network.getFirstElementByMouseEvent(event, false, filterFunction);
    },

    getFirstElementInIntersectsByMouseEvent: function (intersects, event, intersectUnVisible, filterFunction) {
        var picking = this.network.getPickingByEvent(event);
        var list = intersects;
        if (intersects instanceof mono.List) {
            list = intersects.toArray();
        }
        var objects = picking.intersectObjects(list, false, intersectUnVisible);
        if (objects.length) {
            for (var i = 0; i < objects.length; i++) {
                var first = objects[i];
                var object3d = first.element;
                if (filterFunction == null || filterFunction.call(null, object3d)) {
                    return first;
                }
            }
        }
        return null;
    },

    getAnimation: function (element) {
        var node = element.element ? element.element : element;
        var animation = node.getClient('animation');
        return animation;
    },

    playAnimation: function (element, animation) {
        animation = animation || this.getAnimation(element);
        if (animation) {
            //          mono.AniUtil.playAnimation(element.element || element, animation);
            make.Default.playAnimation(element.element || element, animation);
        }
    },

    filterClickElement: function (event) {
        return this.network.getFirstElementByMouseEvent(event, false);
    },


    handleDoubleClick: function (element) {
        var node = element.element;
        var i = 0,
            eventHandler;
        for (; i < this._eventHandlers.length; i++) {
            eventHandler = this._eventHandlers[i];
            var data = this.getDataByNode(node);
            if (eventHandler.shouldHandleDoubleClickElement(node, this.network, data, element)) {
                eventHandler.handleDoubleClickElement(node, this.network, data, element);
                return;
            }
        }
        var animation = this.getAnimation(node);
        if (animation) {
            this.playAnimation(node, animation);
        }
    },

    handleClick: function (element) {
        var node = element.element;
        var i = 0,
            eventHandler;
        for (; i < this._eventHandlers.length; i++) {
            eventHandler = this._eventHandlers[i];
            var data = this.getDataByNode(node);
            if (eventHandler.shouldHandleClickElement(node, this.network, data, element)) {
                eventHandler.handleClickElement(node, this.network, data, element);
                return;
            }
        }
    },

    handleDoubleClickBackground: function () {
        var i = 0,
            eventHandler;
        for (; i < this._eventHandlers.length; i++) {
            eventHandler = this._eventHandlers[i];
            if (eventHandler.shouldHandleDoubleClickBackground(this.network)) {
                eventHandler.handleDoubleClickBackground(this.network);
                return;
            }
        }
    },

    handleClickBackground: function () {
        var i = 0,
            eventHandler;
        for (; i < this._eventHandlers.length; i++) {
            eventHandler = this._eventHandlers[i];
            if (eventHandler.shouldHandleClickBackground(this.network)) {
                eventHandler.handleClickBackground(this.network);
                return;
            }
        }
    },

    clearVisibleMap: function () {
        this.visibleMap = {};
        this.network.dirtyNetwork();
    },

    setOverLoadMaterial: function () { // 虚幻管理
        var network = this.network;
        // network.sortOpaqueOrderByMaterial = false; // 2018-01-16就按照默认的，true表示的是按距离排序
        var self = this,
            mfs = this._materialFilters;
        network.getOverLoadMaterial = function (node, material) {
            // if (!node.isVisible() || !self.visibleMap[node.getId()]) {
            //    return null;
            // } // update by Kevin 2017-06-09 有的Visible是在虚化的里面处理的，若直接返回则无法还原
            var isVirtual = false;
            var filterdMaterial = null;
            for (var i = 0; i < mfs.length; i++) {
                var mf = mfs[i];
                filterdMaterial = mf.filterMaterial(material, filterdMaterial, node);
                if (mf && mf.isVirtual && mf.isVirtual(node)) {
                    isVirtual = true;
                }
            }
            // if (isVirtual) {
            //    if (node._orgDepthMask == undefined) {
            //       node._orgDepthMask = node.getStyle('m.depthMask');
            //    }
            //    node.setStyle('m.depthMask', false); // Kevin 2018-01-23 如果是虚化的对象，那就让透明的背景色不是network的背景色
            // }else{
            //    if (node._orgDepthMask != undefined) {
            //       node.setStyle('m.depthMask', node._orgDepthMask); 
            //    }
            // }
            return filterdMaterial;
        };
    },

    setVisibleFunction: function () {
        var network = this.network;
        var self = this;
        network.isVisible = function (node) {
            /*if (node) {
              if (!node.isVisible()) { //优先级最高，因为这里没有监听它(node的的visible)改变
                    return false;
              }
              if (self.visibleMap[node.getId()] == true) {
                 return true;
              }else if(self.visibleMap[node.getId()] == false){
                 return false;
              }else{
                if(node instanceof TGL.Link || node instanceof TGL.PathLink){
                      if(!this.isVisible(node._fromNode)){
                          self.visibleMap[node.getId()] = false;
                          return false;
                      }
                      if(!this.isVisible(node._toNode)){
                          self.visibleMap[node.getId()] = false;
                          return false;
                      }
                }
                var vf = self._visibleFilters;
                for(var i = 0;i < vf.length;i ++){
                    var filter = vf[i];
                    if(!filter.isVisible(node,self.getDataByNode(node),network)){ //注意，只处理不可见对象,可见的才会继续找下一个filter
                        self.visibleMap[node.getId()] = false;
                        return false;
                    }
                }
              }
            }
            self.visibleMap[node.getId()] = true;
            return true;
            */
            return self.isVisible(node);
        }
    },

    setSelectableFunction: function () {
        var self = this;
        this.network.selectableFunction = function (node) {
            if (node) {
                var sfs = self._selectableFilters;
                if (!sfs || sfs.length < 1) {
                    return true;
                }
                for (var i = 0; i < sfs.length; i++) {
                    var sf = sfs[i];
                    if (!sf.isSelectable(node, self.network)) {
                        return false;
                    }
                }
            }
            return true;
        }
    },

    setNetworkRenderCallback: function () {
        var self = this;
        var rcs = this._renderCallbacks;
        this.network.renderCallback = function () {
            for (var i = 0; i < rcs.length; i++) {
                var renderCallback = rcs[i];
                renderCallback.onRenderCallback(self.network);
            }
        };
    },

    /**
     * 根据node计算其minDistance
     */
    _computeMinDistanceByNode: function (node) {
        if (!node) {
            return 0;
        }
        var bb = node.getBoundingBox();
        var minDistance = 0;
        if (bb && bb.size()) {
            minDistance = bb.size().x;
            if (bb.size().y < minDistance) { // add By Kevin 2017-06-08 以最小的为标准
                minDistance = bb.size().y;
            }
            if (bb.size().z < minDistance) {
                minDistance = bb.size().z;
            }
            if (minDistance) {
                minDistance += this.network.getCamera().getNear() * 0.6;
            }
        }
        return minDistance;
    },

    getMinDistanceByNode: function (node) {
        var data = this.sceneManager.getNodeData(node);
        if (data && data instanceof $Link) {
            var fromNode = this.sceneManager.getNodeByDataOrId(data.getFromId());
            var toNode = this.sceneManager.getNodeByDataOrId(data.getToId());
            var fromMinDistance = this._computeMinDistanceByNode(fromNode);
            var toMinDistance = this._computeMinDistanceByNode(toNode);
            if (fromMinDistance < toMinDistance) {
                return fromMinDistance;
            } else {
                return toMinDistance;
            }
        }
        return this._computeMinDistanceByNode(node);
    },

    getCameraDistanceByNode: function (lookAtNode) {
        if (!lookAtNode) {
            return null;
        }
        var fov = this.network.getCamera().getFov() || 70;
        var defaultInteraction = this.getDefaultInteraction();
        if (!defaultInteraction) { //自定义的第一人称视角时可能就没有defaultInteraction了
            return;
        }
        var data = this.sceneManager.getNodeData(lookAtNode);
        var category = this.sceneManager.dataManager.getCategoryForData(data);
        var _minDistance = defaultInteraction.minDistance;
        var _maxDistance = defaultInteraction.maxDistance;
        var comNode = lookAtNode.getClient('complexNode');
        if (comNode == 'unload') {
            comNode = this.sceneManager.loadComplexNode(data);
        }
        lookAtNode = comNode || lookAtNode;
        if (!lookAtNode || !lookAtNode.getBoundingBoxWithChildren) { // 是billboard
            return null;
        }
        var bb = lookAtNode.getBoundingBoxWithChildren();
        var minDistance = this.getMinDistanceByNode(lookAtNode);
        if (!category) { //有可能是link
            defaultInteraction.minDistance = minDistance || 200;
            defaultInteraction.maxDistance = 10000;
            return;
        }
        var cId = category.getId().toLowerCase();
        var currentScene = this.sceneManager.getCurrentScene();
        if (cId.indexOf('datacenter') >= 0) {
            var maxDistance = 1500;
            var maxSize = 0
            if (bb && bb.size().x) {
                maxSize = bb.size().x;
                if (bb.size().z > maxSize) {
                    maxSize = bb.size().z;
                }
            }
            if (maxSize > 0) {
                maxDistance = maxSize * Math.atan(Math.PI * (90 - fov / 2) / 360);
            }
            _minDistance = 300;
            _maxDistance = maxDistance; //2000
        } else if (cId.indexOf('building') >= 0) { //这里要注意一下，有可能building的floors是整合到了dc中
            if (currentScene && currentScene.getCategoryId().toLowerCase().indexOf('building') >= 0) {
                _minDistance = 100;
                _maxDistance = 10000;
            } else {
                var rootNode = this.sceneManager.getCurrentRootNode();
                if (rootNode) {
                    var comNode = rootNode.getClient('complexNode');
                    if (comNode == 'unload') {
                        comNode = this.sceneManager.loadComplexNode(this.sceneManager.getNodeData(rootNode));
                    }
                    rootNode = comNode || rootNode;
                }
                var bb = rootNode ? rootNode.getBoundingBox() : null;
                var maxDistance = 2000;
                if (bb) {
                    var maxLength = bb.size().x;
                    if (bb.size().y > maxLength) {
                        maxLength = bb.size().y;
                    }
                    if (maxLength) {
                        maxDistance = maxLength * Math.atan(Math.PI * (90 - fov / 2) / 180);
                    }
                }
                if (maxDistance == -Infinity) {
                    maxDistance = 2000;
                }
                _minDistance = 200;
                _maxDistance = maxDistance; //2000
            }
        } else if (cId.indexOf('floor') >= 0 || cId.indexOf('channel') >= 0 || cId.indexOf('area') >= 0 || cId.indexOf('room') >= 0) {
            _minDistance = 100;
            _maxDistance = 10000;
            if (bb && bb.size()) { // 有可能floor超级大
                var maxSize = 0;
                if (bb.size().x > maxSize) {
                    maxSize = bb.size().x;
                }
                if (bb.size().z > maxSize) {
                    maxSize = bb.size().z;
                }
                if (bb.size().y > maxSize) {
                    maxSize = bb.size().y;
                }
                if (maxSize > 10000) {
                    _maxDistance = maxSize;
                }
            }
        } else if (cId.indexOf('rack') >= 0 || cId.indexOf('equipment') >= 0 || cId.indexOf('card') >= 0) {
            minDistance = this.calcCameraMinDistance(lookAtNode, minDistance);
            _minDistance = minDistance || 50;
            _maxDistance = 500; //1000太大 ，update by Kevin 2017-05-26
        } else {
            _minDistance = minDistance || 200;
            _maxDistance = 10000;
        }
        if (currentScene && category && currentScene.defaultInteractionParameters && currentScene.getCategoryId() == category.getId()) {
            var defParams = currentScene.defaultInteractionParameters;
            if (parseInt(defParams.maxDistance)) {
                _maxDistance = parseInt(defParams.maxDistance);
            }
            if (parseInt(defParams.minDistance)) {
                _minDistance = parseInt(defParams.minDistance);
            }
        }
        return { maxDistance: _maxDistance, minDistance: _minDistance };
    },

    calcCameraMinDistance: function (node, minDistance) {
        var bb = node.getBoundingBox();
        if (!bb && !bb.size()) {
            return;
        }
        var x = bb.size().x;
        var y = bb.size().y;
        var z = bb.size().z;
        var arr = [];
        arr.push(parseInt(Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2))));
        arr.push(parseInt(Math.sqrt(Math.pow(y, 2) + Math.pow(z, 2))));
        arr.push(parseInt(Math.sqrt(Math.pow(x, 2) + Math.pow(z, 2))));
        var near = this.network.getCamera().near;
        arr.push(near);
        arr = arr.sort(function (pre, next) {
            return pre - next
        });
        var max = arr[arr.length - 1];
        if (minDistance < max) {
            minDistance = max + near * 0.2;
        }
        return minDistance;
    },

    /**
     * 为了防止camera在play一开始时镜头突然乱跳的问题，将resetCameraDistance拆成setCameraDistanceForBeforePlayCamere和setCameraDistanceForAfterPlayCamere
     * setCameraDistanceForBeforePlayCamere：在play lookAt动画之前
     * 这时：当maxDistance变大了才改变camera的maxDistance，当minDistance变小才改变camera的minDistance
     */
    setCameraDistanceForBeforePlayCamere: function (node) {
        if (!this.cameraDistanceRestrict || !node) {
            return;
        }
        var defaultInteraction = this.getDefaultInteraction();
        if (!defaultInteraction) {
            return;
        }
        var distanceObj = this.getCameraDistanceByNode(node);
        if (!distanceObj) {
            return;
        }
        var orgMaxDistance = defaultInteraction.maxDistance;
        var orgMinDistance = defaultInteraction.minDistance;
        var minDistance = distanceObj.minDistance;
        var maxDistance = distanceObj.maxDistance;
        if (maxDistance && maxDistance > orgMaxDistance) {
            defaultInteraction.maxDistance = maxDistance;
        }
        if (minDistance && minDistance < orgMinDistance) {
            defaultInteraction.minDistance = minDistance;
        }
        // */ 
        // defaultInteraction.minDistance = 1;
        // defaultInteraction.maxDistance = 20000;
    },

    /**
     * setCameraDistanceForAfterPlayCamere lookAt的动画完成之后
     * 这时：当maxDistance变小了才改变camera的maxDistance，当minDistance变大了才改变camera的minDistance
     */
    setCameraDistanceForAfterPlayCamere: function (node) {
        if (!this.cameraDistanceRestrict || !node) {
            return;
        }
        var defaultInteraction = this.getDefaultInteraction();
        if (!defaultInteraction) {
            return;
        }
        var distanceObj = this.getCameraDistanceByNode(node);
        if (!distanceObj) {
            return;
        }

        var orgMaxDistance = defaultInteraction.maxDistance;
        var orgMinDistance = defaultInteraction.minDistance;
        var minDistance = distanceObj.minDistance;
        var maxDistance = distanceObj.maxDistance;
        // if (maxDistance && maxDistance < orgMaxDistance) {
        //    defaultInteraction.maxDistance = maxDistance;
        // }
        // if (minDistance && minDistance > orgMinDistance) {
        //    defaultInteraction.minDistance = minDistance;
        // } 
        if (maxDistance) {
            defaultInteraction.maxDistance = maxDistance;
        }
        if (minDistance) {
            defaultInteraction.minDistance = minDistance;
        }
    },

    /**
     * 这些应该放到数据库中，让用户自己来决定到底是多少，有的DC大，有的DC小
     * @param lookAtNode
     */
    resetCameraDistance: function (lookAtNode) {
        if (!this.cameraDistanceRestrict || !lookAtNode) {
            return;
        }
        var fov = this.network.getCamera().getFov() || 70;
        var defaultInteraction = this.getDefaultInteraction();
        if (!defaultInteraction) {
            return;
        }
        var data = this.sceneManager.getNodeData(lookAtNode);
        var category = this.sceneManager.dataManager.getCategoryForData(data);
        var comNode = lookAtNode.getClient('complexNode');
        if (comNode == 'unload') {
            comNode = this.sceneManager.loadComplexNode(data);
        }
        lookAtNode = comNode || lookAtNode;
        // var bb = lookAtNode.getBoundingBox();
        var bb = lookAtNode.getBoundingBoxWithChildren();
        //minDistance 应该根据自身的boundingBox计算所得
        var minDistance = this.getMinDistanceByNode(lookAtNode);
        if (!category) { //有可能是link
            defaultInteraction.minDistance = minDistance || 200;
            defaultInteraction.maxDistance = 10000;
            return;
        }
        var cId = category.getId().toLowerCase();
        var currentScene = this.sceneManager.getCurrentScene();
        if (cId.indexOf('datacenter') >= 0) {
            var maxDistance = 1500;
            var maxSize = 0
            if (bb && bb.size().x) {
                maxSize = bb.size().x;
                if (bb.size().z > maxSize) {
                    maxSize = bb.size().z;
                }
            }
            if (maxSize > 0) {
                maxDistance = maxSize * Math.atan(Math.PI * (90 - fov / 2) / 360);
            }
            defaultInteraction.minDistance = 300;
            defaultInteraction.maxDistance = maxDistance; //2000
        } else if (cId.indexOf('building') >= 0) { //这里要注意一下，有可能building的floors是整合到了dc中
            if (currentScene &&
                currentScene.getCategoryId().toLowerCase().indexOf('building') >= 0) {
                defaultInteraction.minDistance = 100;
                defaultInteraction.maxDistance = 10000;
            } else {
                var rootNode = this.sceneManager.getCurrentRootNode();
                if (rootNode) {
                    var comNode = rootNode.getClient('complexNode');
                    if (comNode == 'unload') {
                        comNode = this.sceneManager.loadComplexNode(this.sceneManager.getNodeData(rootNode));
                    }
                    rootNode = comNode || rootNode;
                }
                var bb = rootNode ? rootNode.getBoundingBox() : null;
                var maxDistance = 2000;
                if (bb) {
                    var maxLength = bb.size().x;
                    if (bb.size().y > maxLength) {
                        maxLength = bb.size().y;
                    }
                    if (maxLength) {
                        maxDistance = maxLength * Math.atan(Math.PI * (90 - fov / 2) / 180);
                    }
                }
                if (maxDistance == -Infinity) {
                    maxDistance = 2000;
                }
                defaultInteraction.minDistance = 200;
                defaultInteraction.maxDistance = maxDistance; //2000
            }
        } else if (cId.indexOf('floor') >= 0 ||
            cId.indexOf('channel') >= 0 ||
            cId.indexOf('area') >= 0 ||
            cId.indexOf('room') >= 0) {
            defaultInteraction.minDistance = 100;
            defaultInteraction.maxDistance = 10000;
            if (bb && bb.size()) { // 有可能floor超级大
                var maxSize = 0;
                if (bb.size().x > maxSize) {
                    maxSize = bb.size().x;
                }
                if (bb.size().z > maxSize) {
                    maxSize = bb.size().z;
                }
                if (bb.size().y > maxSize) {
                    maxSize = bb.size().y;
                }
                if (maxSize > 10000) {
                    defaultInteraction.maxDistance = maxSize;
                }
            }
        } else if (cId.indexOf('rack') >= 0 || cId.indexOf('equipment') >= 0 || cId.indexOf('card') >= 0) {
            defaultInteraction.minDistance = minDistance || 50;
            defaultInteraction.maxDistance = 1000;
        } else {
            defaultInteraction.minDistance = minDistance || 200;
            defaultInteraction.maxDistance = 10000;
        }
        if (currentScene && category &&
            currentScene.defaultInteractionParameters &&
            currentScene.getCategoryId() == category.getId()) {
            var defParams = currentScene.defaultInteractionParameters;
            if (parseInt(defParams.maxDistance)) {
                defaultInteraction.maxDistance = parseInt(defParams.maxDistance);
            }
            if (parseInt(defParams.minDistance)) {
                defaultInteraction.minDistance = parseInt(defParams.minDistance);
            }
        }
    },

    /**
     * 动态的设置minDistance和maxDistance
     */
    setCameraDistance: function (minDistance, maxDistance) {
        var defaultInteraction = this.getDefaultInteraction();
        if (!defaultInteraction) {
            return;
        }
        if (minDistance != null && minDistance != undefined && parseInt(minDistance)) {
            defaultInteraction.minDistance = parseInt(minDistance);
        }
        if (maxDistance != null && maxDistance != undefined && parseInt(maxDistance)) {
            defaultInteraction.maxDistance = parseInt(maxDistance);
        }
    },

    setSelectedStype: function (nodes, selectColor) {
        if (!nodes) {
            return;
        } else if (nodes instanceof Array && nodes.length < 1) {
            return;
        }
        this.defaultInteractions = this.network.getInteractions();
        var interaction = new mono.DefaultInteraction(this.network);
        interaction.maxDistance = 3000;
        interaction.minDistance = 800;
        this.network.setInteractions([interaction]);
        var selectColor = selectColor || '#0431B4';
        var smodel = this.network.getDataBox().getSelectionModel();
        if (nodes instanceof Array) {
            for (var i = 0; i < nodes.length; i++) {
                var node = nodes[i];
                node.s({
                    'm.type': 'phong',
                    'select.style': 'outline.glow',
                    'select.color': selectColor
                });
                smodel.appendSelection(node);
            }
        } else {
            nodes.s({
                'm.type': 'phong',
                'select.style': 'outline.glow',
                'select.color': selectColor
            });
            smodel.appendSelection(nodes);
        }

    },

    //    clearSelectedStyle :function(){
    //        if(this.defaultInteractions){
    //
    //        }
    //    },

    addCameraDistanceRestrict: function () {
        this.cameraDistanceRestrict = true;
    },

    removeCameraDistanceRestrict: function () {
        delete this.cameraDistanceRestrict;
    },

    lookAt: function (node) {
        if (this.defaultEventHandler && this.defaultEventHandler.lookAt) {
            this.defaultEventHandler.lookAt(node);
        }
    },

    setDefaultCamera: function () {
        var camera = this.network.getCamera();
        camera.setNear(50);
        camera.fov = 70;
    },

    /**
     * 判断data或node是不是可见，因为该SDK中是否可见不仅仅是通过node自身的isVisible来控制，很多都是通过visibleFilter来控制
     * @param dataOrNode
     * @returns {*}
     */
    /*
    isVisible : function(dataOrNode){
        if(!dataOrNode){
            return false;
        }
        var data = null;
        if(dataOrNode instanceof it.Data){
            data = dataOrNode;
        }else if(dataOrNode instanceof mono.Element){
            data = this.sceneManager.getNodeData(dataOrNode);
        }else if(typeof(dataOrNode) == 'string'){
            data = this.sceneManager.dataManager.getDataById(dataOrNode);
        }
        if(!data){
            return false;
        }
        var node = this.sceneManager.getNodeByDataOrId(data);
        if(!node){
            return false;
        }
        if(!this._visibleFilters ||  this._visibleFilters.length < 1){
            return node.isVisible();
        }
        for(var i = 0 ; i < this._visibleFilters.length ; i++){
            var vf = this._visibleFilters[i];
            if(vf && !vf.isVisible(node,data,this.network)){
                return false;
            }
        }
        return true;
    },
    */

    isVisible: function (dataOrNode) {
        if (!dataOrNode) {
            return false;
        }
        var data = null;
        var node = dataOrNode;
        if (dataOrNode instanceof it.Data) {
            data = dataOrNode;
            node = null;
        } else if (node instanceof mono.Billboard && node.getClient('_alarmBillboard')) { //告警的billboard也要处理的
            data = node.getClient('_alarmBillboard');
        } else if (dataOrNode instanceof mono.Element) {
            data = this.sceneManager.getNodeData(dataOrNode);
        } else if (typeof (dataOrNode) == 'string') {
            data = this.sceneManager.dataManager.getDataById(dataOrNode);
            node = null;
        }
        if (!data && !node.getClient('itv_data')) {
            return node.isVisible();
        }
        if (!node) {
            node = this.sceneManager.getNodeByDataOrId(data);
        }
        if (!node) {
            return false;
        }
        if (!node.isVisible()) {
            return false;
        }
        if (this.visibleMap[node.getId()] == true) {
            return true;
        } else if (this.visibleMap[node.getId()] == false) {
            return false;
        } else {
            if (node instanceof TGL.Link || node instanceof TGL.PathLink) {
                if (!this.isVisible.call(this, node._fromNode)) {
                    this.visibleMap[node.getId()] = false;
                    return false;
                }
                if (!this.isVisible.call(this, node._toNode)) {
                    this.visibleMap[node.getId()] = false;
                    return false;
                }
            }
            var vf = this._visibleFilters;
            for (var i = 0; i < vf.length; i++) {
                var filter = vf[i];
                if (!filter.isVisible(node, data, this.network)) { //注意，只处理不可见对象,可见的才会继续找下一个filter
                    this.visibleMap[node.getId()] = false;
                    return false;
                }
            }
        }
        this.visibleMap[node.getId()] = true;
        return true;
    },

    /**
     * 判断该node是不是虚化的，是不是判断在defaultVirtual中是不是虚幻的
     * @param dataOrNode
     */
    isVirtual: function (dataOrNode) {
        // return this.defaultMaterialFilter.isVirtual(dataOrNode);
        for (var i = 0; i < this._materialFilters.length; i++) {
            var vm = this._materialFilters[i];
            if (vm && vm.isVirtual && vm.isVirtual(dataOrNode)) {
                return false;
            }
        }
        return true;
    }



});

it.ViewManager = $ViewManager;

var $ViewManager2D = function(sceneManager,network){
    mono.PropertyChangeDispatcher.call(this);
    this.sceneManager = sceneManager;
    this.map = null;
    this.network = network;
    if(!network){
      if(window.BMap){
        this.network = new twaver.canvas.Network();
        this.network.setRectSelectEnabled(false);
      }else{
        this.network = new twaver.vector.Network();
      }
    }
    this.container = document.createElement('div');
    this.container.style.position = 'absolute';
    this.mapView = null;
    this._visibleFilters = [];
    this._selectableFilters = [];
    this._eventHandlers = [];
    var self =  this;
    this.dbClickHandle = function (event) {
        if(event){
            var element = self.network.getElementAt(event);
            if(element){
                self.handleDoubleClick({element:element});
            }else{
                self.handleDoubleClickBackground();
            }
        }
    };
    //无效，需先将view加到document中方可
    this.network.adjustBounds({ x: 0, y: 0, width:1,height:1});
    this.left = 1;
    this.top = 0;
    this.width = document.documentElement.clientWidth;
    this.height = document.documentElement.clientHeight;
    this.adapter = null;
    this.isCreateMap = false;
//    this.createMap();
    this.focusData = null;
    this.isGis = null;
    var box = this.network.getElementBox();
    this.tree = new twaver.controls.Tree(box);
    this.table = new twaver.controls.Table(box);
    this.tableRule = {}; //table的规则，先注册一个,注册格式为{ID：[{column1},{column2},...]}，id是category或datatype,但是type优先
    this.treeRule = {}; // tree的规则，先注册，格式：{id:{}};
//    this.centerSplit,this.mainSplit;
    this.addTableAndTree();
};

mono.extend($ViewManager2D,mono.PropertyChangeDispatcher,{

    /**
     * @param container,父div，gis将放在该div上，并且这个container在初始化前就应该存在
     */
    createMap : function(){
        this.registerNormalImage('./images/building1.png','b1');
        this.registerNormalImage('./images/building2.png','b2');
        this.registerNormalImage('./images/building3.png','b3');
        if(window.BMap){
            var mainView;
          if(!document.getElementById("mainView")){
            mainView = document.createElement('div');
            mainView.id = "mainView";
            mainView.style.height = "100%";
            document.body.appendChild(mainView);
          }else{
            mainView = document.getElementById("mainView");
          }
          
          mainView.appendChild(this.container);
          this.container.style.height = "100%";
          this.container.style.width = "100%";
          this.mapView = document.createElement('div');
          this.mapView.id = "MapView";
          this.mapView.style.height = "100%";
          this.container.appendChild(this.mapView);

          this.map = new BMap.Map("MapView");
          var map = this.map;
          var point = new BMap.Point(108.95, 34.27);
          map.centerAndZoom(point, 7);
          map.addControl(new BMap.NavigationControl());
          map.enableScrollWheelZoom();
          var networkDom = this.network.getView();
          document.getElementsByClassName("BMap_mask")[0].appendChild(networkDom);
          this.network.adjustBounds({x:0,y:0,width:document.documentElement.clientWidth,height:document.documentElement.clientHeight});


          var network = this.network;
          var self = this;
          network.addInteractionListener(function(event) {
              if(event.kind = "liveMoveBetween") {
                  map.disableDragging();
                  var list = network.getSelectionModel().getSelection();
                  list.forEach(function(element) {
                      var pixel = new BMap.Pixel(element.getX(),element.getY());
                      var point = map.pixelToPoint(pixel)
                      // element.setClient("coordinate", point);
                  });

              }
          });
          network.getView().addEventListener("dbclick", function(event) {
              if(network.getElementAt(event)) {
                  map.disableDoubleClickZoom();
                  event.preventDefault();
              } else {
                  map.enableDoubleClickZoom();
              }
          });
          network.getView().addEventListener("mousedown", function(event) {
              if(!network.getElementAt(event)) {
                  map.enableDragging();
              } else {
                  map.disableDragging();
              }
          });
          network.getView().addEventListener("mousedown", function(event) {
              clickPoint = network.getLogicalPoint(event);
          });
          network.getView().addEventListener("mouseup", function(event) {
              clickPoint = null;
          });

          map.addEventListener("movestart", function(){
              networkDom.style.opacity = 0;
          });
          map.addEventListener("moveend", function(){
              networkDom.style.opacity = 1;
              self.changePostionWithMap();
          });
          map.addEventListener("dragstart", function(){
              networkDom.style.opacity = 0;
              self.changePostionWithMap();
          });
          map.addEventListener("dragend", function(){
              networkDom.style.opacity = 1;
              self.changePostionWithMap();
          });
          map.addEventListener("zoomstart", function(){
              networkDom.style.opacity = 0;
              self.changePostionWithMap();
          });
          map.addEventListener("zoomend", function(){
              networkDom.style.opacity = 1;
              self.changePostionWithMap();
          });
          this.isCreateMap = true;
        }else{
            this.mapView = document.createElement('div');
    //        GisManager.registerDefaultSetting(TWaverGisConst.MAPDRIVER_MAPABC,"http://emap3.mapabc.com/mapabc/maptile?");
            var map = this.map = new twaver.gis.Map(this.mapView,"MapView");
            map.setSize({width:document.documentElement.clientWidth,height:document.documentElement.clientHeight});
            map.setEnableDoubleZoom(false); //设置不能够双击缩放地图
            map.addLayer("BINGMAP",GISConsts.EXECUTOR_TYPE_BINGMAP);//以MapABC作为地图，注意（这里访问的是MapABC的在线地图）
            //如果有地图服务器，并且把地图发布为tile图片，可以把图片放在tomcat之类的服务器中发布起来，然后直接访问
            //map.addLayer("google",GISConsts.EXECUTOR_TYPE_MAPABC,"http://localhost:8080/localecache");
            map.setZoomLevel(5);//设置地图的缩放级别
            map.setCenter(new twaver.gis.geometry.GeoCoordinate(31.41,121.48));//设置地图的中心位置
            this.adapter = new twaver.gis.Adapter();//创建一个适配器对象，用来绑定地图和拓扑
            
            this.isCreateMap = true;
        }
        
    },

    changePostionWithMap:function() {
      if(window.BMap){
        var self = this;
        this.network.getElementBox().forEach(function(element) {
            if(element instanceof twaver.Node) {
                var point = element.getClient("coordinate");
                var pixel = self.map.pointToPixel(point);
                element.setCenterLocation(pixel.x,pixel.y);

            }
        });
      }
    },

    clearContainer : function(){
        var children = this.container.childNodes;
        if(children && children.length > 0){
            for(var i = 0 ; i < children.length ; i++){
                this.container.removeChild(children[i]);
            }
        }
    },

    bindGIS : function(){
        if(this.isGis != null && this.isGis){
            return;
        }
        if(!this.isCreateMap){
            this.createMap();
        }
        if(this.adapter && this.map){
            this.adapter.bindNetworkAndMap(this.network,this.map);
        }
        this.clearContainer();
        this.container.appendChild(this.mapView);
        this.network.getView().removeEventListener("dblclick",this.dbClickHandle);
        if(window.BMap){
            this.map.addEventListener("dblclick",this.dbClickHandle);
        }else{
            this.map.getView().addEventListener("dblclick",this.dbClickHandle);
        }
//        if(!isAdjustBound){ // 如果一开始没有GIS时,那创建好gis后需要在adjust一下，否则node在gis和network上都不显示
//            this.adjustViewBounds(parseInt(this.width)+1);
//        }
        this.adjustViewBounds();
        this.isGis = true;
    },

    unbindGIS : function(){
        if(this.isGis != null && !this.isGis){
            return;
        }
        if(this.adapter){
            this.adapter.unbindNetworkAndMap();
        }
        this.clearContainer();
//        if(this.mainSplit){
//            this.container.appendChild(this.mainSplit.getView());
//        }else{
            this.container.appendChild(this.network.getView());
//        }
//        this.network.adjustBounds({ x: this.left, y: this.top, width: this.width, height: this.height});
        //unbindGis时也的adjust一下，有可能之前都没有2D的场景（之前是一开始和有Gis时才会adjust）,
        // 可是一开始时view并没有append到浏览器中时调用反而导致后来不显示,
        // 可以通过判断container的parentNode是否为空来确定是不是加到了body中,只有加到Body中才可以adjust. 其实这里只要调用一次即可
        if(this.container.parentNode){
            this.adjustViewBounds();
        }
        if(this.map){
            if(window.BMap){
                this.map.removeEventListener("dblclick",this.dbClickHandle);
            }else{
                this.map.getView().removeEventListener("dblclick",this.dbClickHandle);
            }
        }
        this.network.getView().addEventListener("dblclick",this.dbClickHandle);
        this.isGis = false;
    },

    getContainer : function(){
        return this.container;
    },

    removeGis : function(){
            this.unbindGIS();
            this.hideNavigator();
            this.hideOverView();
    },

    addGis : function(showNav,showOverView){
        this.bindGIS();
        if(showNav){
            this.showNavigator();
        }
        if(showOverView){
            this.showOverView();
        }
    },

    /**
     * 2D的network需要先加到body中，然后在adjustBounds，否则无效并且显示不出来
     * 这里既要处理network的bounds，还要处理map的bounds
     * 注意，每次从3D切换回来时都需要重新ajdust一把，并且要使得四个参数中至少有一个参数不一样，如果都一样twaver内部是会直接返回的
     */
    adjustViewBounds : function(width,height,left,top){
        if(arguments.length < 1){
            if(!this.flag){
                this.flag = 1;
            }else{
                this.flag++
            }
            this.width = this.width + Math.pow(-1,parseInt(this.flag));
        }else{
            this.flag = 0;
        }
        this.left = left || this.left;
        this.top = top || this.top;
        this.width = width || this.width;
        this.height = height || this.height;
//        if(this.container.contains(this.network.getView())){ //不管是不是包含，都得adjust，否则node不会显示出来
            this.network.adjustBounds({ x: this.left, y: this.top, width: this.width, height: this.height});
//        }
        if(this.isCreateMap && this.map){
          if(window.BMap){

          }else{
            this.map.setSize({width:this.width,height:this.height});
            this.map.content.style.left = this.left + 'px';
            this.map.content.style.top = this.top + 'px';
          }
        }
//        this._createNetwork2D = true;
    },

    setZoomLevel : function(zoomLevel){
      if(zoomLevel && this.isCreateMap && this.map){
        if(window.BMap){

        }else{
          this.map.setZoomLevel(5);
        }
      }
    },

    setCenter : function(center){
        if(this.isCreateMap && this.map && center && center.x && center.y){
          if(window.BMap){
            var point = new BMap.Point(center.y, center.x);
            this.map.centerAndZoom(point, 7);
          }else{
            this.map.setCenter(new twaver.gis.geometry.GeoCoordinate(center.x,center.y));
          }
        }
    },

    showNavigator :function(x,y){
        if(!this.isCreateMap) {
            return;
        }
        if(window.BMap){
          return;
        }
        var nav = document.getElementById('navigator_id');
        if(nav){
            nav.style.display = 'block';
        }else{
            var navigator = new twaver.gis.gadget.Navigator("navigator_id",this.map);
            if(!x){
                x = 20;
            }
            if(!y){
                y = 50;
            }
            this.map.installGadget(navigator,{x:x,y:y});
        }
    },

    hideNavigator : function(){
        if(!this.isCreateMap) {
            return;
        }
        var nav = document.getElementById('navigator_id');
//        if(nav && nav.parentElement){
//            nav.parentElement.removeChild(nav);
//        }
        if(nav){
            nav.style.display = 'none';
        }
    },

    showOverView : function(right,bottom,width,height){
        if(!this.isCreateMap) {
            return ;
        }
        if(window.BMap){
          return;
        }
        if(this.overview && this.overview.getView()){
            this.overview.getView().style.display = 'block';
        }else{
            var overview = this.overview = new twaver.gis.gadget.Overview("overview_id",this.map);
            if(width == null || width == undefined || width < 0){
                width = 150;
            }
            if(height == null || height == undefined || height <0){
                height = 150;
            }
            overview.setSize({width:width,height:height});
            overview.map.addLayer("BINGMAP",GISConsts.EXECUTOR_TYPE_BINGMAP);
            overview.setBorder("1px solid red");
            if(right){
                right = right-width+5;
            }else{
                right = width+5;
            }
            if(bottom){
                bottom = bottom - height+5;
            }else{
                bottom = height+5;
            }
            this.map.installGadget(overview,{right:right,bottom:bottom});
        }
    },

    hideOverView : function(){
        if(this.overview && this.overview.getView()){
            this.overview.getView().style.display = 'none';
        }
    },

    registerNormalImage : function (url, name) {
        var self = this;
        var image = new Image();
        image.src = url;
        image.onload = function () {
            twaver.Util.registerImage(name, image, image.width/2, image.height/2);
            image.onload = null;
            self.network.invalidateElementUIs();
        };
    },

    setPosition : function(node,x,y){
        if(!node) return;
        if(this.container.contains(this.mapView)){
            if(window.BMap){
                var point = new BMap.Point(y, x);
                node.setClient("coordinate",point);
                var location = this.map.pointToPixel(point)
                node.setCenterLocation(location.x,location.y);
            }else{
                var geo = new twaver.gis.geometry.GeoCoordinate(parseInt(x)||0,parseInt(y)||0);
                node.setClient(GISSettings.GEOCOORDINATE, geo);
            }
            this.setDefaultImage(node); // test
        }else{
            node.setLocation(parseInt(x)||0,parseInt(y)||0);
        }
    },

    setDefaultImage : function(node,index){
        if(!node) return;
        if(index == 1){
            node.setImage('b1');
        }else if(index == 2){
            node.setImage('b2');
        }else if (index == 3){
            node.setImage('b3');
        }else{
            var i = parseInt(Math.random()*3+1);
            node.setImage('b'+i);
        }
    },

    /**
     * 2D的规则和3D的是一样的
     * @param node
     * @returns {*}
     */
    getDataByNode : function(node){
        if(!node){
            return null;
        }
        return this.sceneManager.getNodeData(node);
    },

    handleDoubleClick : function (element) {
        var node = element.element;
        var i = 0,eventHandler;
        for(; i < this._eventHandlers.length;i ++){
            eventHandler = this._eventHandlers[i];
            var data = this.getDataByNode(node);
            if(eventHandler.shouldHandleDoubleClickElement(node,this.network,data,element)){
                eventHandler.handleDoubleClickElement(node,this.network,data,element);
                this.focusData = data;
                return;
            }
        }
    },

    handleDoubleClickBackground : function(){
        if(this.focusData && this.focusData.getParentId()){
           var parentNode = this.sceneManager.dataNodeMap[this.focusData.getParentId()];
           if(parentNode){
              this.sceneManager.viewManager3d.setFocusNode(parentNode);
           }
        }
        var i = 0,eventHandler;
        for(; i < this._eventHandlers.length;i ++){
            eventHandler = this._eventHandlers[i];
            if(eventHandler.shouldHandleDoubleClickBackground(this.network)){
                eventHandler.handleDoubleClickBackground(this.network);
                return;
            }
        }
    },

    addEventHandler : function(eventHandler,index){
        if(eventHandler instanceof it.EventHandler){
            if(index === undefined){
                return this._eventHandlers.push(eventHandler);
            }else{
                return this._eventHandlers.splice(index,0,eventHandler);
            }
        }
    },

    removeEventHandler : function(eventHandler){
        var index = this._eventHandlers.indexOf(eventHandler);
        if(index !== -1){
            this._eventHandlers.splice(index,1);
        }
    },

    createColumn: function (table, name, propetyName, propertyType, valueType, width) {
        var column = new twaver.Column(name);
        column.setName(name);
        column.setPropertyName(propetyName);
        column.setPropertyType(propertyType); //accessor,client,Styles
        if (valueType) {
            column.setValueType(valueType);
        }
        if(width){
            column.setWidth(width);
        }else{
            column.setClient('pack',true);
        }
        column.renderHeader = function (div) {
            var span = document.createElement('span');
            span.style.whiteSpace = 'nowrap';
            span.style.verticalAlign = 'middle';
            span.style.padding = '1px 2px 1px 2px';
            span.innerHTML = column.getName() ? column.getName() : column.getPropertyName();
            span.setAttribute('title', span.innerHTML);
            span.style.font = 'bold 12px Helvetica';
//            div.style.backgroundColor = '#ffab00';// 'rgba(255,0,0,1)';
            div.style.textAlign = 'center';
            div.appendChild(span);
        };
        table.getColumnBox().add(column);
        return column;
    },

    addTableAndTree : function(){
        var view = this.network.getView();
        var tablePane = new twaver.controls.TablePane(this.table);
        var tableHeader = tablePane.getTableHeader().getView();
        tableHeader.style.backgroundColor = 'rgba(255,255,255,0.1)';
        var tableDom = tablePane.getView();
        tableDom.style.position = 'absolute';
        tableDom.style.bottom = '30px';
        tableDom.style.left = '400px';
        tableDom.style.width = "500px";
        tableDom.style.height = "120px";
        view.appendChild(tableDom);

        var treeView = this.tree.getView();
        treeView.style.position = 'absolute';
        treeView.style.top = '30px';
        treeView.style.left = '30px';
        treeView.style.width = "160px";
        treeView.style.height = "250px";
        view.appendChild(treeView);

        this.tree.getToggleImage = function (data) {
            if (data.getChildrenSize()>0) {
                return this.isExpanded(data) ?  '../images/collapse_icon.png':'../images/expand_icon.png';
            }
            return null;
        };

        this.tree.getIcon = function (data) { return null; };

    },

    /**
     * table的样式应该是根据scene来的，不同scene有不同的table
     * @param scene
     */
    initTable : function (scene) {
        this.table.setEditable(true);
        this.createColumn(this.table,'编号', 'toolTip', 'accessor', 'string').setWidth(80);
        var column = this.createColumn(this.table, '端口接入', 'toId', 'client', 'string', true);
        column.setWidth(150);
        this.createColumn(this.table, '当前流量', 'flow', 'client', 'string', true).setWidth(120);
        var timeColumn = this.createColumn(this.table, '启用日期', 'raisedTime', 'client','Date');
        timeColumn.setWidth(150);
        timeColumn.setHorizontalAlign('center');
        timeColumn.renderCell = function (params) {
            var span = document.createElement('span');
            span.innerHTML = it.Util.formatDate(params.value, 'yyyy-MM-dd hh:mm:ss');
            span.style.whiteSpace = 'nowrap';
            params.div.appendChild(span);
        }
    },

    refreshTable : function(){
        var view = this.network.getView();
        var tablePane = new twaver.controls.TablePane(this.table);
        var tableHeader = tablePane.getTableHeader().getView();
//        tableHeader.style.backgroundColor = 'rgba(255,255,255,0.1)';
        var tableDom = tablePane.getView();
        tableDom.style.position = 'absolute';
        tableDom.style.bottom = '30px';
        tableDom.style.left = '400px';
        tableDom.style.width = "500px";
        tableDom.style.height = "120px";
        view.appendChild(tableDom);
    },

    showTable : function(scene){
        this.table.getColumnBox().clear();
//        if(this.sceneManager._currentScene.getTwod()){
            this.table.getView().style.display = 'block';
            this.table.setVisibleFunction(function(node){
                if(node.getName()){
                    return false;
                }
                if(!node.getName() && !node.getToolTip()){
                    return false;
                }
                if(node.getClient('group_id')){
                    return false;
                }
                return true;
            });
            this.initTable(scene);
            this.refreshTable();
//        }else{
//            this.table.getView().style.display = 'none';
//        }
    },

    showTree : function(scene){
//        if(this.sceneManager._currentScene.getTwod()){
            this.tree.getView().style.display = 'block';
            this.tree.setLineType('dotted');//线条类型 solid
            this.tree.setLineColor('#000000');//线条颜色 #ffab00
            this.tree.setLineAlpha(1);//线条透明度
            this.tree.setLineThickness(0.5);//线条厚度
            this.tree.setLineDash([1,1]);
            this.tree.setVisibleFunction(function(node){
                if(!node.getName() && !node.getToolTip()){
                    return false;
                }
                return true;
            });
            this.tree.getLabel = function(data){
                return data.getToolTip() || data.getName();
            };
            this.tree.expandAll();
//        }else{
//            this.tree.getView().style.display = 'none';
//        }
    },

});

it.ViewManager2D =$ViewManager2D;


// 场景加载的管理，把dataManager里面的数据加载成为3D对象呈现在viewManager里面的Network里面。
// 用户可以重载这个类，实现自己的逻辑;
// 默认是基于Scene.js数据的实现;

it.SceneManager = function (dataManager) {
    $Util.checkNotNull(dataManager, "dataManager");
    $EventHandler.call(this);
    this.dataManager = dataManager;
    this.initViewManager();
    this.network3d = this.viewManager3d.network;
    this.network2d = this.viewManager2d && this.viewManager2d.network;
    this.prefabMap = {}; // 预制管理，可以提供加载速度
    this.dataNodeMap = {};
    this.dataNode2DMap = {}; // 不放到dataNodeMap中，2D的单独分开，其实也可以合并，但是得加个标记，并且程序内有些地方的改进
    this.linkMap = {};
    this.categoryNodeMap = {};
    this.assetTypeNodeMap = {};
    this.locationManager = new it.LocationManager(this); // TODO
    // 用于监听进入场景等的监听。
    this._sceneManagerChangeDispatcher = new mono.EventDispatcher();
    this._sceneChangeDispather = new mono.EventDispatcher();
    this._sceneVirtualChangeDispather = new mono.EventDispatcher();//场景，记得是当前场景虚化派发，注意效率，由于是批量处理，最好是一批量弄好后派发一个
    this._sceneVisibleChangeDispather = new mono.EventDispatcher();
    this._scenes = [];
    this._sceneMap = []; 
    this._sceneNodeMap = {}; //用来存储当前场景的所有对象
    this._sceneNodes = [];
    this.cameraManager = new $CameraManager(this);
    this.viewManager3d.initDefault();
    this._linkTemplateMap = {};
    var AlarmManagerClass = this.getAlarmManagerClass();
    this._alarmManager = new AlarmManagerClass(this.dataManager, this);
    this.doubleClickBackgroundGotoUpLevelScene = false;
    this.linkControlsFunction = function(link,fromNode,toNode){
        var bb1 = fromNode.getBoundingBox(),bb2 = toNode.getBoundingBox();
        var maxZ = 20, maxY = Math.max(bb1.max.y,bb2.max.y) ;
        var pos1 = fromNode.frontWorldPosition(bb1.max.z + maxZ),pos2 = toNode.frontWorldPosition(bb2.max.z + maxZ);
        var controls = [];
        controls.push(pos1);
        controls.push(pos1.clone().add(new mono.Vec3(0,maxY,0)));
        controls.push(pos2.clone().add(new mono.Vec3(0,maxY,0)));
        controls.push(pos2);
        return controls;
    };
    this.gcsManager = new it.GCSManager({sceneManager:this});
    this.postManager = new $PortManager(this);
    this.beforeLoadSceneFunction = null;
    this.afterLoadSceneFunction = null;
    this.isBindingBuildingAndFloor = true; //是否将floor绑定到building上，默认是绑定上去
    this.sceneChangeWithOutAnimate = false;
    this.resetCameraWhenSceneChange = true; 
    
    this.lightManager = new $LightManager(this);
    // this.cameraManager = new $CameraManager(this);
    this.adapterManager = new $PropertyChangeAdaperManager(this);
    this.invisibleFilter = new it.VisibleManager(this);
    this.viewManager3d.addVisibleFilter(this.invisibleFilter);
    this.sceneViewMap = {};
    this._focusNode = null;
    this.isClearCache = false;

    var self = this;
    dataManager.addDataManagerChangeListener(function(event){
       if(self._loaded){
          var kind = event.kind;
          if(kind === 'add'){
             self.handleDataAdd(event);
          }else if(kind === 'remove'){
             self.handleDataRemove(event);
          }
       }
    });

    dataManager.addDataPropertyChangeListener(function(event){
        if(self._loaded){
           self.handleDataPropertyChange(event);
        }
    });

    this.removeAndAddAllChildrenWhenSetFocusFilter = null;

    this.addSceneChangeListener(function(eve){
        // self.setSceneNetworkAndLight(eve.data);
        self.setDefaultInteractionValue(eve.data);
    });

};
it.SceneManager.CLIENT_IT_DATA = 'it_data';
it.SceneManager.CLIENT_IT_DATA_ID = 'it_data_id';
//表示的是该node是扩展的，比如空间可视化时，会动态创建彩色的机柜，但这些机柜的id和data都是和真的一样，但是虚化和隐藏不一定真的机柜的影响，
//若想单独管理这些动态机柜的虚化和隐藏，可以给这些临时的node加上CLIENT_EXT
it.SceneManager.CLIENT_EXT_VITUAL = 'it_extend_virtual_node';
it.SceneManager.CLIENT_EXT_VISIBLE = 'it_extend_visible_node';

it.SceneManager.getNodeData =function(node){
    return node.getClient(it.SceneManager.CLIENT_IT_DATA);
},

it.SceneManager.getNodeDataId = function(node){
    if(!node){
        return null;
    }
    return node.getClient(it.SceneManager.CLIENT_IT_DATA_ID);
},

mono.extend(it.SceneManager,$EventHandler,{

	  getSceneView : function(sceneCategory){
          // if(show2D){
              //场景View，可能会同时包括3D和2D的network，目前只考虑3D
          var mainView ;
          if(!document.getElementById("mainView")){
              mainView = this.mainView = document.createElement('div');
              mainView.id = 'mainView';
          }else{
              mainView = this.mainView = document.getElementById("mainView");
              // mainView.appendChild(this.network3d.getRootView());
          }

          if (sceneCategory 
              && this.sceneViewMap[sceneCategory] 
              && this.sceneViewMap[sceneCategory].getContainer()) {
               mainView.appendChild(this.sceneViewMap[sceneCategory].getContainer());
               this.network3d.getRootView().style.display = 'none';
          }

          // var earthSceneView = this.sceneViewMap['earth'];
          // if (earthSceneView && earthSceneView.getContainer()) {
          //     mainView.appendChild(earthSceneView.getContainer());
          // }
          mainView.appendChild(this.network3d.getRootView());
          // this.network3d.getRootView().style.display = 'none';
          if (this.viewManager2d) {
             mainView.appendChild(this.viewManager2d.getContainer());
          };
          return mainView;
          // }else{
          //     return this.network3d.getRootView();
          // }
	  },

    /**
     * 2D的network需要先加到body中，然后在adjustBounds，否则无效并且显示不出来
     */
    adjust2DBounds : function(width,height,left,top){
        this.viewManager2d&&this.viewManager2d.adjustViewBounds(width,height,left,top);
    },

    adjust3DBounds : function(w, h, left, top) {
        if(!w){
            w = document.documentElement.clientWidth;
        }
        if(!h){
            h = document.documentElement.clientHeight;
        }
        left = left || 0;
        top = top || 0;
        this.network3d.adjustBounds(w - left, h - top);
        var self = this;
        if (window.addEventListener) {
            window.addEventListener('resize', function () {
                self.network3d.adjustBounds(w - left, h - top, top, left);
            }, true);
        } else if (window.attachEvent) {
            window.attachEvent('onresize', function () {
                self.network3d.adjustBounds(w - left, h - top, top, left);
            });
        } else {
            window.onresize = function () {
                self.network3d.adjustBounds(w - left, h - top, top, left);
            };
        }
    },

    /**
     * 当真-假对象切换时，是不是将孩子添加至Box中或重box中移除掉
     * @param node
     */
    removeAndAddAllChildrenWhenSetFocus : function(node){
        if(this.removeAndAddAllChildrenWhenSetFocusFilter){
            return this.removeAndAddAllChildrenWhenSetFocusFilter(node);
        }
        if(!node) return false;
        var data = this.getNodeData(node);
        if(data){
            var category = this.dataManager.getCategoryForData(data);
            if(category && category.getId() && category.getId().toLowerCase().indexOf('rack') >= 0 ){
                return true;
            }
        }
        return false;
    },

    isChild : function(parentNode,childNode){
        if(!parentNode || !childNode){
            return false;
        }
        var pdata = this.getNodeData(parentNode);
        if(!pdata) {
            return false;
        }
        var cdata = this.getNodeData(childNode);
        if(!cdata || !(cdata instanceof $Data)){
            return false;
        }
        if(cdata.getParentId() && cdata.getParentId() === pdata.getId()){
            return true;
        }
        return false;
    },

    adjustBounds : function(width,height,left,top){
        this.adjust2DBounds(width,height,left,top);
        this.adjust3DBounds(width,height,left,top);
    },

    getDataBox : function(){
      var sceneView = this.getCurrentSceneView();
      if (sceneView && sceneView.getNetwork3D()) {
        return sceneView.getNetwork3D().getDataBox();
      }
      return this.network3d.getDataBox();
    },

    getDataBox2d : function(){
        return this.network2d.getElementBox();
    },

    setDefaultInteractionSpeed : function(rotateSpeed,panSpeed,zoomSpeed){
        var defaultInteraction = this.network3d.getDefaultInteraction();
        if(!defaultInteraction){
          return;
        }
        defaultInteraction.setRotateSpeed(rotateSpeed);
        defaultInteraction.setPanSpeed(panSpeed);
        defaultInteraction.setZoomSpeed(zoomSpeed);
    },

    shouldHandleDoubleClickBackground : function(network){
        
        if(!this.doubleClickBackgroundGotoUpLevelScene){    // 拓展给外面用的属性，用于当符合某情况时是否场景时过滤
          return false;
        }
        if(!this.dataManager.getRootScene()){
          return false;
        }
        if(this._currentScene === this.dataManager.getRootScene()){
          return false;
        }
        if(network instanceof mono.Network3D){
            var focusNode = this.viewManager3d.getFocusNode();
            //有可能focusNode不在当前场景中，如显示连线时将其他楼层的设备也给加载出来了，然后在lookAt其他楼层的那个设备，此时回到上一级就有问题？？？
            if(focusNode){
                focusNode = this.getMainNode(focusNode);
                if(this._currentRootNode !== focusNode){
                    return false;
                }
            }
        }
        return true;
    },
 
    handleDoubleClickBackground : function(network){
        this.gotoUpLevelScene();
    },

    shouldHandleDoubleClickElement : function(element,network,data,clickedObj){
       var dm = this.dataManager;
       if(!dm.getRootScene()){
         return false;
       }
        if(element.doubliClick){
            return true;
        }
       if(!data){
         return false;
       }
       var scene = null;
       var lastSceneAndRootData = this.getSceneAndRootByData(data);
       if (lastSceneAndRootData) {
          scene = lastSceneAndRootData.scene;
       }
       if(scene && this._currentScene != scene){
         return true;
       }
       return false;
    },

    handleDoubleClickElement : function(element,network,data,clickedObj,callback){
        var dm = this.dataManager;
        var lastSceneAndRootData = this.getSceneAndRootByData(data);
        var scene = lastSceneAndRootData.scene;
        var rootData = lastSceneAndRootData.rootData||data;
        var dataNode = this.getNodeByDataOrId(rootData);
        var doubliClick = element.doubliClick || (dataNode?dataNode.doubliClick:null);
        if(doubliClick){
            return doubliClick(element,network,data,clickedObj,callback);
        }
        if(this._currentScene == scene){
            callback && callback();
            return;
        }
        this.toScene(scene,rootData,callback);
        if (rootData) {
            this.viewManager3d.setFocusNode(this.dataNodeMap[rootData.getId()]);
        }
    }, 

    /**
     * 
     * “彻底“的清除掉相关的缓存对象，释放内存
     * 
     */
    clearCache : function(scene,rootData){
        scene = scene || this._currentScene;
        rootData = rootData || this._currentRootData;
        // 清除dataNodeMap中的引用
        if (scene && rootData) {
          for (var id in this.dataNodeMap) {
             var dataNode = this.dataNodeMap[id];
             var nodeData = this.getNodeData(dataNode);
             var dataType = this.dataManager.getDataTypeForData(nodeData);
             if (dataType && dataType.getModel()) {
                var model = dataType.getModel().replace('twaver.idc.','').replace('twaver.meeting.',''); //这种方式还正好避开了dc中的模型，dc就不是不用删除的 2017-10-13
                if (make.Default._objObject[model]) {
                  delete make.Default._objObject[model];
                }
                if (make.Utils3D._objObject[model]) {
                   delete make.Utils3D._objObject[model];
                }
             }
             // var sceneAndRootData = this.getSceneAndRootByData(this.getNodeData(dataNode));
             // if (sceneAndRootData 
             //    && sceneAndRootData.scene == scene 
             //    && sceneAndRootData.rootData == rootData) {
             if (scene 
                 && scene.getCategoryId() != 'earth' // 对于地球，园区也要弄掉
                 && this.isSceneInstance(scene,rootData,nodeData)) {
                  continue;
             }else{
                delete this.dataNodeMap[id];
             }
          }
        }else{
           this.dataNodeMap = {};
        }
        for(var name in make.Default._objMap){
           make.Default._objMap[name] = [];
        }//加载obj的队列，总是不会释放

        this.prefabMap = {};
        //清除当前场景的nodeMap
        this._sceneNodes = [];
        this._sceneNodeMap = {};
        //清除categoryMap中的引用
        // for(var id in this.categoryNodeMap){
        //    delete this.categoryNodeMap[id];
        // }
        this.categoryNodeMap = {};
        //清除assetTypeNodeMap中的引用
        // for(var id in this.assetTypeNodeMap){
        //   delete this.assetTypeNodeMap[id;]
        // }
        this.assetTypeNodeMap = {};
        //清除告警的billboard
        var datas = this.dataManager._datas
        for (var i = 0; i < datas.length; i++) {
           var boards = datas[i].boards; 
           if (boards && (boards instanceof Array)){
              for(var k = 0 ; k < boards.length ; k++){
                  var board = boards[k];
                  if (board) {
                    board.setParent(null);
                  }
              }
              delete datas[i].boards;
           } 
        }
        //清除告警的Map
        this._alarmManager._alarmBillboardMap = {};
        this._alarmManager._alarmNodeMap = {};
    },

    clear : function(scene,root){
        this.beforeClearFunction && this.beforeClearFunction();
        var nodes = new mono.List();
        for (var id in this.dataNodeMap) {
            var node = this.dataNodeMap[id];
            if (node) {
                node.setParent(null);
                nodes.add(node);
            }
        }
        this.viewManager3d.clear();
        this.getDataBox2d().clear();
        this.clearSceneNodeMap();
        this._sceneManagerChangeDispatcher.fire({
            kind:'clear',
            datas:nodes
        });
        if (this.isClearCache) {
           this.clearCache(scene,root);
        }
    },

    getCurrentScene : function(){
      return this._currentScene;
    },

    getParentScene : function(data){
        if(!data) return null;
        var parentData = this.dataManager.getParent(data);
        if (!parentData) {
            return null;
        }
        var category = this.dataManager.getCategoryForData(parentData);
        if (!category) {
            return this.getParentScene(parentData,this);
        }
        var parentScene = this.dataManager.getSceneByCategory(category);
        if (!parentScene) {
            return this.getParentScene(parentData,this);
        }else{
            return {scene:parentScene,data:parentData};
        }
    },

    gotoUpLevelScene : function(){
        var scene = this._currentScene;
        if(!scene) return false;
        if(scene.getTwod()){
            this.clear();//先去除3D对象的父子关系
            this.gotoUpLevelSceneFor2D();
        }else{
            this.gotoUpLevelSceneFor3D();
        }
    },

    /**
     * 到某个具体的场景中，对clear和loadOneScene进行了进一步的封装
     * 以前的设计思路是：到了一个新的scene，那之前的场景中的东西先全部clear，然后再装载新场景中的东西；
     * 现在有可能并不需要clear
     * @param scene
     * @param data
     */
    toScene : function(scene,data,callback,clientMap){
        if(!scene){
            return;
        }
        var self = this;
        var action = function(){
           self.clear(scene,data);
           self._loadOneScene(scene,data,callback,clientMap);
        }
        this.beforeLoadSceneAnimate(scene,data,this._currentScene,this._currentRootData,action,this);
    },
    
    /**
     * 切换场景
     */
    gotoScene : function(scene, data, callback,clientMap){
        if(!scene) {
            callback && callback('scene is null');
            return;
        }
        if(scene == this._currentScene){ //还得进一步判断，如果从一楼跳到二楼呢，场景一样
            var rootData = this.getNodeData(this._currentRootNode);
            if(data && rootData && data == rootData){
                callback && callback('scene is current scene, no change');
                return ;
            }
        }
        this.toScene(scene,data, callback,clientMap);
        if (data && !scene.getTwod()) {
            // this.viewManager3d.setFocusNode(this.dataNodeMap[data.getId()]);
            this.setFocusNode(this.dataNodeMap[data.getId()]); // 2017-08-11
        }
    },

    /**
     * 对于2D(比如2D面板)回到上一个层时，应该是回到显示机柜的那个scene（机柜本身没有设置scene），并且lookat到机柜
     */
    gotoUpLevelSceneFor2D : function(){
        var scene = this._currentScene;
        if (!scene) {
            return false;
        }
        var rootNode = this._currentRootNode;
        if (!rootNode) {
            return false;
        }
//        var lookAt = rootNode; // 转到2D中后，focus还是停留在3D场景的最后的那个focus，如果是一下子跨越了多个(如:从dc直接跳到了板卡，那板卡upto时，就到了dc——不合理)
        var data = this.getNodeData(rootNode);
        var sceneObj = this.getParentScene(data);
        if(sceneObj && sceneObj.scene && sceneObj.data){
            var self = this;
            var callback = function(){
//                if(lookAt){
                    var lookAtData = self.getNodeData(rootNode);
                    if(lookAtData && lookAtData.getParentId()){
                        var parentNode = self.dataNodeMap[lookAtData.getParentId()];
                        var box3D = self.network3d.getDataBox();
//                的再改改，因为getFocus很可能是dc，而当前的场景是板卡的上一级。
                        //不过将上面的lookAt改成了RootNode,应该是可以了
                        if(!parentNode //可是从面板到设备时，重新加载了对象，此时的机柜都是假的，因此设备很可能就不在box中了
                            || !box3D.getDataById(parentNode.getId())){
                            self.loadLazyData(lookAtData.getParentId());
                            parentNode = self.dataNodeMap[lookAtData.getParentId()];
                        }
                        if(parentNode){
                            self.viewManager3d.lookAt(parentNode);
                        }
                    }
//                }
            };
            this.toScene(sceneObj.scene, sceneObj.data);
            callback();
        }
        this.afterGotoUpLevelScene(data,scene,sceneObj.data,sceneObj.scene);
    },

    /**
     * 跳到上一层后所要执行的动作，便于扩展
     * 
     */
    afterGotoUpLevelScene : function(oldData,oldScene,data,scene){

    },

    /**
     * 根据当前的data获取其上一级的data，默认的是parentData。但是有可能有特殊情况，所以这里抽出来，便于扩展
     */
    getUpLevelDataByData : function(data){
       if (!data) {
          return null;
       }
       return this.dataManager.getParent(data);
    },

    gotoUpLevelSceneFor3D : function(){
        var scene = this._currentScene;
        if (!scene) {
            return false;
        }
        var rootNode = this._currentRootNode;
        var rootData = this._currentRootData;
        if (!rootNode && !rootData) {
            return false;
        } 

        var data = this.getNodeData(rootNode);
        if (!data) {
          data = rootData;
        }
        // var parentData = this.dataManager.getParent(data);
        var parentData = this.getUpLevelDataByData(data);
        if (!parentData) {
            return false;
        }
        var parentScene = this.getSceneAndRootByData(parentData);
        if(!parentScene){
            return false;
        }
        this.gotoScene(parentScene.scene, parentScene.rootData); //都走这个即可
        this.afterGotoUpLevelScene(data,scene,parentData,parentScene);
        return true;
    },

    gotoData : function(dataOrId){
      var dm = this.dataManager;
      var data = dataOrId;
      if(!(typeof dataOrId === $Data)){
         data = dm.getDataById(dataOrId);
      }
      if(!data){
        return false;
      }
      var category = dm.getCategoryForData(data);
      if(!category){
        return false;
      }

      var scene = this.dataManager.getSceneByCategory(category);
      if(!scene){
        return false;
      }
        this.toScene(scene,data);
        var dataNode = null;
        if (data) {
            dataNode = this.dataNodeMap[data.getId()];
        }
        // this.viewManager3d.setFocusNode(dataNode);
        this.setFocusNode(dataNode); //2017-08-11
        return true;
    },

    initViewManager : function(){
        this.viewManager3d = new it.ViewManager(this);
        this.viewManager3d.addEventHandler(this);
        if (it.ViewManager2D) {
           this.viewManager2d = new it.ViewManager2D(this);
           this.viewManager2d.addEventHandler(this);
        }
    },

    removeNodeChildren : function(dataOrNodeOrId,filterFunction){
       var node = dataOrNodeOrId;
       if(dataOrNodeOrId instanceof $Data || typeof dataOrNodeOrId === 'string'){
         node = this.getNodeByDataOrId(dataOrNodeOrId);
       }
       var box = this.getDataBox();
       var children = node.getChildren().toList();

       children.forEach(function(child){
          if(!filterFunction || filterFunction(child)){
              child.setParent(null);
              box.removeByDescendant(child);
          }
       });
    },

    setNodeData : function(data,node,root){
        if(!node) return ;
        // add 2017-11-06 表示业务数据已经设置了，不要再设置了，有可能node的parent没有置空，这里再设置的话导致
        if (node.getClient(it.SceneManager.CLIENT_IT_DATA) 
            && node.getClient(it.SceneManager.CLIENT_IT_DATA_ID)) {
              return ;
        }
       node.setClient(it.SceneManager.CLIENT_IT_DATA,data);
       node.setClient(it.SceneManager.CLIENT_IT_DATA_ID,data.getId());
        if(!root){
            root = node;
            node.setClient('modelParent',null);
        }else{
            node.setClient('modelParent',root);
        }
        var complexNode = node.getClient('complexNode');
        if(complexNode && complexNode != 'unload'){
          this.setNodeData(data,complexNode,root);
        }
        var self = this;
        if(node.getChildren() && node.getChildren().size() > 0 ){// 注意，有可能孩子是其他的类型，所以的注意先后顺序
            node.getChildren().forEach(function(child){
                self.setNodeData(data,child,root);
            });
        }
    },

    getMainNode : function(node){
        if(!node) return;
        if(node.getClient(it.SceneManager.CLIENT_IT_DATA) == null){
            node = node.getParent();
        }
        return this.getNodeByDataOrId(this.getNodeData(node));
    },

    getParentNode : function(data){
       var parentId = data.getParentId();
       if(parentId){
        return this.dataNodeMap[parentId];
       }
       return null;
    },

    getChildrenNodes : function(nodeOrData,dataTypeId){
      var data = nodeOrData;
      if(nodeOrData instanceof mono.Node){
        data = this.getNodeData(node);
      }
      var children,i = 0,nodes = [];
      if(data){
        children = this.dataManager.getChildren(data,dataTypeId);
        for(i = 0;i < children.length;i ++){
            nodes.push(this.getNodeByDataOrId(children[i]));
        }
      }

      return nodes;
    },

    getNodeData : function(node){
        if(!node || !node.getClient) return null;
       return node.getClient('it_data');
    },

    getNodeByDataOrId : function(dataOrId){
        if(!dataOrId) return null;
        var id = dataOrId.getId ? dataOrId.getId() : dataOrId;
        return this.dataNodeMap[id];
    },

    getNodeForDataOrId : function(data){
        if(!data) return null;
        var id = data.getId ? data.getId() : data;
        return this.dataNodeMap[id];
    },

    loadModel: function(model,params,prefabAble,prefabId,callback){
        var params = JSON.parse(JSON.stringify(params));
        var node = null;
        if(prefabAble && prefabId){
           node = this.prefabMap[prefabId];
           if(node && node.clonePrefab){
              node = node.clonePrefab();
           }
        }
        if(!node){
            params = params || {};
            params.type = params.type || model;
            var id = model || params.type;
            if(!id){
                return null;
            }
            var obj = {};
            if(params instanceof Array){
                obj.data = params;
                obj.id = id;
            //支持加载多个模型
            }else if(id === 'twaver.loader'){
                obj.id = id;
                obj.data = params;
            }else{
                obj = params || {};
                obj.id = id;
            }
            var prefaNode = make.Default.load(obj,callback);
            if(!prefaNode){
                return null;
            }
            if(prefabAble && prefabId && id != 'twaver.loader'){
               this.prefabMap[prefabId] = prefaNode;
               node = prefaNode.clonePrefab();
            }else{
              node = prefaNode;
            }
            // if (prefaNode && prefaNode.clonePrefab) {
            //   node = prefaNode.clonePrefab();
            // }else {
            //   node = prefaNode;
            // }
        }
        return node;
    },

    loadDataTypeTemplateModels : function(dataType,parentData,onLoadFinish) {
        var templateDatas = dataType.getTemplateDatas();
        if(templateDatas == null || templateDatas.length == 0){
            return;
        }
        var self = this;
        templateDatas.forEach(function(data){
            data = self._translateTemplateData(data,parentData)
            var parentNode = self.dataNode2DMap[parentData.getId()];
            var node = self.loadDataModel2D(data,onLoadFinish)
            if (node) {
               node.setMovable(false);
               node.setHost(parentNode);
               node.setParent(parentNode);
               node.setName("");
            }
        });
    },

    _loadDataModeCallback : function(data,node,onLoadFinish){
          var dm = this.dataManager,
          box = this.network3d.getDataBox();
          var id = data.getId();
          var assetType = dm.getDataTypeForData(data);
          var category = dm.getCategoryForData(data);
           box.addByDescendant(node);
           if (!this.dataNodeMap[id] && this.afterFirstLoadDataModelFunction) {
              this.afterFirstLoadDataModelFunction(data, node); //第一次创建好dataNode的时候调用
           }
           this.dataNodeMap[id] = node;
           var temp = this.assetTypeNodeMap[assetType.getId()];
           if(!temp){
              temp = {};
              this.assetTypeNodeMap[assetType.getId()] = temp;
           }
           temp[id] = node;
           if(category){
              temp = this.categoryNodeMap[category.getId()];
              if(!temp){
                temp = {};
                this.categoryNodeMap[category.getId()] = temp;
              }
              temp[id] = node;
           }
           this.setNodeData(data,node);
           this.addToSceneNodeMap(data,node);
           if (onLoadFinish) {
              onLoadFinish(node);
           }
           this._sceneManagerChangeDispatcher.fire({
               kind:'add',
               data:node
           });
    },

    /**
     * 创建data的3D对象
     * @includeInvisible 是否加载不可见的对象(目前用category中的visible来标识)
     *
     */
    loadDataModel : function(data,includeInvisible,onLoadFinish){
       var dm = this.dataManager;
       var dataType = dm.getDataTypeForData(data);
       var category = dm.getCategoryForData(data);
       if (category && !category.isVisible()) { 
            this.invisibleFilter.setVisible(data,false); // 虽然load了,但是load后依然是隐藏着的
            if (!includeInvisible) {
               return;
            }
       }
       var self = this,
           box = this.network3d.getDataBox(),
           id = data.getId();
       var node = this.dataNodeMap[id];
       var parameters = dataType.getModelParameters();
       var params = parameters;
       var prefabAble = dataType.isPrefabAble(),simplePrefabAble = dataType.isSimplePrefabAble();
       var simpleModel = dataType.getSimpleModel();
       var simpleModelParameters = dataType.getSimpleModelParameters();
       if(node){
          this._loadDataModeCallback(data,node,onLoadFinish);
       }else{
          var simpleNode;
          if(simpleModel){
              simpleNode = this.loadModel(simpleModel,simpleModelParameters,simplePrefabAble,dataType.getId() + '_simple');
          }
          if(simpleNode){
              // var boundingBox = node.getBoundingBoxWithChildren();
              var boundingBox = simpleNode.getBoundingBoxWithChildren && simpleNode.getBoundingBoxWithChildren();
              var size = {x:1,y:1,z:1} ; 
              if(boundingBox){
                size = boundingBox.size();
              }
              var fakeNode = new mono.Cube(size.x,size.y,size.z);
              fakeNode.s({
                'm.visible' : false
              });
              simpleNode.setParent(fakeNode);
              fakeNode.setClient("simpleNode",simpleNode);
              fakeNode.setClient("complexNode","unload");
              // fakeNode.setClient("complexNode",node);
              // callback(fakeNode);
              this._loadDataModeCallback(data,fakeNode,onLoadFinish);
          }else{
              // callback(node); 
              // this._loadDataModeCallback(data,node,onLoadFinish);
              this.loadComplexNode(data,onLoadFinish);
          }
       }
    },

    /**
     * 加载复杂模型，为了初次的加载速度，有可能一开始没有创建创建复杂对象，只是创建了简单对象
     * 存在两种情况：1、没有简单模型(fakeNode就是自己)，在当前场景下的话，就设置relaction和position
     *             2、有简单模型的情况
     * 有可能复杂对象是个obj模型
     */
    loadComplexNode : function(data,callback){
        if (!data) {
            callback&&callback(null);
            return null;
        }
        var dataNode = this.dataNodeMap[data.getId()];
        if (dataNode) {
           var complexNode = dataNode.getClient('complexNode');
           // if (!complexNode || complexNode != 'unload') {
          if (complexNode && complexNode != 'unload') { // 2017-10-31
              callback&&callback(complexNode);
              return complexNode;
           }
        }
        var dm = this.dataManager;
        var self = this;
        var dataType = dm.getDataTypeForData(data);
        var params = dataType.getModelParameters();
        var prefabAble = dataType.isPrefabAble(),simplePrefabAble = dataType.isSimplePrefabAble();
        
        var complexNode = this.loadModel(dataType.getModel(),params,prefabAble,dataType.getId()); // 为了可以支持异步加载，需要提供callback机制
        if(!complexNode) {
            this.loadModel(dataType.getModel(),params,prefabAble,dataType.getId(),function(node){
                if (self.dataNodeMap[data.getId()]) { 
                    return ;
                }
                if(node && node instanceof Array){
                   for(var i = 1 ; i < node.length ; i++){
                      console.log('load a lots of model');
                      node[i].setParent(node[0]); //让其他的是第一个的孩子
                   }
                   node = node[0];
                }
                if (dataNode) {
                   dataNode.setClient('complexNode',node);
                   self.setNodeData(data,node,dataNode);
                   callback&&callback(node);
                }else{
                    if (self.isCurrentSceneInstance(data)) { //那就没法强制创建了
                        self._loadDataModeCallback(data,node,null);
                        self.setRelationShipAndPosition(data); //当有真假对象时，并不需要设置真对象的这些值吧？
                        callback&&callback(node);
                    }else{
                       // 如果没有简单模型，并且不在当前场景就不管了
                       callback&&callback(node); // 2018-01-04 kevin callback还是需要调用
                    }
                }
            });
            return null;
        }else{
           if (complexNode instanceof Array) {
              for(var i =1 ; i< complexNode.length ; i++){
                complexNode[i].setParent(complexNode[0]);
              }
              complexNode = complexNode[0];
           }
           if (dataNode) {
              dataNode.setClient('complexNode',complexNode);
              this.setNodeData(data,complexNode,dataNode);
              callback&&callback(complexNode);
           }else{
              this._loadDataModeCallback(data,complexNode,null);
              this.setRelationShipAndPosition(data); // 解决孩子比父亲先创建的bug
              callback&&callback(complexNode);
           }
           return complexNode;
        }
    },

    /**
     * 根据model或params创建2D的Node，这块还需要扩展，是否也需要提供一个2d的Modellib
     * @param model
     * @param params
     * @returns {twaver.Node}
     */
    loadModel2D : function(model,params,data){
        if(model || mono.Utils.isArray(params)){
            var obj = {};
            if(params instanceof Array){
                params.forEach(function(node){
                    node.scale = 20;
                });
                obj.data = params;
                obj.id = model;
            }else{
                obj = params || {};
                obj.id = model;
            }
            return make.Default.load(obj);
        }else {
             console.log('unknown 2d model params: ' + params);
             return null;
        }
    },

    /**
     * 创建template的实例对象
     * @param data
     * @param parentData
     * @returns {*}
     * @private
     */
    _translateTemplateData : function(data,parentData) {
        var id = data.getId(),
            parentId = parentData.getId(),
            pos = data.getPosition2d()||new mono.Vec2,
            pPos = parentData.getPosition2d()||new mono.Vec2;
        var dataId = id + "@" + parentId;
        var newData = this.dataManager.getDataById(dataId);
        if(!newData){
            newData = data.clone(dataId);
            newData.setHostId(data.getHostId());
            this.dataManager.addData(newData,false);
            var newPos = newData.getPosition2d() || new mono.Vec2;
            //每次新建时才换算成绝对的位置
            // pPos有可能是{x:"0",y:"0",z:"0"}，所以的转换
            newPos.x = parseInt(pPos.x||0) + pos.x;
            newPos.y = parseInt(pPos.y||0) + pos.y;
//            newPos.z = parseInt(pPos.z||0) + pos.z; //没有z
        }
        //让dataType中的data的位置永远是相对的
//        pos.x = pPos.x + pos.x;
//        pos.y = pPos.y + pos.y;
//        pos.z = pPos.z + pos.z;
        newData.setParentId(parentId);
        return newData;
    },

    /**
     * 加载2D dataType的templateDatas，如：板卡中的端口,灯泡等对象
     * @param dataType
     * @param parentData
     * @param onLoadFinish
     */
    loadDataTypeTemplateModel2Ds : function  (dataType,parentData,onLoadFinish) {
        var templateDatas = dataType.getTemplateDatas();
        if(templateDatas == null || templateDatas.length == 0){
            return;
        }
        var self = this;
        var groups = {};
        templateDatas.forEach(function(data){ //可是child有groupID时呢(也就是data的hostId)
            data = self._translateTemplateData(data,parentData);
            var groupId = data.getHostId();
            var parentNode = self.dataNode2DMap[parentData.getId()];
            var node = self.loadDataModel2D(data,onLoadFinish);
            if (!node) {
               return ;
            }
            node.setMovable(false);
            if(groupId){
                self.setTemplatesGroup(node,groupId,parentNode,groups);
            }else{
                if(parentNode){
                    node.setHost(parentNode);
                    node.setParent(parentNode);
                }
            }
            node.setName("");
            var tooltip = data.getId();
            var parentId = parentData.getId();
            if(tooltip.length > (parentId.length+1)){
                tooltip = tooltip.substring(0,(tooltip.length-parentId.length-1));
            }
            node.setToolTip(tooltip);
        });
    },

    setTemplatesGroup : function(node,groupId,parentNode,groups){
        if(!node || !groupId){
            return null;
        }
        if(!groups){
            groups = {};
        }
        //并不是每次都要创建，一般第一次创建，后来再进入该面板(同一个面板实例)时就不需要创建了
        var nodeGroup = node.getParent();
        if(nodeGroup
            && nodeGroup.getClient('group_id')
            && nodeGroup.getClient('group_id') == groupId){
            return ;
        }
        var group = null;
        if(!groups[groupId]){
            var box = this.getDataBox2d();
            group = new twaver.Node();
            if(parentNode){
                var parentData = this.getNodeData(parentNode);
                group.setParent(parentNode);
                group.setClient('parent_data',parentData);
                group.setName('');
                group.setToolTip(groupId);
                group.setVisible(false);
            }
            group.setClient('group_id',groupId);
            groups[groupId] = group;
            box.add(group);
        }else{
            group = groups[groupId];
        }
        node.setHost(parentNode);//但是还是附着在面板上
        node.setParent(group);
    },

    /**
     * 加载2d的模型
     * @param data
     * @param onLoadFinish
     * @returns {*}
     */
    loadDataModel2D : function(data,onLoadFinish){
        if (!this.viewManager2d) {
            console.log('need add ViewManager2D model!');
            return null;
        }
        var dm = this.dataManager;
        var dataType = dm.getDataTypeForData(data);
        var box = this.getDataBox2d(),id = data.getId();
        var node = this.dataNode2DMap[id];
        var parameters = dataType.getModel2dParameters();
        if(!node){
            node = this.loadModel2D(dataType.getModel2d(), parameters,data);
            var parentNode = node;
            if(node instanceof Array){
                parentNode = node[0];
                if(parentNode){
                    parentNode.setMovable(false);
                    for(var i = 1 ; i < node.length ; i++){
                        var child = node[i];
                        if(child){
                            child.setMovable(false);
                            this.setNodeData(data,child);
                            parentNode.addChild(child);
                            child.setHost(parentNode);
                        }
                    }
                }
            }
            if(parentNode){
                parentNode.setName(data.getDescription() || id);
                this.setNodeData(data,parentNode);
                this.dataNode2DMap[id] = parentNode;
                var position = data.getPosition2d();
                if(position){
                   this.viewManager2d.setPosition(parentNode, position.x, position.y);
                }
            }
        }
        if(!box.getDataById(node.getId())){//如果板卡之前创建过，那一下子就会将其孩子加进去，所有接下来重新load child时会有重复的问题
            box.addByDescendant(node);
        }
        this.loadDataTypeTemplateModel2Ds(dataType,data,onLoadFinish);
        return node;
    },

    handleDataAdd : function(event){
       var data = event.data;
       if(data instanceof $Data){
          if(this.shouldLoadData(data)){
            this.loadOneData(data);
          }else if(this.shouldLoadData2D(data)){
            this.loadDataModel2D(data); 
          }
       }else if(data instanceof $Link){
          this.loadLink(data);
       }
    },

    /**
     * 这里判断的注意一下，有可能data是延时加载的，如：Equipment,我们只在需要的时候才会去加载创建，目前只在lookAt的时候会将其显示出来
     * @param data
     * @returns {boolean}
     */
    shouldLoadData : function(data,forParent){
        if(!data){
            return false;
        }
        if(forParent){
             var node = this.getNodeByDataOrId(data);
              if(node ){ //如果已经存在节点
                return true;
              }
        }
       
        var dataType = this.dataManager.getDataTypeForData(data);
        if(dataType && dataType.isLazyable()){
            var focusNode = this.viewManager3d.getFocusNode();
            var focusData = this.getNodeData(focusNode);
            if(focusData && (focusData.getId() == data.getId())){
                return true;
            }else{
                return false;
            }
        }else{ //不是延迟加载的话，就判断是不是在当前场景下
//            var currentScene = this.getCurrentScene();
//            if(currentScene == null){
//                return true;
//            }
//            var sceneData = this.getParentScene(data);
//            return sceneData.scene == this.getCurrentScene() && !currentScene.getTwod();
            var parentId = data.getParentId(),
            parent = this.dataManager.getDataById(parentId);
            return this.shouldLoadData(parent,true) && this.isCurrentSceneInstance(data);
        }
    },

    /**
     *
     * @param data
     * @returns {*}
     */
    shouldLoadData2D : function(data){
       var currentScene = this.getCurrentScene();
       if(currentScene == null){
          return false;
       }
       var sceneData = this.getParentScene(data)
       return sceneData.scene == this.getCurrentScene() && currentScene.getTwod();
    },

    handleDataRemove : function(event){
       var data = event.data;
       var dm = this.dataManager;
       var box = this.network3d.getDataBox();
       if(data instanceof $Data){
         var node = this.dataNodeMap[data.getId()];
         box.removeByDescendant(node);
       }else if(data instanceof $Link){
         var link = this.linkMap[data.getId()];
         box.removeByDescendant(link);
       }
    },

    handleDataPropertyChange : function(event){
        var data = event.source;
        var property = event.property;
        if(property === "parentId"){
           var oldParentId = event.oldValue;
           var parentId = data.getId();
           this.setParentRelationShip(data);
           this.translatePosition(data);
        }else if(property === "location" || property === "position"){
           this.translatePosition(data);
        }
    },

    setAllParentRelationShip : function(scene,rootData){
    	  for(var id in this.dataNodeMap){
    		    var node = this.dataNodeMap[id];
    		    var data = this.getNodeData(node);
            // this.setParentRelationShip(data); //不要所有都设置，这样还要常常去切断其他的场景中的父子关系
            /*
            if (scene && rootData) {
                var dataScene = this.getSceneAndRootByData(data);
                if (dataScene.scene == scene && dataScene.rootData == rootData) {
                   this.setParentRelationShip(data);
                }
            }else{*/
               this.setParentRelationShip(data);
            /*}*/
    	  }
    },

    //如果去掉了parent，那lookAt时，去掉虚化的byDecendant就会受到影响，通过data的parentid
    // 如果是地球的话，不来设置其Data的父子关系
    isNeedSetParent: function(data, node) {
        // return true;
        if (data) {
            var parentNode = this.dataNodeMap[data.getParentId()];
            if (this.earthScene && this.earthScene.rootData) {
                var earthNode = this.getNodeByDataOrId(this.earthScene.rootData);
                //如果parent是地球，那在地球场景中设置其parent，其他的场景下则不设置
                if (parentNode && parentNode == earthNode) {
                    if (this._currentScene 
                        && this._currentScene.getCategoryId().indexOf('earth') >= 0) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }
            //注意：如果lazyLoad其他场景的设备或机柜时，那这些对象的父子关系就没有了，尽然要加进来那一定会设置父子关系的，否则位置都不对 —— 注销于2017-09-28
            // var parentData = this.getNodeData(parentNode);
            // if (!this.isCurrentSceneInstance(parentData)) { // 如果父亲不在当前场景中，就不需要设置该孩子和它的父子关系了
            //     return false;
            // }
        }
        return true;
    },

    /**
     * 设置父子关系
     *
     */
    setParentRelationShip : function(data){
        if(!data) return;
        var node = this.dataNodeMap[data.getId()];
        if(!this.isNeedSetParent(data,node)){
            return ;
        }
        var parentNode = this.dataNodeMap[data.getParentId()];
        if(node && parentNode){
          node.setParent(parentNode);
        }
    },

    /**
     * 设置data的父子关系和位置，以及data的孩子的父子关系和位置
     * 使用场景：延迟加载，有可能孩子先加载出来，父亲的3D对象许久之后
     */
    setRelationShipAndPosition : function(data){
        if (!data) {
            return;
        }
        this.setParentRelationShip(data);
        this.translatePosition(data);
        var children = data.getChildren();
        if (!children || children.size() < 1) {
            return;
        }
        var node = this.dataNodeMap[data.getId()];
        var self = this;
        children.forEach(function(child){
            var childNode = self.dataNodeMap[child.getId()];
            if (childNode && self.isNeedSetParent(child,childNode)) {
                childNode.setParent(node);
            }
            self.translatePosition(child);
        });
    },

    translateAllPosition : function(){
       for(var id in this.dataNodeMap){
          var node = this.dataNodeMap[id];
          var data = this.getNodeData(node);
          this.translatePosition(data);
       }
    },
    
    // 独立处理，方便用户重载这个方法，实现特定的逻辑？
    computePosition : function(data,parentData,node,parentNode){
    	this.locationManager.computePosition(data,parentData,node,parentNode);
    },

    computeRotation : function(data,parentData,node,parentNode){
      this.locationManager.computeRotation(data,parentData,node,parentNode);
    },

    translatePosition : function(data){
  		if(!data){
  			return;
  		}
  		var dm = this.dataManager;
  	  var id = data.getId();
  	  var node = this.dataNodeMap[id];
  	  if(!node){
  	    	return;
  	  }
  		var parentId = data.getParentId();
  		var parentData = dm.getDataById(parentId);
  		var node = this.dataNodeMap[id];
  		var parentNode = this.dataNodeMap[parentId];
      // 注意，如果不是在同一个Scene时，应该不设置其parentNode,如楼层的parent不需要填上，否则building的缩放等会影响到楼层，需要的话从data上获取
      
      this.computePosition(data,parentData,node,parentNode);
      this.computeRotation(data,parentData,node,parentNode);
    },

    /**
     * 场景跳转前，这个方法不同于beforeLoadScene方法。
     * 由于存在“场景切换之前需要处理一系列的动画，然后在动画执行结束后在去切换场景”的情形，而动画都是异步的，
     * 所以提供了这样的方法来处理这样的情形
     * beforeLoadScene其实是在该方法内部执行的(即在callback中)。
     */
    beforeLoadSceneAnimate : function(scene,sceneRootData,oldScene,oldSceneRootData,callback,scope){
        if(callback){
          callback.call(scope);
        }
    },

    /**
     * 加载场景之前所要执行的方法
     * 有返回值，true和false，表示是否执行接下来的场景切换
     * 注意：该方法和beforeLoadSceneAnimate的区别
     */
    beforeLoadScene : function(scene,sceneRootData,clientMap){ // 通过此方法控制场景进入之前的工作
        if(this.beforeLoadSceneFunction){
            this.beforeLoadSceneFunction(scene,sceneRootData,clientMap);
        }
    	return true;
    },

    /**
     * 场景切换完成之后所执行的方法
     */
    afterLoadScene : function(scene,sceneRootData,oldScene,oldRootData,clientMap){ //for user use.
        this._sceneChangeDispather.fire({
            kind:'changeScene',
            data:scene,
            rootData:sceneRootData,
            oldData:oldScene,
            oldRootData:oldRootData,
            clientMap:clientMap
        });
        if(this.afterLoadSceneFunction){
            this.afterLoadSceneFunction(scene,sceneRootData);
        }
    },

    /**
     * 生成data的3D对象，并且设置位置和父子关系
     * @includeInvisible 是否加载不可见的对象
     */
    loadOneData : function(data,includeInvisible,onLoadFinish){
       var dataType = this.dataManager.getDataTypeForData(data);
        if(!dataType || !make.Default.getCreator(dataType._model)) {
          if (!dataType) {
             console.log('modelType is  null!');
          }else{
             console.log('model id ' + dataType._model+' does not exist!');
          }
          onLoadFinish && onLoadFinish();
          return ;
        }
       this.loadDataModel(data,includeInvisible,onLoadFinish);
       this.setParentRelationShip(data);
       this.translatePosition(data);
    },

    getSceneFromData : function(dataOrId){
        var dm = this.dataManager;
        if(dm.getRootScene() == null){
           return null;
        }
        if(!dataOrId){
          return null;
        }
        var dm = this.dataManager;
        var data = dataOrId;
        if(!dataOrId.getId){
         data = dm.getDataById(dataOrId);
        }
        var scene = dm.getSceneByData(data);
        if(scene == null){
          return data&&this.getSceneFromData(data.getParentId());
        }
        scene.__currentRootData = data;
        return scene;
    },

    /**
     * 懒加载
     * 注意：如果懒加载的node的Scene和当前的Scene不同时，该怎么办...
     *
     * @param dataOrId
     * @param callback 这个callback在加载完第一个后执行的
     */
    loadLazyData : function(dataOrId,callback){ //有个问题，如果dataOrId是floor呢，貌似直接返回了，所以下面判断scene时，若要返回则先loadData
        if (!dataOrId) {
            return;
        }
        var self = this;
        var dm = this.dataManager;
        var data = dataOrId;
        if (!dataOrId.getId) {
            data = dm.getDataById(dataOrId);
        }
        var parentId = data.getParentId();
        var parentScene = this.getSceneFromData(parentId);
        var dataScene = this.getSceneFromData(data);
        // 一步一步往上，然后AddByDescendant很容易重复; 这里加了个，不在同一个场景中中一定是没有必要在往上跑的
        if ((parentScene != null || dataScene != null) && parentScene != dataScene) {
           var node = this.getNodeByDataOrId(data); 
           if (!node) {
             this.loadOneData(data,null,callback);
           } else {
              var box = this.getDataBox();
              if (!box.contains(node)) {
                 box.addByDescendant(node,function(childNode){
                     var childData = self.getNodeData(childNode); 
                     if (childData && self.isCurrentSceneInstance(childData)) {
                        return true;
                     }
                     return false;
                 }); // 这个byDescendant有可能add了其他场景的对象
                 this.setParentRelationShip(data);
                 this.translatePosition(data);
              }
            }
            callback&&callback(node);
            return;
        }
        this.loadLazyData(parentId);
        var node = this.getNodeByDataOrId(data); 
        if (!node) {
            this.loadOneData(data,null,callback);
        } else {
            var box = this.getDataBox();
            if (!box.contains(node)) {
                box.addByDescendant(node);
                this.setParentRelationShip(data);
                this.translatePosition(data);
            }
            callback&&callback(node);
        }
    },

    /**
     * 加载孩子或者子孙，可以当孩子或孙子可这个data不在同一个场景下是不是会有点乱呢，loadChild之前已经判断了
     * @param dataOrNode
     * @param onlyNotLazy
     */
    loadLazyChildren : function(dataOrNode,onlyNotLazy){
       onlyNotLazy = onlyNotLazy || false;
       var data =  dataOrNode;
       var root = dataOrNode;
       if(dataOrNode instanceof mono.Data){
          data = this.getNodeData(dataOrNode);
       }else{
          root = this.getNodeByDataOrId(data);
       }
        if(!(data instanceof it.Data)){
            return null;
        }
       var parentScene = this.getSceneFromData(data);
       var children = new mono.List();
        if(data instanceof $Data){
            children = data.getChildren();
        }//this.dataManager.getChildren(data);
       var i =0,length = children.size(),child,childType,node;
       for(;i < length;i ++){
           child = children.get(i);
           node = this.dataNodeMap[child.getId()];
           if (!node) {
               childType = this.dataManager.getDataTypeForData(child);
               if (!(childType.isLazyable() && onlyNotLazy)) {
                   //先判断是否在该场景,再加载孩子 2017-10-25
                   // var dataScene = this.getSceneFromData(child);
                   // if ((parentScene != null || dataScene != null) && parentScene != dataScene) { 
                   //     continue;
                   // }
                   // if (this.isSceneInstance(parentScene,data,child)) {//2017-10-31 不可根据父亲的data来，这样会全部都加载的
                   if (this.isCurrentSceneInstance(child)) { // 只判断是否是当前场景就行
                      this.loadOneData(child);
                      this.loadLazyChildren(child, true);
                   }
                   // this.loadOneData(child);
                   // var dataScene = this.getSceneFromData(child);
                   //先判断是否在该场景,再加载孩子 2017-10-25
                   // if ((parentScene != null || dataScene != null) && parentScene != dataScene) { 
                   //     continue;
                   // }
                   // this.loadLazyChildren(child, true);
               }
           } else {
//             node.setParent(root);
               if (!this.isCurrentSceneInstance(child)) { // 2017-11-09 只判断是否是当前场景就行
                   continue;
               }
               var self = this;
               var childType = this.dataManager.getDataTypeForData(child);
               if (childType && !(childType.isLazyable() && onlyNotLazy)) {
               //这么添加的条件是，当parentData加载了，其孩子也一定加载了，其实不然，当跨楼层的link时，
               // 只加载了那个data和其所在场景的rootData,因此下面还有一个loadLazyChildren
               if (!this.network3d.getDataBox().getDataById(node.getId())) { 
                   this.network3d.getDataBox().addByDescendant(node,function(childNode){ 
                   // 加了一个filter，同一个场景中的才加进去
                   // 可是有存在这样的情况：data有自己的场景，可是data的parent又是一个场景，并且其parent的场景中有加载它data(即：showParentAndChildren)，
                   //   此时若是其parent的场景中加载自己时，则会把它的孩子也加载进来了，因为child和data是同一个。
                   // 但是这样是不是自己都有可能加不进去啊，因为自己有自己的场景
                       // var nodeScene = self.getSceneFromData(child);
                       var rootNodeScene = self._currentScene;
                       var childNodeScene = self.getSceneFromData(self.getNodeData(childNode));
                       var childNodeData = self.getNodeData(childNode);
                       if(childNodeData == child){ // 不管怎么着，如果是他自己的话一定加进去
                          return true;
                       }
                       if (childNode instanceof mono.Billboard 
                        && childNode.getClient('_alarmBillboard')) { // 2017-11-06 如果是告警气泡的话也不应该过滤掉
                          return true;
                       }
                       
                       // 如果lazyLoad的node已经创建了，此时判断并不是把孩子都load进去，如果有复杂模型的，只有add复杂模型时还把孩子加进去
                       var complexNode = node.getClient('complexNode'),simpleNode = node.getClient('simpleNode');
                       if (complexNode 
                           && simpleNode 
                           && complexNode != 'unload' 
                           && complexNode.getParent() != node
                           && simpleNode.getParent() == node) {
                          return false;
                       }
                       if ((rootNodeScene != null || childNodeScene != null) 
                        && rootNodeScene != childNodeScene) {
                           return false;
                       }else{
                           return true;
                       }
                   });
               }
               var dataScene = this.getSceneFromData(child);
               if ((parentScene != null || dataScene != null) && parentScene != dataScene) {
                   continue;
                }
                this.loadLazyChildren(child, true);
               }
               
           }
       }
       // this.loadLinks();
    },

    $P : function(level,dataOrId){
       
    },

    loadLinks : function(){
       var dm = this.dataManager;
       var linkMap = dm.getLinkMap();
       for(var id in linkMap){
           this.loadLink(linkMap[id]);
       }
    },

    loadLink : function(link){
        var dm = this.dataManager;
        var fromId = link.getFromId();
        var toId = link.getToId();
        var fromSide = link.getFromSide();
        var toSide = link.getToSide();
        var fromNode = this.dataNodeMap[fromId];
        var toNode = this.dataNodeMap[toId];
        if (!fromNode || !toNode) {
            return;
        }
        // add 2016-12-06 连线到端，注意：由于端口是单独管理的，所以加载/卸载link时，得通过业务数据来处理
        var fromPort = null,toPort = null;
        if (link.getFromPortId()) {
            fromPort = this.postManager.loadPortByPortId(fromId,link.getFromPortId(),fromSide);
        }
        if (link.getToPortId()) {
            toPort = this.postManager.loadPortByPortId(toId,link.getToPortId(),toSide);
        }
        if (fromPort) {
            fromNode = fromPort;
        }
        if (toPort) {
            toNode = toPort;
        }

        if (this.linkMap[link.getId()]) {
            return;
        }
        var monoLink = null;
        var color = '#21CD43'; //00FFFF
        var radius = link.getRadius() || 2;
        var linkTemplate = null;
        var dataTypeId = link.getDataTypeId();
        var dataType = dm._dataTypeMap[dataTypeId];
        var imageFlow = 'data:image/jpg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4RDARXhpZgAATU0AKgAAAAgABQESAAMAAAABAAEAAAExAAIAAAAuAAAIVgEyAAIAAAAUAAAIhIdpAAQAAAABAAAImOocAAcAAAgMAAAASgAAAAAc6gAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAE1pY3Jvc29mdCBXaW5kb3dzIFBob3RvIFZpZXdlciA2LjEuNzYwMC4xNjM4NQAyMDE1OjA3OjMwIDE2OjU4OjA4AAAB6hwABwAACAwAAAiqAAAAABzqAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4TG4aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49J++7vycgaWQ9J1c1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCc/Pg0KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyI+PHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj48cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0idXVpZDpmYWY1YmRkNS1iYTNkLTExZGEtYWQzMS1kMzNkNzUxODJmMWIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyI+PHhtcDpDcmVhdG9yVG9vbD5NaWNyb3NvZnQgV2luZG93cyBQaG90byBWaWV3ZXIgNi4xLjc2MDAuMTYzODU8L3htcDpDcmVhdG9yVG9vbD48L3JkZjpEZXNjcmlwdGlvbj48L3JkZjpSREY+PC94OnhtcG1ldGE+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8P3hwYWNrZXQgZW5kPSd3Jz8+/9sAQwACAQECAQECAgICAgICAgMFAwMDAwMGBAQDBQcGBwcHBgcHCAkLCQgICggHBwoNCgoLDAwMDAcJDg8NDA4LDAwM/9sAQwECAgIDAwMGAwMGDAgHCAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwM/8AAEQgBAAEAAwEiAAIRAQMRAf/EAB8AAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/EAB8BAAMBAQEBAQEBAQEAAAAAAAABAgMEBQYHCAkKC//EALURAAIBAgQEAwQHBQQEAAECdwABAgMRBAUhMQYSQVEHYXETIjKBCBRCkaGxwQkjM1LwFWJy0QoWJDThJfEXGBkaJicoKSo1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoKDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uLj5OXm5+jp6vLz9PX29/j5+v/aAAwDAQACEQMRAD8A/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA/p8ooor+sD+SwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACv5g6/p8r+YOvyfxQ/5hv+3/8A2w/WvC3/AJif+3P/AG8KKKK/Jz9aCiiigAooooAKKKKACiiigAooooA//9k=';
        if(dataType != null){
            linkTemplate = this._linkTemplateMap[dataTypeId];
            if(!linkTemplate){
                linkTemplate = this.loadModel(dataType.getModel(),dataType.getModelParameters());
            }
        }

        if(link.getType() && link.getType() == 'link'){
            monoLink = new mono.Link(fromNode, toNode);
            if(linkTemplate && linkTemplate instanceof mono.PathNode){
                // monoLink.s(linkTemplate.styleMap); // 这样会共用，当改变某个link的style时所有的link都会跟着一起变 ——2017-06-23 Kevin
                for(var key in linkTemplate.styleMap){
                    monoLink.setStyle(key,linkTemplate.styleMap[key]);
                }
            }else{
                monoLink.s({ // 设置默认的值
                    'm.type':'phong',
                    'm.color':'cyan',
                    'm.ambient':'cyan',
                });
            }
            monoLink.setStyle('m.linewidth',5);
        }else{
            monoLink = new mono.PathLink(fromNode, toNode);
//            if(dataType != null){
               // if(linkTemplate && linkTemplate instanceof mono.PathNode){ // if exists template,use template style;
               //    monoLink.setStartCap(linkTemplate.getStartCap());
               //    monoLink.setEndCap(linkTemplate.getEndCap());
               //    monoLink.setRadius(linkTemplate.getRadius());
               //    monoLink.s(linkTemplate.styleMap);
               // }else{
                 monoLink.s({ // 设置默认的值
                  'm.type':'phong',
                  'm.color':'cyan',
                  'm.ambient':'cyan',
                  // 'm.texture.image':imageFlow,//'./images/pipeline/flow.jpg',
                  // 'm.texture.repeat':new mono.Vec2(200,1),
                 });
               // }
        }

        if(!(linkTemplate instanceof mono.PathNode) && (monoLink instanceof mono.PathNode)){
            monoLink.setStartCap('plain');
            monoLink.setEndCap('plain');
            monoLink.setRadius(radius);
            monoLink.s({
                'm.specularStrength': 30,
                'm.ambient': '#C6FEFA',
                'm.type': 'phong',
            });
        }
        monoLink._adjustTimes = 10;
        if (this.linkControlsFunction) {
            fromNode.updateWorldMatrix();
            toNode.updateWorldMatrix();
            var controls = this.linkControlsFunction(link, fromNode, toNode);
            monoLink.setLinkType('control');
            monoLink.setControls(controls);
        } else {
            var fromControls = monoLink.getFromControls();
            var toControls = monoLink.getToControls();
            var controls = [];
        }
        monoLink.setClient('id', link.getId());
        monoLink.setClient(it.SceneManager.CLIENT_IT_DATA, link);
        this.linkMap[link.getId()] = monoLink;
        monoLink.setVisible(false);  //对于it.Link加载进来后都隐藏，只有需要显示时自己控制着将其显示
        this.network3d.getDataBox().add(monoLink);
    },

    _getControlPoint : function(dataOrId,exprObject){
       exprObject  = exprObject || {};
       var x = this._getControlNumber(dataOrId,exprObject.x,'x');
       var y = this._getControlNumber(dataOrId,exprObject.y,'y');
       var z = this._getControlNumber(dataOrId,exprObject.z,'z');
       return new mono.Vec3(x,y,z);
    },

    _getControlNumber : function (dataOrId,expr,axis) {
        if(!expr){
          return 0;
        }
        var data0 = dataOrId.getId ? dataOrId : this.dataManager.getDataById(dataOrId);
        var reg = /\$(p|P)\d/g;
        var $ps = expr.match(reg);
        var scope = {};
        var self = this;

        for(var i = 0;i < $ps.length;i ++){
           var $p = $ps[i];
           var num = $p.toLowerCase().replace("$p",'');
           var node = self.getNodeByDataOrId(getParent(num,data0));
           scope[$p] = self._wrapBoundingBox(node);
        }
        function getParent(level,data){
            if(level == 0){
               return data;
            }
            var parent = self.dataManager.getParent(data);
            if(!parent){
              return data;
            }else{
               return getParent(level - 1,parent);
            }
        }
        var text = " with (scope) {  return " + expr + "}";
        var myFunction = new Function('scope', text);  
        try{
          var value = myFunction(scope); 
          return value;
        }catch(e){
           console.error(e);
        }
        return 0;
    },

    _wrapBoundingBox : function(node){
        var boundingBox = node.getBoundingBox();
        boundingBox.front = function(value){
           value = value || 0;
           return node.frontWorldPosition(this.max.z + value).z;
        };
        boundingBox.top = function(value){
           value = value || 0;
           return node.worldPosition(new mono.Vec3(0,1,0),this.max.y + value).y;
        };
        return boundingBox
    },

    isLink : function(node){
        if(node && node.getClient(it.SceneManager.CLIENT_IT_DATA)
            && node.getClient(it.SceneManager.CLIENT_IT_DATA) instanceof $Link){
            return true;
        }
        return false;
    },

    getLinkNodeById : function (linkOrId){
        var linkId = linkOrId;
        if (linkOrId instanceof it.Link) {
            linkId = linkOrId.getId();
        }
        return this.linkMap[linkId];
    },

    dwRootScene: function(data, category) {  //可能有多个datacenter  by--loda 2017-11-30
        var self = this;
        var children = data.getChildren()._as;
        if (!children.length) {
            return false;
        } else {
            for(var i=0;i<children.length;i++){
                var childCty = self.dataManager.getCategoryForData(children[i]);
                var childCtyId = childCty.getId();
                if(category == childCtyId)return false;
            }
            return true;
        }      
    },

    _loadRootScene : function(){
        var dm = this.dataManager;
        var rootScene = dm.getRootScene();
        var self = this;
        var callback = function(){
          var rootData = null;
          if (rootScene) {
             var rootCategoryId = rootScene.getCategoryId();
             var dataMap = dm.getDataMapByCategory(rootCategoryId);
             for (var id in dataMap) {
                rootData = dataMap[id];
                var bo = self.dwRootScene(rootData, rootCategoryId);
                if (!bo)continue;
                break;
             }
          }
           self._loadOneScene(rootScene, rootData);
           if (self._currentRootNode) {
             // self.viewManager3d.setFocusNode(self._currentRootNode);
             self.setFocusNode(self._currentRootNode); // 2017-08-11
           }
        }
        this.beforeLoadSceneAnimate(rootScene,null,null,null,callback,this);
    },

    clearCustomSceneView : function(){
      if (!this.sceneViewMap) {
         return ;
      }
      for(var cid in this.sceneViewMap){
        var sv = this.sceneViewMap[cid];
        if (sv && sv.getContainer() && this.mainView.contains(sv.getContainer())) {
           this.mainView.removeChild(sv.getContainer());
        } 
      }
    },

    /**
     * 用于处理GPU占用内存不释放的问题，当场景多并且大时，不断的切换会使得浏览器崩溃
     * 记录当前状态下的textutes
     */
    _saveTextures : function(){
        if(!this.isClearCache) {
          return ;
        }
        this._textures = {};
        var self = this;
        this.network3d.getDataBox().forEach(function (data) {
             data.material 
             && data.material.materials 
             && data.material.materials.forEach(function(material) {
               material.uniformsList && material.uniformsList.forEach(function(uniform) {
                  if (uniform[0].type === 't' && uniform[0].value) {
                      self._textures[uniform[0].value.id] = true;
                  } else if (uniform[0].type === 'tv' 
                          && uniform[0].value 
                          && uniform[0].value.length) {
                     console.log(uniform[0].value);
                  }
               });
           });
      });
    },
    
    /**
     * 用于处理GPU占用内存不释放的问题，当场景多并且大时，不断的切换会使得浏览器崩溃
     * 清除_saveTextures下textures
     */
    _clearTextures : function(){
        if(!this._textures || !this.isClearCache) {
          return ;
        }
        var self = this;
        Object.keys(this._textures).forEach(function(t) {
            self.network3d._gl.deleteTexture(self.network3d.pm.glTextureMap[t]);
            delete self.network3d.pm.glTextureMap[t];
        });
        Object.keys(this._textures).forEach(function(id) {
           self.network3d.pm.textureUpdateFlags[id] = true;
        });
    },
    
    
    _loadOneScene : function(scene,rootData,callback,clientMap){
        if (!this.beforeLoadScene(scene, rootData,clientMap)) {
            return;
        }
        this._saveTextures(); //记录切换前的textures，好在切换后清除它
        this.setSceneCamera(scene); //切换前先设置其参数
        this.setSceneNetworkAndLight(scene);
        var oldScene = this._currentScene;
        var oldRootData = this.getNodeData(this._currentRootNode);
        var dm = this.dataManager;
        var categoryId = scene.getCategoryId();
        var sceneType = scene.getSceneType(), level;
        var is2d = scene.getTwod();
        var withGis = scene.getWithGis();
        if (sceneType == "ShowSelf") {
            level = 0;
        } else if (sceneType === "ShowSelfAndChildren" || sceneType === "ShowChildren") {
            level = 1;
        } else if(sceneType === "ShowThird"){
            level = 2;
        } else {
            level = 100;
        }
        if(this.earthScene){
          this.earthScene.clear();
        }
        this.clearCustomSceneView();
        this._currentScene = scene;
         var sceneView = this.sceneViewMap[scene.getId()];
        if (sceneView) { // 自定义的场景视图
            if (sceneView.getContainer()) {
                this.network3d.getRootView().style.display = 'none';
                this.viewManager2d.getContainer().style.display = 'node';
                this.mainView.appendChild(sceneView.getContainer());
                sceneView.show(rootData);
                callback && callback();
            } else {
                callback && callback();
                //都自定义了，view都换了，
                // onloadfinish(setAllParentRelationShip、translateAllPosition、loadLinks、resetCamera)没有啥用
                // 除非view还是那个View3D
                // 但是：父子关系和位置信息还是需要设置的，这些流程在自定义视图中处理吧！！！。
            // this.afterLoadScene(scene, rootData, oldScene, oldRootData); //都得调用
            }
            this._currentRootData = rootData; 
            if (sceneView.isLoadData()) {
               this._loadSceneData(rootData, sceneType, level, is2d); //这里创建好的对象都
            }
            if (is2d) {
                this._currentRootNode = this.dataNode2DMap[rootData.getId()];
            } else {
                this._currentRootNode = this.dataNodeMap[rootData.getId()];
            }
            this._onLoadFinish(scene, rootData, oldScene, oldRootData,clientMap);
            this.afterLoadScene(scene, rootData, oldScene, oldRootData,clientMap);
            return;
        } else if (this._currentScene.getTwod()) {
            if (!this.viewManager2d) {
               console.log('need install viewManager2d model!');
               return;
            }
            if (withGis) {
                this.viewManager2d.addGis(true, true);
            } else {
                this.viewManager2d.removeGis();
            }
            if (this._currentScene.zoomLevel) {
                this.viewManager2d.setZoomLevel(this._currentScene.zoomLevel);
            }
            if (this._currentScene.center) {
                this.viewManager2d.setCenter(this._currentScene.center);
            }
            this.network3d.getRootView().style.display = 'none';
            this.viewManager2d.getContainer().style.display = 'block';
        }else if(withGis){ //3D并且with GIS ,这时我们就认为是3D地球了
            if(!this.earthScene){
                this.earthScene = this.createDefaultEarthScene(scene);
                if (!this.earthScene) {
                   return;
                }
                this._currentRootData = rootData; 
                setTimeout(function(){
                    if (self.earthScene && self._currentScene === self.earthScene.scene) { // 延迟了1秒，有在此期间已经跳到了其他的场景
                      self.earthScene.doPlay();
                    }
                },1000);
            }else{
                this._currentRootData = rootData; 
                this.earthScene.refresh();
            }
            if (this.viewManager2d) {
               this.viewManager2d.getContainer().style.display = 'none';
            }
            this.network3d.getRootView().style.display = 'block';

            if(this.earthScene && this.earthScene.rootData){
               this._currentRootNode = this.dataNodeMap[this.earthScene.rootData.getId()];
            }else{
                this._currentRootNode = null;
            }
            this.viewManager3d.setFocusNode(null); // 到了地球场景，focus置为null 2017-10-12
            
            if (callback) {
                callback();
            }
            this.resetCamera(scene, rootData,oldScene,oldRootData,clientMap);//镜头还是统一管理，否则各个地方的动画设置没用--2016-10-27
            this.afterLoadScene(scene, rootData,oldScene,oldRootData,clientMap);
            // var self = this;
            /* 为了统一 2017-07-13 ，还是用上data上的相关参数  */
            this.setAllParentRelationShip(scene,rootData);
            this.translateAllPosition();
            // if (this.viewManager2d) {
            //    this.viewManager2d.getContainer().style.display = 'none';
            // }
            // this.network3d.getRootView().style.display = 'block';
            
            return; // 3D地球中处理了其孩子的创建，并且network和camera什么的都由其自己管理 --2016-05
            // 这里直接返回了，联position、rotation等参数都没有使用data中的.但是回来时又将被设置，因为切换到其他场景时，会全部设置一番 -- 2017-07-13
        } else {
            if (this.viewManager2d) {
               this.viewManager2d.getContainer().style.display = 'none';
            }
            this.network3d.getRootView().style.display = 'block';
        }

        if (rootData == null) {
            var dataMap = dm.getDataMapByCategory(categoryId);
            this.network3d.getDataBox().startBatch();
            for (var id in dataMap) {
                this._currentRootData = dataMap[id]; //有可能rootData没有对应3DNode
                this._loadSceneData(dataMap[id], sceneType, level, is2d);
                this._currentRootNode = this.dataNodeMap[id];
                // 放到_loadSceneData前面 否则创建node的change中判断rootData不对 -- add By Kevin 2017-05-16
                // this._currentRootData = dataMap[id]; //有可能rootData没有对应3DNode
            }
        } else {
            this._currentRootData = rootData; // 当场景showChild时，那_currentRootNode就不会创建
            this.network3d.getDataBox().startBatch();
            this._loadSceneData(rootData, sceneType, level, is2d);
            //如果是2d，并且是lazyable时，通过搜索树直接跳过去的话，那3D的对象很有可能没有加载出来
            //因此改成如果是2D的话，rootNode就是twaver 2D的node
            if (is2d) {
                this._currentRootNode = this.dataNode2DMap[rootData.getId()];
            } else {
                this._currentRootNode = this.dataNodeMap[rootData.getId()];
            }
            // 放到_loadSceneData前面 否则创建node的change中判断rootData不对 -- add By Kevin 2017-05-16
            // this._currentRootData = rootData; // 当场景showChild时，那_currentRootNode就不会创建 
        }
        if (callback) {
            callback();
        }
        if (this._currentScene.getTwod() && this.viewManager2d) {
            this.viewManager2d.showTable(this._currentScene);
            this.viewManager2d.showTree(this._currentScene);
            this.network2d.zoomOverview();
        }
//      var oldScene = this._currentScene;
        //颠倒一下，当设置好位置等信息后在调用afterLoadScene,
        // 否则在监听sceneChange时需要重新计算位置，调整镜头等loadFinishe中的东西，、
        // 如果不一致的话，非的设置timeout才能确保更改后的东西不被afterLoadScene中的操作覆盖
        this.network3d.getDataBox().endBatch();
        this._onLoadFinish(scene, rootData,oldScene,oldRootData,clientMap);
        this.afterLoadScene(scene, rootData,oldScene,oldRootData,clientMap);
    },

    afterCreateEarthScene : function(earthScene){

    },

    createDefaultEarthScene: function(scene) {
        if (!it.DefaultEarthScene) {
           console.log('  need include DefaultEarthScene!!!');
           return null;
        }
        var earthScene = new it.DefaultEarthScene(this, scene);
        earthScene.createDCBillboard = function(data) {
            return null
        };
        this.afterCreateEarthScene(earthScene);
        this._sceneManagerChangeDispatcher.fire({
               kind:'createDefaultEarthScene',
               data:earthScene
           });
        return earthScene;
    },

    // 可是如果scene中的根是lazyLoad呢(比如floor是lazyLoad，那么双击进入floor场景时)
    _loadSceneData : function(data,sceneType,level,is2d){
        var getChildTime = 0;
        var dm = this.dataManager;
        if (sceneType === "ShowChildren" && level === 1) {
        } else if(sceneType === "ShowDescendant" && level === 100){
          
        }else if(sceneType === "ShowSelfAndDescendant" && level === 100){ // 2017-10-11这种情况也应该加载根（不管根是不是lazy的）
           this.loadDataModel(data);
        }else {
            if (is2d) {  // 目前不支持同时显示2D和3D,并且2D不支持lazyload
                this.loadDataModel2D(data);
            } else {
                if (!dm.isLazyable(data)) {
                    this.loadDataModel(data);
                }
            }
        }
        if (level <= 0) {
            return;
        }
        var children = data.getChildren();//dm.getChildren(data);
        for (var i = 0; i < children.size(); i++){
            this._loadSceneData(children.get(i), sceneType, level - 1, is2d);
        }
    },

    _onLoadFinish : function(scene, rootData,oldScene,oldRootData,clientMap){
        this.setAllParentRelationShip(scene,rootData);
        this.translateAllPosition();
        this.loadLinks();
        this._clearTextures();// 释放GPU占用的内存
        this.resetCamera(scene, rootData,oldScene,oldRootData,clientMap);
        //设置该场景中的相关的参数，如3D时：灯光，network的背景色，镜头的角度等属性,包括场景的动画，目前这些东西都是共享的
        //这些动作其实可以通过添加一个sceneChangeListener来单独处理，放到了setSceneNetworkAndLight中
//        this.setSceneNetworkAndLight();
        this._loaded = true;
    },

    getSetMethod : function(key){
        var setMethod = 'set' + key.charAt(0).toUpperCase() + key.slice(1);
        return setMethod;
    },

    /**
     * 个图network3d的某个属性key设置value值
     * @param key
     * @param value
     */
    setNetworkValue : function(network3d,key,value){
        if(!key){
            return ;
        }
        var setMethod = this.getSetMethod(key);
        // var network3d = this.network3d;
        // var currentScene = this._currentScene;
        // var sceneView = this.sceneViewMap[currentScene.getId()];
        // if (sceneView && sceneView.getNetwork3D()) {
            // network3d = sceneView.getNetwork3D();
        // }
        if(network3d[setMethod] && (typeof(network3d[setMethod]) === 'function')){
            network3d[setMethod](value);
        }else{
            network3d[key] = value;
        }
    },

    /**
     * 根据scene中的defaultInteraction的参数设置默认交互的参数
     */
    setDefaultInteractionValue: function(scene) {
        if(!scene){
            return;
        }
        var defaultInteractionParameters = scene.defaultInteractionParameters;
        if (!defaultInteractionParameters) {
            return;
        }
        // var currentScene  = this._currentScene;
        var network3d = this.network3d;
        if (scene && this.sceneViewMap[scene.getId()] && this.sceneViewMap[scene.getId()].getNetwork3D()) {
            network3d = this.sceneViewMap[scene.getId()].getNetwork3D();
        }
        var df = network3d.getDefaultInteraction();
        if (defaultInteractionParameters) {
            for (var key in defaultInteractionParameters) {
                var setMethod = this.getSetMethod(key);
                var value = defaultInteractionParameters[key];
                if (df[setMethod] && (typeof(df[setMethod]) === 'function')) {
                   df[setMethod](value);
                } else {
                    df[key] = value;
                }
            }
        }
    },

    setCameraValue : function(camera,key,value){
      if(!key || !camera){
            return ;
        }
        // var camera = this.network3d.getCamera();
        // var currentScene  = this._currentScene;
        // var sceneView = this.sceneViewMap[currentScene.getId()];
        // if (sceneView && sceneView.getCamera()) {
        //    camera = sceneView.getCamera();
        // } 
        var setMethod = this.getSetMethod(key);
        if(camera[setMethod] && (typeof(camera[setMethod]) === 'function')){
          if (value instanceof Array && value.length ===3 ) {
            camera[setMethod](value[0],value[1],value[2]);
          }else{
            camera[setMethod](value);
          }
        }else if(key == 'target'){
          if (value instanceof Array && value.length ===3 ) {
            camera['lookAt'](value[0],value[1],value[2]);
          }
        }else{
            camera[key] = value;
        }
    },

    clearSceneNodeMap : function(){
        this._sceneNodeMap = {}; //用来存储当前场景的所有对象
        this._sceneNodes = [];
    },

    addToSceneNodeMap : function(data,node){
        if (!data || !node) {
            return  ;
        }
        this._sceneNodeMap[data.getId()] = node;
        this._sceneNodes.push(node);
    },

    /**
     * 设置该场景中的相关的参数，如3D时：灯光，network的背景色，镜头的角度等属性,包括场景的动画，目前这些东西都是共享的
     * @param scene
     */
    setSceneNetworkAndLight : function(scene){
        if(!scene){
            return null;
        }
        if(scene.getTwod()){ //如果是2D的话，那就设置2D的network
            return;
        }
        var networkParameters = scene.networkParameters;
        var lights = scene.lights;
        var animateParameters = scene.animateParameters;
        var network = this.network3d;
        var sceneView = this.sceneViewMap[scene.getId()];
        if (sceneView && sceneView.getNetwork3D()) {
          network = sceneView.getNetwork3D();
        } 
        this.viewManager3d.resetNetwork();//默认的设置，需要设置默认的都要通过viewManager来管理
        if(networkParameters){
            for(var pro in networkParameters){
               this.setNetworkValue(network,pro,networkParameters[pro]);
            }
        }
    },

    setSceneCamera : function(scene){
        this.viewManager3d.resetCamera();
        if(!scene){
            return null;
        }
        if(scene.getTwod()){ //如果是2D的话，那就设置2D的network
            return;
        }
        var camera = this.network3d.getCamera();
        var sceneView = this.sceneViewMap[scene.getId()];
        if (sceneView && sceneView.getCamera()) {
           camera = sceneView.getCamera();
        } 
        var cameraParameters = scene.cameraParameters;
        if(cameraParameters){
            for(var pro in cameraParameters){
               this.setCameraValue(camera,pro,cameraParameters[pro]);
            }
        }
    },

    _loadDataMap : function(dataMap){
        var dm = this.dataManager;
        for (id in dataMap) {
            var data = dataMap[id];
            if (!dm.isLazyable(data)) {
                this.loadDataModel(dataMap[id]);
            }
        }
        // 颠倒一下，当设置好位置等信息后在调用afterLoadScene,
        // 否则在监听sceneChange时需要重新计算位置，调整镜头等loadFinishe中的东西，、
        // 如果不一致的话，非的设置timeout才能确保更改后的东西不被afterLoadScene中的操作覆盖
        this._onLoadFinish();
        this.afterLoadScene();
    },
    
    /**
     * 场景切换时，重置镜头
     * 加上了一堆的参数，是为了重载扩展用
     * moveCameraCallback这个是镜头 
     * 这个方法在CameraManager中重写了
     */
    resetCamera : function(scene, rootData,oldScene,oldRootData,moveCameraCallback){
//      this.network3d.zoomEstimateOverview(30); //要不通过LookAt中的方式改进，要不直接去掉，反正进入到每个场景后都会重新计算
        if(this.resetCameraWhenSceneChange){
          if (this._currentRootNode) {
             this.viewManager3d.getDefaultEventHandler().lookAtNodeWithOutAnimate(this._currentRootNode);
          }else{
            this.network3d.zoomEstimateOverview(30);
          }
        }
        this.resetCameraWhenSceneChange = true; 
    },

    loadScene : function (){
        var dm = this.dataManager;
        var rootScene = dm.getRootScene();
        // if (!this.beforeLoadScene(rootScene)) {  // 在_loadRootScene中有执行
        //     return;
        // }
        if (rootScene) {
            this.loadPreRenderScene();
            return this._loadRootScene();
        }
        var dataMap = dm.getDataMap();
        this._loadDataMap(dataMap);
    },

    /**
     * 加载提前渲染的场景
     * 前提条件：
     *   1、必需有rootScene
     *   2、不是rootScene
     *   3、跟rootScene不是一个view(network)
     *   
     */
    loadPreRenderScene: function(callback) {
        var sceneMap = this.dataManager._sceneMap;
        var rootScene = this.dataManager.getRootScene();
        // var preLoadSceneMap = {};
        for (var id in sceneMap) {
            var scene = sceneMap[id];
            if (scene && scene != rootScene && scene.getPreRender() && !this.isSameView(scene, rootScene)) {
                // preLoadSceneMap[id] = scene;
                var level;
                var sceneType = scene.getSceneType();
                if (sceneType == "ShowSelf") {
                    level = 0;
                } else if (sceneType === "ShowSelfAndChildren" || sceneType === "ShowChildren") {
                    level = 1;
                } else if (sceneType === "ShowThird") {
                    level = 2;
                } else {
                    level = 100;
                }
                var sceneView = this.sceneViewMap[scene.getId()]
                if(sceneView && sceneView.getContainer()){
                    scene.getContainer().style.display = 'none';
                }else{
                   this.network3d.getRootView().style.display = 'none';
                   this.viewManager2d.getContainer().style.display = 'node';
                }
                var dataMap = this.dataManager.getDataMapByCategory(scene.getCategoryId());
                for(var key in dataMap){
                    var data = dataMap[key];
                    if (!data) {
                       continue;
                    }
                    if (data && data.getParentId() && !this.dataManager.getDataById(data.getParentId())) {
                       continue;
                    }
                    if (data.getChildren() && data.getChildren().size() <= 0) {
                       continue;
                    }
                    this._loadSceneData(data, sceneType, level, scene.getTwod());
                    // 设置sceneView中的镜头的默认起始位置：以免切到该场景
                    // this._onLoadFinish(scene, rootData,oldScene,oldRootData);
                    this.setFocusNode(this.getNodeByDataOrId(data)); // 有可能需要真假切换的，如dc，直接进去的话真的模型还没有load
                    this.lookAt(this.getNodeByDataOrId(data));
                }
            }
        }
        callback && callback();
    },

    isSameView : function(scene1,scene2){
        if(!scene1 || !scene2){
            return true;
        }
        if (scene1 == scene2) {
            return true;
        }
        var s1View = this.sceneViewMap[scene1.getId()],s2View = this.sceneViewMap[scene2.getId()]; 
        if (scene1.getTwod()) {
            s1View = this.network2d;
        }else if(s1View && s1View.getContainer()){ //自定义
            s1View = scene1.getContainer();
        }else{
            s1View = this.network3d;
        }

        if(scene2.getTwod()){
            s2View = this.network2d;
        }else if (s2View && s2View.getContainer()) { //自定义
            s2View = s2View.getContainer();
        }else{
            s2View = this.network3d;
        }

        if (s1View != s2View) {
            return false;
        }
        return true;
    },

    /**
     * 显示所有不可见的对象(这个“不可见”指的是，category中标记的是否可见)
     */
    showAllInvisibleData : function(){
        // this.viewManager3d.removeVisibleFilter(this.invisibleFilter); // 有可能还没有加载咧
       var categoryMap = this.dataManager._categoryMap;
       if (!categoryMap) {
          return false;
       }
       for(var id in categoryMap){
          this.setInvisibleDataByCategoryId(id,true);
       }
    },

    /**
     * 隐藏所有的不可见的对象(这个“不可见”指的是，category中标记的是否可见)
     */
    invisibleAllInvisibleData : function(){
       var categoryMap = this.dataManager._categoryMap;
       if (!categoryMap) {
          return false;
       }
       for(var id in categoryMap){
          this.setInvisibleDataByCategoryId(id,false);
       }
    },

    /**
     * 根据categoryId来显示/隐藏该category对应的对象(这个“不可见”指的是，category中标记的是否可见)
     * 注意：如果该category本来就是可见的，那就不做任何处理，这里只处理category.isVisible() == false的
     * 有可能这些data也没有加载，那此时是否需要加载它？
     */
    setInvisibleDataByCategoryId : function(categoryId,visible){
       if (!categoryId) {
         return;
       }
       var category = this.dataManager._categoryMap[categoryId];
       if (!category || category.isVisible()) {
         return;
       }
       var datas = this.dataManager.getDataMapByCategory(categoryId);
       if (!datas) {
          return;
       }
       // this.viewManager3d.addVisibleFilter(this.invisibleFilter);
       for(var id in datas){
         var data = datas[id];
         // this.invisibleFilter.setVisible(data,visible);
         if(!this.dataNodeMap[id] 
           && this.isCurrentSceneInstance(data)){ //如果是当前场景中的data，并且没有load过，这里就load一下
           this.loadOneData(data,true);//这个里面统一将data的Visible设置成了false
         }
         this.invisibleFilter.setVisible(data,visible); //要放到loadDataMode后面，
       }
       this.viewManager3d.clearVisibleMap();
       this.network3d.dirtyNetwork();
    },

    getAlarmManager:function(){
        return this._alarmManager;
    },

    addSceneManagerChangeListener : function(listener, scope, ahead) {
        this._sceneManagerChangeDispatcher.add(listener, scope, ahead);
    },
    removeSceneManagerChangeListener : function(listener, scope) {
        this._sceneManagerChangeDispatcher.remove(listener, scope);
    },

    addSeneChangeListener : function(listener, scope, ahead){
       this._sceneChangeDispather.add(listener,scope,ahead);
    },

    addSceneChangeListener : function(listener, scope, ahead){
        this._sceneChangeDispather.add(listener,scope,ahead);
    },

    removeSceneChangeListener : function(listener, scope){
       this._sceneChangeDispather.remove(listener,scope);
    },

    addSceneVirtualChangeListener : function(listener, scope, ahead){
        this._sceneVirtualChangeDispather.add(listener,scope,ahead);
    },

    removeSceneVirtualChangeListener : function(listener, scope){
       this._sceneVirtualChangeDispather.remove(listener,scope);
    },

    addSceneVisibleChangeListener : function(listener, scope, ahead){
        this._sceneVisibleChangeDispather.add(listener,scope,ahead);
    },

    removeSceneVisibleChangeListener : function(listener, scope){
       this._sceneVisibleChangeDispather.remove(listener,scope);
    },

    /**
     * 移除billboard
     * @param {mono.Billboard} board
     */
    removeBillboard : function (board) {
        board.setParent(null);
        this.getDataBox().remove(board);
    },

    /**
     * 移除所有billboard
     * @param dataId
     */
   /* removeAllBillboardByDataId:function(dataId){
        var data = this.dataManager.getDataById(dataId);
        this.removeAllBillboardByData(data);
    },
*/
    /**
     * 移除所有billboard
     * @param {it.Data} data
     */
  /*  removeAllBillboardByData : function (data) {
        var boards = data.boards;
        if(boards){
            for(var i=0;i<boards.length;i++){
                this.removeBillboard(boards[i]);
            }
        }
    },
*/
    /**
     * 创建一个空白的billboard
     * @param dataId
     * @param {width: 256,height: 128,radius: 16,arrowWidth: 16,arrowHeight: 16,bgColor: '#5B85B5'} args
     */
   /* createBillboardById:function(dataId, board){
        var node = this.dataNodeMap[dataId];
        this.getDataBox().add(board);
        var data = this.dataManager.getDataById(dataId);
        if(!data.boards){
            data.boards = [];
        }
        data.boards.push(board);
        return board;
    },
    */

    /**
     * 创建一个空白billboard
     * @param  {it.Data} data
     * @param {String} text
     * @param {Color} gbColor
     * @returns {mono.Billboard}
     */
    createBillboard : function (data, board) {
        return this.createTitleBillboardById(data.getId(),board);
    },

    /**
     * 创建一个文本billboard
     * @param  {it.Data} data
     * @param {String} text
     * @param {Color} gbColor
     * @returns {mono.Billboard}
     */
    createTextBillboard : function (data, text, gbColor) {
        return this.createTextBillboardById(data.getId(),text, gbColor);
    },

    /**
     * 创建一个文本billboard
     * @param  {it.Data} data
     * @param {String} text
     * @param {Color} gbColor
     * @returns {mono.Billboard}
     */
    createTextBillboardById : function (dataId, text, gbColor) {
        var node = this.dataNodeMap[dataId];
        var board = it.Util.createTextBillboardForNode(node, text, gbColor);
        this.getDataBox().add(board);
        return board;
    },

    /**
     * 创建一个空白的billboard
     * @param dataId
     * @param {width: 256,height: 128,radius: 16,arrowWidth: 16,arrowHeight: 16,bgColor: '#5B85B5'} args
     */
    createEmptyBillboardById:function(dataId, args){
        var node = this.dataNodeMap[dataId];
        var board = it.Util.createEmptyBillboardForNode(node, args);
        this.getDataBox().add(board);
        return board;
    },

    /**
     * 创建一个空白billboard
     * @param  {it.Data} data
     * @param {String} text
     * @param {Color} gbColor
     * @returns {mono.Billboard}
     */
    createEmptyBillboard : function (data, text, gbColor) {
        return this.createEmptyBillboardById(data.getId(),text, gbColor);
    },

    /**
     * 创建一个空白的billboard
     * @param dataId
     * @param {width: 256,height: 128,radius: 16,arrowWidth: 16,arrowHeight: 16,bgColor: '#5B85B5'} args
     */
    createTitleBillboardById:function(dataId, args){
        var node = this.dataNodeMap[dataId];
        var board = it.Util.createTitleBillboardForNode(node, args);
        this.getDataBox().add(board);
        return board;
    },

    /**
     * 创建一个空白billboard
     * @param  {it.Data} data
     * @param {String} text
     * @param {Color} gbColor
     * @returns {mono.Billboard}
     */
    createTitleBillboard : function (data, args) {
        return this.createTitleBillboardById(data.getId(),args);
    },

    /**
     * 将appObj的属性合并至orgObj中
     * @param orgObj
     * @param appObj
     */
    margeObject : function(orgObj,appObj){
        orgObj = orgObj || {};
        if(!appObj){
            return orgObj;
        }
        if(appObj instanceof Array){
            for(var i = 0 ; i <  appObj.length ;i++){
                var data = appObj[i];
                if(data.getId()){
                    orgObj[data.getId()] = data;
                }
            }
        }else if(appObj instanceof mono.List){
            for(var i = 0 ; i <  appObj.size() ;i++){
                var data = appObj.get(i);
                if(data && data.getId()){
                    orgObj[data.getId()] = data;
                }
            }
        }
        else{
            for(var dataId in appObj){
                if(dataId && appObj[dataId]){
                    orgObj[dataId] = appObj[dataId];
                }
            }
        }
        return orgObj;
    },

    /**
     *  获取当前场景的data，包括lazyload的data
     */
    getSceneDatas : function(rootData){
        rootData = rootData||this.getNodeData(this._currentRootNode);
        var rooDataAndScene = this.getSceneAndRootByData(rootData)||{};
        var scene = rooDataAndScene.scene || this._currentScene;
        var dm = this.dataManager;
        if (!scene) {
            return dm.getDataMap();
        }
        var categoryId = scene.getCategoryId();
        var sceneType = scene.getSceneType() || '';
        var datas = {};
        if (rootData) {
            datas[rootData.getId()] = rootData;
            if (sceneType === "ShowSelfAndChildren" || sceneType === "ShowChildren") {
                var children = rootData.getChildren();
                this.margeObject(datas, children);
            } else { // 获取这个data的子孙(不仅仅是孩子)
                var descendants = dm.getDescendants(rootData);
                this.margeObject(datas, descendants);
            }
        } else {
            var dataMap = dm.getDataMapByCategory(categoryId); // 还得考虑rootData，每个楼层都共用一个Scene呢
            if (!dataMap || sceneType == "ShowSelf") {
                return dataMap;
            }
            for (var dataId in dataMap) {
                var data = dataMap[dataId];
                if (data) {
                    datas[dataId] = data;
                    if (sceneType === "ShowSelfAndChildren" || sceneType === "ShowChildren") {
                        var children = data.getChildren();//dm.getChildren(data);
                        this.margeObject(datas, children);
                    } else { // 获取这个data的子孙(不仅仅是孩子)
                        var descendants = dm.getDescendants(data);
                        this.margeObject(datas, descendants);
                    }
                }
            }
        }
        return datas;
    },

    getSceneDataTypes: function(rootData) {
        var dataTypes = {};
        var currentSceneDatas = this.getSceneDatas(rootData);
        if (currentSceneDatas) {
            for (var dataId in currentSceneDatas) {
                var data = currentSceneDatas[dataId];
                if (data) {
                    var dataType = this.dataManager.getDataTypeForData(data);
                    dataTypes[dataType.getId()] = dataType;
                }
            }
        }
        return dataTypes;
    },

    getDatasByAncestorId : function(){

    },

    /**
     * 获取当前场景的根节点，注意，改节点有可能是2D的也有可能是3D的
     * @returns {*|it.SceneManager._currentRootNode}
     */
    getCurrentRootNode : function(){
        return this._currentRootNode;
    },


    getLinkData : function(linkNode){
        if(!linkNode){
            return null;
        }
        var link = linkNode.getClient(it.SceneManager.CLIENT_IT_DATA);
        if(link && (link instanceof $Link)){
            return link;
        }
        return null;
    },

     
    /**
     * 根据dataId删除场景中的node 
     * add by Kevin 
     * 2016-10-09
     */
    removeDataNodeByDataOrId : function(dataOrId){
       if (!dataOrId) {
         return;
       }
       var dataId = dataOrId;
       if (dataOrId instanceof it.Data){
         dataId = dataOrId.getId();
       }
       var box = this.network3d.getDataBox();
       var dataNode = this.getNodeByDataOrId(dataOrId);
       if (dataNode) {
         dataNode.setParent(null);
         delete this.dataNodeMap[dataId];
         box.removeByDescendant(dataNode);
         this._sceneManagerChangeDispatcher.fire({
               kind:'remove',
               data:dataNode
         });

       }
    },

    /**
     * 根据data看是否需要创建该data对应的3D对象
     * 使用场合:当动态的添加一个资产时(推送机制)
     * add by Kevin 
     * 2016-10-11
     * 需要先判断该data是不是当前场景中的对象
     */
    createNodeByDataOrId : function(dataOrId){
       if (!dataOrId 
           || !this.isCurrentSceneInstance(dataOrId)) {
          return;
       }
       var data = dataOrId;
       if (!(dataOrId instanceof it.Data)){
          data = this.dataManager.getDataById(dataOrId);
       }
       if (data) {
         this.loadDataModel(data);
         this.setParentRelationShip(data); // 需要算位置，add by Kevin 2016-11-17
         this.translatePosition(data);
       }
    },

    /**
     * 判断ancestorId是不是data的祖先
     * @param dataOrId
     * @param ancestorId
     */
    isAncestor : function(dataOrId,ancestorId,scope){
        var self = scope || this;
        if(!dataOrId || !ancestorId){
            return false;
        }
        var data = null;
        if(dataOrId instanceof $Data){
            data = dataOrId;
        }else{
            data = this.dataManager.getDataById(dataOrId);
        }
        if(!data){
            return false;
        }
        var ancestor = null;
        if (ancestorId instanceof $Data) {
           ancestor = ancestorId;
           ancestorId = ancestor.getId();
        }else{
           ancestor = this.dataManager.getDataById(ancestorId);
        }
        if(!ancestor){
            return false;
        }
        if(ancestor.getParentId() && ancestor.getParentId() === data.getId()){ //使之提前跳出
            return false;
        }
        if(data.getParentId()){
            if(data.getParentId() === ancestorId){
                return true;
            }else{
                return self.isAncestor(data.getParentId(),ancestorId,self);
            }
        }
        return false;
    },

    /**
     * 判断是不是在同一个Scene下，严格意义上来讲，往上找parent时，还要判断scene的sceneType
     */

     lastSceneFilter : function(data){
        return true;
     },

    /**
     * 获取data的"Scene实例"(Scene实例指的是rootData+Scene)
     * @param data
     * @param sceneMap
     * @param scope
     * @returns {*}
     */
    getLastSceneInstance : function(data,sceneMap,scope){
        var self = scope || this;
        sceneMap = sceneMap || self.dataManager._categorySceneMap;
        if(!data || !sceneMap){
            return null;
        }
        if (typeof(data) === 'string') { //支持dataid
           data = self.dataManager.getDataById(data);
        }
        if (!data) {
           return null;
        }
        var category = self.dataManager.getCategoryForData(data);
        if(category && sceneMap[category.getId()] && self.lastSceneFilter(data)){
            return {rootData:data , scene:sceneMap[category.getId()]};
        }else if(data && data.getParentId && data.getParentId()){
            var parent = self.dataManager.getDataById(data.getParentId());
            return self.getLastSceneInstance(parent,sceneMap,self);
        }
        return null;
    },

    /**
     * 根据Data获取Scene实例
     * @param data
     * @returns {*}
     */
    getSceneAndRootByData : function(data){
        if(!data){
            return null;
        }
        var sceneMap = this.dataManager._categorySceneMap;
        if(!sceneMap){
            return null;
        }
        return this.getLastSceneInstance(data,sceneMap);
    },

    /**
     * 判断该data或id是不是在当前场景下
     * 注意：有可能data存在于多个场景中，那都应该返回true
     * @param dataOrId
     * @isNearestScene 当前的场景是不是离它最近的场景，默认是否
     * @returns {boolean}
     */
    isCurrentSceneInstance : function(dataOrId,isNearestScene){
        if(!dataOrId){
            return false;
        }
        var data = dataOrId;
        if(!(data instanceof $Data)){
            data = this.dataManager.getDataById(data);
        }
        if(!data){
            return false;
        }
        var sceneMap = this.dataManager._categorySceneMap;
        if(!sceneMap){
            return true;
        }
        var currentScene = this._currentScene;
        if(!currentScene){
            // return true;
            return false ; // 返回ture，对于preRender来说可能会认为所有的子孙结点都在当前场景中
        }
        var currentRootData = this._currentRootData||this.getNodeData(this._currentRootNode); //add By Kevin 2017-05-16调换了一下
        if (!currentRootData) { // currentRootData都没有，有可能是没有创建好，直接返回false
            return false;
        }
        if(data == currentRootData){
            return true;
        }
        if (isNearestScene) {
            var lastSceneAndRootData = this.getLastSceneInstance(data);
            if(lastSceneAndRootData 
                && lastSceneAndRootData.rootData == currentRootData 
                && lastSceneAndRootData.scene == currentScene){
                return true;
            }else{
                return false;
            }
        }
        if(currentRootData && !this.isAncestor(data,currentRootData.getId())){
            return false;
        }
        var sceneType = currentScene.getSceneType();
        if (sceneType === "ShowSelf") {
            if (currentRootData.getId() == data.getId()) {
                return true;
            }else{
                return false;
            } //备注：20170329 可是存在一个问题，在earth场景时，判断dc是不是该场景时总是返回true，其实不管返回true或false都有道理，但是有时我需要判断是否进入下一层时就应该返回false，所以上面的isNearestScene得传
        } else if (sceneType === "ShowSelfAndChildren" || sceneType === "ShowChildren") { 
            if (currentRootData && (currentRootData.getId() == data.getId() 
                || currentRootData.getId() == data.getParentId())) {
                return true;
            }else{
                return false;
            }
        } else if(sceneType === "ShowThird"){
            if (currentRootData.getId() == data.getId() 
                || currentRootData.getId() == data.getParentId()) {
                return true;
            }
            var parentData = this.dataManager.getDataById(data.getParentId());
            if (parentData 
                && currentRootData.getId() == parentData.getParentId()) {
                return true;
            }
            return false;
        } else {
            return true;
        }
    },
    
    /**
     * 判断data是否在(scene,rootData)中
     * 
     */
    isSceneInstance : function(scene,rootData,data){
        if(!scene || !rootData || !data){
           return false;
        }
        if(rootData != data && !this.isAncestor(data,rootData.getId())){
            return false;
        }
        var rdCategory = this.dataManager.getCategoryForData(rootData);
        var dCategoty = this.dataManager.getCategoryForData(data);
        if (rdCategory 
          && rdCategory.getId().toLowerCase() == 'datacenter' 
          && dCategoty 
          && dCategoty.getId() == 'floor'){
            return true;
        }
        var sceneType = scene.getSceneType();
        if (!sceneType) {
           return false;
        }
        if (sceneType === "ShowSelf") {
            if (rootData.getId() == data.getId()) {
                return true;
            }else{
                return false;
            } //备注：20170329 可是存在一个问题，在earth场景时，判断dc是不是该场景时总是返回true，其实不管返回true或false都有道理，但是有时我需要判断是否进入下一层时就应该返回false，所以上面的isNearestScene得传
        } else if (sceneType === "ShowSelfAndChildren" || sceneType === "ShowChildren") { 
            if (rootData.getId() == data.getId() 
                || rootData.getId() == data.getParentId()) {
                return true;
            }else{
                return false;
            }
        } else if(sceneType === "ShowThird"){
            if (rootData.getId() == data.getId() 
                || rootData.getId() == data.getParentId()) {
                return true;
            }
            var parentData = this.dataManager.getDataById(data.getParentId());
            if (parentData 
                && rootData.getId() == parentData.getParentId()) {
                return true;
            }
            return false;
        } 
        return true;
    },

    /**
     * 判断该data是不是Scene的根节点
     * @param data
     */
    isSceneRootData : function(data){
        if(!data){
            return false;
        }
        var sceneMap = this.dataManager._categorySceneMap;
        if(!sceneMap){
            return false;
        }
        var category = this.dataManager.getCategoryForData(data);
        if(category && sceneMap[category.getId()]){
            return true;
        }
    },

   /*
    isTheSameSceneInstance : function(data1,data2){
        var sceneMap = this.dataManager._categorySceneMap;
        if(!sceneMap){ //如果scene都没有的话，那所有的对象都在同一个scene中
            return true;
        }
    },
    */

    getAlarmManagerClass:function(){
        return it.AlarmManager;
    },

    registerCustomSceneView: function(sceneId, customSceneView) {
        if (!sceneId || !customSceneView) {
            return;
        }
        if (!this.sceneViewMap) {
            this.sceneViewMap = {};
        }
        this.sceneViewMap[sceneId] = customSceneView;
    },

    deregisterCustomSceneView : function(sceneId){
       if (sceneId && this.sceneViewMap && this.sceneViewMap[sceneId]) {
         delete this.sceneViewMap[sceneId];
       }
    },

    adjustCustomSceneViewBounds : function(w,h,left,top){
        for(var sceneId in this.sceneViewMap){
            var sceneView = this.sceneViewMap[sceneId];
            if (sceneView) {
                sceneView.adjustBounds(w,h,left,top);
            }
        }
    },

    getCurrentSceneView : function(){
       if (this._currentScene) {
         return this.sceneViewMap[this._currentScene.getId()];
       }
       return null;
    },

    /**
     * 根据node获取该node所在的场景
     * 但是：1、存在同一个node在多个场景中的问题，这时就看该node是不是在当前场景中，如果是在当前场景中则返回当前场景视图，否则返回离它最近的那个场景视图
     *      2、node确保都创建
     */
    getSceneViewByNode : function(node){
        if (!node) {
            return null;
        }
        var scene = null;
        var data = this.getNodeData(node);
        if (this.isCurrentSceneInstance(data)) {
            scene = this._currentScene;
        }else {
            var sceneAndRootData = this.getSceneAndRootByData(data);
            if (sceneAndRootData && sceneAndRootData.scene) {
                scene = sceneAndRootData.scene;
            }
        }
        if (scene && this.sceneViewMap[scene.getId()]) {
            return this.sceneViewMap[scene.getId()];
        }else{
            return this.viewManager3d;
        }
    },

    getFocusNode : function(){
        return this._focusNode;
    },

    setFocusNode : function(node){
        this._focusNode = node;
        var sceneView = this.getSceneViewByNode(node);
        if (sceneView && sceneView.setFocusNode) {
            sceneView.setFocusNode(node);
        }
    },

    /**
     * 获取当前场景的镜头
     * 根据当前的场景视图来获取的
     */
    getCurrentCamera : function(){
       var scene = this._currentScene ;
       var sceneView = null;
       if (scene) {
           sceneView = this.sceneViewMap[scene.getId()];
       }
       if (sceneView) {
           if ('upload' == sceneView.getCamera()) { //如果返回unload，表示该场景没有镜头，返回null的话就表示跟内置的共用一个镜头
             return null;
           }else{
             return sceneView.getCamera();
           }
       }else{
           return this.network3d.getCamera();
       }
    },

    /**
     * lookAt
     * 外面的调用都从这里开始，内部根据node所在的view来做具体的分发
     * 目前内部没有做
     */
    lookAt : function(node, callback1) {
        var sceneView = this.getSceneViewByNode(node);
        if (sceneView) {
           this.viewManager3d.defaultEventHandler.lookAt(node,callback1);// 目前sceneView中没有做特别的处理，所以这里共用
        }else{
           this.viewManager3d.defaultEventHandler.lookAt(node,callback1);
        }
    }
    
});
// 用于管理运行时候的，动态更改材质的功能。

var $MaterialFilter =  function  (argument) {
	
}; 
it.MaterialFilter = $MaterialFilter;
mono.extend($MaterialFilter,Object,{
	filterMaterial : function(originalMaterial,filterdMaterial,node){
        return originalMaterial;
	},
});

var $VisibleFilter = function(arguments){

};

mono.extend($VisibleFilter,Object,{
    isVisible: function(node,data,network){
        return true;
    }
});

it.VisibleFilter = $VisibleFilter;

/**
* 灯光管理器
*/
var $LightManager = function(sceneManager){
	this.sceneManager = sceneManager;
	this.sceneLights = {};
	this.init();
};

mono.extend($LightManager,Object,{

	init:  function(){
		var self = this;
		this.sceneManager.addSceneChangeListener(function(eve){
			var scene = eve.data;
            self.setUpLights(scene);
		});
	},

	getDefaultLights: function() {
		var lights = {};
		var ambientLight = new mono.AmbientLight(0xFFFFFF);
		lights['a'] = ambientLight;
		var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
		pointLight.setPosition(10000, 10000, 10000);
		lights['p1'] = pointLight;
		var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
		pointLight.setPosition(-10000, 10000, -10000);
		lights['p2'] = pointLight;
		var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
		pointLight.setPosition(10000, 10000, -10000);
		lights['p3'] = pointLight;
		var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
		pointLight.setPosition(-10000, 10000, 10000);
		lights['p4'] = pointLight;
		var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
		pointLight.setPosition(0, 0, 10000);
		lights['p5'] = pointLight;
		var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
		pointLight.setPosition(0, 0, -10000);
		lights['p6'] = pointLight;
		var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
		pointLight.setPosition(10000, 0, 0);
		lights['p7'] = pointLight;
		var pointLight = new mono.PointLight(0xFFFFFF, 0.05);
		pointLight.setPosition(0, 0, -10000);
		lights['p8'] = pointLight;
		return lights;
	},

	setUpLights : function(sceneOrId){
		var lights = {};
		var id = sceneOrId;
		this.clearLights();
		if (sceneOrId instanceof it.Scene) {
			id = sceneOrId.getId();
		}
		if (!id || !this.sceneLights[id]) { //如果没有给场景设置灯光的话，那就使用默认的灯光
			lights = this.getDefaultLights();
		}else{
			lights = this.sceneLights[id];
		}
		var dataBox = this.sceneManager.network3d.getDataBox();
		for (var pro in lights) {
			var light = lights[pro];
			dataBox.add(light);
		}
	},

	clearLights : function(){
		var dataBox = this.sceneManager.network3d.getDataBox();
		var lights = [];
		for (var i = 0; i < dataBox.size(); i++) {
			var light = dataBox.getLights().get(i);
			if (light) {
				lights.push(light);
			};
		};
		for(var i = 0 ; i < lights.length ; i++){
			var light = lights[i];
			dataBox.remove(light);
		}
	},

	addSceneLight : function(light){ 
		if (!light) {
			return;
		}
		var sceneId = light.getSceneId();
		var lightId = light.getId();
		var lightObj = null;
		if (light.getType().toLowerCase().indexOf('am')>=0) {
			lightObj = new mono.AmbientLight(light.getColor());
		}else{
			lightObj = new mono.PointLight(light.getColor(),light.getIntensity()||1,light.getDistance()||0);
		    lightObj.setPosition(light.getPosition());
		}
		var allLights = this.sceneLights[sceneId];
		if (!allLights) {
           this.sceneLights[sceneId] = {lightId:lightObj}; 
		}else{
			allLights[lightId] = lightObj;
		}
	},

    /**
     * 移除场景中的某个light
    */
	removeSceneLight : function(light){
        if (!light) {
			return;
		}
		var sceneId = light.geSceneId();
		var lightId = light.getId();
		var lights = this.sceneLights[sceneId];
		if (lights){
			delete lights[lightId];
			// disparch...
		} 
	},

	addLightsFromJson : function(json){
		var jsonObjects = json;
       if(typeof json === "string"){
          jsonObjects = JSON.parse(json);
       }     
       var i = 0,len = jsonObjects.length;

       for(i = 0;i < len;i ++){
          var jsonObject = jsonObjects[i];
          var light = new $Light();
          light.fromJson(jsonObject);
          this.addSceneLight(light);
       }
	}


});


it.LightManager = $LightManager;
/**
 * 告警级别
 * @param value {number} 级别数值
 * @param name {string} 级别名称(缩写)
 * @param nickName {string} 级别别名
 * @param color {string} 颜色
 * @param displayName {string} 显示名称
 * @constructor
 */
it.AlarmSeverity = function (value, name, nickName, color, displayName) {
    it.Base.call(this);
    this.value = value;
    this.name = name;
    this.nickName = nickName;
    this.color = color;
    this.displayName = displayName;
};
mono.extend(it.AlarmSeverity, it.Base, {
    IT_Alarm_Severity: true,
});
(function () {
    var s = it.AlarmSeverity;
    s.severities = new mono.List();
    s._vm = {};
    s._nm = {};
    s._cp = function (s1, s2) {
        if (s1 && s2) {
            var v = s1.value - s2.value;
            if (v > 0) return 1;
            if (v < 0) return -1;
            return 0;
        }
        if (s1 && !s2) return 1;
        if (!s1 && s2) return -1;
        return 0;
    };
    s.forEach = function (callbackFunction, scope) {
        s.severities.forEach(callbackFunction, scope)
    };
    s.getSortFunction = function () {
        return s._cp;
    };
    s.setSortFunction = function (sortFunction) {
        s._cp = sortFunction;
        s.severities.sort(sortFunction);
    }
    s.add = function (value, name, nickName, color, displayName) {
        var severity = new s(value, name, nickName, color, displayName);
        s._vm[value] = severity;
        s._nm[name] = severity;
        s.severities.add(severity);
        s.severities.sort(s._cp);
        return severity;
    };
    s.remove = function (name) {
        var severity = s._nm[name];
        if (severity) {
            delete s._nm[name];
            delete s._vm[severity.value];
            s.severities.remove(severity);
        }
        return severity;
    };
    s.CRITICAL = s.add(500, "Critical", "C", '#FF0000');
    s.MAJOR = s.add(400, "Major", "M", '#FFA000');
    s.MINOR = s.add(300, "Minor", "m", '#FFFF00');
    s.WARNING = s.add(200, "Warning", "W", '#00FFFF');
    s.INDETERMINATE = s.add(100, "Indeterminate", "N", '#C800FF');
    s.CLEARED = s.add(0, "Cleared", "R", '#00FF00');
    s.isClearedAlarmSeverity = function (severity) {
        return severity ? severity.value === 0 : false;
    };
    s.getByName = function (name) {
        return s._nm[name];
    };
    s.getByValue = function (value) {
        return s._vm[value];
    };
    s.clear = function () {
        s.severities.clear();
        s._vm = {};
        s._nm = {};
    };
    s.compare = function (severity1, severity2) {
        return s._cp(severity1, severity2);
    }
})();
/**
 * 管理业务告警,不同于mono.Alarm,it.Alarm是针对与it.Data的
 * @param id {string} 告警id,全局唯一
 * @param dataId {string} 发生告警对象的id
 * @param {it.AlarmSeverity} severity 告警级别
 * @param alarmType {it.AlarmType} 告警类型
 * @param description {string} 告警描述
 * @constructor
 */
it.Alarm = function (id, dataId, alarmSeverity, description, dateTime) {
    it.Base.call(this);
    this._id = id;
    this._dataId = dataId;
    this._alarmSeverity = alarmSeverity || it.AlarmSeverity.CRITICAL;
    this._dateTime = dateTime;
    this._description = description;
    if (!this._alarmSeverity.IT_Alarm_Severity) {
        throw 'alarmSeverity is not it.AlarmSeverity'
    }
};

mono.extend(it.Alarm, it.Base, {
    ___accessor: ['alarmSeverity', 'alarmType', 'description', 'dateTime'],

    IT_Alarm: true,

    getId: function () {
        return this._id;
    },

    getDataId: function () {
        return this._dataId;
    },

    fromJson: function (json) {
        json = json || "";
        if (typeof json === 'string') {
            json = JSON.parse(json);
        }
        this._id = json.id;
        this._dataId = json.dataId;
        this._alarmSeverity = it.AlarmSeverity.getByName(json.level);
        this._dateTime = json.time;
        this._description = json.description;
    },

});
/**
 * 告警状态
 * 告警状态分为两部分:自身的告警,上浮的告警
 * selfHighestAlarmSeverity - 自身告警的最高级别
 * selfAlarmCount - 自身告警的数量
 * propagateHighestAlarmSeverity - 上浮告警的最高级别
 * propagateAlarmCount - 上浮告警的数量
 * highestAlarmSeverity - 告警最高级别, 比较自身告警的最高级别和上浮告警的最高级别
 * alarmCount - 告警数量, 自身的告警数量加上上浮的告警数量
 * @param data {it.Data} 数据的data
 * @constructor
 */
it.AlarmState = function (data) {
    it.Base.call(this);
    this._data = data;
    this._selfHighestAlarmSeverity = null;
    this._selfAlarmCount = 0;
    this._propagateHighestAlarmSeverity = null;
    this._propagateAlarmCount = 0;
    this._highestAlarmSeverity = null;
    this._alarmCount = 0;
};
mono.extend(it.AlarmState, it.Base, {

    ___accessor: ['selfHighestAlarmSeverity', 'selfAlarmCount', 'propagateHighestAlarmSeverity', 'propagateAlarmCount', 'highestAlarmSeverity', 'alarmCount'],
    IT_Alarm_Status: true,
    clear: function () {
        this._selfHighestAlarmSeverity = null;
        this._selfAlarmCount = 0;
        this._propagateHighestAlarmSeverity = null;
        this._propagateAlarmCount = 0;
        this._highestAlarmSeverity = null;
        this._alarmCount = 0;
    }
});

/**
 * 告警的容器，所有的告警会要增加到容器里面管理
 * 告警的基本思路:只做涉及到SDK本身的功能,业务上的需求留给用户扩展,例如:新增告警数量,已经确认的告警数量等跟SDK无关,留给用户自己实现
 * * 告警状态的显示:
 *  1,只有自身告警: 整体染色 + 显示billboard
 *  2,只有上浮告警: 边框变色 + 显示billboard
 *  3,自身和上浮告警: 整体染色(自身告警) + 边框软色(上浮告警) + 显示billboard(按照最高级别告警来显示)
 * 告警渲染: scene -> category -> dataType -> data
 * 参数it.DataManager, 在it.DataManager 里面会自动创建一个it.AlarmManager.
 * @extend Base
 * @param {it.DataManager} dataManager
 * @param {it.SceneManager} sceneManager
 * @constructor
 */
it.AlarmManager = function (dataManager, sceneManager) {
    it.Base.call(this);
    this._dataManager = dataManager;
    this._sceneManager = sceneManager;

    /**
     *
     * @type {mono.List} 所有告警列表
     * @private
     */
    this._alarmList = new mono.List();

    /**
     *
     * @type {{}} 所有告警集合key是告警id, vlaue是告警对象
     * @private
     */
    this._alarmMap = {};

    /**
     *
     * @type {{}} key是data的id, value是集合(mono.List),该data的所有告警
     * @private
     */
    this._dataAlarms = {};

    /**
     * 需要重新计算告警状态的数据集合
     * @type {Array}
     * @private
     */
    this._dirtyDataAlarmState = [];

    /**
     * 告警渲染的 billboard 列表
     * @type {{}}
     * @private
     */
    this._alarmBillboardMap = {};

    /**
     * 告警渲染的 node 列表
     * @type {{}}
     * @private
     */
    this._alarmNodeMap = {};

    /**
     * 告警渲染的烟雾列表
     * @type {{}}
     * @private
     */
    this._alarmSmokeMap = {};

    /**
     * 告警增删动作监听
     * @type {mono.EventDispatcher}
     * @private
     */
    this._alarmManagerChangeDispatcher = new mono.EventDispatcher();

    /**
     * 告警更新动作监听
     * @type {mono.EventDispatcher}
     * @private
     */
    this._alarmPropertyChangeDispatcher = new mono.EventDispatcher();

    this.renderType = it.AlarmManager.RENDER_TYPE_DEFAULT;

    this._sceneManager.addSceneManagerChangeListener(this.handleSceneManagerChange, this, true);
    this._dataManager.addDataManagerChangeListener(this.handleDataManagerChange, this, true);
    this.addAlarmPropertyChangeListener(this.handleAlarmPropertyChange, this, true);
    this.addAlarmManagerChangeListener(this.handleAlarmManagerChange, this, true);

    this.intervalId = '';  //烟雾动画定时器
};

it.AlarmManager.RENDER_TYPE_DEFAULT = 0; //默认渲染告警方式, 自身染色, 上浮显示 billboard
it.AlarmManager.RENDER_TYPE_PAINT = 1; //全部染色告警方式, 自身和上浮都染色, 上浮不显示 billboard
it.AlarmManager.RENDER_TYPE_PAINT_BILLBOARD = 2; //全部染色告警方式, 自身和上浮都染色, 上浮显示 billboard

/**
 *
 */
mono.extend(it.AlarmManager, it.Base, {
    __accessor: ['removeAlarmWhenDataIsRemoved'],

    _name: 'AlarmBox',

    /**
     * 去的所有告警
     * @param matchFunction 过滤函数, 返回true,添加到结果
     * @param scope 过滤函数作用域
     * @returns {mono.List} 返回告警集合
     */
    getAlarms: function (matchFunction, scope) {

        return this._alarmList.toList(matchFunction, scope);
    },

    /**
     * 计算dirty列表中的data的上浮告警
     * @private
     */
    _calculateDataPropagateAlarmState: function () {

        while (this._dirtyDataAlarmState.length > 0) {
            var data = this._dirtyDataAlarmState.pop();
            this.calculateDataPropagateAlarmState(data);
        }

    },

    _setDataAlarmStateDirty: function (data) {
        data['_alarmRenderDirty'] = true;
    },
    _clearDataAlarmStateDirty: function (data) {
        delete data['_alarmRenderDirty'];
    },
    _isDataAlarmStateDirty: function (data) {
        return data['_alarmRenderDirty'];
    },

    /**
     * 将data的父亲加入到dirty列表中,需要重新计算上浮告警
     * @param data
     * @private
     */
    _dirtyParentDataAlarmState: function (data, isSkipRender) {

        var parent = this._dataManager.getParent(data);
        if (parent) {
            var self = this;
            var alarmState = parent.getAlarmState();
            var alarmCount = alarmState.getSelfAlarmCount();
            // 2017-10-27 可是如果parent自己有告警呢，parent被skip了导致parent自己的告警有不渲染了
            if (alarmCount <= 0) {
                parent.isSkipRender = isSkipRender;
            }else{
                parent.isSkipRender = null;
            }
            clearTimeout(parent._dirtyParentTimerId);
            parent._dirtyParentTimerId = setTimeout(function() {
                self._dirtyDataAlarmState.push(parent);
                if (self._dirtyDataAlarmState) {
                    self._calculateDataPropagateAlarmState();
                }
            }, 10);
        } else if (this._dirtyDataAlarmState) {
            this._calculateDataPropagateAlarmState();
        }
    },

    /**
     * 计算一个data的自身告警状态,如果状态发生变化,会同步会触发计算parentData的上浮告警状态
     * @param data {it.Data} data
     */
    calculateDataAlarmState: function (data) {

        var alarmStateValue = this.getDataAlarmState(data);//自身告警的数量和最高级别
        var alarmState = data.getAlarmState();
        var alarmCount = alarmState.getSelfAlarmCount();
        var highestAlarmSeverity = alarmState.getSelfHighestAlarmSeverity();
        //如果自身告警数量和总的告警数量相等并且最高级别也相等, 说明没有告警变化
        if (alarmCount == alarmStateValue.alarmCount
            && it.AlarmSeverity.compare(alarmStateValue.highestAlarmSeverity, highestAlarmSeverity) == 0) {
            return;
        }
        alarmState.setSelfHighestAlarmSeverity(alarmStateValue.highestAlarmSeverity);
        alarmState.setSelfAlarmCount(alarmStateValue.alarmCount);
        //2017-10-27 可是如果parent自己有告警，parent就不skip了，有可能child的告警先来，parent的告警后来，由于先来时就将skiprender设置成TRUE
        if (alarmStateValue.alarmCount > 0) {
            data.isSkipRender = null;
        }
        this._calculateDataAlarmState(data);
        
        
        //自己或者孩子阻止了告警 
        var isSkipRender = this._dataManager.isStopAlarmPropagation(data) || data.isSkipRender;
        this._dirtyParentDataAlarmState(data, isSkipRender);

    },

    /**
     * 计算一个data的上浮告警状态,如果告警状态发生变化, 会同步会触发计算parentData的上浮告警状态
     * @param data
     */
    calculateDataPropagateAlarmState: function (data) {


        var children = this._dataManager.getChildren(data);
        var result = {
            highestAlarmSeverity: null,
            alarmCount: 0,
        };
        if (children) {
            for (var i = 0; i < children.length; i++) {
                var child = children[i];
                var alarmState = child.getAlarmState();
                result.alarmCount += alarmState.getAlarmCount();
                result.highestAlarmSeverity = this._getHighestAlarmSeverity(result.highestAlarmSeverity, alarmState.getHighestAlarmSeverity())
            }
        }
        var alarmState = data.getAlarmState();
        var alarmCount = alarmState.getPropagateAlarmCount();
        var highestAlarmSeverity = alarmState.getPropagateHighestAlarmSeverity();
        //if (alarmCount == result.alarmCount
        //    && it.AlarmSeverity.compare(result.highestAlarmSeverity, highestAlarmSeverity) == 0) {
        //    return;
        //}
        alarmState.setPropagateAlarmCount(result.alarmCount);
        alarmState.setPropagateHighestAlarmSeverity(result.highestAlarmSeverity);
        this._calculateDataAlarmState(data);

        
        //自己或者孩子阻止了告警 
        var isSkipRender = this._dataManager.isStopAlarmPropagation(data) || data.isSkipRender;
        this._dirtyParentDataAlarmState(data, isSkipRender);
    },


    /**
     * 计算节点上的总的告警
     * 告警数量等于自身告警加上上浮告警
     * 最高告警级别等于自身告警和上浮告警最高级别
     * @param alarmState
     * @private
     */
    _calculateDataAlarmState: function (data) {

        var alarmState = data.getAlarmState();
        var result = {
            highestAlarmSeverity: null,
            alarmCount: 0,
        };
        result.alarmCount = alarmState.getSelfAlarmCount() + alarmState.getPropagateAlarmCount();
        result.highestAlarmSeverity = this._getHighestAlarmSeverity(result.highestAlarmSeverity, alarmState.getSelfHighestAlarmSeverity())
        result.highestAlarmSeverity = this._getHighestAlarmSeverity(result.highestAlarmSeverity, alarmState.getPropagateHighestAlarmSeverity())
        alarmState.setAlarmCount(result.alarmCount);
        alarmState.setHighestAlarmSeverity(result.highestAlarmSeverity);
        this._setDataAlarmStateDirty(data);
        this.renderDataAlarm(data);
    },

    /**
     * 取得高级别的告警
     * @param severity1 {it.AlarmSeverity} severity1
     * @param severity2 {it.AlarmSeverity} severity2
     * @returns {it.AlarmSeverity} 返回severity1或者severity2
     * @private
     */
    _getHighestAlarmSeverity: function (severity1, severity2) {
        return it.AlarmSeverity.compare(severity1, severity2) > 0 ? severity1 : severity2;
    },

    renderDataAlarm: function (data) {
        //如果 isSkipRender=true, 并且不再强制渲染列表中, 跳过渲染过程
        if (data.isSkipRender && !this.isForceRenderData(data)) {
            return;
        }
        if (!this._sceneManager.isCurrentSceneInstance(data)) {
            this._setDataAlarmStateDirty(data);
            return;
        }
        var node = this._sceneManager.getNodeByDataOrId(data);
        if (!node && this._sceneManager.earthScene && this._sceneManager.earthScene.dataCenterNodeMap) {
            node = this._sceneManager.earthScene.dataCenterNodeMap[data.getId()]
        }
        if (node && this._isDataAlarmStateDirty(data)) {
            this._renderAlarm(data, node);
        } else if (!node) {
            this._setDataAlarmStateDirty(data);
        }
    },

    /**
     * 是否强制渲染 data
     * @param data
     * @returns {boolean}
     */
    isForceRenderData: function (data) {
        return false;
    },

    /**
     * 渲染告警
     * @param data {it.Data} data
     * @param node {mono.Data} node
     */
    _renderAlarm: function (data, node) {

        this._clearDataAlarmStateDirty(data);
        var scene = this._sceneManager.getCurrentScene();
        if (scene && scene.renderAlarm) {
            scene.renderAlarm(data, node);
            return;
        }
        var category = this._dataManager.getCategoryForData(data);
        if (category && category.renderAlarm) {
            category.renderAlarm(data, node);
            return;
        }
        var dataType = this._dataManager.getDataTypeForData(data);
        if (dataType && dataType.renderAlarm) {
            dataType.renderAlarm(data, node);
            return;
        }
        this.renderAlarm(data, node);
    },

    /**
     * 渲染告警
     * @param data
     * @param node
     */
    renderAlarm: function (data, node) {

        if (this.renderType == it.AlarmManager.RENDER_TYPE_PAINT) {

            //找到最高级别告警, 不区分是上浮还是自身
            var alarmState = data.getAlarmState();
            if (alarmState.getAlarmCount() > 0) {

                var alarmSeverity = alarmState.getHighestAlarmSeverity();
                this.paintDataColor(data, node, alarmSeverity);
            } else {

                this.clearDataColor(data, node);
            }
        } else if (this.renderType == it.AlarmManager.RENDER_TYPE_PAINT_BILLBOARD) {

            //找到最高级别告警, 不区分是上浮还是自身
            var alarmState = data.getAlarmState();
            if (alarmState.getAlarmCount() > 0) {

                var alarmSeverity = alarmState.getHighestAlarmSeverity();
                this.paintDataColor(data, node, alarmSeverity);
            } else {

                this.clearDataColor(data, node);
            }

            //上浮告警状态
            var parentData = this._dataManager.getParent(data);
            //如果parent为空,或者自身阻止了告警传播,并且总的告警数量大于0,那么显示或者更新告警billboard
            if (alarmState.getAlarmCount() > 0 && (!parentData || this._dataManager.isStopAlarmPropagation(data))) {

                this.showDataBillboard(data, node);
            } else if (this._alarmBillboardMap[data.getId()]) {
                this.hideDataBillboard(data, node);
            }
        } else {
            //自身告警状态
            var alarmState = data.getAlarmState();
            if (alarmState.getSelfAlarmCount() > 0) {

                this.paintDataColor(data, node);

                //增加烟雾效果 -- yxk
                this.createSmokeAlarm(data, node); 
            } else {

                this.clearDataColor(data, node);
                this.removeSmokeAlarm(data, node);
            }

            //上浮告警状态
            var parentData = this._dataManager.getParent(data);
            //如果parent为空,或者自身阻止了告警传播,并且总的告警数量大于0,那么显示或者更新告警billboard
            if (alarmState.getAlarmCount() > 0 && (!parentData || this._dataManager.isStopAlarmPropagation(data))) {

                this.showDataBillboard(data, node);
            } else if (this._alarmBillboardMap[data.getId()]) {
                this.hideDataBillboard(data, node);
            }
        }
    },

    createSmokeAlarm: function (data,node) {
        if (this._alarmSmokeMap[data.getId()]) {
            return;
        }
        var categoryId = this._dataManager.getCategoryForData(data).getId();
        if(categoryId != 'smoke')return;

        // var node = this._sceneManager.getNodeByDataOrId(data);
        var alarms = this.getAlarmsByDataOrId(data);
        if (alarms) {
            alarms = alarms._as;
            // var highest = -1, color, hasSmoke = false;
            for(var i=0; i<alarms.length;i++){
                alarm = alarms[i];
                if (alarm.alarmTypeId == 'smoke') {
                    var smokeNode = this.addSmoke(node, alarm._alarmSeverity.color);
                    smokeNode.setClient(it.SceneManager.CLIENT_IT_DATA, data);
                    smokeNode.setClient(it.SceneManager.CLIENT_IT_DATA_ID, data.getId());
                    this._alarmSmokeMap[data.getId()] = smokeNode;
                    this.startSmokeAnimation(this._alarmSmokeMap);
                    break;
                }
            }
            // alarms.forEach(function (alarm) {
            //     if (alarm.alarmTypeId == 'smoke') {
            //         hasSmoke = true;
            //         if(alarm._alarmSeverity.value>highest){
            //             highest = alarm._alarmSeverity.value;
            //             color = alarm._alarmSeverity.color;
            //         }
            //     }
            // }, this);
            // if(hasSmoke){
            //     var smokeNode = this.addSmoke(node, color);
            //     this._alarmSmokeMap[data.getId()] = smokeNode;
            //     this.startSmokeAnimation(data,smokeNode);
            // }
            
        }
    },
    //创建烟雾node
    createSmokeNode: function (color) {
        var smoke = new mono.Particle();
        var count = 200;
        for (var j = 0; j < count; j++) {
            smoke.vertices.push(new mono.Vec3());
        }
        smoke.verticesNeedUpdate = true;
        smoke.sortParticles = false;
        smoke.setStyle('m.size', 20);
        smoke.setStyle('m.color', color);
        smoke.setStyle('m.depthTest', false);
        smoke.setStyle('m.transparent', true);
        smoke.setStyle('m.opacity', 0.6);
        smoke.setClient('_alarmParticle', 'true');
        smoke.setStyle('m.texture.image', 'data:image/png;base64,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');
        return smoke;
    },

    //为烟感添加烟雾
    addSmoke: function (node, color) {
        var smoke = this.createSmokeNode(color);
        smoke.setParent(node);
        var bBox = node.getBoundingBox();
        var height = bBox.max.y - bBox.min.y;
        smoke.p(0, height * 3, 0);
        this._sceneManager.network3d.dataBox.add(smoke);
        return smoke;
    },
    updateSmoke: function (smokeNodeMap) {
        var network = this._sceneManager.network3d;
        return function () {
            for (var dataId in smokeNodeMap) {
                var smokeNode = smokeNodeMap[dataId];
                if (smokeNode.isVisible()) {
                    var count = smokeNode.vertices.length;
                    for (var i = 0; i < count; i++) {
                        var point = smokeNode.vertices[i];
                        point.y = Math.random() * 200;
                        point.x = Math.random() * point.y / 2 - point.y / 4;
                        point.z = Math.random() * point.y / 2 - point.y / 4;
                    }
                    smokeNode.verticesNeedUpdate = true;
                }
            }
            network.dirtyNetwork();
        }
    },
    startSmokeAnimation: function (smokeNodeMap) {
        this.removeSmokeAnimation();
        var arr = Object.keys(smokeNodeMap);
        if (arr.length == 0) {
            return;
        }
        var intervalId = setInterval(this.updateSmoke(smokeNodeMap), 100);
        this.intervalId = intervalId;
    },
    removeSmokeAlarm: function (data) {
        var smokeNode = this._alarmSmokeMap[data.getId()];
        if (!smokeNode) {
            return;
        }
        smokeNode.setParent(null);
        this._sceneManager.network3d.dataBox.remove(smokeNode);
        delete this._alarmSmokeMap[data.getId()];
        this.startSmokeAnimation(this._alarmSmokeMap);
    },
    removeSmokeAnimation: function () {
        if (this.intervalId) {
            clearInterval(this.intervalId);
        }
    },

    /**
     * 染色
     */
    paintDataColor: function (data, node, alarmSeverity) {

        if (node.getClient('complexNode')) {
            node = node.getClient('complexNode') != 'unload' && node.getClient('complexNode').getParent() ? node.getClient('complexNode') : node.getClient('simpleNode');
        }
        var alarmState = data.getAlarmState();
        var alarmSeverity = alarmSeverity || alarmState.getSelfHighestAlarmSeverity();
        this._setNodeAlarmEffect(node, alarmSeverity);
        this._alarmNodeMap[node.getId()] = node;

        //同步到孩子, 例如机柜门
        var children = node.getChildren();
        var length = children.size();
        for (var i = 0; i < length; i++) {
            var childTemp = children.get(i);
            if (childTemp.getClient('modelParent')) {
                this._setNodeAlarmEffect(childTemp, alarmSeverity);
                this._alarmNodeMap[childTemp.getId()] = childTemp;
            }
        }
    },

    /**
     * 染色
     */
    clearDataColor: function (data, node) {

        if (node.getClient('complexNode')) {
            node = node.getClient('complexNode') != 'unload' && node.getClient('complexNode').getParent() ? node.getClient('complexNode') : node.getClient('simpleNode');
        }
        //判断是否已经染色, 如果没有染色, 直接跳过
        if (!node.getStyle('alarm.m.ambient')) {
            return;
        }
        this._clearNodeAlarmEffect(node);
        delete this._alarmNodeMap[node.getId()];

        var children = node.getChildren();
        var length = children.size();
        for (var i = 0; i < length; i++) {
            var childTemp = children.get(i);
            if (childTemp.getClient('modelParent')) {
                this._clearNodeAlarmEffect(childTemp);
                delete this._alarmNodeMap[childTemp.getId()];
            }
        }
    },

    showDataBillboard: function (data, node) {

        var alarmState = data.getAlarmState();
        var alarmSeverity = alarmState.getHighestAlarmSeverity();
        var color = null;
        if (alarmSeverity) {
            color = alarmSeverity.color;
        }
        var alarmBillboard = null;
        if (this._alarmBillboardMap[data.getId()]) {
            alarmBillboard = this._alarmBillboardMap[data.getId()]
        } else {
            alarmBillboard = this._sceneManager.createEmptyBillboardById(data.getId());
            this.initAlarmBillboard(alarmBillboard, data);
            this._alarmBillboardMap[data.getId()] = alarmBillboard;
        }
        alarmBillboard.setStyle('m.texture.image', mono.ImageCache.AlarmBillboardImage);
        alarmBillboard.setStyle('m.color', color);
        alarmBillboard.setStyle('m.alignment', mono.BillboardAlignment.bottomCenter);
        this._setAlarmBillboardPositionAndSize(node, alarmBillboard);
    },

    hideDataBillboard: function (data, node) {

        this._sceneManager.removeBillboard(this._alarmBillboardMap[data.getId()]);
        delete this._alarmBillboardMap[data.getId()];
    },

    /**
     * 初始化 告警 billboard
     * @param billboard
     * @param data
     * @returns {*}
     */
    initAlarmBillboard: function (billboard, data) {
        billboard.setClient('_alarmBillboard', data);

        // 把机柜的告警billboard放到机柜的node上面去，方便后面取用
        // 2017.12.29 add by lyz
        var node = this._sceneManager.getNodeByDataOrId(data);
        node.setClient('_alarmBillboard', billboard);
    },

    _setAlarmBillboardPositionAndSize: function (node, alarmBillboard) {
        var position = node.getStyle('alarm.billboard.position');
        var boundingBox = node.getBoundingBox();
        var min = boundingBox.min;
        var max = boundingBox.max;
        var center = boundingBox.center();
        var size = boundingBox.size();
        if (position === 'topLeft') {
            alarmBillboard._position.set(min.x, max.y, center.z + 1);
        } else if (position === 'topRight') {
            alarmBillboard._position.set(max.x, max.y, center.z + 1);
        } else if (position === 'topBack') {
            alarmBillboard._position.set(center.x, max.y, min.z - 1);
        } else if (position === 'topFront') {
            alarmBillboard._position.set(center.x, max.y, max.z + 1);
        } else {
            alarmBillboard._position.set(center.x, max.y, center.z + 1);
        }

        var scale = node.getStyle('alarm.billboard.scale');
        if (scale instanceof mono.Vec3) {
            alarmBillboard._scale.copy(scale);
        } else {
            alarmBillboard._scale.set(size.x / 2, size.x / 2, 1);
        }

        var vertical = node.getStyle('alarm.billboard.vertical');
        alarmBillboard.setStyle('m.vertical', vertical);
    },

    _setNodeAlarmEffect: function (node, alarmSeverity) {
        //备份之前的状态
        var oldColor = node.getStyle('alarm.m.ambient') || node.getStyle('m.ambient');
        var color = alarmSeverity ? alarmSeverity.color : oldColor;
        node.setStyle('m.ambient', color);
        node.setStyle('m.color', color);
        node.setStyle('alarm.m.ambient', oldColor);
    },

    _clearNodeAlarmEffect: function (node) {
        var color = node.getStyle('alarm.m.ambient');
        node.setStyle('m.ambient', color);
        node.setStyle('m.color', color);
        node.setStyle('alarm.m.ambient', null);
    },

    /**************************  alarm begin *******************************/


    _add: function (alarm) {
        this._alarmList.add(alarm);
        this._alarmMap[alarm.getId()] = alarm;
        var alarms = this._dataAlarms[alarm.getDataId()];
        if (!alarms) {
            alarms = this._dataAlarms[alarm.getDataId()] = new mono.List();
        }
        alarms.add(alarm);
    },

    _remove: function (alarm) {
        this._alarmList.remove(alarm);
        delete this._alarmMap[alarm.getId()];
        var alarms = this._dataAlarms[alarm.getDataId()];
        if (alarms) {
            alarms.remove(alarm);
        }
        if (alarms.size() == 0) {
            delete this._dataAlarms[alarm.getDataId()];
        }
    },

    /**
     * 取得告警
     * @param alarmOrId {string|it.Alarm} 告警或告警id
     * @returns {it.Alarm}
     */
    getAlarm: function (alarmOrId) {
        if (!alarmOrId) {
            return null;
        }
        var alarm = null;
        if (alarmOrId.IT_Alarm) {
            alarm = this._alarmMap[alarmOrId.getId()];
        } else {
            alarm = this._alarmMap[alarmOrId];
        }
        return alarm;
    },


    /**
     * 增加告警
     * @param {it.Alarm} alarm 告警对象
     */
    add: function (alarm) {
        if (!alarm) {
            throw 'alarm is null or undefined'
        }
        if (!alarm.getId()) {
            throw 'alarm`s id is empty'
        }
        if (!alarm.getDataId()) {
            throw 'alarm`s dataId is empty'
        }
        if (!alarm.IT_Alarm) {
            throw "alarm`s class is not it.Alarm";
        }
        var a = this._alarmMap[alarm.getId()];
        if (a) {
            throw 'alarm`s id repeat';
        }
        //如果data为空,不做强制校验,等data增加时再处理
        var d = this._dataManager.getDataById(alarm.getDataId())
        if (!d) {
            alarm.error = 'data is not exist';
            console.warn(alarm.error)
        }
        this._add(alarm);
        this._alarmManagerChangeDispatcher.fire({
            kind: 'add',
            data: alarm
        });
        alarm.addPropertyChangeListener(this.handleAlarmDataPropertyChange, this);
    },

    /**
     * 通过json创建alarms
     * @param json
     */
    addAlarmFromJson: function (json) {

        var jsonObjects = $Util.toJsonArray(json);
        var i = 0, len = jsonObjects.length;
        for (; i < len; i++) {
            var jsonObject = jsonObjects[i];
            var alarm = new it.Alarm();
            alarm.fromJson(jsonObject);
            this.add(alarm);
        }
    },

    /**
     * 删除告警
     * @param {string|it.Alarm} alarm对象或者告警id
     * return alarm
     */
    remove: function (alarmOrId) {
        if (!alarmOrId) {
            throw 'alarmOrId is null or undefined'
        }
        var alarm = null;
        if (alarmOrId.IT_Alarm) {
            alarm = this._alarmMap[alarmOrId.getId()]
        } else {
            alarm = this._alarmMap[alarmOrId]
        }
        if (!alarm) {
            console.warn('alarm is not exist');
            return;
        }
        this._remove(alarm);
        alarm.removePropertyChangeListener(this.handleAlarmDataPropertyChange, this);
        this._alarmManagerChangeDispatcher.fire({
            kind: 'remove',
            data: alarm
        });
        return alarm;
    },

    clear: function () {
        var list = this._alarmList.toList();
        this._alarmList.clear();
        this._alarmMap = {};
        this._dataAlarms = {};
        this._dirtyDataAlarmState = [];
        this._alarmManagerChangeDispatcher.fire({
            kind: 'clear',
            datas: list
        });
        return list;
    },
    /**************************  alarm end *******************************/

    /**************************  data begin *******************************/

    /**
     * 根据数据或者id取得所有相关告警
     * @param dataOrId 数据或着id
     * @returns {*|mono.List}
     */
    getAlarmsByDataOrId: function (dataOrId) {

        if (!dataOrId) {
            return [];
        }
        var dataId = dataOrId;
        if (dataOrId.IT_Data) {
            dataId = dataOrId.getId();
        }
        return this._dataAlarms[dataId];
    },

    /**
     * 根据数据或者id移除所有相关告警
     * @param dataOrId 数据或着id
     */
    removeAlarmsByDataOrId: function (dataOrId) {

        var alarms = this.getAlarmsByDataOrId(dataOrId);
        if (alarms) {
            alarms = alarms.toList();
            alarms.forEach(this.remove, this);
        }
        return alarms;
    },

    /**
     * 根据告警或者id取得相关数据
     * @param alarmOrId {string|it.Alarm}  告警或者id
     * @returns {it.Data}
     */
    getDataByAlarmOrId: function (alarmOrId) {

        var alarm = this.getAlarm(alarmOrId);
        if (!alarm) {
            return null;
        }
        var dataId = alarm.getDataId();
        return this._dataManager.getDataById(dataId);
    },

    /**
     *  取的数据自身的的告警状态, 数量和最高级别
     * @param data
     * @returns {{highestAlarmSeverity: null, alarmCount: number}}
     */
    getDataAlarmState: function (data) {
        var result = {
            highestAlarmSeverity: null,
            alarmCount: 0,
        };
        var alarms = this.getAlarmsByDataOrId(data);
        if (alarms) {
            result.alarmCount = alarms.size();
            alarms.forEach(function (alarm) {
                if (!result.highestAlarmSeverity) {
                    result.highestAlarmSeverity = alarm.getAlarmSeverity();
                } else {
                    var severity = alarm.getAlarmSeverity();
                    if (it.AlarmSeverity.compare(severity, result.highestAlarmSeverity) > 0) {
                        result.highestAlarmSeverity = severity;
                    }
                }
            })
        }
        return result;
    },

    /**************************  data end *******************************/



    /**************************  alarm change handler begin *******************************/
    /**
     * 告警的增删，同步data对象上的告警状态
     * @param e
     */
    handleAlarmManagerChange: function (e) {
        if (e.kind === 'add') {
            var alarm = e.data;
            var data = this._dataManager.getDataById(alarm.getDataId());
            if (data) {
                var self = this;
                clearTimeout(data._calculateTimerId);
                data._calculateTimerId = setTimeout(function () {
                  self.calculateDataAlarmState(data);
                },100);

            }
        } else if (e.kind === 'remove') {
            var alarm = e.data;
            var data = this._dataManager.getDataById(alarm.getDataId());
            if (data) {
                var self = this;
                // clearTimeout(data._calculateTimerId);
                // data._calculateTimerId = setTimeout(function () {
                self.calculateDataAlarmState(data);
                // })
            }
        } else if (e.kind === 'clear') {

            //清除的所有告警
            var alarms = e.datas;
            if (alarms && alarms.size() > 0) {
                //找到所有dataId
                var dataArr = this._dataManager.getDatas();
                if (dataArr && dataArr.length > 0) {
                    var len = dataArr.length;
                    //清除告警标记
                    for (var i = 0; i < len; i++) {
                        var data = dataArr[i];
                        var state = data.getAlarmState();
                        if (state.getAlarmCount()) {
                            state.clear();
                        }
                    }
                }
                for (var id in this._alarmBillboardMap) {
                    this._sceneManager.removeBillboard(this._alarmBillboardMap[id]);
                }
                this._alarmBillboardMap = {};
                for (var id in this._alarmNodeMap) {
                    this._clearNodeAlarmEffect(this._alarmNodeMap[id]);
                }
                this._alarmNodeMap = {};
                for (var id in this._alarmSmokeMap) {
                    var data = this.sceneManager.dataManager.getDataById(id);
                    this.removeSmokeAlarm(data);
                }
                this._alarmSmokeMap = {};
            }
        }
    },


    /**
     * 告警的属性变化 FIXME
     * @param e
     */
    handleAlarmDataPropertyChange: function (e) {
        this._alarmPropertyChangeDispatcher.fire(e);
    },
    /**
     * 告警的属性变化处理：级别，确认状态，清除状态
     * @param e
     */
    handleAlarmPropertyChange: function (e) {
        var alarm = e.source;
        if (e.property === "alarmSeverity") {
            var data = this._dataManager.getDataById(alarm.getDataId());
            if (data) {
                this.calculateDataAlarmState(data);
            }
        }
    },
    /**************************  alarm change handler end *******************************/

    /**************************  data change handler begin *******************************/
    /**
     * 数据的变更
     * 传入的是node
     * @param e
     */
    handleDataManagerChange: function (e) {
        if (e.kind === 'add') {
            //排除掉先加告警,后加data,告警无法加载的情况
            this.calculateDataAlarmState(e.data);
        } else if (e.kind === 'remove') {
            //清除data的告警
            var data  = e.data
            this.removeAlarmsByDataOrId(data);
            //自己或者孩子阻止了告警
            var isSkipRender = this._dataManager.isStopAlarmPropagation(data) || data.isSkipRender;
            this._dirtyParentDataAlarmState(data, isSkipRender);
        } else if (e.kind === 'clear') {
            //FIXME dataManager暂时没有`clear`方法
            //for (var dataId in dataIds) {
            //    var data = this._dataManager.getDataById(dataId);
            //    if (data) {
            //        data.getAlarmState().clear();
            //    }
            //}
            ////清除所有告警
            //this.clear();
        }
    },

    /**************************  data change handler end *******************************/

    /**************************  scene change handler begin *******************************/
    /**
     * 场景变更
     * 传入的参数是node
     * @param e
     */
    handleSceneManagerChange: function(e) {
        var self = this;
        if (e.kind === 'add') {
            var node = e.data;
            var data = this._sceneManager.getNodeData(node);
            // setTimeout(function () {
            self.renderDataAlarm(data);
            // }, 10)
        } else 
        if (e.kind === 'change') {
            var node = e.data;
            var data = this._sceneManager.getNodeData(node);
            // var data = e.rootData;
            if (data) {
                this._setDataAlarmStateDirty(data);
                this.renderDataAlarm(data);
            }
        }
    },

    /**************************  scene change handler end *******************************/



    addAlarmManagerChangeListener: function (listener, scope, ahead) {
        this._alarmManagerChangeDispatcher.add(listener, scope, ahead);
    },

    removeAlarmManagerChangeListener: function (listener, scope) {
        this._alarmManagerChangeDispatcher.remove(listener, scope);
    },
    addAlarmPropertyChangeListener: function (listener, scope, ahead) {
        this._alarmPropertyChangeDispatcher.add(listener, scope, ahead);
    },

    removeAlarmPropertyChangeListener: function (listener, scope) {
        this._alarmPropertyChangeDispatcher.remove(listener, scope);
    },


    /**
     * 实时计算高级功能数量
     * 找到所有的孩子, 遍历累加,比较耗时.
     * @param data
     * @returns {number}
     */
    getAlarmCountNow: function (data) {


        if (!data) {
            return 0;
        }
        var result = this._dataManager.getDescendants(data);
        if (!result) {
            return 0;
        }
        var count = 0;
        result.forEach(function (item) {
            count += item.getAlarmState().getSelfAlarmCount();
        })
        return count;
    }
});
/**
 * 告警上浮的控制.
 * 每一次上浮增加一个dirty标记.如果上浮到了父亲,那么父亲的父亲dirty置位,需要继续计算.
 * 判断是否有dirty节点,继续计算.
 * 告警上浮原理
 * 同步告警状态到节点上: 告警的增删改,告警状态的变化,数据的增删改,场景变化
 * 告警的增删改,告警状态变化 - 同步告警状态
 * 数据的增删改 - 删除数据时,触发删除告警动作(触发同步告警)
 * 场景变化 - 监听node变化,同步告警状态
 * @param {it.DataManager} dataManager
 * @param {it.SceneManager} sceneManager
 * @param {it.AlarmManager} alarmManager
 * @constructor
 *
 */
it.AlarmStatePropagator = function (dataManager, sceneManager, alarmManager) {
    this._dataManager = dataManager;
    this._sceneManager = sceneManager;
    this._alarmManager = alarmManager;
    this.dataBox = alarmManager.dataBox;
    this.alarmBox = alarmManager.alarmBox;
    mono.AlarmStatePropagator.call(this, this.dataBox, 'alarmState');
    this.dataBox.setAlarmStatePropagator(this);
    this.childrenAlarms = [];
};

mono.extend(it.AlarmStatePropagator, mono.AlarmStatePropagator, {

    propagateToTop: function (data) {
        //for (var i = 0; i < this.childrenAlarms.length; i++) {
        //    this.alarmBox.remove(this.childrenAlarms[i]);
        //}
        //this.childrenAlarms = [];
        var result = true;
        result = this.propagateToParent(null, data);
        while (data && data.getParent() && result !== false) {
            result = this.propagateToParent(data, data.getParent());
            data = data.getParent();
        }
    },

    propagateToParent: function (child, parent) {
        var childData = child == null ? null : it.SceneManager.getNodeData(child);
        var parentData = parent == null ? null : it.SceneManager.getNodeData(parent);
        if (!parentData) {
            return false;
        }
        return this.dataPropagateToParent(childData, parentData, child, parent);
    },


    dataPropagateToParent: function (childData, parentData, child, parent) {
        return this.dataPropagateToParentForRoom(childData, parentData, child, parent);
    },


    dataPropagateToParentForRoom: function (childData, parentData, child, parent) {
        //判断child已经阻止了上浮，禁止一切后续动作
        if (this.isStop(childData)) {
            return false;
        }

        if (!parentData.getAlarmState) { // 对于link没有AlarmState
            return false;
        }

        if (parent.getClient('modelParent')) {
            parent = parent.getClient('modelParent')
        }

        //清除旧的上浮告警，否则getHighestOverallAlarmSeverity会干扰
        parentData.getAlarmState().setPropagateSeverity(null);
        parent.getAlarmState().setPropagateSeverity(null);
        var result = parentData.getAlarmState().getHighestOverallAlarmSeverity();
        var children = parentData.getChildren();//this.dataManager.getChildren(parentData);
        var length = children.size();
        for (var i = 0; i < length; i++) {
            var childDataTemp = children.get(i);
            var severity = childDataTemp.getAlarmState().getHighestOverallAlarmSeverity();
            if (it.AlarmSeverity.compare(severity, result) > 0) {
                result = severity;
            }
        }
        //设置新的上浮告警级别
        //如果是机柜,加到孩子里面
        parentData.getAlarmState().setPropagateSeverity(result);
        if (parent.getClient('complexNode')) {
            var target = parent.getClient('complexNode')!='unload'&&parent.getClient('complexNode').getParent() ? parent.getClient('complexNode') : parent.getClient('simpleNode');
            target.getAlarmState().setPropagateSeverity(result);
        }


        this.modelChildAlarmSyn(childData, parentData, child, parent);

        //判断是否需要继续上浮
        var parentDataType = parentData == null ? null : this.dataManager.getDataTypeForData(parentData);
        if (!parentDataType) {
            return false;
        }
        if (parentDataType.isStopAlarmPropagationable()) {
            return false;
        }
        var parentCategory = this.dataManager.getCategoryForData(parentData);
        if (!parentCategory) {
            return !parentDataType.isStopAlarmPropagationable();
        }
        if (parentCategory.isStopAlarmPropagationable()) {
            return false;
        }
        return true;
    },

    isStop: function (childData) {
        if (childData) {
            var childDataType = this.dataManager.getDataTypeForData(childData);
            if (childDataType) {

                if (childDataType.isStopAlarmPropagationable()) {
                    return true;
                }
                var childCategory = this.dataManager.getCategoryForData(childData);
                if (childCategory && childCategory.isStopAlarmPropagationable()) {
                    return true;
                }
            }
        }
        return false;
    },

    modelChildAlarmSyn: function (childData, parentData, child, parent) {
        if (parent.getClient('complexNode')) {
            parent = parent.getClient('complexNode')!='unload'&&parent.getClient('complexNode').getParent() ? parent.getClient('complexNode') : parent.getClient('simpleNode');
        }
        var children = parent.getChildren();
        var length = children.size();
        var parentNativeSeverity = parent.getAlarmState().getPropagateSeverity();
        for (var i = 0; i < length; i++) {
            var childTemp = children.get(i);
            if (childTemp.getClient('modelParent')) {
                var alarmId = 'child_alarm_' + childTemp.getId();
                if (parentNativeSeverity) {
                    var alarm = this.alarmBox.getDataById(alarmId);
                    if (!alarm) {
                        alarm = new mono.Alarm(alarmId, childTemp.getId(), parentNativeSeverity);
                        this.alarmBox.add(alarm);
                    } else {
                        alarm.setAlarmSeverity(parentNativeSeverity);
                    }
                    childTemp.getAlarmState().setPropagateSeverity(parentNativeSeverity);
                } else {
                    this.alarmBox.removeById(alarmId);
                    childTemp.getAlarmState().setPropagateSeverity(null);
                }
            }
        }
    }
});


/**
 * 此类是EventHandler的一个默认的实现，其实现功能如下：
 * 1、鼠标点击某个对象时，镜头会移过去；
 * 2、点击空白处回到上一级；
 * 3、点击地板镜头移过去；
 * 4、对于虚化的对象都不可点中；
 * 5、对于透明的对象，不去处理dblclick事件；
 */

var $DefaultEventHandler = function (sceneManager){ // 这个类用户可以重载实现自己的逻辑；
	$EventHandler.call(this);
    this.sceneManager = sceneManager;
    this.dataManager = sceneManager.dataManager;
    if(!sceneManager){
        console.log('sceneManager can not be null!');
    }
    this.mode = "lookat"; // lookat move,
    this.filterFunction = null;
    this.defaultPostion = null;
    this.defaultTarget = null;
    this.defaultLookAtDistance = 2000;
    this.lookAtDistanceFunction = null;
    this.isLookAtFunction = null;
    this.afterLookAtFunction = null;
    this.afterLookAtFinishedFunction = null;
    this._afterLookAtListener = []; //通过注册lister比通过重写afterLookAtFunction要更合理一点，特别是有多个实现的话
    this._afterLookAtFinishedListener = [];//镜头移动好后执行,比重写afterLookAtFinishedFunction
    this.box3d = sceneManager.network3d.getDataBox();
    this.withOutAnimate = false;
    this.lookAtWithOutMoveCamera = true; // 调用lookAt时是不是移动镜头(这里比较拗)，也就是只是处理setFocus的动作。因为有的动作双击过去不想移动镜头
    this.handleDoubleClickBackgroundFunction = null;
    this.cameraInfoStack = [];
};

mono.extend($DefaultEventHandler,$EventHandler,{
    
    setDefaultPositionAndTarget : function(position,target){
        this.defaultPostion = position;
        this.defaultTarget = target;
    },

    getDefaultVirtual : function(){
       return this.sceneManager.viewManager3d.getDefaultVirtualMaterialFilter();
    },

    setMode : function(mode){//lookat, move
        this.mode = mode;
    },

    getCamera : function(node){
        var sceneView = this.sceneManager.getSceneViewByNode(node);
        if (sceneView && sceneView.getCamera && sceneView.getCamera()) {
            return sceneView.getCamera();
        }else{
            return this.sceneManager.network3d.getCamera();
        }
    },

    /**
     * 是否是需要俯视，否则的话是正视，默认的是，如果boundingBox中某一边超过1000时就俯视
     * @param node
     * @returns {boolean}
     */
    isLookAtWithAngle : function(node){
        if (!node) {
            return false;
        }
        var bb = it.Util.getBoundingBox(node);
        // if(node && node.getBoundingBox()){
        //     var boundingBox = node.getBoundingBox();
        //     if(boundingBox.max.x - boundingBox.min.x > 500
        //         || boundingBox.max.y - boundingBox.min.y > 500
        //         || boundingBox.max.z - boundingBox.min.z > 500){
        //         return true;
        //     }
        // }
        var data = this.sceneManager.getNodeData(node);
        var category = this.sceneManager.dataManager.getCategoryForData(data);
        if (category && category.getId() == 'building') { // 有些建筑很小 -- 2017-07-06
            return true;
        }
        if (bb && (bb.size().x > 500 || bb.size().y > 500 || bb.size().z > 500)) {
            return true;
        }
        return false;
    },

    /**
     * 计算lookAt3D对象的最佳距离
     * 注意：得考虑scale，因为scale后，boudingbox的size并不会做相应的scale
     *  withOutScale为true时不考虑Scale，否则考虑，因此默认的情况下都会考虑scale
     * 需要考虑到fov
    */
    getElementPerfectDistance : function(node,withOutScale){
        if (!node) {
            return 100;
        }
        if(withOutScale == true){
            withOutScale = true;
        }else{
            withOutScale = false;
        }
        var camera = this.getCamera(node); // 17-08-11 this.sceneManager.network3d.getCamera();
        var h = 100;
        // var bb = node.getBoundingBox();//20160914
        var bb = it.Util.getBoundingBox(node); // update 2017-07-06 
        // var bb = node.getBoundingBoxWithChildren();
        if (bb) {
            var d_y = bb.max.y - bb.min.y;
            var d_x = bb.max.x - bb.min.x;
            var d_z = bb.max.z - bb.min.z; // 加上Z分量 add 2017-09-08 Kevin
            if(!withOutScale){
                d_y = d_y * node.getScaleY();
                d_x = d_x * node.getScaleX();
            }
            if (d_y > d_x) {
                h = d_y;
            } else {
                h = d_x;
            }
            if (d_z > h) {
                h = d_z;
            }
        }
        var l = h / (2 * Math.tan(camera.fov * Math.PI / 180 / 2));
        var offset = this.getElementPerfectDistanceOffset(node);
        l += offset;
        return l;
    },

    getElementPerfectDistanceOffset : function(node){
        return 50;
    },

    getElementPerfectFrontPositionOffsetY : function(node){
        var data = this.sceneManager.getNodeData(node);
        var category = this.dataManager.getCategoryForData(data);
        if (category && category.getId() == 'equipment') {
            return 0;
        }
        return 20;
    },

    getElementPerfectFrontPosition : function(node){
        if (!node) return null;
        var l = this.getElementPerfectDistance(node);
        if (l < 100) {
            l = 100;
        }

        // 2017-11-02 由于node的建模的中心坐标可能并不是其真正的中心点，特别是对于roon，用node.frontWorldPositions算的总是不正确
        // var perfectPosition = node.frontWorldPosition(l); //都改成正视
        var nodeCenter = this.getNodeCenterPosition(node);
        var distance = l > 0 ? l : 1;
        var perfectPosition = nodeCenter.add(node.frontDirection().multiplyScalar(distance));
        var offsetY = this.getElementPerfectFrontPositionOffsetY(node) || 0;
        perfectPosition.y = perfectPosition.y + offsetY; 
        return perfectPosition;
    },

    /**
     * 是中心点的正前方，很多情况下，3D对象自身的中心点不是其原点
     * @param node
     * @param v 表示的是有俯视的角度，如果为空就表示正视，且正前方
     * @returns {*}
     */
    getElementPerfectFrontPositionForNodeCenterPosition : function(node,withAngle){
        if (!node) return null;
        var l = this.getElementPerfectDistance(node);
        if (l < 100) {
            l = 100;
        }
//        var perfectPosition = node.frontWorldPosition(l); //都改成正视
//        perfectPosition.y = perfectPosition.y + 20;
//        return perfectPosition;
        var pos = this.getNodeCenterPosition(node);
        var v = null;
        if(withAngle == undefined){
            withAngle = true;
        }
        if(withAngle){
            v = new mono.Vec3(0, 1, 2); //俯视30度
        }
        if(v){
            return pos.add(node.direction(v).multiplyScalar(l));
        }else{
            return pos.add(node.frontDirection().multiplyScalar(l));
        }
    },

    /**
     * 获取node的中心点，有些时候position并不是其真正的中心点，有可能对象自身的坐标并不是从中间开始的
     * 并且要注意缩放的情况，因为不管是否缩放，boundingBox的大小是不变的，所以的*Scale
     * 注意：如果像pathNode这样的对象，path完全用的是世界坐标，那这样算出来的中心点（其实是没有错的）
     * @param node
     * @returns {position}
     */
    getNodeCenterPosition : function(node){
        if(!node) return null;
        // var boundingBox = node.getBoundingBox(); // update 20160914
        var boundingBox = it.Util.getBoundingBox(node);  // update 2017-07-06 
        // var boundingBox = node.getBoundingBoxWithChildren();
        var offx = 0;
        var offy = 0;
        var offz = 0;
        if (boundingBox && boundingBox.max && boundingBox.min) {
            offx = (boundingBox.max.x + boundingBox.min.x)/2*node.getScaleX();
            offy = (boundingBox.max.y + boundingBox.min.y)/2*node.getScaleY();
            offz = (boundingBox.max.z + boundingBox.min.z)/2*node.getScaleZ();
        }
        var position = node.getWorldPosition();
        position.setX(position.x + offx);
        position.setY(position.y + offy); 
        position.setZ(position.z + offz);
        return position;
    },

    getCameraPositionForLookAt: function(node) {
        var h = this.getElementPerfectDistance(node); 
        // 2017-11-02 有可能node的坐标原点不是其中心点，特别是对应区域、房间这样的对象
        // return node.worldPosition(new mono.Vec3(0, 1, 2), h); 
        var nodeCenter = this.getNodeCenterPosition(node);
        return nodeCenter.add(node.direction(new mono.Vec3(0, 1, 2)).multiplyScalar(h));
    },

    getCameraTargetAndPositionByNode : function(node){
        return null;
    },

    /**
     * 移动镜头看某个node
     */
    moveCameraForLookAtNode: function(node, callback, offset) {
        if (!node) return;
        var camera = this.getCamera(node); // 17-08-11 this.sceneManager.network3d.getCamera();
        var tarAngPos = this.getSavedCameraInfoByNode(node)||this.getCameraTargetAndPositionByNode(node);
        var target = null;
        var f_position = null;
        if (tarAngPos && tarAngPos.target && tarAngPos.position) {
            target = tarAngPos.target;
            f_position = tarAngPos.position;
        } else {
            var w_p = this.getNodeCenterPosition(node);
            if (!w_p) {
                w_p = new mono.Vec3(0, 0, 0);
            }
            var bb = it.Util.getBoundingBox(node); // update 2017-07-06
            target = new mono.Vec3(w_p.x, w_p.y, w_p.z);
            f_position = this.getElementPerfectFrontPosition(node);
            if (this.isLookAtWithAngle(node)) {
                var h = this.getElementPerfectDistance(node); //如果旋转了则有问题
                // f_position = node.worldPosition(new mono.Vec3(0, 1, 2), h); //4000
                f_position = this.getCameraPositionForLookAt(node);
                if (bb && (bb.max.y + bb.min.y) != 0) { //像pathNode这样的管道，建模的中心点与其自身的中心点差太多时
                    f_position.y = f_position.y + (bb.max.y + bb.min.y) / 2
                }
                var datalX = 0,
                    datalZ = 0;
                if (node.getRotationY()) {
                    datalX = h * Math.sin(node.getRotationY());
                }
                f_position.x = target.x + datalX; // 对应lookAt楼层对象，可能会有些歪，这是因为楼层的主对象的中心点的问题，其实应该以地板为标准
            }
            if (offset) {
                f_position.x += offset.x;
                f_position.y += offset.y;
                f_position.z += offset.z;
            }
        }

        function callbackWrap() {
            // adjustBounds();
            if (callback) {
                callback();
            }
        };

        it.Util.playCameraAnimation(camera, f_position, target, 1500, callbackWrap);

    },

    /**
     * 直接调整好镜头的位置，没有动画(如场景加载完后马上设置位置，还有就是中间计算过程中)
     * @param node
     */
    lookAtNodeWithOutAnimate: function(node) {
        if (!node) return;
        if (!(node instanceof mono.Element)) {
            return;
        }
        var camera = this.getCamera(node); // 17-08-11 this.sceneManager.network3d.getCamera();
        var cameraTarAndPos = this.getSavedCameraInfoByNode(node) || this.getCameraTargetAndPositionByNode(node);
        if (cameraTarAndPos && cameraTarAndPos.target && cameraTarAndPos.position) {
            camera.setPosition(cameraTarAndPos.position.x, cameraTarAndPos.position.y, cameraTarAndPos.position.z);
            camera.lookAt(cameraTarAndPos.target.x, cameraTarAndPos.target.y, cameraTarAndPos.target.z);
        } else {
            var w_p = this.getNodeCenterPosition(node);
            if (!w_p) {
                w_p = new mono.Vec3(0, 0, 0);
            }
            var f_position = this.getElementPerfectFrontPosition(node);
            if (this.isLookAtWithAngle(node)) {
                var h = this.getElementPerfectDistance(node); //如果旋转了则有问题
                f_position = node.worldPosition(new mono.Vec3(0, 1, 1), h); //4000
                var datalX = 0,
                    datalZ = 0;
                if (node.getRotationY()) {
                    datalX = h * Math.sin(node.getRotationY());
                    datalZ = h * (1 - Math.cos(node.getRotationY()));
                }
                f_position.x = w_p.x + datalX; // 对应lookAt楼层对象，可能会有些歪，这是因为楼层的主对象的中心点的问题，其实应该以地板为标准
                f_position.z = f_position.z - datalZ;
            }
            camera.setPosition(f_position.x, f_position.y, f_position.z);
            camera.lookAt(w_p.x, w_p.y, w_p.z);
        }
    },

    /**
     * 移动镜头，使之看到nodes中所有的element
     * @param nodes
     * @returns {null}
     */
    lookAtElements : function(nodes,callback){
        if(!nodes || nodes.length < 1){
            return null;
        }
        if(nodes.length === 1){
            this.lookAt(nodes[0]);
            return;
        }
        this.sceneManager.viewManager3d.setCameraDistance(null,10000);
        var camera = this.getCamera(nodes[0]); // 17-08-11  this.sceneManager.network3d.getCamera();
        var minx,miny,minz,maxx,maxy,maxz;
        for(var i = 0 ; i < nodes.length ; i++){
            var node = nodes[i];
            if(!node){
                continue;
            }
            var bp = node.getBoundingBox()||{min:{x:0,y:0,z:0},max:{x:0,y:0,z:0}}; //只考虑中心点还不够准确，还需要考虑到boundingBox，这样才能真的全部包围
            var wp = node.getWorldPosition();
            if(!minx || minx > (wp.x+bp.min.x)){
                minx = wp.x+bp.min.x;
            }
            if(!miny || miny > (wp.y + bp.min.y)){
                miny = wp.y + bp.min.y;
            }
            if(!minz || minz > (wp.z + bp.min.z)){
                minz = wp.z + bp.min.z;
            }
            if(!maxx || maxx < (wp.x + bp.max.x)){
                maxx = wp.x + bp.max.x;
            }
            if(!maxy || maxy < (wp.y + bp.max.y)){
                maxy = wp.y + bp.max.y;
            }
            if(!maxz || maxz < (wp.z + bp.max.z)){
                maxz = wp.z + bp.max.z;
            }
        }
        var target = new mono.Vec3(minx+(maxx-minx)/2,miny+(maxy-miny)/2,minz+(maxz-minz)/2);
        // var maxLen = maxx - minx; // 应该是算斜边
        // if(maxLen < (maxy-miny)){
        //     maxLen = (maxy-miny);
        // }
        // if(maxLen < (maxz - minz)){
        //     maxLen = (maxz - minz);
        // }
        var maxLen = Math.sqrt((maxx - minx)*(maxx - minx) + (maxy-miny)*(maxy-miny));
        var length = maxLen / (2 * Math.tan(camera.fov * Math.PI / 180 / 2));
        var offset = 50;
        length+= offset;
        if(length < 500){
            length = 500;
        }
        var up = 50;
        if(maxy-miny < 300){ //在这个范围内，我们认为是同一层，所以俯视。为何是300(比较大哦)，因为一个机柜就有200多，而maxy是从最上方开始算
            up = length ;// up = 500; //应该差不多45度
        }
        var  f_position = new mono.Vec3(target.x, target.y+up, target.z+length);
        it.Util.playCameraAnimation(camera, f_position, target, 1500, callback);
    },

    getCameraTarAndPosForLookAtNodes: function(nodes, angle, offset) {
        if (!nodes || nodes.length < 1) {
            return null;
        }
        if (nodes.length == 1) {
            // this.moveCameraForLookAtNode(nodes[0], callback, offset);
            var w_p = this.getNodeCenterPosition(nodes[0]);
            if (!w_p) {
                w_p = new mono.Vec3(0, 0, 0);
            }
            // var bb = nodes[0].getBoundingBox();
            var bb =  it.Util.getBoundingBox(nodes[0]);// update 2017-07-06 
            var target = new mono.Vec3(w_p.x, w_p.y, w_p.z);
            var f_position = this.getElementPerfectFrontPosition(nodes[0]);
            if (this.isLookAtWithAngle(nodes[0])){
                var h = this.getElementPerfectDistance(nodes[0]); //如果旋转了则有问题
                f_position = this.getCameraPositionForLookAt(nodes[0]);
                if (bb && (bb.max.y + bb.min.y) != 0) { //像pathNode这样的管道，建模的中心点与其自身的中心点差太多时
                    f_position.y = f_position.y + (bb.max.y + bb.min.y)/2
                }
                var datalX = 0,datalZ = 0;
                if (nodes[0].getRotationY()) {
                    datalX = h*Math.sin(nodes[0].getRotationY());
                }
                f_position.x = target.x + datalX; // 对应lookAt楼层对象，可能会有些歪，这是因为楼层的主对象的中心点的问题，其实应该以地板为标准
            }
            return {
                target: w_p,
                position: f_position
            };
        }
        var camera = this.getCamera(nodes[0]); // 17-08-11 this.sceneManager.network3d.getCamera();
        var bb = this.computeNodesBoundingBox(nodes);
        if (!bb) {
            return null;
        }
        var center = bb.center();
        var sub1 = new mono.Vec3(0, bb.max.y - bb.min.y, bb.max.z - bb.min.z);
        var sub2 = new mono.Vec3(bb.max.x - bb.min.x, 0, 0, 0);
        var sub = sub1.clone();
        if (sub.length() < sub2.length()) {
            sub = sub2.clone();
        }
        var position;
        if (angle) {
            var l = sub1.length();
            sub1.y = sub1.z * Math.tan(angle / 180 * Math.PI);
            sub1.setLength(l);
        }
        position = new mono.Vec3().addVectors(center, sub1.multiplyScalar(0.5));
        var fov = camera.fov,
            aspect = camera.aspect;
        var length = sub.length() / 2 / Math.tan(fov * Math.PI / 180);
        length = length * 2; //太小了
        position.add(sub1.normalize().multiplyScalar(length));
        return {
            target: center,
            position: position
        };
    },

    /**
     * 移动镜头，使之看到一系列的nodes
     * add by Kevin 2016-11-01
     */
    moveCameraForLookAtNodes: function(nodes, callback, angle,offset) {
        if (!nodes || nodes.length < 1) {
            if (callback) {
                callback();
            }
            return;
        }
        var camera = this.getCamera(nodes[0]); // 17-08-11 this.sceneManager.network3d.getCamera();
        var targetAndPos = this.getCameraTarAndPosForLookAtNodes(nodes,angle,offset);
        if (targetAndPos) {
            var position = targetAndPos.position;
            var center = targetAndPos.target;
            it.Util.playCameraAnimation(camera, position, center, 1500, callback);
        }
    },
    
    /**
     * 计算一系列nodes的总boundingBox
     * 注意：由于这个node是保存在map中的主对象，其实它有可能包含了多个子对象，但是其子对象并没有参与合并boundingBox的计算，
     * 一般来讲也不会有什么问题，我们lookAt时也只计算了该node，若有问题，需调整模型
     * add by Kevin 2016-11-01
     */
    computeNodesBoundingBox: function(nodes) {
        if (!nodes || nodes.length < 1) {
            return;
        }
        var vertices = [];
        for (var i = 0; i < nodes.length; i++) {
            var data = nodes[i];
            if (data instanceof TGL.Node) {
                bb = data.getBoundingBox();
                matrix = data.worldMatrix;
                var min = bb.min,
                    max = bb.max;
                pushVertics(min.clone(), matrix);
                pushVertics(max.clone(), matrix);
                pushVertics(new mono.Vec3(min.x, min.y, max.z), matrix);
                pushVertics(new mono.Vec3(min.x, max.y, min.z), matrix);
                pushVertics(new mono.Vec3(max.x, min.y, min.z), matrix);
                pushVertics(new mono.Vec3(max.x, max.y, min.z), matrix);
                pushVertics(new mono.Vec3(max.x, min.y, max.z), matrix);
                pushVertics(new mono.Vec3(min.x, max.y, max.z), matrix);
            }
        }

        function pushVertics(vertex, matrix) {
            vertex.applyMatrix4(matrix);
            vertices.push(vertex);
        };
        if (vertices.length <= 1) {
            return null;
        }
        var boundingBox = new mono.BoundingBox();
        boundingBox.setFromPoints(vertices);
        return boundingBox;
    },

    getCenter : function(node1,node2){
        if(!node1 && !node2){
            return null;
        }else if(!node1 && node2){
            return node2.getWorldPosition();
        }else if(!node2 && node1){
            return node1.getWorldPosition();
        }else{
            var w_n1 = node1.getWorldPosition();
            var w_n2 = node2.getWorldPosition();
            var x = (w_n2.x - w_n1.x) > 0 ?w_n1.x + (w_n2.x - w_n1.x)/2 : w_n2.x + (w_n1.x - w_n2.x)/2;
            var y = (w_n2.y - w_n1.y) > 0 ?w_n1.y + (w_n2.y - w_n1.y)/2 : w_n2.y + (w_n1.y - w_n2.y)/2;
            var z = (w_n2.z - w_n1.z) > 0 ?w_n1.z + (w_n2.z - w_n1.z)/2 : w_n2.z + (w_n1.z - w_n2.z)/2;
            return new mono.Vec3(x,y+50,z);
        }
    },

    /**
     * 备注，length*frontDirection，是使之计算包含上其方向
     */
    getPerfectDistanceForNodes : function(node1,node2){
        var direction = 'z';
        var result = {direction:'x',length:0};
        if(!node1 && !node2){
            return null;
        }else if(!node1 && node2){
            // return this.getElementPerfectDistance(node2);
            var fd = 1;
            if (node2.frontDirection().z < 0) {
                fd = -1;
            }
            result = {direction:'x',length:this.getElementPerfectDistance(node2)*fd};
        }else if(!node2 && node1){
            // return this.getElementPerfectDistance(node1);
             var fd = 1;
             if (node1.frontDirection().z < 0) {
                fd = -1;
             }
             result = {direction:'x',length:this.getElementPerfectDistance(node1)*fd};
        }else{
            var camera = this.getCamera(node1); // 17-08-11 this.sceneManager.network3d.getCamera();
            var w_n1 = node1.getWorldPosition();
            var w_n2 = node2.getWorldPosition();
//            var x = (w_n2.x - w_n1.x) > 0 ? (w_n2.x - w_n1.x) :  (w_n1.x - w_n2.x);
//            var y = (w_n2.y - w_n1.y) > 0 ? (w_n2.y - w_n1.y) :(w_n1.y - w_n2.y);
//            var z = (w_n2.z - w_n1.z) > 0 ? (w_n2.z - w_n1.z) : (w_n1.z - w_n2.z);
            var x = Math.abs(w_n2.x - w_n1.x);
            var y = Math.abs(w_n2.y - w_n1.y);
            var z = Math.abs(w_n2.z - w_n1.z);
            var h = x;
            if(y>h){
                h = y;
            }
            if(z>h){ 
                h = z;
                direction = 'x'; //如果z上的偏移量大的话，那就应该在x方向来看
            }
            var length = h / (2 * Math.tan(camera.fov * Math.PI / 180 / 2));
//            var length = h / (2 * Math.tan(camera.fov / 2));
            var offset = 50;
            length+= offset;
            if(length < 500){
                length = 500;
            }
            var fd = 1;
            if (node1.frontDirection().z < 0) {
              fd = -1;
            }
            result = {direction:direction,length:length*2*fd};
            // return length*2;
        }
        return result;
    },

    /**
     * lookAt link
     * 注意：如果是跨层的link，那就平视到正中间
     * @param linkNode
     * @param callback
     */
    moveCameraForLookAtLink : function(linkNode,callback,dur){
        if(!linkNode) return ;
        dur = dur||1500;
        var camera = this.getCamera(linkNode); // 17-08-11 this.sceneManager.network3d.getCamera();
        var link = this.sceneManager.getLinkData(linkNode);
        if(!link){
            this.moveCameraForLookAtNode(linkNode,callback);
            return;
        }
        var fromNodde = this.sceneManager.getNodeByDataOrId(link.getFromId());
        var toNode = this.sceneManager.getNodeByDataOrId(link.getToId());
        //有可能fromNode和toNode在focuseNode时真假切换的过程中给remove掉了，如正lookAt某个机柜时，
        //这个link的端正好是该机柜中的设备或端口,所以这里重新add一下 2016-12-06
        if(fromNodde && !this.box3d.getDataById(fromNodde.getId())){
            this.box3d.add(fromNodde);
        }
        if(toNode && !this.box3d.getDataById(toNode.getId())){
            this.box3d.add(toNode);
        }
        var target = this.getCenter(fromNodde,toNode);
        var dirLength = this.getPerfectDistanceForNodes(fromNodde,toNode);
        var length = null;
        var direction = null;
        if (dirLength) {
            length = dirLength.length;
            direction = dirLength.direction;
        }
        var detalY = 0;//500;
        if(fromNodde && toNode){
            var fWPos = fromNodde.getWorldPosition();
            var tWPos = toNode.getWorldPosition();
            if(Math.abs(fWPos.y - tWPos.y) > 100){ //表示跨层了，跨层的话就平视
                detalY = 0;
            }else{
                // detalY = detalY+ Math.round(Math.abs(fWPos.y - tWPos.y)/500) * 100;
                detalY = Math.abs(length) * Math.tan(Math.PI/6);
            }
        }
        var  f_position = new mono.Vec3(target.x, target.y+detalY, target.z);
        if (direction && direction == 'x' && length) {
            f_position.x = f_position.x + length;
        }else if (direction && direction == 'z' && length){
            f_position.z = f_position.z + length;
        }
        it.Util.playCameraAnimation(camera, f_position, target, dur, callback);
    },

    _isLookAt : function(node){
        if(this.isLookAtFunction != null){
            return this.isLookAtFunction(node);
        }
        var data = this.sceneManager.getNodeData(node);
        if(!data){ // 如温度云图
            return false;
        }
        return true;
    },

    isDoLookAt : function(node){
        if(node && node.getClient('notLookAt')){
            return false;
        }
        return true;
    },

    /**
     * 哪些东西要实现堆栈
     * 也可以通过重写该方法，返回false时来关闭镜头堆栈的功能
     */
    isUseCameraStackByNode : function(node){
         var nodeData = this.sceneManager.getNodeData(node);
         if (!nodeData) {
            return false;
         }
          var nCategory = this.dataManager.getCategoryForData(nodeData);
         if (nCategory 
            && (nCategory.getId().toLowerCase() == 'floor' 
                || nCategory.getId().toLowerCase() == 'room')) {
             return true;
         }
         return false;
    },
    
    /**
     * 是否将镜头的信息压入栈中
     * 注意：从lookAt机柜退回到lookAt机柜的上层时，这样的情况是不需要压栈的，根据focusNode来判断
     * 
     */
    isPushCameraInfoBeforeLookAt : function(node){
         if(!node){
            return false;
         }
         var nodeData = this.sceneManager.getNodeData(node);
         if (!nodeData) {
            return false;
         }
         var oldFocusNode = this.sceneManager.viewManager3d.getFocusNode();
         var oldFocusData = this.sceneManager.getNodeData(oldFocusNode);
         if (nodeData != oldFocusData && this.dataManager.isAncestor(nodeData.getId(),oldFocusData)) {
             return false;
         }
         return this.isUseCameraStackByNode(node);
         // var nCategory = this.dataManager.getCategoryForData(nodeData);
         // if (nCategory 
         //    && (nCategory.getId().toLowerCase() == 'floor' 
         //        || nCategory.getId().toLowerCase() == 'room')) {
         //     return true;
         // }
         // return false;
    },

    /**
     * 保存lookAt之前的压入该节点的镜头信息
     */
    pushCameraInfoByChildNode : function(childNode){ 
        //下面三行本来为注释状态的，会产生以下问题，通过id进入楼层后，马上lookAt楼层时，会产生一个奇怪的镜头位置，且只有第一次lookAt的时候才有，因此取消注释。
        //2017-11-29 by liyinzheng
        if (!childNode) {
            return ;
        }
        var cData = this.sceneManager.getNodeData(childNode);
        // if (!cData || !cData.getParentId()) {
        //     return ;
        // }
        // var parentNode = this.sceneManager.getNodeByDataOrId(cData.getParentId());
        var parentNode = this.sceneManager.viewManager3d.getFocusNode();//应该是focuseNode,因为lookAt的时候不一定是一级一级的。
        var data = this.sceneManager.getNodeData(parentNode);
        if (cData == data  // 2017-10-27 如果看到是focus自己的话，就不压栈了
            || !this.isPushCameraInfoBeforeLookAt(parentNode)) {
            return ;
        }
        var camera = this.getCamera();
        if (camera) {
            this.cameraInfoStack.push({id:data.getId(),target: camera.target,position:camera.getPosition()});
        }
    },
    
    /**
     * lookAt好了以后压出该节点的镜头信息
     * 注意：不是所有的node都需要压出，如果之前压入的对象才需要；
     *      如果快速跳转的话，得注意压出到哪里
     *  貌似压出可以不用控制的那么严，如果lookAt的是自己的话查看一下堆，如果堆里有的话则pop.
     *  对于点击背景的回退的才pop，其他的通过id跳转的则不去pop，直接清空堆栈
     *  
     */
    popCameraInfoByNode : function(node){
        var data = this.sceneManager.getNodeData(node);
        if (!data) {
            return false;
        }
        if (!this.isUseCameraStackByNode(node)) {
            return false;
        }
        return this.popToDataParentByData(data); //一直回退回退
    },

    /**
     * 出栈，一直出到data那层
     */
    popToDataParentByData : function(data,scope){
        scope = scope || this;
        if(!data || !scope.cameraInfoStack || scope.cameraInfoStack.length < 1){
            return ;
        }
        //lookAt区域时，lookAt完之后马上就出栈了，没有去判断刚刚入的正是它的parent，这样不太合理 -- 2017-10-19
        if (!scope.cameraInfoStack[0] || scope.cameraInfoStack[0].id == data.getParentId() ) { 
            return ;
        }
        var pci = scope.cameraInfoStack.pop();
        if (pci && pci.id == data.getId()) {
            return true;
        }else {
            return scope.popToDataParentByData(data,scope);
        }
    },

    /**
     * 清除堆栈中的镜头信息
     */
    clearCameraInfo : function(){
        this.cameraInfoStack = [];
    },

    getSavedCameraInfoByNode : function(node){
        var data = this.sceneManager.getNodeData(node);
        if (!node 
            || !data 
            || !this.cameraInfoStack 
            || this.cameraInfoStack.length < 1) {
            return null;
        }
        if (!this.isUseCameraStackByNode(node)) {
            return null;
        }
        for(var i = this.cameraInfoStack.length-1 ; i >=0 ; i--){
            var pci = this.cameraInfoStack[i];
            if (pci.id == data.getId()) {
                return pci;
            }
        }
        return null;
    },

    /**
     * 移动镜头前是否处理了虚幻
     * 如果没有（从大范围到局部），那就返回false，使得接下来在lookAt的callback中处理
     */
    isDealWithVirtualBeforeMoveCamera : function(focusNode,oldFocusNode){
        var oldFocusData = this.sceneManager.getNodeData(oldFocusNode);
        var data = this.sceneManager.getNodeData(focusNode); 
        var category = this.sceneManager.dataManager.getCategoryForData(data);
        if (category && category.getId().toLowerCase() == 'datacenter') { // floor合并例外，否则合并的过程中floor和building同时存在
            return false;
        }
        return this.sceneManager.isAncestor(oldFocusData,data);
    },

    /**
     * 将镜头对到node
     * 注意：有可能node虽然存在，但是不在box中，比如设备，因为一般情况下(lazyable)时，机柜中的设备是被移除了
     *
     * 对于有些对象不需要这个lookAt(调用这个是实属无奈，比如场景切换时)，如：earth(地球)，由于它的lookAt比较特殊(需要看到中国)，所以其自身处理了这个lookAt
     *
     * @param node
     * @param callback1
     */
    lookAt : function(node, callback1) { //虚化
        this.pushCameraInfoByChildNode(node);
        if (!node) {
            if (callback1) {
                callback1();
            }
            return;
        }
        if (!this.isDoLookAt(node)) {
            if (callback1) {
                callback1();
            }
            return;
        }
        var oldFocusNode = this.sceneManager.viewManager3d.getFocusNode();
        // var oldFocusData = this.sceneManager.getNodeData(oldFocusNode);
        var mainNode = this.sceneManager.getMainNode(node);
        if (!mainNode && !this.sceneManager.isLink(node)) { //有可能是2D的Node
            return;
        }
        var data = this.sceneManager.getNodeData(mainNode);
        if (!mainNode && this.sceneManager.isLink(node)) { //由于Link没有父子关系，因此lookat到link时，返回到上一级需特别处理一下(找fromId和toId)
            mainNode = node;
        }else if (!this.box3d.getDataById(mainNode.getId())) {//如果不存在就得重新load,可是如果是在building场景(该场景只加载children，但是lookAt的是自己)下呢？
            this.sceneManager.loadLazyData(data);
        }
        var isDealWithVirtual = true;
        // 有可能setFocus时不需要处理虚幻，然而这边又从局部到外部
        if (this.isDealWithVirtualBeforeMoveCamera(mainNode,oldFocusNode)) {//从局部到全局时，Focus时就不处理虚幻，在动画完成之后处理
            isDealWithVirtual = false;
        }
        this.sceneManager.viewManager3d.isDealWithVirtual = isDealWithVirtual; // 2017-10-20 为了同步，setFocusNode可能会被重写
        this.sceneManager.viewManager3d.setFocusNode(mainNode,isDealWithVirtual);
        if (this.beforeLookAtFunction) { // 放到了setFocuse之后，是因为这是为了不让某些对象虚化而增加了(而虚化是在setFocuse中处理的)
            this.beforeLookAtFunction(node,oldFocusNode);
        }
        if (!this.sceneManager.isLink(node)) {
             mainNode = this.sceneManager.getMainNode(node); // 有可能在beforeLookAtFunction中重新组织了数据
        }
        if (!mainNode || !this.box3d.getDataById(mainNode.getId())) { // 不在box中，不用lookAt
            this.afterLookAt(mainNode, node,oldFocusNode); // 如果为空也要执行这个动作，比如我们切换属性框的动作，如果直接返回了，那属性还是老的
            return;
        }
        var self = this;
        var callback = function(){ //可是这都是异步的，有可能在移动镜头的过程中，执行了其他的动作，并且该动作也改变了该callback中的值
            // if (!isDealWithVirtual) {
            // 2017-10-20 有可能setFocus被重写了，并不需要去改变虚幻，view3D中都不用的话，这里也不用。当view3D中需要的话，它会将里面的isDealWithVirtual置为true
            if (!isDealWithVirtual && self.sceneManager.viewManager3d.isDealWithVirtual) {
                self.sceneManager.viewManager3d.dealWithVirtual(mainNode);
            }
            self.popCameraInfoByNode(mainNode);
            self.openDoor(mainNode, callback1,oldFocusNode);
            self.afterLookAtFinished(mainNode, node,oldFocusNode);
        }
        if (this.lookAtWithOutMoveCamera) {
            if (this.sceneManager.isLink(node)) {
                this.moveCameraForLookAtLink(node, callback);
            } else {
                if (this.withOutAnimate) {
                    this.lookAtNodeWithOutAnimate(mainNode);
                    callback();
                    this.withOutAnimate = false;
                } else {
                    this.moveCameraForLookAtNode(mainNode, callback);
                }
            }
        } else {
            callback();
            this.lookAtWithOutMoveCamera = true;
        }
        this.afterLookAt(mainNode,node,oldFocusNode); //after lookAt,并不放到动画执行后，由于是异步的，比如在lookAt机柜的过程中，突然lookAt楼层或dc，此时bread和pm都很奇怪
    },

    /**
     * lookAt后马上执行，执行该动作时，camera还在移动的过程中
     * @param mainNode
     * @param node
     * @param callback
     */
    afterLookAt : function(mainNode,node,oldFocusNode){
//        this.openDoor(mainNode,callback);
        if(this.afterLookAtFunction){
            this.afterLookAtFunction(mainNode,node,oldFocusNode);
        }
        for(var i = 0 ; i < this._afterLookAtListener.length ; i++){
            var l = this._afterLookAtListener[i];
            l.call(l.scope||this,mainNode,node,oldFocusNode);
        }
    },

    addAfterLookAtListener : function(l,scope){
        if(l){
            l.scope = scope;
            this._afterLookAtListener.push(l);
        }
    },

    removeAfterLookAtListener : function(l){
         var index = this._afterLookAtListener.indexOf(l);
        if(index !== -1){
           this._afterLookAtListener.splice(index,1);
        }
    },

    /**
     * lookAt时，镜头移动好后执行
     * @param mainNode
     * @param node
     */
    afterLookAtFinished : function(mainNode,node){
        if(this.afterLookAtFinishedFunction){
            this.afterLookAtFinishedFunction(mainNode,node);
        }
        for(var i = 0 ; i < this._afterLookAtFinishedListener.length ; i++){
            var l = this._afterLookAtFinishedListener[i];
            l.call(l.scope||this,mainNode,node);
        }
    },

    addAfterLookFinishedAtListener : function(l,scope){
        if(l){
            l.scope = scope;
            this._afterLookAtFinishedListener.push(l);
        }
    },

    removeAfterLookAtFinishedListener : function(l){
         var index = this._afterLookAtFinishedListener.indexOf(l);
        if(index !== -1){
           this._afterLookAtFinishedListener.splice(index,1);
        }
    },

    findOidfromChildren : function (node, oid) {
        var result = [];
        if (node.getClient('type') == oid) {
            // return node; // 不能直接返回，还有孩子呢
            result.push(node);
        }
        var children = node.getChildren();
        for (var i = 0; i < children.size(); i++) {
            var child = children.get(i);
            if (child.getClient('it_data') == node.getClient('it_data')) {
                var cd = this.findOidfromChildren(child, oid, this);
                if (cd && cd.length > 0) {
                    // return cd;
                    for(var j = 0 ; j < cd.length ; j++){
                        result.push(cd[j]);
                    }
                }
            }
        }
        return result;
    },

    findAllOidDatafromChildren: function (node, oid) {
        var all = [];
        if (node.getClient('type') == oid) { //oid
            all.push(node);
            // return all;  // 不能马上返回，还有很多门没有找到 add 2017-05-12 Kevin
        }
        var children = node.getChildren();
        for (var i = 0; i < children.size(); i++) {
            var child = children.get(i);
            if (child.getClient('it_data') == node.getClient('it_data')) {
                var cd = this.findOidfromChildren(child, oid);
                if (cd && cd.length > 0) {
                    // all.push(cd);
                    for(var j = 0 ; j < cd.length ; j++){
                        all.push(cd[j]);
                    }
                }
            }
        }
        return all;
    },

    findRackDoorElementAtRack: function (mainNode) {
        if (!mainNode) {
            return;
        }
        return this.findAllOidDatafromChildren(mainNode, 'rack_door'); //door
    },

    findChannelDoorElementAtChannel: function (mainNode) { //增加赛选channel模型的door、天窗  by--loda 2017-12-12
        if (!mainNode) {
            return;
        }
        return this.findAllOidDatafromChildren(mainNode, 'channel_door'); //channel_door
    },

    openDoor : function(mainNode,callback){
        var doors = this.findRackDoorElementAtRack(mainNode);
        var count = doors.length;
        var index = 0;
        var isPlay = false;
        if (doors && doors.length > 0) {
            doors.forEach(function (door) {
                if (door && door.getClient('animation') && !door.getClient('animated')) { //!door.__animated 表示的是动画没有被执行
//                    console.log(door.getClient('animation'));
//                    var amin = 'rotation:right:-150:1000:0:Bounce.Out'; //door.getClient('animation')
                    // (element, animation, time, delay, easing, onCompleteCallback)
//                    mono.AniUtil.playAnimation(door, door.getClient('animation'), null, null, null, callback);
                    isPlay = true;
                    make.Default.playAnimation(door,door.getClient('animation'),function(){callback && callback(index++,count)});
                }
            });
        }
        if(!isPlay && callback){
            callback(0,0);
        }
    },

    closeDoor:function(mainNode,callback){
        var self = this;
        var doors = this.findRackDoorElementAtRack(mainNode);
        doors = doors.concat(this.findChannelDoorElementAtChannel(mainNode));
        var isPlay = false;
        if (doors && doors.length > 0) {
            doors.forEach(function (door) {
                if (door && door.getClient('animation') && door.getClient('animated')) { //door.__animated 表示的是动画被执行(即机柜的门是开着的)
//                    mono.AniUtil.playAnimation(door, door.getClient('animation'));
                    isPlay = true;
                    make.Default.playAnimation(door,door.getClient('animation'),callback);
                }
            });
        }
        var rackData = this.sceneManager.getNodeData(mainNode);
        var children = this.dataManager.getChildren(rackData);
        if(children && children.length>0){
            children.forEach(function(child){
                var childNode = self.sceneManager.getNodeByDataOrId(child);
                if (childNode && childNode.getClient('animation') && childNode.getClient('animated')) { //执行恢复原位动画
                    make.Default.playAnimation(childNode,childNode.getClient('animation'),callback);
                }
            })
        }
        if(!isPlay && callback){
            callback();
        }
    },

    /**
     * 表示双击到该Node上时是不是镜头跟着走
     * 默认实现是，当其尺寸中某以方向超过500时会跟着移动，像机柜设备这样的对象应该不能跟随，否则门都打不开
     * add 2016-11-22，若是dc或地板上的小物体呢？也无法移动了，需改进，不用boundingBox的size判断，用category
     * @param node
     * @returns {boolean}
     */
    isFollow : function(node){
        if (node) {
            var data = this.sceneManager.getNodeData(node);
            var category = this.dataManager.getCategoryForData(data);
            if (category) {
                var cid = category.getId().toLowerCase() ;
                if (cid === 'datacenter' || cid === 'floor' || cid === 'room') {
                     return true;
                }
            }
        };
        return false;
    },

    /**
     * 点击一下镜头就跟着移动一下
     * @param clickObj
     */
    moveToClickPoint : function(clickObj){
        if(!clickObj) return;
        var camera = this.getCamera();
        if(!camera) return;
        var newTarget=clickObj.point;
        var offset=camera.getPosition().sub(camera.getTarget());
        var f_position=new mono.Vec3().addVectors(offset, newTarget);
        it.Util.playCameraAnimation(camera,f_position,newTarget,1000);
    },

    /**
     * 移动镜头到，保持距离，target弄成node
     * 不过当offset小于moveSize时就不移动了
    */
    moveToClickNode : function(node,callback,moveSize){
        if(!node) return;
        if (!moveSize) {
            moveSize = 0;
        }
        var camera = this.getCamera();
        if(!camera) return;
        var newTarget=this.getNodeCenterPosition(node);
        var offset=camera.getPosition().sub(camera.getTarget());
        var f_position=new mono.Vec3().addVectors(offset, newTarget);
        var diffOff = new mono.Vec3().subVectors(newTarget,camera.getTarget());
        if (Math.abs(diffOff.x) > moveSize || Math.abs(diffOff.y)>moveSize || Math.abs(diffOff.z)>moveSize) {
            it.Util.playCameraAnimation(camera,f_position,newTarget,1000,callback);
        }else{
            if (callback) {
                callback();
            }
        }
    },

    getElementPerfectBackPosition : function(element){
        if(!element) return null;
        var h = this.getElementPerfectDistance(element);
        var  perfectPosition = element.worldPosition(new mono.Vec3(0,0,-1),h);
        if(perfectPosition){
            perfectPosition.y = perfectPosition.y+20;
        }
        return perfectPosition;
    },

    rotateElement : function(mainObj){
        // var mainObj = Util.getMainObject(element);
        if(!mainObj){
            return ;
        }
        if(!mainObj.isVisible() && mainObj.simpleRack){
            mainObj = mainObj.simpleRack;
        }
        var camera = this.getCamera(mainObj); // 17-08-11 this.sceneManager.network3d.getCamera();
        var perfectPosition = null;
        var w_p = mainObj.getWorldPosition();
        var rotate_flage = mainObj.getClient('rotate_flage');
        if(rotate_flage){
            perfectPosition = this.getElementPerfectFrontPosition(mainObj);
            mainObj.setClient('rotate_flage',false);
        }else{
            perfectPosition = this.getElementPerfectBackPosition(mainObj)
            mainObj.setClient('rotate_flage',true);
        }
        var target =  new mono.Vec3(w_p.x, w_p.y, w_p.z);
        it.Util.playCameraAnimation(camera,perfectPosition,target,1000);
    },

    shouldHandleDoubleClickElement : function(node,network,data,clickedObj){
        var lookAtNode = this.sceneManager.viewManager3d.getFocusNode();
         //移至了viewManager3D中，从根处过滤更加合理
        // var virtualManager = this.getDefaultVirtual();
        // if(virtualManager && virtualManager.isVirtual(data||node)){
        //     return false;
        // }
        var root = node.getClient('modelParent') || node;
        var dataForRoot = this.sceneManager.getNodeData(root);
        var dataForLookAtNode = this.sceneManager.getNodeData(lookAtNode);
        // if(this._isLookAt(root) && lookAtNode != root){
        if(this._isLookAt(root) && dataForRoot != dataForLookAtNode){ //check data
            return true;
        }else if(node && (node.getClient('animation') || node.getClient('animated'))){
            return true;
        }else if(this.isFollow(node)){
            return true;
        }
       return false;
	},

  	shouldPropogateDoubleClickElement : function(node,network,data,clickedObj){
         return false;
  	},

  	shouldHandleDoubleClickBackground : function(network){
//  		 if(this.lookAtNode){
           return true;
//         }
//         return false;
  	},

  	shouldPropogateDoubleClickBackground : function(network){
         return false;
  	},

    /**
     * 表示什么对象都没有点中时，此时处理一下
     * @param network
     */
  	handleDoubleClickBackground : function(network){
        var lookAtNode = this.sceneManager.viewManager3d.getFocusNode();
        if(lookAtNode){
            if(this.sceneManager.isLink(lookAtNode)){
//                var fromNode = lookAtNode.getFromNode();//有可能为空
//                if(fromNode){
//                    lookAtNode =  fromNode;
//                }else{
                    var link = this.sceneManager.getNodeData(lookAtNode);
                    if(link){
                        if(link.getFromId() && this.sceneManager.isCurrentSceneInstance(link.getFromId())){
                            lookAtNode = this.sceneManager.getNodeByDataOrId(link.getFromId());
                        }else if(link.getToId()) {
                            lookAtNode = this.sceneManager.getNodeByDataOrId(link.getToId());
                        }else{
                            lookAtNode = lookAtNode.getFromNode();//有可能为空
                        }
                    }
//                }
//                lookAtNode = lookAtNode.getFromNode();
            }

            var parentNode = this.getParentFocusNode(lookAtNode);
            if(parentNode){
                this.lookAt(parentNode);
                return this.handleDoubleClickBackgroundFunction && this.handleDoubleClickBackgroundFunction(network);
            }
        }
        this.handleDoubleClickBackgroundFunction && this.handleDoubleClickBackgroundFunction(network);
  	},

    /**
     * 点击背景时，lookAt到下一个对象，这里做了个扩展，不一定是其parent.
     * 因为现在有种特殊的情况：开始看到的是真的building，点击该building看到的是building的所有的楼层，现在回到上一级时应该还是building
     * @param lookAtNode
     * @returns {*}
     */
    getParentFocusNode : function(lookAtNode){
        var data = this.sceneManager.getNodeData(lookAtNode);
        if (data && data.getParentId()) {
            var parentData = this.sceneManager.dataManager.getDataById(data.getParentId());
            if (!parentData) {
                return null;
            }
            var parentNode = this.sceneManager.dataNodeMap[data.getParentId()]; //如果确实存在parentData，但是其本身就是根场景的情况，因此这里就不要用loadLazyData了
            return parentNode
        }
    },
     
    /**
     * 双击的对象如果太远，是不是先lookAt到它的parent(这个parent是room或channel)
     */
    isLookAtParentFirst : function(node,network,data,clickedObj){
        return true;
    },

    isPlayAnimate : function(node){
        return true;
    },

    /**
     * 鼠标“双击”时的处理
     * 如果是可以lookAt的（并且当前不是lookAt到它时）那就lookAt过去,
     * 否则看看是不是可以移动镜头
     * @param node
     * @param network
     * @param clickedObj
     */
  	handleDoubleClickElement : function(node,network,data,clickedObj){
        var root = node.getClient('modelParent') || node;
        var self = this;
        var lookAtNode = this.sceneManager.viewManager3d.getFocusNode();
        if(data 
            && clickedObj.distance > 2500 
            && this.isLookAtParentFirst(node,network,data,clickedObj)){ // 如果点的老远的对象，并且之前不是通道时，那么就look到通道(或room add By Kevin 20161109)
            var parantData = this.sceneManager.dataManager.getDataById(data.getParentId());
            var parentNode = this.sceneManager.getNodeByDataOrId(data.getParentId());
            if(parantData && parentNode && parentNode != lookAtNode){
                var category = this.sceneManager.dataManager.getCategoryForData(parantData);
                if(category 
                    && (category.getId().indexOf('channel') >=0 
                        || category.getId().toLowerCase() === 'room')){
                    root = parentNode;
                }
            }
        }
        if(this._isLookAt(root) && lookAtNode != root){
            this.lookAt(root);
//            this.lookAtNode = root;
        }else if(node && (node.getClient('animation') || node.getClient('animated'))) { //door.__animated 表示的是动画被执行(即门是开着的)
            var animate = node.getClient('animate');
            if (this.isPlayAnimate(node)) {
                var callback = function(){
                    self.afterPlayAnimateFunction && self.afterPlayAnimateFunction(node,!!animate); 
                }
                make.Default.playAnimation(node,node.getClient('animation'),callback);
            }
        }else if(this.isFollow(node)){
            this.moveToClickPoint(clickedObj);
        }
  	},

    /**
     * 
     * @withStopCamera,默认是true 表示当场景切换时，是不是将镜头的动画停掉，比如：场景切换时，各种设置镜头的动作
     */
    lookAtByData : function(data,callback,withStopCamera){
        if (!data) {
            callback&&callback();
            return;
        }
        if (typeof(data) == 'string' || typeof(data) == 'number') {
            data = this.sceneManager.dataManager.getDataById(data);
        }
        var node = this.sceneManager.getNodeByDataOrId(data);
        var sceneAndRootData = this.sceneManager.getSceneAndRootByData(data);
        if (sceneAndRootData) {
            if (node 
                && sceneAndRootData.scene == this.sceneManager.getCurrentScene() 
                && sceneAndRootData.rootData == this.sceneManager._currentRootData
                ) {
                this.lookAt(node,callback);
                 return;
            }
            if(withStopCamera || withStopCamera == undefined || withStopCamera == null){
                withStopCamera = true;
            }else{
                withStopCamera = false;
            }
            if (withStopCamera) {
                this.sceneManager.cameraManager.setStopCamera(true);
            }
            var self = this;
            var afterGotoSceneCallback = function(){ 
                if (sceneAndRootData.rootData != data) {
                    node = self.sceneManager.dataNodeMap[data.getId()];
                    if (!node) {
                        self.sceneManager.loadLazyData(data, function () {
                            node = self.sceneManager.dataNodeMap[data.getId()];
                            self.lookAt(node, callback);
                        });
                        return;
                    }
                } else {
                    node = null;
                    // node = self.sceneManager.dataNodeMap[data.getId()]; // add 2017-05-08 正好切换到根场景 gotoScene只setFocuse，没有lookAt
                }
                self.lookAt(node, callback);
            };
            // this.sceneManager.gotoScene(sceneAndRootData.scene, sceneAndRootData.rootData,afterGotoSceneCallback);
            if (sceneAndRootData.scene.getCategoryId() == 'earth') {
                //update 2017-07-07 不一定是同步的，后来加了beforeLoadSceneAnimate方法，目前dc切换到earth时会先在befor中play一下
                this.sceneManager.gotoScene(sceneAndRootData.scene, sceneAndRootData.rootData,afterGotoSceneCallback);
            }else{
                if (sceneAndRootData.rootData != data) {
                    this.sceneManager.resetCameraWhenSceneChange = false;
                }
                this.sceneManager.gotoScene(sceneAndRootData.scene, sceneAndRootData.rootData);//这是同步的，并且callback后还有set父子关系和setFocuse
                afterGotoSceneCallback(); //这些callback都不是同步的，只是切换完就马上调用，可是动画(CameraManager中的动画)并没有执行完
            }
           
            if (withStopCamera) {
                mono.Utils.stopAllAnimates(true);
            }
        }
    }

});

it.DefaultEventHandler = $DefaultEventHandler;

/**
 * 虚化的实现类
 * 1、该类实现了两个级别的虚化管理，一个全局的，一个非全局的。
 * 如：实现类似先查询（不符合条件的虚化），然后在虚幻的基础上再进行虚化（如在查询后的基础上再看某个设备）
 *
 * 2、设置了透明不可点中，（setSelectTransparencyThreshold方法）
 *
 *
 */

var $VirtualManager = function(sceneManager){
    $MaterialFilter.call(this);
    this.sceneManager = sceneManager;
    this.opacityValue = 0.26; //0.06;
    this.focusElement = null;
    this.virtualFilter = null; // TODO 可以增加是否需要虚幻的过滤。
    this.materialMap = {};
    this.isDealWithFunction = null;

    this._global_tmap = {}; //这个是全局的，最高级，比如搜索后的结果而tmap的处理只是在这一层上,放的是it.Data对象
    this._global_linkTmap = {}; // 放全局的it.Link对象
    this._tmap = {}; // 第一级 ,放入it.Data对象的
    this._linkTmap = {}; // 第一级,放入it.Link对象的
    this._billboard_tmap = {}; //用来保存中途billboard的透明的处理
    this._link_tmap = {}; // 对于mono.Link，使用clone其materal是无效的，所以这里采用同billboard一样的方式
    this.sceneManager.network3d.setSelectTransparencyThreshold(this.opacityValue + 0.1); // 点击门槛不应该通过这种方式，应该加个用个filter
    this.dealWithLinkFunction = null;
    this.virtualFunction = null;
    this.getOpacityValueFunction = null; //用于获取data的透明的自定义方法
    this._particleMap = {};
};

mono.extend($VirtualManager,$MaterialFilter,{

    clearGlobal : function(){
        this._global_tmap = {};
        this._global_linkTmap = {};
        this.sceneManager._sceneVirtualChangeDispather.fire({
                type:'clearGlobal'
        });
    },

    clear: function(){
        this._tmap = {};
        this._linkTmap = {};
        this.sceneManager._sceneVirtualChangeDispather.fire({
                type:'clear'
        });
    },

    clearAll : function(){
        this._tmap = {};
        this._linkTmap = {};
        this._global_tmap = {};
        this._global_linkTmap = {};
        this.sceneManager._sceneVirtualChangeDispather.fire({
                type:'clearAll'
        });
    },

    /**
     * 是否需要设置透明：
     * 对于数据中心来说，datacenter和building不需要
     * @param data
     * @returns {boolean}
     */
    isDealWith : function(data){
        if(this.isDealWithFunction != null){
            return this.isDealWithFunction(data);
        }
        return true;
    },

    isVirtualOther :function(data){
        var dataType = this.sceneManager.dataManager.getDataTypeForData(data);
        if(dataType && dataType._noVirtualOther){
            return false;
        }
        if(this.virtualFunction){
            return this.virtualFunction(data);
        }
        return true;
    },

    isDealWithLink : function(link){
        if(this.dealWithLinkFunction){
            return this.dealWithLinkFunction(link);
        }
        return false;
    },

    getBId : function(data){
        if(!data) {
            return null;
        }
        if(!this.isDealWith(data)){
            return null;
        }
        if (typeof(data) =='string') {
          return data;
        }
        return data.getId();
    },

    addGlobal : function(data){
        if(data instanceof it.Link){
            this.addGlobalLink(data);
            return ;
        }
        var id = this.getBId(data);
        if(id){
            this._global_tmap[id] = true;
        }
    },

    addGlobalLink : function(link){
        var id = this.getBId(link);
        if(id){
//            this._global_linkTmap[id] = true; //不折腾link的virture了
        }
    },

    addGlobalByDescendant : function(data){
        if(!data){
            return ;
        }
        if(data instanceof mono.Element){
            data = this.getDataByNode(data);
        }
        if(!data || !data.getId()) return;
        this.addGlobal(data);
        var node = this.sceneManager.dataNodeMap[data.getId()];
        var children = node.getChildren();
        if(children && children.size() > 0){
            for(var i = 0 ; i < children.size(); i++){
                var child = children.get(i);
                var childData = this.getDataByNode(child);
                if(childData
                    && this.getBId(childData) != this.getBId(data)){
                    this.addGlobalByDescendant(child,this);
                }
            }
        }

    },

    removeGlobal : function(data){
        var id = this.getBId(data);
        if (id) {
            if (data instanceof it.Link) {
                delete this._global_linkTmap[id];
            } else {
                delete this._global_tmap[id];
            }
        }
    },

    removeGlobalByDescendant : function(data){
        if(!data){
            return;
        }
        if(data instanceof mono.Element){
            data = this.getDataByNode(data);
        }
        if(!data || !data.getId()) return;
        this.removeGlobal(data);
        var node = this.sceneManager.dataNodeMap[data.getId()];
        var children = node.getChildren();
        if(children && children.size() > 0){
            for(var i = 0 ; i < children.size(); i++){
                var child = children.get(i);
                var childData = this.getDataByNode(child);
                if(childData
                    && this.getBId(childData) != this.getBId(data)){
                    this.removeGlobalByDescendant(child,this);
                }
            }
        }
    },
    
    /**
     * 设置之前的一些操作
     */
    beforeAdd : function(data){

    },

    add : function(data){
        this.beforeAdd(data);
        var id = this.getBId(data);
        if(id){
            if(data instanceof it.Link){
//                this._linkTmap[id] = true; //不折腾link的virture了
            }else{
                this._tmap[id] = true;
            }
        }
    },

    addLink : function(link){
        if(!link) return;
        var id = this.getBId(link);
        if(id){
//            this._linkTmap[id] = true; //不折腾link的virture了
        }
    },

    getDataByNode : function(node){
        if(!node){
            return null;
        }
        return node.getClient(it.SceneManager.CLIENT_IT_DATA);
    },

    addByDescendant : function(data){
        if(!data) return;
        if(data instanceof mono.Element){
            data = this.getDataByNode(data);
        }
        if(!data || !data.getId()) return;
        this.add(data);
        /** 不太合理，为什么不直接用data呢？有可能3D中的父子关系去掉了 —— update 2017-06-28
        var node = this.sceneManager.dataNodeMap[data.getId()];
        var children = node.getChildren();
        if(children && children.size() > 0){
            for(var i = 0 ; i < children.size(); i++){
                var child = children.get(i);
                var childData = this.getDataByNode(child);
                if(childData
                    && this.getBId(childData) != this.getBId(data)){
                    this.addByDescendant(child,this);
                }
            }
        }*/
        var children = data.getChildren();
        if (!children || children.size() < 1) {
            return;
        }
        for(var i = 0 ;i < children.size() ; i++){
             var childData = children.get(i);
             if(childData){
                this.addByDescendant(childData,this);
             }
        }
    },

    remove : function(data){
        var id = this.getBId(data);
        if(id){
            if(data instanceof it.Link){
                delete this._linkTmap[id];
            }else{
                if(data.getAllLinks){ // 移除与该data有关的link的透明
                    var links = data.getAllLinks();
                    if(links){
                        for(var linkId in links){
                            delete this._linkTmap[linkId];
                        }
                    }
                }
                delete this._tmap[id];
            }
        }
    },

    /**
     *
     * @param data data或Element
     */
    removeByDescendant : function(dataOrElement){
        var data = dataOrElement;
        if(!data) return ;
        if(data instanceof mono.Element){
            data = this.getDataByNode(data);
        }
        if(!data || !data.getId()) return;
        this.remove(data);
        var node = this.sceneManager.dataNodeMap[data.getId()];
        if(data instanceof it.Link){
            node = this.sceneManager.linkMap[data.getId()];
        }
        var self = this;
        if(!node || !node.getChildren){
//            console.log('Stop!');
        }
//        var children = node.getChildren();
//        if(children && children.size() > 0){
//            for(var i = 0 ; i < children.size(); i++){
//                var child = children.get(i);
//                var childData = self.getDataByNode(child);
//                if(childData
//                    && self.getBId(childData) != self.getBId(data)){
//                    self.removeByDescendant(child,self);
//                }
//            }
//        }
        var children = null;
        if(data.getChildren){ //有可能是it.link
            children = data.getChildren(); //用data上的children更加合理，又可以能因某种原因3D上的parent置为了空，如房间的parent置为null了
            if(children && children.size() > 0){
                for(var i = 0 ; i < children.size(); i++){
                    var child = children.get(i);
//                var childData = self.getDataByNode(child);
                    if(child
                        && self.getBId(child) != self.getBId(data)){
                        self.removeByDescendant(child,self);
                    }
                }
            }
        }

    },

    /**
     * 将所有的对象虚化掉
     * 注意：得包括it.Link
     */
    addAll:function(){
        this.addAllData();
        this.addAllLink();
        this.sceneManager._sceneVirtualChangeDispather.fire({
                type:'addAll'
        });
    },

    addAllData : function(){
        var dataMap = this.sceneManager.dataManager.getDataMap();
        if(!dataMap) return ;
        for(var id in dataMap){
            var data = dataMap[id];
            if(data){
                this.add(data);
            }
        }
        this.sceneManager._sceneVirtualChangeDispather.fire({
                type:'addAllData'
        });
    },

    addAllLink : function(){
        var linkMap = this.sceneManager.dataManager.getLinkMap();
        if(!linkMap) return ;
        for(var id in linkMap){
            var link = linkMap[id];
            if(link){
                this.addLink(link);
            }
        }
        this.sceneManager._sceneVirtualChangeDispather.fire({
                type:'addAllLink'
        });
    },

    isDealWithBillboard : function(node){
        return true;
    },

    isDealWithParticle : function(node){
        return true;
    },

    isVirtual : function(node){
        var data = node;
        if(node instanceof mono.Element){
            data = this.getDataByNode(node);
        }
        if(!(data instanceof it.Data) && !(data instanceof it.Link)) {
           // return true;
           return false; //没有就不管了
        }
        var dataNode = this.sceneManager.getNodeByDataOrId(data);
        if (dataNode && dataNode.getClient(it.SceneManager.CLIENT_EXT_VITUAL)) { //自己管理的这里就不管了
            return false;
        }
        var id = this.getBId(data);
        var transFlag = false;
        if(id){
            if(node instanceof mono.Link){
                if(this._global_linkTmap[id]){ // 对于透明来讲，如果global中是虚化的，那怎么着它就是虚化的
                    transFlag = this._global_linkTmap[id];
                }else if(this._linkTmap[id]){
                    transFlag = this._linkTmap[id];
                }
            }else{
                if(this._global_tmap[id]){ // 对于透明来讲，如果global中是虚化的，那怎么着它就是虚化的
                    transFlag = this._global_tmap[id];
                }else if(this._tmap[id]){
                    transFlag = this._tmap[id];
                }
            }
        }
        return transFlag;
    },

    isLink : function(node){
        if(node
            && node.getClient(it.SceneManager.CLIENT_IT_DATA)
            && node.getClient(it.SceneManager.CLIENT_IT_DATA) instanceof it.Link){
            return true;
        }
        return false;
    },

    /**
     * 是否隐藏虚化的billboard，默认的情况想告警的billboard会被隐藏的，不隐藏的话，透明的会挡住没透明的
     * @param node
     */
    isHideVirtualBillboard : function(node){
        if(node
            &&node instanceof mono.Billboard
            && node.getParent()){
            // var parent = node.getParent();
            // if(parent._alarmBillboard == node){// 这样才认为这的billboard是一个告警的billboard
            //     return true;
            // }
            if (node.getClient('_alarmBillboard')) {
                return true;
            }
        }
        return false;
    },

    isHideVirtualParticle : function(node){
        if(node
            &&node instanceof mono.Particle
            && node.getParent()){
            // var parent = node.getParent();
            // if(parent._alarmBillboard == node){
            //     return true;
            // }
            if (node.getClient('_alarmParticle')) {
                return true;
            }
        }
        return false;
    },

      setFocusElement : function(element){
//          this.focusElement = element;
//          this.sceneManager.viewManager3d.network.dirtyNetwork();
      },

    setOpacityValue : function(opacityValue){
        if(opacityValue){
            this.opacityValue = opacityValue;
        }
    },

    getOpacityValue : function(data){
        if (this.getOpacityValueFunction && this.getOpacityValueFunction(data)) {
            return this.getOpacityValueFunction(data);
        }
        return this.opacityValue;
    },

    /**
     * 由于billboard的透明的处理其实不是通过真正Filter来处理的，
     * 它还是通过原始的方法在本身设置了transparent和opacity来处理的，
     * 而当你remove这个handle时，其实是不会将已经设置的billboard做处理的
     */
    destoryBillboard : function(){
        if(!this._billboard_tmap) return;
        for(var id in this._billboard_tmap){
            var billboard = this._billboard_tmap[id];
            if(billboard.hasOwnProperty('orig_opacity')){
                var orig_opacity = billboard.orig_opacity;
                if(orig_opacity == undefined){
                    orig_opacity = 1;
                }
                billboard.setStyle('m.opacity',orig_opacity);
                if(this.isHideVirtualBillboard(billboard)){
                    billboard.setVisible(true);
                }
                delete billboard.orig_opacity;
                billboard.renderDepth = 0;
                delete this._billboard_tmap[billboard.getId()];
            }
        }
    },

    destoryParticle : function(){
        if(!this._particleMap) return;
        for(var id in this._particleMap){
            var particle = this._particleMap[id];
            if(particle.hasOwnProperty('smoke_opacity')){
                var smoke_opacity = particle.smoke_opacity;
                if(this.isHideVirtualParticle(particle)){
                    particle.setStyle('m.opacity',smoke_opacity);
                }
                delete particle.smoke_opacity;
                particle.renderDepth = 0;
                delete this._particleMap[particle.getId()];
            }
        }
    },

    getParentDataByNode : function(node,scope){
      if (!node) {
        return null;
      }
      if (!scope) {
        scope = this;
      }
      var data = scope.getDataByNode(node);
      if (data) {
        return data;
      }else{
         var parentNode = node.getParent();
         return arguments.callee(parentNode,scope);
      }
    },

    filterMaterial : function(originalMaterial,filterdMaterial,node){
        if (!(this.isLink(node)) && node instanceof mono.Line) {
            return originalMaterial;
        }
        if (node && node.getClient(it.SceneManager.CLIENT_EXT_VITUAL)) { // 如果是扩展的直接就返回不管了
          return originalMaterial;
        }
        var materialMap = this.materialMap;
        var material = filterdMaterial ? filterdMaterial : originalMaterial;
        var data = this.getDataByNode(node);
        if (!data
            && (node instanceof mono.Billboard)
            && node.getParent()) { //当billboard没有data时(如：告警的的board)，此时看它父亲的状态
            data = this.getDataByNode(node.getParent());
        }
          // 可是对于没有data的node，这里是没有处理的，是不是应该一直往上找，直到有data的父亲为止 -- add by Kevin 2016-11-04
        if (!data) {
           data = this.getParentDataByNode(node);
        }
        // var opacityValue = this.opacityValue;
        var opacityValue = this.getOpacityValue(data);
        if(opacityValue == 1){
            // return originalMaterial;
            return material; // 不应该是originalMaterial,update by Kevin 2017-07-04
        }
        var id = "";
        var transFlag = false;
        if (data && data instanceof it.Link && this.isDealWithLink()){
            id = this.getBId(data);
            if (id) {
                if (this._global_linkTmap[id]) { // 对于透明来讲，如果global中是虚化的，那怎么着它就是虚化的
                      transFlag = this._global_linkTmap[id];
                } else if (this._linkTmap[id]) {
                    transFlag = this._linkTmap[id];
                }
            }
            if (transFlag) {
                this._link_tmap[node.getId()] = node.isVisible();
                node.setVisible(false);
            } else {
                if(this._link_tmap[node.getId()] != null || !(this._link_tmap[node.getId()] === undefined)){
                    node.setVisible(this._link_tmap[node.getId()]);
                    delete this._link_tmap[node.getId()];
                }
            }
            return material;
        } else {
            if (data && data instanceof it.Data) {
//                  id = data.getId();
                id = this.getBId(data);
            }
              if (id) {
                  if (this._global_tmap[id]) { // 对于透明来讲，如果global中是虚化的，那怎么着它就是虚化的
                      transFlag = this._global_tmap[id];
                  } else if (this._tmap[id]) {
                      transFlag = this._tmap[id];
                  }
              }
          }

          if (node instanceof mono.Billboard && this.isDealWithBillboard(node)) {
              if (transFlag) { // 此时得给billboard加上透明
                  node.renderDepth = 10000;
                  if (!node.hasOwnProperty("orig_opacity")) { // 加了个判断，以防中途该值有所改变
                      node.orig_opacity = node.getStyle('m.opacity');
                  }
                  this._billboard_tmap[node.getId()] = node;
                  node.setStyle('m.opacity', opacityValue);
                  if (this.isHideVirtualBillboard(node)) {
                      node.setVisible(false); //这样可能会存在一个问题，那就是它本来就是隐藏着的
                  }
              } else { // 得去掉上面的透明
                  if (node.hasOwnProperty('orig_opacity')
                      && this._billboard_tmap[node.getId()]) { //当new多个这个的对象并且添加到filter中时，会存在冲突,所以的用个map来保存
                      var orig_opacity = node.orig_opacity;
                      if (orig_opacity == undefined) {
                          orig_opacity = 1;
                      }
                      node.setStyle('m.opacity', orig_opacity);
                      if (this.isHideVirtualBillboard(node)) {
                          node.setVisible(true);
                      }
                      delete node.orig_opacity;
                      node.renderDepth = 0;
                      delete this._billboard_tmap[node.getId()];
                  }
              }
              return material;
          }

          //处理烟雾
          if (node instanceof mono.Particle && this.isDealWithParticle(node)) {
            if (transFlag) {
                node.renderDepth = 10000;
                if (!node.hasOwnProperty("smoke_opacity")) { // 加了个判断，以防中途该值有所改变
                    node.smoke_opacity = node.getStyle('m.opacity');
                }
                this._particleMap[node.getId()] = node;
                if (this.isHideVirtualParticle(node)) {
                    node.setStyle('m.opacity', 0.001);
                }            
            } else {
                if (this._particleMap[node.getId()] && node.hasOwnProperty('smoke_opacity')) {
                    var smoke_opacity = node.smoke_opacity;
                    if (this.isHideVirtualParticle(node)) {
                        node.setStyle('m.opacity', smoke_opacity);
                    }
                    delete this._particleMap[node.getId()];
                    node.renderDepth = 0;
                    delete node.smoke_opacity;
                }
            }
            return material;
        }

          if (!transFlag) {
              return material;
          }

          var key = filterdMaterial ? filterdMaterial.getUniqueCode() : originalMaterial.getUniqueCode();
          if (materialMap[key] == null) {
              var m = filterdMaterial ? filterdMaterial.clone() : originalMaterial.clone();
              m.transparent = true;
              if( m.opacity > opacityValue){ // 有可能有多个materialFilter，这时就以最小的opacityValue -- Kevin 2017-06-29 
                 m.opacity = opacityValue;
              }
              materialMap[key] = m;
              return m;
          } else {
              return materialMap[key];
          }
    }

});

it.VirtualManager = $VirtualManager;

var $SelectableFilter = function(){

};

mono.extend($SelectableFilter,Object, {

    isSelectable : function(node,network){
        return true;
    }
});

it.SelectableFilter = $SelectableFilter;

var $SelectableManager = function(virtualManager){
    this.virtualManager = virtualManager;
};

mono.extend($SelectableManager,$SelectableFilter,{

    isSelectable : function(node,network){
       if(this.virtualManager.isVirtual(node)){
           return false;
       }
       if(node instanceof mono.Line){
       	 return false;
       }
        return true;
    }
});

it.SelectableManager = $SelectableManager;

/**
 * 镜头管理
 * 1、进入场景的镜头设置；sceneManager.resetCamera();
 * 2、进入场景后，添加的一些动画，如：在地球上点击dc，会一层一层的进入下一级；
 * 3、最终镜头的位置和target
 **/

$CameraManager = function(sceneManager){
	this.sceneManager = sceneManager;
	this.onloadFinishFunction = null;
	this.doAnimateFunction = null;
	this.finalCameraFunction = null;
    this.beforeSceneChangeCameraFunction = null;
    this._afterPlayCameraListener = []; // sceneChangerListener中耗时的listener放到这里
	this.initCamera();
	this.callback = this.afterPlayCamera;
    this._stopCamera = false;
};

mono.extend($CameraManager,Object,{

     /**
      * 初始化镜头，这里主要是把各个情境下的镜头设置串连起来
      */
     initCamera : function(){
     	var self = this;
        // 可以在resetCamera上加上一个moveCameraCallback的方法，在场景切换时可以传，等到场景切换好，并且场景的动画执行完后再执行
     	this.sceneManager.resetCamera = function(scene, rootData,oldScene,oldRootData,clientMap){
            if (!self.sceneManager.resetCameraWhenSceneChange) {
                self.sceneManager.resetCameraWhenSceneChange = true;
                return ;
            }
            if (self._stopCamera) {
                self._stopCamera = false;
                return;
            }
     		self.setCameraForOnloadFinish(scene, rootData,oldScene,oldRootData,clientMap);
     	}

        this.sceneManager.beforeLoadSceneAnimate = function(scene, rootData,oldScene,oldRootData,callback,scope){
            if (self.beforeSceneChangeCameraFunction) {
                self.beforeSceneChangeCameraFunction(scene, rootData,oldScene,oldRootData,callback,scope)
            }else{
                if (callback) {
                  callback.call(scope);
                }
            }
        }

     },

     setStopCamera : function(stopCamera){
        this._stopCamera = (stopCamera === true);
     },

     /**
      * 要想阻止从某个场景跳到某个场景的动画，也可以通过重写这个方法来
      */
     beforePlaySceneChangeAnimate : function(scene, rootData,oldScene,oldRootData,clientMap){
        return true;
     },

    /**
     * 当场景加载完后，镜头的设置
     */
	setCameraForOnloadFinish : function(scene, rootData,oldScene,oldRootData,clientMap){
        if (!this.beforePlaySceneChangeAnimate(scene, rootData,oldScene,oldRootData,clientMap)){
            return;
        }
		var scope = this;
		var callback = function(){
			scope.doAnimate(scene, rootData,oldScene,oldRootData,clientMap);
		}
		// var callback = this.doAnimate;
		if (this.onloadFinishFunction) {
			this.onloadFinishFunction(scene, rootData,oldScene,oldRootData,callback);
			return;
		}
		var sm = this.sceneManager;
		if(sm.resetCameraWhenSceneChange){
           if (sm._currentRootNode) {
              sm.viewManager3d.getDefaultEventHandler().lookAtNodeWithOutAnimate(sm._currentRootNode);
           }else{
              sm.network3d.zoomEstimateOverview(30);
           }
        }
        sm.resetCameraWhenSceneChange = true; 
        callback.call(this,scene, rootData,oldScene,oldRootData);
	},

    /***
     * 是否执行doAnimate
     * 默认是执行的
     * 在有些情况下不需要执行这样的动画，比如：从floor跳转到Datacenter中时，不执行这个反而更加流畅，否则镜头有点乱
     */
    isDoAnimate : function(scene,rootData,oldScene,oldRootData,clientMap){
        return true;
    },

    /**
     * 场景load完后，一些动画的实现或扩展，如：点击地球上的dc，一层一层进入下一级
     */
    doAnimate : function(scene, rootData,oldScene,oldRootData,clientMap){
    	var scope = this;
    	var callback = function(){
    		scope.setFinalCamera(scene, rootData,oldScene,oldRootData,clientMap);
    	}
    	if (this.isDoAnimate(scene, rootData,oldScene,oldRootData,clientMap) && this.doAnimateFunction) {
    		this.doAnimateFunction.call(this,scene, rootData,oldScene,oldRootData,callback,clientMap);
    		return;
    	}
    	callback(scene, rootData,oldScene,oldRootData,clientMap);
    },

    /***
     * 是否执行setFinalCamera
     * 默认是执行的
     * 在有些情况下不需要执行这样的动画，比如：从floor跳转到Datacenter中时，不执行这个反而更加流畅，否则镜头有点乱
     */
    isDoFinalCamera : function(scene,rootData,oldScene,oldRootData,clientMap){
        return true;
    },

    /**
     * 镜头最终的位置,有的是通过scene中的参数配置的，有的是客户自己配置的
     * 客户设置的优先级高于scene中配置的
     */
	setFinalCamera : function(scene, rootData,oldScene,oldRootData,clientMap){
		// var scope = this;
		var callback = this.callback;
		// this.sceneManager.setSceneCamera(scene); // remove 2017-08-28,等到切换完再执行，太晚了，地球到园区时，第一次执行从地球到园区的动画没有设置scene中的fov
		if (this.finalCameraFunction) {
			this.finalCameraFunction(scene, rootData,oldScene,oldRootData,callback,clientMap);
			return;
		}
		if(callback){
			callback.call(this,scene, rootData,oldScene,oldRootData,clientMap);
		}
	},

    addAfterPlayCameraListener : function(listener,scope){
        listener.scope = scope;
        this._afterPlayCameraListener.push(listener);
    },

    removeAfterPlayCameraListener : function(listener){
        var index = this._afterPlayCameraListener.indexOf(listener);
        if(index !== -1){
            this._afterPlayCameraListener.splice(index,1);
        }
    },

    afterPlayCamera : function(scene, rootData,oldScene,oldRootData,clientMap){
        if (!this._afterPlayCameraListener) {
            return ;
        }
        for(var i = 0 ; i < this._afterPlayCameraListener.length ; i++){
            var l = this._afterPlayCameraListener[i];
            l.call(l.scope||this,scene, rootData,oldScene,oldRootData,clientMap);
        }
    },

    // getFinalCameraTargetAndPosition : function(scene, rootData,oldScene,oldRootData){
       
    // }

});

it.CameraManager = $CameraManager;



// 需要监听数据的变化
var $DataFinder = function (dataManager) {
	this.dataManager = dataManager;
	this.descentdantMap = {};
    this.ancesstorIdsMap = {};
    this.init();
};

mono.extend($DataFinder,Object,{

    /**
     * 可以提前把子孙保存起来
     */ 
    init : function(){
    },

    getGetMethod : function(key){
       var getMethod = 'get' + key.charAt(0).toUpperCase() + key.slice(1);
       return getMethod;
    },

    /**
     * 便于给搜索其他的类型提供扩展
     * @returns {*}
     */
    getDatas : function(){
        return this.dataManager.getDatas();
    },

    /**
     * 便于给其他的类型扩展
     * @param id
     * @returns {*}
     */
    getDataById : function(id){
        return this.dataManager.getDataById(id);
    },

    /**
     * 返回一个数据,用相等匹配
     * 有客户，想按照自己定义的对象来搜索，而该key不是Client中，也不是data的直接属性，有可能是data.自定义obj中的某个属性
     */
     /*
    getDataByKey : function(key,value){
       if(!key && !value){
          return null;
       }
       var searchUserData = false;
       var searchCategory = false;
       var searchDataType = false;
       if(key.toUpperCase().startsWith('U:')){
         searchUserData = true;
         key = key.slice(2);
       }else if (key.toUpperCase().startsWith('C:')) { // category
          searchCategory = true;
          key = key.slice(2);
       }else if(key.toUpperCase().startsWith('D:')){ // dataType
          searchDataType = true;
          key = key.slice(2);
       }
       var getMethod = this.getGetMethod(key);
       var i = 0,datas = this.getDatas(),data;
       for(;i < datas.length;i ++){
          data =datas[i];
          if(searchUserData){
             var userData = data.getUserData(key);
             if(userData == value){
                return data;
             }
          }else if(searchCategory){
            var category = this.dataManager.getCategoryForData(data);
            if(category[getMethod] == null){
                var userData = category.getUserData(key);
                if(userData == value){
                  return data;
                }
            }
            if(category[getMethod]() == value){
               return data;
            }
          }else if(searchDataType){
            var dataType = this.dataManager.getDataTypeForData(data);
            if(dataType[getMethod] == null){
                var userData = dataType.getUserData(key);
                if(userData == value){
                  return data;
                }
            }
            if(dataType[getMethod]() == value){
               return data;
            }
          }else if(data[getMethod] == null){
             var userData = data.getUserData(key);
             if(userData == value){
                return data;
             }
          }
          if(data[getMethod]() == value){
             return data;
          }
          if(key === 'ancestor'){//如：“位置”，则是查询其所有的子孙节点
             if(this.isChild(data,value,this)){
                 return data;
             }
          }
       }
       return null;
    },
    */

    isChild : function(data,ancestorId,scope){
        if(!data || !ancestorId){
            return false;
        }
        if(data.getId() == ancestorId){
            return true;
        }else if(data.getParentId() == ancestorId){
            return true;
        }else if(!data.getParentId()){
            return false;
        }else{
            var parentData = this.dataManager.getDataById(data.getParentId());
            var scope = scope||this;
            return scope.isChild(parentData,ancestorId,scope);
        }
    },

    /**
     * 是不是不考虑这些data，如：不想查花花草草
     * @param data
     * @returns {boolean}
     */
    filter : function(data){
        return true;
    },
    
    isVisible : function(data){
        if (data) {
            var category = this.dataManager.getCategoryForData(data);
            if (category && !category.isVisible()) {
                return false;
            }
        }
        return true;
    },

    /** 
     *  json like {key : "id,name", value: "xxx",type : 'string',operation : 'equal'|'like'|'between','descentdantOf'} operation,比较的类型
     *  descentdantOf 表示是指定值的后代
     */
    find : function(conditions) {
        var datas = this.getDatas();
        if (!datas || datas.length < 1) {
            return [];
        }
        var results = [];
        if (!conditions || conditions.length < 1) {
//            return datas; // 当没有查询条件时应该返回所有,不可这么返回数据源，应该返回一个副本；
            for(var i = 0 ; i < datas.length; i++){
                if(this.isVisible(datas[i]) &&
                   this.filter(datas[i])){
                     results.push(datas[i]);
                }
            }
            return results;
        }
        var data, i = 0, len = datas.length;
        for (; i < len; i++) {
            data = datas[i];
            if(!this.isVisible(data)
                ||!this.filter(data)){
                continue;
            }
            if (this.isDataConformConditions(data, conditions)) {
                results.push(data);
            }
        }
        return results;
    },

    /**
     * conditions:[{dataType:"string",key:"id,description",operation:"like", value:"rack,1"},{dataType:'',key''..},...]
     */
    isDataConformConditions : function(data,conditions){
       var conform = true;
       for(var p in conditions){
          if(!this.isDataConformCondition(data,conditions[p])){
            conform = false;
            break;
          }
       }
       return conform;
    },

    isDataConformCondition : function(data,condition,key){
        if(condition.value == '' || condition.value == null){
            return true;
        }
        var key = key || condition.key;
        var dataType = condition.dataType || 'string'; 
        if(key.indexOf(',') > 0){
            var splitKeys = key.split(',');
            for(var i = 0;i < splitKeys.length;i ++){
                if(this.isDataConformCondition(data,condition,splitKeys[i])){
                    return true;
                }
            }
            return false;
        }
        var searchUserData = false;
        var searchCategory = false;
        var searchDataType = false;
        if(key.toUpperCase().startsWith('U:')){
            searchUserData = true;
            key = key.slice(2);
        }else if (key.toUpperCase().startsWith('C:')) { // category
          searchCategory = true;
          key = key.slice(2);
        }else if(key.toUpperCase().startsWith('D:')){ // dataType
          searchDataType = true;
          key = key.slice(2);
        }
        var getMethod = this.getGetMethod(key);
        // if(data[getMethod] == null){
        //    searchUserData = true;
        // }
        var operation = condition.operation;
        var value = condition.value;
        var dataValue = null;
        // if(searchUserData || data[getMethod] == null){
        //     dataValue = data.getUserData(key);
        // }else{
        //     var getMethod = this.getGetMethod(key);
        //     dataValue = data[getMethod]();
        // }
        if(searchUserData){
            dataValue = data.getUserData(key);
        } else if (searchCategory) {
            var category = this.dataManager.getCategoryForData(data);
            if(category[getMethod] == null){
                dataValue = category.getUserData(key);
            }else {
                dataValue = category[getMethod]();
            }
        }else if(searchDataType){
            var dataType = this.dataManager.getDataTypeForData(data);
            if(dataType[getMethod] == null){
                dataValue = dataType.getUserData(key);
            }else {
                dataValue = dataType[getMethod]();
            }
        }else{
            var getMethod = this.getGetMethod(key);
            dataValue = data[getMethod]&&data[getMethod]();
        }
        if(!dataValue && key==='ancestor'){
            if(this.isChild(data,condition.value,this)){
                return true;
            }
        }
        var compareMethod = this[operation];
        if(typeof compareMethod === 'function'){
           return this[operation](value,dataValue,key); 
        }else{
           return this.other(value,dataValue,key,operation,dataType);
        }
    },
    
    /**
     * 表示相等，可能需要扩展复杂对象的相等。
     */
    equal : function(value,dataValue,key){
        if(value && dataValue){
            return value.toLowerCase() == dataValue.toLowerCase();
        }
       return dataValue == value;
    },

    like : function(value,dataValue,key){
        dataValue = dataValue + '';
        if (dataValue.trim) {
            dataValue = dataValue.trim();
        }
        if (value.trim) {
            value = value.trim();
        }
        // if(dataValue.startsWith){
        //     if(value){
        //         return dataValue.toLowerCase().startsWith(value.toLowerCase());
        //     }
        //    return dataValue.startsWith(value); 
        // }
        value = value.toLowerCase();
        dataValue = dataValue.toLowerCase();
        if (dataValue.indexOf) {
            if (dataValue.indexOf(value) >= 0) {
                return true;
            }
        }
        return false;
    },

    /**
     * 表示在之间
     */
    between : function(value,dataValue,key){
       if(value[0] || value[1]){
          if(value[0] == null) return dataValue <= value[1];
          if(value[1] == null) return dataValue >= value[0];
          return dataValue >= value[0] && dataValue<= value[1];
       }
       return false;
    },

    /**
     * 其他的，或用符号表示的，如：>、<、<=、>=、<>等 ，
     * @param value
     * @param dataValue
     * @param key
     */
    other : function(value,dataValue,key,operation,dataType){
        if(!operation){
            return this.like(value,dataValue,key);
        }
        dataType = dataType||'string';
        // 当比较数字的时候，若其中某个值为0，这里的判断应该还是true才对。  2018-1-23 add by lyz
        if ((value || value == 0) && (dataValue || dataValue == 0)) {
        // if(value && dataValue){
            if(dataType == 'number'){
                dataValue = parseFloat(dataValue);
                value = parseFloat(value);
            }else{
                if(typeof(dataValue) === 'number'){
                   dataValue += '';
                }
            }
            var operation = operation.trim();
            if(operation == '>'){
                return dataValue > value;
            }else if(operation == '<'){
                return dataValue < value;
            }else if(operation == '<='){
                return dataValue <= value;
            }else if(operation == '>='){
                return dataValue >= value;
            }else if(operation == '='){
                if(typeof(dataValue)=='number' || typeof(value)=='number'){
                     return (dataValue === value);
                }else{
                    return dataValue.toLowerCase() == value.toLowerCase();
                }
            }
        }
        return this.like(value,dataValue,key);
    },

    descentdantOf : function(value,dataValue,key){
        if(key !== 'id'){
            throw 'Only id support descentdantOf';
        }
        var data1 = this.getDataById(value);
        var data2 = this.getDataById(dataValue);
        if(data1 == null || data2 == null){
            return false;
        }
        var ancestors = this.dataManager.getAncestors(data2) || [];
        return ancestors.indexOf(data1) !== -1;
    },

});

it.DataFinder = $DataFinder;


var $BuildingToFloorHandle = function(bfAdapter) {
	this.bfAdapter = bfAdapter;
	this.sceneManager = this.bfAdapter.sceneManager;
	this.dataManager = this.sceneManager.dataManager;
	this.beforeDoubleClickFloorFunction = null;
	// this.animates = []; // 不需要缓存，导致内存泄露
};

mono.extend($BuildingToFloorHandle, Object, {

	/**
     * 在dc和building合在一起的模式下重写双击楼层的动作(doubliClick):
      边拉近镜头到点击的floor,然后它上面的floors都慢慢展开一点点，最后才切换场景
    */
	doubliClickFloorNode: function(element, network, data, clickedObj, callback) {
		if (this.beforeDoubleClickFloorFunction) {
			this.beforeDoubleClickFloorFunction(element);
		}
		if (!data) {
			return;
		}
		var parentData = this.dataManager.getDataById(data.getParentId());
		if (!parentData) {
			return;
		}
		var deHandler = this.sceneManager.viewManager3d.getDefaultEventHandler();
		var category = this.dataManager.getCategoryForData(data);
		var scene = this.dataManager.getSceneByCategory(category);
		var sceneAndRootData = this.sceneManager.getSceneAndRootByData(data);
		if (this.sceneManager._currentScene == scene && sceneAndRootData && this.sceneManager._currentRootData == sceneAndRootData.rootData) {
			deHandler.moveToClickPoint(clickedObj);
			return;
		}
		if (!scene) {
			return;
		}
		if (this.doubleClickFloorNodeFlag) {
			return;
		}
		this.sceneManager.viewManager3d.enableDBLClick = false;
		var virFilter = new it.VirtualManager(this.sceneManager);
		virFilter.opacityValue = 1;
		virFilter.addByDescendant(this.sceneManager._currentRootData);
		virFilter.removeByDescendant(data);
		this.sceneManager.viewManager3d.addMaterialFilter(virFilter);
		this.doubleClickFloorNodeFlag = true; //用于标记是不是已经点击了，并且正在执行。可是当正在执行时，点击背景，此时该怎么搞？
		var floorNodes = [];
		var self = this;
		var children = parentData.getChildren();
		var lookAtFloorNode = this.sceneManager.dataNodeMap[data.getId()];
		for (var i = children.size() - 1; i >= 0; i--) {
			var child = children.get(i);
			var childCategory = this.dataManager.getCategoryForData(child);
			if (childCategory &&
				childCategory.getId() && childCategory.getId().toLowerCase().indexOf('floor') >= 0) {
				var floorNode = this.sceneManager.dataNodeMap[child.getId()];
				if (floorNode && floorNode.getY() > lookAtFloorNode.getY()) {
					floorNodes.push(floorNode);
				}
			}
		}
		var camera = this.sceneManager.network3d.getCamera();
		if (network) {
			camera = network.getCamera();
		}

		var focusNode1 = this.sceneManager.viewManager3d.getFocusNode();

		var palyLookAtFun = function() {
			//调用前判断一下是不是换到了其他的场景(比如执行动画前点了背景)，然而怎么判断呢？通过focusNode
			var focusNode2 = self.sceneManager.viewManager3d.getFocusNode();
			if (focusNode2 != focusNode1) {
				this.doubleClickFloorNodeFlag = false;
				self.sceneManager.viewManager3d.enableDBLClick = true;
				return;
			}
			var callback1 = function() {
				camera.fov = 60; //这个值很快会被改变，这里只是为了resetCamer做准备
				/* 
				 *  // update By Kevin 2017-06-21 
				 * toScene会dataBox，_loadOneScene则不会清空dataBox
				 * 为了连贯，采取不清空，而这边单独清空dc、building，以及其兄弟floor
				 */
				// self.sceneManager.toScene(scene, data,callback);
				// self.removeDcAndBuilding(data);
				var oldScene = self.sceneManager.getCurrentScene();
				var oldRootData = self.sceneManager._currentRootData;
				self.sceneManager.resetCameraWhenSceneChange = false;//下面的场景切换时，不去调用，这样的话不会使用保存的镜头，-- 2017-09-07 Kevin
				// 需要断开其他的floor中对象与其parent的父子关系 ，loadOneScene后，会将所有的node的父子关系都建立上了
				self.sceneManager._loadOneScene(scene, data, callback); 
				//_loadOneScene中会重新加上父子关系
				if (data) {
					var dataNode = self.sceneManager.dataNodeMap[data.getId()];
					dataNode && dataNode.setParent(null);
					self.sceneManager.viewManager3d.setFocusNode(dataNode);
				}
				self.doubleClickFloorNodeFlag = false;
				self.sceneManager.viewManager3d.enableDBLClick = true;
				//2017-10-26 统一一下，使得cameraManager中的callback方法永远能执行
				if(self.sceneManager.cameraManager.callback){ 
					self.sceneManager.cameraManager.callback(scene, data,oldScene,oldRootData);
				} 
			};
			callback1();
		};

		var dataPosition = data.getPosition();
		var oldPosition = lookAtFloorNode.getWorldPosition().clone();
		var nScale = lookAtFloorNode.getScale();

		var getAbsoluteRotationByNode = function(node) {
			if (!node) {
				return null;
			}
			var rot = node.getRotation().clone();
			var parentNode = node.getParent();
			if (parentNode) {
				var pRot = getAbsoluteRotationByNode.call(this, parentNode);
				if (pRot) {
					rot.x = rot.x + pRot.x;
					rot.y = rot.y + pRot.y;
					rot.z = rot.z + pRot.z;
				}
			}
			return rot;
		}

		var rotation = getAbsoluteRotationByNode(lookAtFloorNode);
		/**
		 * 重新设置回该floor的Scale，并且将其position设置成其真实的位置
		 * 并且Camera也慢慢的拉远
		 */
		var restorePosScaleAndRotationCallback = function() {
			var fBb = lookAtFloorNode.getBoundingBox();
			var oldDistance = camera.getDistance();
			var distance = fBb.size().z > fBb.size().x ? fBb.size().x : fBb.size().z;
			distance = distance * 2;
			var angles = mono.Utils.getVectorAngles(camera.target, camera.getPosition());
			var dataRotation = data.getRotation() || new mono.Vec3();
			var restorePosAndScaleAnimate = new mono.Animate({
				from: 0,
				to: 1,
				dur: 1000,
				onUpdate: function(value) {
					var pos = new mono.Vec3().lerpVectors(oldPosition, dataPosition, value);
					lookAtFloorNode.setPosition(pos);
					if (lookAtFloorNode.orgScale) {
						var oScale = lookAtFloorNode.orgScale.clone();
						lookAtFloorNode.setScaleX(nScale.x + (oScale.x - nScale.x) * value);
						lookAtFloorNode.setScaleY(nScale.y + (oScale.y - nScale.y) * value);
						lookAtFloorNode.setScaleZ(nScale.z + (oScale.z - nScale.z) * value);
					}
					lookAtFloorNode.setRotationX(rotation.x + (dataRotation.x * mono.Utils.DEGREES_TO_RADIANS - rotation.x) * value);
					lookAtFloorNode.setRotationY(rotation.y + (dataRotation.y * mono.Utils.DEGREES_TO_RADIANS - rotation.y) * value);
					lookAtFloorNode.setRotationZ(rotation.z + (dataRotation.z * mono.Utils.DEGREES_TO_RADIANS - rotation.z) * value);

					var d = (oldDistance + (distance - oldDistance) * value); // 这个400是moveCameraToCloseFloor(之前镜头的距离)中
					
					var cPos = new mono.Vec3(); 
					// pos.x = camera.target.x + d * Math.sin(angles[0] * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(angles[1] * mono.Utils.DEGREES_TO_RADIANS);
					// pos.z = camera.target.z + d * Math.cos(angles[0] * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(angles[1] * mono.Utils.DEGREES_TO_RADIANS);
					// pos.y = camera.target.y + d * Math.sin(angles[1] * mono.Utils.DEGREES_TO_RADIANS);
					// add 直接用floor的position，也就是一直盯着floor update 2017-07-11
					var target = pos.clone();
					cPos.x = target.x + d * Math.sin(angles[0] * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(angles[1] * mono.Utils.DEGREES_TO_RADIANS);
					cPos.z = target.z + d * Math.cos(angles[0] * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(angles[1] * mono.Utils.DEGREES_TO_RADIANS);
					cPos.y = target.y + d * Math.sin(angles[1] * mono.Utils.DEGREES_TO_RADIANS);
					camera.setPosition(cPos);
					camera.lookAt(target);
				},
				onStop: function() {
					// playFinalCamera();
					palyLookAtFun();
				}
			});
            // self.animates.push(restorePosAndScaleAnimate); //始终不释放，导致内存泄露 ， 2017-10-12
			restorePosAndScaleAnimate.play();
		}

		/**
		 * 1、将镜头的焦点对着floor
		 * 2、断开floor与building的父子关系
		 * 不调用这步，直接restorePosAndScaleAnimate，这样在空间没有参照物有点不太协调，很突然的感觉
		 */
		var moveCameraToFocusFloorAndRemoveRelactionShipAnimate = function() {
			var callback = function() {
				self.removeDcAndBuilding(data);
				if (lookAtFloorNode.orgScale) {
					lookAtFloorNode.setScaleX(nScale.x);
					lookAtFloorNode.setScaleY(nScale.y);
					lookAtFloorNode.setScaleZ(nScale.z);
				}
				lookAtFloorNode.setRotationX(rotation.x);
				lookAtFloorNode.setRotationY(rotation.y);
				lookAtFloorNode.setRotationZ(rotation.z);
				lookAtFloorNode.setPosition(oldPosition);
				self.sceneManager.viewManager3d.removeMaterialFilter(virFilter);
				restorePosScaleAndRotationCallback();
			}
			// callback(); 
			// 这一步将镜头对着点中的floor 
			var distance = camera.getDistance();
			var cTarget = camera.target;
			var cPos = camera.getPosition();
			var angles= mono.Utils.getVectorAngles(cTarget, cPos);
			var vAngle = angles[1],hAngle = angles[0];
			var endTarget = lookAtFloorNode.getWorldPosition();
            // 某些情况下此处的mono.Animate不会执行下去，应该使用twaver.Animate则能正常使用
            // 某些情况包括：当处于楼层展开状态时，若在此时使用lookAtByData看向某个楼层，则会产生这种情况 2017-12-12 add by lyz
			var animate = new twaver.Animate({
				from: 0,
				to: 1,
				dur: 1000,
				onUpdate: function(value) {
					var t = new mono.Vec3().lerpVectors(cTarget,endTarget, value); 
					var newPos = new mono.Vec3();
					newPos.x = t.x + distance * Math.sin(hAngle * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(vAngle * mono.Utils.DEGREES_TO_RADIANS);
					newPos.z = t.z + distance * Math.cos(hAngle * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(vAngle * mono.Utils.DEGREES_TO_RADIANS);
					newPos.y = t.y + distance * Math.sin(vAngle * mono.Utils.DEGREES_TO_RADIANS);
					camera.p(newPos);
					camera.lookAt(t);
				},
				onStop: function() {
					callback();
				}
			});
			animate.play();
		}

		/**
		 * 边展开边消失
		 */
		var doubliClickFloorNodeAnimate = new mono.Animate({
			from: 0,
			to: 1,
			dur: 1000,
			easing: 'easeOut',
			onUpdate: function(value) {
				for (var i = floorNodes.length - 1; i >= 0; i--) {
					var floor = floorNodes[i];
					var floorData = self.sceneManager.getNodeData(floor);
					var y = parseFloat(floorData.getPosition().y / 10);
					floor.setY(y + 50 + 200 * value);
				}
				virFilter.opacityValue = (1 - value);
				virFilter.materialMap = {};
			},
			// onDone: function() { //不管是stop还是正常执行完，这个一定是被执行
			onStop: function() {
				moveCameraToFocusFloorAndRemoveRelactionShipAnimate();
			}
		});
		doubliClickFloorNodeAnimate.play();

	},

	/**
	 * 清除DataBox中的所有3D对象，除了exceptData外
	 * exceptData上的孩子也不应该删除？或者在下一个场景(应该是floor)中存在时就不应该移除
	 */
	removeDcAndBuilding: function(exceptData) {
		if (!exceptData) {
			return;
		}
		var exceptNode = this.sceneManager.getNodeByDataOrId(exceptData);
		for (var id in this.sceneManager.dataNodeMap) {
			var node = this.sceneManager.dataNodeMap[id];
			if (node && !this.sceneManager.isAncestor(id,exceptData.getId())) {//理论上判断id和exceptData是不是在同一个场景中更加合理
				node.setParent(null);
			}
		}
		for (var id in this.sceneManager.dataNodeMap) {
			var node = this.sceneManager.dataNodeMap[id];
			if (node && id != exceptData.getId() && !this.sceneManager.isAncestor(id,exceptData.getId())) {
				this.sceneManager.network3d.dataBox.removeByDescendant(node);
			}
		}
	},



});
/**
 * 从楼层退回到园区
 * 主要流程：
 * 1、创建一个虚化管理器，并且opacityValue为0(相当于隐藏)，将dc及其所有的除了当前floor之外的对象都放到虚化管理器中；
 * 2、load园区的所有对象，注意这个load不是场景切换的load，并设置focusNode为building；
 * 3、播放当前floor的动画，将它移动到最终在building上的位置，同时变换scale和rotation；3秒
 * 4、慢慢的改变1步创建的虚幻管理器的opacityValue的值，是所有的对象慢慢显示；3秒
 * 5、显示好后移除1步的虚幻管理器，并且从databox中移除floor中的所有孩子；
 * 需要注意的是：
 * 1、其他floor场景的父子关系也应该切断
 * 2、在Floor场景下，通过其他的途径进入DC时的处理(如：在floor场景下，点击搜索树或面包屑上的dc的方式进入dc)
 * 
 */
var $FloorToBuildingHandle = function(bfAdapter) {
	this.bfAdapter = bfAdapter;
	this.sceneManager = bfAdapter.sceneManager;
	this.virFilter = new it.VirtualManager(this.sceneManager);
	this.virFilter.opacityValue = 0.01;
	// virFilter.addByDescendant(this.sceneManager._currentRootData);
	// virFilter.removeByDescendant(data);
	// this.oldIsNeedSetParent = this.sceneManager.isNeedSetParent; //可以这么早就保存了，3d机房
	// this.oldTranslatePosition = this.sceneManager.translatePosition;
	this.oldResetCamera = this.sceneManager.resetCamera;
	this.defaultEventHandler = this.sceneManager.viewManager3d.defaultEventHandler;
	this.animates = [];
	this.init();
};

mono.extend($FloorToBuildingHandle, Object, {

	init: function() {
		var self = this;
        
        /*
		var oldGotoUpLevelSceneFor3D = this.sceneManager.gotoUpLevelSceneFor3D;
		this.sceneManager.gotoUpLevelSceneFor3D = function() { //当不是点的背景呢？
			var scene = self.sceneManager._currentScene;
			if (!scene) {
				return false;
			}
			var rootNode = self.sceneManager._currentRootNode;
			var rootData = self.sceneManager._currentRootData;
			if (!rootNode && !rootData) {
				return false;
			}
			var data = self.sceneManager.getNodeData(rootNode);
			if (!data) {
				data = rootData;
			}
			var parentData = self.sceneManager.getUpLevelDataByData(data);
			if (!parentData) {
				return false;
			}
			var parentScene = self.sceneManager.getSceneAndRootByData(parentData);
			if (!parentScene || !parentScene.scene) {
				return false;
			}
			if (parentScene.scene.getId().toLowerCase() == 'datacenter' && scene.getId() == 'floor') {
				self.doFloorToDatacenter(parentScene.scene, parentScene.rootData, scene, data);
			} else {
				oldGotoUpLevelSceneFor3D.call(self.sceneManager);
			}
		}
		*/
	},
     
    /**
     * 摧毁，初步计划是可以动态的扭转floor-dc的业务流程
     */
	destroy: function(){

	},

	// 增加了floor到building的gotoSceneCallback。解决问题是，在floor点击dc的导航，需要直接进去dc，而不是building。因此在gotoScene前往building后，在进行一些操作，进入dc
	// 2017-12-12 add by lyz
	doFloorToDatacenter: function(dcScene, dc, floorScene, floor, gotoSceneCallback) {
		var self = this;
		/**
		 * 在floor场景load园区后，不设置该floor的父亲，也不设置其位置和rotation，以及镜头也不动 
		 */
		this.oldIsNeedSetParent = this.sceneManager.isNeedSetParent; 
		this.sceneManager.isNeedSetParent = function(data, node) {
			if (data == floor) {
				return false;
			} else {
				return self.oldIsNeedSetParent.call(self.sceneManager, data, node);
			}
		}
		this.oldTranslatePosition = this.sceneManager.translatePosition;
		this.sceneManager.translatePosition = function(data) {
			if (data == floor) {
				return null;
			} else {
				return self.oldTranslatePosition.call(self.sceneManager, data);
			}
		}
        //这样直接重写，得有个地方还原！！！
        var oldResetCamera = this.sceneManager.resetCamera;
		this.sceneManager.resetCamera = function() {
			return null;
		}

        this.sceneManager.viewManager3d.enableDBLClick = false;
		var floorNode = this.sceneManager.getNodeByDataOrId(floor);
		/**
		 * 将load的动西全部隐藏掉，其透明度为0，除了当前的floor外
		 */
		this.sceneManager.viewManager3d.addMaterialFilter(this.virFilter);
		this.virFilter.opacityValue = 0;
		this.virFilter.materialMap = {};
		this.virFilter.addByDescendant(dc);
		this.virFilter.removeByDescendant(floor);
		var defaultHandler = this.sceneManager.viewManager3d.defaultEventHandler;

		// this.bfAdapter.bindingBuildingAndFloorVisibleManager.setVisible(floor, true);//默认在园区floor都隐藏 
		var callback = function(endCallback) {
			var buildingNode = self.sceneManager.getNodeByDataOrId(floor.getParentId());
			var bData = self.sceneManager.dataManager.getDataById(floor.getParentId());
			// var floorNodes = self.getFloorsByBuildingNode(buildingNode);
			var dcNode = self.sceneManager.getNodeByDataOrId(bData.getParentId());
			if (dcNode) {
				// self.sceneManager.viewManager3d.setFocusNode(dcNode); // 有可能是直接从其他的入口进入的，退回去时，先处理一下dc
				//需要注意的是这里也会触发switchBuilding，会导致回退f时floor一下子就是scale后的状态
				self.sceneManager.viewManager3d.defaultMaterialFilter.addAll();
                self.sceneManager.viewManager3d.defaultMaterialFilter.removeByDescendant(dcNode);
			}
			self.sceneManager.viewManager3d.setFocusNode(buildingNode);
			var floorNodes = self.getFloorsByBuildingNode(buildingNode); // 放到setFocus之后 2017-10-11，否则开启了floor的延迟加载和清空缓存会有问题
			// if (floorNodes && floorNodes.length > 1) { 
			// 	defaultHandler.moveCameraForLookAtNodes(floorNodes, null, 30);
			// } else {
			// 	defaultHandler.moveCameraForLookAtNode(buildingNode, callback1);
			// }
			self.sceneManager.viewManager3d.defaultMaterialFilter.clear(); // 脱离BuidingAndFloorChangeAdapter，自己管理
			// self.sceneManager.viewManager3d.defaultMaterialFilter.add(bData);
			// 场景切换到dc后，该floor上的building需要虚化，但是兄弟floor不需要，还有就是需要重新设置兄弟floor的位置
			self.sceneManager.viewManager3d.defaultMaterialFilter.addByDescendant(bData); //建筑上的非floor的孩子也要虚幻
			for (var i = 0; i < floorNodes.length; i++) {
				var fNode = floorNodes[i];
				var fData = self.sceneManager.getNodeData(fNode);
				self.sceneManager.viewManager3d.defaultMaterialFilter.removeByDescendant(fData);
				// self.bfAdapter.bindingBuildingAndFloorVisibleManager.setVisible(fData, true); //可是在sceneChange时将floor都设置成了不显示
				if (fData != floor) {
					fNode.setParent(buildingNode);
					fNode.setY(fData.getPosition().y / 10 + 50); // +50是展开后弹的开的高度
					self.sceneManager.computeRotation(fData, bData, fNode, buildingNode);
					var fScale = self.getFloorScaleInDc(fNode, buildingNode) || new mono.Vec3(1, 1, 1);
					fNode.setScale(fScale);
				}
			}
			setTimeout(function() {
				self.removeChildrenByFloorNode(floorNode);
				self.doFloorPRSAnimate(floorNode,endCallback);
			}, 500);
		}
		//这里先情况一半然后再load，最后再清空之前的另一半，这里很容易出现bug
		//2017-10-20 不能清除一半，父子关系没有断掉的话，在_loadOneScene中会给node重新设置it_data_id和it_data会把floor的孩子机柜设备都置成了floor
		// this.clearOtherFloorParentRelaction(floor); 
		this.clearOtherFloorParentRelaction(); 
		this.animates = [];
		var oldScene = self.sceneManager.getCurrentScene();
		var oldRootData = self.sceneManager._currentRootData;
		this.sceneManager._loadOneScene(dcScene, dc);
		// this.setBrotherFloorPositionY(floor);
		this.sceneManager.resetCamera = oldResetCamera; // 还原
		var endCallback = function(){
			if(self.sceneManager.cameraManager.callback){ 
				self.sceneManager.cameraManager.callback(dcScene, dc,oldScene,oldRootData);
			}
			gotoSceneCallback&&gotoSceneCallback();
		};
		callback(endCallback);
		this.sceneManager.isNeedSetParent = this.oldIsNeedSetParent;
		this.sceneManager.translatePosition = this.oldTranslatePosition;
	},

    /**
     * 回到园区时，楼层是展开且弹开的，上升了50
     */
    /*
	setBrotherFloorPositionY : function(floor){
		if (!floor) {
			return ;
		}
		var parent = this.sceneManager.dataManager.getDataById(floor.getParentId());
		var children = parent.getChildren();
		if (children && children.size() > 1) {
			for(var i = 0 ; i < children.size() ; i++){
				var child = children.get(i);
				var cCategory = this.sceneManager.dataManager.getCategoryForData(child);
				if (cCategory 
					&& cCategory.getId() == 'floor' 
					&& child != floor) {
					var childNode = this.sceneManager.getNodeByDataOrId(child);
				    childNode.setY(childNode.getY() + 50);
				}
			}
		}
	},
	*/

    /**
     * 清除其他楼层的父子关系，特别是楼层和楼层的孩子
     * 否则当从楼层切换到楼层，然后再退回到dc时，会有问题
     */
	clearOtherFloorParentRelaction: function(floor){
		var floors = this.sceneManager.dataManager._categoryDatas['floor'];
		if (!floors) {
			return ;
		}
		var self = this;
		for(var id in floors){
			var fData = this.sceneManager.dataManager.getDataById(id);
			if (fData && fData != floor 
				&& fData.getChildren() 
				&& fData.getChildren().size() > 0) {
				// fData.getChildren().forEach(function(child){
				// 	var childNode = self.sceneManager.getNodeByDataOrId(child);
				// 	if (childNode) {
				// 		childNode.setParent(null);
				// 	}
				// });
                this.clearRelactionByParentData(fData);
			}
		}
	},

	/**
	 *
	 * 改变floor的position、rotation、scale,使之变成在园区时的值
	 * 还有就是需要改变Camera，使之lookAt该floor对应的building
	 *
	 */
	doFloorPRSAnimate: function(floor,endCallback) {
		if(!floor){
			this.sceneManager.viewManager3d.enableDBLClick = false;
			return;
		}
		var self = this;
		var buildingNode = this.getBuildingNodeByFloor(floor);
		var floorNodes = this.getFloorsByBuildingNode(buildingNode);
		var endPos = this.getFloorPositionInDc(floor,buildingNode) || new mono.Vec3();
		var endRot = this.getFloorRotationInDc(floor,buildingNode) || new mono.Vec3();
		var endScale = this.getFloorScaleInDc(floor,buildingNode)  || new mono.Vec3(1,1,1);
		var camera = this.sceneManager.network3d.getCamera();
		var oldTarget = camera.target.clone();
		// 算最终的target和pos，那floorNodes也应该是终止状态，但是此时当前的floor并没有缩放，暂时用building(不合理，bb没有)
		var tarAndPos = null;
		if (floorNodes.length == 1) {
			tarAndPos = this.defaultEventHandler.getCameraTarAndPosForLookAtNodes([buildingNode],30);
		}else{
			 var endingFloors = this.getEndingFloorsByFloors(floorNodes,buildingNode,floor);
			 tarAndPos = this.defaultEventHandler.getCameraTarAndPosForLookAtNodes(endingFloors,30);
		}
		// var tarAndPos = this.defaultEventHandler.getCameraTarAndPosForLookArNodes([buildingNode],30);
		var angles = mono.Utils.getVectorAngles(tarAndPos.target, tarAndPos.position);
		
		var oldDistance = camera.getDistance();
		var newDistance = tarAndPos.position.distanceTo(tarAndPos.target);
		var fPos = floor.getWorldPosition();
		var fRot = floor.getRotation();
		var fScale = floor.getScale();
		var animate = new mono.Animate({
			from: 0,
			to: 1,
			dur: 2000,
			onUpdate: function(value) {
				var pos = new mono.Vec3().lerpVectors(fPos, endPos, value);
				floor.setPosition(pos);
				floor.setScaleX(fScale.x + (endScale.x - fScale.x) * value);
				floor.setScaleY(fScale.y + (endScale.y - fScale.y) * value);
				floor.setScaleZ(fScale.z + (endScale.z - fScale.z) * value);
				floor.setRotationX(fRot.x + (endRot.x - fRot.x) * value);
				floor.setRotationY(fRot.y + (endRot.y - fRot.y) * value);
				floor.setRotationZ(fRot.z + (endRot.z - fRot.z) * value);
                
                var target = new mono.Vec3().lerpVectors(oldTarget, tarAndPos.target, value);
				var d = (oldDistance + (newDistance - oldDistance) * value); // 这个400是moveCameraToCloseFloor(之前镜头的距离)中
				var cameraPos = new mono.Vec3();
				cameraPos.x = target.x + d * Math.sin(angles[0] * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(angles[1] * mono.Utils.DEGREES_TO_RADIANS);
				cameraPos.z = target.z + d * Math.cos(angles[0] * mono.Utils.DEGREES_TO_RADIANS) * Math.cos(angles[1] * mono.Utils.DEGREES_TO_RADIANS);
				cameraPos.y = target.y + d * Math.sin(angles[1] * mono.Utils.DEGREES_TO_RADIANS);
				camera.setPosition(cameraPos);
				camera.lookAt(target);
			},
			onStop: function() {
				self.setFloorRelationShipAndPosition(floor,buildingNode);
				self.doFadeOutAnimate(floor,floorNodes,endCallback);
				self.animates = [];// 运行完了释放 2017-10-12
			}
		});
        this.animates.push(animate);
		animate.play();
	},

	/**
	 * 隐藏的东西慢慢的显示出来
	 */
	doFadeOutAnimate: function(floorNode,floorNodes,endCallback) {
		var self = this;
		var animate = new mono.Animate({
			from: 0,
			to: 1,
			dur: 2000,
			onUpdate: function(value) {
				self.virFilter.opacityValue = 0.16 + (1-0.16) * value ; //最下值应该是其正常情况下的透明度值
                self.virFilter.materialMap = {};
                self.sceneManager.network3d.dirtyNetwork();
			},
			onStop: function() {
				self.sceneManager.viewManager3d.removeMaterialFilter(self.virFilter);
				self.sceneManager.viewManager3d.enableDBLClick = true;
				// self.removeChildrenByFloorNode(floorNode);
				if (!floorNodes || floorNodes.length <= 1) {
					self.sceneManager.viewManager3d.setFocusNode(self.sceneManager.getCurrentRootNode());
				}
				self.animates = [];//运行完了释放 2017-10-12
				endCallback && endCallback();
			}
		});
		this.animates.push(animate);
		animate.play();
	},

	stopAllAnimate : function(){
		if (this.animates && this.animates.length > 0) {
			for(var i = 0 ; i < this.animates.length ; i++){
				var animate = this.animates[i];
				animate.stop();
			}
		}
		this.animates = [];
	},

	setFloorRelationShipAndPosition: function(floorNode, buildingNode) {
		if (!floorNode || !buildingNode) {
			return;
		}
		var fData = this.sceneManager.getNodeData(floorNode);
		var bData = this.sceneManager.getNodeData(buildingNode);
		var pos = new mono.Vec3();
		var rot = new mono.Vec3();
		if (fData.getPosition()) {
			pos.setY(fData.getPosition().y / 10 + 50); //+50是展开并弹开后的
			pos.setX(fData.getPosition().x);
			pos.setZ(fData.getPosition().z);
		}
		this.sceneManager.computeRotation(fData,bData,floorNode,buildingNode);
		floorNode.setPosition(pos);
		// floorNode.setRotation(rot);
		floorNode.setParent(buildingNode);
	},

    /**
     * 移除该楼层中所有的对象，并且断掉这些对象的父子关系
     * 是不是也需要考虑切断其他楼层的父子关系呢？
     *  如：从floor01切到floor02，然后再返回到dc
     */
	removeChildrenByFloorNode : function(floorNode){
		if (!floorNode) {
			return;
		}
		var floorData = this.sceneManager.getNodeData(floorNode);
		this.sceneManager.network3d.dataBox.removeByDescendant(floorNode);
		this.clearRelactionByParentData(floorData);
		this.sceneManager.network3d.dataBox.addByDescendant(floorNode);
		if (this.sceneManager.isClearCache) {
			this.sceneManager.clearCache();
		}
	},

	clearRelactionByParentData : function(parentData){
		if (!parentData) {
			return;
		}
		var children = parentData.getChildren();
		if (!children || children.size() < 1) {
			return ;
		}
		for(var i = 0 ; i < children.size() ; i++){
			var child = children.get(i);
			var childNode = this.sceneManager.getNodeByDataOrId(child);
			if (childNode) {
				childNode.setParent(null);
			}
			this.clearRelactionByParentData.call(this,child);
		}
	},

	getBuildingNodeByFloor : function(floor){
		if (!floor) {
			return null;
		}
		var fData = this.sceneManager.getNodeData(floor);
		var parentId = fData.getParentId();
		var pCategory = this.sceneManager.dataManager.getCategoryForData(parentId);
		if (pCategory && pCategory.getId().toLowerCase() == 'building') {
			return this.sceneManager.getNodeByDataOrId(parentId);
		}
		return null;
	},

	getFloorsByBuildingNode: function(buildingNode) {
		var bData = this.sceneManager.getNodeData(buildingNode);
		var children = bData.getChildren();
		var floors = [];
		for (var i = 0; i < children.size(); i++) {
			var child = children.get(i);
			var childCategory = this.sceneManager.dataManager.getCategoryForData(child);
			if (childCategory &&
				childCategory.getId() && childCategory.getId().toLowerCase().indexOf('floor') >= 0) {
				var floorNode = this.sceneManager.dataNodeMap[child.getId()];
			    floors.push(floorNode);
			}
		}
		return floors;
	},

	getEndingFloorsByFloors : function(floorNodes,buildingNode,currentloor){
		if (!floorNodes) {
			return null;
		}
		var cloneFloors = [];
		for (var i = 0; i < floorNodes.length; i++) {
			var fn = floorNodes[i];
			var cfn = fn.clonePrefab();
			if (fn == currentloor) {
				var scale = this.getFloorScaleInDc(currentloor,buildingNode);
				if(scale){
					cfn.setScale(scale);
				}
				var fnPos = fn.p().clone();
				fnPos.setY(fnPos.y/10);
				cfn.setPosition(buildingNode.p().clone().add(fnPos));//该floor的位置还没有相对父亲
			}else{
				cfn.setPosition(fn.getWorldPosition());
			}
			cloneFloors.push(cfn);
		}
		return cloneFloors;
	},
    
    /**
     * 获取floor在dc场景中的位置：
     * y是缩小了10倍的
     * x,z是（0，0），可以0，0也不太对，在园区中有偏移量
     */
	getFloorPositionInDc: function(floor,buildingNode) {
		if (!floor || !buildingNode) {
			return null;
		}
		var fData = this.sceneManager.getNodeData(floor);
		if (buildingNode) {
			var pos = buildingNode.getWorldPosition().clone();
			if (fData.getPosition() && fData.getPosition().y) {
				pos.setY(pos.y+fData.getPosition().y/10 +  50); //+50是展开并弹开后的
				pos.setX(pos.x+fData.getPosition().x);
				pos.setZ(pos.z+fData.getPosition().z);
			}
			return pos;
		}
		return null;
	},

    /**
     * 获取floor在dc场景中的旋转角度（绝对）
     */
	getFloorRotationInDc: function(floor,buildingNode) {
		if (!floor || !buildingNode) {
			return null;
		}
		var rotation = new mono.Vec3();
		if (floor) {
			rotation = floor.getRotation().clone();
		}
		var bRot = buildingNode.getRotation().clone();
		if (bRot) {
			rotation = rotation.add(bRot);
		}
		return rotation;
	},

	getFloorScaleInDc: function(floor, buildingNode) {
		if (!floor || !buildingNode) {
			return null;
		}
		var bData = this.sceneManager.getNodeData(buildingNode);
		var bSacle = buildingNode.getScale();
		// var buildingBoundingBox = buildingNode.getBoundingBox();
		var buildingBoundingBox = it.Util.getBoundingBox(buildingNode);
		var children = bData.getChildren();
		var minScaleX = 10,
			minScaleZ = 10; // 用最大的，如果每个floor都不一样大时,所有的floor都用等比例缩放
		for (var i = 0; i < children.size(); i++) {
			var child = children.get(i);
			var childCategory = this.sceneManager.dataManager.getCategoryForData(child);
			if (childCategory &&
				childCategory.getId() && childCategory.getId().toLowerCase().indexOf('floor') >= 0) {
				var floorNode = this.sceneManager.dataNodeMap[child.getId()];
				if (floorNode) {
					if (!floorNode.orgScale) {
						floorNode.orgScale = floorNode.getScale().clone();
					}
					if (!floorNode.orgPosY) {
						floorNode.orgPosY = floorNode.getPositionY();
					}
					var floorNodeBoundingBox = floorNode.getBoundingBox();
					if (buildingBoundingBox && floorNodeBoundingBox) {
						var bbSize = buildingBoundingBox.size();
						var fSize = floorNodeBoundingBox.size();
						var scaleX = 0.1,
							scaleZ = 0.1;
						if (bbSize && fSize) {
							if (bbSize.x != -Infinity && bbSize.x != Infinity && fSize.x != -Infinity && fSize.x != Infinity) {
								scaleX = bbSize.x / fSize.x;
							}
							if (bbSize.z != -Infinity && bbSize.z != Infinity && fSize.z != -Infinity && fSize.z != Infinity) {
								scaleZ = bbSize.z / fSize.z;
							}
						}
						if (scaleX < minScaleX) {
							minScaleX = scaleX;
						}
						if (scaleZ < minScaleZ) {
							minScaleZ = scaleZ;
						}
					}
				}
			}
		}
		// return new mono.Vec3(minScaleX * bSacle.x, 0.1, minScaleZ * bSacle.z);
		var scale = minScaleX>minScaleZ ? minScaleZ : minScaleX;
		return new mono.Vec3(scale * bSacle.x, scale>0.1?scale:0.1, scale * bSacle.z);
	}
});

/**
 * 焦点改变的基类适配
 * 类似于真假切换这样的功能都可以通过继承该类来实现
 *
 * 备注：
 *   1、类似于直接从通道或其他的机柜直接看到机柜的情况，其实这样会触发两个动作：
 *        动作1：真到假
 *        动作2：假到真
 *   2、
 */
$BaseFocuseChangeAdapeter = function(sceneManager){
	this.sceneManager = sceneManager;
	this.dataManager = this.sceneManager.dataManager;
	this.box = this.sceneManager.network3d.getDataBox();
};

mono.extend($BaseFocuseChangeAdapeter,Object,{

 //    //bug 2016-11-21 从dc-building顶上的孩子(冷水塔),dc是有真假的
 //    /*add 注意 by Kevin 2016-12-01
 //    注意：由于此类会被很多类继承，很有可能最开始执行的改变了某些属性使得后来的没法正常执行，如：
 //       最开始的complexNodeAndSimpleNodeChangeAdapter执行后，complexNode和simpleNode的父子关系已经改变过，
 //       接下来的的实例就很有可能执行不了,realToFake 和 fakeToReal了
 //     改进：将这块移到其管理类中，然后在realToFake、fakeToReal以及focusNodeChange中遍历BaseFocuseChangeAdapeter的实例，然后一一执行,这
 //          样就不会遗漏没有执行的，但是在每个BaseFocuseChangeAdapeter实例中，需要注意所得到的node和oldNode的某些属性(如:真假对象的父子关系,以及是否加到了box中)
 //          可能被之前执行的实例更改过
 //          移至其管理类(PropertyChangeAdaperManager)中
 //    */
	// focusChange: function(event) {
	// 	var self = this;
	// 	if (event && event.property == "focusNode") {
	// 		var oldNode = event.oldValue;
	// 		var node = event.newValue;
	// 		if (oldNode) {
	// 			var simpleNode = oldNode.getClient('simpleNode');
	// 			//真 —— 假 ,并且不是父子(如果是lookAt机柜 到 lookAt该机柜中的设备，此时是不需要卸载的，可是如果是孙子呢？？？，因此改成不是子孙)
	// 			if (simpleNode && simpleNode.getParent() != oldNode && !self.isChild(oldNode, node)) {
	// 				self.realToFake(oldNode, node);
	// 			}
	// 		}

	// 		if (node) {
	// 			var complexNode = node.getClient('complexNode');
	// 			if (complexNode && complexNode.getParent() != node) { // 假 —— 真 
	// 				var simpleNode = node.getClient('simpleNode');
	// 				self.fakeToReal(oldNode, node);
	// 			}
	// 		}

	// 		self.focusNodeChange(oldNode, node);
	// 	}
	// },

	// isChild : function(parentNode,childNode,scope){
	// 	scope = scope || this;
 //        if(!parentNode || !childNode){
 //            return false;
 //        }
 //        var pdata = parentNode;
 //        if (parentNode instanceof mono.Element) {
 //        	pdata = scope.sceneManager.getNodeData(parentNode);
 //        }
 //        if(!pdata) {
 //            return false;
 //        }
 //        var cdata = childNode;
 //        if (childNode instanceof mono.Element) {
 //        	cdata = scope.sceneManager.getNodeData(childNode);
 //        }
 //        if(!cdata || !(cdata instanceof $Data)){
 //            return false;
 //        }
 //        var pDataScene = scope.sceneManager.getSceneFromData(pdata);
 //        var cDataScene = scope.sceneManager.getSceneFromData(cdata);
 //        if ((!pDataScene && cDataScene) 
 //        	|| (pDataScene && !cDataScene)
 //        	|| (pDataScene != cDataScene)) {
 //        	return false;
 //        }
 //        if(cdata.getParentId() && cdata.getParentId() === pdata.getId()){
 //            return true;
 //        }else{
 //        	var cdataParent = scope.sceneManager.dataManager.getDataById(cdata.getParentId());
 //        	return scope.isChild(pdata,cdataParent,scope);
 //        }
 //        // return false;
 //    },
    
    /**
     * 真的切换到（假的/真的[这个"真"是其他的真]）
     */
    realToFake :function(oldNode,node){

    },

    /**
     * (假的/真的)切换到真的
     */
    fakeToReal : function(oldNode,node){

    },

    /**
     * 只是焦点改变时
     */
    focusNodeChange :function(oldNode,node){

    },

    startInit : function(){

    },

    destroy : function(){

    }


});

it.BaseFocuseChangeAdapeter = $BaseFocuseChangeAdapeter;



/**
 * 简单对象和复杂对象切换适配
 * 如视角从机柜 到 看到其他的机柜(或通道等)
 * add 2017-07-14:需要考虑跨场景的情况，如从机柜切换到building时，
 *   有可能building所在的dc也有真假的问题，所以如果你不去对dc做真假切换只对机柜和building做真假切换的话，
 *   园区此时是出不来的，所以你需要考虑到这种情况。目前就dc比较特别
 *   目前对于一级一级lookAt下去的话，看到了孙子grant是不会切换成假的了——这块没错
 *      所以对于fakeToReal时，如果parent是假(并且在同一场景中)的话也需要切成真的，
 *  ——— 这块的处理移至AdapterManager中，因为有可能自身没有真假对象，但是父亲有的情况，这种情况就不走这里了
 */
$ComplexNodeAndSimpleNodeChangeAdapter = function(sceneManager){
	$BaseFocuseChangeAdapeter.call(this,sceneManager);
};

mono.extend($ComplexNodeAndSimpleNodeChangeAdapter,$BaseFocuseChangeAdapeter,{
	/**
     * 真的切换到假的
     * 如果old是link，并且link的某个端正好在该真对象中的，比如:oldNode(link)连接的是node中的设备或端口
     */
	realToFake: function(oldNode, node) {
		if (!oldNode) { //其实基类已经处理了，这里绝对不会为空
			return null;
		}
		var self = this;
		var complexNode = oldNode.getClient('complexNode');
		var simpleNode = oldNode.getClient('simpleNode');
		var data = this.sceneManager.getNodeData(oldNode);
		complexNode.setParent(null);
		simpleNode.setParent(oldNode);
		if (this.box.getDataById(oldNode.getId())) { //表示没有clear（即没移到其他的场景中）,注意如果从机柜一下子跳到了dc场景呢？？
			var fromNode = null,toNode = null;
			var nodeData = this.sceneManager.getNodeData(node);
			if (nodeData && nodeData instanceof it.Link) {
				fromNode = this.sceneManager.getNodeByDataOrId(nodeData.getFromId());
				toNode =  this.sceneManager.getNodeByDataOrId(nodeData.getToId());
			}
			// 这里的filter需要好好捋捋
			this.box.removeByDescendant(oldNode, false, function(child) {
				var childData = self.sceneManager.getNodeData(child);
				var childType = self.dataManager.getDataTypeForData(childData);
				if (childType && !childType.isLazyable()) {
					return false;
				}
				if (fromNode && (fromNode == child || child.getParent() == fromNode)) { //设备或端口
					return false;
				}
				if (toNode && (toNode == child || child.getParent() == toNode)) {
					return false;
				}
				if (childData && data && childData.getParentId && childData.getParentId() === data.getId()) {
					return true;
				}
				return false;
			});
			this.box.removeByDescendant(complexNode);
			this.box.addByDescendant(simpleNode, function(node) {
				return true;
			});
			this.sceneManager._sceneManagerChangeDispatcher.fire({
				kind: 'change',
				data: oldNode
			});
		}
		// 并把门关上：
		this.sceneManager.viewManager3d.getDefaultEventHandler().closeDoor(complexNode);
	},

    /**
     * 假的切换到真的
     */
	fakeToReal: function(oldNode, node) {
		if (!node) {
			return;
		}
		var simpleNode = node.getClient('simpleNode');
		var complexNode = node.getClient('complexNode');
		simpleNode.setParent(null);
		complexNode.setParent(node);
		this.box.addByDescendant(complexNode, function(node) {
			return true;
		});
		this.box.removeByDescendant(simpleNode);
		this.sceneManager._sceneManagerChangeDispatcher.fire({
			kind: 'change',
			data: node
		});
	},
	
	/**
	 * 这个函数通过rack的后代元素获取rack（包括rack自身这种情况）
	 */
	getRackByData: function(curData){
		if(!curData) return null;
		var curDataId = this.sceneManager.dataManager.getCategoryForData(curData).getId();
		if(curDataId == 'rack'){
			return curData;
		}else{
			if(curDataId == 'earth'){
				return null;
			}
			curData = this.sceneManager.dataManager.getParent(curData);
			return this.getRackByData(curData);
		}
	},
	/*
	* 返回设备node的初始状态，如card有一个弹出动画，这里将处于动画的node回复初始状态
	*/
	clearNodeState: function(node){
		if(!node) return;
		//将处于弹出状态的card收回
		if(this.sceneManager.viewManager3d.getDefaultEventHandler().isPlayAnimate(node)){
			if(node.getClient('animation') && (node.getClient('animated') === true)){
				make.Default.playAnimation(node,node.getClient('animation'),null);
			}   
		}
	},


	/*	
	*	这个方法仅仅处理了从rack子元素以及孙子元素等后代到机柜外部的情况
    *	其它的情况不能在这里拦下
	*	当rack自身为oldNode的情况也最好不要在这里拦截，因为在其它地方有处理
	*   -- add Yaphets 2017-11-23
	*/
	focusNodeChange: function (oldNode, node) {
		if (!oldNode) {
			return;
		}
		var oldData = this.sceneManager.getNodeData(oldNode),
		oldDataCategory = this.sceneManager.dataManager.getCategoryForData(oldData),
		oldCategoryId = oldDataCategory.getId(),
		data = this.sceneManager.getNodeData(node),
		oldRackData = this.getRackByData(oldData),
		newRackData = this.getRackByData(data);
		if (oldDataCategory && oldCategoryId != 'rack' && oldRackData && !newRackData) {
			var oldParentData = this.sceneManager.dataManager.getDataById(oldData.getParentId());
			if (oldParentData && data != oldParentData &&
				(!data.getParentId //有可能是link
					||
					data.getParentId() != oldParentData.getId())) { //focus的不是设备的parent，也不是其兄弟设备

				oldRackNode = this.sceneManager.getNodeByDataOrId(oldRackData);
				this.clearNodeState(oldNode);
				this.realToFake(oldRackNode);                   
			}
		}
	},

    
});
  /**
   * 将buidling和floor都放到datacenter这一Scene中。
   * 点击building虚化building，然后显示其对应的楼层并展开
   */
  var $BuidingAndFloorChangeAdapter = function(sceneManager) {
    it.BaseFocuseChangeAdapeter.call(this, sceneManager);
    this.isMoveCameraBeforeLaunchFloor = true; //点击building时，是不是先移动镜头然后再展开，false的话就不移动镜头原地展开
    this.animates = [];
    this.init();
  };

mono.extend($BuidingAndFloorChangeAdapter,it.BaseFocuseChangeAdapeter,{
	
    init: function() {
       // this.sceneManager.switchToRealNode = this.switchToRealNode;
       var self = this;
       this.f2BHandle = new $FloorToBuildingHandle(this); //楼层回到园区的业务处理
       this.b2fHandle = new $BuildingToFloorHandle(this);

       this.sceneChangeListener = function(eve) {
          self.bindingBuildingAndFloor(eve.data,eve.rootData,eve.oldData,eve.oldRootData);
       };
       this.sceneManager.addSceneChangeListener(this.sceneChangeListener,this);

       // 从floor退回到buiding时，内置动画禁止掉，可是从floor-building需要经过两步：1、floor-dc，2、dc—building
       // 需要注意的是：存在其他的跳转方式，如：点击tree的方式
       this.orgChangeAnimate = this.sceneManager.cameraManager.beforePlaySceneChangeAnimate;
       this.newChangeAnimate = function(scene, rootData,oldScene,oldRootData){
           var oldCategory = self.dataManager.getCategoryForData(oldRootData);
           var category = self.dataManager.getCategoryForData(rootData);
           if (oldCategory && category 
               && oldCategory.getId().toLowerCase() ==='floor' 
               && category.getId().toLowerCase() === 'datacenter') {
               return false;
           }
           return self.orgChangeAnimate.call(self.sceneManager.cameraManager,scene, rootData,oldScene,oldRootData);
       }

       this.bindingBuildingAndFloorVisibleManager = new it.VisibleManager(this.sceneManager);
       this.sceneManager.viewManager3d.addVisibleFilter(this.bindingBuildingAndFloorVisibleManager);

       var defaultHandler = this.sceneManager.viewManager3d.getDefaultEventHandler();
       this.oldlookAtFun = defaultHandler.lookAt;
       this.newLookAtfun = function(node, callback){
           var data = self.sceneManager.getNodeData(node);
           var category = self.sceneManager.dataManager.getCategoryForData(data);
           if (category && category.getId() == 'building') {
              var mainNode = self.sceneManager.getNodeByDataOrId(data);
              self.sceneManager.viewManager3d.setFocusNode(mainNode);
              defaultHandler.afterLookAt(mainNode,node);
              callback && callback();
              return ;
           }else{
              self.oldlookAtFun.call(defaultHandler,node,callback);
           }
       }

    this.oldGotoScene = this.sceneManager.gotoScene;
    this.newGotoScene = function(scene, data, callback) {
        var currentScene = self.sceneManager.getCurrentScene();
        var currentRootData = self.sceneManager.getNodeData(self.sceneManager.getCurrentRootNode());
        var dataNode = self.sceneManager.getNodeByDataOrId(data);
        var oldFocusNode = self.sceneManager.viewManager3d.getFocusNode();
        var oldFocusData = self.sceneManager.getNodeData(oldFocusNode);
        if (oldFocusData 
            && oldFocusData.getId() == data.getParentId() //只有当前的focuse正好是其父亲时，才走这条路，否则直接切换(从tree上点击的情况很复杂)
            // 此处修改的问题为：当处于楼层展开状态时，若在此时使用lookAtByData看向某个设备或机柜，则会调用b2f的场景切换，造成界面的混乱无法使用。
            // 在lookAtByData中，如果要看目标不为当前场景的根节点，则会设置self.sceneManager.resetCameraWhenSceneChange为false，此处借用了他的状态，
            // 使用lookAtByData看向某个设备或机柜， 即看得目标不是那个场景的根节点，此处应该用oldScene，因此这里给出false。  2017-12-12 add by lyz
            && self.sceneManager.resetCameraWhenSceneChange
            && dataNode && dataNode.doubliClick) {
           dataNode.doubliClick(dataNode, self.sceneManager.network3d, data, null, callback);
           return;
        }
        if (currentScene 
             && currentScene.getId() == 'floor' 
             && scene 
             && scene.getId().toLowerCase() == 'datacenter') {
            self.f2BHandle.doFloorToDatacenter(scene, data, currentScene, currentRootData, callback);
        } else {
            self.oldGotoScene.call(self.sceneManager, scene, data, callback);
        }
     }

       var defaultMF = this.sceneManager.viewManager3d.defaultMaterialFilter;
       this.oldGetOpacityValue = defaultMF.getOpacityValue;
       this.newGetOpacityValue = function(data){
          if (self.sceneManager.getCurrentScene() 
            && self.sceneManager.getCurrentScene().getCategoryId()
            && self.sceneManager.getCurrentScene().getCategoryId().toLowerCase() == 'datacenter') {
              return 0.01;
          }
          return self.oldGetOpacityValue.call(defaultMF,data);
       } 

    },

    startInit : function(){
        if (this.bindingBuildingAndFloorVisibleManager) {
            this.sceneManager.viewManager3d.addVisibleFilter(this.bindingBuildingAndFloorVisibleManager);
        }
        if (this.sceneChangeListener) {
          this.sceneManager.removeSceneChangeListener(this.sceneChangeListener,this); //有可能在初始化时已经加了，避免重复添加
          this.sceneManager.addSceneChangeListener(this.sceneChangeListener,this);
        }
        this.sceneManager.viewManager3d.getDefaultEventHandler().lookAt = this.newLookAtfun;
        this.sceneManager.gotoScene  = this.newGotoScene;
        this.sceneManager.cameraManager.beforePlaySceneChangeAnimate = this.newChangeAnimate;
        this.sceneManager.viewManager3d.defaultMaterialFilter.getOpacityValue = this.newGetOpacityValue;
    },

    destroy : function(){
       if (this.bindingBuildingAndFloorVisibleManager) {
            this.bindingBuildingAndFloorVisibleManager.clear();
            this.sceneManager.viewManager3d.removeVisibleFilter(this.bindingBuildingAndFloorVisibleManager);
        }
        if (this.sceneChangeListener) {
           this.sceneManager.removeSceneChangeListener(this.sceneChangeListener,this);
        }
        this.sceneManager.viewManager3d.getDefaultEventHandler().lookAt = this.oldlookAtFun;
        this.sceneManager.gotoScene = this.oldGotoScene;
        this.sceneManager.cameraManager.beforePlaySceneChangeAnimate = this.orgChangeAnimate;
        this.sceneManager.viewManager3d.defaultMaterialFilter.getOpacityValue = this.oldGetOpacityValue;
    },

    stopAllAnimate : function(){
        if (this.animates && this.animates.length > 0) {
          for(var i = 0 ; i < this.animates.length > 0 ; i++){
             var animate = this.animates[i];
            animate.stop();
          }
        }
        this.animates = [];
    },

	  /**
     * 看到真对象时(setFocus到真对象时)，注意这里有多层含义：1、假机柜切换到真机柜；
     * 2、真的机柜切换到真的地板这种“真-真”的模式
     *
     * 写这个扩展类的原因：当我点击building时(我们可以认为整个大的building是假的，里面的具体的楼层才是真的)，
     * 我想其下的floor有些动画，并且要见其自身虚幻掉(一般来说，当focus到自己时，除了自己其他的都会虚幻的)
     *
     * building —— floors
     * floors —— building
     *
     * @param node
     * @param oldNode
     */
    // switchToRealNode : function(node,oldNode){
     focusNodeChange: function(oldNode, node) {
        if(!node){
            return;
        }
        var sceneMap = this.dataManager._sceneMap;
        for (var sId in sceneMap) {
           var sceneObj = sceneMap[sId];
           if(sceneObj && sceneObj.getCategoryId() && sceneObj.getCategoryId().toLowerCase().indexOf('building')>=0){
              return ;
           }
        };
        var self = this;
        var data = this.sceneManager.getNodeData(node);
        var category = this.dataManager.getCategoryForData(data);
        var oldData =  oldNode?this.sceneManager.getNodeData(oldNode):null;
        var oldCategory = this.dataManager.getCategoryForData(oldData);
        // 2017-05-02 Kevin
        if(category && category.getId().toLowerCase().indexOf('datacenter') >=0
          && oldCategory && oldCategory.getId() == 'floor'){ //dc-floor时直接退出，gotoUpLevelSceneFor3D中的afterGotoUpLevelScene会重新调用的
           return;
        }
        // var box = this.network3d.getDataBox();
        // lookAt到building时
        // 注意：不管看到floors或是building，都是building。不管显示的是那种buidling，接下来双击背景都会到其他的对象，而不是真的building了
        // 所以还需要来判断oldNode是不building
       if (category 
            && category.getId() 
            && category.getId().toLowerCase().indexOf('building') >= 0 
            && oldCategory 
            && oldCategory.getId()
            && oldCategory.getId().toLowerCase().indexOf('building') >= 0) { // building - building
            var oldDataChildren = oldData.getChildren();
            if(oldDataChildren && oldDataChildren.size() > 0) {
                for (var i = 0; i < oldDataChildren.size(); i++) {
                    var child = oldDataChildren.get(i);
                    var childCategory = this.dataManager.getCategoryForData(child);
                    if (childCategory &&
                        childCategory.getId()
                       && childCategory.getId().toLowerCase().indexOf('floor') >= 0) {
                           var floorNode = self.sceneManager.dataNodeMap[child.getId()];
                           if (floorNode && self.box.getDataById(floorNode.getId())) {
                                self.box.removeByDescendant(floorNode);
                                 //add 2017-07-06 Kevin focus时从filter中去掉了，然后scenechange时再重新设置，这里点击地板也应该设置回去，上面的是不是remove不是很重要
                                // self.bindingBuildingAndFloorVisibleManager.setVisible(child, false); 
                                 self.bindingBuildingAndFloorVisibleManager.setVisibleByDescendant(child, false); //有可能有孩子的情况 2017-07-19
                          }
                    }
                }
            }
            this.switchToBuilding(node,oldNode,this.switchToBuildingFinished);
        }else if(category 
           && category.getId() 
           && category.getId().toLowerCase().indexOf('building') >= 0){ // dc-building or floor-building(floor不会一步到building的，除了点击搜索树)
            if (oldCategory 
            && oldCategory.getId() == 'floor') { // floor-building返回，在FloorToBuildingHandle中处理了
               return;
            }
            this.switchToBuilding(node,oldNode,this.switchToBuildingFinished);
        }
        // else if(oldNode){ //这种情况被转发到了上面的第一种情况，在clickBackground中转发的
           // 存在两种情况：1、building-dc，2、building-非DC(如具体的floor或通过其他的方式跳转到其他的场景)
           // 并且是只在1的情况下才执行以下的方法
            // var oldData =  this.getNodeData(oldNode);
            // var oldCategory = this.dataManager.getCategoryForData(oldData);
       else if(oldCategory 
                && oldCategory.getId()
                && oldCategory.getId().toLowerCase().indexOf('building') >= 0
                ){  // building-dc,or other
                var children = oldData.getChildren();
                if(children && children.size() > 0) {
                  var floorNodes = [];
                    for (var i = 0; i < children.size(); i++) {
                        var child = children.get(i);
                        var childCategory = this.dataManager.getCategoryForData(child);
                        if (childCategory &&
                            childCategory.getId()
                            && childCategory.getId().toLowerCase().indexOf('floor') >= 0) {
                              var floorNode = this.sceneManager.dataNodeMap[child.getId()];
                              floorNodes.push(floorNode);
                        }
                    }
                   var callback = function(){ // 如果是其他building的楼层的话
                        for(var j = 0 ; j < floorNodes.length; j++){
                            var floorNode = floorNodes[j];
                            var child =self.sceneManager.getNodeData(floorNode);
                            if (data != child //如果从building跳到楼层的话，本层的不需要移除
                                && floorNode
                                && self.box.getDataById(floorNode.getId())) {
                                self.box.removeByDescendant(floorNode);
                              //add 2017-07-06 Kevin focus时从filter中去掉了，然后scenechange时再重新设置，这里点击地板也应该设置回去，上面的是不是remove不是很重要
                                self.bindingBuildingAndFloorVisibleManager.setVisible(child, false); 
                            }
                        }
                    };
                    if(category && category.getId().toLowerCase().indexOf('datacenter') >= 0){ // 回到dc中才需要动画，否则就没有必要
                        this.hideFloorAnimate(floorNodes,oldNode,callback);
                        // this.sceneManager.viewManager3d.defaultMaterialFilter.clearAll(); //此时显示的园区，应该clearAll
                    }else{
                        callback();
                        this.sceneManager.viewManager3d.defaultMaterialFilter.removeByDescendant(oldData);
                    }
                    // this.sceneManager.viewManager3d.defaultMaterialFilter.clearAll(); //此时显示的园区，应该clearAll
                }
        }
    },

	 /**
     * 将building和floor"绑定"在一起:
     * 也就是显示building时，floors就被隐藏了(在earth下也不应该显示)，当floors显示时，building和dc都虚幻，
     * 但是这里处理的只是场景切换到dc模式下，将floors隐藏
    */
    bindingBuildingAndFloor : function(scene,rootData,oldScene,oldRootData){
      this.stopAllAnimate();
        var floors = this.dataManager._categoryDatas['floor']; //一下子拿出了所有的floor，可以floor不是延迟加载的，
        // 有可能是通过url的方式进来的，此时parentScene和data就为null
        if (scene 
          && scene.getCategoryId() 
          && scene.getCategoryId().toLowerCase() == 'datacenter') {
              if (floors) {
                for (var id in floors) {
                    var floor = floors[id];
                    //从floor到园区，这里不处理隐藏，在FloorToBuildingHandle中处理,但是其他building的floor需要处理
                    // Add 2017-07-10 如果是通过搜索树和面包屑直接跳转到dc呢？
                    if (!oldRootData  //有可能是通过url的方式进来的
                        || (floor 
                            && floor != oldRootData 
                            && floor.getParentId() != oldRootData.getParentId())) { 
                        // this.bindingBuildingAndFloorVisibleManager.setVisible(floor, false); 
                        this.bindingBuildingAndFloorVisibleManager.setVisibleByDescendant(floor,false);
                    }
                }
              }
        } else {
            this.bindingBuildingAndFloorVisibleManager.clear();
            // 将floor的scale设置回去
            if (floors) {
                for (var id in floors) {
                    var floor = floors[id];
                    var floorNode = this.sceneManager.getNodeByDataOrId(floor);
                    if (floorNode){
                        if( floorNode.orgScale) {
                            floorNode.setScale(floorNode.orgScale.clone());
                            if(floorNode == this.sceneManager._currentRootNode){
                              if (this.afterLoadFloor) {
                                  this.afterLoadFloor(floorNode);
                              }
                            }
                        }
                        if(floorNode.orgPosY){ //展开的动画要执行完，所以上面的需要stop
                            floorNode.setPositionY(floorNode.orgPosY);
                            // delete floorNode.doubliClick; // 将事件删掉
                        }
                    }
                }
            }
        }
    },

  /**
   * 先慢慢虚幻dc和building
   * 虚化完成后，楼层慢慢上升
   * 如果是floor场景(即oldNode是floor场景中的对象)跳过来的话，则是点击building到floor动画的反向
  */
  showFloorAnimate: function(floors, buildingNode, oldNode,finishedCallback,afterLookAtCallback) {
    if (!floors && floors.length < 1) {
      return;
    }
    var self = this;
    var data = this.sceneManager.getNodeData(buildingNode);
    var defaultHandler = this.sceneManager.viewManager3d.getDefaultEventHandler();
    var oldFocusData = this.sceneManager.getNodeData(oldNode);
    var oldSceneAndRoot = null;
    if (oldFocusData) {
      oldSceneAndRoot = this.sceneManager.getSceneAndRootByData(oldFocusData);
    }
    if (oldSceneAndRoot && oldSceneAndRoot.scene 
        && oldSceneAndRoot.scene.getCategoryId().toLowerCase().indexOf('floor') >= 0) { //从floor退回到园区的building中
      /*
        移到了FloorToBuildingHandle.js中
      */
    } else {
      // defaultHandler.lookAtWithOutMoveCamera = false;
    var moveUpFloorsAnimate = new mono.Animate({
        from: 0,
        to: 1,
        dur: 1000,
        // delay: 1000,
         delay: 0,
        easing: 'elasticOut',
        onUpdate: function(value) {
          // floor.setY(value);
          for (var i = floors.length - 1; i >= 0; i--) {
            var floor = floors[i];
            var data = self.sceneManager.getNodeData(floor);
            var y = parseFloat(data.getPosition().y / 10);
            floor.setY(y + 50 * value);
          }
        },
        onStop:function(){
           if (self.animates && self.animates.length > 0) {
              self.animates = []; //运行完后，清空缓存 --2017-10-10
           }
           finishedCallback && finishedCallback(buildingNode);
        }
      });

      var callback1 = function() {
        afterLookAtCallback && afterLookAtCallback();
        if (!self.sceneChangeWithOutAnimate) {
           // self.moveUpFloorsAnimate.play();
           moveUpFloorsAnimate.play();
        } else {
          for (var i = floors.length - 1; i >= 0; i--) {
            var floor = floors[i];
            var data = self.sceneManager.getNodeData(floor);
            var y = parseFloat(data.getPosition().y / 10);
            floor.setY(y + 50);
          }
        }
      };
      this.animates.push(moveUpFloorsAnimate);
      //defaultHandler.moveToClickNode(buildingNode,callback,200);
       // defaultHandler.moveCameraForLookAtNode(buildingNode,callback1);
       if (floors && floors.length > 1) { // update 2016-11-01 Kevin
           if(this.isMoveCameraBeforeLaunchFloor){
              defaultHandler.moveCameraForLookAtNodes(floors,callback1,30);
              this.sceneManager.viewManager3d.clearVisibleMap();
           }else{
              setTimeout(function(){
                  callback1();
              },100);
           }
       }else{
           defaultHandler.moveCameraForLookAtNode(buildingNode,callback1);
       }
    }
  },

    /**
      * 其实执行这个方法前，内置的虚化都已经处理好了，因此floors都被遮住了。
      *
      * 也是通过setFocusNode来触发的，所以虚化的处理需要注意
    */
    hideFloorAnimate : function(floors,buildingNode,callback){
        if (!floors && floors.length < 1) {
            if(callback){
                callback();
            }
            return;
        }
        if(this.doubliClickFloorNodeAnimate){
          this.doubliClickFloorNodeAnimate.stop();
        }
        // this.viewManager3d.getDefaultEventHandler().withOutAnimate = true;
        this.sceneManager.viewManager3d.getDefaultEventHandler().lookAtWithOutMoveCamera = false;
        var buildingData = this.sceneManager.getNodeData(buildingNode);
        if (buildingData) {
            // buildingNode.setStyle('m.transparent', true);
            // buildingNode.setStyle('m.opacity', 0.06);
            this.sceneManager.viewManager3d.defaultMaterialFilter.add(buildingData);
            this.sceneManager.network3d.dirtyNetwork();
        }
        var self = this;
        var moveDownFloorsAnimate = new mono.Animate({
            from: 0,
            to: 1,
            dur: 1000,
            // delay: 1000,
            easing: 'easeOut',
            onUpdate: function (value) {
                // floor.setY(value);
                for (var i = floors.length - 1; i >= 0; i--) {
                    var floor = floors[i];
                    var data = self.sceneManager.getNodeData(floor);
                    if (!data) {
                       return; //有可能被释放掉了 2017-10-11
                    }
                    var y = parseFloat(data.getPosition().y/10) + 50;
                    // var y = parseFloat(floor.getPositionY());
                    floor.setY(y - 50 * value);
                }
            },
            onStop : function(){ //不管是stop还是正常执行完，这个一定是被执行
              if(callback){
                    callback();
                }
                self.sceneManager.viewManager3d.defaultMaterialFilter.clearAll();
                self.sceneManager.network3d.dirtyNetwork();
                // var index = self.animates.indexOf(moveDownFloorsAnimate);
                // if(index !== -1){
                //    self.animates.splice(index,1);
                // }
                if (self.animates && self.animates.length > 0) {
                   self.animates = []; //运行完后，清空缓存 --2017-10-12
                }
            }
        });
        this.animates.push(moveDownFloorsAnimate);
        moveDownFloorsAnimate.play();
    },

    /**
     * 根据building和floor获取该floor的scale
     */
  getFloorScaleByBuildingNodeAndFloorNode: function(buildingNode, floorNode) {
    if (!buildingNode || !floorNode) {
       return null;
    }
     // var minScaleX = 10,
     //    minScaleZ = 10; // 用最大的，如果每个floor都不一样大时，最后都缩放成了一样大，不太好
    // var buildingBoundingBox = buildingNode.getBoundingBox();
    var buildingBoundingBox = it.Util.getBoundingBox(buildingNode);
    // var floorNodeBoundingBox = floorNode.getBoundingBox();
    var floorNodeBoundingBox = it.Util.getBoundingBox(floorNode);
    var scaleX = 0.1,
        scaleZ = 0.1;
    if (buildingBoundingBox && floorNodeBoundingBox) {
      var bbSize = buildingBoundingBox.size();
      var fSize = floorNodeBoundingBox.size();
      // var scaleX = 0.1,
      //     scaleZ = 0.1; // 默认的都0.1，可是当楼层本身就比较小时也太小了,都除以1000呢？
      if (bbSize && fSize) {
        if (bbSize.x && bbSize.x != -Infinity && bbSize.x != Infinity && fSize.x != -Infinity && fSize.x != Infinity) {
          scaleX = bbSize.x / fSize.x;
        }
        if (bbSize.z && bbSize.z != -Infinity && bbSize.z != Infinity && fSize.z != -Infinity && fSize.z != Infinity) {
          scaleZ = bbSize.z / fSize.z;
        }
      }
      // if (scaleX < minScaleX) {
      //   minScaleX = scaleX;
      // }
      // if (scaleZ < minScaleZ) {
      //   minScaleZ = scaleZ;
      // }
    }
    var scale = scaleX > scaleZ ? scaleZ:scaleX;
    return new mono.Vec3(scale, 1, scale);
  },

  /**
   * 当该building只有一层楼时，是不是直接进入
   */
  isIntoFloor : function(){
    return true;
  },
  
  /**
   * 双击楼层是否进入具体楼层，便于扩展，贵州浪潮的某个建筑只有展厅一层，并且双击不允许进入
   */
  shouldDoubliClickFloorNode : function(data){
    return true;
  },

  /**
   * 点击building
   * 1、lookAt Building
   * 2、虚幻building
   * 3、展开楼层（如果该building只有一层时，那就直接进入）
   * 4、当有多个building时，其他的building的floor应该隐藏
   */
  switchToBuilding: function(node, oldNode, callback) {
    if (!node) return;
    var data = this.sceneManager.getNodeData(node);
    if (!data) return;
    // var buildingBoundingBox = node.getBoundingBox();
    // var buildingBoundingBox = it.Util.getBoundingBox(node);
    var wPos = node.getWorldPosition();
    var bSacle = node.getScale();
    var children = data.getChildren();
    if (!children || children.size() < 1) {
      return;
    }
    var self = this;
    var floorNodes = [];
    var minScaleZ = 1;
    var minScaleX = 1;
    if (children && children.size() > 0) {
      for (var i = 0; i < children.size(); i++) {
        var child = children.get(i);
        var childCategory = this.sceneManager.dataManager.getCategoryForData(child);
        if (childCategory &&
          childCategory.getId() && childCategory.getId().toLowerCase().indexOf('floor') >= 0) {
          var floorNode = this.sceneManager.dataNodeMap[child.getId()];
          if (floorNode) {
            if (!floorNode.orgScale) {
              floorNode.orgScale = floorNode.getScale().clone();
            }
            if (!floorNode.orgPosY) {
              floorNode.orgPosY = floorNode.getPositionY();
            }
            var fMinScale = this.getFloorScaleByBuildingNodeAndFloorNode(node,floorNode)||new mono.Vec3(0.1,0.1,0.1);
            if(minScaleZ > fMinScale.z){
               minScaleZ = fMinScale.z;
            }
            if (minScaleX > fMinScale.x) {
               minScaleX = fMinScale.x;
            }
            floorNode.setPositionY(child.getPosition().y / 10);
            this.sceneManager.viewManager3d.defaultMaterialFilter.removeByDescendant(child);
            delete this.doubleClickFloorNodeFlag; //每次展开都删掉，以防中间存在没有干掉的情况
            floorNode.doubliClick = function(element, network, data, clickedObj, callback) {
                // self.doubliClickFloorNode(element, network, data, clickedObj, callback);
                if(self.shouldDoubliClickFloorNode(data)){
                    self.b2fHandle.doubliClickFloorNode(element, network, data, clickedObj, callback);
                }
            }
            floorNodes.push(floorNode);
          }
        }
      }
      if(floorNodes.length  < 1){ //当building没有floor孩子时，直接返回
         this.sceneManager.viewManager3d.defaultMaterialFilter.clear(); // 在该模式下只虚化building，其他的都不虚化。
         return ;
      }
      // 该building只有一层时，改成不是直接场景切换，而是展开后直接进入 —— update by Kevin 2017-07-04
      for (var i = floorNodes.length - 1; i >= 0; i--) {
          floorNodes[i].setScale(minScaleX * bSacle.x, (minScaleX>0.1?minScaleX:0.1), minScaleZ * bSacle.z); //这个得根据自己的boundingbox和building的boundingbox比较计算
      }

      /**
       * 隐藏建筑，显示建筑的floor
       */
      var aftrLookAtCallback = function() {

        self.sceneManager.viewManager3d.defaultMaterialFilter.addByDescendant(data); //建筑上的非floor的孩子也要虚幻
        for (var i = 0; i < floorNodes.length; i++) {
           var fData = self.sceneManager.getNodeData(floorNodes[i]);
           self.sceneManager.viewManager3d.defaultMaterialFilter.removeByDescendant(fData);
        }
        self.sceneManager.network3d.dirtyNetwork();

        if (self.bindingBuildingAndFloorVisibleManager && floorNodes.length > 0) {
            for(var i = 0 ; i < floorNodes.length ; i++){
               var floor = self.sceneManager.getNodeData(floorNodes[i]);
               // self.bindingBuildingAndFloorVisibleManager.setVisible(floor, true);
               self.bindingBuildingAndFloorVisibleManager.setVisibleByDescendant(floor, true); // update 2017-07-19 有可能会有孩子的情况
            }
        }
       
        if(self.afterLookAtBuildingFunction){
           self.afterLookAtBuildingFunction(node,floorNodes);
        }

      }

      var endCallback = function(){
        callback && callback();
         if (floorNodes.length == 1 && self.isIntoFloor() && self.shouldDoubliClickFloorNode(fData)) { //如果只有一层，那就直接进入
            var fData = self.sceneManager.getNodeData(floorNodes[0]);
            self.b2fHandle.doubliClickFloorNode(floorNodes[0], self.sceneManager.network3d, fData, null, null);
        }
      }

      this.sceneManager.viewManager3d.defaultMaterialFilter.clear(); // 在该模式下只虚化building，其他的都不虚化。
      this.showFloorAnimate(floorNodes, node, oldNode,endCallback, aftrLookAtCallback);
    }
  }

});

it.BuidingAndFloorChangeAdapter = $BuidingAndFloorChangeAdapter;





/**
 * 适配管理器，虽然可以都放在sceneManger中
 * 独立出来，模块化，同时也使得sceneManager中不那么臃肿
 *
 */
$PropertyChangeAdaperManager = function(sceneManager){
	this.sceneManager = sceneManager;
	this.changeAdapterList = new mono.List();
	this.defaultFocuseAdaper = new $ComplexNodeAndSimpleNodeChangeAdapter(sceneManager);//默认的一个真假切换的处理
	this.buildAndFloorAdaper = new $BuidingAndFloorChangeAdapter(sceneManager);
	this.init();
};

mono.extend($PropertyChangeAdaperManager,Object,{

	init: function() {
		var self = this;
		this.sceneManager.viewManager3d.addPropertyChangeListener(function(event) {
			// if(event.property == "focusNode"){
			// }
			var currentScene = self.sceneManager.getCurrentScene();
			if (event 
				&& event.property == "focusNode" 
				&& (!currentScene || currentScene.getId() != 'earth')) { // earth 上的 billboard就不触发loadChildren了
				var node = event.newValue;
				if (node) {
					self.sceneManager.loadLazyChildren(node); // 如:从机柜 lookAt 地板 ,貌似直接lookAt也会执行
					// viewManage中的“focusNode”中会统一处理的，这里再这么整就没法统一管理了，不知当初为何在这里这么用，--2017-09-27 
					// if (self.sceneManager.viewManager3d.defaultMaterialFilter) {
					// 	self.sceneManager.viewManager3d.defaultMaterialFilter.removeByDescendant(self.sceneManager.getNodeData(node));
					// }
					self.setRelationWithChildren(node); // 2018-01-19 Kevin 设置父子关系，有可能父子关系断掉了
				}
			}

			// for (var i = 0; i < self.changeAdapterList.size(); i++) {
			// 	var changeAdaper = self.changeAdapterList.get(i);
			// 	if (changeAdaper && (changeAdaper instanceof it.BaseFocuseChangeAdapeter)) {
			// 		changeAdaper.focusChange(event);
			// 	}
			// }
			self.focusChange(event);
		});
		this.register(this.defaultFocuseAdaper);
		this.register(this.buildAndFloorAdaper);
	},

	// -- add By Kevin 2016-12-01 为了解决将focusChange放至BaseFocuseChangeAdapeter中的问题:
	// /*add 注意 by Kevin 2016-12-01
    // 注意：由于此类会被很多类继承，很有可能最开始执行的改变了某些属性使得后来的没法正常执行，如：
    //    最开始的complexNodeAndSimpleNodeChangeAdapter执行后，complexNode和simpleNode的父子关系已经改变过，
    //    接下来的的实例就很有可能执行不了,realToFake 和 fakeToReal了
    //  改进：将这块移到其管理类中，然后在realToFake、fakeToReal以及focusNodeChange中遍历BaseFocuseChangeAdapeter的实例，然后一一执行,这
    //       样就不会遗漏没有执行的，但是在每个BaseFocuseChangeAdapeter实例中，需要注意所得到的node和oldNode的某些属性(如:真假对象的父子关系,以及是否加到了box中)
    //       可能被之前执行的实例更改过
    // */
	focusChange: function(event) {
		var self = this;
		if (event && event.property == "focusNode") {
			var oldNode = event.oldValue;
			var node = event.newValue;
			if (oldNode) {
				var simpleNode = oldNode.getClient('simpleNode');
				var complexNode = oldNode.getClient('complexNode');
				//真 —— 假 ,并且不是父子(如果是lookAt机柜 到 lookAt该机柜中的设备，此时是不需要卸载的，可是如果是孙子呢？？？，因此改成不是子孙)
				// if (simpleNode && simpleNode.getParent() != oldNode && !self.isChild(oldNode, node)) {
			// add by Kevin 2011221，有可能中途出错导致真假都显示了，所以不应该判断simpleNode的parent不存在，而判断complex的父亲存在
				if (simpleNode 
					&& ((complexNode 
						 && complexNode != 'unload' 
						 && complexNode.getParent() == oldNode)
						|| simpleNode.getParent() != oldNode) 
					&& !self.isChild(oldNode, node)) { 
					for (var i = 0; i < self.changeAdapterList.size(); i++) {
						var changeAdaper = self.changeAdapterList.get(i);
						if (changeAdaper && (changeAdaper instanceof it.BaseFocuseChangeAdapeter)) {
							changeAdaper.realToFake(oldNode, node);
						}
					}
					// self.realToFake(oldNode, node);
				}
			}

			if (node) {
				self.fakeToRealForParent(node); //先切换父亲的真假
				var complexNode = node.getClient('complexNode');
				var simpleNode = node.getClient('simpleNode');
				var data = self.sceneManager.getNodeData(node);
				if (complexNode == 'unload') { //可能开始复杂模型没有创建
					self.sceneManager.loadComplexNode(data,function(comNode){
						self._doFakeToReal(comNode,simpleNode,oldNode,node);
					});
				}else{
					/*
			    	if (complexNode && 
				        (complexNode.getParent() != node
				          || (simpleNode && simpleNode.getParent() == node))) { // 假 —— 真 
				    	var simpleNode = node.getClient('simpleNode');
			    		for (var i = 0; i < self.changeAdapterList.size(); i++) {
			    			var changeAdaper = self.changeAdapterList.get(i);
				    		if (changeAdaper && (changeAdaper instanceof it.BaseFocuseChangeAdapeter)) {
				     			changeAdaper.fakeToReal(oldNode, node);
			    			}
		    			}
		    		}*/
		    		self._doFakeToReal(complexNode,simpleNode,oldNode,node);
				}
			}

			for (var i = 0; i < self.changeAdapterList.size(); i++) {
				var changeAdaper = self.changeAdapterList.get(i);
				if (changeAdaper && (changeAdaper instanceof it.BaseFocuseChangeAdapeter)) {
					changeAdaper.focusNodeChange(oldNode, node);
				}
			}
			// self.focusNodeChange(oldNode, node);
		}
	},
    
    /**
     * 注意有可能父亲也要切换
     * 并且node自身没有真假，但是父亲有
     */
	_doFakeToReal: function(complexNode,simpleNode,oldNode,node) {
		if (complexNode &&
			 (complexNode.getParent() != node 
			  || (simpleNode && simpleNode.getParent() == node))) { // 假 —— 真 
			var simpleNode = node.getClient('simpleNode');
			for (var i = 0; i < this.changeAdapterList.size(); i++) {
				var changeAdaper = this.changeAdapterList.get(i);
				if (changeAdaper && (changeAdaper instanceof it.BaseFocuseChangeAdapeter)) {
					changeAdaper.fakeToReal(oldNode, node);
				}
			}
		}
	},

	/**
     * 切换其parent的真假，有可能从其他的入口进入的
     * add 2017-07-14
     */
	fakeToRealForParent : function(node){
		var nodeData = this.sceneManager.getNodeData(node);
		var self = this;
		if (nodeData && nodeData.getParentId && nodeData.getParentId()) { //有可能是连线
			var parent = this.sceneManager.dataManager.getDataById(nodeData.getParentId());
			if (parent && this.sceneManager.isCurrentSceneInstance(parent)) {
				var parentNode = this.sceneManager.getNodeByDataOrId(parent);
				if (!parentNode) {
					return;
				}
				this.fakeToRealForParent.call(this,parentNode);//一直找到根
				var complexNode = parentNode.getClient('complexNode');
				var simpleNode = parentNode.getClient('simpleNode');
				if (complexNode == 'unload') { //可能开始复杂模型没有创建
					self.sceneManager.loadComplexNode(parent,function(comNode){
						self._doFakeToReal(comNode,simpleNode,null,parentNode);
					});
				}else if(complexNode && complexNode.getParent() != parentNode){ //表示没有切过
		    		self._doFakeToReal(complexNode,simpleNode,null,parentNode);
				}	
			}
		}
	},

	isChild : function(parentNode,childNode,scope){
		scope = scope || this;
        if(!parentNode || !childNode){
            return false;
        }
        var pdata = parentNode;
        if (parentNode instanceof mono.Element) {
        	pdata = scope.sceneManager.getNodeData(parentNode);
        }
        if(!pdata) {
            return false;
        }
        var cdata = childNode;
        if (childNode instanceof mono.Element) {
        	cdata = scope.sceneManager.getNodeData(childNode);
        }
        if(!cdata || !(cdata instanceof $Data)){
            return false;
        }
        var pDataScene = scope.sceneManager.getSceneFromData(pdata);
        var cDataScene = scope.sceneManager.getSceneFromData(cdata);
        if ((!pDataScene && cDataScene) 
        	|| (pDataScene && !cDataScene)
        	|| (pDataScene != cDataScene)) {
        	return false;
        }
        if(cdata.getParentId() && cdata.getParentId() === pdata.getId()){
            return true;
        }else{
        	var cdataParent = scope.sceneManager.dataManager.getDataById(cdata.getParentId());
        	return scope.isChild(pdata,cdataParent,scope);
        }
        // return false;
    },

    /**
     * 2018-01-19 Kevin 
     * 设置该node的孩子和它之间的父子关系
     * 由于loadLazyChildren时，当node已经加载过的话，就不再去加载它的孩子了。若是父子关系断掉了，不重新loadScene是整不对的
     * 在IT架构中就很有可能会出现这样的情况，清除了父子关系，直接loadLazyData设备后再lookAt它的父类(包括祖先)的对象就有存在不对的情况
     */
    setRelationWithChildren : function(node){
    	var data = this.sceneManager.getNodeData(node);
    	if (data) {
    		var children = data.getChildren();
    		if (children && children.size() > 0) {
    			for(var i = 0 ;i < children.size(); i++){
    				var child = children.get(i);
    				this.sceneManager.setParentRelationShip(child);
    			}
    		}
    	} 
    },

	register : function(changeAdaper){
		if (changeAdaper) {
			if (!this.changeAdapterList.contains(changeAdaper)) {
				changeAdaper.startInit();
				this.changeAdapterList.add(changeAdaper);
			}
		}
	},

	deregister : function(changeAdaper){ //移除的时候，也要将相关的listener去掉
		if (changeAdaper) {
			if (this.changeAdapterList.contains(changeAdaper)) {
				this.changeAdapterList.remove(changeAdaper);
				changeAdaper.destroy();
			}
		}
	},


});

it.PropertyChangeAdaperManager = $PropertyChangeAdaperManager;



/**
 * 空间可视化时，当fouse发生改变时，创建/移除机柜以及机柜内的透明方块
 * 备注：这些焦点对象(不管是oldFouseNode还是fouseNode)都应该是机柜，其他类型的不处理
 */
var $SpaceAdapter = function(sceneManager,spaceManager){
	it.BaseFocuseChangeAdapeter.call(this,sceneManager);
	this.spaceManager = spaceManager;
	this.box = this.sceneManager.network3d.getDataBox();
};

mono.extend($SpaceAdapter, it.BaseFocuseChangeAdapeter, {

	/**
	 * 真的切换到(真/假)(处理后来的真对象)
	 * 如果存在空间可视化的立方体时，就把它从box中移除，并且移除掉真的机柜，即只留下spaceNode(frame+彩色cube)
	 * 1、真机柜删除；
	 * 2、spaceNode留下(这个在该模式下应该是永远显示着)
	 * 3、删除机柜中的空余空间立方体(彩色cube表示)
	 * add 2017-11-18 需要注意的是如果oldNode是真通道的话
	 */
	realToFake: function(oldNode, node) {
		var self = this;
		var isSpaceNode = false,spaceNode = null;
		var children = oldNode.getChildren().toArray();
		var oldData = this.sceneManager.getNodeData(oldNode);
		for (j = 0; j < children.length; j++) {
			var child = children[j];
			if (this.spaceManager.isSpaceChildrenNode(child)) { // || this.isSpaceChildrenNode(child)
				this.box.removeByDescendant(child);
				child.setParent(null);
				isSpaceNode = true;
			}else{
				// 2017-11-10 设备，板卡什么的都得清除。虽然在ComplexNodeAndSimpleNodeChangeAdapter中有处理，但是那里面没有处理干净
				// 2017-11-18 如果是通道切换的话，就不可这样把机柜都干掉
				var childData = this.sceneManager.getNodeData(child);
				var cCategory = this.sceneManager.dataManager.getCategoryForData(childData);
				// if (!cCategory 
				// 	|| cCategory.getId().toLowerCase().indexOf('rack') < 0) {
					// remark 2017-12-14 如果是通道的话，假通道给remove了，会到资产模式下通道会不见了。因此也不能是自己
				if (oldData != childData && (!cCategory 
					|| cCategory.getId().toLowerCase().indexOf('rack') < 0)) {
					this.box.removeByDescendant(child); 
				}
			}
			if(this.spaceManager.isSpaceNode(child)){
				spaceNode = child;
			}
		}
		if (isSpaceNode) {
			var complexNode = oldNode.getClient('complexNode'); 
			var simpleNode = oldNode.getClient('simpleNode');
			this.box.removeByDescendant(complexNode); //有可能之前的adpeter已经处理了(做了真假切换)，所以真假都删掉
			this.box.removeByDescendant(simpleNode);
			if (spaceNode) { //当isSpaceNode为true时，spaceNode一定存在
				this.box.addByDescendant(spaceNode);
			}
		}
	},

	/**
	 * (假/真)机柜切到真机柜时(处理后来的真对象)：
	 * 1、移除之前的spaceNode
	 * 2、将机柜加到box中
	 * 3、创建机柜对应的彩色块，并加到box中
	 */
	fakeToReal: function(oldNode, node) {
		var self = this;
		var data = this.sceneManager.getNodeData(node);
		if (!data) {
			return;
		}
		var isSpaceNode = false;
		var children = node.getChildren().toArray();
		for (j = 0; j < children.length; j++) {
			var child = children[j];
			if (this.spaceManager.isSpaceNode(child)) { // || this.isSpaceChildrenNode(child)
				// child.setParent(null); //从box中移除它，但是父子关系依然在
				this.box.removeByDescendant(child);
				isSpaceNode = true;
			}
		}
		if (isSpaceNode) {
			var complexNode = node.getClient('complexNode'); 
			if(complexNode){
				this.box.addByDescendant(complexNode);
			}else{
				this.box.addByDescendant(node,function(child){
					if (self.spaceManager.isSpaceNode(child)) {
						return false;
					}else{
						return true;
					}
				});
			}
			var spaceChildrenNodes = this.spaceManager.create1DChildrenSpaceNodes(data);
			for (j = 0; j < spaceChildrenNodes.length; j++) { // update By Kevin 2016-11-30 这里一开始可以不创建，等到lookAt的时(现在)才创建，并放到box中
				spaceChildNode = spaceChildrenNodes[j];
				spaceChildNode.setParent(node);
				this.box.addByDescendant(spaceChildNode)
			}
		}
	},

});

it.SpaceAdapter = $SpaceAdapter;



it.PowerCapacityManager = function(sceneManager){
    this.sceneManager = sceneManager;
    this.dataManager = this.sceneManager.dataManager;
    this.visibleManager = new $VisibleManager(this.sceneManager);
    this.sceneManager.viewManager3d.addVisibleFilter(this.visibleManager);
};

mono.extend(it.PowerCapacityManager,Object,{
    computePowerPercent : function(dataOrId){
       var dm = this.dataManager;
       var data = dataOrId;
       if(!data.getId){
          data = dm.getDataById(dataOrId);
       }
       var datatype = dm.getDataTypeForData(data);
       if(!datatype){
         return;
       }
       var powerRating = datatype.getPowerRating();
       if(powerRating == null || powerRating == 0){
          return null;
       }
       
       var totalPower = 0,power;
       var childList = data.getChildren();
       childList.forEach(function(child){
           power = child.getPower() || 0;
           totalPower += power;
       });
       return totalPower / powerRating;
    },

    createPowerNode : function(dataOrId){

        var sm = this.sceneManager,dm = this.dataManager,data = dataOrId,
            box = sm.network3d.getDataBox();
        if(!sm.isCurrentSceneInstance(dataOrId)){
            return;
        }
        if(!data.getId){
            data = dm.getDataById(dataOrId);
        }
        var percent = this.computePowerPercent(dataOrId);
        if(percent == null){
            return;
        }
        var node = sm.getNodeByDataOrId(data);
        var boundingBox = node.getBoundingBox(),
            size = boundingBox.size(),
            width = size.x,height = size.y,depth = size.z;

        var powerNode = node.getClient('powerNode'),powerNode2;
        percent = percent || 0.01;
        if(!powerNode){
            powerNode = new mono.Cube(width-0.2,height ,depth-0.2);
            powerNode2 = new mono.Cube(width,height,depth);
            powerNode2.setParent(powerNode);
            powerNode.s({
                'm.type':'phong',
            });
            powerNode2.s({
                'm.wireframe':true,
                'm.wireframeLinewidth':1,
                'm.color':'white',
            });
            powerNode.setClient('child',powerNode2);
        }
        var color = this.getPowerNodeColor(percent);
         powerNode.s({
            'm.color':color,
            'm.ambient':color,
            'm.specularStrength':30,
        });
        powerNode.setParent(node);
        powerNode.setScale(1,percent,1);
        powerNode.setY(height * percent / 2  -  height / 2 + 5);
        powerNode.setClient('powerChildNode',true);
        node.setClient('powerNode',powerNode);
        powerNode.setClient('it_data','power');
        box.addByDescendant(powerNode);
        // this.makeItDataNodeUnvisible(node);
        this.makeItDataUnvisible(data);
        return powerNode;
    },

    // makeItDataNodeUnvisible : function(node){
    //     if(node.getClient('it_data')){
    //        if(node._oldvisible === undefined){
    //           node._oldvisible = node.getStyle('m.visible',false,false);
    //           node._oldvisible = node._oldvisible === false ? false: true;
    //        }
    //        node.setStyle('m.visible',false);
    //     }
    //     var self = this;
    //     node.getChildren().forEach(function(child){
    //         self.makeItDataNodeUnvisible(child);
    //     });
    // },

    makeItDataUnvisible : function(data){
        if (!data) {
          return;
        }
        this.visibleManager.setVisible(data,false);
        var self = this;
        data.getChildren().forEach(function(child){
            self.makeItDataUnvisible(child);
        });
    },

    makeItDataVisible : function(data){//node
      if (!data) {
         return;
      }
       this.visibleManager.setVisible(data,true);
      var self = this;
      data.getChildren().forEach(function(child){
          self.makeItDataVisible(child);
      });
    },

    removePowerNode : function(dataOrId){
        var sm = this.sceneManager,dm = this.dataManager,data = dataOrId,box = sm.network3d.getDataBox();
        if(!data.getId){
            data = dm.getDataById(dataOrId);
        }
        var node = sm.getNodeByDataOrId(dataOrId);
        if(!node){
            return;
        }
        var powerNode = node.getClient('powerNode');
        if(powerNode){
            powerNode.setParent(null);
            box.removeByDescendant(powerNode);
            // this.makeItDataNodeVisible(node);
        }
         this.makeItDataVisible(data);
    },

    getPowerNodeColor : function(percent){
       if(this.powerNodeColorFunction){
          var color = this.powerNodeColorFunction(percent);
         return color;
       }
       var color;
       if(percent < 0.25){
          color = 'green';
       }else if(percent >= 0.25 && percent <= 0.75){ // TODO
          color = "orange";
       }else{
          color = "red";
       }
       return color;
    },

    isPowerAvailabe : function(){

    },


});
/**
 * 计算承重
 * @param sceneManager
 * @constructor
 */
it.WeightCapacityManager = function (sceneManager) {
    this.sceneManager = sceneManager;
    this.dataManager = this.sceneManager.dataManager;
    this.visibleManager = new $VisibleManager(this.sceneManager);
    this.sceneManager.viewManager3d.addVisibleFilter(this.visibleManager);
};

mono.extend(it.WeightCapacityManager, Object, {

    /**
     * 计算承重比率
     * @param dataOrId
     * @returns {*}
     */
    computeWeightPercent: function (dataOrId) {

        var dm = this.dataManager;
        var data = dataOrId;
        if (!data.getId) {
            data = dm.getDataById(dataOrId);
        }
        var dataType = dm.getDataTypeForData(data);
        if (!dataType) {
            return;
        }
        var weightRating = dataType.getWeightRating();
        //如果承重为空或者为0, 返回null
        if (weightRating == null || weightRating == 0) {
            return null;
        }

        //计算所有孩子的重量
        var totalWeight = this.computeChildrenWeight(data);

        return totalWeight / weightRating;
    },

    /**
     * 计算所有孩子的重量
     * @param dataOrId
     * @returns {number}
     */
    computeChildrenWeight: function (dataOrId) {

        var dm = this.dataManager;
        var self = this;
        var data = dataOrId;
        if (!data.getId) {

            data = dm.getDataById(dataOrId);
        }
        var totalWeight = 0, weight;
        var childList = data.getChildren();
        childList.forEach(function (child) {//haizi
            weight = child.getWeight() || 0;
            totalWeight += weight;
            //
            var childChildren = child.getChildren();
            if (childChildren && childChildren.size() > 0) {
                totalWeight += self.computeChildrenWeight(child);
            }
        });
        return totalWeight;
    },

    /**
     * 创建重量比率节点
     * @param dataOrId
     */
    createWeightNode: function (dataOrId) {

        var sm = this.sceneManager, dm = this.dataManager, data = dataOrId,
            box = sm.network3d.getDataBox();
        //如果不在当前场景
        if(!sm.isCurrentSceneInstance(dataOrId)){
            return;
        }
        if (!data.getId) {
            data = dm.getDataById(dataOrId);
        }
        var node = sm.getNodeByDataOrId(data);
        var percent = this.computeWeightPercent(data);

        if (percent == null) {
            return;
        }
        data._weightPercent = percent;
        var boundingBox = node.getBoundingBox(),
            size = boundingBox.size(),
            width = size.x, height = size.y, depth = size.z;

        var weightNode = node.getClient('weightNode'), weightNode2;
        percent = percent || 0.01; //如果是0, 就显示很小的一个值
        if (!weightNode) {
            weightNode = new mono.Cube(width - 0.2, height, depth - 0.2);
            weightNode2 = new mono.Cube(width, height, depth);
            weightNode2.setParent(weightNode);
            weightNode.s({
                'm.type': 'phong',
            });
            weightNode2.s({
                'm.wireframe': true,
                'm.wireframeLinewidth': 1,
                'm.color': 'white',
            });
            weightNode.setClient('child', weightNode2);
        }
        var color = this.getWeightNodeColor(percent);
        weightNode.s({
            'm.color': color,
            'm.ambient': color,
            'm.specularStrength': 30,
        });
        weightNode.setParent(node);
        weightNode.setScale(1, percent, 1);
        weightNode.setY(height * percent / 2 - height / 2 + 5);
        weightNode.setClient('weightChildNode', true);
        node.setClient('weightNode', weightNode);
        weightNode.setClient('it_data','weight');
        box.addByDescendant(weightNode);
        this.makeItDataUnvisible(data);
        return weightNode;
    },

    // makeItDataNodeUnvisible: function (node) {
    //     if (node.getClient('it_data')) {
    //         if (node.__oldvisible === undefined) {
    //             node.__oldvisible = node.getStyle('m.visible', false, false);
    //             node.__oldvisible = node.__oldvisible === false ? false : true;
    //         }
    //         node.setStyle('m.visible', false);
    //     }
    //     var self = this;
    //     node.getChildren().forEach(function (child) {
    //         self.makeItDataNodeUnvisible(child);
    //     });
    // },

    // makeItDataNodeVisible: function (node) {
    //     if (node.getClient('it_data')) {
    //         if (node.__oldvisible === undefined || node.__oldvisible === true) {
    //             node.setStyle('m.visible', true);
    //         }
    //     }
    //     var self = this;
    //     node.getChildren().forEach(function (child) {
    //         self.makeItDataNodeVisible(child);
    //     });
    // },

    makeItDataUnvisible : function(data){
        if (!data) {
          return;
        }
        this.visibleManager.setVisible(data,false);
        var self = this;
        data.getChildren().forEach(function(child){
            self.makeItDataUnvisible(child);
        });
    },

    makeItDataVisible : function(data){//node
      if (!data) {
         return;
      }
      this.visibleManager.setVisible(data,true);
      var self = this;
      data.getChildren().forEach(function(child){
          self.makeItDataVisible(child);
      });
    },

    removeWeightNode: function (dataOrId) {
        var sm = this.sceneManager, dm = this.dataManager, data = dataOrId, box = sm.network3d.getDataBox();
        if (!data.getId) {
            data = dm.getDataById(dataOrId);
        }
        delete data._weightPercent;
        var node = sm.getNodeByDataOrId(dataOrId);
        if (!node) {
            return;
        }
        var weightNode = node.getClient('weightNode');
        if (weightNode) {
            weightNode.setParent(null);
            box.removeByDescendant(weightNode);
            // this.makeItDataNodeVisible(node);
        }
        this.makeItDataVisible(data);
    },

    getWeightNodeColor: function (percent) {
        if (this.weightNodeColorFunction) {
            var color = this.weightNodeColorFunction(percent);
            return color;
        }
        var color;
        if (percent < 0.25) {
            color = 'green';
        } else if (percent >= 0.25 && percent <= 0.75) { // TODO
            color = "orange";
        } else {
            color = "red";
        }
        return color;
    },

    isWeightAvailabe: function () {

    },


});
it.CameraFollow = function (camera) {
    
    this.setHost = function(hostNode){
        if(camera._hostNode){
        	  camera._hostNode.removePropertyChangeListener(follow);
    	  }
    		camera._hostNode = hostNode;
    		hostNode.addPropertyChangeListener(function(e){
    	       follow(e,hostNode);
    		});
    };

	function follow(e,node){
       var property = e.property;
       if(property.startsWith('position') || property.startsWith('rotation')){
     	   	var pos = node.p();
     	   	var distance = camera.getDistance();
     	   	var pos2 = node.worldPosition(new mono.Vec3(-2,1,0),distance);			
		      camera.lookAt(pos);
		      camera.setPosition(pos2);
       }
	};
}
it.InspectionManager = function (sceneManager) {

    it.EventHandler.call(this);
    this.sceneManager = sceneManager;
    this.visibleManager = new it.VisibleManager(sceneManager);
    sceneManager.viewManager3d.addVisibleFilter(this.visibleManager);
    this.dataManager = this.sceneManager.dataManager;
    this.camera = this.sceneManager.network3d.getCamera();
    this.box = this.sceneManager.network3d.getDataBox();

    this.status = it.InspectionManager.STATUS_READY;
    this.host = null;//小人或其它
    this.path = [];//路径
    this.animates = [];//动画
    this.loop = false; //是否循环播放,在执行play前设置有效, 默认是false
    this.finalAngle = null;//最后的角度
    this.limitDistance = 200;//距离轨迹直线的距离,距离100范围内
    this.limitAngle = 40; //机柜的旋转角度和面向轨迹直线法线的夹角, 正负40度范围内
    this.inspectDataArray = [];//保存本次巡检所有的data
    this.inspectDataMap = {};//保存本次巡检所有的data
    this.currentInspectDataArray = [];//保存当前移动动画,需要巡检的data
    this.currentInspectingDataMap = {}; // 保存正在巡检的data
    this.inspectColor = 'orange';//巡检时,渲染的颜色
    this.moveSpeed = 10; //移动速度
    this.rotateSpeed = 400;//旋转速度
    this.showTrail = true;//显示巡检轨迹

    this.trailColor = 'green';//巡检轨迹颜色
    this.trailWidth = 20;//巡检轨迹宽度
    this.trailHeight = 3;//巡检高度

    this.hideDataMap = {};//巡检时,隐藏的data

    this.isCameraFollow = true;
    this.cameraFollow = null;

};


it.InspectionManager.STATUS_READY = 'ready';
it.InspectionManager.STATUS_PLAYING = 'playing';
it.InspectionManager.STATUS_PAUSE = 'pause';
it.InspectionManager.STATUS_STOP = 'stop';


mono.extend(it.InspectionManager, it.EventHandler, {

    /**
     * 正在巡检
     * @param data
     */
    renderDataHandle: function (data) {

    },

    /**
     * 清除巡检
     */
    resetDataHandler: function (data) {

    },


    /**
     * 创建估计对象
     */
    createTrail: function (points, trailWidth, trailHeight, trailColor) {

        var path = new mono.Path();
        path.moveTo(points[0][0], points[0][1]);
        for (var i = 1; i < points.length; i++) {
            path.lineTo(points[i][0], points[i][1]);
        }
        path = mono.PathNode.prototype.adjustPath(path, 20);
        trailWidth = trailWidth || this.trailWidth;
        trailHeight = trailHeight || this.trailHeight;
        trailColor = trailColor || this.trailColor;
        var trail = new mono.PathCube(path, trailWidth, trailHeight);
        trail.s({
            'm.type': 'phong',
            'm.specularStrength': 30,
            'm.color': trailColor,
            'm.ambient': trailColor,
            'm.texture.repeat': new mono.Vec2(150, 1),
        });
        trail.setRotationX(Math.PI);
        trail.setPositionY(trailHeight / 2 + 4);
        trail.setClient('type', 'trail');
        return trail;
    },
    /**
     * 开始巡检
     */
    play: function () {
        if (this.isPlaying()) {
            console.warn('it is already playing');
            return;
        }

        if (this.isPause()) {
            console.warn('status is pause, you should call resume function');
            return;
        }
        //ready或者stop时,重新开始
        this.startPlay();
        this.status = it.InspectionManager.STATUS_PLAYING;
    },

    /**
     * 暂停巡检
     */
    pause: function () {
        if (this.isPlaying()) {
            var animate = this.getCurrentAnimate();
            animate.pause();
            this.status = it.InspectionManager.STATUS_PAUSE
        } else {
            console.warn('when inspection status is playing, you can pause inspection')
        }
    },

    /**
     * 恢复巡检
     */
    resume: function () {
        if (this.isPause()) {
            //如果是暂停,继续播放
            var animate = this.getCurrentAnimate();
            animate.resume();
            this.status = it.InspectionManager.STATUS_PLAYING;
        } else {
            console.warn('when inspection status is pause, you can resume inspection')
        }
    },

    /**
     * 停止巡检
     * @param finish
     */
    stop: function (finish) {
        if (this.isPlaying() || this.isPause()) {
            if (!finish) {
                var animate = this.getCurrentAnimate();
                animate.stop();
            }
            this.resetHideData();
            this.resetInspectData();
            this.onFinish();
            //播放完毕,释放资源
            if (this.trail) {
                this.box.remove(this.trail);
            }
            delete this.animates;
            delete this.trail;
            delete this.host.animate;

            this.status = it.InspectionManager.STATUS_STOP;
        } else {
            console.warn('inspection is not started')
        }
    },

    /**
     * 增加一个巡检路径, 如果已经播放或者暂停,禁止添加
     * @param path {[{x,y}]} 添加的path,
     */
    setPath: function (path) {
        this.path = path;
    },

    /**
     * 设置移动的host
     * @param host
     */
    setHost: function (host) {
        this.host = host;
    },

    /**
     * 是否是就绪状态
     * @returns {boolean}
     */
    isReady: function () {
        return this.status == it.InspectionManager.STATUS_READY;
    },

    /**
     * 是否是巡检状态
     * @returns {boolean}
     */
    isPlaying: function () {
        return this.status == it.InspectionManager.STATUS_PLAYING;
    },

    /**
     * 是否暂停状态
     * @returns {boolean}
     */
    isPause: function () {
        return this.status == it.InspectionManager.STATUS_PAUSE;
    },

    /**
     * 是否是停止状态
     * @returns {boolean}
     */
    isStop: function () {
        return this.status == it.InspectionManager.STATUS_STOP;
    },

    /**
     * 巡检结束
     */
    onFinish: function () {

        console.log("inspection is completed")
    },

    /**
     * 开始巡检
     * 找到所有的巡检对象
     * 计算处巡检的轨迹,动画效果
     */
    startPlay: function () {

        var self = this;
        var sceneManager = this.sceneManager;
        var camera = this.camera;
        var box = this.box;

        this.initInspectData();

        var object = this.host;
        if (this.isCameraFollow) {
            var cameraFollow = this.cameraFollow || new it.CameraFollow(camera);
            cameraFollow.setHost(object);
        }
        var points = this.path;
        object.setPositionX(points[0][0]);
        object.setPositionZ(points[0][1]);
        //create animate chain
        var animates = this.animates = this.createPathAnimates(camera, object, points, this.loop, this.finalAngle);
        animates[animates.length - 1].onDone = function () {

            self.stop(true);
        };

        this.hideData();

        if (this.showTrail) {

            if (self.createTrail) {
                this.trail = self.createTrail(this.path);
            }
            if (this.trail) {
                this.trail.setParent(this.host.getParent());
                box.add(this.trail);
            }
        }
        //start play
        object.animate = animates[0];
        object.animate.play();
    },

    hideData: function () {
        var self = this;
        var keys = Object.keys(this.hideDataMap);
        keys.forEach(function (key) {
            var data = self.hideDataMap[key];
            self.visibleManager.setVisible(data, false);
        })
    },

    resetHideData: function () {
        var self = this;
        var keys = Object.keys(this.hideDataMap);
        keys.forEach(function (key) {
            var data = self.hideDataMap[key];
            self.visibleManager.setVisible(data, true);
        })
    },

    /**
     * 初始化需要巡检的数据
     */
    initInspectData: function () {
        this.inspectDataArray = [];
        this.inspectDataMap = {};
        this.hideDataMap = {};
        this.box.getNodes().forEach(function (node) {
            var data = this.sceneManager.getNodeData(node);
            if (data && !this.inspectDataMap[data.getId()] && this.isInspect(data)) {
                this.initDataPositionAndRotation(data);
                this.inspectDataMap[data.getId()] = data;
                this.inspectDataArray.push(data);
            }
            if (data && !this.hideDataMap[data.getId()] && this.isHideInInspection(data)) {
                this.hideDataMap[data.getId()] = data;
            }
        }, this);
    },

    /**
     * 取得当前的动画
     * @returns {*}
     */
    getCurrentAnimate: function () {
        if (this.host) {
            return this.host.animate;
        }
        return null;
    },

    /**
     * 创建动画
     * @param camera
     * @param element
     * @param points
     * @param loop
     * @param finalAngle
     * @returns {Array}
     */
    createPathAnimates: function (camera, element, points, loop, finalAngle) {

        var self = this;
        var animates = [];
        var moveSpeed = this.moveSpeed || 10;
        var rotateSpeed = this.rotateSpeed || 400;

        if (points && points.length >= 2) {

            var angle = element.getRotationY() || 0;

            for (var i = 1; i < points.length; i++) {
                var point0 = points[i - 1];
                var point1 = points[i];
                var x = point0[0];
                var z = point0[1];
                var x1 = point1[0];
                var z1 = point1[1];
                var rotate = Math.atan2(-(z1 - z), x1 - x) || 0;

                var rotateAnimate = this.createRotateAnimate(camera, element, rotateSpeed, rotate, angle);
                if (rotateAnimate) {
                    animates.push(rotateAnimate);
                    angle = rotateAnimate.toAngle;
                }

                var moveAnimate = this.createMoveAnimate(camera, element, moveSpeed, x, z, x1, z1);
                animates.push(moveAnimate);

                x = x1;
                z = z1;
            }

            if (finalAngle != undefined && angle != finalAngle) {
                var rotateAnimate = this.createRotateAnimate(camera, element, rotateSpeed, finalAngle, angle);
                if (rotateAnimate) {
                    animates.push(rotateAnimate);
                }
            }
        }
        var animate;
        for (var i = 0; i < animates.length; i++) {
            if (i > 0) {
                animates[i - 1].chain(animates[i]);
                if (loop && i == animates.length - 1) {
                    animates[i].chain(animate);
                }
            } else {
                animate = animates[i];
            }
        }
        return animates;
    },

    /**
     * 创建移动动画
     * @param camera
     * @param element
     * @param moveSpeed
     * @param x
     * @param z
     * @param x1
     * @param z1
     * @returns {TGL.Animate|mono.Animate|Ib.Animate|Ib.animate.Animate}
     */
    createMoveAnimate: function (camera, element, moveSpeed, x, z, x1, z1) {

        var self = this;
        var moveAnimate = new mono.Animate({
            from: { x: x, y: z },
            to: { x: x1, y: z1 },
            type: 'point',
            dur: Math.sqrt((x1 - x) * (x1 - x) + (z1 - z) * (z1 - z)) * moveSpeed,
            easing: 'easeNone',
            onPlay: function () {
                element.animate = this;
                self.currentInspectDataArray = self.getCurrentInspectionData(this);
                self.resetInspectData();
            },
            onUpdate: function (value) {
                element.setPositionX(value.x);
                element.setPositionZ(value.y);
                self.renderInspectData();

            },
        });
        return moveAnimate;
    },

    /**
     * 创建旋转动画
     * @param camera
     * @param element
     * @param toAngle
     * @param angle
     * @returns {*}
     */
    createRotateAnimate: function (camera, element, rotateSpeed, toAngle, angle) {

        angle = parseFloat(angle);
        toAngle = parseFloat(toAngle);
        if (angle === undefined || angle === null || isNaN(angle) ||
            toAngle === undefined || angle === null || isNaN(toAngle) ||
            toAngle == angle) {
            return null;
        }
        if (toAngle - angle > Math.PI) {
            toAngle -= Math.PI * 2;
        }
        if (toAngle - angle < -Math.PI) {
            toAngle += Math.PI * 2;
        }
        //console.log(angle, toAngle);
        var rotateAnimate = new mono.Animate({
            from: angle,
            to: toAngle,
            type: 'number',
            dur: Math.abs(toAngle - angle) * rotateSpeed,
            easing: 'easeNone',
            onPlay: function () {
                element.animate = this;
            },
            onUpdate: function (value) {
                value = value || 0;
                element.setRotationY(value);
            },

        });
        rotateAnimate.toAngle = toAngle;
        return rotateAnimate;
    },


    /**
     * 渲染正在巡检的对象
     * @param data
     */
    renderData: function (data) {

        if (data._inspected) {
            return;
        }
        data._inspected = true;
        var node = this.sceneManager.getNodeByDataOrId(data);
        if (node.getClient('complexNode')) {
            node = node.getClient('complexNode') != 'unload' && node.getClient('complexNode').getParent() ? node.getClient('complexNode') : node.getClient('simpleNode');
        }
        var oldColor = node.getStyle('inspection.m.ambient') || node.getStyle('m.ambient');
        node.setStyle('m.ambient', this.inspectColor);
        node.setStyle('inspection.m.ambient', oldColor);
        this.renderDataHandle && this.renderDataHandle(data);
    },

    /**
     * 恢复巡检的对象
     * @param data
     */
    resetData: function (data) {
        if (!data._inspected) {
            return;
        }
        data._inspected = false;
        delete data._inspected;
        delete data._face2animateLine;
        delete data._distance2host;
        var node = this.sceneManager.getNodeByDataOrId(data);
        if (node.getClient('complexNode')) {
            node = node.getClient('complexNode') != 'unload' && node.getClient('complexNode').getParent() ? node.getClient('complexNode') : node.getClient('simpleNode');
        }
        node.setStyle('m.ambient', node.getStyle('inspection.m.ambient'));
        node.setStyle('inspection.m.ambient', null);
        this.resetDataHandler && this.resetDataHandler(data);
    },

    /**
     * 渲染所有的巡检对象
     */
    renderInspectData: function () {

        var result = false;
        var self = this;

        var newDataArrayTemp = [];
        //找到所有靠近host的data
        this.currentInspectDataArray.forEach(function (data) {
            if (self.isClosed(data, self.host)) {
                newDataArrayTemp.push(data);

            }
        })

        //只选择最近的data, 过滤掉相同角度的其它data,
        var newDataArray = this.filterInspectData(newDataArrayTemp);

        //保存所有新的data
        var map = {};
        newDataArray.forEach(function (data) {
            map[data.getId()] = data;
        })

        //如果没有渲染,渲染data
        newDataArray.forEach(function (data) {
            if (!self.currentInspectingDataMap[data.getId()]) {
                self.renderData(data);
                self.currentInspectingDataMap[data.getId()] = data;
                result = result || true;
            }
        })

        //如果已经不需要渲染, 清除渲染标记
        var keys = Object.keys(this.currentInspectingDataMap);
        if (keys.length > 0) {
            keys.forEach(function (key) {
                if (!map[key]) {
                    self.resetData(self.currentInspectingDataMap[key]);
                    delete self.currentInspectingDataMap[key];
                    result = result || true;
                }
            })
        }
        return result;
    },

    /**
     * 恢复所有的巡检对象
     */
    resetInspectData: function () {
        var self = this;
        var keys = Object.keys(this.currentInspectingDataMap);
        if (keys.length > 0) {
            keys.forEach(function (key) {
                self.resetData(self.currentInspectingDataMap[key]);
                delete self.currentInspectingDataMap[key]
            })
        }
    },

    /**
     * 按距离和角度过滤巡检对象
     * @param array
     * @returns {*}
     */
    filterInspectData: function (array) {

        if (array.length <= 1) {
            return array;
        }
        var result = [];

        //按距离又小到大排序
        array.sort(function (o1, o2) {
            return o1._distance2host - o2._distance2host;
        });

        for (var i = 0; i < array.length; i++) {
            var d = array[i];
            //如果是已经巡检过的,过滤
            if (d._face2animateLine === undefined) {
                continue;
            }
            if (!this.haveSameDir(d, result)) {
                result.push(d);
            }
        }

        return result;
    },

    /**
     * 是否以已经有相同角度的对象
     * @param data
     * @param array
     * @returns {boolean}
     */
    haveSameDir: function (data, array) {
        var angle = data._face2animateLine;
        for (var j = 0; j < array.length; j++) {
            var angleTmp = array[j]._face2animateLine;
            //如果有相邻的,取消
            if (Math.abs(angle - angleTmp) < 45) {
                return true;
            }
        }
        return false;
    },

    /**
     * 是否需要巡检
     * 默认机柜和列头柜巡检
     * @param data
     * @returns {boolean}
     */
    isInspect: function (data) {
        var dataType = this.dataManager.getDataTypeForData(data);
        if (!dataType) {
            return false;
        }
        var categoryId = dataType.getCategoryId();
        if (categoryId == 'rack' || categoryId == 'headerRack') {
            return true;
        }
        return false;
    },

    /**
     * 是否在巡检时隐藏
     * @param data
     * @returns {boolean}
     */
    isHideInInspection: function (data) {
        var dataType = this.dataManager.getDataTypeForData(data);
        if (!dataType) {
            return false;
        }
        var categoryId = dataType.getCategoryId();
        if (categoryId == 'channel') {
            return true;
        }
        return false;
    },

    /**
     * 取得当前动画执行轨迹, 所有面向轨迹的data, 并且离轨迹距离小与limitDistance的data
     * @param animate
     * @returns {Array}
     */
    getCurrentInspectionData: function (animate) {
        var result = [];
        var from = animate.from;
        var to = animate.to;
        var line = this.getLine(from, to);
        this.inspectDataArray.forEach(function (data) {
            if (this.isFace2Line(data, from, to, line)) {
                result.push(data);
            }
        }, this)
        return result;
    },

    /**
     * 是否面向线路
     * @param data
     * @returns {boolean}
     */
    isFace2Line: function (data, from, to, line) {

        var np = data._absolutePosition;
        var npx = np.x;
        var npy = np.z;
        var nodeAngle = data._absoluteRotation.y;
        if (line.b == 0) {

            var dx = npx - to.x;
            if (Math.abs(dx) > this.limitDistance) {
                return false;
            }

            //竖直线
            var angle;
            //右边
            if (npx > -line.c) {
                angle = 270;
            } else {
                angle = 90;
            }
            //角度不对
            if (Math.abs(nodeAngle - angle) > this.limitAngle) {
                return false;
            }
            data._face2animateLine = angle;
        } else if (line.a == 0) {

            var dy = npy - to.y;
            if (Math.abs(dy) > this.limitDistance) {
                return false;
            }

            //水平线
            var angle;
            //上方
            if (npy > -line.c) {
                angle = 180;
            } else {
                angle = 0;
            }
            if (Math.abs(nodeAngle - angle) > this.limitAngle) {
                return false;
            }
            data._face2animateLine = angle;
        } else {

            var d = Math.abs((line.a * npx + line.b * npy + line.c) / Math.sqrt(Math.pow(line.a, 2) + Math.pow(line.b, 2)))
            if (d > this.limitDistance) {
                return false;
            }

            //斜线
            var kk = 1 / line.k;//法线角度
            var angle = Math.atan(kk) / Math.PI * 180; //换算成角度
            var npxx = -(line.b * npy + line.c) / line.a;
            //点在线右边
            if (npxx < npx) {// 90度到 270度

                angle += 180;
            } else {  // -90 度 到 90度

                if (angle < 0) {
                    angle += 360;
                }
            }
            //机柜默认旋转了-90度,所以要加上90度
            angle += 90;
            angle = angle % 360;
            //计算处夹角, 夹角绝对值不可能大于180度
            var da = Math.abs(nodeAngle - angle);
            if (da > 180) { //如果是大于180度, 反向取值, 夹角绝对值不可能大于180度
                da = 360 - da;
            }
            if (da > this.limitAngle) {
                return false;
            }
            data._face2animateLine = angle;
        }
        return true;
    },

    /**
     * 是否巡检到当前数据
     * @param data
     * @param host
     * @returns {*}
     */
    isClosed: function (data, host) {

        var np = data._absolutePosition;
        var npx = np.x;
        var npy = np.z;

        var hp = host.getPosition();
        var hpx = hp.x;
        var hpy = hp.z;
        var d = Math.sqrt(Math.pow(hpx - npx, 2) + Math.pow(hpy - npy, 2));
        data._distance2host = d;
        return d < this.limitDistance;
    },

    /**
     * 根据两点, 计算出直线
     * @param p1
     * @param p2
     * @returns {*}
     */
    getLine: function (p1, p2) {
        if (p1.x == p2.x) {
            //竖直线
            return { a: 1, b: 0, c: -p1.x };
        } else if (p1.y == p2.y) {
            //水平线
            return { a: 0, b: 1, c: -p1.y }
        }
        var a = 0, b = 0, c = 0;
        var k = (p1.y - p2.y) / (p1.x - p2.x);
        var c = p1.y - k * p1.x;
        a = k, b = -1;
        return { a: a, b: b, c: c, k: k }
    },

    /**
     * 计算data相对于楼层的绝对坐标
     * @param data
     */
    initDataPositionAndRotation: function (data) {

        if (data._absolutePosition && data._absoluteRotation) {
            return;
        }
        var node = this.sceneManager.getNodeByDataOrId(data);
        var p = node.getPosition();
        var r = node.getRotation();
        var pp = { x: p.x, y: p.y, z: p.z };
        var rr = { x: r.x, y: r.y, z: r.z };
        var parentData = this.dataManager.getDataById(data.getParentId());
        this._initDataPositionAndRotation(parentData, pp, rr);
        rr.x = (rr.x / Math.PI * 180) % 360;
        rr.y = (rr.y / Math.PI * 180) % 360;
        rr.z = (rr.z / Math.PI * 180) % 360;
        data._absolutePosition = pp;
        data._absoluteRotation = rr;
    },

    /**
     * 取得相对于父亲的坐标
     * @param parentData
     * @param position
     */
    _initDataPositionAndRotation: function (parentData, position, rotation) {

        if (!parentData) {
            return;
        }
        var dataType = this.dataManager.getDataTypeForData(parentData);
        if (!dataType) {
            console.warn('dataType is null');
            return;
        }
        var categoryId = dataType.getCategoryId();
        if (categoryId == 'floor') {
            console.warn('parent data type is floor, calculate position complete')
            return;
        }

        //
        //x0= (x - rx0)*cos(a) - (y - ry0)*sin(a) + rx0 ;

        //y0= (x - rx0)*sin(a) + (y - ry0)*cos(a) + ry0 ;

        var parentNode = this.sceneManager.getNodeByDataOrId(parentData);
        if (parentNode) {
            var pp = parentNode.getPosition();
            var rr = parentNode.getRotation();

            var x = position.x;
            var z = position.z;
            var rx0 = 0;
            var rz0 = 0;
            var a = -rr.y;//还原角度
            var x0 = (x - rx0) * Math.cos(a) - (z - rz0) * Math.sin(a) + rx0;
            var z0 = (x - rx0) * Math.sin(a) + (z - rz0) * Math.cos(a) + rz0;
            position.x = x0;
            position.z = z0;//2D和3D的方向相反,3D顶视图, 逆时针旋转为正, z轴上为负, 下为正

            position.x += pp.x;
            position.y += pp.y;
            position.z += pp.z;


            rotation.x += rr.x;
            rotation.y += rr.y;
            rotation.z += rr.z;
        }

        var parentParentData = this.dataManager.getDataById(parentData.getParentId());
        if (parentParentData) {
            this._initDataPositionAndRotation(parentParentData, position, rotation);
        }
    }
});

/**
 * 端口管理
 * 1、根据模板数据创建端口
 * 2、连线连到端口
 * 3、端口告警
 */
var $PortManager = function(sceneManager){
	this.sceneManager = sceneManager;
	this.dataManager = this.sceneManager.dataManager;
	this.dataBox = this.sceneManager.network3d.getDataBox();
	//为了跟2D中端口的id统一，采用:'id+"@"+parentId'的方式,可是不太好根据parentId来查找，并且不太严格，
	//因此采用tree的结构来存储,即：{parentId001:{port01:portNode01,...},parentId001:{port01:portNode01,...}}
	this.portNodeMap = {}; // 注意正反面的问题，保存时没有考虑正反面的问题哦———— 2017-07-21
};

mono.extend($PortManager,Object,{

	removePortsByParentId : function(parentId){
		var ports = this.portNodeMap[parentId];
		if (ports) {
			for(var id in ports){
				var port = ports[id];
				if (port) {
					port.setParent(null);
					this.dataBox.remove(port);
				}
			}
			// delete this.portNodeMap[parentId];
		}
	},

	/**
     * 根据设备id，获取到所有的端口对象
     */
	getAllPortsByParentId: function(parentId){
		var ports = [];
		var dataType = this.dataManager.getDataTypeForData(parentId);
		if (!dataType || !dataType.getTemplateDatas()) {
			return null;
		}
		var templateDatas = dataType.getTemplateDatas();
		for(var i = 0 ;i < templateDatas.length; i++){
			var tdata = templateDatas[i];
			var side = tdata.getUserData('side')||0;
			port = this.loadPortByPortId(parentId,tdata.getId(),side);
			ports.push(port);
		}
		return ports;
	},
    
    /**
     * 根据设备id，加载该设备所有的端口
     */
	loadAllPortsByParentId : function(parentId){
		var ports = this.getAllPortsByParentId(parentId);
		for(var i = 0 ;i < ports.length; i++){
			var port = ports[i];
			this.dataBox.add(port);
		}
	},
    
    /**
     * 根据端口id(端口id包括了parentid和端口id，以下同理)加载端口
     */
	loadPortByPortId : function(parentId,portId,side){
		var port = this.getPortById(parentId,portId);
		if (port) {
			return port;
		}
	    port = this.createPortByPortId(parentId,portId,side);
		if (port) {
			var parentPorts = this.portNodeMap[parentId];
			if (!parentPorts) {
				parentPorts = {portId:port};
				this.portNodeMap[parentId] = parentPorts;
			}else{
				parentPorts[portId] = port;
			}
		}
		return port;
	},

    /**
     * 根据端口id找对应的端口对象
     */
	getPortById : function(parentId,portId){
		var parentPorts = this.portNodeMap[parentId];
		if (parentPorts) {
			return parentPorts[portId];
		}
		return null;
	},
    
    /**
     * 根据端口id创建3d端口
     * @parentId 表示的是设备的id
     * @portId 是端口的id
     * @side 表示的是哪一面，0是正面，1是反面
     * 并且如果是反面的话，需要旋转(左边跑到右边，正面跑到反面)
     */
	createPortByPortId : function(parentId,portId,side){
		var dataType = this.dataManager.getDataTypeForData(parentId);
		var devNode = this.sceneManager.getNodeByDataOrId(parentId);
		if (!dataType || !portId || !devNode) {
			return null;
		}
		side = side||0;
		var portData = dataType.getTemplateDataById(portId+(side?'@true':'@false'));
		if (!portData) {
			return null;
		}
		var panelData = dataType.getModel2dParameters()[0];
		var portType = this.dataManager.getDataTypeById(portData.getDataTypeId()); //can not getDataTypeForData
		if (!portType) {
			return null;
		}
		if (!panelData) {
			return null;
		}
		if (!portType.getModel()) {
			console.log('portType‘s model is null!');
			return null;
		};
		var panelParam = make.Default.getModelDefaultParametersValues(panelData.id);
		// 端口的尺寸{width: 13.06, height: 9.55}
		var portParam = make.Default.getModelDefaultParametersValues(portType.getModel2d());
		if (!portParam) {
			console.log('port Param is null');
			return null;
		}
		var port = this.sceneManager.loadModel(portType.getModel(),portType.getModelParameters(),true,portType.getId());
		// x:(data.getPosition().x - panel.size.x)/10
		// y:(data.getPosition().y - panel.size.y)/10
		var port2DPos = portData.getPosition();
		var portRot = portData.getRotation();// 角度制
		var dbb = devNode.getBoundingBox();
		if (!port || !port2DPos || !panelParam) {
			return null;
		}
		 // {width: 455, height: 44.45} ,不是10倍的关系(x: 50, y: 4.445, z: 51)，还是更加boundingBox的size来推算吧
		 var scaleX = panelParam.width/dbb.size().x; 
		 var scaleY = panelParam.height/dbb.size().y;

         /* 
		 var padding = devNode.getClient('padding');
		 if (side === 1 && padding && padding instanceof Array) {
		 	 var up = padding[0]||0,right = padding[1]||0,down = padding[2]||0,left = padding[3]||0;
		 	 scaleX = panelParam.width/(dbb.size().x - right - left);
		 	 scaleY = panelParam.height/(dbb.size().y - up - down);
		 }
		 */
		 // 可能是横着的，也可能是竖着的。可能n行n列 
		var x = (port2DPos.x + portParam.width/2 - panelParam.width/2)/scaleX; 
		var y = (panelParam.height/2 - portParam.height/2 - port2DPos.y)/scaleY; // 2d中左上角为(0,0)，并且host的location是host的左上角的位置
		if (side === 1) { // 背面的话，需跟正面比较，算出新的padding
		 	var backPanelData = dataType.getModel2d2Parameters()[0];
		 	var backPanelParam = make.Default.getModelDefaultParametersValues(backPanelData.id);
		 	var backWidth = backPanelParam.width;
		 	var backHeight = backPanelParam.height;
		 	// var up  = (panelParam.height-backHeight)/2;
		 	// var left = (panelParam.width-backWidth)/2;
		 	var up = 0; //从中心往两边跑，不需要+up和-left
		 	var left = 0;
		 	x = (port2DPos.x + portParam.width/2 + left - backPanelParam.width/2)/scaleX; 
		    y = (backPanelParam.height/2 - portParam.height/2 - port2DPos.y - up)/scaleY;
		}
		port.setX(x);
		port.setY(y);
		if (side === 1) {
			port.setZ(dbb.min.z); 
			// 如果是反面的话，创建的端口则需要旋转，并且位置也要反过来，原来在右边的应该跑到左边，左边跑到右边
			port.setRotationY(Math.PI);
			var px =  (-1)*x;  //反一下
			port.setX(px);
		}else{
			port.setZ(dbb.max.z);
		}
		if (portRot) {
			if (portRot.x) {
				port.setRotationX(portRot.x*Math.PI/180);
			}
			if (portRot.z) {
				port.setRotationZ(portRot.z*Math.PI/180);
			}
		}
		port.c({
			'parentId': parentId,
			'portId': portId,
			'side': side
		});
		port.setParent(devNode);
		return port;
	}
	
});

it.PortManager = $PortManager;
/**
 * 端口占用率管理
 * @param sceneManager
 * @constructor
 */
it.PortCapacityManager = function (sceneManager) {

    it.EventHandler.call(this);
    this.sceneManager = sceneManager;
    this.dataManager = this.sceneManager.dataManager;
    this.visibleManager = new $VisibleManager(this.sceneManager);
    this.sceneManager.viewManager3d.addVisibleFilter(this.visibleManager);
    this.colors = ['#8A0808', '#088A08', '#088A85', '#6A0888', '#B18904'];
    this.padding = 2.5;
    this.portNodes = [];
    this.solidColor = '#eaeaea';
};

it.PortCapacityManager.CATEGORY_EQUIPMENT = 'equipment';
it.PortCapacityManager.CATEGORY_PORT = 'port';

mono.extend(it.PortCapacityManager, it.EventHandler, {

    /**
     * 计算端口利用率
     * @param dataOrId
     * @returns {*}
     */
    computePortPercent: function (dataOrId) {

        var dm = this.dataManager;
        var data = dataOrId;
        if (!data.getId) {
            data = dm.getDataById(dataOrId);
        }
        var dataType = dm.getDataTypeForData(data);
        if (!dataType) {
            return;
        }
        //只计算设备的端口利用率
        if (dataType.getCategoryId() != it.PortCapacityManager.CATEGORY_EQUIPMENT) {
            return;
        }

        //计算所有端口
        var ports = this.computePortInfo(data);
        //如果没有端口,默认端口利用率是100%
        if (!ports || ports.length == 0) {
            return 100;
        }

        //计算出有连线的端口数量
        var count = 0;
        for (var i = 0; i < ports.length; i++) {
            var port = ports[i];
            var links = port.getAllLinks();
            if (links && Object.keys(links).length > 0) {
                count++;
            }
        }
        return count / ports.length * 100;
    },

    /**
     * 从设备的所有孩子中查找出端口
     * @param dataOrId
     * @returns {Array}
     */
    computePortInfo: function (dataOrId) {

        var dm = this.dataManager;
        var self = this;
        var data = dataOrId;
        if (!data.getId) {

            data = dm.getDataById(dataOrId);
        }
        //取得所有的端口
        var allPorts = [];
        var children = dm.getChildren(data);
        children.forEach(function (child) {
            var childDataType = dm.getDataTypeForData(child);
            if (!childDataType || childDataType.getCategoryId() != it.PortCapacityManager.CATEGORY_PORT) {
                return;
            }
            allPorts.push(child);
        })
        return allPorts;
    },

    /**
     * 创建重量比率节点
     * @param dataOrId
     */
    createPortNode: function (dataOrId, width, height, depth, positionY, rackNode) {

        var sm = this.sceneManager, dm = this.dataManager, data = dataOrId,
            box = sm.network3d.getDataBox();
        //如果不在当前场景
        if (!sm.isCurrentSceneInstance(dataOrId)) {
            return;
        }
        if (!data.getId) {
            data = dm.getDataById(dataOrId);
        }
        var percent = this.computePortPercent(data);

        if (percent == null) {
            return;
        }

        percent = Math.round(Math.random() * 100);//FIXME 发后注释
        data._portPercent = percent;

        var portNode = data._portNode;
        if (!portNode) {
            portNode = new mono.Cube(width, height, depth);
            portNode.setPosition(0, positionY, 0);
            portNode.s({
                'm.type': 'phong',
                'm.specularStrength': 50,
                'm.transparent': true,
                'm.opacity': 0.6,

            });
            portNode.setClient('it_data', 'port');
            portNode.setClient('portChildNode', true);
            portNode.setClient('data', data);
            data._portNode = portNode;
        }
        var color = this.getPortNodeColor(percent);
        portNode.s({
            'm.color': color,
            'm.ambient': color,
        });
        portNode.setParent(rackNode);
        box.addByDescendant(portNode);
        return portNode;
    },

    /**
     * 创建重量比率节点
     * @param dataOrId
     */
    createSolidNode: function (width, height, depth, positionY, rackNode) {

        var sm = this.sceneManager, dm = this.dataManager, box = sm.network3d.getDataBox();

        var solidNode = solidNode = new mono.Cube(width, height, depth);
        solidNode.setPosition(0, positionY, 0);
        solidNode.s({
            'm.type': 'phong',
            'm.specularStrength': 50,
            'm.color': this.solidColor,
            'm.ambient': this.solidColor,

        });
        solidNode.setClient('it_data', 'port_solid');
        solidNode.setClient('portChildNode_solid', true);
        solidNode.setParent(rackNode);
        box.addByDescendant(solidNode);
        return solidNode;
    },

    makeItDataUnvisible: function (data) {
        if (!data) {
            return;
        }
        this.visibleManager.setVisible(data, false);
        var self = this;
        data.getChildren().forEach(function (child) {
            self.makeItDataUnvisible(child);
        });
    },

    makeItDataVisible: function (data) {//node
        if (!data) {
            return;
        }
        this.visibleManager.setVisible(data, true);
        var self = this;
        data.getChildren().forEach(function (child) {
            self.makeItDataVisible(child);
        });
    },

    removePortNode: function (dataOrId) {
        var sm = this.sceneManager, dm = this.dataManager, data = dataOrId, box = sm.network3d.getDataBox();
        if (!data.getId) {
            data = dm.getDataById(dataOrId);
        }
        delete data._portPercent;
        var portNode = data._portNode;
        if (portNode) {
            portNode.setParent(null);
            box.removeByDescendant(portNode);
        }
        this.makeItDataVisible(data);
    },

    getPortNodeColor: function (percent) {
        if (this.portNodeColorFunction) {
            var color = this.portNodeColorFunction(percent);
            return color;
        }

        var colorIndex = Math.ceil(percent / 20);
        return this.colors[colorIndex - 1];
    },

    isDataSupport: function (data) {
        var dm = this.dataManager;
        var dataType = dm.getDataTypeForData(data);
        if (dataType && dataType.getCategoryId() == it.PortCapacityManager.CATEGORY_EQUIPMENT && dataType.getSubType() == 'network') {

            return true;
        }
        return false;
    },

    calcDataHeight: function (data) {
        var dm = this.dataManager;
        var dataType = dm.getDataTypeForData(data);
        var size = dataType.getSize();
        return parseInt(size.ySize || 0) * make.Default.UNIT_HEIGHT;
    },


    /**
     * 显示机柜里面设备的端口占用率
     * FIXME 颜色块之间,要加上一个小间隔试试
     * @param data
     */
    createPortNodeInRack: function (data) {
        var result = [];
        var sm = this.sceneManager, dm = this.dataManager, self = this;
        //如果不在当前场景
        if (!sm.isCurrentSceneInstance(data)) {
            return;
        }
        var dataType = dm.getDataTypeForData(data);
        if (!dataType) {
            console.warn('dataType is not exist');
            return;
        }
        var rackNode = sm.getNodeByDataOrId(data);
        if (!rackNode) {
            console.warn('rack node is not exist')
            return;
        }
        var childrenSize = dataType.getChildrenSize();
        var boundingBox = rackNode.getBoundingBox(),
            size = boundingBox.size(),
            width = size.x, height = size.y, depth = size.z;

        this.makeItDataUnvisible(data);
        var childrenAll = dm.getChildren(data);
        //var children = [];
        var childMap = {};
        //过滤出设备节点
        childrenAll.forEach(function (child) {
            if (self.isDataSupport(child)) {
                //children.push(child);
                childMap[child.getLocation().y] = child;
            }
        })

        var lastSolid = 0;
        //按机柜高度显示端口占用比
        for (var i = 1; i <= childrenSize.ySize; i++) {
            if (childMap[i]) {

                var child = childMap[i];
                if (lastSolid != 0) {
                    //填补之前的空白块
                    var childSize = i - lastSolid;
                    var childHeight = parseInt(childSize) * make.Default.UNIT_HEIGHT;
                    childHeight -= self.padding;

                    var positionY = childrenSize.yPadding[0];
                    positionY += (lastSolid - 1 + (childSize) / 2) * make.Default.UNIT_HEIGHT;
                    positionY += self.padding / 2;
                    positionY -= height /2;
                    console.log('solid: height = ' + childHeight + '  positionY = ' + positionY);
                    var node = self.createSolidNode(width, childHeight, depth, positionY, rackNode);
                    if (node) {
                        result.push(node);
                    }
                    lastSolid = 0;
                }
                var childDataType = dm.getDataTypeForData(child);
                var childSize = childDataType.getSize().ySize;
                var childHeight = parseInt(childSize || 0) * make.Default.UNIT_HEIGHT;
                childHeight -= self.padding;

                var loc = child.getLocation();
                var positionY = childrenSize.yPadding[0];
                positionY += (loc.y - 1 + childSize / 2) * make.Default.UNIT_HEIGHT;
                positionY += self.padding / 2;
                positionY -= height /2;
                console.log('port : height = ' + childHeight + '  positionY = ' + positionY);
                var node = self.createPortNode(child, width, childHeight, depth, positionY, rackNode);
                if (node) {
                    result.push(node);
                }
                i--;
                i += childSize;
            } else if (lastSolid == 0) {
                lastSolid = i;
                continue;
            }

        }
        if (lastSolid != 0) {
            //填补之前的空白块
            var childSize = i - lastSolid;
            var childHeight = parseInt(childSize) * make.Default.UNIT_HEIGHT;
            childHeight -= self.padding;

            var positionY = childrenSize.yPadding[0];
            positionY += (lastSolid - 1 + (childSize) / 2) * make.Default.UNIT_HEIGHT;
            positionY += self.padding / 2;
            positionY -= height /2;
            console.log('solid: height = ' + childHeight + '  positionY = ' + positionY);
            var node = self.createSolidNode(width, childHeight, depth, positionY, rackNode);
            if (node) {
                result.push(node);
            }
            lastSolid = 0;
        }
        data.portNodeArray = result;
        //按顺序排序
        //children.sort(function (o1, o2) {
        //    return o1.getLocation().y - o2.getLocation().y;
        //})
        //children.forEach(function (child) {
        //
        //    var solid = !!child.network;
        //    var childDataType = dm.getDataTypeForData(child);
        //    var childSize = childDataType.getSize();
        //    var childHeight = parseInt(childSize.ySize || 0) * make.Default.UNIT_HEIGHT;
        //    var loc = child.getLocation();
        //    var positionY = childrenSize.yPadding[0];
        //    positionY += loc.y * make.Default.UNIT_HEIGHT - height / 2;
        //    childHeight -= self.padding;
        //    positionY += self.padding / 2;
        //    var node = self.createPortNode(child, width, childHeight, depth, positionY, solid, rackNode);
        //    if (node) {
        //        result.push(node);
        //    }
        //
        //})
        return result;
    },

    hasChild: function (y, children) {

    },

    /**
     * 隐藏机柜里面设备的端口占用率
     * @param data
     */
    removePortNodeInRack: function (data) {
        var sm = this.sceneManager, dm = this.dataManager, self = this, box = sm.network3d.getDataBox();
        //如果不在当前场景
        if (!sm.isCurrentSceneInstance(data)) {
            return;
        }
        var rackNode = sm.getNodeByDataOrId(data);
        if (!rackNode) {
            return;
        }
        this.makeItDataVisible(data);
        if (data.portNodeArray) {
            data.portNodeArray.forEach(function (node) {
                box.remove(node);
            })
        }
    },
});

var $VisibleManager = function(sceneManager){
    it.VisibleFilter.call(this);
    this.sceneManager = sceneManager;
    this.isDealWithFunction = null;
    this._vmap = {};
};

mono.extend($VisibleManager,it.VisibleFilter,{

    clear: function(){
        this._vmap = {};
        // 需要注意的时，当没有加到viewManager3D中时，怎么clear都不应该fire,这里还需改进!!!
        this.sceneManager._sceneVisibleChangeDispather.fire({
                data:null,
                type:'clear'
        });
    },

    /**
     * 是否需要设置显示/隐藏：
     * @param data
     * @returns {boolean}
     */
    isDealWith : function(data){
        if(this.isDealWithFunction != null){
            return this.isDealWithFunction(data);
        }
        return true;
    },

    getBId : function(data){
        if(!data) {
            return null;
        }
        if (!(data instanceof it.Data)) {
             return null;
        }
        if(!this.isDealWith(data)){
            return null;
        }
        return data.getId();
    },

    setVisible: function(data, visible, fireDispather) {
        var id = this.getBId(data);
        if (id) {
            var oldValue = this._vmap[id];
            if (visible) {
                delete this._vmap[id];
            } else {
                this._vmap[id] = false;
            }
            if (oldValue == undefined) { //如果map中没有的话就直接退出
                return ;
            }
            if (fireDispather === null || fireDispather === undefined) {
                fireDispather = true;
            }
            if (fireDispather && (oldValue != visible)) {
                this.sceneManager._sceneVisibleChangeDispather.fire({
                    data: data,
                    value: visible,
                });
            }
        }
    },

    getDataByNode : function(node){
        if(!node){
            return null;
        }
        return this.sceneManager.getNodeData(node);
    },

    setVisibleByDescendant : function(data,visible,fireDispather){
        if(!data){
            return ;
        }
        if(data instanceof mono.Element){
            data = this.getDataByNode(data);
        }
        if(fireDispather === null || fireDispather === undefined){
            fireDispather = true;
        }
        if(!data || !data.getId()) return;
        this.setVisible(data,visible,false);
        // var node = this.sceneManager.dataNodeMap[data.getId()];
        // var children = node.getChildren();
        var children = data.getChildren();
        if(children && children.size() > 0){
            for(var i = 0 ; i < children.size(); i++){
                var child = children.get(i);
                // var childData = this.getDataByNode(child);
                // if(childData
                //     && this.getBId(childData) != this.getBId(data)){
                //     this.setVisibleByDescendant(child,visible,false,this);
                // }
                if(this.getBId(child) != this.getBId(data) 
                    || (!this.getBId(child) && !this.getBId(data))){ //当两个Bid都为null时也执行，因为filter(过滤在里面处理的)
                    this.setVisibleByDescendant(child,visible,false,this);
                }
            }
        }
        if(fireDispather){
            this.sceneManager._sceneVisibleChangeDispather.fire({
                data: data,
                type:'descendtant',
                value: visible,
            });
        }
    },

    isVisible: function(node,dataOrId,network){
        var data = null;
        if (dataOrId) {
            if (dataOrId instanceof it.Data) {
                data = dataOrId;
            }else{
                data = this.sceneManager.dataManager.getDataById(dataOrId);
            }
        }
        var id = this.getBId(data);
        if (node && node.getClient(it.SceneManager.CLIENT_EXT_VISIBLE)) { // 如果是扩展的直接就返回不管了
            return true;
        }
        if(this._vmap[id] != false){
            return true;
        }
        return false;
    }

});

it.VisibleManager = $VisibleManager;


/**
 * 用来组建DataFind的基础数据类型
 * @constructor
 */
it.SData = function(inputIndex,inputType,label,placeholder,dataType,readonly){
    it.Base.call(this);
    this._key = "";
//    this._isObject = false; // data.obj[key] 这个obj
    this._isClient = false;
    this._value = "";
    this._operation = "";
    this._clientMap = {};
    this._style = "";
    this.placeholder = placeholder;
    this.label = label;
    this.inputType = inputType;
    this.inputIndex = inputIndex; //在组建BasePanel时，用做div的id
    this._dataType = dataType||'string';
    this._readonly = false;
    if (readonly === true) {
        this._readonly = true;
    }
//    this._rowspan = null;
//    this._colspan = null;
};

mono.extend(it.SData,it.Base,{

    ___accessor :['key','isClient','value','operation','style','dataType'],

    setClient : function(key,value){
        if(key){
            this._clientMap[key] = value;
        }
    },

    getClient : function(key){
       return this._clientMap[key];
    },

    //{key:'u:userId',value:'aaa',operation:'like'}
    toString : function(){
        if(!this._key || !this._value){
            return '';
        }
        var key = this._key;
        if(this._isClient){
            key = 'u:' + key;
        }
        var obj = {key:key};
        var value = '';
        if(this._value){
            value = this._value;
        }
        obj.value = value;
        var operation = '=';
        if(this._operation){
            operation = this._operation;
        }
        obj.operation = operation;
        obj.dataType = this._dataType;
        return obj;
    }

});


/**
 * 条件查询输入panel
 * @constructor
 */

it.BasePanel = function(panelId){
    if(!panelId){
        panelId = 'base-search-panel'
    }
    this.mainPane = $('<div id="'+panelId+'" class="inputPane"> </div>');
    this._ids = [];
    this.inputMap = {}; // 用于存放更加sdata创建的input
    this.className = 'BasePanel';
    this.doClickFunction = null;
    this.doClearFunction = null;
};

mono.extend(it.BasePanel,Object,{

    createRow : function(){
        return $('<div class="row"></div>');
    },

    createCol : function(num,withClass){
        if(!num){
            num = 3;
        }
        if(withClass){
            return  $('<div class="without-padding col-md-'+num+' '+ withClass +'"></div>');
        }else{
            return  $('<div class="without-padding col-md-'+num+'"></div>');
        }
    },

    appendRow : function(row){
        if(row){
            this.mainPane.append(row);
            var height = this.mainPane.height();
            height += 27;
            // this.mainPane.height(height); //如果lable太长的话，存在跨行的情况，所有高度自适应的计算
        }
    },

    addQuick : function(cdata){
        if(!cdata) return;
        if (this.className && cdata.inputIndex) {
            cdata.inputIndex = this.className + '_' + cdata.inputIndex;
        };
        var id = cdata.inputIndex;
        var placeholder = cdata.placeholder;
        var row = this.createRow();
        var col = this.createCol(12);
        var input = $('<input type="text" class="input-min contral-width" id="'+id+'" placeholder="'+placeholder+'">');
        var style = cdata.getStyle()||"";
        if(style){
            input.attr('style',style);
        }
        var self = this;
        input.keypress(function(event){
            if(event.keyCode === 13){
                self.doClick();
            }
        });
        col.append(input);
        this.inputMap[id] = input;
        row.append(col);
        this.appendRow(row);
        this._ids.push(cdata);
    },

    validateDatePick : function(){
        $('.datetime-picker').datetimepicker({
            language:  'zh-CN',
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayBtn: true,
            startView: 2,
            minView: 2
        });
    },


    createInput : function(data){
        if(!data) return;
        var id = data.inputIndex;
        var input = null;
        if(data.inputType && data.inputType.toLowerCase() == 'date'){
            input = $('<input id="'+id+'" class="input-min contral-width datetime-picker">');
//            this.validateDatePick(); //重复调用,不知datepicker自身是不是单例的,不对，需要add到body上后调用才有效
            input.datetimepicker({  //这样不就行了么，需测试，2016-09-21
                language:  'zh-CN',
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayBtn: true,
                startView: 2,
                minView: 2
            });
        }else{
             input = $('<input id="'+id+'" class="input-min contral-width">');
        }
        var style = data.getStyle()||"";
        if(style){
            input.attr('style',style);
        }
        if (data._readonly) {
            input.attr('readonly', 'readonly');
        }
        // this.inputMap[id] = input;
        return input;
    },

    /**
     * 创建行，如果同时传入了两个cdata，就表示这两行合并成一行
     * @param cdata
     * @param cdata2
     */
    addRow : function(cdata,cdata2){
        if(!cdata && !cdata2) return;
        if (this.className) {
            if (cdata && cdata.inputIndex) {
                cdata.inputIndex = this.className + '_' + cdata.inputIndex;
            }
            if (cdata2 && cdata2.inputIndex) {
                cdata2.inputIndex = this.className + '_' + cdata2.inputIndex;
            }
        }
        var row = this.createRow();
        if(cdata && cdata2){//表示cdata和cdata2都不为空
            var id1 = cdata.inputIndex;
            var label1 = cdata.label;
            var labelCol1 = this.createCol(3);
            var h_label = $('<label for="'+id1+'" class="inputpane-label label-min">'+label1+'</label>');
            labelCol1.append(h_label);
            row.append(labelCol1);
            var txtCol1 = this.createCol(4);
            var input1 = this.createInput(cdata);
            this.inputMap[cdata.inputIndex] = input1;
            txtCol1.append(input1);
            row.append(txtCol1);
            input1.keypress(function(event){
                if(event.keyCode === 13){
                    self.doClick();
                }
            });
            this._ids.push(cdata);
            var id2 = cdata2.inputIndex;
            var label2 = cdata2.label;
            var labelCol2 = this.createCol(1,'text-center');
            var h_label2 = $('<label for="'+id2+'" class="inputpane-label label-min">'+label2+'</label>');
            labelCol2.append(h_label2);
            row.append(labelCol2);
            var txtCol2 = this.createCol(4);
            var input2 = this.createInput(cdata2);
            this.inputMap[cdata2.inputIndex] = input2;
            txtCol2.append(input2);
            row.append(txtCol2);
            input2.keypress(function(event){
                if(event.keyCode === 13){
                    self.doClick();
                }
            });
            this.appendRow(row);
            this._ids.push(cdata2);
        }else{
            if(!cdata && cdata2) {
                cdata = cdata2;
            }
            var id = cdata.inputIndex;
            var label = cdata.label;
            var labelCol = this.createCol(3);
            var txtCol = this.createCol(9);
            var h_label = $('<label for="'+id+'" class="inputpane-label label-min">'+label+'</label>');
            labelCol.append(h_label);
            row.append(labelCol);
//        var input = $('<input id="'+id+'" class="input-min contral-width">');
            var input = this.createInput(cdata);
            this.inputMap[cdata.inputIndex] = input;
            var self = this;
            input.keypress(function(event){
                if(event.keyCode === 13){
                    self.doClick();
                }
            });
            txtCol.append(input);
            row.append(txtCol);
            this.appendRow(row);
            this._ids.push(cdata);
        }
    },

    /**
     * 添加固定的查询条件，如：想查询type勇为“Rack”的，但是不想在搜索框中体现处理
     * @param cdata
     */
    addConstantCondition : function(cdata){
        if(!cdata){
            this._ids.push(cdata);
        }
    },

    addButtonRow : function(){
        var row = this.createRow();
        var col = this.createCol(12);
        var btnOk = $('<span id="btn_search_it" class="base-panel-search-btn" type="submit" title="搜 索">搜 索</span>');
        var btnClear = $('<span id="btn_cancel_search_it" class="base-panel-search-btn" type="cancel" title="清 除">清 除</span>');
        col.append(btnClear);
        col.append(btnOk);
        var self = this;
        btnOk.click(function(){
            self.doClick();
        });
        btnClear.click(function(){
            self.doClear();
        });
        row.append(col);
        this.appendRow(row);
    },

    /**
     * 通过obj创建it.SData
     */
    createSDataByObj: function(data) {
        if (!data) {
            return null;
        }
        var inputIndex = data.inputIndex;
        var inputType = data.inputType;
        var label = data.label;
        var placeholder = data.placeholder;
        var dataType = data.dataType;
        var key = data.key;
        if (!key) {
            return null;
        }
        var sdata = new it.SData(inputIndex, inputType, label, placeholder, dataType);
        sdata.setKey(key);
        sdata.setOperation(data.operation);
        if (data.source) {
            if (data.source instanceof Array) {
                sdata.setClient('options',data.source);
            }else if (this[data.source] && typeof(this[data.source]) == 'function') {
                var options = this[data.source]();
                 sdata.setClient('options',options);
            }
        }
        if (data.style) {
            sdata.setStyle(data.style);
        }
        return sdata;
    },

    getContentPane : function(){
        return this.mainPane;
    },


    getDataValue : function(sdata){
        if(sdata && sdata.inputIndex){
            var id = sdata.inputIndex;
            var inputType = sdata.inputType;
//            if(inputType && inputType.toLowerCase().indexOf('input') < 0){
//                if(inputType.toLowerCase().indexOf('select') >= 0){
//
//                }else if(inputType.toLowerCase().indexOf('checkbox') >= 0){
//
//                }
//            }else{
                var value = $('#'+id).val();
                sdata.setValue(value);
//            }
            if(sdata.toString()){
                return sdata.toString();
            }
        }
        return '';
    },

    getInputValues : function(){
        if(!this._ids) return;
        var contents = [];
        for(var i = 0 ; i < this._ids.length ; i++){
            var data = this._ids[i];
            var obj =  this.getDataValue(data);
            if(obj){
                contents.push(obj);
            }
        }
        return contents;
    },

    getInputHtmlById : function(sid){
        return this.inputMap[this.className + '_' + sid];
    },

    doClick : function(){
        var values = this.getInputValues();
        if(this.doClickFunction){
            this.doClickFunction(values);
        }
    },

    /**
     * 扩展，有可能存在特殊的情况
     */
    clearInputByData : function(id,data){

    },

    clearInput : function(){
        if(!this._ids) return;
        for(var i = 0 ; i < this._ids.length ; i++){
            var data = this._ids[i];
            if(data && data.inputIndex){
                var id = data.inputIndex;
                this.clearInputByData(id,data);
                if(!data || !data.inputType || data.inputType.toLowerCase().indexOf('input') >=0 ){
                    $('#'+id).val('');
                }else{
                    $('#'+id).val('');
                }
            }
        }
    },

    doClear : function(){
        this.clearInput();
        if(this.doClearFunction){
            this.doClearFunction();
        }
    }

});

it.ITSearchPanel = function(){
    it.BasePanel.call(this);
    this.init();
};

mono.extend(it.ITSearchPanel,it.BasePanel,{

    init:function(){
        var sdata = new it.SData('it_key_text',null,null,'请输入编号'); //inputIndex,inputType,label,placeholder
        sdata.setKey('id');
        sdata.setStyle('background: url("./css/images/insidesearch.svg") no-repeat scroll right center;background-position-x: 98%;');
        this.addQuick(sdata);

        sdata = new it.SData('txt_location','select','位置');
        sdata.setKey('location');
        sdata.setIsClient(true);
        var options = ['','上海数据中心','生产楼','一楼'];
        sdata.setClient('options',options);
        this.addRow(sdata);

        sdata = new it.SData('txt_type','select','设备类型');
        sdata.setKey('userId');
        sdata.setIsClient(false);
        var options = ['','机柜1','思科设备1','华为交换机'];
        sdata.setClient('options',options);
        this.addRow(sdata);

        sdata = new it.SData('txt_model','input','型号');
        sdata.setKey('model');
        sdata.setIsClient(true);
        this.addRow(sdata);

        sdata = new it.SData('txt_manu','input','厂家');
        sdata.setKey('userId');
        sdata.setIsClient(true);
        this.addRow(sdata);

        sdata = new it.SData('txt_Type','input','安装日期');
        sdata.setKey('userId');
        sdata.setIsClient(true);
        this.addRow(sdata);

//        sdata = new it.SData('test_id001','input','userId');
//        sdata.setKey('userId');
//        sdata.setIsClient(true);
//        sdata.setOperation('like');
//        this.addRow(sdata);
//        sdata = new it.SData('test_id002','select','制造商');
//        sdata.setKey('制造商');
//        sdata.setIsClient(true);
//        sdata.setOperation('like');
//        var options = ['','A','B','C'];
//        sdata.setClient('options',options);

        this.addRow(sdata);
        this.addButtonRow();
    },

    /***
     * 创建特别的样式，类似select下拉框
     * @param data
     * @returns {*}
     */
    createInput : function(data){
        if (data && data.inputType) {
            var inputType = data.inputType;
            var inputId = data.inputIndex;
            if (inputType.toLowerCase().indexOf('select') >= 0) {
                var select = $('<select id="' + inputId + '" class="input-min contral-width"></select>');
                var options = data.getClient('options');
                if (options && options.length > 0) {
                    for (var i = 0; i < options.length; i++) {
                        var value = options[i];
                        var option = $('<option value="' + value + '" class="input-min">'+value+'</option>');
                        select.append(option);
                    }
                }
                this.inputMap[inputId] = select;
                return select;
            }
        }
        return this.constructor.superClass.createInput(data);
    }
});

it.SpaceSearchPanel = function(){
    it.BasePanel.call(this);
    this.className = 'SpaceSearchPanel';
    this.init();
};

mono.extend(it.SpaceSearchPanel,it.BasePanel,{

    init:function(){
        var sdata = new it.SData('U_ID','input','U数');
        sdata.setKey('dyna_user_data_maxSerSpace');
        sdata.setIsClient(true);
        sdata.setOperation('>=');
        sdata.setDataType('number');
        this.addRow(sdata);
        this.addButtonRow();
    },

    getUNumber : function(){
        return $('#' + this.className + '_U_ID').val();
    }

});
/*globals jQuery, define, exports, require, window, document, postMessage */
(function (factory) {
//	"use strict";
	if (typeof define === 'function' && define.amd) {
		define(['jquery'], factory);
	}
	else if(typeof exports === 'object') {
		factory(require('jquery'));
	}
	else {
		factory(jQuery);
	}
}(function ($, undefined) {
//	"use strict";
/*!
 * jsTree 3.1.1
 * http://jstree.com/
 *
 * Copyright (c) 2014 Ivan Bozhanov (http://vakata.com)
 *
 * Licensed same as jquery - under the terms of the MIT License
 *   http://www.opensource.org/licenses/mit-license.php
 */
/*!
 * if using jslint please allow for the jQuery global and use following options:
 * jslint: browser: true, ass: true, bitwise: true, continue: true, nomen: true, plusplus: true, regexp: true, unparam: true, todo: true, white: true
 */

	// prevent another load? maybe there is a better way?
	if($.jstree) {
		return;
	}

	/**
	 * ### jsTree core functionality
	 */

	// internal variables
	var instance_counter = 0,
		ccp_node = false,
		ccp_mode = false,
		ccp_inst = false,
		themes_loaded = [],
		src = $('script:last').attr('src'),
		document = window.document, // local variable is always faster to access then a global
		_node = document.createElement('LI'), _temp1, _temp2;

	_node.setAttribute('role', 'treeitem');
	_temp1 = document.createElement('I');
	_temp1.className = 'jstree-icon jstree-ocl';
	_temp1.setAttribute('role', 'presentation');
	_node.appendChild(_temp1);
	_temp1 = document.createElement('A');
	_temp1.className = 'jstree-anchor';
	_temp1.setAttribute('href','#');
	_temp1.setAttribute('tabindex','-1');
	_temp2 = document.createElement('I');
	_temp2.className = 'jstree-icon jstree-themeicon';
	_temp2.setAttribute('role', 'presentation');
	_temp1.appendChild(_temp2);
	_node.appendChild(_temp1);
	_temp1 = _temp2 = null;


	/**
	 * holds all jstree related functions and variables, including the actual class and methods to create, access and manipulate instances.
	 * @name $.jstree
	 */
	$.jstree = {
		/**
		 * specifies the jstree version in use
		 * @name $.jstree.version
		 */
		version : '3.1.1',
		/**
		 * holds all the default options used when creating new instances
		 * @name $.jstree.defaults
		 */
		defaults : {
			/**
			 * configure which plugins will be active on an instance. Should be an array of strings, where each element is a plugin name. The default is `[]`
			 * @name $.jstree.defaults.plugins
			 */
			plugins : []
		},
		/**
		 * stores all loaded jstree plugins (used internally)
		 * @name $.jstree.plugins
		 */
		plugins : {},
		path : src && src.indexOf('/') !== -1 ? src.replace(/\/[^\/]+$/,'') : '',
		idregex : /[\\:&!^|()\[\]<>@*'+~#";.,=\- \/${}%?`]/g
	};
	/**
	 * creates a jstree instance
	 * @name $.jstree.create(el [, options])
	 * @param {DOMElement|jQuery|String} el the element to create the instance on, can be jQuery extended or a selector
	 * @param {Object} options options for this instance (extends `$.jstree.defaults`)
	 * @return {jsTree} the new instance
	 */
	$.jstree.create = function (el, options) {
		var tmp = new $.jstree.core(++instance_counter),
			opt = options;
		options = $.extend(true, {}, $.jstree.defaults, options);
		if(opt && opt.plugins) {
			options.plugins = opt.plugins;
		}
		$.each(options.plugins, function (i, k) {
			if(i !== 'core') {
				tmp = tmp.plugin(k, options[k]);
			}
		});
		$(el).data('jstree', tmp);
		tmp.init(el, options);
		return tmp;
	};
	/**
	 * remove all traces of jstree from the DOM and destroy all instances
	 * @name $.jstree.destroy()
	 */
	$.jstree.destroy = function () {
		$('.jstree:jstree').jstree('destroy');
		$(document).off('.jstree');
	};
	/**
	 * the jstree class constructor, used only internally
	 * @private
	 * @name $.jstree.core(id)
	 * @param {Number} id this instance's index
	 */
	$.jstree.core = function (id) {
		this._id = id;
		this._cnt = 0;
		this._wrk = null;
		this._data = {
			core : {
				themes : {
					name : false,
					dots : false,
					icons : false
				},
				selected : [],
				last_error : {},
				working : false,
				worker_queue : [],
				focused : null
			}
		};
	};
	/**
	 * get a reference to an existing instance
	 *
	 * __Examples__
	 *
	 *	// provided a container with an ID of "tree", and a nested node with an ID of "branch"
	 *	// all of there will return the same instance
	 *	$.jstree.reference('tree');
	 *	$.jstree.reference('#tree');
	 *	$.jstree.reference($('#tree'));
	 *	$.jstree.reference(document.getElementByID('tree'));
	 *	$.jstree.reference('branch');
	 *	$.jstree.reference('#branch');
	 *	$.jstree.reference($('#branch'));
	 *	$.jstree.reference(document.getElementByID('branch'));
	 *
	 * @name $.jstree.reference(needle)
	 * @param {DOMElement|jQuery|String} needle
	 * @return {jsTree|null} the instance or `null` if not found
	 */
	$.jstree.reference = function (needle) {
		var tmp = null,
			obj = null;
		if(needle && needle.id && (!needle.tagName || !needle.nodeType)) { needle = needle.id; }

		if(!obj || !obj.length) {
			try { obj = $(needle); } catch (ignore) { }
		}
		if(!obj || !obj.length) {
			try { obj = $('#' + needle.replace($.jstree.idregex,'\\$&')); } catch (ignore) { }
		}
		if(obj && obj.length && (obj = obj.closest('.jstree')).length && (obj = obj.data('jstree'))) {
			tmp = obj;
		}
		else {
			$('.jstree').each(function () {
				var inst = $(this).data('jstree');
				if(inst && inst._model.data[needle]) {
					tmp = inst;
					return false;
				}
			});
		}
		return tmp;
	};
	/**
	 * Create an instance, get an instance or invoke a command on a instance.
	 *
	 * If there is no instance associated with the current node a new one is created and `arg` is used to extend `$.jstree.defaults` for this new instance. There would be no return value (chaining is not broken).
	 *
	 * If there is an existing instance and `arg` is a string the command specified by `arg` is executed on the instance, with any additional arguments passed to the function. If the function returns a value it will be returned (chaining could break depending on function).
	 *
	 * If there is an existing instance and `arg` is not a string the instance itself is returned (similar to `$.jstree.reference`).
	 *
	 * In any other case - nothing is returned and chaining is not broken.
	 *
	 * __Examples__
	 *
	 *	$('#tree1').jstree(); // creates an instance
	 *	$('#tree2').jstree({ plugins : [] }); // create an instance with some options
	 *	$('#tree1').jstree('open_node', '#branch_1'); // call a method on an existing instance, passing additional arguments
	 *	$('#tree2').jstree(); // get an existing instance (or create an instance)
	 *	$('#tree2').jstree(true); // get an existing instance (will not create new instance)
	 *	$('#branch_1').jstree().select_node('#branch_1'); // get an instance (using a nested element and call a method)
	 *
	 * @name $().jstree([arg])
	 * @param {String|Object} arg
	 * @return {Mixed}
	 */
	$.fn.jstree = function (arg) {
		// check for string argument
		var is_method	= (typeof arg === 'string'),
			args		= Array.prototype.slice.call(arguments, 1),
			result		= null;
		if(arg === true && !this.length) { return false; }
		this.each(function () {
			// get the instance (if there is one) and method (if it exists)
			var instance = $.jstree.reference(this),
				method = is_method && instance ? instance[arg] : null;
			// if calling a method, and method is available - execute on the instance
			result = is_method && method ?
				method.apply(instance, args) :
				null;
			// if there is no instance and no method is being called - create one
			if(!instance && !is_method && (arg === undefined || $.isPlainObject(arg))) {
				$.jstree.create(this, arg);
			}
			// if there is an instance and no method is called - return the instance
			if( (instance && !is_method) || arg === true ) {
				result = instance || false;
			}
			// if there was a method call which returned a result - break and return the value
			if(result !== null && result !== undefined) {
				return false;
			}
		});
		// if there was a method call with a valid return value - return that, otherwise continue the chain
		return result !== null && result !== undefined ?
			result : this;
	};
	/**
	 * used to find elements containing an instance
	 *
	 * __Examples__
	 *
	 *	$('div:jstree').each(function () {
	 *		$(this).jstree('destroy');
	 *	});
	 *
	 * @name $(':jstree')
	 * @return {jQuery}
	 */
	$.expr[':'].jstree = $.expr.createPseudo(function(search) {
		return function(a) {
			return $(a).hasClass('jstree') &&
				$(a).data('jstree') !== undefined;
		};
	});

	/**
	 * stores all defaults for the core
	 * @name $.jstree.defaults.core
	 */
	$.jstree.defaults.core = {
		/**
		 * data configuration
		 *
		 * If left as `false` the HTML inside the jstree container element is used to populate the tree (that should be an unordered list with list items).
		 *
		 * You can also pass in a HTML string or a JSON array here.
		 *
		 * It is possible to pass in a standard jQuery-like AJAX config and jstree will automatically determine if the response is JSON or HTML and use that to populate the tree.
		 * In addition to the standard jQuery ajax options here you can suppy functions for `data` and `url`, the functions will be run in the current instance's scope and a param will be passed indicating which node is being loaded, the return value of those functions will be used.
		 *
		 * The last option is to specify a function, that function will receive the node being loaded as argument and a second param which is a function which should be called with the result.
		 *
		 * __Examples__
		 *
		 *	// AJAX
		 *	$('#tree').jstree({
		 *		'core' : {
		 *			'data' : {
		 *				'url' : '/get/children/',
		 *				'data' : function (node) {
		 *					return { 'id' : node.id };
		 *				}
		 *			}
		 *		});
		 *
		 *	// direct data
		 *	$('#tree').jstree({
		 *		'core' : {
		 *			'data' : [
		 *				'Simple root node',
		 *				{
		 *					'id' : 'node_2',
		 *					'text' : 'Root node with options',
		 *					'state' : { 'opened' : true, 'selected' : true },
		 *					'children' : [ { 'text' : 'Child 1' }, 'Child 2']
		 *				}
		 *			]
		 *		});
		 *
		 *	// function
		 *	$('#tree').jstree({
		 *		'core' : {
		 *			'data' : function (obj, callback) {
		 *				callback.call(this, ['Root 1', 'Root 2']);
		 *			}
		 *		});
		 *
		 * @name $.jstree.defaults.core.data
		 */
		data			: false,
		/**
		 * configure the various strings used throughout the tree
		 *
		 * You can use an object where the key is the string you need to replace and the value is your replacement.
		 * Another option is to specify a function which will be called with an argument of the needed string and should return the replacement.
		 * If left as `false` no replacement is made.
		 *
		 * __Examples__
		 *
		 *	$('#tree').jstree({
		 *		'core' : {
		 *			'strings' : {
		 *				'Loading ...' : 'Please wait ...'
		 *			}
		 *		}
		 *	});
		 *
		 * @name $.jstree.defaults.core.strings
		 */
		strings			: false,
		/**
		 * determines what happens when a user tries to modify the structure of the tree
		 * If left as `false` all operations like create, rename, delete, move or copy are prevented.
		 * You can set this to `true` to allow all interactions or use a function to have better control.
		 *
		 * __Examples__
		 *
		 *	$('#tree').jstree({
		 *		'core' : {
		 *			'check_callback' : function (operation, node, node_parent, node_position, more) {
		 *				// operation can be 'create_node', 'rename_node', 'delete_node', 'move_node' or 'copy_node'
		 *				// in case of 'rename_node' node_position is filled with the new node name
		 *				return operation === 'rename_node' ? true : false;
		 *			}
		 *		}
		 *	});
		 *
		 * @name $.jstree.defaults.core.check_callback
		 */
		check_callback	: false,
		/**
		 * a callback called with a single object parameter in the instance's scope when something goes wrong (operation prevented, ajax failed, etc)
		 * @name $.jstree.defaults.core.error
		 */
		error			: $.noop,
		/**
		 * the open / close animation duration in milliseconds - set this to `false` to disable the animation (default is `200`)
		 * @name $.jstree.defaults.core.animation
		 */
		animation		: 200,
		/**
		 * a boolean indicating if multiple nodes can be selected
		 * @name $.jstree.defaults.core.multiple
		 */
		multiple		: true,
		/**
		 * theme configuration object
		 * @name $.jstree.defaults.core.themes
		 */
		themes			: {
			/**
			 * the name of the theme to use (if left as `false` the default theme is used)
			 * @name $.jstree.defaults.core.themes.name
			 */
			name			: false,
			/**
			 * the URL of the theme's CSS file, leave this as `false` if you have manually included the theme CSS (recommended). You can set this to `true` too which will try to autoload the theme.
			 * @name $.jstree.defaults.core.themes.url
			 */
			url				: false,
			/**
			 * the location of all jstree themes - only used if `url` is set to `true`
			 * @name $.jstree.defaults.core.themes.dir
			 */
			dir				: false,
			/**
			 * a boolean indicating if connecting dots are shown
			 * @name $.jstree.defaults.core.themes.dots
			 */
			dots			: true,
			/**
			 * a boolean indicating if node icons are shown
			 * @name $.jstree.defaults.core.themes.icons
			 */
			icons			: true,
			/**
			 * a boolean indicating if the tree background is striped
			 * @name $.jstree.defaults.core.themes.stripes
			 */
			stripes			: false,
			/**
			 * a string (or boolean `false`) specifying the theme variant to use (if the theme supports variants)
			 * @name $.jstree.defaults.core.themes.variant
			 */
			variant			: false,
			/**
			 * a boolean specifying if a reponsive version of the theme should kick in on smaller screens (if the theme supports it). Defaults to `false`.
			 * @name $.jstree.defaults.core.themes.responsive
			 */
			responsive		: false
		},
		/**
		 * if left as `true` all parents of all selected nodes will be opened once the tree loads (so that all selected nodes are visible to the user)
		 * @name $.jstree.defaults.core.expand_selected_onload
		 */
		expand_selected_onload : true,
		/**
		 * if left as `true` web workers will be used to parse incoming JSON data where possible, so that the UI will not be blocked by large requests. Workers are however about 30% slower. Defaults to `true`
		 * @name $.jstree.defaults.core.worker
		 */
		worker : true,
		/**
		 * Force node text to plain text (and escape HTML). Defaults to `false`
		 * @name $.jstree.defaults.core.force_text
		 */
		force_text : false,
		/**
		 * Should the node should be toggled if the text is double clicked . Defaults to `true`
		 * @name $.jstree.defaults.core.dblclick_toggle
		 */
		dblclick_toggle : true
	};
	$.jstree.core.prototype = {
		/**
		 * used to decorate an instance with a plugin. Used internally.
		 * @private
		 * @name plugin(deco [, opts])
		 * @param  {String} deco the plugin to decorate with
		 * @param  {Object} opts options for the plugin
		 * @return {jsTree}
		 */
		plugin : function (deco, opts) {
			var Child = $.jstree.plugins[deco];
			if(Child) {
				this._data[deco] = {};
				Child.prototype = this;
				return new Child(opts, this);
			}
			return this;
		},
		/**
		 * initialize the instance. Used internally.
		 * @private
		 * @name init(el, optons)
		 * @param {DOMElement|jQuery|String} el the element we are transforming
		 * @param {Object} options options for this instance
		 * @trigger init.jstree, loading.jstree, loaded.jstree, ready.jstree, changed.jstree
		 */
		init : function (el, options) {
			this._model = {
				data : {
					'#' : {
						id : '#',
						parent : null,
						parents : [],
						children : [],
						children_d : [],
						state : { loaded : false }
					}
				},
				changed : [],
				force_full_redraw : false,
				redraw_timeout : false,
				default_state : {
					loaded : true,
					opened : false,
					selected : false,
					disabled : false
				}
			};

			this.element = $(el).addClass('jstree jstree-' + this._id);
			this.settings = options;

			this._data.core.ready = false;
			this._data.core.loaded = false;
			this._data.core.rtl = (this.element.css("direction") === "rtl");
			this.element[this._data.core.rtl ? 'addClass' : 'removeClass']("jstree-rtl");
			this.element.attr('role','tree');
			if(this.settings.core.multiple) {
				this.element.attr('aria-multiselectable', true);
			}
			if(!this.element.attr('tabindex')) {
				this.element.attr('tabindex','0');
			}

			this.bind();
			/**
			 * triggered after all events are bound
			 * @event
			 * @name init.jstree
			 */
			this.trigger("init");

			this._data.core.original_container_html = this.element.find(" > ul > li").clone(true);
			this._data.core.original_container_html
				.find("li").addBack()
				.contents().filter(function() {
					return this.nodeType === 3 && (!this.nodeValue || /^\s+$/.test(this.nodeValue));
				})
				.remove();
			this.element.html("<"+"ul class='jstree-container-ul jstree-children' role='group'><"+"li id='j"+this._id+"_loading' class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='tree-item'><i class='jstree-icon jstree-ocl'></i><"+"a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'></i>" + this.get_string("Loading ...") + "</a></li></ul>");
			this.element.attr('aria-activedescendant','j' + this._id + '_loading');
			this._data.core.li_height = this.get_container_ul().children("li").first().height() || 24;
			/**
			 * triggered after the loading text is shown and before loading starts
			 * @event
			 * @name loading.jstree
			 */
			this.trigger("loading");
			this.load_node('#');
		},
		/**
		 * destroy an instance
		 * @name destroy()
		 * @param  {Boolean} keep_html if not set to `true` the container will be emptied, otherwise the current DOM elements will be kept intact
		 */
		destroy : function (keep_html) {
			if(this._wrk) {
				try {
					window.URL.revokeObjectURL(this._wrk);
					this._wrk = null;
				}
				catch (ignore) { }
			}
			if(!keep_html) { this.element.empty(); }
			this.teardown();
		},
		/**
		 * part of the destroying of an instance. Used internally.
		 * @private
		 * @name teardown()
		 */
		teardown : function () {
			this.unbind();
			this.element
				.removeClass('jstree')
				.removeData('jstree')
				.find("[class^='jstree']")
					.addBack()
					.attr("class", function () { return this.className.replace(/jstree[^ ]*|$/ig,''); });
			this.element = null;
		},
		/**
		 * bind all events. Used internally.
		 * @private
		 * @name bind()
		 */
		bind : function () {
			var word = '',
				tout = null,
				was_click = 0;
			this.element
				.on("dblclick.jstree", function () {
						if(document.selection && document.selection.empty) {
							document.selection.empty();
						}
						else {
							if(window.getSelection) {
								var sel = window.getSelection();
								try {
									sel.removeAllRanges();
									sel.collapse();
								} catch (ignore) { }
							}
						}
					})
				.on("mousedown.jstree", $.proxy(function (e) {
						if(e.target === this.element[0]) {
							e.preventDefault(); // prevent losing focus when clicking scroll arrows (FF, Chrome)
							was_click = +(new Date()); // ie does not allow to prevent losing focus
						}
					}, this))
				.on("mousedown.jstree", ".jstree-ocl", function (e) {
						e.preventDefault(); // prevent any node inside from losing focus when clicking the open/close icon
					})
				.on("click.jstree", ".jstree-ocl", $.proxy(function (e) {
						this.toggle_node(e.target);
					}, this))
				.on("dblclick.jstree", ".jstree-anchor", $.proxy(function (e) {
						if(this.settings.core.dblclick_toggle) {
							this.toggle_node(e.target);
						}
					}, this))
				.on("click.jstree", ".jstree-anchor", $.proxy(function (e) {
						e.preventDefault();
						if(e.currentTarget !== document.activeElement) { $(e.currentTarget).focus(); }
						this.activate_node(e.currentTarget, e);
					}, this))
				.on('keydown.jstree', '.jstree-anchor', $.proxy(function (e) {
						if(e.target.tagName === "INPUT") { return true; }
						if(e.which !== 32 && e.which !== 13 && (e.shiftKey || e.ctrlKey || e.altKey || e.metaKey)) { return true; }
						var o = null;
						if(this._data.core.rtl) {
							if(e.which === 37) { e.which = 39; }
							else if(e.which === 39) { e.which = 37; }
						}
						switch(e.which) {
							case 32: // aria defines space only with Ctrl
								if(e.ctrlKey) {
									e.type = "click";
									$(e.currentTarget).trigger(e);
								}
								break;
							case 13: // enter
								e.type = "click";
								$(e.currentTarget).trigger(e);
								break;
							case 37: // right
								e.preventDefault();
								if(this.is_open(e.currentTarget)) {
									this.close_node(e.currentTarget);
								}
								else {
									o = this.get_parent(e.currentTarget);
									if(o && o.id !== '#') { this.get_node(o, true).children('.jstree-anchor').focus(); }
								}
								break;
							case 38: // up
								e.preventDefault();
								o = this.get_prev_dom(e.currentTarget);
								if(o && o.length) { o.children('.jstree-anchor').focus(); }
								break;
							case 39: // left
								e.preventDefault();
								if(this.is_closed(e.currentTarget)) {
									this.open_node(e.currentTarget, function (o) { this.get_node(o, true).children('.jstree-anchor').focus(); });
								}
								else if (this.is_open(e.currentTarget)) {
									o = this.get_node(e.currentTarget, true).children('.jstree-children')[0];
									if(o) { $(this._firstChild(o)).children('.jstree-anchor').focus(); }
								}
								break;
							case 40: // down
								e.preventDefault();
								o = this.get_next_dom(e.currentTarget);
								if(o && o.length) { o.children('.jstree-anchor').focus(); }
								break;
							case 106: // aria defines * on numpad as open_all - not very common
								this.open_all();
								break;
							case 36: // home
								e.preventDefault();
								o = this._firstChild(this.get_container_ul()[0]);
								if(o) { $(o).children('.jstree-anchor').filter(':visible').focus(); }
								break;
							case 35: // end
								e.preventDefault();
								this.element.find('.jstree-anchor').filter(':visible').last().focus();
								break;
							/*
							// delete
							case 46:
								e.preventDefault();
								o = this.get_node(e.currentTarget);
								if(o && o.id && o.id !== '#') {
									o = this.is_selected(o) ? this.get_selected() : o;
									this.delete_node(o);
								}
								break;
							// f2
							case 113:
								e.preventDefault();
								o = this.get_node(e.currentTarget);
								if(o && o.id && o.id !== '#') {
									// this.edit(o);
								}
								break;
							default:
								// console.log(e.which);
								break;
							*/
						}
					}, this))
				.on("load_node.jstree", $.proxy(function (e, data) {
						if(data.status) {
							if(data.node.id === '#' && !this._data.core.loaded) {
								this._data.core.loaded = true;
								if(this._firstChild(this.get_container_ul()[0])) {
									this.element.attr('aria-activedescendant',this._firstChild(this.get_container_ul()[0]).id);
								}
								/**
								 * triggered after the root node is loaded for the first time
								 * @event
								 * @name loaded.jstree
								 */
								this.trigger("loaded");
							}
							if(!this._data.core.ready) {
								setTimeout($.proxy(function() {
									if(this.element && !this.get_container_ul().find('.jstree-loading').length) {
										this._data.core.ready = true;
										if(this._data.core.selected.length) {
											if(this.settings.core.expand_selected_onload) {
												var tmp = [], i, j;
												for(i = 0, j = this._data.core.selected.length; i < j; i++) {
													tmp = tmp.concat(this._model.data[this._data.core.selected[i]].parents);
												}
												tmp = $.vakata.array_unique(tmp);
												for(i = 0, j = tmp.length; i < j; i++) {
													this.open_node(tmp[i], false, 0);
												}
											}
											this.trigger('changed', { 'action' : 'ready', 'selected' : this._data.core.selected });
										}
										/**
										 * triggered after all nodes are finished loading
										 * @event
										 * @name ready.jstree
										 */
										this.trigger("ready");
									}
								}, this), 0);
							}
						}
					}, this))
				// quick searching when the tree is focused
				.on('keypress.jstree', $.proxy(function (e) {
						if(e.target.tagName === "INPUT") { return true; }
						if(tout) { clearTimeout(tout); }
						tout = setTimeout(function () {
							word = '';
						}, 500);

						var chr = String.fromCharCode(e.which).toLowerCase(),
							col = this.element.find('.jstree-anchor').filter(':visible'),
							ind = col.index(document.activeElement) || 0,
							end = false;
						word += chr;

						// match for whole word from current node down (including the current node)
						if(word.length > 1) {
							col.slice(ind).each($.proxy(function (i, v) {
								if($(v).text().toLowerCase().indexOf(word) === 0) {
									$(v).focus();
									end = true;
									return false;
								}
							}, this));
							if(end) { return; }

							// match for whole word from the beginning of the tree
							col.slice(0, ind).each($.proxy(function (i, v) {
								if($(v).text().toLowerCase().indexOf(word) === 0) {
									$(v).focus();
									end = true;
									return false;
								}
							}, this));
							if(end) { return; }
						}
						// list nodes that start with that letter (only if word consists of a single char)
						if(new RegExp('^' + chr + '+$').test(word)) {
							// search for the next node starting with that letter
							col.slice(ind + 1).each($.proxy(function (i, v) {
								if($(v).text().toLowerCase().charAt(0) === chr) {
									$(v).focus();
									end = true;
									return false;
								}
							}, this));
							if(end) { return; }

							// search from the beginning
							col.slice(0, ind + 1).each($.proxy(function (i, v) {
								if($(v).text().toLowerCase().charAt(0) === chr) {
									$(v).focus();
									end = true;
									return false;
								}
							}, this));
							if(end) { return; }
						}
					}, this))
				// THEME RELATED
				.on("init.jstree", $.proxy(function () {
						var s = this.settings.core.themes;
						this._data.core.themes.dots			= s.dots;
						this._data.core.themes.stripes		= s.stripes;
						this._data.core.themes.icons		= s.icons;
						this.set_theme(s.name || "default", s.url);
						this.set_theme_variant(s.variant);
					}, this))
				.on("loading.jstree", $.proxy(function () {
						this[ this._data.core.themes.dots ? "show_dots" : "hide_dots" ]();
						this[ this._data.core.themes.icons ? "show_icons" : "hide_icons" ]();
						this[ this._data.core.themes.stripes ? "show_stripes" : "hide_stripes" ]();
					}, this))
				.on('blur.jstree', '.jstree-anchor', $.proxy(function (e) {
						this._data.core.focused = null;
						$(e.currentTarget).filter('.jstree-hovered').mouseleave();
						this.element.attr('tabindex', '0');
					}, this))
				.on('focus.jstree', '.jstree-anchor', $.proxy(function (e) {
						var tmp = this.get_node(e.currentTarget);
						if(tmp && tmp.id) {
							this._data.core.focused = tmp.id;
						}
						this.element.find('.jstree-hovered').not(e.currentTarget).mouseleave();
						$(e.currentTarget).mouseenter();
						this.element.attr('tabindex', '-1');
					}, this))
				.on('focus.jstree', $.proxy(function () {
						if(+(new Date()) - was_click > 500 && !this._data.core.focused) {
							was_click = 0;
							var act = this.get_node(this.element.attr('aria-activedescendant'), true);
							if(act) {
								act.find('> .jstree-anchor').focus();
							}
						}
					}, this))
				.on('mouseenter.jstree', '.jstree-anchor', $.proxy(function (e) {
						this.hover_node(e.currentTarget);
					}, this))
				.on('mouseleave.jstree', '.jstree-anchor', $.proxy(function (e) {
						this.dehover_node(e.currentTarget);
					}, this));
		},
		/**
		 * part of the destroying of an instance. Used internally.
		 * @private
		 * @name unbind()
		 */
		unbind : function () {
			this.element.off('.jstree');
			$(document).off('.jstree-' + this._id);
		},
		/**
		 * trigger an event. Used internally.
		 * @private
		 * @name trigger(ev [, data])
		 * @param  {String} ev the name of the event to trigger
		 * @param  {Object} data additional data to pass with the event
		 */
		trigger : function (ev, data) {
			if(!data) {
				data = {};
			}
			data.instance = this;
			this.element.triggerHandler(ev.replace('.jstree','') + '.jstree', data);
		},
		/**
		 * returns the jQuery extended instance container
		 * @name get_container()
		 * @return {jQuery}
		 */
		get_container : function () {
			return this.element;
		},
		/**
		 * returns the jQuery extended main UL node inside the instance container. Used internally.
		 * @private
		 * @name get_container_ul()
		 * @return {jQuery}
		 */
		get_container_ul : function () {
			return this.element.children(".jstree-children").first();
		},
		/**
		 * gets string replacements (localization). Used internally.
		 * @private
		 * @name get_string(key)
		 * @param  {String} key
		 * @return {String}
		 */
		get_string : function (key) {
			var a = this.settings.core.strings;
			if($.isFunction(a)) { return a.call(this, key); }
			if(a && a[key]) { return a[key]; }
			return key;
		},
		/**
		 * gets the first child of a DOM node. Used internally.
		 * @private
		 * @name _firstChild(dom)
		 * @param  {DOMElement} dom
		 * @return {DOMElement}
		 */
		_firstChild : function (dom) {
			dom = dom ? dom.firstChild : null;
			while(dom !== null && dom.nodeType !== 1) {
				dom = dom.nextSibling;
			}
			return dom;
		},
		/**
		 * gets the next sibling of a DOM node. Used internally.
		 * @private
		 * @name _nextSibling(dom)
		 * @param  {DOMElement} dom
		 * @return {DOMElement}
		 */
		_nextSibling : function (dom) {
			dom = dom ? dom.nextSibling : null;
			while(dom !== null && dom.nodeType !== 1) {
				dom = dom.nextSibling;
			}
			return dom;
		},
		/**
		 * gets the previous sibling of a DOM node. Used internally.
		 * @private
		 * @name _previousSibling(dom)
		 * @param  {DOMElement} dom
		 * @return {DOMElement}
		 */
		_previousSibling : function (dom) {
			dom = dom ? dom.previousSibling : null;
			while(dom !== null && dom.nodeType !== 1) {
				dom = dom.previousSibling;
			}
			return dom;
		},
		/**
		 * get the JSON representation of a node (or the actual jQuery extended DOM node) by using any input (child DOM element, ID string, selector, etc)
		 * @name get_node(obj [, as_dom])
		 * @param  {mixed} obj
		 * @param  {Boolean} as_dom
		 * @return {Object|jQuery}
		 */
		get_node : function (obj, as_dom) {
			if(obj && obj.id) {
				obj = obj.id;
			}
			var dom;
			try {
				if(this._model.data[obj]) {
					obj = this._model.data[obj];
				}
				else if(typeof obj === "string" && this._model.data[obj.replace(/^#/, '')]) {
					obj = this._model.data[obj.replace(/^#/, '')];
				}
				else if(typeof obj === "string" && (dom = $('#' + obj.replace($.jstree.idregex,'\\$&'), this.element)).length && this._model.data[dom.closest('.jstree-node').attr('id')]) {
					obj = this._model.data[dom.closest('.jstree-node').attr('id')];
				}
				else if((dom = $(obj, this.element)).length && this._model.data[dom.closest('.jstree-node').attr('id')]) {
					obj = this._model.data[dom.closest('.jstree-node').attr('id')];
				}
				else if((dom = $(obj, this.element)).length && dom.hasClass('jstree')) {
					obj = this._model.data['#'];
				}
				else {
					return false;
				}

				if(as_dom) {
					obj = obj.id === '#' ? this.element : $('#' + obj.id.replace($.jstree.idregex,'\\$&'), this.element);
				}
				return obj;
			} catch (ex) { return false; }
		},
		/**
		 * get the path to a node, either consisting of node texts, or of node IDs, optionally glued together (otherwise an array)
		 * @name get_path(obj [, glue, ids])
		 * @param  {mixed} obj the node
		 * @param  {String} glue if you want the path as a string - pass the glue here (for example '/'), if a falsy value is supplied here, an array is returned
		 * @param  {Boolean} ids if set to true build the path using ID, otherwise node text is used
		 * @return {mixed}
		 */
		get_path : function (obj, glue, ids) {
			obj = obj.parents ? obj : this.get_node(obj);
			if(!obj || obj.id === '#' || !obj.parents) {
				return false;
			}
			var i, j, p = [];
			p.push(ids ? obj.id : obj.text);
			for(i = 0, j = obj.parents.length; i < j; i++) {
				p.push(ids ? obj.parents[i] : this.get_text(obj.parents[i]));
			}
			p = p.reverse().slice(1);
			return glue ? p.join(glue) : p;
		},
		/**
		 * get the next visible node that is below the `obj` node. If `strict` is set to `true` only sibling nodes are returned.
		 * @name get_next_dom(obj [, strict])
		 * @param  {mixed} obj
		 * @param  {Boolean} strict
		 * @return {jQuery}
		 */
		get_next_dom : function (obj, strict) {
			var tmp;
			obj = this.get_node(obj, true);
			if(obj[0] === this.element[0]) {
				tmp = this._firstChild(this.get_container_ul()[0]);
				while (tmp && tmp.offsetHeight === 0) {
					tmp = this._nextSibling(tmp);
				}
				return tmp ? $(tmp) : false;
			}
			if(!obj || !obj.length) {
				return false;
			}
			if(strict) {
				tmp = obj[0];
				do {
					tmp = this._nextSibling(tmp);
				} while (tmp && tmp.offsetHeight === 0);
				return tmp ? $(tmp) : false;
			}
			if(obj.hasClass("jstree-open")) {
				tmp = this._firstChild(obj.children('.jstree-children')[0]);
				while (tmp && tmp.offsetHeight === 0) {
					tmp = this._nextSibling(tmp);
				}
				if(tmp !== null) {
					return $(tmp);
				}
			}
			tmp = obj[0];
			do {
				tmp = this._nextSibling(tmp);
			} while (tmp && tmp.offsetHeight === 0);
			if(tmp !== null) {
				return $(tmp);
			}
			return obj.parentsUntil(".jstree",".jstree-node").nextAll(".jstree-node:visible").first();
		},
		/**
		 * get the previous visible node that is above the `obj` node. If `strict` is set to `true` only sibling nodes are returned.
		 * @name get_prev_dom(obj [, strict])
		 * @param  {mixed} obj
		 * @param  {Boolean} strict
		 * @return {jQuery}
		 */
		get_prev_dom : function (obj, strict) {
			var tmp;
			obj = this.get_node(obj, true);
			if(obj[0] === this.element[0]) {
				tmp = this.get_container_ul()[0].lastChild;
				while (tmp && tmp.offsetHeight === 0) {
					tmp = this._previousSibling(tmp);
				}
				return tmp ? $(tmp) : false;
			}
			if(!obj || !obj.length) {
				return false;
			}
			if(strict) {
				tmp = obj[0];
				do {
					tmp = this._previousSibling(tmp);
				} while (tmp && tmp.offsetHeight === 0);
				return tmp ? $(tmp) : false;
			}
			tmp = obj[0];
			do {
				tmp = this._previousSibling(tmp);
			} while (tmp && tmp.offsetHeight === 0);
			if(tmp !== null) {
				obj = $(tmp);
				while(obj.hasClass("jstree-open")) {
					obj = obj.children(".jstree-children").first().children(".jstree-node:visible:last");
				}
				return obj;
			}
			tmp = obj[0].parentNode.parentNode;
			return tmp && tmp.className && tmp.className.indexOf('jstree-node') !== -1 ? $(tmp) : false;
		},
		/**
		 * get the parent ID of a node
		 * @name get_parent(obj)
		 * @param  {mixed} obj
		 * @return {String}
		 */
		get_parent : function (obj) {
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			return obj.parent;
		},
		/**
		 * get a jQuery collection of all the children of a node (node must be rendered)
		 * @name get_children_dom(obj)
		 * @param  {mixed} obj
		 * @return {jQuery}
		 */
		get_children_dom : function (obj) {
			obj = this.get_node(obj, true);
			if(obj[0] === this.element[0]) {
				return this.get_container_ul().children(".jstree-node");
			}
			if(!obj || !obj.length) {
				return false;
			}
			return obj.children(".jstree-children").children(".jstree-node");
		},
		/**
		 * checks if a node has children
		 * @name is_parent(obj)
		 * @param  {mixed} obj
		 * @return {Boolean}
		 */
		is_parent : function (obj) {
			obj = this.get_node(obj);
			return obj && (obj.state.loaded === false || obj.children.length > 0);
		},
		/**
		 * checks if a node is loaded (its children are available)
		 * @name is_loaded(obj)
		 * @param  {mixed} obj
		 * @return {Boolean}
		 */
		is_loaded : function (obj) {
			obj = this.get_node(obj);
			return obj && obj.state.loaded;
		},
		/**
		 * check if a node is currently loading (fetching children)
		 * @name is_loading(obj)
		 * @param  {mixed} obj
		 * @return {Boolean}
		 */
		is_loading : function (obj) {
			obj = this.get_node(obj);
			return obj && obj.state && obj.state.loading;
		},
		/**
		 * check if a node is opened
		 * @name is_open(obj)
		 * @param  {mixed} obj
		 * @return {Boolean}
		 */
		is_open : function (obj) {
			obj = this.get_node(obj);
			return obj && obj.state.opened;
		},
		/**
		 * check if a node is in a closed state
		 * @name is_closed(obj)
		 * @param  {mixed} obj
		 * @return {Boolean}
		 */
		is_closed : function (obj) {
			obj = this.get_node(obj);
			return obj && this.is_parent(obj) && !obj.state.opened;
		},
		/**
		 * check if a node has no children
		 * @name is_leaf(obj)
		 * @param  {mixed} obj
		 * @return {Boolean}
		 */
		is_leaf : function (obj) {
			return !this.is_parent(obj);
		},
		/**
		 * loads a node (fetches its children using the `core.data` setting). Multiple nodes can be passed to by using an array.
		 * @name load_node(obj [, callback])
		 * @param  {mixed} obj
		 * @param  {function} callback a function to be executed once loading is complete, the function is executed in the instance's scope and receives two arguments - the node and a boolean status
		 * @return {Boolean}
		 * @trigger load_node.jstree
		 */
		load_node : function (obj, callback) {
			var k, l, i, j, c;
			if($.isArray(obj)) {
				this._load_nodes(obj.slice(), callback);
				return true;
			}
			obj = this.get_node(obj);
			if(!obj) {
				if(callback) { callback.call(this, obj, false); }
				return false;
			}
			// if(obj.state.loading) { } // the node is already loading - just wait for it to load and invoke callback? but if called implicitly it should be loaded again?
			if(obj.state.loaded) {
				obj.state.loaded = false;
				for(k = 0, l = obj.children_d.length; k < l; k++) {
					for(i = 0, j = obj.parents.length; i < j; i++) {
						this._model.data[obj.parents[i]].children_d = $.vakata.array_remove_item(this._model.data[obj.parents[i]].children_d, obj.children_d[k]);
					}
					if(this._model.data[obj.children_d[k]].state.selected) {
						c = true;
						this._data.core.selected = $.vakata.array_remove_item(this._data.core.selected, obj.children_d[k]);
					}
					delete this._model.data[obj.children_d[k]];
				}
				obj.children = [];
				obj.children_d = [];
				if(c) {
					this.trigger('changed', { 'action' : 'load_node', 'node' : obj, 'selected' : this._data.core.selected });
				}
			}
			obj.state.failed = false;
			obj.state.loading = true;
			this.get_node(obj, true).addClass("jstree-loading").attr('aria-busy',true);
			this._load_node(obj, $.proxy(function (status) {
				obj = this._model.data[obj.id];
				obj.state.loading = false;
				obj.state.loaded = status;
				obj.state.failed = !obj.state.loaded;
				var dom = this.get_node(obj, true);
				if(obj.state.loaded && !obj.children.length && dom && dom.length && !dom.hasClass('jstree-leaf')) {
					dom.removeClass('jstree-closed jstree-open').addClass('jstree-leaf');
				}
				dom.removeClass("jstree-loading").attr('aria-busy',false);
				/**
				 * triggered after a node is loaded
				 * @event
				 * @name load_node.jstree
				 * @param {Object} node the node that was loading
				 * @param {Boolean} status was the node loaded successfully
				 */
				this.trigger('load_node', { "node" : obj, "status" : status });
				if(callback) {
					callback.call(this, obj, status);
				}
			}, this));
			return true;
		},
		/**
		 * load an array of nodes (will also load unavailable nodes as soon as the appear in the structure). Used internally.
		 * @private
		 * @name _load_nodes(nodes [, callback])
		 * @param  {array} nodes
		 * @param  {function} callback a function to be executed once loading is complete, the function is executed in the instance's scope and receives one argument - the array passed to _load_nodes
		 */
		_load_nodes : function (nodes, callback, is_callback) {
			var r = true,
				c = function () { this._load_nodes(nodes, callback, true); },
				m = this._model.data, i, j, tmp = [];
			for(i = 0, j = nodes.length; i < j; i++) {
				if(m[nodes[i]] && ( (!m[nodes[i]].state.loaded && !m[nodes[i]].state.failed) || !is_callback)) {
					if(!this.is_loading(nodes[i])) {
						this.load_node(nodes[i], c);
					}
					r = false;
				}
			}
			if(r) {
				for(i = 0, j = nodes.length; i < j; i++) {
					if(m[nodes[i]] && m[nodes[i]].state.loaded) {
						tmp.push(nodes[i]);
					}
				}
				if(callback && !callback.done) {
					callback.call(this, tmp);
					callback.done = true;
				}
			}
		},
		/**
		 * loads all unloaded nodes
		 * @name load_all([obj, callback])
		 * @param {mixed} obj the node to load recursively, omit to load all nodes in the tree
		 * @param {function} callback a function to be executed once loading all the nodes is complete,
		 * @trigger load_all.jstree
		 */
		load_all : function (obj, callback) {
			if(!obj) { obj = '#'; }
			obj = this.get_node(obj);
			if(!obj) { return false; }
			var to_load = [],
				m = this._model.data,
				c = m[obj.id].children_d,
				i, j;
			if(obj.state && !obj.state.loaded) {
				to_load.push(obj.id);
			}
			for(i = 0, j = c.length; i < j; i++) {
				if(m[c[i]] && m[c[i]].state && !m[c[i]].state.loaded) {
					to_load.push(c[i]);
				}
			}
			if(to_load.length) {
				this._load_nodes(to_load, function () {
					this.load_all(obj, callback);
				});
			}
			else {
				/**
				 * triggered after a load_all call completes
				 * @event
				 * @name load_all.jstree
				 * @param {Object} node the recursively loaded node
				 */
				if(callback) { callback.call(this, obj); }
				this.trigger('load_all', { "node" : obj });
			}
		},
		/**
		 * handles the actual loading of a node. Used only internally.
		 * @private
		 * @name _load_node(obj [, callback])
		 * @param  {mixed} obj
		 * @param  {function} callback a function to be executed once loading is complete, the function is executed in the instance's scope and receives one argument - a boolean status
		 * @return {Boolean}
		 */
		_load_node : function (obj, callback) {
			var s = this.settings.core.data, t;
			// use original HTML
			if(!s) {
				if(obj.id === '#') {
					return this._append_html_data(obj, this._data.core.original_container_html.clone(true), function (status) {
						callback.call(this, status);
					});
				}
				else {
					return callback.call(this, false);
				}
				// return callback.call(this, obj.id === '#' ? this._append_html_data(obj, this._data.core.original_container_html.clone(true)) : false);
			}
			if($.isFunction(s)) {
				return s.call(this, obj, $.proxy(function (d) {
					if(d === false) {
						callback.call(this, false);
					}
					this[typeof d === 'string' ? '_append_html_data' : '_append_json_data'](obj, typeof d === 'string' ? $($.parseHTML(d)).filter(function () { return this.nodeType !== 3; }) : d, function (status) {
						callback.call(this, status);
					});
					// return d === false ? callback.call(this, false) : callback.call(this, this[typeof d === 'string' ? '_append_html_data' : '_append_json_data'](obj, typeof d === 'string' ? $(d) : d));
				}, this));
			}
			if(typeof s === 'object') {
				if(s.url) {
					s = $.extend(true, {}, s);
					if($.isFunction(s.url)) {
						s.url = s.url.call(this, obj);
					}
					if($.isFunction(s.data)) {
						s.data = s.data.call(this, obj);
					}
					return $.ajax(s)
						.done($.proxy(function (d,t,x) {
								var type = x.getResponseHeader('Content-Type');
								if((type && type.indexOf('json') !== -1) || typeof d === "object") {
									return this._append_json_data(obj, d, function (status) { callback.call(this, status); });
									//return callback.call(this, this._append_json_data(obj, d));
								}
								if((type && type.indexOf('html') !== -1) || typeof d === "string") {
									return this._append_html_data(obj, $($.parseHTML(d)).filter(function () { return this.nodeType !== 3; }), function (status) { callback.call(this, status); });
									// return callback.call(this, this._append_html_data(obj, $(d)));
								}
								this._data.core.last_error = { 'error' : 'ajax', 'plugin' : 'core', 'id' : 'core_04', 'reason' : 'Could not load node', 'data' : JSON.stringify({ 'id' : obj.id, 'xhr' : x }) };
								this.settings.core.error.call(this, this._data.core.last_error);
								return callback.call(this, false);
							}, this))
						.fail($.proxy(function (f) {
								callback.call(this, false);
								this._data.core.last_error = { 'error' : 'ajax', 'plugin' : 'core', 'id' : 'core_04', 'reason' : 'Could not load node', 'data' : JSON.stringify({ 'id' : obj.id, 'xhr' : f }) };
								this.settings.core.error.call(this, this._data.core.last_error);
							}, this));
				}
				t = ($.isArray(s) || $.isPlainObject(s)) ? JSON.parse(JSON.stringify(s)) : s;
				if(obj.id === '#') {
					return this._append_json_data(obj, t, function (status) {
						callback.call(this, status);
					});
				}
				else {
					this._data.core.last_error = { 'error' : 'nodata', 'plugin' : 'core', 'id' : 'core_05', 'reason' : 'Could not load node', 'data' : JSON.stringify({ 'id' : obj.id }) };
					this.settings.core.error.call(this, this._data.core.last_error);
					return callback.call(this, false);
				}
				//return callback.call(this, (obj.id === "#" ? this._append_json_data(obj, t) : false) );
			}
			if(typeof s === 'string') {
				if(obj.id === '#') {
					return this._append_html_data(obj, $($.parseHTML(s)).filter(function () { return this.nodeType !== 3; }), function (status) {
						callback.call(this, status);
					});
				}
				else {
					this._data.core.last_error = { 'error' : 'nodata', 'plugin' : 'core', 'id' : 'core_06', 'reason' : 'Could not load node', 'data' : JSON.stringify({ 'id' : obj.id }) };
					this.settings.core.error.call(this, this._data.core.last_error);
					return callback.call(this, false);
				}
				//return callback.call(this, (obj.id === "#" ? this._append_html_data(obj, $(s)) : false) );
			}
			return callback.call(this, false);
		},
		/**
		 * adds a node to the list of nodes to redraw. Used only internally.
		 * @private
		 * @name _node_changed(obj [, callback])
		 * @param  {mixed} obj
		 */
		_node_changed : function (obj) {
			obj = this.get_node(obj);
			if(obj) {
				this._model.changed.push(obj.id);
			}
		},
		/**
		 * appends HTML content to the tree. Used internally.
		 * @private
		 * @name _append_html_data(obj, data)
		 * @param  {mixed} obj the node to append to
		 * @param  {String} data the HTML string to parse and append
		 * @trigger model.jstree, changed.jstree
		 */
		_append_html_data : function (dom, data, cb) {
			dom = this.get_node(dom);
			dom.children = [];
			dom.children_d = [];
			var dat = data.is('ul') ? data.children() : data,
				par = dom.id,
				chd = [],
				dpc = [],
				m = this._model.data,
				p = m[par],
				s = this._data.core.selected.length,
				tmp, i, j;
			dat.each($.proxy(function (i, v) {
				tmp = this._parse_model_from_html($(v), par, p.parents.concat());
				if(tmp) {
					chd.push(tmp);
					dpc.push(tmp);
					if(m[tmp].children_d.length) {
						dpc = dpc.concat(m[tmp].children_d);
					}
				}
			}, this));
			p.children = chd;
			p.children_d = dpc;
			for(i = 0, j = p.parents.length; i < j; i++) {
				m[p.parents[i]].children_d = m[p.parents[i]].children_d.concat(dpc);
			}
			/**
			 * triggered when new data is inserted to the tree model
			 * @event
			 * @name model.jstree
			 * @param {Array} nodes an array of node IDs
			 * @param {String} parent the parent ID of the nodes
			 */
			this.trigger('model', { "nodes" : dpc, 'parent' : par });
			if(par !== '#') {
				this._node_changed(par);
				this.redraw();
			}
			else {
				this.get_container_ul().children('.jstree-initial-node').remove();
				this.redraw(true);
			}
			if(this._data.core.selected.length !== s) {
				this.trigger('changed', { 'action' : 'model', 'selected' : this._data.core.selected });
			}
			cb.call(this, true);
		},
		/**
		 * appends JSON content to the tree. Used internally.
		 * @private
		 * @name _append_json_data(obj, data)
		 * @param  {mixed} obj the node to append to
		 * @param  {String} data the JSON object to parse and append
		 * @param  {Boolean} force_processing internal param - do not set
		 * @trigger model.jstree, changed.jstree
		 */
		_append_json_data : function (dom, data, cb, force_processing) {
			if(this.element === null) { return; }
			dom = this.get_node(dom);
			dom.children = [];
			dom.children_d = [];
			// *%$@!!!
			if(data.d) {
				data = data.d;
				if(typeof data === "string") {
					data = JSON.parse(data);
				}
			}
			if(!$.isArray(data)) { data = [data]; }
			var w = null,
				args = {
					'df'	: this._model.default_state,
					'dat'	: data,
					'par'	: dom.id,
					'm'		: this._model.data,
					't_id'	: this._id,
					't_cnt'	: this._cnt,
					'sel'	: this._data.core.selected
				},
				func = function (data, undefined) {
					if(data.data) { data = data.data; }
					var dat = data.dat,
						par = data.par,
						chd = [],
						dpc = [],
						add = [],
						df = data.df,
						t_id = data.t_id,
						t_cnt = data.t_cnt,
						m = data.m,
						p = m[par],
						sel = data.sel,
						tmp, i, j, rslt,
						parse_flat = function (d, p, ps) {
							if(!ps) { ps = []; }
							else { ps = ps.concat(); }
							if(p) { ps.unshift(p); }
							var tid = d.id.toString(),
								i, j, c, e,
								tmp = {
									id			: tid,
									text		: d.text || '',
									icon		: d.icon !== undefined ? d.icon : true,
									parent		: p,
									parents		: ps,
									children	: d.children || [],
									children_d	: d.children_d || [],
									data		: d.data,
									state		: { },
									li_attr		: { id : false },
									a_attr		: { href : '#' },
									original	: false
								};
							for(i in df) {
								if(df.hasOwnProperty(i)) {
									tmp.state[i] = df[i];
								}
							}
							if(d && d.data && d.data.jstree && d.data.jstree.icon) {
								tmp.icon = d.data.jstree.icon;
							}
							if(tmp.icon === undefined || tmp.icon === null || tmp.icon === "") {
								tmp.icon = true;
							}
							if(d && d.data) {
								tmp.data = d.data;
								if(d.data.jstree) {
									for(i in d.data.jstree) {
										if(d.data.jstree.hasOwnProperty(i)) {
											tmp.state[i] = d.data.jstree[i];
										}
									}
								}
							}
							if(d && typeof d.state === 'object') {
								for (i in d.state) {
									if(d.state.hasOwnProperty(i)) {
										tmp.state[i] = d.state[i];
									}
								}
							}
							if(d && typeof d.li_attr === 'object') {
								for (i in d.li_attr) {
									if(d.li_attr.hasOwnProperty(i)) {
										tmp.li_attr[i] = d.li_attr[i];
									}
								}
							}
							if(!tmp.li_attr.id) {
								tmp.li_attr.id = tid;
							}
							if(d && typeof d.a_attr === 'object') {
								for (i in d.a_attr) {
									if(d.a_attr.hasOwnProperty(i)) {
										tmp.a_attr[i] = d.a_attr[i];
									}
								}
							}
							if(d && d.children && d.children === true) {
								tmp.state.loaded = false;
								tmp.children = [];
								tmp.children_d = [];
							}
							m[tmp.id] = tmp;
							for(i = 0, j = tmp.children.length; i < j; i++) {
								c = parse_flat(m[tmp.children[i]], tmp.id, ps);
								e = m[c];
								tmp.children_d.push(c);
								if(e.children_d.length) {
									tmp.children_d = tmp.children_d.concat(e.children_d);
								}
							}
							delete d.data;
							delete d.children;
							m[tmp.id].original = d;
							if(tmp.state.selected) {
								add.push(tmp.id);
							}
							return tmp.id;
						},
						parse_nest = function (d, p, ps) {
							if(!ps) { ps = []; }
							else { ps = ps.concat(); }
							if(p) { ps.unshift(p); }
							var tid = false, i, j, c, e, tmp;
							do {
								tid = 'j' + t_id + '_' + (++t_cnt);
							} while(m[tid]);

							tmp = {
								id			: false,
								text		: typeof d === 'string' ? d : '',
								icon		: typeof d === 'object' && d.icon !== undefined ? d.icon : true,
								parent		: p,
								parents		: ps,
								children	: [],
								children_d	: [],
								data		: null,
								state		: { },
								li_attr		: { id : false },
								a_attr		: { href : '#' },
								original	: false
							};
							for(i in df) {
								if(df.hasOwnProperty(i)) {
									tmp.state[i] = df[i];
								}
							}
							if(d && d.id) { tmp.id = d.id.toString(); }
							if(d && d.text) { tmp.text = d.text; }
							if(d && d.data && d.data.jstree && d.data.jstree.icon) {
								tmp.icon = d.data.jstree.icon;
							}
							if(tmp.icon === undefined || tmp.icon === null || tmp.icon === "") {
								tmp.icon = true;
							}
							if(d && d.data) {
								tmp.data = d.data;
								if(d.data.jstree) {
									for(i in d.data.jstree) {
										if(d.data.jstree.hasOwnProperty(i)) {
											tmp.state[i] = d.data.jstree[i];
										}
									}
								}
							}
							if(d && typeof d.state === 'object') {
								for (i in d.state) {
									if(d.state.hasOwnProperty(i)) {
										tmp.state[i] = d.state[i];
									}
								}
							}
							if(d && typeof d.li_attr === 'object') {
								for (i in d.li_attr) {
									if(d.li_attr.hasOwnProperty(i)) {
										tmp.li_attr[i] = d.li_attr[i];
									}
								}
							}
							if(tmp.li_attr.id && !tmp.id) {
								tmp.id = tmp.li_attr.id.toString();
							}
							if(!tmp.id) {
								tmp.id = tid;
							}
							if(!tmp.li_attr.id) {
								tmp.li_attr.id = tmp.id;
							}
							if(d && typeof d.a_attr === 'object') {
								for (i in d.a_attr) {
									if(d.a_attr.hasOwnProperty(i)) {
										tmp.a_attr[i] = d.a_attr[i];
									}
								}
							}
							if(d && d.children && d.children.length) {
								for(i = 0, j = d.children.length; i < j; i++) {
									c = parse_nest(d.children[i], tmp.id, ps);
									e = m[c];
									tmp.children.push(c);
									if(e.children_d.length) {
										tmp.children_d = tmp.children_d.concat(e.children_d);
									}
								}
								tmp.children_d = tmp.children_d.concat(tmp.children);
							}
							if(d && d.children && d.children === true) {
								tmp.state.loaded = false;
								tmp.children = [];
								tmp.children_d = [];
							}
							delete d.data;
							delete d.children;
							tmp.original = d;
							m[tmp.id] = tmp;
							if(tmp.state.selected) {
								add.push(tmp.id);
							}
							return tmp.id;
						};

					if(dat.length && dat[0].id !== undefined && dat[0].parent !== undefined) {
						// Flat JSON support (for easy import from DB):
						// 1) convert to object (foreach)
						for(i = 0, j = dat.length; i < j; i++) {
							if(!dat[i].children) {
								dat[i].children = [];
							}
							m[dat[i].id.toString()] = dat[i];
						}
						// 2) populate children (foreach)
						for(i = 0, j = dat.length; i < j; i++) {
							m[dat[i].parent.toString()].children.push(dat[i].id.toString());
							// populate parent.children_d
							p.children_d.push(dat[i].id.toString());
						}
						// 3) normalize && populate parents and children_d with recursion
						for(i = 0, j = p.children.length; i < j; i++) {
							tmp = parse_flat(m[p.children[i]], par, p.parents.concat());
							dpc.push(tmp);
							if(m[tmp].children_d.length) {
								dpc = dpc.concat(m[tmp].children_d);
							}
						}
						for(i = 0, j = p.parents.length; i < j; i++) {
							m[p.parents[i]].children_d = m[p.parents[i]].children_d.concat(dpc);
						}
						// ?) three_state selection - p.state.selected && t - (if three_state foreach(dat => ch) -> foreach(parents) if(parent.selected) child.selected = true;
						rslt = {
							'cnt' : t_cnt,
							'mod' : m,
							'sel' : sel,
							'par' : par,
							'dpc' : dpc,
							'add' : add
						};
					}
					else {
						for(i = 0, j = dat.length; i < j; i++) {
							tmp = parse_nest(dat[i], par, p.parents.concat());
							if(tmp) {
								chd.push(tmp);
								dpc.push(tmp);
								if(m[tmp].children_d.length) {
									dpc = dpc.concat(m[tmp].children_d);
								}
							}
						}
						p.children = chd;
						p.children_d = dpc;
						for(i = 0, j = p.parents.length; i < j; i++) {
							m[p.parents[i]].children_d = m[p.parents[i]].children_d.concat(dpc);
						}
						rslt = {
							'cnt' : t_cnt,
							'mod' : m,
							'sel' : sel,
							'par' : par,
							'dpc' : dpc,
							'add' : add
						};
					}
					if(typeof window === 'undefined' || typeof window.document === 'undefined') {
						postMessage(rslt);
					}
					else {
						return rslt;
					}
				},
				rslt = function (rslt, worker) {
					if(this.element === null) { return; }
					this._cnt = rslt.cnt;
					this._model.data = rslt.mod; // breaks the reference in load_node - careful

					if(worker) {
						var i, j, a = rslt.add, r = rslt.sel, s = this._data.core.selected.slice(), m = this._model.data;
						// if selection was changed while calculating in worker
						if(r.length !== s.length || $.vakata.array_unique(r.concat(s)).length !== r.length) {
							// deselect nodes that are no longer selected
							for(i = 0, j = r.length; i < j; i++) {
								if($.inArray(r[i], a) === -1 && $.inArray(r[i], s) === -1) {
									m[r[i]].state.selected = false;
								}
							}
							// select nodes that were selected in the mean time
							for(i = 0, j = s.length; i < j; i++) {
								if($.inArray(s[i], r) === -1) {
									m[s[i]].state.selected = true;
								}
							}
						}
					}
					if(rslt.add.length) {
						this._data.core.selected = this._data.core.selected.concat(rslt.add);
					}

					this.trigger('model', { "nodes" : rslt.dpc, 'parent' : rslt.par });

					if(rslt.par !== '#') {
						this._node_changed(rslt.par);
						this.redraw();
					}
					else {
						// this.get_container_ul().children('.jstree-initial-node').remove();
						this.redraw(true);
					}
					if(rslt.add.length) {
						this.trigger('changed', { 'action' : 'model', 'selected' : this._data.core.selected });
					}
					cb.call(this, true);
				};
			if(this.settings.core.worker && window.Blob && window.URL && window.Worker) {
				try {
					if(this._wrk === null) {
						this._wrk = window.URL.createObjectURL(
							new window.Blob(
								['self.onmessage = ' + func.toString()],
								{type:"text/javascript"}
							)
						);
					}
					if(!this._data.core.working || force_processing) {
						this._data.core.working = true;
						w = new window.Worker(this._wrk);
						w.onmessage = $.proxy(function (e) {
							rslt.call(this, e.data, true);
							try { w.terminate(); w = null; } catch(ignore) { }
							if(this._data.core.worker_queue.length) {
								this._append_json_data.apply(this, this._data.core.worker_queue.shift());
							}
							else {
								this._data.core.working = false;
							}
						}, this);
						if(!args.par) {
							if(this._data.core.worker_queue.length) {
								this._append_json_data.apply(this, this._data.core.worker_queue.shift());
							}
							else {
								this._data.core.working = false;
							}
						}
						else {
							w.postMessage(args);
						}
					}
					else {
						this._data.core.worker_queue.push([dom, data, cb, true]);
					}
				}
				catch(e) {
					rslt.call(this, func(args), false);
					if(this._data.core.worker_queue.length) {
						this._append_json_data.apply(this, this._data.core.worker_queue.shift());
					}
					else {
						this._data.core.working = false;
					}
				}
			}
			else {
				rslt.call(this, func(args), false);
			}
		},
		/**
		 * parses a node from a jQuery object and appends them to the in memory tree model. Used internally.
		 * @private
		 * @name _parse_model_from_html(d [, p, ps])
		 * @param  {jQuery} d the jQuery object to parse
		 * @param  {String} p the parent ID
		 * @param  {Array} ps list of all parents
		 * @return {String} the ID of the object added to the model
		 */
		_parse_model_from_html : function (d, p, ps) {
			if(!ps) { ps = []; }
			else { ps = [].concat(ps); }
			if(p) { ps.unshift(p); }
			var c, e, m = this._model.data,
				data = {
					id			: false,
					text		: false,
					icon		: true,
					parent		: p,
					parents		: ps,
					children	: [],
					children_d	: [],
					data		: null,
					state		: { },
					li_attr		: { id : false },
					a_attr		: { href : '#' },
					original	: false
				}, i, tmp, tid;
			for(i in this._model.default_state) {
				if(this._model.default_state.hasOwnProperty(i)) {
					data.state[i] = this._model.default_state[i];
				}
			}
			tmp = $.vakata.attributes(d, true);
			$.each(tmp, function (i, v) {
				v = $.trim(v);
				if(!v.length) { return true; }
				data.li_attr[i] = v;
				if(i === 'id') {
					data.id = v.toString();
				}
			});
			tmp = d.children('a').first();
			if(tmp.length) {
				tmp = $.vakata.attributes(tmp, true);
				$.each(tmp, function (i, v) {
					v = $.trim(v);
					if(v.length) {
						data.a_attr[i] = v;
					}
				});
			}
			tmp = d.children("a").first().length ? d.children("a").first().clone() : d.clone();
			tmp.children("ins, i, ul").remove();
			tmp = tmp.html();
			tmp = $('<div />').html(tmp);
			data.text = this.settings.core.force_text ? tmp.text() : tmp.html();
			tmp = d.data();
			data.data = tmp ? $.extend(true, {}, tmp) : null;
			data.state.opened = d.hasClass('jstree-open');
			data.state.selected = d.children('a').hasClass('jstree-clicked');
			data.state.disabled = d.children('a').hasClass('jstree-disabled');
			if(data.data && data.data.jstree) {
				for(i in data.data.jstree) {
					if(data.data.jstree.hasOwnProperty(i)) {
						data.state[i] = data.data.jstree[i];
					}
				}
			}
			tmp = d.children("a").children(".jstree-themeicon");
			if(tmp.length) {
				data.icon = tmp.hasClass('jstree-themeicon-hidden') ? false : tmp.attr('rel');
			}
			if(data.state.icon !== undefined) {
				data.icon = data.state.icon;
			}
			if(data.icon === undefined || data.icon === null || data.icon === "") {
				data.icon = true;
			}
			tmp = d.children("ul").children("li");
			do {
				tid = 'j' + this._id + '_' + (++this._cnt);
			} while(m[tid]);
			data.id = data.li_attr.id ? data.li_attr.id.toString() : tid;
			if(tmp.length) {
				tmp.each($.proxy(function (i, v) {
					c = this._parse_model_from_html($(v), data.id, ps);
					e = this._model.data[c];
					data.children.push(c);
					if(e.children_d.length) {
						data.children_d = data.children_d.concat(e.children_d);
					}
				}, this));
				data.children_d = data.children_d.concat(data.children);
			}
			else {
				if(d.hasClass('jstree-closed')) {
					data.state.loaded = false;
				}
			}
			if(data.li_attr['class']) {
				data.li_attr['class'] = data.li_attr['class'].replace('jstree-closed','').replace('jstree-open','');
			}
			if(data.a_attr['class']) {
				data.a_attr['class'] = data.a_attr['class'].replace('jstree-clicked','').replace('jstree-disabled','');
			}
			m[data.id] = data;
			if(data.state.selected) {
				this._data.core.selected.push(data.id);
			}
			return data.id;
		},
		/**
		 * parses a node from a JSON object (used when dealing with flat data, which has no nesting of children, but has id and parent properties) and appends it to the in memory tree model. Used internally.
		 * @private
		 * @name _parse_model_from_flat_json(d [, p, ps])
		 * @param  {Object} d the JSON object to parse
		 * @param  {String} p the parent ID
		 * @param  {Array} ps list of all parents
		 * @return {String} the ID of the object added to the model
		 */
		_parse_model_from_flat_json : function (d, p, ps) {
			if(!ps) { ps = []; }
			else { ps = ps.concat(); }
			if(p) { ps.unshift(p); }
			var tid = d.id.toString(),
				m = this._model.data,
				df = this._model.default_state,
				i, j, c, e,
				tmp = {
					id			: tid,
					text		: d.text || '',
					icon		: d.icon !== undefined ? d.icon : true,
					parent		: p,
					parents		: ps,
					children	: d.children || [],
					children_d	: d.children_d || [],
					data		: d.data,
					state		: { },
					li_attr		: { id : false },
					a_attr		: { href : '#' },
					original	: false
				};
			for(i in df) {
				if(df.hasOwnProperty(i)) {
					tmp.state[i] = df[i];
				}
			}
			if(d && d.data && d.data.jstree && d.data.jstree.icon) {
				tmp.icon = d.data.jstree.icon;
			}
			if(tmp.icon === undefined || tmp.icon === null || tmp.icon === "") {
				tmp.icon = true;
			}
			if(d && d.data) {
				tmp.data = d.data;
				if(d.data.jstree) {
					for(i in d.data.jstree) {
						if(d.data.jstree.hasOwnProperty(i)) {
							tmp.state[i] = d.data.jstree[i];
						}
					}
				}
			}
			if(d && typeof d.state === 'object') {
				for (i in d.state) {
					if(d.state.hasOwnProperty(i)) {
						tmp.state[i] = d.state[i];
					}
				}
			}
			if(d && typeof d.li_attr === 'object') {
				for (i in d.li_attr) {
					if(d.li_attr.hasOwnProperty(i)) {
						tmp.li_attr[i] = d.li_attr[i];
					}
				}
			}
			if(!tmp.li_attr.id) {
				tmp.li_attr.id = tid;
			}
			if(d && typeof d.a_attr === 'object') {
				for (i in d.a_attr) {
					if(d.a_attr.hasOwnProperty(i)) {
						tmp.a_attr[i] = d.a_attr[i];
					}
				}
			}
			if(d && d.children && d.children === true) {
				tmp.state.loaded = false;
				tmp.children = [];
				tmp.children_d = [];
			}
			m[tmp.id] = tmp;
			for(i = 0, j = tmp.children.length; i < j; i++) {
				c = this._parse_model_from_flat_json(m[tmp.children[i]], tmp.id, ps);
				e = m[c];
				tmp.children_d.push(c);
				if(e.children_d.length) {
					tmp.children_d = tmp.children_d.concat(e.children_d);
				}
			}
			delete d.data;
			delete d.children;
			m[tmp.id].original = d;
			if(tmp.state.selected) {
				this._data.core.selected.push(tmp.id);
			}
			return tmp.id;
		},
		/**
		 * parses a node from a JSON object and appends it to the in memory tree model. Used internally.
		 * @private
		 * @name _parse_model_from_json(d [, p, ps])
		 * @param  {Object} d the JSON object to parse
		 * @param  {String} p the parent ID
		 * @param  {Array} ps list of all parents
		 * @return {String} the ID of the object added to the model
		 */
		_parse_model_from_json : function (d, p, ps) {
			if(!ps) { ps = []; }
			else { ps = ps.concat(); }
			if(p) { ps.unshift(p); }
			var tid = false, i, j, c, e, m = this._model.data, df = this._model.default_state, tmp;
			do {
				tid = 'j' + this._id + '_' + (++this._cnt);
			} while(m[tid]);

			tmp = {
				id			: false,
				text		: typeof d === 'string' ? d : '',
				icon		: typeof d === 'object' && d.icon !== undefined ? d.icon : true,
				parent		: p,
				parents		: ps,
				children	: [],
				children_d	: [],
				data		: null,
				state		: { },
				li_attr		: { id : false },
				a_attr		: { href : '#' },
				original	: false
			};
			for(i in df) {
				if(df.hasOwnProperty(i)) {
					tmp.state[i] = df[i];
				}
			}
			if(d && d.id) { tmp.id = d.id.toString(); }
			if(d && d.text) { tmp.text = d.text; }
			if(d && d.data && d.data.jstree && d.data.jstree.icon) {
				tmp.icon = d.data.jstree.icon;
			}
			if(tmp.icon === undefined || tmp.icon === null || tmp.icon === "") {
				tmp.icon = true;
			}
			if(d && d.data) {
				tmp.data = d.data;
				if(d.data.jstree) {
					for(i in d.data.jstree) {
						if(d.data.jstree.hasOwnProperty(i)) {
							tmp.state[i] = d.data.jstree[i];
						}
					}
				}
			}
			if(d && typeof d.state === 'object') {
				for (i in d.state) {
					if(d.state.hasOwnProperty(i)) {
						tmp.state[i] = d.state[i];
					}
				}
			}
			if(d && typeof d.li_attr === 'object') {
				for (i in d.li_attr) {
					if(d.li_attr.hasOwnProperty(i)) {
						tmp.li_attr[i] = d.li_attr[i];
					}
				}
			}
			if(tmp.li_attr.id && !tmp.id) {
				tmp.id = tmp.li_attr.id.toString();
			}
			if(!tmp.id) {
				tmp.id = tid;
			}
			if(!tmp.li_attr.id) {
				tmp.li_attr.id = tmp.id;
			}
			if(d && typeof d.a_attr === 'object') {
				for (i in d.a_attr) {
					if(d.a_attr.hasOwnProperty(i)) {
						tmp.a_attr[i] = d.a_attr[i];
					}
				}
			}
			if(d && d.children && d.children.length) {
				for(i = 0, j = d.children.length; i < j; i++) {
					c = this._parse_model_from_json(d.children[i], tmp.id, ps);
					e = m[c];
					tmp.children.push(c);
					if(e.children_d.length) {
						tmp.children_d = tmp.children_d.concat(e.children_d);
					}
				}
				tmp.children_d = tmp.children_d.concat(tmp.children);
			}
			if(d && d.children && d.children === true) {
				tmp.state.loaded = false;
				tmp.children = [];
				tmp.children_d = [];
			}
			delete d.data;
			delete d.children;
			tmp.original = d;
			m[tmp.id] = tmp;
			if(tmp.state.selected) {
				this._data.core.selected.push(tmp.id);
			}
			return tmp.id;
		},
		/**
		 * redraws all nodes that need to be redrawn. Used internally.
		 * @private
		 * @name _redraw()
		 * @trigger redraw.jstree
		 */
		_redraw : function () {
			var nodes = this._model.force_full_redraw ? this._model.data['#'].children.concat([]) : this._model.changed.concat([]),
				f = document.createElement('UL'), tmp, i, j, fe = this._data.core.focused;
			for(i = 0, j = nodes.length; i < j; i++) {
				tmp = this.redraw_node(nodes[i], true, this._model.force_full_redraw);
				if(tmp && this._model.force_full_redraw) {
					f.appendChild(tmp);
				}
			}
			if(this._model.force_full_redraw) {
				f.className = this.get_container_ul()[0] ? this.get_container_ul()[0].className : null;
				f.setAttribute('role','group');
				this.element.empty().append(f);
				//this.get_container_ul()[0].appendChild(f);
			}
			if(fe !== null) {
				tmp = this.get_node(fe, true);
				if(tmp && tmp.length && tmp.children('.jstree-anchor')[0] !== document.activeElement) {
					tmp.children('.jstree-anchor').focus();
				}
				else {
					this._data.core.focused = null;
				}
			}
			this._model.force_full_redraw = false;
			this._model.changed = [];
			/**
			 * triggered after nodes are redrawn
			 * @event
			 * @name redraw.jstree
			 * @param {array} nodes the redrawn nodes
			 */
			this.trigger('redraw', { "nodes" : nodes });
		},
		/**
		 * redraws all nodes that need to be redrawn or optionally - the whole tree
		 * @name redraw([full])
		 * @param {Boolean} full if set to `true` all nodes are redrawn.
		 */
		redraw : function (full) {
			if(full) {
				this._model.force_full_redraw = true;
			}
			//if(this._model.redraw_timeout) {
			//	clearTimeout(this._model.redraw_timeout);
			//}
			//this._model.redraw_timeout = setTimeout($.proxy(this._redraw, this),0);
			this._redraw();
		},
		/**
		 * redraws a single node's children. Used internally.
		 * @private
		 * @name draw_children(node)
		 * @param {mixed} node the node whose children will be redrawn
		 */
		draw_children : function (node) {
			var obj = this.get_node(node),
				i = false,
				j = false,
				k = false,
				d = document;
			if(!obj) { return false; }
			if(obj.id === '#') { return this.redraw(true); }
			node = this.get_node(node, true);
			if(!node || !node.length) { return false; } // TODO: quick toggle

			node.children('.jstree-children').remove();
			node = node[0];
			if(obj.children.length && obj.state.loaded) {
				k = d.createElement('UL');
				k.setAttribute('role', 'group');
				k.className = 'jstree-children';
				for(i = 0, j = obj.children.length; i < j; i++) {
					k.appendChild(this.redraw_node(obj.children[i], true, true));
				}
				node.appendChild(k);
			}
		},
		/**
		 * redraws a single node. Used internally.
		 * @private
		 * @name redraw_node(node, deep, is_callback, force_render)
		 * @param {mixed} node the node to redraw
		 * @param {Boolean} deep should child nodes be redrawn too
		 * @param {Boolean} is_callback is this a recursion call
		 * @param {Boolean} force_render should children of closed parents be drawn anyway
		 */
		redraw_node : function (node, deep, is_callback, force_render) {
			var obj = this.get_node(node),
				par = false,
				ind = false,
				old = false,
				i = false,
				j = false,
				k = false,
				c = '',
				d = document,
				m = this._model.data,
				f = false,
				s = false,
				tmp = null,
				t = 0,
				l = 0;
			if(!obj) { return false; }
			if(obj.id === '#') {  return this.redraw(true); }
			deep = deep || obj.children.length === 0;
			node = !document.querySelector ? document.getElementById(obj.id) : this.element[0].querySelector('#' + ("0123456789".indexOf(obj.id[0]) !== -1 ? '\\3' + obj.id[0] + ' ' + obj.id.substr(1).replace($.jstree.idregex,'\\$&') : obj.id.replace($.jstree.idregex,'\\$&')) ); //, this.element);
			if(!node) {
				deep = true;
				//node = d.createElement('LI');
				if(!is_callback) {
					par = obj.parent !== '#' ? $('#' + obj.parent.replace($.jstree.idregex,'\\$&'), this.element)[0] : null;
					if(par !== null && (!par || !m[obj.parent].state.opened)) {
						return false;
					}
					ind = $.inArray(obj.id, par === null ? m['#'].children : m[obj.parent].children);
				}
			}
			else {
				node = $(node);
				if(!is_callback) {
					par = node.parent().parent()[0];
					if(par === this.element[0]) {
						par = null;
					}
					ind = node.index();
				}
				// m[obj.id].data = node.data(); // use only node's data, no need to touch jquery storage
				if(!deep && obj.children.length && !node.children('.jstree-children').length) {
					deep = true;
				}
				if(!deep) {
					old = node.children('.jstree-children')[0];
				}
				f = node.children('.jstree-anchor')[0] === document.activeElement;
				node.remove();
				//node = d.createElement('LI');
				//node = node[0];
			}
			node = _node.cloneNode(true);
			// node is DOM, deep is boolean

			c = 'jstree-node ';
			for(i in obj.li_attr) {
				if(obj.li_attr.hasOwnProperty(i)) {
					if(i === 'id') { continue; }
					if(i !== 'class') {
						node.setAttribute(i, obj.li_attr[i]);
					}
					else {
						c += obj.li_attr[i];
					}
				}
			}
			if(!obj.a_attr.id) {
				obj.a_attr.id = obj.id + '_anchor';
			}
			node.setAttribute('aria-selected', !!obj.state.selected);
			node.setAttribute('aria-level', obj.parents.length);
			node.setAttribute('aria-labelledby', obj.a_attr.id);
			if(obj.state.disabled) {
				node.setAttribute('aria-disabled', true);
			}

			if(obj.state.loaded && !obj.children.length) {
				c += ' jstree-leaf';
			}
			else {
				c += obj.state.opened && obj.state.loaded ? ' jstree-open' : ' jstree-closed';
				node.setAttribute('aria-expanded', (obj.state.opened && obj.state.loaded) );
			}
			if(obj.parent !== null && m[obj.parent].children[m[obj.parent].children.length - 1] === obj.id) {
				c += ' jstree-last';
			}
			node.id = obj.id;
			node.className = c;
			c = ( obj.state.selected ? ' jstree-clicked' : '') + ( obj.state.disabled ? ' jstree-disabled' : '');
			for(j in obj.a_attr) {
				if(obj.a_attr.hasOwnProperty(j)) {
					if(j === 'href' && obj.a_attr[j] === '#') { continue; }
					if(j !== 'class') {
						node.childNodes[1].setAttribute(j, obj.a_attr[j]);
					}
					else {
						c += ' ' + obj.a_attr[j];
					}
				}
			}
			if(c.length) {
				node.childNodes[1].className = 'jstree-anchor ' + c;
			}
			if((obj.icon && obj.icon !== true) || obj.icon === false) {
				if(obj.icon === false) {
					node.childNodes[1].childNodes[0].className += ' jstree-themeicon-hidden';
				}
				else if(obj.icon.indexOf('/') === -1 && obj.icon.indexOf('.') === -1) {
					node.childNodes[1].className += ' ' + obj.icon + ' jstree-themeicon-custom';	//新版jstree图标可配置 （杨兴康）
				}
				else {
					node.childNodes[1].childNodes[0].style.backgroundImage = 'url('+obj.icon+')';
					node.childNodes[1].childNodes[0].style.backgroundPosition = 'center center';
					node.childNodes[1].childNodes[0].style.backgroundSize = 'auto';
					node.childNodes[1].childNodes[0].className += ' jstree-themeicon-custom';
				}
			}

			if(this.settings.core.force_text) {
				node.childNodes[1].appendChild(d.createTextNode(obj.text));
			}
			else {
				node.childNodes[1].innerHTML += obj.text;
			}


			if(deep && obj.children.length && (obj.state.opened || force_render) && obj.state.loaded) {
				k = d.createElement('UL');
				k.setAttribute('role', 'group');
				k.className = 'jstree-children';
				for(i = 0, j = obj.children.length; i < j; i++) {
					k.appendChild(this.redraw_node(obj.children[i], deep, true));
				}
				node.appendChild(k);
			}
			if(old) {
				node.appendChild(old);
			}
			if(!is_callback) {
				// append back using par / ind
				if(!par) {
					par = this.element[0];
				}
				for(i = 0, j = par.childNodes.length; i < j; i++) {
					if(par.childNodes[i] && par.childNodes[i].className && par.childNodes[i].className.indexOf('jstree-children') !== -1) {
						tmp = par.childNodes[i];
						break;
					}
				}
				if(!tmp) {
					tmp = d.createElement('UL');
					tmp.setAttribute('role', 'group');
					tmp.className = 'jstree-children';
					par.appendChild(tmp);
				}
				par = tmp;

				if(ind < par.childNodes.length) {
					par.insertBefore(node, par.childNodes[ind]);
				}
				else {
					par.appendChild(node);
				}
				if(f) {
					t = this.element[0].scrollTop;
					l = this.element[0].scrollLeft;
					node.childNodes[1].focus();
					this.element[0].scrollTop = t;
					this.element[0].scrollLeft = l;
				}
			}
			if(obj.state.opened && !obj.state.loaded) {
				obj.state.opened = false;
				setTimeout($.proxy(function () {
					this.open_node(obj.id, false, 0);
				}, this), 0);
			}
			return node;
		},
		/**
		 * opens a node, revaling its children. If the node is not loaded it will be loaded and opened once ready.
		 * @name open_node(obj [, callback, animation])
		 * @param {mixed} obj the node to open
		 * @param {Function} callback a function to execute once the node is opened
		 * @param {Number} animation the animation duration in milliseconds when opening the node (overrides the `core.animation` setting). Use `false` for no animation.
		 * @trigger open_node.jstree, after_open.jstree, before_open.jstree
		 */
		open_node : function (obj, callback, animation) {
			var t1, t2, d, t;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.open_node(obj[t1], callback, animation);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			animation = animation === undefined ? this.settings.core.animation : animation;
			if(!this.is_closed(obj)) {
				if(callback) {
					callback.call(this, obj, false);
				}
				return false;
			}
			if(!this.is_loaded(obj)) {
				if(this.is_loading(obj)) {
					return setTimeout($.proxy(function () {
						this.open_node(obj, callback, animation);
					}, this), 500);
				}
				this.load_node(obj, function (o, ok) {
					return ok ? this.open_node(o, callback, animation) : (callback ? callback.call(this, o, false) : false);
				});
			}
			else {
				d = this.get_node(obj, true);
				t = this;
				if(d.length) {
					if(animation && d.children(".jstree-children").length) {
						d.children(".jstree-children").stop(true, true);
					}
					if(obj.children.length && !this._firstChild(d.children('.jstree-children')[0])) {
						this.draw_children(obj);
						//d = this.get_node(obj, true);
					}
					if(!animation) {
						this.trigger('before_open', { "node" : obj });
						d[0].className = d[0].className.replace('jstree-closed', 'jstree-open');
						d[0].setAttribute("aria-expanded", true);
					}
					else {
						this.trigger('before_open', { "node" : obj });
						d
							.children(".jstree-children").css("display","none").end()
							.removeClass("jstree-closed").addClass("jstree-open").attr("aria-expanded", true)
							.children(".jstree-children").stop(true, true)
								.slideDown(animation, function () {
									this.style.display = "";
									t.trigger("after_open", { "node" : obj });
								});
					}
				}
				obj.state.opened = true;
				if(callback) {
					callback.call(this, obj, true);
				}
				if(!d.length) {
					/**
					 * triggered when a node is about to be opened (if the node is supposed to be in the DOM, it will be, but it won't be visible yet)
					 * @event
					 * @name before_open.jstree
					 * @param {Object} node the opened node
					 */
					this.trigger('before_open', { "node" : obj });
				}
				/**
				 * triggered when a node is opened (if there is an animation it will not be completed yet)
				 * @event
				 * @name open_node.jstree
				 * @param {Object} node the opened node
				 */
				this.trigger('open_node', { "node" : obj });
				if(!animation || !d.length) {
					/**
					 * triggered when a node is opened and the animation is complete
					 * @event
					 * @name after_open.jstree
					 * @param {Object} node the opened node
					 */
					this.trigger("after_open", { "node" : obj });
				}
			}
		},
		/**
		 * opens every parent of a node (node should be loaded)
		 * @name _open_to(obj)
		 * @param {mixed} obj the node to reveal
		 * @private
		 */
		_open_to : function (obj) {
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			var i, j, p = obj.parents;
			for(i = 0, j = p.length; i < j; i+=1) {
				if(i !== '#') {
					this.open_node(p[i], false, 0);
				}
			}
			return $('#' + obj.id.replace($.jstree.idregex,'\\$&'), this.element);
		},
		/**
		 * closes a node, hiding its children
		 * @name close_node(obj [, animation])
		 * @param {mixed} obj the node to close
		 * @param {Number} animation the animation duration in milliseconds when closing the node (overrides the `core.animation` setting). Use `false` for no animation.
		 * @trigger close_node.jstree, after_close.jstree
		 */
		close_node : function (obj, animation) {
			var t1, t2, t, d;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.close_node(obj[t1], animation);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			if(this.is_closed(obj)) {
				return false;
			}
			animation = animation === undefined ? this.settings.core.animation : animation;
			t = this;
			d = this.get_node(obj, true);
			if(d.length) {
				if(!animation) {
					d[0].className = d[0].className.replace('jstree-open', 'jstree-closed');
					d.attr("aria-expanded", false).children('.jstree-children').remove();
				}
				else {
					d
						.children(".jstree-children").attr("style","display:block !important").end()
						.removeClass("jstree-open").addClass("jstree-closed").attr("aria-expanded", false)
						.children(".jstree-children").stop(true, true).slideUp(animation, function () {
							this.style.display = "";
							d.children('.jstree-children').remove();
							t.trigger("after_close", { "node" : obj });
						});
				}
			}
			obj.state.opened = false;
			/**
			 * triggered when a node is closed (if there is an animation it will not be complete yet)
			 * @event
			 * @name close_node.jstree
			 * @param {Object} node the closed node
			 */
			this.trigger('close_node',{ "node" : obj });
			if(!animation || !d.length) {
				/**
				 * triggered when a node is closed and the animation is complete
				 * @event
				 * @name after_close.jstree
				 * @param {Object} node the closed node
				 */
				this.trigger("after_close", { "node" : obj });
			}
		},
		/**
		 * toggles a node - closing it if it is open, opening it if it is closed
		 * @name toggle_node(obj)
		 * @param {mixed} obj the node to toggle
		 */
		toggle_node : function (obj) {
			var t1, t2;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.toggle_node(obj[t1]);
				}
				return true;
			}
			if(this.is_closed(obj)) {
				return this.open_node(obj);
			}
			if(this.is_open(obj)) {
				return this.close_node(obj);
			}
		},
		/**
		 * opens all nodes within a node (or the tree), revaling their children. If the node is not loaded it will be loaded and opened once ready.
		 * @name open_all([obj, animation, original_obj])
		 * @param {mixed} obj the node to open recursively, omit to open all nodes in the tree
		 * @param {Number} animation the animation duration in milliseconds when opening the nodes, the default is no animation
		 * @param {jQuery} reference to the node that started the process (internal use)
		 * @trigger open_all.jstree
		 */
		open_all : function (obj, animation, original_obj) {
			if(!obj) { obj = '#'; }
			obj = this.get_node(obj);
			if(!obj) { return false; }
			var dom = obj.id === '#' ? this.get_container_ul() : this.get_node(obj, true), i, j, _this;
			if(!dom.length) {
				for(i = 0, j = obj.children_d.length; i < j; i++) {
					if(this.is_closed(this._model.data[obj.children_d[i]])) {
						this._model.data[obj.children_d[i]].state.opened = true;
					}
				}
				return this.trigger('open_all', { "node" : obj });
			}
			original_obj = original_obj || dom;
			_this = this;
			dom = this.is_closed(obj) ? dom.find('.jstree-closed').addBack() : dom.find('.jstree-closed');
			dom.each(function () {
				_this.open_node(
					this,
					function(node, status) { if(status && this.is_parent(node)) { this.open_all(node, animation, original_obj); } },
					animation || 0
				);
			});
			if(original_obj.find('.jstree-closed').length === 0) {
				/**
				 * triggered when an `open_all` call completes
				 * @event
				 * @name open_all.jstree
				 * @param {Object} node the opened node
				 */
				this.trigger('open_all', { "node" : this.get_node(original_obj) });
			}
		},
		/**
		 * closes all nodes within a node (or the tree), revaling their children
		 * @name close_all([obj, animation])
		 * @param {mixed} obj the node to close recursively, omit to close all nodes in the tree
		 * @param {Number} animation the animation duration in milliseconds when closing the nodes, the default is no animation
		 * @trigger close_all.jstree
		 */
		close_all : function (obj, animation) {
			if(!obj) { obj = '#'; }
			obj = this.get_node(obj);
			if(!obj) { return false; }
			var dom = obj.id === '#' ? this.get_container_ul() : this.get_node(obj, true),
				_this = this, i, j;
			if(!dom.length) {
				for(i = 0, j = obj.children_d.length; i < j; i++) {
					this._model.data[obj.children_d[i]].state.opened = false;
				}
				return this.trigger('close_all', { "node" : obj });
			}
			dom = this.is_open(obj) ? dom.find('.jstree-open').addBack() : dom.find('.jstree-open');
			$(dom.get().reverse()).each(function () { _this.close_node(this, animation || 0); });
			/**
			 * triggered when an `close_all` call completes
			 * @event
			 * @name close_all.jstree
			 * @param {Object} node the closed node
			 */
			this.trigger('close_all', { "node" : obj });
		},
		/**
		 * checks if a node is disabled (not selectable)
		 * @name is_disabled(obj)
		 * @param  {mixed} obj
		 * @return {Boolean}
		 */
		is_disabled : function (obj) {
			obj = this.get_node(obj);
			return obj && obj.state && obj.state.disabled;
		},
		/**
		 * enables a node - so that it can be selected
		 * @name enable_node(obj)
		 * @param {mixed} obj the node to enable
		 * @trigger enable_node.jstree
		 */
		enable_node : function (obj) {
			var t1, t2;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.enable_node(obj[t1]);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			obj.state.disabled = false;
			this.get_node(obj,true).children('.jstree-anchor').removeClass('jstree-disabled').attr('aria-disabled', false);
			/**
			 * triggered when an node is enabled
			 * @event
			 * @name enable_node.jstree
			 * @param {Object} node the enabled node
			 */
			this.trigger('enable_node', { 'node' : obj });
		},
		/**
		 * disables a node - so that it can not be selected
		 * @name disable_node(obj)
		 * @param {mixed} obj the node to disable
		 * @trigger disable_node.jstree
		 */
		disable_node : function (obj) {
			var t1, t2;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.disable_node(obj[t1]);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			obj.state.disabled = true;
			this.get_node(obj,true).children('.jstree-anchor').addClass('jstree-disabled').attr('aria-disabled', true);
			/**
			 * triggered when an node is disabled
			 * @event
			 * @name disable_node.jstree
			 * @param {Object} node the disabled node
			 */
			this.trigger('disable_node', { 'node' : obj });
		},
		/**
		 * called when a node is selected by the user. Used internally.
		 * @private
		 * @name activate_node(obj, e)
		 * @param {mixed} obj the node
		 * @param {Object} e the related event
		 * @trigger activate_node.jstree, changed.jstree
		 */
		activate_node : function (obj, e) {
			if(this.is_disabled(obj)) {
				return false;
			}

			// ensure last_clicked is still in the DOM, make it fresh (maybe it was moved?) and make sure it is still selected, if not - make last_clicked the last selected node
			this._data.core.last_clicked = this._data.core.last_clicked && this._data.core.last_clicked.id !== undefined ? this.get_node(this._data.core.last_clicked.id) : null;
			if(this._data.core.last_clicked && !this._data.core.last_clicked.state.selected) { this._data.core.last_clicked = null; }
			if(!this._data.core.last_clicked && this._data.core.selected.length) { this._data.core.last_clicked = this.get_node(this._data.core.selected[this._data.core.selected.length - 1]); }

			if(!this.settings.core.multiple || (!e.metaKey && !e.ctrlKey && !e.shiftKey) || (e.shiftKey && (!this._data.core.last_clicked || !this.get_parent(obj) || this.get_parent(obj) !== this._data.core.last_clicked.parent ) )) {
				if(!this.settings.core.multiple && (e.metaKey || e.ctrlKey || e.shiftKey) && this.is_selected(obj)) {
					this.deselect_node(obj, false, e);
				}
				else {
					this.deselect_all(true);
					this.select_node(obj, false, false, e);
					this._data.core.last_clicked = this.get_node(obj);
				}
			}
			else {
				if(e.shiftKey) {
					var o = this.get_node(obj).id,
						l = this._data.core.last_clicked.id,
						p = this.get_node(this._data.core.last_clicked.parent).children,
						c = false,
						i, j;
					for(i = 0, j = p.length; i < j; i += 1) {
						// separate IFs work whem o and l are the same
						if(p[i] === o) {
							c = !c;
						}
						if(p[i] === l) {
							c = !c;
						}
						if(!this.is_disabled(p[i]) && (c || p[i] === o || p[i] === l)) {
							this.select_node(p[i], true, false, e);
						}
						else {
							this.deselect_node(p[i], true, e);
						}
					}
					this.trigger('changed', { 'action' : 'select_node', 'node' : this.get_node(obj), 'selected' : this._data.core.selected, 'event' : e });
				}
				else {
					if(!this.is_selected(obj)) {
						this.select_node(obj, false, false, e);
					}
					else {
						this.deselect_node(obj, false, e);
					}
				}
			}
			/**
			 * triggered when an node is clicked or intercated with by the user
			 * @event
			 * @name activate_node.jstree
			 * @param {Object} node
			 */
			this.trigger('activate_node', { 'node' : this.get_node(obj) });
		},
		/**
		 * applies the hover state on a node, called when a node is hovered by the user. Used internally.
		 * @private
		 * @name hover_node(obj)
		 * @param {mixed} obj
		 * @trigger hover_node.jstree
		 */
		hover_node : function (obj) {
			obj = this.get_node(obj, true);
			if(!obj || !obj.length || obj.children('.jstree-hovered').length) {
				return false;
			}
			var o = this.element.find('.jstree-hovered'), t = this.element;
			if(o && o.length) { this.dehover_node(o); }

			obj.children('.jstree-anchor').addClass('jstree-hovered');
			/**
			 * triggered when an node is hovered
			 * @event
			 * @name hover_node.jstree
			 * @param {Object} node
			 */
			this.trigger('hover_node', { 'node' : this.get_node(obj) });
			setTimeout(function () { t.attr('aria-activedescendant', obj[0].id); }, 0);
		},
		/**
		 * removes the hover state from a nodecalled when a node is no longer hovered by the user. Used internally.
		 * @private
		 * @name dehover_node(obj)
		 * @param {mixed} obj
		 * @trigger dehover_node.jstree
		 */
		dehover_node : function (obj) {
			obj = this.get_node(obj, true);
			if(!obj || !obj.length || !obj.children('.jstree-hovered').length) {
				return false;
			}
			obj.children('.jstree-anchor').removeClass('jstree-hovered');
			/**
			 * triggered when an node is no longer hovered
			 * @event
			 * @name dehover_node.jstree
			 * @param {Object} node
			 */
			this.trigger('dehover_node', { 'node' : this.get_node(obj) });
		},
		/**
		 * select a node
		 * @name select_node(obj [, supress_event, prevent_open])
		 * @param {mixed} obj an array can be used to select multiple nodes
		 * @param {Boolean} supress_event if set to `true` the `changed.jstree` event won't be triggered
		 * @param {Boolean} prevent_open if set to `true` parents of the selected node won't be opened
		 * @trigger select_node.jstree, changed.jstree
		 */
		select_node : function (obj, supress_event, prevent_open, e) {
			var dom, t1, t2, th;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.select_node(obj[t1], supress_event, prevent_open, e);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			dom = this.get_node(obj, true);
			if(!obj.state.selected) {
				obj.state.selected = true;
				this._data.core.selected.push(obj.id);
				if(!prevent_open) {
					dom = this._open_to(obj);
				}
				if(dom && dom.length) {
					dom.attr('aria-selected', true).children('.jstree-anchor').addClass('jstree-clicked');
				}
				/**
				 * triggered when an node is selected
				 * @event
				 * @name select_node.jstree
				 * @param {Object} node
				 * @param {Array} selected the current selection
				 * @param {Object} event the event (if any) that triggered this select_node
				 */
				this.trigger('select_node', { 'node' : obj, 'selected' : this._data.core.selected, 'event' : e });
				if(!supress_event) {
					/**
					 * triggered when selection changes
					 * @event
					 * @name changed.jstree
					 * @param {Object} node
					 * @param {Object} action the action that caused the selection to change
					 * @param {Array} selected the current selection
					 * @param {Object} event the event (if any) that triggered this changed event
					 */
					this.trigger('changed', { 'action' : 'select_node', 'node' : obj, 'selected' : this._data.core.selected, 'event' : e });
				}
			}
		},
		/**
		 * deselect a node
		 * @name deselect_node(obj [, supress_event])
		 * @param {mixed} obj an array can be used to deselect multiple nodes
		 * @param {Boolean} supress_event if set to `true` the `changed.jstree` event won't be triggered
		 * @trigger deselect_node.jstree, changed.jstree
		 */
		deselect_node : function (obj, supress_event, e) {
			var t1, t2, dom;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.deselect_node(obj[t1], supress_event, e);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			dom = this.get_node(obj, true);
			if(obj.state.selected) {
				obj.state.selected = false;
				this._data.core.selected = $.vakata.array_remove_item(this._data.core.selected, obj.id);
				if(dom.length) {
					dom.attr('aria-selected', false).children('.jstree-anchor').removeClass('jstree-clicked');
				}
				/**
				 * triggered when an node is deselected
				 * @event
				 * @name deselect_node.jstree
				 * @param {Object} node
				 * @param {Array} selected the current selection
				 * @param {Object} event the event (if any) that triggered this deselect_node
				 */
				this.trigger('deselect_node', { 'node' : obj, 'selected' : this._data.core.selected, 'event' : e });
				if(!supress_event) {
					this.trigger('changed', { 'action' : 'deselect_node', 'node' : obj, 'selected' : this._data.core.selected, 'event' : e });
				}
			}
		},
		/**
		 * select all nodes in the tree
		 * @name select_all([supress_event])
		 * @param {Boolean} supress_event if set to `true` the `changed.jstree` event won't be triggered
		 * @trigger select_all.jstree, changed.jstree
		 */
		select_all : function (supress_event) {
			var tmp = this._data.core.selected.concat([]), i, j;
			this._data.core.selected = this._model.data['#'].children_d.concat();
			for(i = 0, j = this._data.core.selected.length; i < j; i++) {
				if(this._model.data[this._data.core.selected[i]]) {
					this._model.data[this._data.core.selected[i]].state.selected = true;
				}
			}
			this.redraw(true);
			/**
			 * triggered when all nodes are selected
			 * @event
			 * @name select_all.jstree
			 * @param {Array} selected the current selection
			 */
			this.trigger('select_all', { 'selected' : this._data.core.selected });
			if(!supress_event) {
				this.trigger('changed', { 'action' : 'select_all', 'selected' : this._data.core.selected, 'old_selection' : tmp });
			}
		},
		/**
		 * deselect all selected nodes
		 * @name deselect_all([supress_event])
		 * @param {Boolean} supress_event if set to `true` the `changed.jstree` event won't be triggered
		 * @trigger deselect_all.jstree, changed.jstree
		 */
		deselect_all : function (supress_event) {
			var tmp = this._data.core.selected.concat([]), i, j;
			for(i = 0, j = this._data.core.selected.length; i < j; i++) {
				if(this._model.data[this._data.core.selected[i]]) {
					this._model.data[this._data.core.selected[i]].state.selected = false;
				}
			}
			this._data.core.selected = [];
			this.element.find('.jstree-clicked').removeClass('jstree-clicked').parent().attr('aria-selected', false);
			/**
			 * triggered when all nodes are deselected
			 * @event
			 * @name deselect_all.jstree
			 * @param {Object} node the previous selection
			 * @param {Array} selected the current selection
			 */
			this.trigger('deselect_all', { 'selected' : this._data.core.selected, 'node' : tmp });
			if(!supress_event) {
				this.trigger('changed', { 'action' : 'deselect_all', 'selected' : this._data.core.selected, 'old_selection' : tmp });
			}
		},
		/**
		 * checks if a node is selected
		 * @name is_selected(obj)
		 * @param  {mixed}  obj
		 * @return {Boolean}
		 */
		is_selected : function (obj) {
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			return obj.state.selected;
		},
		/**
		 * get an array of all selected nodes
		 * @name get_selected([full])
		 * @param  {mixed}  full if set to `true` the returned array will consist of the full node objects, otherwise - only IDs will be returned
		 * @return {Array}
		 */
		get_selected : function (full) {
			return full ? $.map(this._data.core.selected, $.proxy(function (i) { return this.get_node(i); }, this)) : this._data.core.selected.slice();
		},
		/**
		 * get an array of all top level selected nodes (ignoring children of selected nodes)
		 * @name get_top_selected([full])
		 * @param  {mixed}  full if set to `true` the returned array will consist of the full node objects, otherwise - only IDs will be returned
		 * @return {Array}
		 */
		get_top_selected : function (full) {
			var tmp = this.get_selected(true),
				obj = {}, i, j, k, l;
			for(i = 0, j = tmp.length; i < j; i++) {
				obj[tmp[i].id] = tmp[i];
			}
			for(i = 0, j = tmp.length; i < j; i++) {
				for(k = 0, l = tmp[i].children_d.length; k < l; k++) {
					if(obj[tmp[i].children_d[k]]) {
						delete obj[tmp[i].children_d[k]];
					}
				}
			}
			tmp = [];
			for(i in obj) {
				if(obj.hasOwnProperty(i)) {
					tmp.push(i);
				}
			}
			return full ? $.map(tmp, $.proxy(function (i) { return this.get_node(i); }, this)) : tmp;
		},
		/**
		 * get an array of all bottom level selected nodes (ignoring selected parents)
		 * @name get_bottom_selected([full])
		 * @param  {mixed}  full if set to `true` the returned array will consist of the full node objects, otherwise - only IDs will be returned
		 * @return {Array}
		 */
		get_bottom_selected : function (full) {
			var tmp = this.get_selected(true),
				obj = [], i, j;
			for(i = 0, j = tmp.length; i < j; i++) {
				if(!tmp[i].children.length) {
					obj.push(tmp[i].id);
				}
			}
			return full ? $.map(obj, $.proxy(function (i) { return this.get_node(i); }, this)) : obj;
		},
		/**
		 * gets the current state of the tree so that it can be restored later with `set_state(state)`. Used internally.
		 * @name get_state()
		 * @private
		 * @return {Object}
		 */
		get_state : function () {
			var state	= {
				'core' : {
					'open' : [],
					'scroll' : {
						'left' : this.element.scrollLeft(),
						'top' : this.element.scrollTop()
					},
					/*!
					'themes' : {
						'name' : this.get_theme(),
						'icons' : this._data.core.themes.icons,
						'dots' : this._data.core.themes.dots
					},
					*/
					'selected' : []
				}
			}, i;
			for(i in this._model.data) {
				if(this._model.data.hasOwnProperty(i)) {
					if(i !== '#') {
						if(this._model.data[i].state.opened) {
							state.core.open.push(i);
						}
						if(this._model.data[i].state.selected) {
							state.core.selected.push(i);
						}
					}
				}
			}
			return state;
		},
		/**
		 * sets the state of the tree. Used internally.
		 * @name set_state(state [, callback])
		 * @private
		 * @param {Object} state the state to restore
		 * @param {Function} callback an optional function to execute once the state is restored.
		 * @trigger set_state.jstree
		 */
		set_state : function (state, callback) {
			if(state) {
				if(state.core) {
					var res, n, t, _this, i;
					if(state.core.open) {
						if(!$.isArray(state.core.open) || !state.core.open.length) {
							delete state.core.open;
							this.set_state(state, callback);
						}
						else {
							this._load_nodes(state.core.open, function (nodes) {
								this.open_node(nodes, false, 0);
								delete state.core.open;
								this.set_state(state, callback);
							}, true);
						}
						return false;
					}
					if(state.core.scroll) {
						if(state.core.scroll && state.core.scroll.left !== undefined) {
							this.element.scrollLeft(state.core.scroll.left);
						}
						if(state.core.scroll && state.core.scroll.top !== undefined) {
							this.element.scrollTop(state.core.scroll.top);
						}
						delete state.core.scroll;
						this.set_state(state, callback);
						return false;
					}
					if(state.core.selected) {
						_this = this;
						this.deselect_all();
						$.each(state.core.selected, function (i, v) {
							_this.select_node(v, false, true);
						});
						delete state.core.selected;
						this.set_state(state, callback);
						return false;
					}
					for(i in state) {
						if(state.hasOwnProperty(i) && i !== "core" && $.inArray(i, this.settings.plugins) === -1) {
							delete state[i];
						}
					}
					if($.isEmptyObject(state.core)) {
						delete state.core;
						this.set_state(state, callback);
						return false;
					}
				}
				if($.isEmptyObject(state)) {
					state = null;
					if(callback) { callback.call(this); }
					/**
					 * triggered when a `set_state` call completes
					 * @event
					 * @name set_state.jstree
					 */
					this.trigger('set_state');
					return false;
				}
				return true;
			}
			return false;
		},
		/**
		 * refreshes the tree - all nodes are reloaded with calls to `load_node`.
		 * @name refresh()
		 * @param {Boolean} skip_loading an option to skip showing the loading indicator
		 * @param {Mixed} forget_state if set to `true` state will not be reapplied, if set to a function (receiving the current state as argument) the result of that function will be used as state
		 * @trigger refresh.jstree
		 */
		refresh : function (skip_loading, forget_state) {
			this._data.core.state = forget_state === true ? {} : this.get_state();
			if(forget_state && $.isFunction(forget_state)) { this._data.core.state = forget_state.call(this, this._data.core.state); }
			this._cnt = 0;
			this._model.data = {
				'#' : {
					id : '#',
					parent : null,
					parents : [],
					children : [],
					children_d : [],
					state : { loaded : false }
				}
			};
			var c = this.get_container_ul()[0].className;
			if(!skip_loading) {
				this.element.html("<"+"ul class='"+c+"' role='group'><"+"li class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='treeitem' id='j"+this._id+"_loading'><i class='jstree-icon jstree-ocl'></i><"+"a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'></i>" + this.get_string("Loading ...") + "</a></li></ul>");
				this.element.attr('aria-activedescendant','j'+this._id+'_loading');
			}
			this.load_node('#', function (o, s) {
				if(s) {
					this.get_container_ul()[0].className = c;
					if(this._firstChild(this.get_container_ul()[0])) {
						this.element.attr('aria-activedescendant',this._firstChild(this.get_container_ul()[0]).id);
					}
					this.set_state($.extend(true, {}, this._data.core.state), function () {
						/**
						 * triggered when a `refresh` call completes
						 * @event
						 * @name refresh.jstree
						 */
						this.trigger('refresh');
					});
				}
				this._data.core.state = null;
			});
		},
		/**
		 * refreshes a node in the tree (reload its children) all opened nodes inside that node are reloaded with calls to `load_node`.
		 * @name refresh_node(obj)
		 * @param  {mixed} obj the node
		 * @trigger refresh_node.jstree
		 */
		refresh_node : function (obj) {
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') { return false; }
			var opened = [], to_load = [], s = this._data.core.selected.concat([]);
			to_load.push(obj.id);
			if(obj.state.opened === true) { opened.push(obj.id); }
			this.get_node(obj, true).find('.jstree-open').each(function() { opened.push(this.id); });
			this._load_nodes(to_load, $.proxy(function (nodes) {
				this.open_node(opened, false, 0);
				this.select_node(this._data.core.selected);
				/**
				 * triggered when a node is refreshed
				 * @event
				 * @name refresh_node.jstree
				 * @param {Object} node - the refreshed node
				 * @param {Array} nodes - an array of the IDs of the nodes that were reloaded
				 */
				this.trigger('refresh_node', { 'node' : obj, 'nodes' : nodes });
			}, this));
		},
		/**
		 * set (change) the ID of a node
		 * @name set_id(obj, id)
		 * @param  {mixed} obj the node
		 * @param  {String} id the new ID
		 * @return {Boolean}
		 */
		set_id : function (obj, id) {
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') { return false; }
			var i, j, m = this._model.data;
			id = id.toString();
			// update parents (replace current ID with new one in children and children_d)
			m[obj.parent].children[$.inArray(obj.id, m[obj.parent].children)] = id;
			for(i = 0, j = obj.parents.length; i < j; i++) {
				m[obj.parents[i]].children_d[$.inArray(obj.id, m[obj.parents[i]].children_d)] = id;
			}
			// update children (replace current ID with new one in parent and parents)
			for(i = 0, j = obj.children.length; i < j; i++) {
				m[obj.children[i]].parent = id;
			}
			for(i = 0, j = obj.children_d.length; i < j; i++) {
				m[obj.children_d[i]].parents[$.inArray(obj.id, m[obj.children_d[i]].parents)] = id;
			}
			i = $.inArray(obj.id, this._data.core.selected);
			if(i !== -1) { this._data.core.selected[i] = id; }
			// update model and obj itself (obj.id, this._model.data[KEY])
			i = this.get_node(obj.id, true);
			if(i) {
				i.attr('id', id).children('.jstree-anchor').attr('id', id + '_anchor').end().attr('aria-labelledby', id + '_anchor');
				if(this.element.attr('aria-activedescendant') === obj.id) {
					this.element.attr('aria-activedescendant', id);
				}
			}
			delete m[obj.id];
			obj.id = id;
			obj.li_attr.id = id;
			m[id] = obj;
			return true;
		},
		/**
		 * get the text value of a node
		 * @name get_text(obj)
		 * @param  {mixed} obj the node
		 * @return {String}
		 */
		get_text : function (obj) {
			obj = this.get_node(obj);
			return (!obj || obj.id === '#') ? false : obj.text;
		},
		/**
		 * set the text value of a node. Used internally, please use `rename_node(obj, val)`.
		 * @private
		 * @name set_text(obj, val)
		 * @param  {mixed} obj the node, you can pass an array to set the text on multiple nodes
		 * @param  {String} val the new text value
		 * @return {Boolean}
		 * @trigger set_text.jstree
		 */
		set_text : function (obj, val) {
			var t1, t2;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.set_text(obj[t1], val);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') { return false; }
			obj.text = val;
			if(this.get_node(obj, true).length) {
				this.redraw_node(obj.id);
			}
			/**
			 * triggered when a node text value is changed
			 * @event
			 * @name set_text.jstree
			 * @param {Object} obj
			 * @param {String} text the new value
			 */
			this.trigger('set_text',{ "obj" : obj, "text" : val });
			return true;
		},
		/**
		 * gets a JSON representation of a node (or the whole tree)
		 * @name get_json([obj, options])
		 * @param  {mixed} obj
		 * @param  {Object} options
		 * @param  {Boolean} options.no_state do not return state information
		 * @param  {Boolean} options.no_id do not return ID
		 * @param  {Boolean} options.no_children do not include children
		 * @param  {Boolean} options.no_data do not include node data
		 * @param  {Boolean} options.flat return flat JSON instead of nested
		 * @return {Object}
		 */
		get_json : function (obj, options, flat) {
			obj = this.get_node(obj || '#');
			if(!obj) { return false; }
			if(options && options.flat && !flat) { flat = []; }
			var tmp = {
				'id' : obj.id,
				'text' : obj.text,
				'icon' : this.get_icon(obj),
				'li_attr' : $.extend(true, {}, obj.li_attr),
				'a_attr' : $.extend(true, {}, obj.a_attr),
				'state' : {},
				'data' : options && options.no_data ? false : $.extend(true, {}, obj.data)
				//( this.get_node(obj, true).length ? this.get_node(obj, true).data() : obj.data ),
			}, i, j;
			if(options && options.flat) {
				tmp.parent = obj.parent;
			}
			else {
				tmp.children = [];
			}
			if(!options || !options.no_state) {
				for(i in obj.state) {
					if(obj.state.hasOwnProperty(i)) {
						tmp.state[i] = obj.state[i];
					}
				}
			}
			if(options && options.no_id) {
				delete tmp.id;
				if(tmp.li_attr && tmp.li_attr.id) {
					delete tmp.li_attr.id;
				}
				if(tmp.a_attr && tmp.a_attr.id) {
					delete tmp.a_attr.id;
				}
			}
			if(options && options.flat && obj.id !== '#') {
				flat.push(tmp);
			}
			if(!options || !options.no_children) {
				for(i = 0, j = obj.children.length; i < j; i++) {
					if(options && options.flat) {
						this.get_json(obj.children[i], options, flat);
					}
					else {
						tmp.children.push(this.get_json(obj.children[i], options));
					}
				}
			}
			return options && options.flat ? flat : (obj.id === '#' ? tmp.children : tmp);
		},
		/**
		 * create a new node (do not confuse with load_node)
		 * @name create_node([obj, node, pos, callback, is_loaded])
		 * @param  {mixed}   par       the parent node (to create a root node use either "#" (string) or `null`)
		 * @param  {mixed}   node      the data for the new node (a valid JSON object, or a simple string with the name)
		 * @param  {mixed}   pos       the index at which to insert the node, "first" and "last" are also supported, default is "last"
		 * @param  {Function} callback a function to be called once the node is created
		 * @param  {Boolean} is_loaded internal argument indicating if the parent node was succesfully loaded
		 * @return {String}            the ID of the newly create node
		 * @trigger model.jstree, create_node.jstree
		 */
		create_node : function (par, node, pos, callback, is_loaded) {
			if(par === null) { par = "#"; }
			par = this.get_node(par);
			if(!par) { return false; }
			pos = pos === undefined ? "last" : pos;
			if(!pos.toString().match(/^(before|after)$/) && !is_loaded && !this.is_loaded(par)) {
				return this.load_node(par, function () { this.create_node(par, node, pos, callback, true); });
			}
			if(!node) { node = { "text" : this.get_string('New node') }; }
			if(typeof node === "string") { node = { "text" : node }; }
			if(node.text === undefined) { node.text = this.get_string('New node'); }
			var tmp, dpc, i, j;

			if(par.id === '#') {
				if(pos === "before") { pos = "first"; }
				if(pos === "after") { pos = "last"; }
			}
			switch(pos) {
				case "before":
					tmp = this.get_node(par.parent);
					pos = $.inArray(par.id, tmp.children);
					par = tmp;
					break;
				case "after" :
					tmp = this.get_node(par.parent);
					pos = $.inArray(par.id, tmp.children) + 1;
					par = tmp;
					break;
				case "inside":
				case "first":
					pos = 0;
					break;
				case "last":
					pos = par.children.length;
					break;
				default:
					if(!pos) { pos = 0; }
					break;
			}
			if(pos > par.children.length) { pos = par.children.length; }
			if(!node.id) { node.id = true; }
			if(!this.check("create_node", node, par, pos)) {
				this.settings.core.error.call(this, this._data.core.last_error);
				return false;
			}
			if(node.id === true) { delete node.id; }
			node = this._parse_model_from_json(node, par.id, par.parents.concat());
			if(!node) { return false; }
			tmp = this.get_node(node);
			dpc = [];
			dpc.push(node);
			dpc = dpc.concat(tmp.children_d);
			this.trigger('model', { "nodes" : dpc, "parent" : par.id });

			par.children_d = par.children_d.concat(dpc);
			for(i = 0, j = par.parents.length; i < j; i++) {
				this._model.data[par.parents[i]].children_d = this._model.data[par.parents[i]].children_d.concat(dpc);
			}
			node = tmp;
			tmp = [];
			for(i = 0, j = par.children.length; i < j; i++) {
				tmp[i >= pos ? i+1 : i] = par.children[i];
			}
			tmp[pos] = node.id;
			par.children = tmp;

			this.redraw_node(par, true);
			if(callback) { callback.call(this, this.get_node(node)); }
			/**
			 * triggered when a node is created
			 * @event
			 * @name create_node.jstree
			 * @param {Object} node
			 * @param {String} parent the parent's ID
			 * @param {Number} position the position of the new node among the parent's children
			 */
			this.trigger('create_node', { "node" : this.get_node(node), "parent" : par.id, "position" : pos });
			return node.id;
		},
		/**
		 * set the text value of a node
		 * @name rename_node(obj, val)
		 * @param  {mixed} obj the node, you can pass an array to rename multiple nodes to the same name
		 * @param  {String} val the new text value
		 * @return {Boolean}
		 * @trigger rename_node.jstree
		 */
		rename_node : function (obj, val) {
			var t1, t2, old;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.rename_node(obj[t1], val);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') { return false; }
			old = obj.text;
			if(!this.check("rename_node", obj, this.get_parent(obj), val)) {
				this.settings.core.error.call(this, this._data.core.last_error);
				return false;
			}
			this.set_text(obj, val); // .apply(this, Array.prototype.slice.call(arguments))
			/**
			 * triggered when a node is renamed
			 * @event
			 * @name rename_node.jstree
			 * @param {Object} node
			 * @param {String} text the new value
			 * @param {String} old the old value
			 */
			this.trigger('rename_node', { "node" : obj, "text" : val, "old" : old });
			return true;
		},
		/**
		 * remove a node
		 * @name delete_node(obj)
		 * @param  {mixed} obj the node, you can pass an array to delete multiple nodes
		 * @return {Boolean}
		 * @trigger delete_node.jstree, changed.jstree
		 */
		delete_node : function (obj) {
			var t1, t2, par, pos, tmp, i, j, k, l, c;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.delete_node(obj[t1]);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') { return false; }
			par = this.get_node(obj.parent);
			pos = $.inArray(obj.id, par.children);
			c = false;
			if(!this.check("delete_node", obj, par, pos)) {
				this.settings.core.error.call(this, this._data.core.last_error);
				return false;
			}
			if(pos !== -1) {
				par.children = $.vakata.array_remove(par.children, pos);
			}
			tmp = obj.children_d.concat([]);
			tmp.push(obj.id);
			for(k = 0, l = tmp.length; k < l; k++) {
				for(i = 0, j = obj.parents.length; i < j; i++) {
					pos = $.inArray(tmp[k], this._model.data[obj.parents[i]].children_d);
					if(pos !== -1) {
						this._model.data[obj.parents[i]].children_d = $.vakata.array_remove(this._model.data[obj.parents[i]].children_d, pos);
					}
				}
				if(this._model.data[tmp[k]].state.selected) {
					c = true;
					pos = $.inArray(tmp[k], this._data.core.selected);
					if(pos !== -1) {
						this._data.core.selected = $.vakata.array_remove(this._data.core.selected, pos);
					}
				}
			}
			/**
			 * triggered when a node is deleted
			 * @event
			 * @name delete_node.jstree
			 * @param {Object} node
			 * @param {String} parent the parent's ID
			 */
			this.trigger('delete_node', { "node" : obj, "parent" : par.id });
			if(c) {
				this.trigger('changed', { 'action' : 'delete_node', 'node' : obj, 'selected' : this._data.core.selected, 'parent' : par.id });
			}
			for(k = 0, l = tmp.length; k < l; k++) {
				delete this._model.data[tmp[k]];
			}
			this.redraw_node(par, true);
			return true;
		},
		/**
		 * check if an operation is premitted on the tree. Used internally.
		 * @private
		 * @name check(chk, obj, par, pos)
		 * @param  {String} chk the operation to check, can be "create_node", "rename_node", "delete_node", "copy_node" or "move_node"
		 * @param  {mixed} obj the node
		 * @param  {mixed} par the parent
		 * @param  {mixed} pos the position to insert at, or if "rename_node" - the new name
		 * @param  {mixed} more some various additional information, for example if a "move_node" operations is triggered by DND this will be the hovered node
		 * @return {Boolean}
		 */
		check : function (chk, obj, par, pos, more) {
			obj = obj && obj.id ? obj : this.get_node(obj);
			par = par && par.id ? par : this.get_node(par);
			var tmp = chk.match(/^move_node|copy_node|create_node$/i) ? par : obj,
				chc = this.settings.core.check_callback;
			if(chk === "move_node" || chk === "copy_node") {
				if((!more || !more.is_multi) && (obj.id === par.id || $.inArray(obj.id, par.children) === pos || $.inArray(par.id, obj.children_d) !== -1)) {
					this._data.core.last_error = { 'error' : 'check', 'plugin' : 'core', 'id' : 'core_01', 'reason' : 'Moving parent inside child', 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
					return false;
				}
			}
			if(tmp && tmp.data) { tmp = tmp.data; }
			if(tmp && tmp.functions && (tmp.functions[chk] === false || tmp.functions[chk] === true)) {
				if(tmp.functions[chk] === false) {
					this._data.core.last_error = { 'error' : 'check', 'plugin' : 'core', 'id' : 'core_02', 'reason' : 'Node data prevents function: ' + chk, 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
				}
				return tmp.functions[chk];
			}
			if(chc === false || ($.isFunction(chc) && chc.call(this, chk, obj, par, pos, more) === false) || (chc && chc[chk] === false)) {
				this._data.core.last_error = { 'error' : 'check', 'plugin' : 'core', 'id' : 'core_03', 'reason' : 'User config for core.check_callback prevents function: ' + chk, 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
				return false;
			}
			return true;
		},
		/**
		 * get the last error
		 * @name last_error()
		 * @return {Object}
		 */
		last_error : function () {
			return this._data.core.last_error;
		},
		/**
		 * move a node to a new parent
		 * @name move_node(obj, par [, pos, callback, is_loaded])
		 * @param  {mixed} obj the node to move, pass an array to move multiple nodes
		 * @param  {mixed} par the new parent
		 * @param  {mixed} pos the position to insert at (besides integer values, "first" and "last" are supported, as well as "before" and "after"), defaults to integer `0`
		 * @param  {function} callback a function to call once the move is completed, receives 3 arguments - the node, the new parent and the position
		 * @param  {Boolean} is_loaded internal parameter indicating if the parent node has been loaded
		 * @param  {Boolean} skip_redraw internal parameter indicating if the tree should be redrawn
		 * @param  {Boolean} instance internal parameter indicating if the node comes from another instance
		 * @trigger move_node.jstree
		 */
		move_node : function (obj, par, pos, callback, is_loaded, skip_redraw, origin) {
			var t1, t2, old_par, old_pos, new_par, old_ins, is_multi, dpc, tmp, i, j, k, l, p;

			par = this.get_node(par);
			pos = pos === undefined ? 0 : pos;
			if(!par) { return false; }
			if(!pos.toString().match(/^(before|after)$/) && !is_loaded && !this.is_loaded(par)) {
				return this.load_node(par, function () { this.move_node(obj, par, pos, callback, true, false, origin); });
			}

			if($.isArray(obj)) {
				if(obj.length === 1) {
					obj = obj[0];
				}
				else {
					//obj = obj.slice();
					for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
						if((tmp = this.move_node(obj[t1], par, pos, callback, is_loaded, false, origin))) {
							par = tmp;
							pos = "after";
						}
					}
					this.redraw();
					return true;
				}
			}
			obj = obj && obj.id ? obj : this.get_node(obj);

			if(!obj || obj.id === '#') { return false; }

			old_par = (obj.parent || '#').toString();
			new_par = (!pos.toString().match(/^(before|after)$/) || par.id === '#') ? par : this.get_node(par.parent);
			old_ins = origin ? origin : (this._model.data[obj.id] ? this : $.jstree.reference(obj.id));
			is_multi = !old_ins || !old_ins._id || (this._id !== old_ins._id);
			old_pos = old_ins && old_ins._id && old_par && old_ins._model.data[old_par] && old_ins._model.data[old_par].children ? $.inArray(obj.id, old_ins._model.data[old_par].children) : -1;
			if(old_ins && old_ins._id) {
				obj = old_ins._model.data[obj.id];
			}

			if(is_multi) {
				if((tmp = this.copy_node(obj, par, pos, callback, is_loaded, false, origin))) {
					if(old_ins) { old_ins.delete_node(obj); }
					return tmp;
				}
				return false;
			}
			//var m = this._model.data;
			if(par.id === '#') {
				if(pos === "before") { pos = "first"; }
				if(pos === "after") { pos = "last"; }
			}
			switch(pos) {
				case "before":
					pos = $.inArray(par.id, new_par.children);
					break;
				case "after" :
					pos = $.inArray(par.id, new_par.children) + 1;
					break;
				case "inside":
				case "first":
					pos = 0;
					break;
				case "last":
					pos = new_par.children.length;
					break;
				default:
					if(!pos) { pos = 0; }
					break;
			}
			if(pos > new_par.children.length) { pos = new_par.children.length; }
			if(!this.check("move_node", obj, new_par, pos, { 'core' : true, 'origin' : origin, 'is_multi' : (old_ins && old_ins._id && old_ins._id !== this._id), 'is_foreign' : (!old_ins || !old_ins._id) })) {
				this.settings.core.error.call(this, this._data.core.last_error);
				return false;
			}
			if(obj.parent === new_par.id) {
				dpc = new_par.children.concat();
				tmp = $.inArray(obj.id, dpc);
				if(tmp !== -1) {
					dpc = $.vakata.array_remove(dpc, tmp);
					if(pos > tmp) { pos--; }
				}
				tmp = [];
				for(i = 0, j = dpc.length; i < j; i++) {
					tmp[i >= pos ? i+1 : i] = dpc[i];
				}
				tmp[pos] = obj.id;
				new_par.children = tmp;
				this._node_changed(new_par.id);
				this.redraw(new_par.id === '#');
			}
			else {
				// clean old parent and up
				tmp = obj.children_d.concat();
				tmp.push(obj.id);
				for(i = 0, j = obj.parents.length; i < j; i++) {
					dpc = [];
					p = old_ins._model.data[obj.parents[i]].children_d;
					for(k = 0, l = p.length; k < l; k++) {
						if($.inArray(p[k], tmp) === -1) {
							dpc.push(p[k]);
						}
					}
					old_ins._model.data[obj.parents[i]].children_d = dpc;
				}
				old_ins._model.data[old_par].children = $.vakata.array_remove_item(old_ins._model.data[old_par].children, obj.id);

				// insert into new parent and up
				for(i = 0, j = new_par.parents.length; i < j; i++) {
					this._model.data[new_par.parents[i]].children_d = this._model.data[new_par.parents[i]].children_d.concat(tmp);
				}
				dpc = [];
				for(i = 0, j = new_par.children.length; i < j; i++) {
					dpc[i >= pos ? i+1 : i] = new_par.children[i];
				}
				dpc[pos] = obj.id;
				new_par.children = dpc;
				new_par.children_d.push(obj.id);
				new_par.children_d = new_par.children_d.concat(obj.children_d);

				// update object
				obj.parent = new_par.id;
				tmp = new_par.parents.concat();
				tmp.unshift(new_par.id);
				p = obj.parents.length;
				obj.parents = tmp;

				// update object children
				tmp = tmp.concat();
				for(i = 0, j = obj.children_d.length; i < j; i++) {
					this._model.data[obj.children_d[i]].parents = this._model.data[obj.children_d[i]].parents.slice(0,p*-1);
					Array.prototype.push.apply(this._model.data[obj.children_d[i]].parents, tmp);
				}

				if(old_par === '#' || new_par.id === '#') {
					this._model.force_full_redraw = true;
				}
				if(!this._model.force_full_redraw) {
					this._node_changed(old_par);
					this._node_changed(new_par.id);
				}
				if(!skip_redraw) {
					this.redraw();
				}
			}
			if(callback) { callback.call(this, obj, new_par, pos); }
			/**
			 * triggered when a node is moved
			 * @event
			 * @name move_node.jstree
			 * @param {Object} node
			 * @param {String} parent the parent's ID
			 * @param {Number} position the position of the node among the parent's children
			 * @param {String} old_parent the old parent of the node
			 * @param {Number} old_position the old position of the node
			 * @param {Boolean} is_multi do the node and new parent belong to different instances
			 * @param {jsTree} old_instance the instance the node came from
			 * @param {jsTree} new_instance the instance of the new parent
			 */
			this.trigger('move_node', { "node" : obj, "parent" : new_par.id, "position" : pos, "old_parent" : old_par, "old_position" : old_pos, 'is_multi' : (old_ins && old_ins._id && old_ins._id !== this._id), 'is_foreign' : (!old_ins || !old_ins._id), 'old_instance' : old_ins, 'new_instance' : this });
			return obj.id;
		},
		/**
		 * copy a node to a new parent
		 * @name copy_node(obj, par [, pos, callback, is_loaded])
		 * @param  {mixed} obj the node to copy, pass an array to copy multiple nodes
		 * @param  {mixed} par the new parent
		 * @param  {mixed} pos the position to insert at (besides integer values, "first" and "last" are supported, as well as "before" and "after"), defaults to integer `0`
		 * @param  {function} callback a function to call once the move is completed, receives 3 arguments - the node, the new parent and the position
		 * @param  {Boolean} is_loaded internal parameter indicating if the parent node has been loaded
		 * @param  {Boolean} skip_redraw internal parameter indicating if the tree should be redrawn
		 * @param  {Boolean} instance internal parameter indicating if the node comes from another instance
		 * @trigger model.jstree copy_node.jstree
		 */
		copy_node : function (obj, par, pos, callback, is_loaded, skip_redraw, origin) {
			var t1, t2, dpc, tmp, i, j, node, old_par, new_par, old_ins, is_multi;

			par = this.get_node(par);
			pos = pos === undefined ? 0 : pos;
			if(!par) { return false; }
			if(!pos.toString().match(/^(before|after)$/) && !is_loaded && !this.is_loaded(par)) {
				return this.load_node(par, function () { this.copy_node(obj, par, pos, callback, true, false, origin); });
			}

			if($.isArray(obj)) {
				if(obj.length === 1) {
					obj = obj[0];
				}
				else {
					//obj = obj.slice();
					for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
						if((tmp = this.copy_node(obj[t1], par, pos, callback, is_loaded, true, origin))) {
							par = tmp;
							pos = "after";
						}
					}
					this.redraw();
					return true;
				}
			}
			obj = obj && obj.id ? obj : this.get_node(obj);
			if(!obj || obj.id === '#') { return false; }

			old_par = (obj.parent || '#').toString();
			new_par = (!pos.toString().match(/^(before|after)$/) || par.id === '#') ? par : this.get_node(par.parent);
			old_ins = origin ? origin : (this._model.data[obj.id] ? this : $.jstree.reference(obj.id));
			is_multi = !old_ins || !old_ins._id || (this._id !== old_ins._id);

			if(old_ins && old_ins._id) {
				obj = old_ins._model.data[obj.id];
			}

			if(par.id === '#') {
				if(pos === "before") { pos = "first"; }
				if(pos === "after") { pos = "last"; }
			}
			switch(pos) {
				case "before":
					pos = $.inArray(par.id, new_par.children);
					break;
				case "after" :
					pos = $.inArray(par.id, new_par.children) + 1;
					break;
				case "inside":
				case "first":
					pos = 0;
					break;
				case "last":
					pos = new_par.children.length;
					break;
				default:
					if(!pos) { pos = 0; }
					break;
			}
			if(pos > new_par.children.length) { pos = new_par.children.length; }
			if(!this.check("copy_node", obj, new_par, pos, { 'core' : true, 'origin' : origin, 'is_multi' : (old_ins && old_ins._id && old_ins._id !== this._id), 'is_foreign' : (!old_ins || !old_ins._id) })) {
				this.settings.core.error.call(this, this._data.core.last_error);
				return false;
			}
			node = old_ins ? old_ins.get_json(obj, { no_id : true, no_data : true, no_state : true }) : obj;
			if(!node) { return false; }
			if(node.id === true) { delete node.id; }
			node = this._parse_model_from_json(node, new_par.id, new_par.parents.concat());
			if(!node) { return false; }
			tmp = this.get_node(node);
			if(obj && obj.state && obj.state.loaded === false) { tmp.state.loaded = false; }
			dpc = [];
			dpc.push(node);
			dpc = dpc.concat(tmp.children_d);
			this.trigger('model', { "nodes" : dpc, "parent" : new_par.id });

			// insert into new parent and up
			for(i = 0, j = new_par.parents.length; i < j; i++) {
				this._model.data[new_par.parents[i]].children_d = this._model.data[new_par.parents[i]].children_d.concat(dpc);
			}
			dpc = [];
			for(i = 0, j = new_par.children.length; i < j; i++) {
				dpc[i >= pos ? i+1 : i] = new_par.children[i];
			}
			dpc[pos] = tmp.id;
			new_par.children = dpc;
			new_par.children_d.push(tmp.id);
			new_par.children_d = new_par.children_d.concat(tmp.children_d);

			if(new_par.id === '#') {
				this._model.force_full_redraw = true;
			}
			if(!this._model.force_full_redraw) {
				this._node_changed(new_par.id);
			}
			if(!skip_redraw) {
				this.redraw(new_par.id === '#');
			}
			if(callback) { callback.call(this, tmp, new_par, pos); }
			/**
			 * triggered when a node is copied
			 * @event
			 * @name copy_node.jstree
			 * @param {Object} node the copied node
			 * @param {Object} original the original node
			 * @param {String} parent the parent's ID
			 * @param {Number} position the position of the node among the parent's children
			 * @param {String} old_parent the old parent of the node
			 * @param {Number} old_position the position of the original node
			 * @param {Boolean} is_multi do the node and new parent belong to different instances
			 * @param {jsTree} old_instance the instance the node came from
			 * @param {jsTree} new_instance the instance of the new parent
			 */
			this.trigger('copy_node', { "node" : tmp, "original" : obj, "parent" : new_par.id, "position" : pos, "old_parent" : old_par, "old_position" : old_ins && old_ins._id && old_par && old_ins._model.data[old_par] && old_ins._model.data[old_par].children ? $.inArray(obj.id, old_ins._model.data[old_par].children) : -1,'is_multi' : (old_ins && old_ins._id && old_ins._id !== this._id), 'is_foreign' : (!old_ins || !old_ins._id), 'old_instance' : old_ins, 'new_instance' : this });
			return tmp.id;
		},
		/**
		 * cut a node (a later call to `paste(obj)` would move the node)
		 * @name cut(obj)
		 * @param  {mixed} obj multiple objects can be passed using an array
		 * @trigger cut.jstree
		 */
		cut : function (obj) {
			if(!obj) { obj = this._data.core.selected.concat(); }
			if(!$.isArray(obj)) { obj = [obj]; }
			if(!obj.length) { return false; }
			var tmp = [], o, t1, t2;
			for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
				o = this.get_node(obj[t1]);
				if(o && o.id && o.id !== '#') { tmp.push(o); }
			}
			if(!tmp.length) { return false; }
			ccp_node = tmp;
			ccp_inst = this;
			ccp_mode = 'move_node';
			/**
			 * triggered when nodes are added to the buffer for moving
			 * @event
			 * @name cut.jstree
			 * @param {Array} node
			 */
			this.trigger('cut', { "node" : obj });
		},
		/**
		 * copy a node (a later call to `paste(obj)` would copy the node)
		 * @name copy(obj)
		 * @param  {mixed} obj multiple objects can be passed using an array
		 * @trigger copy.jstree
		 */
		copy : function (obj) {
			if(!obj) { obj = this._data.core.selected.concat(); }
			if(!$.isArray(obj)) { obj = [obj]; }
			if(!obj.length) { return false; }
			var tmp = [], o, t1, t2;
			for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
				o = this.get_node(obj[t1]);
				if(o && o.id && o.id !== '#') { tmp.push(o); }
			}
			if(!tmp.length) { return false; }
			ccp_node = tmp;
			ccp_inst = this;
			ccp_mode = 'copy_node';
			/**
			 * triggered when nodes are added to the buffer for copying
			 * @event
			 * @name copy.jstree
			 * @param {Array} node
			 */
			this.trigger('copy', { "node" : obj });
		},
		/**
		 * get the current buffer (any nodes that are waiting for a paste operation)
		 * @name get_buffer()
		 * @return {Object} an object consisting of `mode` ("copy_node" or "move_node"), `node` (an array of objects) and `inst` (the instance)
		 */
		get_buffer : function () {
			return { 'mode' : ccp_mode, 'node' : ccp_node, 'inst' : ccp_inst };
		},
		/**
		 * check if there is something in the buffer to paste
		 * @name can_paste()
		 * @return {Boolean}
		 */
		can_paste : function () {
			return ccp_mode !== false && ccp_node !== false; // && ccp_inst._model.data[ccp_node];
		},
		/**
		 * copy or move the previously cut or copied nodes to a new parent
		 * @name paste(obj [, pos])
		 * @param  {mixed} obj the new parent
		 * @param  {mixed} pos the position to insert at (besides integer, "first" and "last" are supported), defaults to integer `0`
		 * @trigger paste.jstree
		 */
		paste : function (obj, pos) {
			obj = this.get_node(obj);
			if(!obj || !ccp_mode || !ccp_mode.match(/^(copy_node|move_node)$/) || !ccp_node) { return false; }
			if(this[ccp_mode](ccp_node, obj, pos, false, false, false, ccp_inst)) {
				/**
				 * triggered when paste is invoked
				 * @event
				 * @name paste.jstree
				 * @param {String} parent the ID of the receiving node
				 * @param {Array} node the nodes in the buffer
				 * @param {String} mode the performed operation - "copy_node" or "move_node"
				 */
				this.trigger('paste', { "parent" : obj.id, "node" : ccp_node, "mode" : ccp_mode });
			}
			ccp_node = false;
			ccp_mode = false;
			ccp_inst = false;
		},
		/**
		 * clear the buffer of previously copied or cut nodes
		 * @name clear_buffer()
		 * @trigger clear_buffer.jstree
		 */
		clear_buffer : function () {
			ccp_node = false;
			ccp_mode = false;
			ccp_inst = false;
			/**
			 * triggered when the copy / cut buffer is cleared
			 * @event
			 * @name clear_buffer.jstree
			 */
			this.trigger('clear_buffer');
		},
		/**
		 * put a node in edit mode (input field to rename the node)
		 * @name edit(obj [, default_text, callback])
		 * @param  {mixed} obj
		 * @param  {String} default_text the text to populate the input with (if omitted or set to a non-string value the node's text value is used)
		 * @param  {Function} callback a function to be called once the text box is blurred, it is called in the instance's scope and receives the node and a status parameter - true if the rename is successful, false otherwise. You can access the node's title using .text
		 */
		edit : function (obj, default_text, callback) {
			var rtl, w, a, s, t, h1, h2, fn, tmp;
			obj = this.get_node(obj);
			if(!obj) { return false; }
			if(this.settings.core.check_callback === false) {
				this._data.core.last_error = { 'error' : 'check', 'plugin' : 'core', 'id' : 'core_07', 'reason' : 'Could not edit node because of check_callback' };
				this.settings.core.error.call(this, this._data.core.last_error);
				return false;
			}
			tmp = obj;
			default_text = typeof default_text === 'string' ? default_text : obj.text;
			this.set_text(obj, "");
			obj = this._open_to(obj);
			tmp.text = default_text;

			rtl = this._data.core.rtl;
			w  = this.element.width();
			a  = obj.children('.jstree-anchor');
			s  = $('<span>');
			/*!
			oi = obj.children("i:visible"),
			ai = a.children("i:visible"),
			w1 = oi.width() * oi.length,
			w2 = ai.width() * ai.length,
			*/
			t  = default_text;
			h1 = $("<"+"div />", { css : { "position" : "absolute", "top" : "-200px", "left" : (rtl ? "0px" : "-1000px"), "visibility" : "hidden" } }).appendTo("body");
			h2 = $("<"+"input />", {
						"value" : t,
						"class" : "jstree-rename-input",
						// "size" : t.length,
						"css" : {
							"padding" : "0",
							"border" : "1px solid silver",
							"box-sizing" : "border-box",
							"display" : "inline-block",
							"height" : (this._data.core.li_height) + "px",
							"lineHeight" : (this._data.core.li_height) + "px",
							"width" : "150px" // will be set a bit further down
						},
						"blur" : $.proxy(function () {
							var i = s.children(".jstree-rename-input"),
								v = i.val(),
								f = this.settings.core.force_text,
								nv;
							if(v === "") { v = t; }
							h1.remove();
							s.replaceWith(a);
							s.remove();
							t = f ? t : $('<div></div>').append($.parseHTML(t)).html();
							this.set_text(obj, t);
							nv = !!this.rename_node(obj, f ? $('<div></div>').text(v).text() : $('<div></div>').append($.parseHTML(v)).html());
							if(!nv) {
								this.set_text(obj, t); // move this up? and fix #483
							}
							if(callback) {
								callback.call(this, tmp, nv);
							}
						}, this),
						"keydown" : function (event) {
							var key = event.which;
							if(key === 27) {
								this.value = t;
							}
							if(key === 27 || key === 13 || key === 37 || key === 38 || key === 39 || key === 40 || key === 32) {
								event.stopImmediatePropagation();
							}
							if(key === 27 || key === 13) {
								event.preventDefault();
								this.blur();
							}
						},
						"click" : function (e) { e.stopImmediatePropagation(); },
						"mousedown" : function (e) { e.stopImmediatePropagation(); },
						"keyup" : function (event) {
							h2.width(Math.min(h1.text("pW" + this.value).width(),w));
						},
						"keypress" : function(event) {
							if(event.which === 13) { return false; }
						}
					});
				fn = {
						fontFamily		: a.css('fontFamily')		|| '',
						fontSize		: a.css('fontSize')			|| '',
						fontWeight		: a.css('fontWeight')		|| '',
						fontStyle		: a.css('fontStyle')		|| '',
						fontStretch		: a.css('fontStretch')		|| '',
						fontVariant		: a.css('fontVariant')		|| '',
						letterSpacing	: a.css('letterSpacing')	|| '',
						wordSpacing		: a.css('wordSpacing')		|| ''
				};
			s.attr('class', a.attr('class')).append(a.contents().clone()).append(h2);
			a.replaceWith(s);
			h1.css(fn);
			h2.css(fn).width(Math.min(h1.text("pW" + h2[0].value).width(),w))[0].select();
		},


		/**
		 * changes the theme
		 * @name set_theme(theme_name [, theme_url])
		 * @param {String} theme_name the name of the new theme to apply
		 * @param {mixed} theme_url  the location of the CSS file for this theme. Omit or set to `false` if you manually included the file. Set to `true` to autoload from the `core.themes.dir` directory.
		 * @trigger set_theme.jstree
		 */
		set_theme : function (theme_name, theme_url) {
			if(!theme_name) { return false; }
			if(theme_url === true) {
				var dir = this.settings.core.themes.dir;
				if(!dir) { dir = $.jstree.path + '/themes'; }
				theme_url = dir + '/' + theme_name + '/style.css';
			}
			if(theme_url && $.inArray(theme_url, themes_loaded) === -1) {
				$('head').append('<'+'link rel="stylesheet" href="' + theme_url + '" type="text/css" />');
				themes_loaded.push(theme_url);
			}
			if(this._data.core.themes.name) {
				this.element.removeClass('jstree-' + this._data.core.themes.name);
			}
			this._data.core.themes.name = theme_name;
			this.element.addClass('jstree-' + theme_name);
			this.element[this.settings.core.themes.responsive ? 'addClass' : 'removeClass' ]('jstree-' + theme_name + '-responsive');
			/**
			 * triggered when a theme is set
			 * @event
			 * @name set_theme.jstree
			 * @param {String} theme the new theme
			 */
			this.trigger('set_theme', { 'theme' : theme_name });
		},
		/**
		 * gets the name of the currently applied theme name
		 * @name get_theme()
		 * @return {String}
		 */
		get_theme : function () { return this._data.core.themes.name; },
		/**
		 * changes the theme variant (if the theme has variants)
		 * @name set_theme_variant(variant_name)
		 * @param {String|Boolean} variant_name the variant to apply (if `false` is used the current variant is removed)
		 */
		set_theme_variant : function (variant_name) {
			if(this._data.core.themes.variant) {
				this.element.removeClass('jstree-' + this._data.core.themes.name + '-' + this._data.core.themes.variant);
			}
			this._data.core.themes.variant = variant_name;
			if(variant_name) {
				this.element.addClass('jstree-' + this._data.core.themes.name + '-' + this._data.core.themes.variant);
			}
		},
		/**
		 * gets the name of the currently applied theme variant
		 * @name get_theme()
		 * @return {String}
		 */
		get_theme_variant : function () { return this._data.core.themes.variant; },
		/**
		 * shows a striped background on the container (if the theme supports it)
		 * @name show_stripes()
		 */
		show_stripes : function () { this._data.core.themes.stripes = true; this.get_container_ul().addClass("jstree-striped"); },
		/**
		 * hides the striped background on the container
		 * @name hide_stripes()
		 */
		hide_stripes : function () { this._data.core.themes.stripes = false; this.get_container_ul().removeClass("jstree-striped"); },
		/**
		 * toggles the striped background on the container
		 * @name toggle_stripes()
		 */
		toggle_stripes : function () { if(this._data.core.themes.stripes) { this.hide_stripes(); } else { this.show_stripes(); } },
		/**
		 * shows the connecting dots (if the theme supports it)
		 * @name show_dots()
		 */
		show_dots : function () { this._data.core.themes.dots = true; this.get_container_ul().removeClass("jstree-no-dots"); },
		/**
		 * hides the connecting dots
		 * @name hide_dots()
		 */
		hide_dots : function () { this._data.core.themes.dots = false; this.get_container_ul().addClass("jstree-no-dots"); },
		/**
		 * toggles the connecting dots
		 * @name toggle_dots()
		 */
		toggle_dots : function () { if(this._data.core.themes.dots) { this.hide_dots(); } else { this.show_dots(); } },
		/**
		 * show the node icons
		 * @name show_icons()
		 */
		show_icons : function () { this._data.core.themes.icons = true; this.get_container_ul().removeClass("jstree-no-icons"); },
		/**
		 * hide the node icons
		 * @name hide_icons()
		 */
		hide_icons : function () { this._data.core.themes.icons = false; this.get_container_ul().addClass("jstree-no-icons"); },
		/**
		 * toggle the node icons
		 * @name toggle_icons()
		 */
		toggle_icons : function () { if(this._data.core.themes.icons) { this.hide_icons(); } else { this.show_icons(); } },
		/**
		 * set the node icon for a node
		 * @name set_icon(obj, icon)
		 * @param {mixed} obj
		 * @param {String} icon the new icon - can be a path to an icon or a className, if using an image that is in the current directory use a `./` prefix, otherwise it will be detected as a class
		 */
		set_icon : function (obj, icon) {
			var t1, t2, dom, old;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.set_icon(obj[t1], icon);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') { return false; }
			old = obj.icon;
			obj.icon = icon === true || icon === null || icon === undefined || icon === '' ? true : icon;
			dom = this.get_node(obj, true).children(".jstree-anchor").children(".jstree-themeicon");
			if(icon === false) {
				this.hide_icon(obj);
			}
			else if(icon === true || icon === null || icon === undefined || icon === '') {
				dom.removeClass('jstree-themeicon-custom ' + old).css("background","").removeAttr("rel");
				if(old === false) { this.show_icon(obj); }
			}
			else if(icon.indexOf("/") === -1 && icon.indexOf(".") === -1) {
				dom.removeClass(old).css("background","");
				dom.addClass(icon + ' jstree-themeicon-custom').attr("rel",icon);
				if(old === false) { this.show_icon(obj); }
			}
			else {
				dom.removeClass(old).css("background","");
				dom.addClass('jstree-themeicon-custom').css("background", "url('" + icon + "') center center no-repeat").attr("rel",icon);
				if(old === false) { this.show_icon(obj); }
			}
			return true;
		},
		/**
		 * get the node icon for a node
		 * @name get_icon(obj)
		 * @param {mixed} obj
		 * @return {String}
		 */
		get_icon : function (obj) {
			obj = this.get_node(obj);
			return (!obj || obj.id === '#') ? false : obj.icon;
		},
		/**
		 * hide the icon on an individual node
		 * @name hide_icon(obj)
		 * @param {mixed} obj
		 */
		hide_icon : function (obj) {
			var t1, t2;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.hide_icon(obj[t1]);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj === '#') { return false; }
			obj.icon = false;
			this.get_node(obj, true).children(".jstree-anchor").children(".jstree-themeicon").addClass('jstree-themeicon-hidden');
			return true;
		},
		/**
		 * show the icon on an individual node
		 * @name show_icon(obj)
		 * @param {mixed} obj
		 */
		show_icon : function (obj) {
			var t1, t2, dom;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.show_icon(obj[t1]);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj === '#') { return false; }
			dom = this.get_node(obj, true);
			obj.icon = dom.length ? dom.children(".jstree-anchor").children(".jstree-themeicon").attr('rel') : true;
			if(!obj.icon) { obj.icon = true; }
			dom.children(".jstree-anchor").children(".jstree-themeicon").removeClass('jstree-themeicon-hidden');
			return true;
		}
	};

	// helpers
	$.vakata = {};
	// collect attributes
	$.vakata.attributes = function(node, with_values) {
		node = $(node)[0];
		var attr = with_values ? {} : [];
		if(node && node.attributes) {
			$.each(node.attributes, function (i, v) {
				if($.inArray(v.name.toLowerCase(),['style','contenteditable','hasfocus','tabindex']) !== -1) { return; }
				if(v.value !== null && $.trim(v.value) !== '') {
					if(with_values) { attr[v.name] = v.value; }
					else { attr.push(v.name); }
				}
			});
		}
		return attr;
	};
	$.vakata.array_unique = function(array) {
		var a = [], i, j, l, o = {};
		for(i = 0, l = array.length; i < l; i++) {
			if(o[array[i]] === undefined) {
				a.push(array[i]);
				o[array[i]] = true;
			}
		}
		return a;
	};
	// remove item from array
	$.vakata.array_remove = function(array, from, to) {
		var rest = array.slice((to || from) + 1 || array.length);
		array.length = from < 0 ? array.length + from : from;
		array.push.apply(array, rest);
		return array;
	};
	// remove item from array
	$.vakata.array_remove_item = function(array, item) {
		var tmp = $.inArray(item, array);
		return tmp !== -1 ? $.vakata.array_remove(array, tmp) : array;
	};


/**
 * ### Checkbox plugin
 *
 * This plugin renders checkbox icons in front of each node, making multiple selection much easier.
 * It also supports tri-state behavior, meaning that if a node has a few of its children checked it will be rendered as undetermined, and state will be propagated up.
 */

	var _i = document.createElement('I');
	_i.className = 'jstree-icon jstree-checkbox';
	_i.setAttribute('role', 'presentation');
	/**
	 * stores all defaults for the checkbox plugin
	 * @name $.jstree.defaults.checkbox
	 * @plugin checkbox
	 */
	$.jstree.defaults.checkbox = {
		/**
		 * a boolean indicating if checkboxes should be visible (can be changed at a later time using `show_checkboxes()` and `hide_checkboxes`). Defaults to `true`.
		 * @name $.jstree.defaults.checkbox.visible
		 * @plugin checkbox
		 */
		visible				: true,
		/**
		 * a boolean indicating if checkboxes should cascade down and have an undetermined state. Defaults to `true`.
		 * @name $.jstree.defaults.checkbox.three_state
		 * @plugin checkbox
		 */
		three_state			: true,
		/**
		 * a boolean indicating if clicking anywhere on the node should act as clicking on the checkbox. Defaults to `true`.
		 * @name $.jstree.defaults.checkbox.whole_node
		 * @plugin checkbox
		 */
		whole_node			: true,
		/**
		 * a boolean indicating if the selected style of a node should be kept, or removed. Defaults to `true`.
		 * @name $.jstree.defaults.checkbox.keep_selected_style
		 * @plugin checkbox
		 */
		keep_selected_style	: true,
		/**
		 * This setting controls how cascading and undetermined nodes are applied.
		 * If 'up' is in the string - cascading up is enabled, if 'down' is in the string - cascading down is enabled, if 'undetermined' is in the string - undetermined nodes will be used.
		 * If `three_state` is set to `true` this setting is automatically set to 'up+down+undetermined'. Defaults to ''.
		 * @name $.jstree.defaults.checkbox.cascade
		 * @plugin checkbox
		 */
		cascade				: '',
		/**
		 * This setting controls if checkbox are bound to the general tree selection or to an internal array maintained by the checkbox plugin. Defaults to `true`, only set to `false` if you know exactly what you are doing.
		 * @name $.jstree.defaults.checkbox.tie_selection
		 * @plugin checkbox
		 */
		tie_selection		: true
	};
	$.jstree.plugins.checkbox = function (options, parent) {
		this.bind = function () {
			parent.bind.call(this);
			this._data.checkbox.uto = false;
			this._data.checkbox.selected = [];
			if(this.settings.checkbox.three_state) {
				this.settings.checkbox.cascade = 'up+down+undetermined';
			}
			this.element
				.on("init.jstree", $.proxy(function () {
						this._data.checkbox.visible = this.settings.checkbox.visible;
						if(!this.settings.checkbox.keep_selected_style) {
							this.element.addClass('jstree-checkbox-no-clicked');
						}
						if(this.settings.checkbox.tie_selection) {
							this.element.addClass('jstree-checkbox-selection');
						}
					}, this))
				.on("loading.jstree", $.proxy(function () {
						this[ this._data.checkbox.visible ? 'show_checkboxes' : 'hide_checkboxes' ]();
					}, this));
			if(this.settings.checkbox.cascade.indexOf('undetermined') !== -1) {
				this.element
					.on('changed.jstree uncheck_node.jstree check_node.jstree uncheck_all.jstree check_all.jstree move_node.jstree copy_node.jstree redraw.jstree open_node.jstree', $.proxy(function () {
							// only if undetermined is in setting
							if(this._data.checkbox.uto) { clearTimeout(this._data.checkbox.uto); }
							this._data.checkbox.uto = setTimeout($.proxy(this._undetermined, this), 50);
						}, this));
			}
			if(!this.settings.checkbox.tie_selection) {
				this.element
					.on('model.jstree', $.proxy(function (e, data) {
						var m = this._model.data,
							p = m[data.parent],
							dpc = data.nodes,
							i, j;
						for(i = 0, j = dpc.length; i < j; i++) {
							m[dpc[i]].state.checked = (m[dpc[i]].original && m[dpc[i]].original.state && m[dpc[i]].original.state.checked);
							if(m[dpc[i]].state.checked) {
								this._data.checkbox.selected.push(dpc[i]);
							}
						}
					}, this));
			}
			if(this.settings.checkbox.cascade.indexOf('up') !== -1 || this.settings.checkbox.cascade.indexOf('down') !== -1) {
				this.element
					.on('model.jstree', $.proxy(function (e, data) {
							var m = this._model.data,
								p = m[data.parent],
								dpc = data.nodes,
								chd = [],
								c, i, j, k, l, tmp, s = this.settings.checkbox.cascade, t = this.settings.checkbox.tie_selection;

							if(s.indexOf('down') !== -1) {
								// apply down
								if(p.state[ t ? 'selected' : 'checked' ]) {
									for(i = 0, j = dpc.length; i < j; i++) {
										m[dpc[i]].state[ t ? 'selected' : 'checked' ] = true;
									}
									this._data[ t ? 'core' : 'checkbox' ].selected = this._data[ t ? 'core' : 'checkbox' ].selected.concat(dpc);
								}
								else {
									for(i = 0, j = dpc.length; i < j; i++) {
										if(m[dpc[i]].state[ t ? 'selected' : 'checked' ]) {
											for(k = 0, l = m[dpc[i]].children_d.length; k < l; k++) {
												m[m[dpc[i]].children_d[k]].state[ t ? 'selected' : 'checked' ] = true;
											}
											this._data[ t ? 'core' : 'checkbox' ].selected = this._data[ t ? 'core' : 'checkbox' ].selected.concat(m[dpc[i]].children_d);
										}
									}
								}
							}

							if(s.indexOf('up') !== -1) {
								// apply up
								for(i = 0, j = p.children_d.length; i < j; i++) {
									if(!m[p.children_d[i]].children.length) {
										chd.push(m[p.children_d[i]].parent);
									}
								}
								chd = $.vakata.array_unique(chd);
								for(k = 0, l = chd.length; k < l; k++) {
									p = m[chd[k]];
									while(p && p.id !== '#') {
										c = 0;
										for(i = 0, j = p.children.length; i < j; i++) {
											c += m[p.children[i]].state[ t ? 'selected' : 'checked' ];
										}
										if(c === j) {
											p.state[ t ? 'selected' : 'checked' ] = true;
											this._data[ t ? 'core' : 'checkbox' ].selected.push(p.id);
											tmp = this.get_node(p, true);
											if(tmp && tmp.length) {
												tmp.attr('aria-selected', true).children('.jstree-anchor').addClass( t ? 'jstree-clicked' : 'jstree-checked');
											}
										}
										else {
											break;
										}
										p = this.get_node(p.parent);
									}
								}
							}

							this._data[ t ? 'core' : 'checkbox' ].selected = $.vakata.array_unique(this._data[ t ? 'core' : 'checkbox' ].selected);
						}, this))
					.on(this.settings.checkbox.tie_selection ? 'select_node.jstree' : 'check_node.jstree', $.proxy(function (e, data) {
							var obj = data.node,
								m = this._model.data,
								par = this.get_node(obj.parent),
								dom = this.get_node(obj, true),
								i, j, c, tmp, s = this.settings.checkbox.cascade, t = this.settings.checkbox.tie_selection;

							// apply down
							if(s.indexOf('down') !== -1) {
								this._data[ t ? 'core' : 'checkbox' ].selected = $.vakata.array_unique(this._data[ t ? 'core' : 'checkbox' ].selected.concat(obj.children_d));
								for(i = 0, j = obj.children_d.length; i < j; i++) {
									tmp = m[obj.children_d[i]];
									tmp.state[ t ? 'selected' : 'checked' ] = true;
									if(tmp && tmp.original && tmp.original.state && tmp.original.state.undetermined) {
										tmp.original.state.undetermined = false;
									}
								}
							}

							// apply up
							if(s.indexOf('up') !== -1) {
								while(par && par.id !== '#') {
									c = 0;
									for(i = 0, j = par.children.length; i < j; i++) {
										c += m[par.children[i]].state[ t ? 'selected' : 'checked' ];
									}
									if(c === j) {
										par.state[ t ? 'selected' : 'checked' ] = true;
										this._data[ t ? 'core' : 'checkbox' ].selected.push(par.id);
										tmp = this.get_node(par, true);
										if(tmp && tmp.length) {
											tmp.attr('aria-selected', true).children('.jstree-anchor').addClass(t ? 'jstree-clicked' : 'jstree-checked');
										}
									}
									else {
										break;
									}
									par = this.get_node(par.parent);
								}
							}

							// apply down (process .children separately?)
							if(s.indexOf('down') !== -1 && dom.length) {
								dom.find('.jstree-anchor').addClass(t ? 'jstree-clicked' : 'jstree-checked').parent().attr('aria-selected', true);
							}
						}, this))
					.on(this.settings.checkbox.tie_selection ? 'deselect_all.jstree' : 'uncheck_all.jstree', $.proxy(function (e, data) {
							var obj = this.get_node('#'),
								m = this._model.data,
								i, j, tmp;
							for(i = 0, j = obj.children_d.length; i < j; i++) {
								tmp = m[obj.children_d[i]];
								if(tmp && tmp.original && tmp.original.state && tmp.original.state.undetermined) {
									tmp.original.state.undetermined = false;
								}
							}
						}, this))
					.on(this.settings.checkbox.tie_selection ? 'deselect_node.jstree' : 'uncheck_node.jstree', $.proxy(function (e, data) {
							var obj = data.node,
								dom = this.get_node(obj, true),
								i, j, tmp, s = this.settings.checkbox.cascade, t = this.settings.checkbox.tie_selection;
							if(obj && obj.original && obj.original.state && obj.original.state.undetermined) {
								obj.original.state.undetermined = false;
							}

							// apply down
							if(s.indexOf('down') !== -1) {
								for(i = 0, j = obj.children_d.length; i < j; i++) {
									tmp = this._model.data[obj.children_d[i]];
									tmp.state[ t ? 'selected' : 'checked' ] = false;
									if(tmp && tmp.original && tmp.original.state && tmp.original.state.undetermined) {
										tmp.original.state.undetermined = false;
									}
								}
							}

							// apply up
							if(s.indexOf('up') !== -1) {
								for(i = 0, j = obj.parents.length; i < j; i++) {
									tmp = this._model.data[obj.parents[i]];
									tmp.state[ t ? 'selected' : 'checked' ] = false;
									if(tmp && tmp.original && tmp.original.state && tmp.original.state.undetermined) {
										tmp.original.state.undetermined = false;
									}
									tmp = this.get_node(obj.parents[i], true);
									if(tmp && tmp.length) {
										tmp.attr('aria-selected', false).children('.jstree-anchor').removeClass(t ? 'jstree-clicked' : 'jstree-checked');
									}
								}
							}
							tmp = [];
							for(i = 0, j = this._data[ t ? 'core' : 'checkbox' ].selected.length; i < j; i++) {
								// apply down + apply up
								if(
									(s.indexOf('down') === -1 || $.inArray(this._data[ t ? 'core' : 'checkbox' ].selected[i], obj.children_d) === -1) &&
									(s.indexOf('up') === -1 || $.inArray(this._data[ t ? 'core' : 'checkbox' ].selected[i], obj.parents) === -1)
								) {
									tmp.push(this._data[ t ? 'core' : 'checkbox' ].selected[i]);
								}
							}
							this._data[ t ? 'core' : 'checkbox' ].selected = $.vakata.array_unique(tmp);

							// apply down (process .children separately?)
							if(s.indexOf('down') !== -1 && dom.length) {
								dom.find('.jstree-anchor').removeClass(t ? 'jstree-clicked' : 'jstree-checked').parent().attr('aria-selected', false);
							}
						}, this));
			}
			if(this.settings.checkbox.cascade.indexOf('up') !== -1) {
				this.element
					.on('delete_node.jstree', $.proxy(function (e, data) {
							// apply up (whole handler)
							var p = this.get_node(data.parent),
								m = this._model.data,
								i, j, c, tmp, t = this.settings.checkbox.tie_selection;
							while(p && p.id !== '#') {
								c = 0;
								for(i = 0, j = p.children.length; i < j; i++) {
									c += m[p.children[i]].state[ t ? 'selected' : 'checked' ];
								}
								if(c === j) {
									p.state[ t ? 'selected' : 'checked' ] = true;
									this._data[ t ? 'core' : 'checkbox' ].selected.push(p.id);
									tmp = this.get_node(p, true);
									if(tmp && tmp.length) {
										tmp.attr('aria-selected', true).children('.jstree-anchor').addClass(t ? 'jstree-clicked' : 'jstree-checked');
									}
								}
								else {
									break;
								}
								p = this.get_node(p.parent);
							}
						}, this))
					.on('move_node.jstree', $.proxy(function (e, data) {
							// apply up (whole handler)
							var is_multi = data.is_multi,
								old_par = data.old_parent,
								new_par = this.get_node(data.parent),
								m = this._model.data,
								p, c, i, j, tmp, t = this.settings.checkbox.tie_selection;
							if(!is_multi) {
								p = this.get_node(old_par);
								while(p && p.id !== '#') {
									c = 0;
									for(i = 0, j = p.children.length; i < j; i++) {
										c += m[p.children[i]].state[ t ? 'selected' : 'checked' ];
									}
									if(c === j) {
										p.state[ t ? 'selected' : 'checked' ] = true;
										this._data[ t ? 'core' : 'checkbox' ].selected.push(p.id);
										tmp = this.get_node(p, true);
										if(tmp && tmp.length) {
											tmp.attr('aria-selected', true).children('.jstree-anchor').addClass(t ? 'jstree-clicked' : 'jstree-checked');
										}
									}
									else {
										break;
									}
									p = this.get_node(p.parent);
								}
							}
							p = new_par;
							while(p && p.id !== '#') {
								c = 0;
								for(i = 0, j = p.children.length; i < j; i++) {
									c += m[p.children[i]].state[ t ? 'selected' : 'checked' ];
								}
								if(c === j) {
									if(!p.state[ t ? 'selected' : 'checked' ]) {
										p.state[ t ? 'selected' : 'checked' ] = true;
										this._data[ t ? 'core' : 'checkbox' ].selected.push(p.id);
										tmp = this.get_node(p, true);
										if(tmp && tmp.length) {
											tmp.attr('aria-selected', true).children('.jstree-anchor').addClass(t ? 'jstree-clicked' : 'jstree-checked');
										}
									}
								}
								else {
									if(p.state[ t ? 'selected' : 'checked' ]) {
										p.state[ t ? 'selected' : 'checked' ] = false;
										this._data[ t ? 'core' : 'checkbox' ].selected = $.vakata.array_remove_item(this._data[ t ? 'core' : 'checkbox' ].selected, p.id);
										tmp = this.get_node(p, true);
										if(tmp && tmp.length) {
											tmp.attr('aria-selected', false).children('.jstree-anchor').removeClass(t ? 'jstree-clicked' : 'jstree-checked');
										}
									}
									else {
										break;
									}
								}
								p = this.get_node(p.parent);
							}
						}, this));
			}
		};
		/**
		 * set the undetermined state where and if necessary. Used internally.
		 * @private
		 * @name _undetermined()
		 * @plugin checkbox
		 */
		this._undetermined = function () {
			if(this.element === null) { return; }
			var i, j, k, l, o = {}, m = this._model.data, t = this.settings.checkbox.tie_selection, s = this._data[ t ? 'core' : 'checkbox' ].selected, p = [], tt = this;
			for(i = 0, j = s.length; i < j; i++) {
				if(m[s[i]] && m[s[i]].parents) {
					for(k = 0, l = m[s[i]].parents.length; k < l; k++) {
						if(o[m[s[i]].parents[k]] === undefined && m[s[i]].parents[k] !== '#') {
							o[m[s[i]].parents[k]] = true;
							p.push(m[s[i]].parents[k]);
						}
					}
				}
			}
			// attempt for server side undetermined state
			this.element.find('.jstree-closed').not(':has(.jstree-children)')
				.each(function () {
					var tmp = tt.get_node(this), tmp2;
					if(!tmp.state.loaded) {
						if(tmp.original && tmp.original.state && tmp.original.state.undetermined && tmp.original.state.undetermined === true) {
							if(o[tmp.id] === undefined && tmp.id !== '#') {
								o[tmp.id] = true;
								p.push(tmp.id);
							}
							for(k = 0, l = tmp.parents.length; k < l; k++) {
								if(o[tmp.parents[k]] === undefined && tmp.parents[k] !== '#') {
									o[tmp.parents[k]] = true;
									p.push(tmp.parents[k]);
								}
							}
						}
					}
					else {
						for(i = 0, j = tmp.children_d.length; i < j; i++) {
							tmp2 = m[tmp.children_d[i]];
							if(!tmp2.state.loaded && tmp2.original && tmp2.original.state && tmp2.original.state.undetermined && tmp2.original.state.undetermined === true) {
								if(o[tmp2.id] === undefined && tmp2.id !== '#') {
									o[tmp2.id] = true;
									p.push(tmp2.id);
								}
								for(k = 0, l = tmp2.parents.length; k < l; k++) {
									if(o[tmp2.parents[k]] === undefined && tmp2.parents[k] !== '#') {
										o[tmp2.parents[k]] = true;
										p.push(tmp2.parents[k]);
									}
								}
							}
						}
					}
				});

			this.element.find('.jstree-undetermined').removeClass('jstree-undetermined');
			for(i = 0, j = p.length; i < j; i++) {
				if(!m[p[i]].state[ t ? 'selected' : 'checked' ]) {
					s = this.get_node(p[i], true);
					if(s && s.length) {
						s.children('.jstree-anchor').children('.jstree-checkbox').addClass('jstree-undetermined');
					}
				}
			}
		};
		this.redraw_node = function(obj, deep, is_callback, force_render) {
			obj = parent.redraw_node.apply(this, arguments);
			if(obj) {
				var i, j, tmp = null;
				for(i = 0, j = obj.childNodes.length; i < j; i++) {
					if(obj.childNodes[i] && obj.childNodes[i].className && obj.childNodes[i].className.indexOf("jstree-anchor") !== -1) {
						tmp = obj.childNodes[i];
						break;
					}
				}
				if(tmp) {
					if(!this.settings.checkbox.tie_selection && this._model.data[obj.id].state.checked) { tmp.className += ' jstree-checked'; }
					tmp.insertBefore(_i.cloneNode(false), tmp.childNodes[0]);
				}
			}
			if(!is_callback && this.settings.checkbox.cascade.indexOf('undetermined') !== -1) {
				if(this._data.checkbox.uto) { clearTimeout(this._data.checkbox.uto); }
				this._data.checkbox.uto = setTimeout($.proxy(this._undetermined, this), 50);
			}
			return obj;
		};
		/**
		 * show the node checkbox icons
		 * @name show_checkboxes()
		 * @plugin checkbox
		 */
		this.show_checkboxes = function () { this._data.core.themes.checkboxes = true; this.get_container_ul().removeClass("jstree-no-checkboxes"); };
		/**
		 * hide the node checkbox icons
		 * @name hide_checkboxes()
		 * @plugin checkbox
		 */
		this.hide_checkboxes = function () { this._data.core.themes.checkboxes = false; this.get_container_ul().addClass("jstree-no-checkboxes"); };
		/**
		 * toggle the node icons
		 * @name toggle_checkboxes()
		 * @plugin checkbox
		 */
		this.toggle_checkboxes = function () { if(this._data.core.themes.checkboxes) { this.hide_checkboxes(); } else { this.show_checkboxes(); } };
		/**
		 * checks if a node is in an undetermined state
		 * @name is_undetermined(obj)
		 * @param  {mixed} obj
		 * @return {Boolean}
		 */
		this.is_undetermined = function (obj) {
			obj = this.get_node(obj);
			var s = this.settings.checkbox.cascade, i, j, t = this.settings.checkbox.tie_selection, d = this._data[ t ? 'core' : 'checkbox' ].selected, m = this._model.data;
			if(!obj || obj.state[ t ? 'selected' : 'checked' ] === true || s.indexOf('undetermined') === -1 || (s.indexOf('down') === -1 && s.indexOf('up') === -1)) {
				return false;
			}
			if(!obj.state.loaded && obj.original.state.undetermined === true) {
				return true;
			}
			for(i = 0, j = obj.children_d.length; i < j; i++) {
				if($.inArray(obj.children_d[i], d) !== -1 || (!m[obj.children_d[i]].state.loaded && m[obj.children_d[i]].original.state.undetermined)) {
					return true;
				}
			}
			return false;
		};

		this.activate_node = function (obj, e) {
			if(this.settings.checkbox.tie_selection && (this.settings.checkbox.whole_node || $(e.target).hasClass('jstree-checkbox'))) {
				e.ctrlKey = true;
			}
			if(this.settings.checkbox.tie_selection || (!this.settings.checkbox.whole_node && !$(e.target).hasClass('jstree-checkbox'))) {
				return parent.activate_node.call(this, obj, e);
			}
			if(this.is_disabled(obj)) {
				return false;
			}
			if(this.is_checked(obj)) {
				this.uncheck_node(obj, e);
			}
			else {
				this.check_node(obj, e);
			}
			this.trigger('activate_node', { 'node' : this.get_node(obj) });
		};

		/**
		 * check a node (only if tie_selection in checkbox settings is false, otherwise select_node will be called internally)
		 * @name check_node(obj)
		 * @param {mixed} obj an array can be used to check multiple nodes
		 * @trigger check_node.jstree
		 * @plugin checkbox
		 */
		this.check_node = function (obj, e) {
			if(this.settings.checkbox.tie_selection) { return this.select_node(obj, false, true, e); }
			var dom, t1, t2, th;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.check_node(obj[t1], e);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			dom = this.get_node(obj, true);
			if(!obj.state.checked) {
				obj.state.checked = true;
				this._data.checkbox.selected.push(obj.id);
				if(dom && dom.length) {
					dom.children('.jstree-anchor').addClass('jstree-checked');
				}
				/**
				 * triggered when an node is checked (only if tie_selection in checkbox settings is false)
				 * @event
				 * @name check_node.jstree
				 * @param {Object} node
				 * @param {Array} selected the current selection
				 * @param {Object} event the event (if any) that triggered this check_node
				 * @plugin checkbox
				 */
				this.trigger('check_node', { 'node' : obj, 'selected' : this._data.checkbox.selected, 'event' : e });
			}
		};
		/**
		 * uncheck a node (only if tie_selection in checkbox settings is false, otherwise deselect_node will be called internally)
		 * @name uncheck_node(obj)
		 * @param {mixed} obj an array can be used to uncheck multiple nodes
		 * @trigger uncheck_node.jstree
		 * @plugin checkbox
		 */
		this.uncheck_node = function (obj, e) {
			if(this.settings.checkbox.tie_selection) { return this.deselect_node(obj, false, e); }
			var t1, t2, dom;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.uncheck_node(obj[t1], e);
				}
				return true;
			}
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') {
				return false;
			}
			dom = this.get_node(obj, true);
			if(obj.state.checked) {
				obj.state.checked = false;
				this._data.checkbox.selected = $.vakata.array_remove_item(this._data.checkbox.selected, obj.id);
				if(dom.length) {
					dom.children('.jstree-anchor').removeClass('jstree-checked');
				}
				/**
				 * triggered when an node is unchecked (only if tie_selection in checkbox settings is false)
				 * @event
				 * @name uncheck_node.jstree
				 * @param {Object} node
				 * @param {Array} selected the current selection
				 * @param {Object} event the event (if any) that triggered this uncheck_node
				 * @plugin checkbox
				 */
				this.trigger('uncheck_node', { 'node' : obj, 'selected' : this._data.checkbox.selected, 'event' : e });
			}
		};
		/**
		 * checks all nodes in the tree (only if tie_selection in checkbox settings is false, otherwise select_all will be called internally)
		 * @name check_all()
		 * @trigger check_all.jstree, changed.jstree
		 * @plugin checkbox
		 */
		this.check_all = function () {
			if(this.settings.checkbox.tie_selection) { return this.select_all(); }
			var tmp = this._data.checkbox.selected.concat([]), i, j;
			this._data.checkbox.selected = this._model.data['#'].children_d.concat();
			for(i = 0, j = this._data.checkbox.selected.length; i < j; i++) {
				if(this._model.data[this._data.checkbox.selected[i]]) {
					this._model.data[this._data.checkbox.selected[i]].state.checked = true;
				}
			}
			this.redraw(true);
			/**
			 * triggered when all nodes are checked (only if tie_selection in checkbox settings is false)
			 * @event
			 * @name check_all.jstree
			 * @param {Array} selected the current selection
			 * @plugin checkbox
			 */
			this.trigger('check_all', { 'selected' : this._data.checkbox.selected });
		};
		/**
		 * uncheck all checked nodes (only if tie_selection in checkbox settings is false, otherwise deselect_all will be called internally)
		 * @name uncheck_all()
		 * @trigger uncheck_all.jstree
		 * @plugin checkbox
		 */
		this.uncheck_all = function () {
			if(this.settings.checkbox.tie_selection) { return this.deselect_all(); }
			var tmp = this._data.checkbox.selected.concat([]), i, j;
			for(i = 0, j = this._data.checkbox.selected.length; i < j; i++) {
				if(this._model.data[this._data.checkbox.selected[i]]) {
					this._model.data[this._data.checkbox.selected[i]].state.checked = false;
				}
			}
			this._data.checkbox.selected = [];
			this.element.find('.jstree-checked').removeClass('jstree-checked');
			/**
			 * triggered when all nodes are unchecked (only if tie_selection in checkbox settings is false)
			 * @event
			 * @name uncheck_all.jstree
			 * @param {Object} node the previous selection
			 * @param {Array} selected the current selection
			 * @plugin checkbox
			 */
			this.trigger('uncheck_all', { 'selected' : this._data.checkbox.selected, 'node' : tmp });
		};
		/**
		 * checks if a node is checked (if tie_selection is on in the settings this function will return the same as is_selected)
		 * @name is_checked(obj)
		 * @param  {mixed}  obj
		 * @return {Boolean}
		 * @plugin checkbox
		 */
		this.is_checked = function (obj) {
			if(this.settings.checkbox.tie_selection) { return this.is_selected(obj); }
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') { return false; }
			return obj.state.checked;
		};
		/**
		 * get an array of all checked nodes (if tie_selection is on in the settings this function will return the same as get_selected)
		 * @name get_checked([full])
		 * @param  {mixed}  full if set to `true` the returned array will consist of the full node objects, otherwise - only IDs will be returned
		 * @return {Array}
		 * @plugin checkbox
		 */
		this.get_checked = function (full) {
			if(this.settings.checkbox.tie_selection) { return this.get_selected(full); }
			return full ? $.map(this._data.checkbox.selected, $.proxy(function (i) { return this.get_node(i); }, this)) : this._data.checkbox.selected;
		};
		/**
		 * get an array of all top level checked nodes (ignoring children of checked nodes) (if tie_selection is on in the settings this function will return the same as get_top_selected)
		 * @name get_top_checked([full])
		 * @param  {mixed}  full if set to `true` the returned array will consist of the full node objects, otherwise - only IDs will be returned
		 * @return {Array}
		 * @plugin checkbox
		 */
		this.get_top_checked = function (full) {
			if(this.settings.checkbox.tie_selection) { return this.get_top_selected(full); }
			var tmp = this.get_checked(true),
				obj = {}, i, j, k, l;
			for(i = 0, j = tmp.length; i < j; i++) {
				obj[tmp[i].id] = tmp[i];
			}
			for(i = 0, j = tmp.length; i < j; i++) {
				for(k = 0, l = tmp[i].children_d.length; k < l; k++) {
					if(obj[tmp[i].children_d[k]]) {
						delete obj[tmp[i].children_d[k]];
					}
				}
			}
			tmp = [];
			for(i in obj) {
				if(obj.hasOwnProperty(i)) {
					tmp.push(i);
				}
			}
			return full ? $.map(tmp, $.proxy(function (i) { return this.get_node(i); }, this)) : tmp;
		};
		/**
		 * get an array of all bottom level checked nodes (ignoring selected parents) (if tie_selection is on in the settings this function will return the same as get_bottom_selected)
		 * @name get_bottom_checked([full])
		 * @param  {mixed}  full if set to `true` the returned array will consist of the full node objects, otherwise - only IDs will be returned
		 * @return {Array}
		 * @plugin checkbox
		 */
		this.get_bottom_checked = function (full) {
			if(this.settings.checkbox.tie_selection) { return this.get_bottom_selected(full); }
			var tmp = this.get_checked(true),
				obj = [], i, j;
			for(i = 0, j = tmp.length; i < j; i++) {
				if(!tmp[i].children.length) {
					obj.push(tmp[i].id);
				}
			}
			return full ? $.map(obj, $.proxy(function (i) { return this.get_node(i); }, this)) : obj;
		};
		this.load_node = function (obj, callback) {
			var k, l, i, j, c, tmp;
			if(!$.isArray(obj) && !this.settings.checkbox.tie_selection) {
				tmp = this.get_node(obj);
				if(tmp && tmp.state.loaded) {
					for(k = 0, l = tmp.children_d.length; k < l; k++) {
						if(this._model.data[tmp.children_d[k]].state.checked) {
							c = true;
							this._data.checkbox.selected = $.vakata.array_remove_item(this._data.checkbox.selected, tmp.children_d[k]);
						}
					}
				}
			}
			return parent.load_node.apply(this, arguments);
		};
		this.get_state = function () {
			var state = parent.get_state.apply(this, arguments);
			if(this.settings.checkbox.tie_selection) { return state; }
			state.checkbox = this._data.checkbox.selected.slice();
			return state;
		};
		this.set_state = function (state, callback) {
			var res = parent.set_state.apply(this, arguments);
			if(res && state.checkbox) {
				if(!this.settings.checkbox.tie_selection) {
					this.uncheck_all();
					var _this = this;
					$.each(state.checkbox, function (i, v) {
						_this.check_node(v);
					});
				}
				delete state.checkbox;
				this.set_state(state, callback);
				return false;
			}
			return res;
		};
	};

	// include the checkbox plugin by default
	// $.jstree.defaults.plugins.push("checkbox");

/**
 * ### Contextmenu plugin
 *
 * Shows a context menu when a node is right-clicked.
 */

	/**
	 * stores all defaults for the contextmenu plugin
	 * @name $.jstree.defaults.contextmenu
	 * @plugin contextmenu
	 */
	$.jstree.defaults.contextmenu = {
		/**
		 * a boolean indicating if the node should be selected when the context menu is invoked on it. Defaults to `true`.
		 * @name $.jstree.defaults.contextmenu.select_node
		 * @plugin contextmenu
		 */
		select_node : true,
		/**
		 * a boolean indicating if the menu should be shown aligned with the node. Defaults to `true`, otherwise the mouse coordinates are used.
		 * @name $.jstree.defaults.contextmenu.show_at_node
		 * @plugin contextmenu
		 */
		show_at_node : true,
		/**
		 * an object of actions, or a function that accepts a node and a callback function and calls the callback function with an object of actions available for that node (you can also return the items too).
		 *
		 * Each action consists of a key (a unique name) and a value which is an object with the following properties (only label and action are required):
		 *
		 * * `separator_before` - a boolean indicating if there should be a separator before this item
		 * * `separator_after` - a boolean indicating if there should be a separator after this item
		 * * `_disabled` - a boolean indicating if this action should be disabled
		 * * `label` - a string - the name of the action (could be a function returning a string)
		 * * `action` - a function to be executed if this item is chosen
		 * * `icon` - a string, can be a path to an icon or a className, if using an image that is in the current directory use a `./` prefix, otherwise it will be detected as a class
		 * * `shortcut` - keyCode which will trigger the action if the menu is open (for example `113` for rename, which equals F2)
		 * * `shortcut_label` - shortcut label (like for example `F2` for rename)
		 *
		 * @name $.jstree.defaults.contextmenu.items
		 * @plugin contextmenu
		 */
		items : function (o, cb) { // Could be an object directly
			return {
				"create" : {
					"separator_before"	: false,
					"separator_after"	: true,
					"_disabled"			: false, //(this.check("create_node", data.reference, {}, "last")),
					"label"				: "Create",
					"action"			: function (data) {
						var inst = $.jstree.reference(data.reference),
							obj = inst.get_node(data.reference);
						inst.create_node(obj, {}, "last", function (new_node) {
							setTimeout(function () { inst.edit(new_node); },0);
						});
					}
				},
				"rename" : {
					"separator_before"	: false,
					"separator_after"	: false,
					"_disabled"			: false, //(this.check("rename_node", data.reference, this.get_parent(data.reference), "")),
					"label"				: "Rename",
					/*
					"shortcut"			: 113,
					"shortcut_label"	: 'F2',
					"icon"				: "glyphicon glyphicon-leaf",
					*/
					"action"			: function (data) {
						var inst = $.jstree.reference(data.reference),
							obj = inst.get_node(data.reference);
						inst.edit(obj);
					}
				},
				"remove" : {
					"separator_before"	: false,
					"icon"				: false,
					"separator_after"	: false,
					"_disabled"			: false, //(this.check("delete_node", data.reference, this.get_parent(data.reference), "")),
					"label"				: "Delete",
					"action"			: function (data) {
						var inst = $.jstree.reference(data.reference),
							obj = inst.get_node(data.reference);
						if(inst.is_selected(obj)) {
							inst.delete_node(inst.get_selected());
						}
						else {
							inst.delete_node(obj);
						}
					}
				},
				"ccp" : {
					"separator_before"	: true,
					"icon"				: false,
					"separator_after"	: false,
					"label"				: "Edit",
					"action"			: false,
					"submenu" : {
						"cut" : {
							"separator_before"	: false,
							"separator_after"	: false,
							"label"				: "Cut",
							"action"			: function (data) {
								var inst = $.jstree.reference(data.reference),
									obj = inst.get_node(data.reference);
								if(inst.is_selected(obj)) {
									inst.cut(inst.get_top_selected());
								}
								else {
									inst.cut(obj);
								}
							}
						},
						"copy" : {
							"separator_before"	: false,
							"icon"				: false,
							"separator_after"	: false,
							"label"				: "Copy",
							"action"			: function (data) {
								var inst = $.jstree.reference(data.reference),
									obj = inst.get_node(data.reference);
								if(inst.is_selected(obj)) {
									inst.copy(inst.get_top_selected());
								}
								else {
									inst.copy(obj);
								}
							}
						},
						"paste" : {
							"separator_before"	: false,
							"icon"				: false,
							"_disabled"			: function (data) {
								return !$.jstree.reference(data.reference).can_paste();
							},
							"separator_after"	: false,
							"label"				: "Paste",
							"action"			: function (data) {
								var inst = $.jstree.reference(data.reference),
									obj = inst.get_node(data.reference);
								inst.paste(obj);
							}
						}
					}
				}
			};
		}
	};

	$.jstree.plugins.contextmenu = function (options, parent) {
		this.bind = function () {
			parent.bind.call(this);

			var last_ts = 0, cto = null, ex, ey;
			this.element
				.on("contextmenu.jstree", ".jstree-anchor", $.proxy(function (e, data) {
						e.preventDefault();
						last_ts = e.ctrlKey ? +new Date() : 0;
						if(data || cto) {
							last_ts = (+new Date()) + 10000;
						}
						if(cto) {
							clearTimeout(cto);
						}
						if(!this.is_loading(e.currentTarget)) {
							this.show_contextmenu(e.currentTarget, e.pageX, e.pageY, e);
						}
					}, this))
				.on("click.jstree", ".jstree-anchor", $.proxy(function (e) {
						if(this._data.contextmenu.visible && (!last_ts || (+new Date()) - last_ts > 250)) { // work around safari & macOS ctrl+click
							$.vakata.context.hide();
						}
						last_ts = 0;
					}, this))
				.on("touchstart.jstree", ".jstree-anchor", function (e) {
						if(!e.originalEvent || !e.originalEvent.changedTouches || !e.originalEvent.changedTouches[0]) {
							return;
						}
						ex = e.pageX;
						ey = e.pageY;
						cto = setTimeout(function () {
							$(e.currentTarget).trigger('contextmenu', true);
						}, 750);
					})
				.on('touchmove.vakata.jstree', function (e) {
						if(cto && e.originalEvent && e.originalEvent.changedTouches && e.originalEvent.changedTouches[0] && (Math.abs(ex - e.pageX) > 50 || Math.abs(ey - e.pageY) > 50)) {
							clearTimeout(cto);
						}
					})
				.on('touchend.vakata.jstree', function (e) {
						if(cto) {
							clearTimeout(cto);
						}
					});

			/*
			if(!('oncontextmenu' in document.body) && ('ontouchstart' in document.body)) {
				var el = null, tm = null;
				this.element
					.on("touchstart", ".jstree-anchor", function (e) {
						el = e.currentTarget;
						tm = +new Date();
						$(document).one("touchend", function (e) {
							e.target = document.elementFromPoint(e.originalEvent.targetTouches[0].pageX - window.pageXOffset, e.originalEvent.targetTouches[0].pageY - window.pageYOffset);
							e.currentTarget = e.target;
							tm = ((+(new Date())) - tm);
							if(e.target === el && tm > 600 && tm < 1000) {
								e.preventDefault();
								$(el).trigger('contextmenu', e);
							}
							el = null;
							tm = null;
						});
					});
			}
			*/
			$(document).on("context_hide.vakata.jstree", $.proxy(function () { this._data.contextmenu.visible = false; }, this));
		};
		this.teardown = function () {
			if(this._data.contextmenu.visible) {
				$.vakata.context.hide();
			}
			parent.teardown.call(this);
		};

		/**
		 * prepare and show the context menu for a node
		 * @name show_contextmenu(obj [, x, y])
		 * @param {mixed} obj the node
		 * @param {Number} x the x-coordinate relative to the document to show the menu at
		 * @param {Number} y the y-coordinate relative to the document to show the menu at
		 * @param {Object} e the event if available that triggered the contextmenu
		 * @plugin contextmenu
		 * @trigger show_contextmenu.jstree
		 */
		this.show_contextmenu = function (obj, x, y, e) {
			obj = this.get_node(obj);
			if(!obj || obj.id === '#') { return false; }
			var s = this.settings.contextmenu,
				d = this.get_node(obj, true),
				a = d.children(".jstree-anchor"),
				o = false,
				i = false;
			if(s.show_at_node || x === undefined || y === undefined) {
				o = a.offset();
				x = o.left;
				y = o.top + this._data.core.li_height;
			}
			if(this.settings.contextmenu.select_node && !this.is_selected(obj)) {
				this.activate_node(obj, e);
			}

			i = s.items;
			if($.isFunction(i)) {
				i = i.call(this, obj, $.proxy(function (i) {
					this._show_contextmenu(obj, x, y, i);
				}, this));
			}
			if($.isPlainObject(i)) {
				this._show_contextmenu(obj, x, y, i);
			}
		};
		/**
		 * show the prepared context menu for a node
		 * @name _show_contextmenu(obj, x, y, i)
		 * @param {mixed} obj the node
		 * @param {Number} x the x-coordinate relative to the document to show the menu at
		 * @param {Number} y the y-coordinate relative to the document to show the menu at
		 * @param {Number} i the object of items to show
		 * @plugin contextmenu
		 * @trigger show_contextmenu.jstree
		 * @private
		 */
		this._show_contextmenu = function (obj, x, y, i) {
			var d = this.get_node(obj, true),
				a = d.children(".jstree-anchor");
			$(document).one("context_show.vakata.jstree", $.proxy(function (e, data) {
				var cls = 'jstree-contextmenu jstree-' + this.get_theme() + '-contextmenu';
				$(data.element).addClass(cls);
			}, this));
			this._data.contextmenu.visible = true;
			$.vakata.context.show(a, { 'x' : x, 'y' : y }, i);
			/**
			 * triggered when the contextmenu is shown for a node
			 * @event
			 * @name show_contextmenu.jstree
			 * @param {Object} node the node
			 * @param {Number} x the x-coordinate of the menu relative to the document
			 * @param {Number} y the y-coordinate of the menu relative to the document
			 * @plugin contextmenu
			 */
			this.trigger('show_contextmenu', { "node" : obj, "x" : x, "y" : y });
		};
	};

	// contextmenu helper
	(function ($) {
		var right_to_left = false,
			vakata_context = {
				element		: false,
				reference	: false,
				position_x	: 0,
				position_y	: 0,
				items		: [],
				html		: "",
				is_visible	: false
			};

		$.vakata.context = {
			settings : {
				hide_onmouseleave	: 0,
				icons				: true
			},
			_trigger : function (event_name) {
				$(document).triggerHandler("context_" + event_name + ".vakata", {
					"reference"	: vakata_context.reference,
					"element"	: vakata_context.element,
					"position"	: {
						"x" : vakata_context.position_x,
						"y" : vakata_context.position_y
					}
				});
			},
			_execute : function (i) {
				i = vakata_context.items[i];
				return i && (!i._disabled || ($.isFunction(i._disabled) && !i._disabled({ "item" : i, "reference" : vakata_context.reference, "element" : vakata_context.element }))) && i.action ? i.action.call(null, {
							"item"		: i,
							"reference"	: vakata_context.reference,
							"element"	: vakata_context.element,
							"position"	: {
								"x" : vakata_context.position_x,
								"y" : vakata_context.position_y
							}
						}) : false;
			},
			_parse : function (o, is_callback) {
				if(!o) { return false; }
				if(!is_callback) {
					vakata_context.html		= "";
					vakata_context.items	= [];
				}
				var str = "",
					sep = false,
					tmp;

				if(is_callback) { str += "<"+"ul>"; }
				$.each(o, function (i, val) {
					if(!val) { return true; }
					vakata_context.items.push(val);
					if(!sep && val.separator_before) {
						str += "<"+"li class='vakata-context-separator'><"+"a href='#' " + ($.vakata.context.settings.icons ? '' : 'style="margin-left:0px;"') + ">&#160;<"+"/a><"+"/li>";
					}
					sep = false;
					str += "<"+"li class='" + (val._class || "") + (val._disabled === true || ($.isFunction(val._disabled) && val._disabled({ "item" : val, "reference" : vakata_context.reference, "element" : vakata_context.element })) ? " vakata-contextmenu-disabled " : "") + "' "+(val.shortcut?" data-shortcut='"+val.shortcut+"' ":'')+">";
					str += "<"+"a href='#' rel='" + (vakata_context.items.length - 1) + "'>";
					if($.vakata.context.settings.icons) {
						str += "<"+"i ";
						if(val.icon) {
							if(val.icon.indexOf("/") !== -1 || val.icon.indexOf(".") !== -1) { str += " style='background:url(\"" + val.icon + "\") center center no-repeat' "; }
							else { str += " class='" + val.icon + "' "; }
						}
						str += "><"+"/i><"+"span class='vakata-contextmenu-sep'>&#160;<"+"/span>";
					}
					str += ($.isFunction(val.label) ? val.label({ "item" : i, "reference" : vakata_context.reference, "element" : vakata_context.element }) : val.label) + (val.shortcut?' <span class="vakata-contextmenu-shortcut vakata-contextmenu-shortcut-'+val.shortcut+'">'+ (val.shortcut_label || '') +'</span>':'') + "<"+"/a>";
					if(val.submenu) {
						tmp = $.vakata.context._parse(val.submenu, true);
						if(tmp) { str += tmp; }
					}
					str += "<"+"/li>";
					if(val.separator_after) {
						str += "<"+"li class='vakata-context-separator'><"+"a href='#' " + ($.vakata.context.settings.icons ? '' : 'style="margin-left:0px;"') + ">&#160;<"+"/a><"+"/li>";
						sep = true;
					}
				});
				str  = str.replace(/<li class\='vakata-context-separator'\><\/li\>$/,"");
				if(is_callback) { str += "</ul>"; }
				/**
				 * triggered on the document when the contextmenu is parsed (HTML is built)
				 * @event
				 * @plugin contextmenu
				 * @name context_parse.vakata
				 * @param {jQuery} reference the element that was right clicked
				 * @param {jQuery} element the DOM element of the menu itself
				 * @param {Object} position the x & y coordinates of the menu
				 */
				if(!is_callback) { vakata_context.html = str; $.vakata.context._trigger("parse"); }
				return str.length > 10 ? str : false;
			},
			_show_submenu : function (o) {
				o = $(o);
				if(!o.length || !o.children("ul").length) { return; }
				var e = o.children("ul"),
					x = o.offset().left + o.outerWidth(),
					y = o.offset().top,
					w = e.width(),
					h = e.height(),
					dw = $(window).width() + $(window).scrollLeft(),
					dh = $(window).height() + $(window).scrollTop();
				// може да се спести е една проверка - дали няма някой от класовете вече нагоре
				if(right_to_left) {
					o[x - (w + 10 + o.outerWidth()) < 0 ? "addClass" : "removeClass"]("vakata-context-left");
				}
				else {
					o[x + w + 10 > dw ? "addClass" : "removeClass"]("vakata-context-right");
				}
				if(y + h + 10 > dh) {
					e.css("bottom","-1px");
				}
				e.show();
			},
			show : function (reference, position, data) {
				var o, e, x, y, w, h, dw, dh, cond = true;
				if(vakata_context.element && vakata_context.element.length) {
					vakata_context.element.width('');
				}
				switch(cond) {
					case (!position && !reference):
						return false;
					case (!!position && !!reference):
						vakata_context.reference	= reference;
						vakata_context.position_x	= position.x;
						vakata_context.position_y	= position.y;
						break;
					case (!position && !!reference):
						vakata_context.reference	= reference;
						o = reference.offset();
						vakata_context.position_x	= o.left + reference.outerHeight();
						vakata_context.position_y	= o.top;
						break;
					case (!!position && !reference):
						vakata_context.position_x	= position.x;
						vakata_context.position_y	= position.y;
						break;
				}
				if(!!reference && !data && $(reference).data('vakata_contextmenu')) {
					data = $(reference).data('vakata_contextmenu');
				}
				if($.vakata.context._parse(data)) {
					vakata_context.element.html(vakata_context.html);
				}
				if(vakata_context.items.length) {
					vakata_context.element.appendTo("body");
					e = vakata_context.element;
					x = vakata_context.position_x;
					y = vakata_context.position_y;
					w = e.width();
					h = e.height();
					dw = $(window).width() + $(window).scrollLeft();
					dh = $(window).height() + $(window).scrollTop();
					if(right_to_left) {
						x -= (e.outerWidth() - $(reference).outerWidth());
						if(x < $(window).scrollLeft() + 20) {
							x = $(window).scrollLeft() + 20;
						}
					}
					if(x + w + 20 > dw) {
						x = dw - (w + 20);
					}
					if(y + h + 20 > dh) {
						y = dh - (h + 20);
					}

					vakata_context.element
						.css({ "left" : x, "top" : y })
						.show()
						.find('a').first().focus().parent().addClass("vakata-context-hover");
					vakata_context.is_visible = true;
					/**
					 * triggered on the document when the contextmenu is shown
					 * @event
					 * @plugin contextmenu
					 * @name context_show.vakata
					 * @param {jQuery} reference the element that was right clicked
					 * @param {jQuery} element the DOM element of the menu itself
					 * @param {Object} position the x & y coordinates of the menu
					 */
					$.vakata.context._trigger("show");
				}
			},
			hide : function () {
				if(vakata_context.is_visible) {
					vakata_context.element.hide().find("ul").hide().end().find(':focus').blur().end().detach();
					vakata_context.is_visible = false;
					/**
					 * triggered on the document when the contextmenu is hidden
					 * @event
					 * @plugin contextmenu
					 * @name context_hide.vakata
					 * @param {jQuery} reference the element that was right clicked
					 * @param {jQuery} element the DOM element of the menu itself
					 * @param {Object} position the x & y coordinates of the menu
					 */
					$.vakata.context._trigger("hide");
				}
			}
		};
		$(function () {
			right_to_left = $("body").css("direction") === "rtl";
			var to = false;

			vakata_context.element = $("<ul class='vakata-context'></ul>");
			vakata_context.element
				.on("mouseenter", "li", function (e) {
					e.stopImmediatePropagation();

					if($.contains(this, e.relatedTarget)) {
						// премахнато заради delegate mouseleave по-долу
						// $(this).find(".vakata-context-hover").removeClass("vakata-context-hover");
						return;
					}

					if(to) { clearTimeout(to); }
					vakata_context.element.find(".vakata-context-hover").removeClass("vakata-context-hover").end();

					$(this)
						.siblings().find("ul").hide().end().end()
						.parentsUntil(".vakata-context", "li").addBack().addClass("vakata-context-hover");
					$.vakata.context._show_submenu(this);
				})
				// тестово - дали не натоварва?
				.on("mouseleave", "li", function (e) {
					if($.contains(this, e.relatedTarget)) { return; }
					$(this).find(".vakata-context-hover").addBack().removeClass("vakata-context-hover");
				})
				.on("mouseleave", function (e) {
					$(this).find(".vakata-context-hover").removeClass("vakata-context-hover");
					if($.vakata.context.settings.hide_onmouseleave) {
						to = setTimeout(
							(function (t) {
								return function () { $.vakata.context.hide(); };
							}(this)), $.vakata.context.settings.hide_onmouseleave);
					}
				})
				.on("click", "a", function (e) {
					e.preventDefault();
				//})
				//.on("mouseup", "a", function (e) {
					if(!$(this).blur().parent().hasClass("vakata-context-disabled") && $.vakata.context._execute($(this).attr("rel")) !== false) {
						$.vakata.context.hide();
					}
				})
				.on('keydown', 'a', function (e) {
						var o = null;
						switch(e.which) {
							case 13:
							case 32:
								e.type = "mouseup";
								e.preventDefault();
								$(e.currentTarget).trigger(e);
								break;
							case 37:
								if(vakata_context.is_visible) {
									vakata_context.element.find(".vakata-context-hover").last().closest("li").first().find("ul").hide().find(".vakata-context-hover").removeClass("vakata-context-hover").end().end().children('a').focus();
									e.stopImmediatePropagation();
									e.preventDefault();
								}
								break;
							case 38:
								if(vakata_context.is_visible) {
									o = vakata_context.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").prevAll("li:not(.vakata-context-separator)").first();
									if(!o.length) { o = vakata_context.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").last(); }
									o.addClass("vakata-context-hover").children('a').focus();
									e.stopImmediatePropagation();
									e.preventDefault();
								}
								break;
							case 39:
								if(vakata_context.is_visible) {
									vakata_context.element.find(".vakata-context-hover").last().children("ul").show().children("li:not(.vakata-context-separator)").removeClass("vakata-context-hover").first().addClass("vakata-context-hover").children('a').focus();
									e.stopImmediatePropagation();
									e.preventDefault();
								}
								break;
							case 40:
								if(vakata_context.is_visible) {
									o = vakata_context.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").nextAll("li:not(.vakata-context-separator)").first();
									if(!o.length) { o = vakata_context.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").first(); }
									o.addClass("vakata-context-hover").children('a').focus();
									e.stopImmediatePropagation();
									e.preventDefault();
								}
								break;
							case 27:
								$.vakata.context.hide();
								e.preventDefault();
								break;
							default:
								//console.log(e.which);
								break;
						}
					})
				.on('keydown', function (e) {
					e.preventDefault();
					var a = vakata_context.element.find('.vakata-contextmenu-shortcut-' + e.which).parent();
					if(a.parent().not('.vakata-context-disabled')) {
						a.click();
					}
				});

			$(document)
				.on("mousedown.vakata.jstree", function (e) {
					if(vakata_context.is_visible && !$.contains(vakata_context.element[0], e.target)) {
						$.vakata.context.hide();
					}
				})
				.on("context_show.vakata.jstree", function (e, data) {
					vakata_context.element.find("li:has(ul)").children("a").addClass("vakata-context-parent");
					if(right_to_left) {
						vakata_context.element.addClass("vakata-context-rtl").css("direction", "rtl");
					}
					// also apply a RTL class?
					vakata_context.element.find("ul").hide().end();
				});
		});
	}($));
	// $.jstree.defaults.plugins.push("contextmenu");

/**
 * ### Drag'n'drop plugin
 *
 * Enables dragging and dropping of nodes in the tree, resulting in a move or copy operations.
 */

	/**
	 * stores all defaults for the drag'n'drop plugin
	 * @name $.jstree.defaults.dnd
	 * @plugin dnd
	 */
	$.jstree.defaults.dnd = {
		/**
		 * a boolean indicating if a copy should be possible while dragging (by pressint the meta key or Ctrl). Defaults to `true`.
		 * @name $.jstree.defaults.dnd.copy
		 * @plugin dnd
		 */
		copy : true,
		/**
		 * a number indicating how long a node should remain hovered while dragging to be opened. Defaults to `500`.
		 * @name $.jstree.defaults.dnd.open_timeout
		 * @plugin dnd
		 */
		open_timeout : 500,
		/**
		 * a function invoked each time a node is about to be dragged, invoked in the tree's scope and receives the nodes about to be dragged as an argument (array) - return `false` to prevent dragging
		 * @name $.jstree.defaults.dnd.is_draggable
		 * @plugin dnd
		 */
		is_draggable : true,
		/**
		 * a boolean indicating if checks should constantly be made while the user is dragging the node (as opposed to checking only on drop), default is `true`
		 * @name $.jstree.defaults.dnd.check_while_dragging
		 * @plugin dnd
		 */
		check_while_dragging : true,
		/**
		 * a boolean indicating if nodes from this tree should only be copied with dnd (as opposed to moved), default is `false`
		 * @name $.jstree.defaults.dnd.always_copy
		 * @plugin dnd
		 */
		always_copy : false,
		/**
		 * when dropping a node "inside", this setting indicates the position the node should go to - it can be an integer or a string: "first" (same as 0) or "last", default is `0`
		 * @name $.jstree.defaults.dnd.inside_pos
		 * @plugin dnd
		 */
		inside_pos : 0,
		/**
		 * when starting the drag on a node that is selected this setting controls if all selected nodes are dragged or only the single node, default is `true`, which means all selected nodes are dragged when the drag is started on a selected node
		 * @name $.jstree.defaults.dnd.drag_selection
		 * @plugin dnd
		 */
		drag_selection : true,
		/**
		 * controls whether dnd works on touch devices. If left as boolean true dnd will work the same as in desktop browsers, which in some cases may impair scrolling. If set to boolean false dnd will not work on touch devices. There is a special third option - string "selected" which means only selected nodes can be dragged on touch devices.
		 * @name $.jstree.defaults.dnd.touch
		 * @plugin dnd
		 */
		touch : true,
		/**
		 * controls whether items can be dropped anywhere on the node, not just on the anchor, by default only the node anchor is a valid drop target. Works best with the wholerow plugin. If enabled on mobile depending on the interface it might be hard for the user to cancel the drop, since the whole tree container will be a valid drop target.
		 * @name $.jstree.defaults.dnd.large_drop_target
		 * @plugin dnd
		 */
		large_drop_target : false,
		/**
		 * controls whether a drag can be initiated from any part of the node and not just the text/icon part, works best with the wholerow plugin. Keep in mind it can cause problems with tree scrolling on mobile depending on the interface - in that case set the touch option to "selected".
		 * @name $.jstree.defaults.dnd.large_drag_target
		 * @plugin dnd
		 */
		large_drag_target : false
	};
	// TODO: now check works by checking for each node individually, how about max_children, unique, etc?
	$.jstree.plugins.dnd = function (options, parent) {
		this.bind = function () {
			parent.bind.call(this);

			this.element
				.on('mousedown.jstree touchstart.jstree', this.settings.dnd.large_drag_target ? '.jstree-node' : '.jstree-anchor', $.proxy(function (e) {
					if(this.settings.dnd.large_drag_target && $(e.target).closest('.jstree-node')[0] !== e.currentTarget) {
						return true;
					}
					if(e.type === "touchstart" && (!this.settings.dnd.touch || (this.settings.dnd.touch === 'selected' && !$(e.currentTarget).closest('.jstree-node').children('.jstree-anchor').hasClass('jstree-clicked')))) {
						return true;
					}
					var obj = this.get_node(e.target),
						mlt = this.is_selected(obj) && this.settings.dnd.drag_selection ? this.get_top_selected().length : 1,
						txt = (mlt > 1 ? mlt + ' ' + this.get_string('nodes') : this.get_text(e.currentTarget));
					if(this.settings.core.force_text) {
						txt = $.vakata.html.escape(txt);
					}
					if(obj && obj.id && obj.id !== "#" && (e.which === 1 || e.type === "touchstart") &&
						(this.settings.dnd.is_draggable === true || ($.isFunction(this.settings.dnd.is_draggable) && this.settings.dnd.is_draggable.call(this, (mlt > 1 ? this.get_top_selected(true) : [obj]))))
					) {
						this.element.trigger('mousedown.jstree');
						return $.vakata.dnd.start(e, { 'jstree' : true, 'origin' : this, 'obj' : this.get_node(obj,true), 'nodes' : mlt > 1 ? this.get_top_selected() : [obj.id] }, '<div id="jstree-dnd" class="jstree-' + this.get_theme() + ' jstree-' + this.get_theme() + '-' + this.get_theme_variant() + ' ' + ( this.settings.core.themes.responsive ? ' jstree-dnd-responsive' : '' ) + '"><i class="jstree-icon jstree-er"></i>' + txt + '<ins class="jstree-copy" style="display:none;">+</ins></div>');
					}
				}, this));
		};
	};

	$(function() {
		// bind only once for all instances
		var lastmv = false,
			laster = false,
			opento = false,
			marker = $('<div id="jstree-marker">&#160;</div>').hide(); //.appendTo('body');

		$(document)
			.on('dnd_start.vakata.jstree', function (e, data) {
				lastmv = false;
				if(!data || !data.data || !data.data.jstree) { return; }
				marker.appendTo('body'); //.show();
			})
			.on('dnd_move.vakata.jstree', function (e, data) {
				if(opento) { clearTimeout(opento); }
				if(!data || !data.data || !data.data.jstree) { return; }

				// if we are hovering the marker image do nothing (can happen on "inside" drags)
				if(data.event.target.id && data.event.target.id === 'jstree-marker') {
					return;
				}

				var ins = $.jstree.reference(data.event.target),
					ref = false,
					off = false,
					rel = false,
					tmp, l, t, h, p, i, o, ok, t1, t2, op, ps, pr, ip, tm;
				// if we are over an instance
				if(ins && ins._data && ins._data.dnd) {
					marker.attr('class', 'jstree-' + ins.get_theme() + ( ins.settings.core.themes.responsive ? ' jstree-dnd-responsive' : '' ));
					data.helper
						.children().attr('class', 'jstree-' + ins.get_theme() + ' jstree-' + ins.get_theme() + '-' + ins.get_theme_variant() + ' ' + ( ins.settings.core.themes.responsive ? ' jstree-dnd-responsive' : '' ))
						.find('.jstree-copy').first()[ data.data.origin && (data.data.origin.settings.dnd.always_copy || (data.data.origin.settings.dnd.copy && (data.event.metaKey || data.event.ctrlKey))) ? 'show' : 'hide' ]();


					// if are hovering the container itself add a new root node
					if( (data.event.target === ins.element[0] || data.event.target === ins.get_container_ul()[0]) && ins.get_container_ul().children().length === 0) {
						ok = true;
						for(t1 = 0, t2 = data.data.nodes.length; t1 < t2; t1++) {
							ok = ok && ins.check( (data.data.origin && (data.data.origin.settings.dnd.always_copy || (data.data.origin.settings.dnd.copy && (data.event.metaKey || data.event.ctrlKey)) ) ? "copy_node" : "move_node"), (data.data.origin && data.data.origin !== ins ? data.data.origin.get_node(data.data.nodes[t1]) : data.data.nodes[t1]), '#', 'last', { 'dnd' : true, 'ref' : ins.get_node('#'), 'pos' : 'i', 'origin' : data.data.origin, 'is_multi' : (data.data.origin && data.data.origin !== ins), 'is_foreign' : (!data.data.origin) });
							if(!ok) { break; }
						}
						if(ok) {
							lastmv = { 'ins' : ins, 'par' : '#', 'pos' : 'last' };
							marker.hide();
							data.helper.find('.jstree-icon').first().removeClass('jstree-er').addClass('jstree-ok');
							return;
						}
					}
					else {
						// if we are hovering a tree node
						ref = ins.settings.dnd.large_drop_target ? $(data.event.target).closest('.jstree-node').children('.jstree-anchor') : $(data.event.target).closest('.jstree-anchor');
						if(ref && ref.length && ref.parent().is('.jstree-closed, .jstree-open, .jstree-leaf')) {
							off = ref.offset();
							rel = data.event.pageY - off.top;
							h = ref.outerHeight();
							if(rel < h / 3) {
								o = ['b', 'i', 'a'];
							}
							else if(rel > h - h / 3) {
								o = ['a', 'i', 'b'];
							}
							else {
								o = rel > h / 2 ? ['i', 'a', 'b'] : ['i', 'b', 'a'];
							}
							$.each(o, function (j, v) {
								switch(v) {
									case 'b':
										l = off.left - 6;
										t = off.top;
										p = ins.get_parent(ref);
										i = ref.parent().index();
										break;
									case 'i':
										ip = ins.settings.dnd.inside_pos;
										tm = ins.get_node(ref.parent());
										l = off.left - 2;
										t = off.top + h / 2 + 1;
										p = tm.id;
										i = ip === 'first' ? 0 : (ip === 'last' ? tm.children.length : Math.min(ip, tm.children.length));
										break;
									case 'a':
										l = off.left - 6;
										t = off.top + h;
										p = ins.get_parent(ref);
										i = ref.parent().index() + 1;
										break;
								}
								ok = true;
								for(t1 = 0, t2 = data.data.nodes.length; t1 < t2; t1++) {
									op = data.data.origin && (data.data.origin.settings.dnd.always_copy || (data.data.origin.settings.dnd.copy && (data.event.metaKey || data.event.ctrlKey))) ? "copy_node" : "move_node";
									ps = i;
									if(op === "move_node" && v === 'a' && (data.data.origin && data.data.origin === ins) && p === ins.get_parent(data.data.nodes[t1])) {
										pr = ins.get_node(p);
										if(ps > $.inArray(data.data.nodes[t1], pr.children)) {
											ps -= 1;
										}
									}
									ok = ok && ( (ins && ins.settings && ins.settings.dnd && ins.settings.dnd.check_while_dragging === false) || ins.check(op, (data.data.origin && data.data.origin !== ins ? data.data.origin.get_node(data.data.nodes[t1]) : data.data.nodes[t1]), p, ps, { 'dnd' : true, 'ref' : ins.get_node(ref.parent()), 'pos' : v, 'origin' : data.data.origin, 'is_multi' : (data.data.origin && data.data.origin !== ins), 'is_foreign' : (!data.data.origin) }) );
									if(!ok) {
										if(ins && ins.last_error) { laster = ins.last_error(); }
										break;
									}
								}
								if(v === 'i' && ref.parent().is('.jstree-closed') && ins.settings.dnd.open_timeout) {
									opento = setTimeout((function (x, z) { return function () { x.open_node(z); }; }(ins, ref)), ins.settings.dnd.open_timeout);
								}
								if(ok) {
									lastmv = { 'ins' : ins, 'par' : p, 'pos' : v === 'i' && ip === 'last' && i === 0 && !ins.is_loaded(tm) ? 'last' : i };
									marker.css({ 'left' : l + 'px', 'top' : t + 'px' }).show();
									data.helper.find('.jstree-icon').first().removeClass('jstree-er').addClass('jstree-ok');
									laster = {};
									o = true;
									return false;
								}
							});
							if(o === true) { return; }
						}
					}
				}
				lastmv = false;
				data.helper.find('.jstree-icon').removeClass('jstree-ok').addClass('jstree-er');
				marker.hide();
			})
			.on('dnd_scroll.vakata.jstree', function (e, data) {
				if(!data || !data.data || !data.data.jstree) { return; }
				marker.hide();
				lastmv = false;
				data.helper.find('.jstree-icon').first().removeClass('jstree-ok').addClass('jstree-er');
			})
			.on('dnd_stop.vakata.jstree', function (e, data) {
				if(opento) { clearTimeout(opento); }
				if(!data || !data.data || !data.data.jstree) { return; }
				marker.hide().detach();
				var i, j, nodes = [];
				if(lastmv) {
					for(i = 0, j = data.data.nodes.length; i < j; i++) {
						nodes[i] = data.data.origin ? data.data.origin.get_node(data.data.nodes[i]) : data.data.nodes[i];
					}
					lastmv.ins[ data.data.origin && (data.data.origin.settings.dnd.always_copy || (data.data.origin.settings.dnd.copy && (data.event.metaKey || data.event.ctrlKey))) ? 'copy_node' : 'move_node' ](nodes, lastmv.par, lastmv.pos, false, false, false, data.data.origin);
				}
				else {
					i = $(data.event.target).closest('.jstree');
					if(i.length && laster && laster.error && laster.error === 'check') {
						i = i.jstree(true);
						if(i) {
							i.settings.core.error.call(this, laster);
						}
					}
				}
			})
			.on('keyup.jstree keydown.jstree', function (e, data) {
				data = $.vakata.dnd._get();
				if(data && data.data && data.data.jstree) {
					data.helper.find('.jstree-copy').first()[ data.data.origin && (data.data.origin.settings.dnd.always_copy || (data.data.origin.settings.dnd.copy && (e.metaKey || e.ctrlKey))) ? 'show' : 'hide' ]();
				}
			});
	});

	// helpers
	(function ($) {
		$.vakata.html = {
			div : $('<div />'),
			escape : function (str) {
				return $.vakata.html.div.text(str).html();
			},
			strip : function (str) {
				return $.vakata.html.div.empty().append($.parseHTML(str)).text();
			}
		};
		// private variable
		var vakata_dnd = {
			element	: false,
			target	: false,
			is_down	: false,
			is_drag	: false,
			helper	: false,
			helper_w: 0,
			data	: false,
			init_x	: 0,
			init_y	: 0,
			scroll_l: 0,
			scroll_t: 0,
			scroll_e: false,
			scroll_i: false,
			is_touch: false
		};
		$.vakata.dnd = {
			settings : {
				scroll_speed		: 10,
				scroll_proximity	: 20,
				helper_left			: 5,
				helper_top			: 10,
				threshold			: 5,
				threshold_touch		: 50
			},
			_trigger : function (event_name, e) {
				var data = $.vakata.dnd._get();
				data.event = e;
				$(document).triggerHandler("dnd_" + event_name + ".vakata", data);
			},
			_get : function () {
				return {
					"data"		: vakata_dnd.data,
					"element"	: vakata_dnd.element,
					"helper"	: vakata_dnd.helper
				};
			},
			_clean : function () {
				if(vakata_dnd.helper) { vakata_dnd.helper.remove(); }
				if(vakata_dnd.scroll_i) { clearInterval(vakata_dnd.scroll_i); vakata_dnd.scroll_i = false; }
				vakata_dnd = {
					element	: false,
					target	: false,
					is_down	: false,
					is_drag	: false,
					helper	: false,
					helper_w: 0,
					data	: false,
					init_x	: 0,
					init_y	: 0,
					scroll_l: 0,
					scroll_t: 0,
					scroll_e: false,
					scroll_i: false,
					is_touch: false
				};
				$(document).off("mousemove.vakata.jstree touchmove.vakata.jstree", $.vakata.dnd.drag);
				$(document).off("mouseup.vakata.jstree touchend.vakata.jstree", $.vakata.dnd.stop);
			},
			_scroll : function (init_only) {
				if(!vakata_dnd.scroll_e || (!vakata_dnd.scroll_l && !vakata_dnd.scroll_t)) {
					if(vakata_dnd.scroll_i) { clearInterval(vakata_dnd.scroll_i); vakata_dnd.scroll_i = false; }
					return false;
				}
				if(!vakata_dnd.scroll_i) {
					vakata_dnd.scroll_i = setInterval($.vakata.dnd._scroll, 100);
					return false;
				}
				if(init_only === true) { return false; }

				var i = vakata_dnd.scroll_e.scrollTop(),
					j = vakata_dnd.scroll_e.scrollLeft();
				vakata_dnd.scroll_e.scrollTop(i + vakata_dnd.scroll_t * $.vakata.dnd.settings.scroll_speed);
				vakata_dnd.scroll_e.scrollLeft(j + vakata_dnd.scroll_l * $.vakata.dnd.settings.scroll_speed);
				if(i !== vakata_dnd.scroll_e.scrollTop() || j !== vakata_dnd.scroll_e.scrollLeft()) {
					/**
					 * triggered on the document when a drag causes an element to scroll
					 * @event
					 * @plugin dnd
					 * @name dnd_scroll.vakata
					 * @param {Mixed} data any data supplied with the call to $.vakata.dnd.start
					 * @param {DOM} element the DOM element being dragged
					 * @param {jQuery} helper the helper shown next to the mouse
					 * @param {jQuery} event the element that is scrolling
					 */
					$.vakata.dnd._trigger("scroll", vakata_dnd.scroll_e);
				}
			},
			start : function (e, data, html) {
				if(e.type === "touchstart" && e.originalEvent && e.originalEvent.changedTouches && e.originalEvent.changedTouches[0]) {
					e.pageX = e.originalEvent.changedTouches[0].pageX;
					e.pageY = e.originalEvent.changedTouches[0].pageY;
					e.target = document.elementFromPoint(e.originalEvent.changedTouches[0].pageX - window.pageXOffset, e.originalEvent.changedTouches[0].pageY - window.pageYOffset);
				}
				if(vakata_dnd.is_drag) { $.vakata.dnd.stop({}); }
				try {
					e.currentTarget.unselectable = "on";
					e.currentTarget.onselectstart = function() { return false; };
					if(e.currentTarget.style) { e.currentTarget.style.MozUserSelect = "none"; }
				} catch(ignore) { }
				vakata_dnd.init_x	= e.pageX;
				vakata_dnd.init_y	= e.pageY;
				vakata_dnd.data		= data;
				vakata_dnd.is_down	= true;
				vakata_dnd.element	= e.currentTarget;
				vakata_dnd.target	= e.target;
				vakata_dnd.is_touch	= e.type === "touchstart";
				if(html !== false) {
					vakata_dnd.helper = $("<div id='vakata-dnd'></div>").html(html).css({
						"display"		: "block",
						"margin"		: "0",
						"padding"		: "0",
						"position"		: "absolute",
						"top"			: "-2000px",
						"lineHeight"	: "16px",
						"zIndex"		: "10000"
					});
				}
				$(document).on("mousemove.vakata.jstree touchmove.vakata.jstree", $.vakata.dnd.drag);
				$(document).on("mouseup.vakata.jstree touchend.vakata.jstree", $.vakata.dnd.stop);
				return false;
			},
			drag : function (e) {
				if(e.type === "touchmove" && e.originalEvent && e.originalEvent.changedTouches && e.originalEvent.changedTouches[0]) {
					e.pageX = e.originalEvent.changedTouches[0].pageX;
					e.pageY = e.originalEvent.changedTouches[0].pageY;
					e.target = document.elementFromPoint(e.originalEvent.changedTouches[0].pageX - window.pageXOffset, e.originalEvent.changedTouches[0].pageY - window.pageYOffset);
				}
				if(!vakata_dnd.is_down) { return; }
				if(!vakata_dnd.is_drag) {
					if(
						Math.abs(e.pageX - vakata_dnd.init_x) > (vakata_dnd.is_touch ? $.vakata.dnd.settings.threshold_touch : $.vakata.dnd.settings.threshold) ||
						Math.abs(e.pageY - vakata_dnd.init_y) > (vakata_dnd.is_touch ? $.vakata.dnd.settings.threshold_touch : $.vakata.dnd.settings.threshold)
					) {
						if(vakata_dnd.helper) {
							vakata_dnd.helper.appendTo("body");
							vakata_dnd.helper_w = vakata_dnd.helper.outerWidth();
						}
						vakata_dnd.is_drag = true;
						/**
						 * triggered on the document when a drag starts
						 * @event
						 * @plugin dnd
						 * @name dnd_start.vakata
						 * @param {Mixed} data any data supplied with the call to $.vakata.dnd.start
						 * @param {DOM} element the DOM element being dragged
						 * @param {jQuery} helper the helper shown next to the mouse
						 * @param {Object} event the event that caused the start (probably mousemove)
						 */
						$.vakata.dnd._trigger("start", e);
					}
					else { return; }
				}

				var d  = false, w  = false,
					dh = false, wh = false,
					dw = false, ww = false,
					dt = false, dl = false,
					ht = false, hl = false;

				vakata_dnd.scroll_t = 0;
				vakata_dnd.scroll_l = 0;
				vakata_dnd.scroll_e = false;
				$($(e.target).parentsUntil("body").addBack().get().reverse())
					.filter(function () {
						return	(/^auto|scroll$/).test($(this).css("overflow")) &&
								(this.scrollHeight > this.offsetHeight || this.scrollWidth > this.offsetWidth);
					})
					.each(function () {
						var t = $(this), o = t.offset();
						if(this.scrollHeight > this.offsetHeight) {
							if(o.top + t.height() - e.pageY < $.vakata.dnd.settings.scroll_proximity)	{ vakata_dnd.scroll_t = 1; }
							if(e.pageY - o.top < $.vakata.dnd.settings.scroll_proximity)				{ vakata_dnd.scroll_t = -1; }
						}
						if(this.scrollWidth > this.offsetWidth) {
							if(o.left + t.width() - e.pageX < $.vakata.dnd.settings.scroll_proximity)	{ vakata_dnd.scroll_l = 1; }
							if(e.pageX - o.left < $.vakata.dnd.settings.scroll_proximity)				{ vakata_dnd.scroll_l = -1; }
						}
						if(vakata_dnd.scroll_t || vakata_dnd.scroll_l) {
							vakata_dnd.scroll_e = $(this);
							return false;
						}
					});

				if(!vakata_dnd.scroll_e) {
					d  = $(document); w = $(window);
					dh = d.height(); wh = w.height();
					dw = d.width(); ww = w.width();
					dt = d.scrollTop(); dl = d.scrollLeft();
					if(dh > wh && e.pageY - dt < $.vakata.dnd.settings.scroll_proximity)		{ vakata_dnd.scroll_t = -1;  }
					if(dh > wh && wh - (e.pageY - dt) < $.vakata.dnd.settings.scroll_proximity)	{ vakata_dnd.scroll_t = 1; }
					if(dw > ww && e.pageX - dl < $.vakata.dnd.settings.scroll_proximity)		{ vakata_dnd.scroll_l = -1; }
					if(dw > ww && ww - (e.pageX - dl) < $.vakata.dnd.settings.scroll_proximity)	{ vakata_dnd.scroll_l = 1; }
					if(vakata_dnd.scroll_t || vakata_dnd.scroll_l) {
						vakata_dnd.scroll_e = d;
					}
				}
				if(vakata_dnd.scroll_e) { $.vakata.dnd._scroll(true); }

				if(vakata_dnd.helper) {
					ht = parseInt(e.pageY + $.vakata.dnd.settings.helper_top, 10);
					hl = parseInt(e.pageX + $.vakata.dnd.settings.helper_left, 10);
					if(dh && ht + 25 > dh) { ht = dh - 50; }
					if(dw && hl + vakata_dnd.helper_w > dw) { hl = dw - (vakata_dnd.helper_w + 2); }
					vakata_dnd.helper.css({
						left	: hl + "px",
						top		: ht + "px"
					});
				}
				/**
				 * triggered on the document when a drag is in progress
				 * @event
				 * @plugin dnd
				 * @name dnd_move.vakata
				 * @param {Mixed} data any data supplied with the call to $.vakata.dnd.start
				 * @param {DOM} element the DOM element being dragged
				 * @param {jQuery} helper the helper shown next to the mouse
				 * @param {Object} event the event that caused this to trigger (most likely mousemove)
				 */
				$.vakata.dnd._trigger("move", e);
				return false;
			},
			stop : function (e) {
				if(e.type === "touchend" && e.originalEvent && e.originalEvent.changedTouches && e.originalEvent.changedTouches[0]) {
					e.pageX = e.originalEvent.changedTouches[0].pageX;
					e.pageY = e.originalEvent.changedTouches[0].pageY;
					e.target = document.elementFromPoint(e.originalEvent.changedTouches[0].pageX - window.pageXOffset, e.originalEvent.changedTouches[0].pageY - window.pageYOffset);
				}
				if(vakata_dnd.is_drag) {
					/**
					 * triggered on the document when a drag stops (the dragged element is dropped)
					 * @event
					 * @plugin dnd
					 * @name dnd_stop.vakata
					 * @param {Mixed} data any data supplied with the call to $.vakata.dnd.start
					 * @param {DOM} element the DOM element being dragged
					 * @param {jQuery} helper the helper shown next to the mouse
					 * @param {Object} event the event that caused the stop
					 */
					$.vakata.dnd._trigger("stop", e);
				}
				else {
					if(e.type === "touchend" && e.target === vakata_dnd.target) {
						var to = setTimeout(function () { $(e.target).click(); }, 100);
						$(e.target).one('click', function() { if(to) { clearTimeout(to); } });
					}
				}
				$.vakata.dnd._clean();
				return false;
			}
		};
	}($));

	// include the dnd plugin by default
	// $.jstree.defaults.plugins.push("dnd");


/**
 * ### Massload plugin
 *
 * Adds massload functionality to jsTree, so that multiple nodes can be loaded in a single request (only useful with lazy loading).
 */

	/**
	 * massload configuration
	 *
	 * It is possible to set this to a standard jQuery-like AJAX config.
	 * In addition to the standard jQuery ajax options here you can supply functions for `data` and `url`, the functions will be run in the current instance's scope and a param will be passed indicating which node IDs need to be loaded, the return value of those functions will be used.
	 *
	 * You can also set this to a function, that function will receive the node IDs being loaded as argument and a second param which is a function (callback) which should be called with the result.
	 *
	 * Both the AJAX and the function approach rely on the same return value - an object where the keys are the node IDs, and the value is the children of that node as an array.
	 *
	 *	{
	 *		"id1" : [{ "text" : "Child of ID1", "id" : "c1" }, { "text" : "Another child of ID1", "id" : "c2" }],
	 *		"id2" : [{ "text" : "Child of ID2", "id" : "c3" }]
	 *	}
	 * 
	 * @name $.jstree.defaults.massload
	 * @plugin massload
	 */
	$.jstree.defaults.massload = null;
	$.jstree.plugins.massload = function (options, parent) {
		this.init = function (el, options) {
			parent.init.call(this, el, options);
			this._data.massload = {};
		};
		this._load_nodes = function (nodes, callback, is_callback) {
			var s = this.settings.massload;
			if(is_callback && !$.isEmptyObject(this._data.massload)) {
				return parent._load_nodes.call(this, nodes, callback, is_callback);
			}
			if($.isFunction(s)) {
				return s.call(this, nodes, $.proxy(function (data) {
					if(data) {
						for(var i in data) {
							if(data.hasOwnProperty(i)) {
								this._data.massload[i] = data[i];
							}
						}
					}
					parent._load_nodes.call(this, nodes, callback, is_callback);
				}, this));
			}
			if(typeof s === 'object' && s && s.url) {
				s = $.extend(true, {}, s);
				if($.isFunction(s.url)) {
					s.url = s.url.call(this, nodes);
				}
				if($.isFunction(s.data)) {
					s.data = s.data.call(this, nodes);
				}
				return $.ajax(s)
					.done($.proxy(function (data,t,x) {
							if(data) {
								for(var i in data) {
									if(data.hasOwnProperty(i)) {
										this._data.massload[i] = data[i];
									}
								}
							}
							parent._load_nodes.call(this, nodes, callback, is_callback);
						}, this))
					.fail($.proxy(function (f) {
							parent._load_nodes.call(this, nodes, callback, is_callback);
						}, this));
			}
			return parent._load_nodes.call(this, nodes, callback, is_callback);
		};
		this._load_node = function (obj, callback) {
			var d = this._data.massload[obj.id];
			if(d) {
				return this[typeof d === 'string' ? '_append_html_data' : '_append_json_data'](obj, typeof d === 'string' ? $($.parseHTML(d)).filter(function () { return this.nodeType !== 3; }) : d, function (status) {
					callback.call(this, status);
					delete this._data.massload[obj.id];
				});
			}
			return parent._load_node.call(this, obj, callback);
		};
	};

/**
 * ### Search plugin
 *
 * Adds search functionality to jsTree.
 */

	/**
	 * stores all defaults for the search plugin
	 * @name $.jstree.defaults.search
	 * @plugin search
	 */
	$.jstree.defaults.search = {
		/**
		 * a jQuery-like AJAX config, which jstree uses if a server should be queried for results. 
		 * 
		 * A `str` (which is the search string) parameter will be added with the request, an optional `inside` parameter will be added if the search is limited to a node id. The expected result is a JSON array with nodes that need to be opened so that matching nodes will be revealed.
		 * Leave this setting as `false` to not query the server. You can also set this to a function, which will be invoked in the instance's scope and receive 3 parameters - the search string, the callback to call with the array of nodes to load, and the optional node ID to limit the search to 
		 * @name $.jstree.defaults.search.ajax
		 * @plugin search
		 */
		ajax : false,
		/**
		 * Indicates if the search should be fuzzy or not (should `chnd3` match `child node 3`). Default is `false`.
		 * @name $.jstree.defaults.search.fuzzy
		 * @plugin search
		 */
		fuzzy : false,
		/**
		 * Indicates if the search should be case sensitive. Default is `false`.
		 * @name $.jstree.defaults.search.case_sensitive
		 * @plugin search
		 */
		case_sensitive : false,
		/**
		 * Indicates if the tree should be filtered (by default) to show only matching nodes (keep in mind this can be a heavy on large trees in old browsers). 
		 * This setting can be changed at runtime when calling the search method. Default is `false`.
		 * @name $.jstree.defaults.search.show_only_matches
		 * @plugin search
		 */
		show_only_matches : false,
		/**
		 * Indicates if the children of matched element are shown (when show_only_matches is true)
		 * This setting can be changed at runtime when calling the search method. Default is `false`.
		 * @name $.jstree.defaults.search.show_only_matches_children
		 * @plugin search
		 */
		show_only_matches_children : false,
		/**
		 * Indicates if all nodes opened to reveal the search result, should be closed when the search is cleared or a new search is performed. Default is `true`.
		 * @name $.jstree.defaults.search.close_opened_onclear
		 * @plugin search
		 */
		close_opened_onclear : true,
		/**
		 * Indicates if only leaf nodes should be included in search results. Default is `false`.
		 * @name $.jstree.defaults.search.search_leaves_only
		 * @plugin search
		 */
		search_leaves_only : false,
		/**
		 * If set to a function it wil be called in the instance's scope with two arguments - search string and node (where node will be every node in the structure, so use with caution).
		 * If the function returns a truthy value the node will be considered a match (it might not be displayed if search_only_leaves is set to true and the node is not a leaf). Default is `false`.
		 * @name $.jstree.defaults.search.search_callback
		 * @plugin search
		 */
		search_callback : false
	};

	$.jstree.plugins.search = function (options, parent) {
		this.bind = function () {
			parent.bind.call(this);

			this._data.search.str = "";
			this._data.search.dom = $();
			this._data.search.res = [];
			this._data.search.opn = [];
			this._data.search.som = false;
			this._data.search.smc = false;

			this.element
				.on('before_open.jstree', $.proxy(function (e, data) {
						var i, j, f, r = this._data.search.res, s = [], o = $();
						if(r && r.length) {
							this._data.search.dom = $(this.element[0].querySelectorAll('#' + $.map(r, function (v) { return "0123456789".indexOf(v[0]) !== -1 ? '\\3' + v[0] + ' ' + v.substr(1).replace($.jstree.idregex,'\\$&') : v.replace($.jstree.idregex,'\\$&'); }).join(', #')));
							this._data.search.dom.children(".jstree-anchor").addClass('jstree-search');
							if(this._data.search.som && this._data.search.res.length) {
								for(i = 0, j = r.length; i < j; i++) {
									s = s.concat(this.get_node(r[i]).parents);
								}
								s = $.vakata.array_remove_item($.vakata.array_unique(s),'#');
								o = s.length ? $(this.element[0].querySelectorAll('#' + $.map(s, function (v) { return "0123456789".indexOf(v[0]) !== -1 ? '\\3' + v[0] + ' ' + v.substr(1).replace($.jstree.idregex,'\\$&') : v.replace($.jstree.idregex,'\\$&'); }).join(', #'))) : $();

								this.element.find(".jstree-node").hide().filter('.jstree-last').filter(function() { return this.nextSibling; }).removeClass('jstree-last');
								o = o.add(this._data.search.dom);
								if(this._data.search.smc) {
									this._data.search.dom.children(".jstree-children").find(".jstree-node").show();
								}
								o.parentsUntil(".jstree").addBack().show()
									.filter(".jstree-children").each(function () { $(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last"); });
							}
						}
					}, this))
				.on("search.jstree", $.proxy(function (e, data) {
						if(this._data.search.som) {
							if(data.nodes.length) {
								this.element.find(".jstree-node").hide().filter('.jstree-last').filter(function() { return this.nextSibling; }).removeClass('jstree-last');
								if(this._data.search.smc) {
									data.nodes.children(".jstree-children").find(".jstree-node").show();
								}
								data.nodes.parentsUntil(".jstree").addBack().show()
									.filter(".jstree-children").each(function () { $(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last"); });
							}
						}
					}, this))
				.on("clear_search.jstree", $.proxy(function (e, data) {
						if(this._data.search.som && data.nodes.length) {
							this.element.find(".jstree-node").css("display","").filter('.jstree-last').filter(function() { return this.nextSibling; }).removeClass('jstree-last');
						}
					}, this));
		};
		/**
		 * used to search the tree nodes for a given string
		 * @name search(str [, skip_async])
		 * @param {String} str the search string
		 * @param {Boolean} skip_async if set to true server will not be queried even if configured
		 * @param {Boolean} show_only_matches if set to true only matching nodes will be shown (keep in mind this can be very slow on large trees or old browsers)
		 * @param {mixed} inside an optional node to whose children to limit the search
		 * @param {Boolean} append if set to true the results of this search are appended to the previous search
		 * @plugin search
		 * @trigger search.jstree
		 */
		this.search = function (str, skip_async, show_only_matches, inside, append, show_only_matches_children) {
			if(str === false || $.trim(str.toString()) === "") {
				return this.clear_search();
			}
			inside = this.get_node(inside);
			inside = inside && inside.id ? inside.id : null;
			str = str.toString();
			var s = this.settings.search,
				a = s.ajax ? s.ajax : false,
				m = this._model.data,
				f = null,
				r = [],
				p = [], i, j;
			if(this._data.search.res.length && !append) {
				this.clear_search();
			}
			if(show_only_matches === undefined) {
				show_only_matches = s.show_only_matches;
			}
			if(show_only_matches_children === undefined) {
				show_only_matches_children = s.show_only_matches_children;
			}
			if(!skip_async && a !== false) {
				if($.isFunction(a)) {
					return a.call(this, str, $.proxy(function (d) {
							if(d && d.d) { d = d.d; }
							this._load_nodes(!$.isArray(d) ? [] : $.vakata.array_unique(d), function () {
								this.search(str, true, show_only_matches, inside, append);
							}, true);
						}, this), inside);
				}
				else {
					a = $.extend({}, a);
					if(!a.data) { a.data = {}; }
					a.data.str = str;
					if(inside) {
						a.data.inside = inside;
					}
					return $.ajax(a)
						.fail($.proxy(function () {
							this._data.core.last_error = { 'error' : 'ajax', 'plugin' : 'search', 'id' : 'search_01', 'reason' : 'Could not load search parents', 'data' : JSON.stringify(a) };
							this.settings.core.error.call(this, this._data.core.last_error);
						}, this))
						.done($.proxy(function (d) {
							if(d && d.d) { d = d.d; }
							this._load_nodes(!$.isArray(d) ? [] : $.vakata.array_unique(d), function () {
								this.search(str, true, show_only_matches, inside, append);
							}, true);
						}, this));
				}
			}
			if(!append) {
				this._data.search.str = str;
				this._data.search.dom = $();
				this._data.search.res = [];
				this._data.search.opn = [];
				this._data.search.som = show_only_matches;
				this._data.search.smc = show_only_matches_children;
			}

			f = new $.vakata.search(str, true, { caseSensitive : s.case_sensitive, fuzzy : s.fuzzy });
			$.each(m[inside ? inside : '#'].children_d, function (ii, i) {
				var v = m[i];
				if(v.text && ( (s.search_callback && s.search_callback.call(this, str, v)) || (!s.search_callback && f.search(v.text).isMatch) ) && (!s.search_leaves_only || (v.state.loaded && v.children.length === 0)) ) {
					r.push(i);
					p = p.concat(v.parents);
				}
			});
			if(r.length) {
				p = $.vakata.array_unique(p);
				this._search_open(p);
				if(!append) {
					this._data.search.dom = $(this.element[0].querySelectorAll('#' + $.map(r, function (v) { return "0123456789".indexOf(v[0]) !== -1 ? '\\3' + v[0] + ' ' + v.substr(1).replace($.jstree.idregex,'\\$&') : v.replace($.jstree.idregex,'\\$&'); }).join(', #')));
					this._data.search.res = r;
				}
				else {
					this._data.search.dom = this._data.search.dom.add($(this.element[0].querySelectorAll('#' + $.map(r, function (v) { return "0123456789".indexOf(v[0]) !== -1 ? '\\3' + v[0] + ' ' + v.substr(1).replace($.jstree.idregex,'\\$&') : v.replace($.jstree.idregex,'\\$&'); }).join(', #'))));
					this._data.search.res = $.vakata.array_unique(this._data.search.res.concat(r));
				}
				this._data.search.dom.children(".jstree-anchor").addClass('jstree-search');
			}
			/**
			 * triggered after search is complete
			 * @event
			 * @name search.jstree
			 * @param {jQuery} nodes a jQuery collection of matching nodes
			 * @param {String} str the search string
			 * @param {Array} res a collection of objects represeing the matching nodes
			 * @plugin search
			 */
			this.trigger('search', { nodes : this._data.search.dom, str : str, res : this._data.search.res, show_only_matches : show_only_matches });
		};
		/**
		 * used to clear the last search (removes classes and shows all nodes if filtering is on)
		 * @name clear_search()
		 * @plugin search
		 * @trigger clear_search.jstree
		 */
		this.clear_search = function () {
			this._data.search.dom.children(".jstree-anchor").removeClass("jstree-search");
			if(this.settings.search.close_opened_onclear) {
				this.close_node(this._data.search.opn, 0);
			}
			/**
			 * triggered after search is complete
			 * @event
			 * @name clear_search.jstree
			 * @param {jQuery} nodes a jQuery collection of matching nodes (the result from the last search)
			 * @param {String} str the search string (the last search string)
			 * @param {Array} res a collection of objects represeing the matching nodes (the result from the last search)
			 * @plugin search
			 */
			this.trigger('clear_search', { 'nodes' : this._data.search.dom, str : this._data.search.str, res : this._data.search.res });
			this._data.search.str = "";
			this._data.search.res = [];
			this._data.search.opn = [];
			this._data.search.dom = $();
		};
		/**
		 * opens nodes that need to be opened to reveal the search results. Used only internally.
		 * @private
		 * @name _search_open(d)
		 * @param {Array} d an array of node IDs
		 * @plugin search
		 */
		this._search_open = function (d) {
			var t = this;
			$.each(d.concat([]), function (i, v) {
				if(v === "#") { return true; }
				try { v = $('#' + v.replace($.jstree.idregex,'\\$&'), t.element); } catch(ignore) { }
				if(v && v.length) {
					if(t.is_closed(v)) {
						t._data.search.opn.push(v[0].id);
						t.open_node(v, function () { t._search_open(d); }, 0);
					}
				}
			});
		};
	};

	// helpers
	(function ($) {
		// from http://kiro.me/projects/fuse.html
		$.vakata.search = function(pattern, txt, options) {
			options = options || {};
			options = $.extend({}, $.vakata.search.defaults, options);
			if(options.fuzzy !== false) {
				options.fuzzy = true;
			}
			pattern = options.caseSensitive ? pattern : pattern.toLowerCase();
			var MATCH_LOCATION	= options.location,
				MATCH_DISTANCE	= options.distance,
				MATCH_THRESHOLD	= options.threshold,
				patternLen = pattern.length,
				matchmask, pattern_alphabet, match_bitapScore, search;
			if(patternLen > 32) {
				options.fuzzy = false;
			}
			if(options.fuzzy) {
				matchmask = 1 << (patternLen - 1);
				pattern_alphabet = (function () {
					var mask = {},
						i = 0;
					for (i = 0; i < patternLen; i++) {
						mask[pattern.charAt(i)] = 0;
					}
					for (i = 0; i < patternLen; i++) {
						mask[pattern.charAt(i)] |= 1 << (patternLen - i - 1);
					}
					return mask;
				}());
				match_bitapScore = function (e, x) {
					var accuracy = e / patternLen,
						proximity = Math.abs(MATCH_LOCATION - x);
					if(!MATCH_DISTANCE) {
						return proximity ? 1.0 : accuracy;
					}
					return accuracy + (proximity / MATCH_DISTANCE);
				};
			}
			search = function (text) {
				text = options.caseSensitive ? text : text.toLowerCase();
				if(pattern === text || text.indexOf(pattern) !== -1) {
					return {
						isMatch: true,
						score: 0
					};
				}
				if(!options.fuzzy) {
					return {
						isMatch: false,
						score: 1
					};
				}
				var i, j,
					textLen = text.length,
					scoreThreshold = MATCH_THRESHOLD,
					bestLoc = text.indexOf(pattern, MATCH_LOCATION),
					binMin, binMid,
					binMax = patternLen + textLen,
					lastRd, start, finish, rd, charMatch,
					score = 1,
					locations = [];
				if (bestLoc !== -1) {
					scoreThreshold = Math.min(match_bitapScore(0, bestLoc), scoreThreshold);
					bestLoc = text.lastIndexOf(pattern, MATCH_LOCATION + patternLen);
					if (bestLoc !== -1) {
						scoreThreshold = Math.min(match_bitapScore(0, bestLoc), scoreThreshold);
					}
				}
				bestLoc = -1;
				for (i = 0; i < patternLen; i++) {
					binMin = 0;
					binMid = binMax;
					while (binMin < binMid) {
						if (match_bitapScore(i, MATCH_LOCATION + binMid) <= scoreThreshold) {
							binMin = binMid;
						} else {
							binMax = binMid;
						}
						binMid = Math.floor((binMax - binMin) / 2 + binMin);
					}
					binMax = binMid;
					start = Math.max(1, MATCH_LOCATION - binMid + 1);
					finish = Math.min(MATCH_LOCATION + binMid, textLen) + patternLen;
					rd = new Array(finish + 2);
					rd[finish + 1] = (1 << i) - 1;
					for (j = finish; j >= start; j--) {
						charMatch = pattern_alphabet[text.charAt(j - 1)];
						if (i === 0) {
							rd[j] = ((rd[j + 1] << 1) | 1) & charMatch;
						} else {
							rd[j] = ((rd[j + 1] << 1) | 1) & charMatch | (((lastRd[j + 1] | lastRd[j]) << 1) | 1) | lastRd[j + 1];
						}
						if (rd[j] & matchmask) {
							score = match_bitapScore(i, j - 1);
							if (score <= scoreThreshold) {
								scoreThreshold = score;
								bestLoc = j - 1;
								locations.push(bestLoc);
								if (bestLoc > MATCH_LOCATION) {
									start = Math.max(1, 2 * MATCH_LOCATION - bestLoc);
								} else {
									break;
								}
							}
						}
					}
					if (match_bitapScore(i + 1, MATCH_LOCATION) > scoreThreshold) {
						break;
					}
					lastRd = rd;
				}
				return {
					isMatch: bestLoc >= 0,
					score: score
				};
			};
			return txt === true ? { 'search' : search } : search(txt);
		};
		$.vakata.search.defaults = {
			location : 0,
			distance : 100,
			threshold : 0.6,
			fuzzy : false,
			caseSensitive : false
		};
	}($));

	// include the search plugin by default
	// $.jstree.defaults.plugins.push("search");

/**
 * ### Sort plugin
 *
 * Automatically sorts all siblings in the tree according to a sorting function.
 */

	/**
	 * the settings function used to sort the nodes.
	 * It is executed in the tree's context, accepts two nodes as arguments and should return `1` or `-1`.
	 * @name $.jstree.defaults.sort
	 * @plugin sort
	 */
	$.jstree.defaults.sort = function (a, b) {
		//return this.get_type(a) === this.get_type(b) ? (this.get_text(a) > this.get_text(b) ? 1 : -1) : this.get_type(a) >= this.get_type(b);
		return this.get_text(a) > this.get_text(b) ? 1 : -1;
	};
	$.jstree.plugins.sort = function (options, parent) {
		this.bind = function () {
			parent.bind.call(this);
			this.element
				.on("model.jstree", $.proxy(function (e, data) {
						this.sort(data.parent, true);
					}, this))
				.on("rename_node.jstree create_node.jstree", $.proxy(function (e, data) {
						this.sort(data.parent || data.node.parent, false);
						this.redraw_node(data.parent || data.node.parent, true);
					}, this))
				.on("move_node.jstree copy_node.jstree", $.proxy(function (e, data) {
						this.sort(data.parent, false);
						this.redraw_node(data.parent, true);
					}, this));
		};
		/**
		 * used to sort a node's children
		 * @private
		 * @name sort(obj [, deep])
		 * @param  {mixed} obj the node
		 * @param {Boolean} deep if set to `true` nodes are sorted recursively.
		 * @plugin sort
		 * @trigger search.jstree
		 */
		this.sort = function (obj, deep) {
			var i, j;
			obj = this.get_node(obj);
			if(obj && obj.children && obj.children.length) {
				obj.children.sort($.proxy(this.settings.sort, this));
				if(deep) {
					for(i = 0, j = obj.children_d.length; i < j; i++) {
						this.sort(obj.children_d[i], false);
					}
				}
			}
		};
	};

	// include the sort plugin by default
	// $.jstree.defaults.plugins.push("sort");

/**
 * ### State plugin
 *
 * Saves the state of the tree (selected nodes, opened nodes) on the user's computer using available options (localStorage, cookies, etc)
 */

	var to = false;
	/**
	 * stores all defaults for the state plugin
	 * @name $.jstree.defaults.state
	 * @plugin state
	 */
	$.jstree.defaults.state = {
		/**
		 * A string for the key to use when saving the current tree (change if using multiple trees in your project). Defaults to `jstree`.
		 * @name $.jstree.defaults.state.key
		 * @plugin state
		 */
		key		: 'jstree',
		/**
		 * A space separated list of events that trigger a state save. Defaults to `changed.jstree open_node.jstree close_node.jstree`.
		 * @name $.jstree.defaults.state.events
		 * @plugin state
		 */
		events	: 'changed.jstree open_node.jstree close_node.jstree check_node.jstree uncheck_node.jstree',
		/**
		 * Time in milliseconds after which the state will expire. Defaults to 'false' meaning - no expire.
		 * @name $.jstree.defaults.state.ttl
		 * @plugin state
		 */
		ttl		: false,
		/**
		 * A function that will be executed prior to restoring state with one argument - the state object. Can be used to clear unwanted parts of the state.
		 * @name $.jstree.defaults.state.filter
		 * @plugin state
		 */
		filter	: false
	};
	$.jstree.plugins.state = function (options, parent) {
		this.bind = function () {
			parent.bind.call(this);
			var bind = $.proxy(function () {
				this.element.on(this.settings.state.events, $.proxy(function () {
					if(to) { clearTimeout(to); }
					to = setTimeout($.proxy(function () { this.save_state(); }, this), 100);
				}, this));
				/**
				 * triggered when the state plugin is finished restoring the state (and immediately after ready if there is no state to restore).
				 * @event
				 * @name state_ready.jstree
				 * @plugin state
				 */
				this.trigger('state_ready');
			}, this);
			this.element
				.on("ready.jstree", $.proxy(function (e, data) {
						this.element.one("restore_state.jstree", bind);
						if(!this.restore_state()) { bind(); }
					}, this));
		};
		/**
		 * save the state
		 * @name save_state()
		 * @plugin state
		 */
		this.save_state = function () {
			var st = { 'state' : this.get_state(), 'ttl' : this.settings.state.ttl, 'sec' : +(new Date()) };
			$.vakata.storage.set(this.settings.state.key, JSON.stringify(st));
		};
		/**
		 * restore the state from the user's computer
		 * @name restore_state()
		 * @plugin state
		 */
		this.restore_state = function () {
			var k = $.vakata.storage.get(this.settings.state.key);
			if(!!k) { try { k = JSON.parse(k); } catch(ex) { return false; } }
			if(!!k && k.ttl && k.sec && +(new Date()) - k.sec > k.ttl) { return false; }
			if(!!k && k.state) { k = k.state; }
			if(!!k && $.isFunction(this.settings.state.filter)) { k = this.settings.state.filter.call(this, k); }
			if(!!k) {
				this.element.one("set_state.jstree", function (e, data) { data.instance.trigger('restore_state', { 'state' : $.extend(true, {}, k) }); });
				this.set_state(k);
				return true;
			}
			return false;
		};
		/**
		 * clear the state on the user's computer
		 * @name clear_state()
		 * @plugin state
		 */
		this.clear_state = function () {
			return $.vakata.storage.del(this.settings.state.key);
		};
	};

	(function ($, undefined) {
		$.vakata.storage = {
			// simply specifying the functions in FF throws an error
			set : function (key, val) { return window.localStorage.setItem(key, val); },
			get : function (key) { return window.localStorage.getItem(key); },
			del : function (key) { return window.localStorage.removeItem(key); }
		};
	}($));

	// include the state plugin by default
	// $.jstree.defaults.plugins.push("state");

/**
 * ### Types plugin
 *
 * Makes it possible to add predefined types for groups of nodes, which make it possible to easily control nesting rules and icon for each group.
 */

	/**
	 * An object storing all types as key value pairs, where the key is the type name and the value is an object that could contain following keys (all optional).
	 *
	 * * `max_children` the maximum number of immediate children this node type can have. Do not specify or set to `-1` for unlimited.
	 * * `max_depth` the maximum number of nesting this node type can have. A value of `1` would mean that the node can have children, but no grandchildren. Do not specify or set to `-1` for unlimited.
	 * * `valid_children` an array of node type strings, that nodes of this type can have as children. Do not specify or set to `-1` for no limits.
	 * * `icon` a string - can be a path to an icon or a className, if using an image that is in the current directory use a `./` prefix, otherwise it will be detected as a class. Omit to use the default icon from your theme.
	 *
	 * There are two predefined types:
	 *
	 * * `#` represents the root of the tree, for example `max_children` would control the maximum number of root nodes.
	 * * `default` represents the default node - any settings here will be applied to all nodes that do not have a type specified.
	 *
	 * @name $.jstree.defaults.types
	 * @plugin types
	 */
	$.jstree.defaults.types = {
		'#' : {},
		'default' : {}
	};

	$.jstree.plugins.types = function (options, parent) {
		this.init = function (el, options) {
			var i, j;
			if(options && options.types && options.types['default']) {
				for(i in options.types) {
					if(i !== "default" && i !== "#" && options.types.hasOwnProperty(i)) {
						for(j in options.types['default']) {
							if(options.types['default'].hasOwnProperty(j) && options.types[i][j] === undefined) {
								options.types[i][j] = options.types['default'][j];
							}
						}
					}
				}
			}
			parent.init.call(this, el, options);
			this._model.data['#'].type = '#';
		};
		this.refresh = function (skip_loading, forget_state) {
			parent.refresh.call(this, skip_loading, forget_state);
			this._model.data['#'].type = '#';
		};
		this.bind = function () {
			this.element
				.on('model.jstree', $.proxy(function (e, data) {
						var m = this._model.data,
							dpc = data.nodes,
							t = this.settings.types,
							i, j, c = 'default';
						for(i = 0, j = dpc.length; i < j; i++) {
							c = 'default';
							if(m[dpc[i]].original && m[dpc[i]].original.type && t[m[dpc[i]].original.type]) {
								c = m[dpc[i]].original.type;
							}
							if(m[dpc[i]].data && m[dpc[i]].data.jstree && m[dpc[i]].data.jstree.type && t[m[dpc[i]].data.jstree.type]) {
								c = m[dpc[i]].data.jstree.type;
							}
							m[dpc[i]].type = c;
							if(m[dpc[i]].icon === true && t[c].icon !== undefined) {
								m[dpc[i]].icon = t[c].icon;
							}
						}
						m['#'].type = '#';
					}, this));
			parent.bind.call(this);
		};
		this.get_json = function (obj, options, flat) {
			var i, j,
				m = this._model.data,
				opt = options ? $.extend(true, {}, options, {no_id:false}) : {},
				tmp = parent.get_json.call(this, obj, opt, flat);
			if(tmp === false) { return false; }
			if($.isArray(tmp)) {
				for(i = 0, j = tmp.length; i < j; i++) {
					tmp[i].type = tmp[i].id && m[tmp[i].id] && m[tmp[i].id].type ? m[tmp[i].id].type : "default";
					if(options && options.no_id) {
						delete tmp[i].id;
						if(tmp[i].li_attr && tmp[i].li_attr.id) {
							delete tmp[i].li_attr.id;
						}
						if(tmp[i].a_attr && tmp[i].a_attr.id) {
							delete tmp[i].a_attr.id;
						}
					}
				}
			}
			else {
				tmp.type = tmp.id && m[tmp.id] && m[tmp.id].type ? m[tmp.id].type : "default";
				if(options && options.no_id) {
					tmp = this._delete_ids(tmp);
				}
			}
			return tmp;
		};
		this._delete_ids = function (tmp) {
			if($.isArray(tmp)) {
				for(var i = 0, j = tmp.length; i < j; i++) {
					tmp[i] = this._delete_ids(tmp[i]);
				}
				return tmp;
			}
			delete tmp.id;
			if(tmp.li_attr && tmp.li_attr.id) {
				delete tmp.li_attr.id;
			}
			if(tmp.a_attr && tmp.a_attr.id) {
				delete tmp.a_attr.id;
			}
			if(tmp.children && $.isArray(tmp.children)) {
				tmp.children = this._delete_ids(tmp.children);
			}
			return tmp;
		};
		this.check = function (chk, obj, par, pos, more) {
			if(parent.check.call(this, chk, obj, par, pos, more) === false) { return false; }
			obj = obj && obj.id ? obj : this.get_node(obj);
			par = par && par.id ? par : this.get_node(par);
			var m = obj && obj.id ? (more && more.origin ? more.origin : $.jstree.reference(obj.id)) : null, tmp, d, i, j;
			m = m && m._model && m._model.data ? m._model.data : null;
			switch(chk) {
				case "create_node":
				case "move_node":
				case "copy_node":
					if(chk !== 'move_node' || $.inArray(obj.id, par.children) === -1) {
						tmp = this.get_rules(par);
						if(tmp.max_children !== undefined && tmp.max_children !== -1 && tmp.max_children === par.children.length) {
							this._data.core.last_error = { 'error' : 'check', 'plugin' : 'types', 'id' : 'types_01', 'reason' : 'max_children prevents function: ' + chk, 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
							return false;
						}
						if(tmp.valid_children !== undefined && tmp.valid_children !== -1 && $.inArray((obj.type || 'default'), tmp.valid_children) === -1) {
							this._data.core.last_error = { 'error' : 'check', 'plugin' : 'types', 'id' : 'types_02', 'reason' : 'valid_children prevents function: ' + chk, 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
							return false;
						}
						if(m && obj.children_d && obj.parents) {
							d = 0;
							for(i = 0, j = obj.children_d.length; i < j; i++) {
								d = Math.max(d, m[obj.children_d[i]].parents.length);
							}
							d = d - obj.parents.length + 1;
						}
						if(d <= 0 || d === undefined) { d = 1; }
						do {
							if(tmp.max_depth !== undefined && tmp.max_depth !== -1 && tmp.max_depth < d) {
								this._data.core.last_error = { 'error' : 'check', 'plugin' : 'types', 'id' : 'types_03', 'reason' : 'max_depth prevents function: ' + chk, 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
								return false;
							}
							par = this.get_node(par.parent);
							tmp = this.get_rules(par);
							d++;
						} while(par);
					}
					break;
			}
			return true;
		};
		/**
		 * used to retrieve the type settings object for a node
		 * @name get_rules(obj)
		 * @param {mixed} obj the node to find the rules for
		 * @return {Object}
		 * @plugin types
		 */
		this.get_rules = function (obj) {
			obj = this.get_node(obj);
			if(!obj) { return false; }
			var tmp = this.get_type(obj, true);
			if(tmp.max_depth === undefined) { tmp.max_depth = -1; }
			if(tmp.max_children === undefined) { tmp.max_children = -1; }
			if(tmp.valid_children === undefined) { tmp.valid_children = -1; }
			return tmp;
		};
		/**
		 * used to retrieve the type string or settings object for a node
		 * @name get_type(obj [, rules])
		 * @param {mixed} obj the node to find the rules for
		 * @param {Boolean} rules if set to `true` instead of a string the settings object will be returned
		 * @return {String|Object}
		 * @plugin types
		 */
		this.get_type = function (obj, rules) {
			obj = this.get_node(obj);
			return (!obj) ? false : ( rules ? $.extend({ 'type' : obj.type }, this.settings.types[obj.type]) : obj.type);
		};
		/**
		 * used to change a node's type
		 * @name set_type(obj, type)
		 * @param {mixed} obj the node to change
		 * @param {String} type the new type
		 * @plugin types
		 */
		this.set_type = function (obj, type) {
			var t, t1, t2, old_type, old_icon;
			if($.isArray(obj)) {
				obj = obj.slice();
				for(t1 = 0, t2 = obj.length; t1 < t2; t1++) {
					this.set_type(obj[t1], type);
				}
				return true;
			}
			t = this.settings.types;
			obj = this.get_node(obj);
			if(!t[type] || !obj) { return false; }
			old_type = obj.type;
			old_icon = this.get_icon(obj);
			obj.type = type;
			if(old_icon === true || (t[old_type] && t[old_type].icon !== undefined && old_icon === t[old_type].icon)) {
				this.set_icon(obj, t[type].icon !== undefined ? t[type].icon : true);
			}
			return true;
		};
	};
	// include the types plugin by default
	// $.jstree.defaults.plugins.push("types");

/**
 * ### Unique plugin
 *
 * Enforces that no nodes with the same name can coexist as siblings.
 */

	/**
	 * stores all defaults for the unique plugin
	 * @name $.jstree.defaults.unique
	 * @plugin unique
	 */
	$.jstree.defaults.unique = {
		/**
		 * Indicates if the comparison should be case sensitive. Default is `false`.
		 * @name $.jstree.defaults.unique.case_sensitive
		 * @plugin unique
		 */
		case_sensitive : false,
		/**
		 * A callback executed in the instance's scope when a new node is created and the name is already taken, the two arguments are the conflicting name and the counter. The default will produce results like `New node (2)`.
		 * @name $.jstree.defaults.unique.duplicate
		 * @plugin unique
		 */
		duplicate : function (name, counter) {
			return name + ' (' + counter + ')';
		}
	};

	$.jstree.plugins.unique = function (options, parent) {
		this.check = function (chk, obj, par, pos, more) {
			if(parent.check.call(this, chk, obj, par, pos, more) === false) { return false; }
			obj = obj && obj.id ? obj : this.get_node(obj);
			par = par && par.id ? par : this.get_node(par);
			if(!par || !par.children) { return true; }
			var n = chk === "rename_node" ? pos : obj.text,
				c = [],
				s = this.settings.unique.case_sensitive,
				m = this._model.data, i, j;
			for(i = 0, j = par.children.length; i < j; i++) {
				c.push(s ? m[par.children[i]].text : m[par.children[i]].text.toLowerCase());
			}
			if(!s) { n = n.toLowerCase(); }
			switch(chk) {
				case "delete_node":
					return true;
				case "rename_node":
					i = ($.inArray(n, c) === -1 || (obj.text && obj.text[ s ? 'toString' : 'toLowerCase']() === n));
					if(!i) {
						this._data.core.last_error = { 'error' : 'check', 'plugin' : 'unique', 'id' : 'unique_01', 'reason' : 'Child with name ' + n + ' already exists. Preventing: ' + chk, 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
					}
					return i;
				case "create_node":
					i = ($.inArray(n, c) === -1);
					if(!i) {
						this._data.core.last_error = { 'error' : 'check', 'plugin' : 'unique', 'id' : 'unique_04', 'reason' : 'Child with name ' + n + ' already exists. Preventing: ' + chk, 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
					}
					return i;
				case "copy_node":
					i = ($.inArray(n, c) === -1);
					if(!i) {
						this._data.core.last_error = { 'error' : 'check', 'plugin' : 'unique', 'id' : 'unique_02', 'reason' : 'Child with name ' + n + ' already exists. Preventing: ' + chk, 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
					}
					return i;
				case "move_node":
					i = ( (obj.parent === par.id && (!more || !more.is_multi)) || $.inArray(n, c) === -1);
					if(!i) {
						this._data.core.last_error = { 'error' : 'check', 'plugin' : 'unique', 'id' : 'unique_03', 'reason' : 'Child with name ' + n + ' already exists. Preventing: ' + chk, 'data' : JSON.stringify({ 'chk' : chk, 'pos' : pos, 'obj' : obj && obj.id ? obj.id : false, 'par' : par && par.id ? par.id : false }) };
					}
					return i;
			}
			return true;
		};
		this.create_node = function (par, node, pos, callback, is_loaded) {
			if(!node || node.text === undefined) {
				if(par === null) {
					par = "#";
				}
				par = this.get_node(par);
				if(!par) {
					return parent.create_node.call(this, par, node, pos, callback, is_loaded);
				}
				pos = pos === undefined ? "last" : pos;
				if(!pos.toString().match(/^(before|after)$/) && !is_loaded && !this.is_loaded(par)) {
					return parent.create_node.call(this, par, node, pos, callback, is_loaded);
				}
				if(!node) { node = {}; }
				var tmp, n, dpc, i, j, m = this._model.data, s = this.settings.unique.case_sensitive, cb = this.settings.unique.duplicate;
				n = tmp = this.get_string('New node');
				dpc = [];
				for(i = 0, j = par.children.length; i < j; i++) {
					dpc.push(s ? m[par.children[i]].text : m[par.children[i]].text.toLowerCase());
				}
				i = 1;
				while($.inArray(s ? n : n.toLowerCase(), dpc) !== -1) {
					n = cb.call(this, tmp, (++i)).toString();
				}
				node.text = n;
			}
			return parent.create_node.call(this, par, node, pos, callback, is_loaded);
		};
	};

	// include the unique plugin by default
	// $.jstree.defaults.plugins.push("unique");


/**
 * ### Wholerow plugin
 *
 * Makes each node appear block level. Making selection easier. May cause slow down for large trees in old browsers.
 */

	var div = document.createElement('DIV');
	div.setAttribute('unselectable','on');
	div.setAttribute('role','presentation');
	div.className = 'jstree-wholerow';
	div.innerHTML = '&#160;';
	$.jstree.plugins.wholerow = function (options, parent) {
		this.bind = function () {
			parent.bind.call(this);

			this.element
				.on('ready.jstree set_state.jstree', $.proxy(function () {
						this.hide_dots();
					}, this))
				.on("init.jstree loading.jstree ready.jstree", $.proxy(function () {
						//div.style.height = this._data.core.li_height + 'px';
						this.get_container_ul().addClass('jstree-wholerow-ul');
					}, this))
				.on("deselect_all.jstree", $.proxy(function (e, data) {
						this.element.find('.jstree-wholerow-clicked').removeClass('jstree-wholerow-clicked');
					}, this))
				.on("changed.jstree", $.proxy(function (e, data) {
						this.element.find('.jstree-wholerow-clicked').removeClass('jstree-wholerow-clicked');
						var tmp = false, i, j;
						for(i = 0, j = data.selected.length; i < j; i++) {
							tmp = this.get_node(data.selected[i], true);
							if(tmp && tmp.length) {
								tmp.children('.jstree-wholerow').addClass('jstree-wholerow-clicked');
							}
						}
					}, this))
				.on("open_node.jstree", $.proxy(function (e, data) {
						this.get_node(data.node, true).find('.jstree-clicked').parent().children('.jstree-wholerow').addClass('jstree-wholerow-clicked');
					}, this))
				.on("hover_node.jstree dehover_node.jstree", $.proxy(function (e, data) {
						if(e.type === "hover_node" && this.is_disabled(data.node)) { return; }
						this.get_node(data.node, true).children('.jstree-wholerow')[e.type === "hover_node"?"addClass":"removeClass"]('jstree-wholerow-hovered');
					}, this))
				.on("contextmenu.jstree", ".jstree-wholerow", $.proxy(function (e) {
						e.preventDefault();
						var tmp = $.Event('contextmenu', { metaKey : e.metaKey, ctrlKey : e.ctrlKey, altKey : e.altKey, shiftKey : e.shiftKey, pageX : e.pageX, pageY : e.pageY });
						$(e.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(tmp);
					}, this))
				/*!
				.on("mousedown.jstree touchstart.jstree", ".jstree-wholerow", function (e) {
						if(e.target === e.currentTarget) {
							var a = $(e.currentTarget).closest(".jstree-node").children(".jstree-anchor");
							e.target = a[0];
							a.trigger(e);
						}
					})
				*/
				.on("click.jstree", ".jstree-wholerow", function (e) {
						e.stopImmediatePropagation();
						var tmp = $.Event('click', { metaKey : e.metaKey, ctrlKey : e.ctrlKey, altKey : e.altKey, shiftKey : e.shiftKey });
						$(e.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(tmp).focus();
					})
				.on("click.jstree", ".jstree-leaf > .jstree-ocl", $.proxy(function (e) {
						e.stopImmediatePropagation();
						var tmp = $.Event('click', { metaKey : e.metaKey, ctrlKey : e.ctrlKey, altKey : e.altKey, shiftKey : e.shiftKey });
						$(e.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(tmp).focus();
					}, this))
				.on("mouseover.jstree", ".jstree-wholerow, .jstree-icon", $.proxy(function (e) {
						e.stopImmediatePropagation();
						if(!this.is_disabled(e.currentTarget)) {
							this.hover_node(e.currentTarget);
						}
						return false;
					}, this))
				.on("mouseleave.jstree", ".jstree-node", $.proxy(function (e) {
						this.dehover_node(e.currentTarget);
					}, this));
		};
		this.teardown = function () {
			if(this.settings.wholerow) {
				this.element.find(".jstree-wholerow").remove();
			}
			parent.teardown.call(this);
		};
		this.redraw_node = function(obj, deep, callback, force_render) {
			obj = parent.redraw_node.apply(this, arguments);
			if(obj) {
				var tmp = div.cloneNode(true);
				//tmp.style.height = this._data.core.li_height + 'px';
				if($.inArray(obj.id, this._data.core.selected) !== -1) { tmp.className += ' jstree-wholerow-clicked'; }
				if(this._data.core.focused && this._data.core.focused === obj.id) { tmp.className += ' jstree-wholerow-hovered'; }
				obj.insertBefore(tmp, obj.childNodes[0]);
			}
			return obj;
		};
	};
	// include the wholerow plugin by default
	// $.jstree.defaults.plugins.push("wholerow");
	if(document.registerElement && Object && Object.create) {
		var proto = Object.create(HTMLElement.prototype);
		proto.createdCallback = function () {
			var c = { core : {}, plugins : [] }, i;
			for(i in $.jstree.plugins) {
				if($.jstree.plugins.hasOwnProperty(i) && this.attributes[i]) {
					c.plugins.push(i);
					if(this.getAttribute(i) && JSON.parse(this.getAttribute(i))) {
						c[i] = JSON.parse(this.getAttribute(i));
					}
				}
			}
			for(i in $.jstree.defaults.core) {
				if($.jstree.defaults.core.hasOwnProperty(i) && this.attributes[i]) {
					c.core[i] = JSON.parse(this.getAttribute(i)) || this.getAttribute(i);
				}
			}
			$(this).jstree(c);
		};
		// proto.attributeChangedCallback = function (name, previous, value) { };
		try {
			document.registerElement("vakata-jstree", { prototype: proto });
		} catch(ignore) { }
	}

}));

// 不管外面怎么调用，其实只让他new 一次即可，可是事件的话，因为在有的应用中不需要事件，要不将事件标记加到tree的data上

it.TreeView = function(mainPane){
    this.mainPane = mainPane;
    if(!this.mainPane){
        this.mainPane = $('body');
    }
    var self = this;
    this.treeView = $('<div id = "plugin_tree_view_id" class="black-font-color"></div>');
        // on事件一开始就加上，只要添加一次即可，如果在setData的时候则会出现添加多次的情况
    this.treeView
        .on("changed.jstree", function(e, data){
            self.clickNode(e, data);
        })
        .on("hover_node.jstree", function(e, data){
            self.mouseover(e, data);
        })
        .jstree({
                'core' : {
                    'data' : [],
                    "themes": { "theme": "default", "dots": false, "icons": true } //"dots": false,
               }
       });
    this.treePane = $('<div id="tree-content" class="scroll-class" style="height:100px;overflow:auto; position: relative;display: block;top:15px"></div>');
    this.treePane.append(this.treeView);
    this.mainPane.append(this.treePane);
    this.dataSet = null;

    this.clickNodeFunction = null;
    this.mouseoverNodeFunction = null;
    this.sortFunction = null;

};

mono.extend(it.TreeView,Object,{

    isClick : function(data){
        return true;
    },

    clickNode : function(e, data){
        if(data.selected.length) {
            var asset = data.instance.get_node(data.selected[0]);
            if(asset.select_flag){ // 如果是联动选中的标记的话，就直接返回
                delete asset.select_flag;
                return;
            }
            if(asset.original) {
                if(this.clickNodeFunction){
                    this.clickNodeFunction(asset.original,data);
                }
            }
        }
    },

    mouseover : function(e,data){
        if(!data || !data.node || !data.node.original){
            return ;
        }
        if(this.mouseoverNodeFunction){
            this.mouseoverNodeFunction(data.node.original);
        }
        var tooltopText = data.node.original.text;
        if(tooltopText){
            tooltopText = tooltopText.replace('<label color=#F00>','');
            tooltopText = tooltopText.replace('</label>','');
            var nodeId = data.node.id;
            if (nodeId) {
                nodeId = nodeId.replaceAll('/','\\/');
                // nodeId = nodeId.replace('\\','\\\\');
                nodeId = nodeId.replaceAll('@','\\@');
            }
            $("#"+nodeId).prop('title',tooltopText);
        }
    },

    isSortById : function(){
        return false;
    },

    /**
     * tree的排序
     * @param treeNode1 是tree结点的类型
     * @param treeNode2 是tree结点的类型
     * @returns {number}
     */
    sort: function(treeNode1, treeNode2) {
        if (this.sortFunction) {
            return this.sortFunction(treeNode1, treeNode2);
        }
        // if (treeNode1 && treeNode2 && treeNode1.text && treeNode2.text) {
        //     if (treeNode1.text > treeNode2.text) {
        //         return 1;
        //     }else if (treeNode2.text > treeNode1.text) {
        //         return -1;
        //     }else {
        //         return 0;
        //     }
        // }
        // return 0;
        var text1, text2;
        if (treeNode1) {
            if (this.isSortById()) {
                text1 = treeNode1.id;
            } else {
                text1 = treeNode1.text;
            }
        } else {
            text1 = treeNode1;
        }
        if (treeNode2) {
            if (this.isSortById()) {
                text1 = treeNode2.id;
            } else {
                text2 = treeNode2.text;
            }
        } else {
            text2 = treeNode2;
        }
        return it.Util.compare(text1, text2);
    },

    /**
     * 往tree中添加数据
     * @param data{[]} 数据集合
     * @param withIcon 是否显示图标，true显示图标，false不显示图标
     */
    setData: function (data, withIcon) {
        if(!this.dataSet && !data) return ;
        this.dataSet = data;
        if (this.treeView.jstree(false)
            && this.treeView.jstree(false)._model
            && this.treeView.jstree(false)._model.data) {
            this.treeView.jstree(false)._model.data = {}; //需要手动的清空一下model
        }
        this.treeView.data('jstree', false).empty();
        if (!data) return;
        var icons = true;
        if (withIcon != undefined) {
            icons = withIcon;
        }

        var self = this;

        this.treeView.data('jstree', false).empty()
            .jstree({
                'core': {
                    'data': data,
                    "themes": { "theme": "default", "dots": true, "icons": icons } //"dots": false
                },

                "plugins": ["sort"],

                'sort': function (a, b) {
                    var a_org_node = this.get_node(a) ? this.get_node(a).original : null;
                    var b_org_node = this.get_node(b) ? this.get_node(b).original : null;
                    return self.sort(a_org_node,b_org_node);
                }

            });

    },

    setSelectNode : function(nodeId){
        if (!nodeId) return;
        var mainTree = this.treeView.jstree(true);
        var var_node = mainTree.get_node(nodeId);
        if (var_node) {
            var_node.select_flag = true; // 设置一个标记,标记这个后，然后在选中的时候，可以根据该标记决定是否要触发选中事件
        }
        mainTree.deselect_all();
        mainTree.select_node(nodeId);
        this.scrollTreeByNodeId(nodeId);
    },

    getNodeById : function(nodeId){
        if (!nodeId) return;
        var mainTree = this.treeView.jstree(true);
        return mainTree.get_node(nodeId);
    },

    clearTreeData: function () {
        this.treeView.data('jstree', false).empty();
    },

    show: function () {
        this.treeView.show();
    },

    hidden: function () {
        this.treeView.hide();
    },

    /**
     * 展开
     * @param idOrNode
     */
    open : function(idOrNode){

    },

    /**
     * 合并
     * @param idOrNode
     */
    close : function(idOrNode){

    },

    /**
     * 滚动滚动条，使得选中的对象在可视范围内，在联动选中时要用到，这改的是绝对的位置，应该是滚动滚动条至某地
     * @param nodeId
     */
    scrollTreeByNodeId: function (nodeId) {
        if (!nodeId) return;
        var div_select_row = $('#' + nodeId);
        if (!div_select_row || div_select_row.length < 1) {
            return;
        }

        var min_top_offset =  0;
        if(this.treePane.parent() && this.treePane.parent().height() > 0){
            min_top_offset = this.treePane.parent().height() - this.treePane.height();
        }

        var tree_content = this.treePane; // $('#tree-content');
        var tree_content_height = tree_content[0].clientHeight;//$('#tree-content').height();
        if (!tree_content_height) {
            tree_content_height = 400;
        }
        var select_row_offset_top = 0;
        if (div_select_row.offset()) {
            select_row_offset_top = div_select_row.offset().top;
        }

        if (select_row_offset_top < min_top_offset) { // 也就是选中的row跑到了显示区域上面去了，此时整tree应该下移，下移就是+差值
            var new_scrollTop = tree_content.scrollTop() - (min_top_offset - select_row_offset_top);
            if (new_scrollTop) {
                tree_content.scrollTop(new_scrollTop);
            }
        } else if (select_row_offset_top > tree_content_height + min_top_offset) {
            //表示选中的行已经跑到了显示区域的下方,此时整个tree往上滚，上移是-差值
            var new_scrollTop = tree_content.scrollTop() + (select_row_offset_top - (tree_content_height + min_top_offset) + 70 );
            if (new_scrollTop) {
                tree_content.scrollTop(new_scrollTop);
            }
        }
    },

    /**
     * 设置树的height
     * @private
     */
    setTreeHeight: function (height) {
        if(height && height > 15){
            this.treePane.height(height-15);
        }
    }

});


/**
 * 将数值组织成树的管理类
 */
/**
 *
 * @param dataManager
 * @param dataType 数据类型，it.Data，it.Link
 * @constructor
 */
it.OrganizeTreeManager = function(dataManager,dataType){
    if(!dataManager){
        console.log('dataManager can not be null');
    }
    this.dataManager = dataManager;
    this.dataType = dataType;
};

mono.extend(it.OrganizeTreeManager,Object,{

    includeParent : function(data){
        return true;
    },

    getDataByNode : function(treeNode){
        if(treeNode && treeNode.id){
            return this.getDataById(treeNode.id);
        }
        return null;
    },

    /**
     * 便于其他的类型进行扩展
     * @param id
     * @returns {*}
     */
    getDataById : function(id){
        if(!id) return null;
        if(this.dataType && this.dataType === 'link'){
            return this.dataManager.getLinkById(id);
        }else{
            return this.dataManager.getDataById(id);
        }
    },

    isOpen : function(data){
        return true;
    },

    /**
     * 创建显示的内容
     * @param data
     * @returns {*}
     */
    createLabel : function(data){
        if(data){
            return data.getId();
        }else{
            return "";
        }
    },

    /**
     * 便于其他的类型进行扩展
     * @param data
     * @returns {*}
     */
    getParentIdByData : function(data){
        if(!data){
            return null;
        }
        if(data instanceof it.Link){
            return null;
        }else{
            return data.getParentId();
        }
    },

    /**
     * 创建tree的结点
     * @param data
     * @param children
     * @returns {*}
     */
    createNode : function(data,children){
        if(data){
//            var obj = {id:data.getId(),text:data.getId(),parentId:data.getParentId(),o_data:data};
            var obj = {id:data.getId(),text:this.createLabel(data),parentId:this.getParentIdByData(data)};
            if(children){
                obj.children = children;
            }else{
                obj.children = [];
            }
            if(this.isOpen(data)){
                var state = obj.state;
                if(state){
                    state['opened'] = true;
                }else{
                    obj.state = {"opened":true};
                }
            }
            return obj;
        }
        return null;
    },

    /**
     * 给树的node添加孩子
     * @param data
     * @param child
     */
    addChild : function(node,child){
        if(!node || !child){
            return node;
        }
        var children = this.getChildren(node);
        if(children){
            children.push(child);
        }else {
            node.children = [child];
        }
        return node;
    },

    /**
     * 获取树节点的孩子
     * @param node
     */
    getChildren : function(node){
        return node.children;
    },

    /**
     * 针对当前的搜索数据组织成树，这里可以单独的封装一把
     *
     * 基本思想：
     * 1、遍历datas，找到data的parentid，
     * 2、找到parentid的data，如果没有则new一个；
     * 3、将自己加到parentid的data的孩子中；
     * 4、如果没有parent，那就将其置为root；
     * 5、有个选择是，是否添加其parent，如果不添加的话，那就将其置成其parent‘s parent的孩子，依次往上
     *
     * 至少要遍历两次：第一次计算其parent，第二次组织成树
     *
     */
    organizeTree : function(datas){
        if(!datas || datas.length < 1) return null;
        var results = {}; //obj = {id:id,data:data,children:children}
        for(var i = 0 ; i < datas.length ; i++){
            var data = datas[i];
            if(!data) continue;
            var obj = this.createNode(data);
            results[data.getId()] = obj;
        }
        var treeData = [];
        var treeMap = it.Util.clone(results);
        for(var id in results){
//            var obj = results[id];
            var obj = treeMap[id]; // treeMap的范围要打印results,因为其包含了parent，并且treeData中的数据来自treeMap
            this.organizeParent(obj,treeData,treeMap);
        }
        return treeData;
    },

    /**
     * 将obj加到树上，没有父亲的话就是根
     * @param obj
     * @param treeData
     * @param treeMap
     * @returns {root} ，组织好后，并返回其root
     */
    organizeParent : function(obj,treeData,treeMap){
        if(!obj) return null;
        var pid = obj.parentId;
        if(!pid){
            treeData.push(obj);
            return obj;
        }
        var parent = treeMap[pid]; // 看看搜索的结果中是否包含其parent
        if(parent){
            this.addChild(parent,obj);
        }else if(this.includeParent(obj.data)){
            var parentData = this.getDataById(pid);
            if(!parentData){
                treeData.push(obj);
            }else{
                var pObj = this.createNode(parentData,[obj]);
                treeMap[parentData.getId()] = pObj;
                this.organizeParent(pObj,treeData,treeMap,this);
            }
        }else{ // 找往上data的祖宗
            var ancestorObj = this.getAncestorInTreeMap(pid,treeMap);
            if(ancestorObj){
                this.addChild(ancestorObj,obj);
            }else{
                treeData.push(obj);
            }
        }
    },

    /**
     * 找其祖宗节点
     * @param parentid
     * @param treeMap
     * @returns {*}
     */
    getAncestorInTreeMap : function(parentid,treeMap){
        if(!parentid || !treeMap) return null;
        if(treeMap[parentid]){
            return treeMap[parentid];
        }else{
            var parentData = this.getDataById(parentid);
            if(!parentData || !this.getParentIdByData(parentData)){
                return null;
            }else{
                return this.getAncestorInTreeMap(this.getParentIdByData(parentData),treeMap,this);
            }
        }
    }

});
/**
 * Created by macpro2 on 7/7/15.
 */
/* 图例 */

var $Diagram = function (options) {
    options = options || {};
    this.diagramPane = $('<div class="diagram"></div>');
    if(options.width){
        this.diagramPane.css('width', options.width)
    }
    this.diagramContentPane = $('<div class="diagram-content"></div>'); //用来放item的div
    var main = $('#itv-main');
    main.append(this.diagramPane);
    this.serialNumColorMap = {};
    this.num = 1; //单位数量(即每个单位对应的U数，非连续的就为1)
    this.hideDiagram();
};

mono.extend($Diagram, Object, {

    /**
     * @param data[{color:#00000,value:0-5},...]
     */
    setData: function (datas, titleText, mouseOverCb, mouseoutCb) {
        if (!datas || datas.length < 1) {
            return;
        }
        this.diagramPane.empty();
        this.diagramContentPane.empty();
        this.diagramPane.show();
        if (!titleText) {
            titleText = '连续可用空间图例';
        }
        var title = $('<div class="title">' + titleText + '</div>');
        this.diagramPane.append(title);
        this.diagramPane.append(this.diagramContentPane);
        // var width = 100 / datas.length + '%';
        if (datas instanceof Array) {
            for (var i = 0; i < datas.length; i++) {
                var data = datas[i];
                this.createItem(data);//, width
            }
        }
        if(mouseOverCb){
            this.diagramPane.mouseover(function(event) {
                var $target = $(event.target).parent();
                if($target.hasClass('diagram-item')){
                    var index = $target.index();
                    mouseOverCb(index, $target);
                }
            });
        }
        if(mouseoutCb){
            this.diagramPane.mouseout(function(event) {
                var $target = $(event.target).parent();
                if($target.hasClass('diagram-item')){
                    var index = $target.index();
                    mouseoutCb(index, $target);
                }
            });
        }
        
    },

    createItem: function (data) {
        if (!data) return;
        var value = data.value;
        var color = data.color;
        var width = data.width;
        if (!value || !color) {
            return;
        }
        var row = $('<div class="diagram-item"></div>');
        // row.css('width', width); //不再均分了，而是自动布局,但是为了扩展也支持传参 update by Kevin 2016-11-23
        if (width) {
            row.css('width', width);
        }
        var div_color = $('<div class="cl"></div>');
        div_color.css('background-color', color);
        row.append(div_color);
        var label_Name = $('<label class="lb">' + value + '</label>');
        row.append(label_Name);
        this.diagramContentPane.append(row);
    },

    /**
     *
     * @param num 表示连续可用的空间，47U
     * 剩余的个数越少，颜色就越接近与红色
     */
    showSerialDiagram: function (num) {
        var datas = [];
        this.serialNumColorMap = {};
        num = parseInt(num);
        if (!num) {
            num = 1;
        }
        this.num = num;
        var total_count = Math.floor(47 / num);
        var unit_count = Math.floor(total_count / 4); //ceil

        var color = this.getCapacityColor(null, 0.1);
        var data = {color: color, value: (unit_count * 3 + 1) + '-' + total_count};
        if (total_count <= 4) {
            data.value = total_count;
            this.serialNumColorMap[total_count] = color;
        } else {
            for (var i = (unit_count * 3 + 1); i <= total_count; i++) {
                this.serialNumColorMap[i] = color;
            }
        }

        datas.push(data);


        color = this.getCapacityColor(null, 0.3);
        data = {color: color, value: (unit_count * 2 + 1) + '-' + (unit_count * 3)};
        if (total_count > 1 && total_count <= 4) {
            data.value = total_count - 1;
            this.serialNumColorMap[total_count - 1] = color;
        } else {
            for (var i = (unit_count * 2 + 1); i <= (unit_count * 3); i++) {
                this.serialNumColorMap[i] = color;
            }
        }
        if (total_count > 1) {
            datas.push(data);
        }


        color = this.getCapacityColor(null, 0.6);
        data = {color: color, value: (unit_count + 1) + '-' + (unit_count * 2)};
        if (total_count > 2 && total_count <= 4) {
            data.value = total_count - 2;
            this.serialNumColorMap[total_count - 2] = color;
        } else {
            for (var i = (unit_count + 1); i <= (unit_count * 2); i++) {
                this.serialNumColorMap[i] = color;
            }
        }
        if (total_count > 2) {
            datas.push(data);
        }

        color = this.getCapacityColor(null, 0.8);
        data = {color: color, value: '1-' + unit_count};
        if (total_count > 3 && total_count <= 4) {
            data.value = total_count - 3;
            this.serialNumColorMap[total_count - 3] = color;
        } else {
            for (var i = 1; i <= unit_count; i++) {
                this.serialNumColorMap[i] = color;
            }
        }
        if (total_count > 3) {
            datas.push(data);
        }

        this.setData(datas, '连续可用空间图例');
    },


//value 表示的是已用的
    showTotalSpaceDiagram: function () {
        var datas = [];
        this.num = 1;
        var color = this.getCapacityColor(null, 0.1);
        var data = {color: color, value: '1-25%'};
        datas.push(data);
        color = this.getCapacityColor(null, 0.3);
        data = {color: color, value: '25-50%'};
        datas.push(data);
        color = this.getCapacityColor(null, 0.6);
        data = {color: color, value: '50-75%'};
        datas.push(data);
        color = this.getCapacityColor(null, 0.8);
        data = {color: color, value: '75-100%'};
        datas.push(data);
        this.setData(datas, '非连续可用空间图例');
    },

    hideDiagram: function () {
        this.diagramPane.empty();
        this.diagramPane.hide();
    },

    getCapacityColor: function (rack, ratio) {
        // ratio 表示的是已用的百分比
        if (!ratio) {
            return '#5DBDE0';//'#BEEB9F';
        } else if (ratio <= 0.25) {
            return '#5DBDE0';//'#BEEB9F'; 绿
        } else if (ratio <= 0.5) {
            return '#6FD772';  // FFFF99 黄
        } else if (ratio <= 0.75) {
            return '#FFC95A';//'#FFBB11'; 橙
        } else {
            return '#Fd674F';// FF3357 '#FF6138'; //红色，表示已用的很多
        }
    }

});

it.Diagram = $Diagram;







/**
 * 搜索管理，IT搜索于空间搜索切换
 * 这个比较复杂，想实现一个功能的话，还非得把两个功能都实现，建议客户重新组织，
 * 可以通过SpaceSearchManager和ITSearchManager来自己去实现
 * @param sceneManager
 * @param itSearchInputPanel
 * @param spaceSearchInputPanel
 * @constructor
 */

it.SearchManager = function(sceneManager,itSearchInputPanel,spaceSearchInputPanel,spaceMode){
    this.sceneManager = sceneManager;
    this.itSearchManager = null;//new it.ITSearchManager(this.sceneManager);
    this.spaceSearchManager = null;//new it.SpaceSearchManager(this.sceneManager);
    this.itSearchInputPanel = itSearchInputPanel;
    this.spaceSearchInputPanel = spaceSearchInputPanel;
    this.showModel = '';
    this.spaceMode = spaceMode || 1;
    this.init();
};

mono.extend(it.SearchManager,Object,{

    init : function(){
        this.spaceSearchManager = new it.SpaceSearchManager(this.sceneManager,this.spaceSearchInputPanel,this.spaceMode);
        this.itSearchManager = new it.ITSearchManager(this.sceneManager,this.itSearchInputPanel);
        this.itSearchManager.clearAll(); // 切换前，先清除
        this.itSearchManager.clearAllVirtual();
        this.itSearchManager.hide();
        this.spaceSearchManager.clearAll(); // 切换前，先清除
        this.spaceSearchManager.clearAllVirtual();
        this.spaceSearchManager.hide();
    },

    /**
     * 显示IT搜索
     */
    showITSearch : function(){
        this.switch(false);
    },

    /**
     * 隐藏IT搜索
     */
    hideITSearch : function(){
        if(this.itSearchManager){
            this.itSearchManager.clearAll(); // 切换前，先清除
            this.itSearchManager.clearAllVirtual();
            this.itSearchManager.hide();
        }
    },

    /**
     * 显示空间搜索
     */
    showSpaceSearch : function(){
        this.switch(true);
    },

    /**
     * 隐藏空间搜索
     */
    hideSpaceSearch : function(){
        if(this.spaceSearchManager){
            this.spaceSearchManager.clearAll(); // 切换前，先清除
            this.spaceSearchManager.clearAllVirtual();
            this.spaceSearchManager.hide();
        }
    },

    /**
     * 空间搜索和资产搜索之间的切换，显示资产搜索时就会将空间搜索隐藏掉，显示空间搜索时资产搜索会被隐藏
     * @param isSpace
     */
    switch : function(isSpace){
        if (isSpace) {
            if (this.showModel === 'S') {
                return;
            }
            this.showModel = 'S';
            this.itSearchManager.clearAll(); // 切换前，先清除
            this.itSearchManager.clearAllVirtual();
            this.itSearchManager.hide();
            this.spaceSearchManager.virtualAllNodes();
            this.spaceSearchManager.setupInit();
            this.spaceSearchManager.show();
        } else {
            if (this.showModel === 'IT') {
                return ;
            }
            this.showModel = 'IT';
            this.spaceSearchManager.clearAll(); // 切换前，先清除
            this.spaceSearchManager.clearAllVirtual();
            this.spaceSearchManager.clearInit();
            this.spaceSearchManager.hide();
            this.itSearchManager.show();
        }
    },

    getITSearchTree : function(){
        if(this.itSearchManager){
            return this.itSearchManager.getTreeView();
        }
        return null;
    },

    getSpaceSearchTree : function(){
        if(this.spaceSearchManager){
           return this.spaceSearchManager.getTreeView();
        }
        return null;
    },

    getITSearchOrganizeTreeManager : function(){
        if(this.itSearchManager){
            return this.itSearchManager.getOrganizeTreeManager();
        }
        return null;
    },

    getSpaceSearchOrganizeTreeManager : function(){
        if(this.spaceSearchManager){
            return this.spaceSearchManager.getOrganizeTreeManager();
        }
        return null;
    },

    setPanelLocation:function(obj){
        this.setITSearchPanelLocation(obj);
        this.setSpaceSearchPanelLocation(obj);
    },

    setITSearchPanelLocation : function(obj){
        var searPanel = this.itSearchManager.searPanel;
        if(obj){
            searPanel.css('left','auto');
            searPanel.css('right','auto');
            searPanel.css('bottom','auto');
            searPanel.css('top','auto');
            if(obj.left != null && obj.left != undefined){
                searPanel.css('left',parseInt(obj.left)+'px');
            }
            if(obj.right != null && obj.right != undefined){
                searPanel.css('right',parseInt(obj.right)+'px');
            }
            if(obj.bottom != null && obj.bottom != undefined){
                searPanel.css('bottom',parseInt(obj.bottom)+'px');
            }
            if(obj.top != null && obj.top != undefined){
                searPanel.css('top',parseInt(obj.top)+'px');
            }
        }
    },

    setSpaceSearchPanelLocation : function(obj){
        var searPanel = this.spaceSearchManager.searPanel;
        if(obj){
            searPanel.css('left','auto');
            searPanel.css('right','auto');
            searPanel.css('bottom','auto');
            searPanel.css('top','auto');
            if(obj.left != null && obj.left != undefined){
                searPanel.css('left',parseInt(obj.left)+'px');
            }
            if(obj.right != null && obj.right != undefined){
                searPanel.css('right',parseInt(obj.right)+'px');
            }
            if(obj.bottom != null && obj.bottom != undefined){
                searPanel.css('bottom',parseInt(obj.bottom)+'px');
            }
            if(obj.top != null && obj.top != undefined){
                searPanel.css('top',parseInt(obj.top)+'px');
            }
        }
    },

    getItSearchPane : function(){
        return this.itSearchManager.searPanel;
    },

    getSpaceSearchPane : function(){
        return this.spaceSearchManager.searPanel;
    },

    setParent : function(parent){
        if(parent && $(parent)){
            parent = $(parent);
            parent.append(this.itSearchManager.searPanel);
            parent.append(this.spaceSearchManager.searPanel);
        }else{
            $('body').append(this.itSearchManager.searPanel);
            $('body').append(this.spaceSearchManager.searPanel);
        }
    }

});

// /**
//  *
//  * @param sceneManager
//  * @param inputPane
//  * @constructor
//  */
// it.BaseSearch = function(sceneManager,inputPane){
//     if(!sceneManager) {
//         console.error("agument sceneManager can not be null");
//         return;
//     }
//     this.sceneManager = sceneManager;
//     this.dataManager = this.sceneManager.dataManager;
//     this.dataFinder = new it.DataFinder(this.sceneManager.dataManager);
//     var self = this;
//     this.dataFinder.filter = function(data){
//         return self.filter(data);
//     };
// //    this.orgTreeManager = new it.OrganizeTreeManager(this.sceneManager.dataManager);
//     this.virtualManager = this.getVirtualManager() || new it.VirtualManager(sceneManager);
//     this.virtualManager.isDealWithFunction = function(data){ // 如果是房间的话则不出来透明
//         if(!data) return false;
//         var category = self.dataManager.getCategoryForData(data);
//         if(category
//             && category.getId().indexOf('room') >=0 ){
//             return false;
//         }
//         return true;
//     }
//     this.sceneManager.viewManager3d.addMaterialFilter(this.virtualManager);
//     this.treeView = null;
//     this.orgTreeManager = new it.OrganizeTreeManager(this.sceneManager.dataManager);
//     this.defaultEventHandler = sceneManager.viewManager3d.getDefaultEventHandler();
//     this.inputPane = inputPane||this.createInputPane();
//     this.searPanel = null;
//     this.clearAllFunction = null;
//     this.initSearchPane();
// };

// mono.extend(it.BaseSearch,Object,{

//     createInputPane : function(){
//         return new it.BasePanel();
//     },

//     getVirtualManager : function(){
//         return new it.VirtualManager(this.sceneManager);
//     },

//     removeVirtualManager : function(){
//         this.sceneManager.viewManager3d.removeMaterialFilter(this.virtualManager);
//     },

//     filter:function(data){
//        return true;
//     },

//     clearAllVirtual : function(){
//         this.virtualManager.clearAll();
//     },

//     initSearchPane : function(){
//         this.searPanel = $('.search-main-pane');
//         var paneIndex = 0;
//         if(this.searPanel && this.searPanel.length > 0){
//             paneIndex = this.searPanel.length;
//         }
//         this.searPanel = $('<div id = "search-main-pane_'+paneIndex+'" class="search-main-pane"></div>');
// //        this.searPanel.css('left',10);
// //        this.searPanel.css('top',10);
//         this.searPanel.append(this.inputPane.getContentPane());
//         this.treeView = new it.TreeView(this.searPanel);
// //        $('body').append(this.searPanel);
//         var self = this;
//         this.treeView.clickNodeFunction = function(treeData){
//             self.clickTreeNode(treeData);
//         };

//         this.treeView.mouseoverNodeFunction = function(treeData){
//             self.mouseOverTreeNode(treeData);
//         };

//         this.inputPane.doClickFunction = function(values){
// //            var values = [{key:'u:userId',value:'aaa',operation:'like'}];
//             self.beforeDoClick();
//             self.setData(values);
//             var height = self.searPanel.height() - self.inputPane.getContentPane().height();
//             self.treeView.setTreeHeight(height);
//         };

//         this.inputPane.doClearFunction = function(){
//             self.clearSearch();
//         };
//     },

//     beforeDoClick : function(){

//     },

//     show : function(){
//         this.searPanel.show();
//     },

//     beforHide : function(){

//     },

//     hide : function(){
//         this.beforHide();
//         this.searPanel.hide();
//     },

//     /**
//      * 处理查询条件，该类根据查询条件获取查询的结果，然后组织tree
//      * @param conditions，指的是所有的查询条件
//      */
//     setData : function(conditions){
//         var results = this.dataFinder.find(conditions);
//         var treeNodes = null;
//         if (!results || results.length < 1) {
//             this.treeView.clearTreeData();
// //            return;
//         }else{
//             treeNodes = this.orgTreeManager.organizeTree(results);
//             this.treeView.setData(treeNodes, false);
//         }
//         this.setResult(results,treeNodes);
//     },

//     /**
//      * 处理查询出来的结果
//      * @param results
//      * @param treeNodes
//      */
//     setResult : function(results,treeNodes){

//     },

//     clearSearch : function(){
//         this.treeView.setData(null);
//         this.clearSearchData();
//         this.sceneManager.network3d.dirtyNetwork();
//     },

//     /**
//      * 点击搜索中的“清除”时，所要处理的就是清除搜索的结果即可，显示所有
//     */
//     clearSearchData : function(){

//     },

//     /**
//      * 清除其初始化的东西,默认是清除搜索的结果
//      */
//     clearAll : function(){
//         this.treeView.setData(null);
//         if(this.inputPane.clearInput){
//             this.inputPane.clearInput();
//         }
//         if(this.clearAllFunction){
//             this.clearAllFunction();
//         }else{
//             this.clearSearchData();
//         }
//     },

//     getRootDataBySceneAndData : function(scene,data,scope){
//         if(!scene || !data){
//             return null;
//         }
//         scope = scope || this;
//         var dataType = this.sceneManager.dataManager.getDataTypeForData(data);
//         if(dataType && dataType.getCategoryId() === scene.getCategoryId()){
//             return data;
//         }else if(data.getParentId()){
//             var parent = this.sceneManager.dataManager.getDataById(data.getParentId());
//             if(parent){
//                 return scope.getRootDataBySceneAndData(scene,parent,scope);
//             }
//         }
//         return null;
//     },

//     /**
//      * 点击树上的节点，camera自动移过去
//      * 注意：当前是在dc场景下，点击node时应当判断其所在的场景，如果不是在同一场景下得清空，否则的会会存在问题;
//      * 注意2：即使nodeScene和currentScene，有可能它们的rootNode不一样，如，1楼的机柜和2楼的机柜;
//      *
//      * @param treeData
//      */
//     clickTreeNode : function(treeData){
//         var id = treeData.id;
//         if(!id) return;
//         var data = this.sceneManager.dataManager.getDataById(id);
//         if(!data || !this.treeView.isClick(data)) return;
//         var assetNode = this.sceneManager.dataNodeMap[id];
// //        var nodeData = this.sceneManager.getNodeData(assetNode);

//         if(!this.sceneManager.isCurrentSceneInstance(data)){ //如果一下子跳到其他的场景的某个非根对象
//             var sceneAndRootData = this.sceneManager.getSceneAndRootByData(data);
//             if(sceneAndRootData){
//                 this.sceneManager.gotoScene(sceneAndRootData.scene,sceneAndRootData.rootData);
//                 //如果是整个楼层的话，就不需这么lookAt了(严格意义上说是Data本身就在场景的root就不需再去设置镜头了)
//                 if(sceneAndRootData.rootData != data){
//                     assetNode = this.sceneManager.dataNodeMap[id];
//                     if(!assetNode){
//                         this.sceneManager.loadLazyData(data);
//                     }
//                 }else{
//                     assetNode = null;
//                 }
//             }
//         }
//         //注意以下两种情况：
//         //1、还没有创建，如lazyable的设备，只有在focus该机柜时，它的孩子设备才会被创建(第一次)并加到box中
//         //2、有可能就是存在该场景中，只是不在box中而已，如：lazyable模式下，设备都被移除掉了
//         var box3d = this.sceneManager.network3d.getDataBox();
//         if(!assetNode || !box3d.getDataById(assetNode.getId())){
//             this.sceneManager.loadLazyData(data);
//             if(!assetNode){
//                 assetNode = this.sceneManager.dataNodeMap[data.getId()];
//             }
//         }
//         if(this.defaultEventHandler){
//             this.defaultEventHandler.lookAt(assetNode);
//         }
//     },

//     mouseOverTreeNode : function(treeData){
//         var id = treeData.id;
//         if (id) {
//             var assetNode = this.sceneManager.dataNodeMap[id];
//             if (assetNode) {
//                 this.sceneManager.network3d.getDataBox().getSelectionModel().clearSelection();
//                 assetNode.setSelected(true);
//             }
//         }
//     },

//     getTreeView : function(){
//         return this.treeView;
//     },

//     getOrganizeTreeManager : function(){
//         return this.orgTreeManager;
//     },

// });

// /**
//  * 资产搜索的处理
//  * @param sceneManager
//  * @constructor
//  */
// it.ITSearchManager = function(sceneManager,inputPane){
//     it.ITSearchManager.superClass.constructor.call(this, sceneManager,inputPane);
//     this._assetImage = "data:image/png;base64,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";
// }

// mono.extend(it.ITSearchManager,it.BaseSearch,{

//     createInputPane : function(){
//         return new it.ITSearchPanel();
//     },

//     clearSearchData : function(){
//         this.clearBillboard();
//     },

//     setResult : function(results,treeNodes){
//         this.clearBillboard();
//         this.virtualManager.addAll();
//         if(!treeNodes) return;
//         for(var i = 0 ; i < treeNodes.length; i++){
//             var treeNode = treeNodes[i];
//             this.showData(treeNode);
//         }
//     },

//     showData : function(treeNode){
//         var data = this.orgTreeManager.getDataByNode(treeNode);
//         if(!data) return;
//         if(this.showBillboard(data)){
//             this.addDataBillBoard(data);
//         }
//         this.virtualManager.remove(data); //同理 removeByDescendant
//         var children = this.orgTreeManager.getChildren(treeNode);
//         if(children && children.length > 0){
//             for(var i = 0 ;i < children.length ; i++){
//                 var child = children[i];
//                 if(child){
//                     this.showData(child,this);
//                 }
//             }
//         }
//     },

//     /***
//      * Data是否显示其billboard
//      * @param data
//      * @returns {boolean}
//      */
//     showBillboard : function(data){
//         if(!data) return false;
//         var assetType = data.getDataTypeId();
//         if(assetType){
//             if(assetType.indexOf('equipment') >=0){
//                 return false;
//             }
//             if(assetType.indexOf('room') >=0){
//                 return false;
//             }
//             if(assetType.indexOf('floor') >=0){
//                 return false;
//             }
//         }
//         return true;
//     },

//     clearBillboard : function(){
//         if(this.sceneManager.dataNodeMap){
//             for(var id in this.sceneManager.dataNodeMap){
//                 var node = this.sceneManager.dataNodeMap[id];
//                 if(node && node.getClient('asset_billboard')){
//                     var billboard = node.getClient('asset_billboard');
//                     billboard.setParent(null);
//                     this.sceneManager.network3d.getDataBox().remove(billboard);
//                 }
//             }
//         }
//         this.virtualManager.clearAll();
//     },

//     /**
//      * 创建资产的Billboard
//      * @param data
//      */
//     addDataBillBoard : function(data){
//         if(!data) return;
//         var node = this.sceneManager.dataNodeMap[data.getId()];
//         if(!node) return;
//         var box = this.sceneManager.network3d.getDataBox();
//         if(!box.getDataById(node.getId())){
//             return ;
//         }
//         var billboard = new mono.Billboard();
//         billboard.setPosition(0, node.getBoundingBox().max.y + 20, 0);
//         billboard.setStyle('m.alignment', mono.BillboardAlignment.bottomCenter);
//         billboard.setStyle('m.transparent', true);
// //        billboard.setStyle('m.texture.image', TML.Factory3D.getImagePath('asset.png'));
//         billboard.setStyle('m.texture.image', this._assetImage);
//         billboard.setStyle('m.alignment', mono.BillboardAlignment.bottomCenter);
//         // billboard.setStyle('m.vertical', true);
//         billboard.setScale(40, 50, 1);
//         billboard.setParent(node);
//         billboard.setClient('it_data',data);
//         box.add(billboard);
//         node.setClient('asset_billboard', billboard);
//     }

// });

// it.SpaceSearchVirtualManager = function(sceneManager,spaceManager){
//     it.VirtualManager.call(this,sceneManager);
//     this.spaceManager = spaceManager;
// }

// mono.extend(it.SpaceSearchVirtualManager,it.VirtualManager,{

//     beforeAdd: function(data) {
//         if (data) {
//             // delete data._userDataMap['dyna_user_data_totalSpace']; //总空间
//             // delete data._userDataMap['dyna_user_data_totalOccupation']; //总的占用空间
//             delete data._userDataMap['dyna_user_data_maxSerSpace']; //最大的连续空间
//             // delete data._userDataMap['dyna_user_data_totalEmpSpace']; //总的剩余空间
//             delete data._userDataMap['dyna_user_data_totalCount']; //总共可以放“uNumber”U的个数
//             delete data._userDataMap['dyna_user_data_empCount']; //空余的“uNumber”U的个数
//         }
//     },

//     filterMaterial : function(originalMaterial,filterdMaterial,node){

//         var sm = this.sceneManager;
// //        var vm = sm.viewManager3d;
//         var sm2 = this.spaceManager;
// //        var focusNode = vm.getFocusNode();
//         var map = this.materialMap;

//         if(sm.getNodeData(node)){
//             return filterdMaterial;
//         }
//         if(sm2.isSpaceNode(node)){
//             var parent = node.getParent();
//             if(sm2.isSpaceNode(parent)){
//                 parent = parent.getParent();
//             }
//             var transFlag = false;
//             if(parent){
//                 var data = this.getDataByNode(parent);
//                 if(data){
//                     id = this.getBId(data);
//                     if(this._global_tmap[id]){ // 对于透明来讲，如果global中是虚化的，那怎么着它就是虚化的
//                         transFlag = this._global_tmap[id];
//                     }else if(this._tmap[id]){
//                         transFlag = this._tmap[id];
//                     }
//                 }
//             }
//             if(!transFlag){
//                 return filterdMaterial;
//             }

// //                if(node.isDescendantOf(focusNode)){
// //                    return filterdMaterial;
// //                }else{
//                     var id = originalMaterial.getUniqueCode();
//                     var m = this.materialMap[id];
//                     if(!m){
//                         m = originalMaterial.clone();
//                         this.materialMap[id] = m;
//                         m.transparent = true;
//                         m.opacity = 0.05;
//                     }
//                     return m;
// //                }
//         }
//     }

// });

// /**
//  *  空间可视化搜索的处理
//  *  还得提供场景切换时空间可视化需重新计算的接口，空间可视化永远处理的是当前场景下的
//  * @param sceneManager
//  * @constructor
//  */
// it.SpaceSearchManager = function(sceneManager,inputPane,mode){
//     it.BaseSearch.call(this,sceneManager,inputPane);
//     this.spaceManager = new it.SpaceManager(this.dataManager,this.sceneManager);
//     this.diagram = new it.Diagram();
//     this.isVirtualFunction = null;
//     this.virtualNode = [];
//     this.spaceMap = {};
//     this.mode = mode || 1;
//     var self = this;
//     this.spaceManager.spaceNodeColorFunction = function(percent,data,space){
//         // ratio 表示的是已用的百分比
//         if (space) {
//             // var occupationCount = parseInt(space.getTotal()/self.getUNumber());
//             if (data && data.getUserData('dyna_user_data_empCount')) {
//                 var occupationCount = parseInt(data.getUserData('dyna_user_data_empCount'));
//                 // var totalCount = parseInt(space.getTotal()/self.getUNumber());
//                 // if (totalCount) {
//                 // percent = 1-occupationCount/totalCount;
//                 // }
//                 var num = self.getUNumber()||1;
//                 var total_count = Math.floor(47 / num);
//                 var unit_count = Math.floor(total_count / 4); //ceil
//                 if (total_count <= 4) {
//                     if (occupationCount === 1) {
//                         return '#5DBDE0';
//                     } else if (occupationCount === 2) {
//                         return '#6FD772';
//                     } else if (occupationCount === 3) {
//                         return '#FFC95A';
//                     } else {
//                         return '#Fd674F';
//                     }
//                 } else {
//                     if (occupationCount <= unit_count) {
//                         return '#Fd674F';
//                     } else if (occupationCount >= (unit_count + 1) && occupationCount <= unit_count * 2) {
//                         return '#FFC95A';
//                     } else if (occupationCount >= (unit_count * 2 + 1) && occupationCount <= unit_count * 3) {
//                         return '#6FD772';
//                     } else if (occupationCount >= (unit_count * 3 + 1) && occupationCount <= total_count) {
//                         return '#5DBDE0';
//                     }else{
//                         console.log('can not compute the spaceNodeColorFunction color !');
//                     }
//                 }
//             }
//         }
//         if(!percent){ //空间可视化时，计算内部的颜色时
//             return '#5DBDE0';//'#BEEB9F';
//         }else if(percent <= 0.25){
//             return '#5DBDE0';//'#BEEB9F'; 绿
//         }else if(percent <= 0.5){
//             return '#6FD772';  // FFFF99 黄
//         }else if(percent <= 0.75){
//             return '#FFC95A';//'#FFBB11'; 橙
//         }else{
//             return '#Fd674F';// FF3357 '#FF6138'; //红色，表示已用的很多
//         }
//     };
//     this.spaceManager.spaceNodeFrameColorFunction = function(percent,data,space){
//         if (space) {
//             // var occupationCount = parseInt(space.getTotal()/self.getUNumber());
//             if (data && data.getUserData('dyna_user_data_empCount')) {
//                 var occupationCount = parseInt(data.getUserData('dyna_user_data_empCount'));
//                 var num = self.getUNumber()||1;
//                 var total_count = Math.floor(47 / num);
//                 var unit_count = Math.floor(total_count / 4); //ceil
//                 if (total_count <= 4) {
//                     if (occupationCount === 1) {
//                         return '#018ABD';
//                     } else if (occupationCount === 2) {
//                         return '#1A920A';
//                     } else if (occupationCount === 3) {
//                         return '#E68D00';
//                     } else {
//                         return '#CE3118';
//                     }
//                 } else {
//                     if (occupationCount <= unit_count) {
//                         return '#CE3118';
//                     } else if (occupationCount >= (unit_count + 1) && occupationCount <= unit_count * 2) {
//                         return '#E68D00';
//                     } else if (occupationCount >= (unit_count * 2 + 1) && occupationCount <= unit_count * 3) {
//                         return '#1A920A';
//                     } else if (occupationCount >= (unit_count * 3 + 1) && occupationCount <= total_count) {
//                         return '#018ABD';
//                     }else{
//                         console.log('can not compute the spaceNodeFrameColorFunction color !');
//                     }
//                 }
//             }
//         }
//         if(!percent){ //空间可视化时，计算内部的颜色时
//             return '#018ABD';//'#BEEB9F';
//         }else if(percent <= 0.25){
//             return '#018ABD';//'#BEEB9F'; 绿
//         }else if(percent <= 0.5){
//             return '#1A920A';  // FFFF99 黄
//         }else if(percent <= 0.75){
//             return '#E68D00';//'#FFBB11'; 橙
//         }else{
//             return '#CE3118';// FF3357 '#FF6138'; //红色，表示已用的很多
//         }
//     };
//     this.resetTreeLabel();
//     this.virtualAllNodes();
//     this.clearAllFunction = function(){
//         this.clearSpaceNode();
//     }
//     this.sceneChangeListener = function(eve){
//         if (eve.data && eve.data.getCategoryId() && eve.data.getCategoryId().toLowerCase() == 'floor') {
//             self.showSpaceNode();
//         }
//     }
//     //重新计算空间可视化,当然不是空间可视的模式下的Remove掉该监听
// }

// mono.extend(it.SpaceSearchManager,it.BaseSearch,{

//     /**
//      * 切换到空间可视化时，一些初始化的一些动作，如添加场景变化的监听，隐藏掉哪些资产
//      */
//     setupInit : function(){
//         this.sceneManager.addSceneChangeListener(this.sceneChangeListener);
//         if(!this.visOrVirtFilter){ // 以免重复创建
//             this.visOrVirtFilter = this.setVisibleOrVirtualData(this.sceneManager);
//             if(this.visOrVirtFilter){
//                 if(this.visOrVirtFilter instanceof it.VisibleManager){
//                     this.sceneManager.viewManager3d.addVisibleFilter(this.visOrVirtFilter);
//                 }else if(this.visOrVirtFilter instanceof it.VirtualManager){
//                     this.sceneManager.viewManager3d.addMaterialFilter(this.visOrVirtFilter);
//                 }
//             }
//         }
//         this.setupDoOther(this.sceneManager);
//     },

//     /**
//      * 空间可视化卸载。从空间可视化切换到IT可视化时，的去掉那些在空间可视化时的初始化的动作
//      * 可是如果我从floor的空间可视化跳到上一层呢？ 那么就不会clear了，
//      *         并且使得building中都有彩色（不过可以在sceneChangeListener中判断）
//      * */
//     clearInit : function(){
//         this.sceneManager.removeSceneChangeListener(this.sceneChangeListener);
//         if(this.visOrVirtFilter){
//             if(this.visOrVirtFilter instanceof it.VisibleManager){
//                 this.sceneManager.viewManager3d.removeVisibleFilter(this.visOrVirtFilter);
//             }else if(this.visOrVirtFilter instanceof it.VirtualManager){
//                 this.sceneManager.viewManager3d.removeMaterialFilter(this.visOrVirtFilter);
//             }
//         }
//         this.clearDoOther(this.sceneManager);
//     },

//     /**
//      * 在空间可视化时，哪些资产应该被隐藏掉
//      * @param dataTypeId
//      * @param data
//      * @returns {boolean}
//      */
//     invisibleOrVirtualData : function(dataTypeId,data){
//         if(!dataTypeId && !data){
//             return false;
//         }
//         var category = this.sceneManager.dataManager.getCategoryForDataType(dataTypeId);
//         if(category && category.getId() && category.getId().toLowerCase().indexOf('channel') >=0 ){
//             return true;
//         }
//         return false;
//     },

//     /**
//      * 设置不可见(或虚化)的data
//      * @param visibleFilter或virtualManager
//      */
//     setVisibleOrVirtualData: function(sceneManager){
//         var visibleFilter = new it.VisibleManager(sceneManager);
//         var groupByType = this.dataManager._dataTypeDatas;
//         if(groupByType){
//             for(var typeId in groupByType){
//                 if(this.invisibleOrVirtualData(typeId)){
//                     var datas = groupByType[typeId];
//                     if(datas){
//                         for(var id in datas){
//                             visibleFilter.setVisible(datas[id],false);
//                         }
//                     }
//                 }
//             }
//         }
//         return visibleFilter;
//     },

//     /**
//      * 初始化时的其他动作，这里留给用户自己扩展
//      * @param sceneManager
//      */
//     setupDoOther : function(sceneManager){

//     },

//     /**
//      * 卸载时的其他动作，这里留给用户扩展
//      * @param sceneManager
//      */
//     clearDoOther : function(sceneManager){

//     },

//     createInputPane : function(){
//         this.inputPane = new it.SpaceSearchPanel();
//         return this.inputPane;
//     },

//     getVirtualManager : function(){
//         return new it.SpaceSearchVirtualManager(this.sceneManager, new it.SpaceManager(this.dataManager,this.sceneManager));
//     },

//     resetTreeLabel : function(){
//         var self = this;
//         this.orgTreeManager.createLabel = function(treeData){
//             return self.setLabel(treeData);
//         }
//     },

//     getUNumber : function(){
//         if(this.inputPane){
//           return parseInt(this.inputPane.getUNumber());
//         }else{
//            return 1;
//         }
//     },

//     setLabel : function(treeData){
//         if(!treeData || !treeData.getId()){
//             return null;
//         }
//         var id = treeData.getId();
//         var data = this.dataManager.getDataById(id);//获取data，将计算的结果保存进去，以免其他地方重复计算
//         // var space = this.spaceMap[id];
//         var prex = this.getTreeNodeLabel(treeData);
//         if (!prex) {
//             prex = id;
//         }
//         var count = 0;
//         // var uNumber = this.getUNumber();
//         // if(space && uNumber){
//             // var count = 0;
//             // var empList = space.getEmptyList();
//             // if(empList && empList.length > 0){
//             //     for(var i = 0 ; i < empList.length ; i++){
//             //         var ep = empList[i];
//             //         if(ep.total >= uNumber){
//             //             count += Math.floor(ep.total/uNumber);
//             //         }
//             //     }
//             // }
//             if (data) {
//                 // data.setUserData('dyna_user_data_totalCount',parseInt(space.getTotal()/uNumber));//总共可以放“uNumber”U的个数
//                 count = parseInt(data.getUserData('dyna_user_data_empCount'));//空余的“uNumber”U的个数
//             }
//             // return prex + '('+count+'个)';
//         // }else{
//             // return prex;
//         // }
//         if (count) {
//             prex +=  '('+count+'个)';
//         }
//         return prex;
//     },

//     /**
//      * 搜索树的叶子结点的前缀
//      */
//     getTreeNodeLabel : function(treeData){
//         if (treeData) {
//             return treeData.getId();
//         }
//         return "";
//     },

//     /**
//      * 重写，先计算每个data，然后再组织tree
//      */
//     setData : function(conditions){
//         var results = this.dataFinder.find(conditions);
//         var treeNodes = null;
//         this.setResult(results);
//         if (!results || results.length < 1) {
//             this.treeView.clearTreeData();
//         }else{
//             treeNodes = this.orgTreeManager.organizeTree(results);
//             this.treeView.setData(treeNodes, false);
//         }
//     },

//     setResult : function(result,treeNodes){
//         this.clearSpaceNode(); // 先清空
//         this.virtualManager.addAll();
//         if(!result) return;
//         var nodes = [];
//         for(var i = 0 ; i < result.length; i++){
//             var data = result[i];
//             var node = this.sceneManager.dataNodeMap[data.getId()];
//             //根据node获取其color Cube
// //            var spaceNode = this.getSpaceNode(node);
//             this.virtualManager.remove(data);
//             if(node){
//                 this._dealWithOneNode(node);
//                 nodes.push(node);
//             }
//         }
//         this.showSpaceNode(); //不需要在处理sceneData啦,20161025。需要处理整个scene中所有的nodes，否则那些机柜不会从box中移除的
//     },

//     beforHide : function(){
//         this.diagram.hideDiagram();
//     },

//     /**
//      * 点击搜索中的“清除”时，所要处理的就是清除搜索的结果即可，显示所有
//       */
//     clearSearchData : function(){
//         this.initAllNodes();
//         this.showSpaceNode();
//         this.virtualManager.clearAll();
//     },

//     clearSpaceNode : function(){
//         var nodes = this.getAllNodes();//this.virtualNode;
//         this.spaceManager.remove1DSpaceNodeForNodes(nodes);
//         this.spaceManager.hideSpaceMode();
//         this.showSerialDiagram(1,nodes);
//     },

//     virtualAllNodes : function(){
//         this.initAllNodes();
//         this.showSpaceNode();
//     },

//     showSpaceNode : function(nodes){
//         nodes = nodes || this.getSceneNodes();
//         if(nodes && nodes.length > 0){
//             this.showSerialDiagram(this.getUNumber(),nodes);
//         }else{ //当没有node的时候就隐藏掉
//             this.diagram.hideDiagram();
//         }
// //        this.spaceManager.remove1DSpaceNodeForNodes(nodes);//要先清除，再create，否则会重复创建
//         this.spaceManager.create1DSpaceNodeForNodes(nodes,this.mode); // 创建前，先移除已经放到该创建函数中了。
//         this.spaceManager.showSpaceMode();
//     },

//     /**
//      * 重写例图的显示内容
//      * @param num 表示连续可用的空间，47U
//      * 剩余的个数越少，颜色就越接近与红色
//      */
//     showSerialDiagram : function (num,nodes) {
//         var datas = [];
//         var serialNumColorMap = {};
//         num = parseInt(num);
//         if (!num) {
//             num = 1;
//         }
//         this.num = num;
//         var total_count = Math.floor(47 / num);
//         var unit_count = Math.floor(total_count / 4); //ceil

//         var color = this.getCapacityColor(0.1);
//         var data = {color: color, 
//                     minCount:(unit_count * 3 + 1),
//                     maxCount:total_count,
//                     value: (unit_count * 3 + 1) + '-' + total_count
//                 };
//         if (total_count <= 4) {
//             data.value = total_count;
//             data.minCount = total_count;
//             data.maxCount = total_count;
//             serialNumColorMap[total_count] = color;
//         } else {
//             for (var i = (unit_count * 3 + 1); i <= total_count; i++) {
//                 serialNumColorMap[i] = color;
//             }
//         }
//         datas.push(data);


//         color = this.getCapacityColor(0.3);
//         data = {color: color, 
//                 minCount:(unit_count * 2 + 1),
//                 maxCount: unit_count * 3,
//                 value: (unit_count * 2 + 1) + '-' + (unit_count * 3)
//             };
//         if (total_count > 1 && total_count <= 4) {
//             data.value = total_count - 1;
//             data.minCount = total_count-1;
//             data.maxCount = total_count-1;
//             serialNumColorMap[total_count - 1] = color;
//         } else {
//             for (var i = (unit_count * 2 + 1); i <= (unit_count * 3); i++) {
//                 serialNumColorMap[i] = color;
//             }
//         }
//         if (total_count > 1) {
//             datas.push(data);
//         }

//         color = this.getCapacityColor(0.6);
//         data = {color: color, 
//                 minCount:(unit_count + 1),
//                 maxCount: unit_count * 2,
//                 value: (unit_count + 1) + '-' + (unit_count * 2)
//             };
//         if (total_count > 2 && total_count <= 4) {
//             data.value = total_count - 2;
//             data.minCount = total_count - 2;
//             data.maxCount = total_count - 2;
//             serialNumColorMap[total_count - 2] = color;
//         } else {
//             for (var i = (unit_count + 1); i <= (unit_count * 2); i++) {
//                 serialNumColorMap[i] = color;
//             }
//         }
//         if (total_count > 2) {
//             datas.push(data);
//         }

//         color = this.getCapacityColor(0.8);
//         data = {color: color, 
//                 minCount: 1,
//                 maxCount: unit_count,
//                 value: '1-' + unit_count };
//         if (total_count > 3 && total_count <= 4) {
//             data.value = total_count - 3 ;
//             data.minCount = total_count - 3;
//             data.maxCount = total_count - 3;
//             serialNumColorMap[total_count - 3] = color;
//         } else {
//             for (var i = 1; i <= unit_count; i++) {
//                 serialNumColorMap[i] = color;
//             }
//         }
//         if (total_count > 3) {
//             datas.push(data);
//         }
//         if (nodes && nodes.length > 0) {
//             var totalMap = {};
//             for(var i = 0 ; i < nodes.length ;i++){
//                 var data = this.sceneManager.getNodeData(nodes[i]);
//                 var dColor = serialNumColorMap[data.getUserData('dyna_user_data_empCount')];
//                 if (dColor) {
//                     if(totalMap[dColor]){
//                         totalMap[dColor]  ++;
//                     }else{
//                         totalMap[dColor]  = 1;
//                     }
//                 }
//             }
//             for (var i = 0; i < datas.length; i++) {
//                 var itemData = datas[i];
//                 if (!itemData) {
//                     continue;
//                 }
//                 if (totalMap[itemData.color]) {
//                     var strValue = '';
//                     if (itemData.minCount) {
//                         strValue = itemData.minCount;
//                     }
//                     if (itemData.minCount != itemData.maxCount) {
//                         strValue += '-' + itemData.maxCount;
//                     }
//                     strValue += '('+ totalMap[itemData.color] +')';
//                     itemData.value = strValue;
//                 }
//             }
//         }
//         this.diagram.setData(datas, '连续可用空间图例');
//     },

//     getCapacityColor: function (ratio) {
//         // ratio 表示的是已用的百分比
//         if (!ratio) {
//             return '#5DBDE0';//'#BEEB9F';
//         } else if (ratio <= 0.25) {
//             return '#5DBDE0';//'#BEEB9F'; 绿
//         } else if (ratio <= 0.5) {
//             return '#6FD772';  // FFFF99 黄
//         } else if (ratio <= 0.75) {
//             return '#FFC95A';//'#FFBB11'; 橙
//         } else {
//             return '#Fd674F';// FF3357 '#FF6138'; //红色，表示已用的很多
//         }
//     },

//     isDealwith : function(node){
//         if(!node) return false;
//         if(this.isVirtualFunction){
//             return this.isVirtualFunction(node);
//         }
//         var data = this.sceneManager.getNodeData(node);
//         if(!data) return false;
//         // var type = this.sceneManager.dataManager.getDataTypeForData(data);
//         // if(!type) return false;
//         // if(type._model.indexOf('.rack') >0){
//         //     return true;
//         // }
//         var category = this.sceneManager.dataManager.getCategoryForData(data);
//         if (category && category.getId().toLowerCase() == 'rack') {
//             return true;
//         }
//         return false;
//     },

//     getDataSpace : function(data){
//         if (!data) {
//             return null;
//         }
//         var space = this.spaceMap[data.getId()];
//         if (!space) {
//             var dataSpace = this.spaceManager.computeSpace(data);
//              if(dataSpace && (dataSpace instanceof it.Space1)){
//                 this.spaceMap[data.getId()] = dataSpace;
//                 space = dataSpace;
//              }
//         }
//         return space;
//     },

//     _dealWithOneNode : function(node){
//         var uNumber = this.getUNumber();
//         if (!uNumber) {
//             uNumber = 1;
//         }
//         if(node){
//             if(this.isDealwith(node)){
//                 var data = this.sceneManager.getNodeData(node);
//                 if(!data) return ;
//                 // var space = this.spaceMap[data.getId()]; 
//                 // if (!space) {
//                 //     space = this.spaceManager.computeSpace(data);
//                 //     if(space && (space instanceof it.Space1)){
//                 //        this.spaceMap[data.getId()] = space;
//                 //     }
//                 // }
//                 var space = this.getDataSpace(data);
//                 var count = 0;
//                 // if(space && (space instanceof it.Space1)){
//                 if (space) {
//                     // this.spaceMap[it.SceneManager.getNodeDataId(node)] = space;
//                     var maxEmpSerSpace = 0,totalEmpSpace = space.getTotal() - space.getOccupation();
//                     var empList = space.getEmptyList();
//                     if(empList && empList.length > 0){
//                         for(var i = 0 ; i < empList.length ; i++){
//                             var ep = empList[i];
//                             if(ep.total > maxEmpSerSpace){
//                                 maxEmpSerSpace = ep.total;
//                             }
//                             if(ep.total >= uNumber){
//                                count += Math.floor(ep.total/uNumber);
//                             }  
//                         }
//                     }
//                     data.setUserData('dyna_user_data_totalSpace',space.getTotal());//总空间
//                     data.setUserData('dyna_user_data_totalOccupation',space.getOccupation());//总的占用空间
//                     data.setUserData('dyna_user_data_maxSerSpace',maxEmpSerSpace);//最大的连续空间
//                     data.setUserData('dyna_user_data_totalEmpSpace',totalEmpSpace);//总的剩余空间
//                     data.setUserData('dyna_user_data_totalCount',parseInt(space.getTotal()/uNumber));//总共可以放“uNumber”U的个数
//                     data.setUserData('dyna_user_data_empCount',count);//空余的“uNumber”U的个数
//                     this.virtualNode.push(node);
//                 }
//             }
//         }
//     },

//     /**
//      * 获取所有的Node，此方法在这里没什么用
//      * @returns {*}
//      */
//     getAllNodes : function(){
//         var nodeMap = this.sceneManager.dataNodeMap;
//         if(!nodeMap) return null;
//         var allNodes = [];
//         for(var id in nodeMap){
//             var node = nodeMap[id];
//             if(node && this.isDealwith(node)) {
//                 var data = this.sceneManager.getNodeData(node);
//                 if (!data) return;
//                 // var space = this.spaceManager.computeSpace(data);
//                 // if (space && (space instanceof it.Space1)) {
//                 var space = this.getDataSpace(data);
//                 if (space) {
//                     allNodes.push(node);
//                 }
//             }
//         }
//         return allNodes;
//     },

//     /**
//      * 获取当前场景下的所有的node
//      */
//     getSceneNodes : function(){
//         var sceneNodes = [];
//         var sceneDatas = this.sceneManager.getSceneDatas();
//         if(sceneDatas){
//             var nodeMaps = this.sceneManager.dataNodeMap;
//             for(var id in sceneDatas){
//                 var node = nodeMaps[id];
//                 var data = sceneDatas[id];
//                 if(node && data && this.isDealwith(node)){
//                     // var space = this.spaceManager.computeSpace(data);
//                     var space = this.getDataSpace(data);
//                     // if (space && (space instanceof it.Space1)) {
//                     if (space) {
//                         this._dealWithOneNode(node);
//                         sceneNodes.push(node);
//                     }
//                 }
//             }
//         }
//         return sceneNodes;
//     },

//     initAllNodes : function(){
//         var nodeMap = this.sceneManager.dataNodeMap;
//         if(!nodeMap) return null;
//         this.virtualNode = [];
//         for(var id in nodeMap){
//             var node = nodeMap[id];
//             var data = this.sceneManager.getNodeData(node);
//             if (data) {
//                 data.setUserData('dyna_user_data_totalCount',null);//计算的时候清空
//                 data.setUserData('dyna_user_data_empCount',null);
//             }
//             this._dealWithOneNode(node);
//         }
//         return this.virtualNode;
//     }

// });
/**
 *
 * @param sceneManager
 * @param inputPane
 * @constructor
 */
it.BaseSearch = function(sceneManager,inputPane){
    if(!sceneManager) {
        console.error("agument sceneManager can not be null");
        return;
    }
    this.sceneManager = sceneManager;
    this.dataManager = this.sceneManager.dataManager;
    this.dataFinder = new it.DataFinder(this.sceneManager.dataManager);
    var self = this;
    this.dataFinder.filter = function(data){
        return self.filter(data);
    };
//    this.orgTreeManager = new it.OrganizeTreeManager(this.sceneManager.dataManager);
    this.virtualManager = this.getVirtualManager() || new it.VirtualManager(sceneManager);
    this.virtualManager.isDealWithFunction = function(data){ // 如果是房间的话则不出来透明
        if(!data) return false;
        var category = self.dataManager.getCategoryForData(data);
        if (category) {
            var catId = category.getId().toLowerCase();
            if (catId.indexOf('room') >= 0) {
                return false;
            } else if (catId.indexOf('datacenter') >= 0) {
                return false;
            } else if (catId.indexOf('building') >= 0) {
                return false;
            }else if (catId.indexOf('earth') >= 0) {
                return false;
            }
        }
        return true;
    }
    this.sceneManager.viewManager3d.addMaterialFilter(this.virtualManager);
    this.treeView = null;
    this.orgTreeManager = new it.OrganizeTreeManager(this.sceneManager.dataManager);
    this.defaultEventHandler = sceneManager.viewManager3d.getDefaultEventHandler();
    this.inputPane = inputPane||this.createInputPane();
    this.searPanel = null;
    this.clearAllFunction = null;
    this.initSearchPane();
};

mono.extend(it.BaseSearch,Object,{

    createInputPane : function(){
        return new it.BasePanel();
    },

    getVirtualManager : function(){
        return new it.VirtualManager(this.sceneManager);
    },

    addVirtualManager : function(){
        this.sceneManager.viewManager3d.addMaterialFilter(this.virtualManager);
    },

    removeVirtualManager : function(){
        this.sceneManager.viewManager3d.removeMaterialFilter(this.virtualManager);
    },

    filter:function(data){
       return true;
    },

    clearAllVirtual : function(){
        this.virtualManager.clearAll();
    },
    
    /**
     * 当没有搜索出任何东西时的接口
     */
    showNoData : function(){
        
    },

    initSearchPane : function(){
        this.searPanel = $('.search-main-pane');
        var paneIndex = 0;
        if(this.searPanel && this.searPanel.length > 0){
            paneIndex = this.searPanel.length;
        }
        this.searPanel = $('<div id = "search-main-pane_'+paneIndex+'" class="search-main-pane"></div>');
//        this.searPanel.css('left',10);
//        this.searPanel.css('top',10);
        this.searPanel.append(this.inputPane.getContentPane());
        this.treeView = new it.TreeView(this.searPanel);
//        $('body').append(this.searPanel);
        var self = this;
        this.treeView.clickNodeFunction = function(treeData){
            self.clickTreeNode(treeData);
        };

        this.treeView.mouseoverNodeFunction = function(treeData){
            self.mouseOverTreeNode(treeData);
        };

        this.inputPane.doClickFunction = function(values){
//            var values = [{key:'u:userId',value:'aaa',operation:'like'}];
            self.beforeDoClick();
            self.setData(values);
            var height = self.searPanel.height() - self.inputPane.getContentPane().height();
            self.treeView.setTreeHeight(height);
            self.sceneManager.viewManager3d.clearVisibleMap();
        };

        this.inputPane.doClearFunction = function(){
            self.clearSearch();
        };
    },

    beforeDoClick : function(){

    },

    show : function(){
        this.searPanel.show();
    },

    beforHide : function(){

    },

    hide : function(){
        this.beforHide();
        this.searPanel.hide();
    },

    /**
     * 处理查询条件，该类根据查询条件获取查询的结果，然后组织tree
     * @param conditions，指的是所有的查询条件
     */
    setData : function(conditions){
        // var results = this.dataFinder.find(conditions);
        var results = this.getResultByConditions(conditions);
        var treeNodes = null;
        if (!results || results.length < 1) {
            this.treeView.clearTreeData();
//            return;
        }else{
            treeNodes = this.orgTreeManager.organizeTree(results);
            this.treeView.setData(treeNodes, false);
        }
        this.setResult(results,treeNodes);
    },

    /**
     * 根据条件获取查询的结果
     * 单独拿出来是为了方便扩展，重写这个方法可以对接第三方
     */
    getResultByConditions : function(conditions){
        return this.dataFinder.find(conditions);
    },

    /**
     * 处理查询出来的结果
     * @param results
     * @param treeNodes
     */
    setResult : function(results,treeNodes){

    },

    clearSearch : function(){
        this.treeView.setData(null);
        this.clearSearchData();
        this.sceneManager.network3d.dirtyNetwork();
    },

    /**
     * 点击搜索中的“清除”时，所要处理的就是清除搜索的结果即可，显示所有
    */
    clearSearchData : function(){

    },

    /**
     * 清除其初始化的东西,默认是清除搜索的结果
     */
    clearAll : function(){
        this.treeView.setData(null);
        if(this.inputPane.clearInput){
            this.inputPane.clearInput();
        }
        // this.removeVirtualManager();
        if(this.clearAllFunction){
            this.clearAllFunction();
        }else{
            this.clearSearchData();
        }
    },

    shouldClick : function(data){
        return true;
    },

    getRootDataBySceneAndData : function(scene,data,scope){
        if(!scene || !data){
            return null;
        }
        scope = scope || this;
        var dataType = this.sceneManager.dataManager.getDataTypeForData(data);
        if(dataType && dataType.getCategoryId() === scene.getCategoryId()){
            return data;
        }else if(data.getParentId()){
            var parent = this.sceneManager.dataManager.getDataById(data.getParentId());
            if(parent){
                return scope.getRootDataBySceneAndData(scene,parent,scope);
            }
        }
        return null;
    },

    /**
     * 点击树上的节点，camera自动移过去
     * 注意：当前是在dc场景下，点击node时应当判断其所在的场景，如果不是在同一场景下得清空，否则的会会存在问题;
     * 注意2：即使nodeScene和currentScene，有可能它们的rootNode不一样，如，1楼的机柜和2楼的机柜;
     *
     * @param treeData
     */
    clickTreeNode : function(treeData){
        var id = treeData.id;
        if(!id) return;
        if(!this.sceneManager.viewManager3d.enableDBLClick){ //表示锁定，场景切换的过程中，不可点击再切换
            return;
        }
        var data = this.sceneManager.dataManager.getDataById(id);
        if(!data || !this.treeView.isClick(data)) return;
        var assetNode = this.sceneManager.dataNodeMap[id];
//        var nodeData = this.sceneManager.getNodeData(assetNode);
        if(!this.shouldClick(data)){
            return;
        }
        if(!this.sceneManager.isCurrentSceneInstance(data,true)){ //如果一下子跳到其他的场景的某个非根对象
            var sceneAndRootData = this.sceneManager.getSceneAndRootByData(data);
            if(sceneAndRootData){
                this.sceneManager.gotoScene(sceneAndRootData.scene,sceneAndRootData.rootData,null,false);
                //以下有可能存在一些不合理，因为gotoScene中可能会存在很长时间的动画，特别是楼层切换那块，马上这么调用，有可能有问题
                //如果是整个楼层的话，就不需这么lookAt了(严格意义上说是Data本身就在场景的root就不需再去设置镜头了)
                if(sceneAndRootData.rootData != data){
                    assetNode = this.sceneManager.dataNodeMap[id];
                    if(!assetNode){
                        this.sceneManager.loadLazyData(data);
                    }
                }else{
                    return ; //根节点就是clickData，那就返回吧
                }
            }
        }
        //注意以下两种情况：
        //1、还没有创建，如lazyable的设备，只有在focus该机柜时，它的孩子设备才会被创建(第一次)并加到box中
        //2、有可能就是存在该场景中，只是不在box中而已，如：lazyable模式下，设备都被移除掉了
        var box3d = this.sceneManager.network3d.getDataBox();
        if(!assetNode || !box3d.getDataById(assetNode.getId())){
            this.sceneManager.loadLazyData(data);
            if(!assetNode){
                assetNode = this.sceneManager.dataNodeMap[data.getId()];
            }
        }
        if(this.defaultEventHandler 
            && assetNode != this.sceneManager.getCurrentRootNode()){ //gotoScene中有setFocus，并且该方法有可能会重写
            this.defaultEventHandler.lookAt(assetNode);
        }
    },

    mouseOverTreeNode : function(treeData){
        var id = treeData.id;
        this.sceneManager.network3d.getDataBox().getSelectionModel().clearSelection();
        if (id) {
            var assetNode = this.sceneManager.dataNodeMap[id];
            if (assetNode) {
                assetNode.setSelected(true);
            }
        }
    },

    getTreeView : function(){
        return this.treeView;
    },

    getOrganizeTreeManager : function(){
        return this.orgTreeManager;
    },

});

/**
 * 资产搜索的处理
 * @param sceneManager
 * @constructor
 */
it.ITSearchManager = function(sceneManager,inputPane){
    it.ITSearchManager.superClass.constructor.call(this, sceneManager,inputPane);
    this._assetImage = "data:image/png;base64,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";
}

mono.extend(it.ITSearchManager,it.BaseSearch,{

    createInputPane : function(){
        return new it.ITSearchPanel();
    },

    clearSearchData : function(){
        this.clearBillboard();
    },

    setResult : function(results,treeNodes){
        this.clearBillboard();
        this.virtualManager.addAll();
        if(!treeNodes) {
            this.showNoData();
            return;
        }
        for(var i = 0 ; i < treeNodes.length; i++){
            var treeNode = treeNodes[i];
            this.showData(treeNode);
        }
    },

    showData : function(treeNode){
        var data = this.orgTreeManager.getDataByNode(treeNode);
        if(!data){
            return;
        }
        if(this.showBillboard(data)){
            this.addDataBillBoard(data);
        }
        this.virtualManager.remove(data); //同理 removeByDescendant
        var children = this.orgTreeManager.getChildren(treeNode);
        if(children && children.length > 0){
            for(var i = 0 ;i < children.length ; i++){
                var child = children[i];
                if(child){
                    this.showData(child,this);
                }
            }
        }
    },

    /***
     * Data是否显示其billboard
     * @param data
     * @returns {boolean}
     */
    showBillboard : function(data){
        if(!data) return false;
        var assetType = data.getDataTypeId();
        if(assetType){
            if(assetType.indexOf('equipment') >=0){
                return false;
            }
            if(assetType.indexOf('room') >=0){
                return false;
            }
            if(assetType.indexOf('floor') >=0){
                return false;
            }
        }
        return true;
    },

    clearBillboard : function(){
        if(this.sceneManager.dataNodeMap){
            for(var id in this.sceneManager.dataNodeMap){
                var node = this.sceneManager.dataNodeMap[id];
                if(node && node.getClient('asset_billboard')){
                    var billboard = node.getClient('asset_billboard');
                    billboard.setParent(null);
                    this.sceneManager.network3d.getDataBox().remove(billboard);
                }
            }
        }
        this.virtualManager.clearAll();
    },

    /**
     * 创建资产的Billboard
     * @param data
     */
    addDataBillBoard : function(data){
        if(!data) return;
        var node = this.sceneManager.dataNodeMap[data.getId()];
        if(!node) return;
        var box = this.sceneManager.network3d.getDataBox();
        if(!box.getDataById(node.getId())){
            return ;
        }
        var billboard = new mono.Billboard();
        billboard.setPosition(0, node.getBoundingBox().max.y + 20, 0);
        billboard.setStyle('m.alignment', mono.BillboardAlignment.bottomCenter);
        billboard.setStyle('m.transparent', true);
//        billboard.setStyle('m.texture.image', TML.Factory3D.getImagePath('asset.png'));
        billboard.setStyle('m.texture.image', this._assetImage);
        billboard.setStyle('m.alignment', mono.BillboardAlignment.bottomCenter);
        // billboard.setStyle('m.vertical', true);
        billboard.setScale(40, 50, 1);
        billboard.setParent(node);
        billboard.setClient('it_data',data);
        box.add(billboard);
        node.setClient('asset_billboard', billboard);
    }

});

it.SpaceSearchVirtualManager = function (sceneManager, spaceManager) {
    it.VirtualManager.call(this, sceneManager);
    this.spaceManager = spaceManager;
}

mono.extend(it.SpaceSearchVirtualManager, it.VirtualManager, {

    beforeAdd: function (data) {
        if (data) {
            // delete data._userDataMap['dyna_user_data_totalSpace']; //总空间
            // delete data._userDataMap['dyna_user_data_totalOccupation']; //总的占用空间
            delete data._userDataMap['dyna_user_data_maxSerSpace']; //最大的连续空间
            // delete data._userDataMap['dyna_user_data_totalEmpSpace']; //总的剩余空间
            delete data._userDataMap['dyna_user_data_totalCount']; //总共可以放“uNumber”U的个数
            delete data._userDataMap['dyna_user_data_empCount']; //空余的“uNumber”U的个数
        }
    },

    filterMaterial: function (originalMaterial, filterdMaterial, node) {
        var sm = this.sceneManager;
        var sm2 = this.spaceManager;
        var map = this.materialMap;
        if (sm.getNodeData(node)) {
            return filterdMaterial;
        }
        if (sm2.isSpaceNode(node)) {
            var parent = node.getParent();
            if (sm2.isSpaceNode(parent)) {
                parent = parent.getParent();
            }
            var transFlag = false;
            if (parent) {
                var data = this.getDataByNode(parent);
                if (data) {
                    id = this.getBId(data);
                    if (this._global_tmap[id]) { // 对于透明来讲，如果global中是虚化的，那怎么着它就是虚化的
                        transFlag = this._global_tmap[id];
                    } else if (this._tmap[id]) {
                        transFlag = this._tmap[id];
                    }
                }
            }
            if (!transFlag) {
                return filterdMaterial;
            }
            var id = originalMaterial.getUniqueCode();
            var m = this.materialMap[id];
            if (!m) {
                m = originalMaterial.clone();
                this.materialMap[id] = m;
                m.transparent = true;
                m.opacity = 0.05;
            }
            return m;
        }
    }

});

/**
 *  空间可视化搜索的处理
 *  还得提供场景切换时空间可视化需重新计算的接口，空间可视化永远处理的是当前场景下的
 * @param sceneManager
 * @constructor
 */
it.SpaceSearchManager = function (sceneManager, inputPane, mode) {
    it.BaseSearch.call(this, sceneManager, inputPane);
    this.spaceManager = new it.SpaceManager(this.dataManager, this.sceneManager);
    this.diagram = new it.Diagram();
    this.isVirtualFunction = null;
    this.virtualNode = [];
    this.spaceMap = {};
    this.mode = mode || 1;
    this.maxRackUSize = 47;
    var self = this;
    this.spaceManager.spaceNodeColorFunction = function (percent, data, space) {
        // ratio 表示的是已用的百分比
        // if (space) {
        if (data && data.getUserData('dyna_user_data_empCount')) {
            var occupationCount = parseInt(data.getUserData('dyna_user_data_empCount'));
            var num = self.getUNumber() || 1;
            var total_count = Math.floor(self.maxRackUSize/num);
            var unit_count = Math.floor(total_count / 4); //ceil
            if (total_count <= 4) {
                if (occupationCount === total_count) {
                    return '#5DBDE0'; //蓝
                } else if ((total_count - 1) > 0 && occupationCount === (total_count - 1)) {
                    return '#6FD772';
                } else if ((total_count - 2) > 0 && occupationCount === (total_count - 2)) {
                    return '#FFC95A';
                } else {
                    return '#Fd674F';
                }
            } else {
                if (occupationCount <= unit_count) {
                    return '#Fd674F';
                } else if (occupationCount >= (unit_count + 1) && occupationCount <= unit_count * 2) {
                    return '#FFC95A';
                } else if (occupationCount >= (unit_count * 2 + 1) && occupationCount <= unit_count * 3) {
                    return '#6FD772';
                } else if (occupationCount >= (unit_count * 3 + 1) && occupationCount <= total_count) {
                    return '#5DBDE0';
                } else {
                    console.log('can not compute the spaceNodeColorFunction color !');
                }
            }
        }
        // }
        if (!percent) { //空间可视化时，计算内部的颜色时
            return '#5DBDE0'; //'#BEEB9F';
        } else if (percent <= 0.25) {
            return '#5DBDE0'; //'#BEEB9F'; 绿
        } else if (percent <= 0.5) {
            return '#6FD772'; // FFFF99 黄
        } else if (percent <= 0.75) {
            return '#FFC95A'; //'#FFBB11'; 橙
        } else {
            return '#Fd674F'; // FF3357 '#FF6138'; //红色，表示已用的很多
        }
    };

    this.spaceManager.spaceNodeFrameColorFunction = function (percent, data, space) {
        // if (space) {
        if (data && data.getUserData('dyna_user_data_empCount')) {
            var occupationCount = parseInt(data.getUserData('dyna_user_data_empCount'));
            var num = self.getUNumber() || 1;
            var total_count = Math.floor(self.maxRackUSize/num);
            var unit_count = Math.floor(total_count / 4); //ceil
            if (total_count <= 4) {
                if (occupationCount === 1) {
                    return '#018ABD';
                } else if (occupationCount === 2) {
                    return '#1A920A';
                } else if (occupationCount === 3) {
                    return '#E68D00';
                } else {
                    return '#CE3118';
                }
            } else {
                if (occupationCount <= unit_count) {
                    return '#CE3118';
                } else if (occupationCount >= (unit_count + 1) && occupationCount <= unit_count * 2) {
                    return '#E68D00';
                } else if (occupationCount >= (unit_count * 2 + 1) && occupationCount <= unit_count * 3) {
                    return '#1A920A';
                } else if (occupationCount >= (unit_count * 3 + 1) && occupationCount <= total_count) {
                    return '#018ABD';
                } else {
                    console.log('can not compute the spaceNodeFrameColorFunction color !');
                }
            }
        }
        // }
        if (!percent) { //空间可视化时，计算内部的颜色时
            return '#018ABD'; //'#BEEB9F';
        } else if (percent <= 0.25) {
            return '#018ABD'; //'#BEEB9F'; 绿
        } else if (percent <= 0.5) {
            return '#1A920A'; // FFFF99 黄
        } else if (percent <= 0.75) {
            return '#E68D00'; //'#FFBB11'; 橙
        } else {
            return '#CE3118'; // FF3357 '#FF6138'; //红色，表示已用的很多
        }
    };

    this.resetTreeLabel();
    this.virtualAllNodes();
    this.clearAllFunction = function () {
        this.clearSpaceNode();
    }
}

mono.extend(it.SpaceSearchManager, it.BaseSearch, {
    beforeDoClick: function () {
        var cn = this.sceneManager._currentRootNode;
        this.sceneManager.viewManager3d.defaultEventHandler.lookAt(cn);
    },
    /**
     * 切换到空间可视化时，一些初始化的一些动作，如添加场景变化的监听，隐藏掉哪些资产
     */
    setupInit: function () {
        if (!this.visOrVirtFilter) { // 以免重复创建
            this.visOrVirtFilter = this.setVisibleOrVirtualData(this.sceneManager);
        }
        if (this.visOrVirtFilter instanceof it.VisibleManager) {
            this.sceneManager.viewManager3d.addVisibleFilter(this.visOrVirtFilter);
        } else if (this.visOrVirtFilter instanceof it.VirtualManager) {
            this.sceneManager.viewManager3d.addMaterialFilter(this.visOrVirtFilter);
        }
        
        this.addVirtualManager();
        this.setupDoOther(this.sceneManager);
    },

    /**
     * 空间可视化卸载。从空间可视化切换到IT可视化时，的去掉那些在空间可视化时的初始化的动作
     * 可是如果我从floor的空间可视化跳到上一层呢？ 那么就不会clear了，
     *         并且使得building中都有彩色（不过可以在sceneChangeListener中判断）
     * */
    clearInit: function () {
        this.sceneManager.removeSceneChangeListener(this.sceneChangeListener);
        if (this.visOrVirtFilter) {
            if (this.visOrVirtFilter instanceof it.VisibleManager) {
                this.sceneManager.viewManager3d.removeVisibleFilter(this.visOrVirtFilter);
            } else if (this.visOrVirtFilter instanceof it.VirtualManager) {
                this.sceneManager.viewManager3d.removeMaterialFilter(this.visOrVirtFilter);
            }
        }
        this.removeVirtualManager();
        this.clearDoOther(this.sceneManager);
    },

    /**
     * 在空间可视化时，哪些资产应该被隐藏掉
     * @param dataTypeId
     * @param data
     * @returns {boolean}
     */
    invisibleOrVirtualData: function (dataTypeId, data) {
        if (!dataTypeId && !data) {
            return false;
        }
        var category = this.sceneManager.dataManager.getCategoryForDataType(dataTypeId);
        if (category && category.getId() && category.getId().toLowerCase().indexOf('channel') >= 0) {
            return true;
        }
        return false;
    },

    /**
     * 设置不可见(或虚化)的data
     * @param visibleFilter或virtualManager
     */
    setVisibleOrVirtualData: function (sceneManager) {
        var visibleFilter = new it.VisibleManager(sceneManager);
        var groupByType = this.dataManager._dataTypeDatas;
        if (groupByType) {
            for (var typeId in groupByType) {
                if (this.invisibleOrVirtualData(typeId)) {
                    var datas = groupByType[typeId];
                    if (datas) {
                        for (var id in datas) {
                            visibleFilter.setVisible(datas[id], false);
                        }
                    }
                }
            }
        }
        return visibleFilter;
    },

    /**
     * 初始化时的其他动作，这里留给用户自己扩展
     * @param sceneManager
     */
    setupDoOther: function (sceneManager) {

    },

    /**
     * 卸载时的其他动作，这里留给用户扩展
     * @param sceneManager
     */
    clearDoOther: function (sceneManager) {

    },

    createInputPane: function () {
        this.inputPane = new it.SpaceSearchPanel();
        return this.inputPane;
    },

    getVirtualManager: function () {
        return new it.SpaceSearchVirtualManager(this.sceneManager, new it.SpaceManager(this.dataManager, this.sceneManager));
    },

    resetTreeLabel: function () {
        var self = this;
        this.orgTreeManager.createLabel = function (treeData) {
            return self.setLabel(treeData);
        }
    },

    getUNumber: function () {
        if (this.inputPane) {
            return parseInt(this.inputPane.getUNumber());
        } else {
            return 1;
        }
    },

    setLabel: function (treeData) {
        if (!treeData || !treeData.getId()) {
            return null;
        }
        var id = treeData.getId();
        var data = this.dataManager.getDataById(id);//获取data，将计算的结果保存进去，以免其他地方重复计算
        // var space = this.spaceMap[id];
        var prex = this.getTreeNodeLabel(treeData);
        if (!prex) {
            prex = id;
        }
        var count = 0;
        if (data) {
            count = parseInt(data.getUserData('dyna_user_data_empCount'));//空余的“uNumber”U的个数
        }
        if (count) {
            prex += '(' + count + '个)';
        }
        return prex;
    },

    /**
     * 搜索树的叶子结点的前缀
     */
    getTreeNodeLabel: function (treeData) {
        if (treeData) {
            return treeData.getId();
        }
        return "";
    },

    /**
     * 重写，先计算每个data，然后再组织tree
     */
    setData: function (conditions) {
        var results = this.dataFinder.find(conditions);
        var treeNodes = null;
        this.setResult(results);
        if (!results || results.length < 1) {
            this.showNoData();
            this.treeView.clearTreeData();
        } else {
            treeNodes = this.orgTreeManager.organizeTree(results);
            this.treeView.setData(treeNodes, false);
        }
    },

    setResult: function (result, treeNodes) {
        this.clearSpaceNode(); // 先清空
        this.virtualManager.addAll();
        if (!result) return;
        var nodes = [];
        for (var i = 0; i < result.length; i++) {
            var data = result[i];
            var node = this.sceneManager.dataNodeMap[data.getId()];
            //根据node获取其color Cube
            //            var spaceNode = this.getSpaceNode(node);
            this.virtualManager.remove(data);
            if (node) {
                this._dealWithOneNode(node);
                nodes.push(node);
            }
        }
        this.showSpaceNode(nodes);
    },

    beforHide: function () {
        this.diagram.hideDiagram();
    },

    /**
     * 点击搜索中的“清除”时，所要处理的就是清除搜索的结果即可，显示所有
      */
    clearSearchData: function () {
        this.initAllNodes();
        this.showSpaceNode();
        this.virtualManager.clearAll();
    },

    clearSpaceNode: function () {
        var nodes = this.getAllNodes();//this.virtualNode;
        this.spaceManager.remove1DSpaceNodeForNodes(nodes);
        this.spaceManager.hideSpaceMode();
        this.showSerialDiagram(1, nodes);
    },

    virtualAllNodes: function () {
        this.initAllNodes();
        this.showSpaceNode();
    },

    /**
     * 显示空间彩色机柜
     * @result 这个是查询结果，例图上的数量是通过该值计算的
     * 注意：create1DSpaceNodeForNodes中应该是传入当前场景下的所有的nodes，而不只是搜索结果
     */
    showSpaceNode: function (result) {
        var nodes = this.getSceneNodes();
        if (!result || result.length < 1) {
            result = nodes;
        }
        if (nodes && nodes.length > 0) {
            this.showSerialDiagram(this.getUNumber(), result);
        } else { //当没有node的时候就隐藏掉
            this.diagram.hideDiagram();
        }
        //        this.spaceManager.remove1DSpaceNodeForNodes(nodes);//要先清除，再create，否则会重复创建
        this.spaceManager.create1DSpaceNodeForNodes(nodes, this.mode); // 创建前，先移除已经放到该创建函数中了。
        this.spaceManager.showSpaceMode();
    },

    /**
     * 重写例图的显示内容
     * @param num 表示连续可用的空间，maxRackUSize
     * 剩余的个数越少，颜色就越接近与红色
     */
    showSerialDiagram: function (num, nodes) {
        var datas = [];
        var serialNumColorMap = {};
        num = parseInt(num);
        if (!num) {
            num = 1;
        }
        this.num = num;
        var total_count = Math.floor(this.maxRackUSize/num);
        var unit_count = Math.floor(total_count / 4); //ceil

        var color = this.getCapacityColor(0.1);
        var data = {
            color: color,
            minCount: (unit_count * 3 + 1),
            maxCount: total_count,
            value: (unit_count * 3 + 1) + '-' + total_count
        };
        if (total_count <= 4) {
            data.value = total_count;
            data.minCount = total_count;
            data.maxCount = total_count;
            serialNumColorMap[total_count] = color;
        } else {
            for (var i = (unit_count * 3 + 1); i <= total_count; i++) {
                serialNumColorMap[i] = color;
            }
        }
        datas.push(data);


        color = this.getCapacityColor(0.3);
        data = {
            color: color,
            minCount: (unit_count * 2 + 1),
            maxCount: unit_count * 3,
            value: (unit_count * 2 + 1) + '-' + (unit_count * 3)
        };
        if (total_count > 1 && total_count <= 4) {
            data.value = total_count - 1;
            data.minCount = total_count - 1;
            data.maxCount = total_count - 1;
            serialNumColorMap[total_count - 1] = color;
        } else {
            for (var i = (unit_count * 2 + 1); i <= (unit_count * 3); i++) {
                serialNumColorMap[i] = color;
            }
        }
        if (total_count > 1) {
            datas.push(data);
        }

        color = this.getCapacityColor(0.6);
        data = {
            color: color,
            minCount: (unit_count + 1),
            maxCount: unit_count * 2,
            value: (unit_count + 1) + '-' + (unit_count * 2)
        };
        if (total_count > 2 && total_count <= 4) {
            data.value = total_count - 2;
            data.minCount = total_count - 2;
            data.maxCount = total_count - 2;
            serialNumColorMap[total_count - 2] = color;
        } else {
            for (var i = (unit_count + 1); i <= (unit_count * 2); i++) {
                serialNumColorMap[i] = color;
            }
        }
        if (total_count > 2) {
            datas.push(data);
        }

        color = this.getCapacityColor(0.8);
        data = {
            color: color,
            minCount: 1,
            maxCount: unit_count,
            value: '1-' + unit_count
        };
        if (total_count > 3 && total_count <= 4) {
            data.value = total_count - 3;
            data.minCount = total_count - 3;
            data.maxCount = total_count - 3;
            serialNumColorMap[total_count - 3] = color;
        } else {
            for (var i = 1; i <= unit_count; i++) {
                serialNumColorMap[i] = color;
            }
        }
        if (total_count > 3) {
            datas.push(data);
        }
        var usedP = {};
        var totalMap = {};
        if (nodes && nodes.length > 0) {
            for (var i = 0; i < nodes.length; i++) {
                var data = this.sceneManager.getNodeData(nodes[i]);
                var dColor = serialNumColorMap[data.getUserData('dyna_user_data_empCount')];
                var space = data.getUserData('dyna_user_data_totalSpace');//总空间
                var occupation = data.getUserData('dyna_user_data_totalOccupation');//总的占用空间

                if (dColor) {
                    if (totalMap[dColor]) {
                        totalMap[dColor]++;
                    } else {
                        totalMap[dColor] = 1;
                    }
                    if (usedP[dColor]) {
                        var us = usedP[dColor];
                        var percent = Math.round(occupation / space * 100);
                        if (percent < us.minP) us.minP = percent;
                        if (percent > us.maxP) us.maxP = percent;
                    } else {
                        var percent = Math.round(occupation / space * 100);
                        usedP[dColor] = { 'minP': percent, 'maxP': percent };
                    }
                }
            }
            for (var i = 0; i < datas.length; i++) {
                var itemData = datas[i];
                if (!itemData) {
                    continue;
                }
                if (totalMap[itemData.color]) {
                    var strValue = '';
                    if (itemData.minCount) {
                        strValue = itemData.minCount;
                    }
                    if (itemData.minCount != itemData.maxCount) {
                        strValue += '-' + itemData.maxCount;
                    }
                    strValue += '(' + totalMap[itemData.color] + ')';
                    itemData.value = strValue;
                }

            }
        }
        $.each(datas, function (index, val) {
            var used = usedP[val.color];
            var count = totalMap[val.color] || 0;
            val.tip = '能够放置' + val.minCount + '-' + val.maxCount + '个' + num + 'U设备的机柜有' + count + '个';
            if (used) {
                val.tip += ', 使用率为' + used.minP + '% - ' + used.maxP + '%';
            }
        });

        this.diagram.setData(datas, '连续可用空间图例', function (index, el) {
            var data = datas[index];
            layer.tips(data.tip, el, { tips: [3, data.color], time: 30000 });//'#428BCA'
        }, function (index, el) {
            layer.closeAll();
        });
    },

    getCapacityColor: function (ratio) {
        // ratio 表示的是已用的百分比
        if (!ratio) {
            return '#5DBDE0';//'#BEEB9F';
        } else if (ratio <= 0.25) {
            return '#5DBDE0';//'#BEEB9F'; 绿
        } else if (ratio <= 0.5) {
            return '#6FD772';  // FFFF99 黄
        } else if (ratio <= 0.75) {
            return '#FFC95A';//'#FFBB11'; 橙
        } else {
            return '#Fd674F';// FF3357 '#FF6138'; //红色，表示已用的很多
        }
    },

    isDealwith: function (node) {
        if (!node) return false;
        if (this.isVirtualFunction) {
            return this.isVirtualFunction(node);
        }
        var data = this.sceneManager.getNodeData(node);
        if (!data) return false;
        // var type = this.sceneManager.dataManager.getDataTypeForData(data);
        // if(!type) return false;
        // if(type._model.indexOf('.rack') >0){
        //     return true;
        // }
        var category = this.sceneManager.dataManager.getCategoryForData(data);
        if (category && category.getId().toLowerCase() == 'rack') {
            return true;
        }
        return false;
    },

    getDataSpace: function (data) {
        if (!data) {
            return null;
        }
        var space = this.spaceMap[data.getId()];
        if (!space) {
            var dataSpace = this.spaceManager.computeSpace(data);
            if (dataSpace && (dataSpace instanceof it.Space1)) {
                this.spaceMap[data.getId()] = dataSpace;
                space = dataSpace;
            }
        }
        return space;
    },

    _dealWithOneNode: function (node) {
        var uNumber = this.getUNumber();
        if (!uNumber) {
            uNumber = 1;
        }
        if (node) {
            if (this.isDealwith(node)) {
                var data = this.sceneManager.getNodeData(node);
                if (!data) return;
                // var space = this.spaceMap[data.getId()]; 
                // if (!space) {
                //     space = this.spaceManager.computeSpace(data);
                //     if(space && (space instanceof it.Space1)){
                //        this.spaceMap[data.getId()] = space;
                //     }
                // }
                var space = this.getDataSpace(data);
                var count = 0;
                // if(space && (space instanceof it.Space1)){
                if (space) {
                    // this.spaceMap[it.SceneManager.getNodeDataId(node)] = space;
                    var maxEmpSerSpace = 0, totalEmpSpace = space.getTotal() - space.getOccupation();
                    var empList = space.getEmptyList();
                    if (empList && empList.length > 0) {
                        for (var i = 0; i < empList.length; i++) {
                            var ep = empList[i];
                            if (ep.total > maxEmpSerSpace) {
                                maxEmpSerSpace = ep.total;
                            }
                            if (ep.total >= uNumber) {
                                count += Math.floor(ep.total / uNumber);
                            }
                        }
                    }
                    data.setUserData('dyna_user_data_totalSpace', space.getTotal());//总空间
                    data.setUserData('dyna_user_data_totalOccupation', space.getOccupation());//总的占用空间
                    data.setUserData('dyna_user_data_maxSerSpace', maxEmpSerSpace);//最大的连续空间
                    data.setUserData('dyna_user_data_totalEmpSpace', totalEmpSpace);//总的剩余空间
                    data.setUserData('dyna_user_data_totalCount', parseInt(space.getTotal() / uNumber));//总共可以放“uNumber”U的个数
                    data.setUserData('dyna_user_data_empCount', count);//空余的“uNumber”U的个数
                    this.virtualNode.push(node);
                }
            }
        }
    },

    /**
     * 获取所有的Node，此方法在这里没什么用
     * @returns {*}
     */
    getAllNodes: function () {
        var nodeMap = this.sceneManager.dataNodeMap;
        if (!nodeMap) return null;
        var allNodes = [];
        for (var id in nodeMap) {
            var node = nodeMap[id];
            if (node && this.isDealwith(node)) {
                var data = this.sceneManager.getNodeData(node);
                if (!data) return;
                // var space = this.spaceManager.computeSpace(data);
                // if (space && (space instanceof it.Space1)) {
                var space = this.getDataSpace(data);
                if (space) {
                    allNodes.push(node);
                }
            }
        }
        return allNodes;
    },

    /**
     * 获取当前场景下的所有的node
     */
    getSceneNodes: function () {
        var sceneNodes = [];
        var sceneDatas = this.sceneManager.getSceneDatas();
        if (sceneDatas) {
            var nodeMaps = this.sceneManager.dataNodeMap;
            for (var id in sceneDatas) {
                var node = nodeMaps[id];
                var data = sceneDatas[id];
                if (node && data && this.isDealwith(node)) {
                    // var space = this.spaceManager.computeSpace(data);
                    var space = this.getDataSpace(data);
                    // if (space && (space instanceof it.Space1)) {
                    if (space) {
                        this._dealWithOneNode(node);
                        sceneNodes.push(node);
                    }
                }
            }
        }
        return sceneNodes;
    },

    initAllNodes: function () {
        var nodeMap = this.sceneManager.dataNodeMap;
        if (!nodeMap) return null;
        this.virtualNode = [];
        for (var id in nodeMap) {
            var node = nodeMap[id];
            var data = this.sceneManager.getNodeData(node);
            if (data) {
                data.setUserData('dyna_user_data_totalCount', null);//计算的时候清空
                data.setUserData('dyna_user_data_empCount', null);
            }
            this._dealWithOneNode(node);
        }
        return this.virtualNode;
    }

});
it.Tab = function () {

};

mono.extend(it.Tab, Object, {

    _getTargetLi: function (element) {
        if (!element) return null;
        if (element.tagName && element.tagName.toUpperCase() == 'LI') {
            return element;
        } else if (element.parentElement) {
            return arguments.callee(element.parentElement);
        }
        return null;
    },

    _onclick: function (event) {
        if (event.preventDefault) {
            event.preventDefault();
        }
        var targetLi = this._getTargetLi(event.originalEvent.target);
        var href = targetLi.getAttribute('href'); // 有可能点中的是这个
        if (!href) {
            href = targetLi.childNodes[0].getAttribute('href');
        }

        if (href && href.length > 0) {
            var id = href.substring(1, href.length);

            if ($('#' + id)[0] && $('#' + id)[0].children && $('#' + id)[0].children.length > 0) { //如果类似于只是个按钮，比如点击tab只让旋转，并且该tab根本就没有content
                //清除之前的选中的li的hover,并且放到了这里，当有内容的时候才清除，像旋转就不清除
                this._clearHover();
                targetLi.className = 'hover';
                //隐藏所有的content的item
                $('.contentbox div.tab-pane').hide(); // 这种方式也会隐藏掉contentbox的子孙类的div
                $('#' + id).show();
            }
        }
    },

    _clearHover: function () {
        var menuItems = $('.property-pane-tab .menu ul li');
        if (menuItems && menuItems.length > 0) {
            for (var i = 0; i < menuItems.length; i++) {
                var menuItem = menuItems[i];
                if (menuItem && menuItem.className) {
                    menuItem.className = "";
                }
            }
        }
    },

    initAll: function () {
        var self = this;
        $('.property-pane-tab .menu ul li').click(function (event) {
            self._onclick(event);
        });
    }

});

it.PropertyPane = function (parentDiv) {
    this.propertyPane = $("<div class='property-pane it-shadow'></div>");
    this.propertyTab = $("<div class='property-pane-tab'></div>");
    this.propertyItemsDiv = $("<div class='menu'></div>");//去掉it-shadow
    this.propertyItemsPane = $("<ul></ul>");
    this.propertyTabContent = $('<div class="contentbox scroll-class">'); //tab-content scroll-class 去掉 it-shadow
    this.propertyItemsDiv.append(this.propertyItemsPane);
    this.propertyTab.append(this.propertyItemsDiv);
    this.propertyTab.append(this.propertyTabContent);
    this.propertyPane.append(this.propertyTab);
    if (!parentDiv) {
        parentDiv = document.body;
    }
    parentDiv.appendChild(this.propertyPane[0]);
    this.closeDiv = $('<div class="it-property-title"></div>'); //it-property-title it-shadow 去掉it-shadow
    this.propertyPane.prepend(this.closeDiv);

    this.isvisible;
    this.tab = new it.Tab();
    this.hide();
};

mono.extend(it.PropertyPane, Object, {

    _createTitle: function (titleText) {
        if (!titleText) {
            titleText = '资产属性';
        }
        var titleDiv = $('<span>' + titleText + '</span>');
        var closeIcon = $('<div class="close"></div>');
        var self = this;
        closeIcon.click(function (e) {
            self.hide();
        });
        this.closeDiv.append(titleDiv);
        this.closeDiv.append(closeIcon);
    },

    clear: function () {
        this.propertyItemsPane.empty();
        this.propertyTabContent.empty();
        this.closeDiv.empty();
    },

//{title:title,items:[{icon:icon,onclick:callback,title:t,properties:pro/或者是数组[{key:value},{}]},{icon:icon.....}]}
    /**
     * showIndex表示的是要显示哪一个tab
     */
    setData: function (contents, node, titleText, showIndex) {
        this.clear();
        this._createTitle(titleText);
        if (!contents || !contents.items || contents.items < 1) return;
        var self = this;
        var items = contents.items;
        for (var i = 0; i < items.length; i++) {
            var item = items[i]; //{icon:icon,title:t,propertyObj:pro/或者是数组[{key:value},{}]}
            if (!item) {
                continue;
            }
            if (item.isShow && !item.isShow(node)) {
                continue;
            }
            var href = "tab_" + i;
            var title = item.title;
            //  var icon = item.icon;
            var className = item.className;
            var on_click = item.onclick;
            var propertyObj = item.properties;
            var isGroup = item.isGroup || item.isGrop;
            if (i == 0) {
                //        this.addTab(href,title,propertyObj,icon,true,isGroup,on_click);
                this.addTab(href, title, propertyObj, className, true, isGroup, on_click, node);
            } else {
                //    this.addTab(href,title,propertyObj,icon,false,isGroup,on_click);
                this.addTab(href, title, propertyObj, className, false, isGroup, on_click, node);
            }
        }

        //实现tooltip
        this.showTooltip({
            id: '.menu ul li a',
            parent: this.propertyPane,
            offsetY: 10
        });

        this.tab.initAll();
        this.showTabByIndex(showIndex);
    },

    /**
     *
     * @param href
     * @param title
     * @param contentObj
     * @param icon
     * @param visible
     * @param onclick
     * @param isButton 如果只是button的话，那它只是个button,没有内容，也并不会像tab那样有选中的效果
     * @param data
     */
    addTab: function (href, title, contentObj, className, visible, isGroup, onclick, node) {
        var tabItem = $('<li ><a href="#' + href + '" rel = "' + title + '" class= ' + className + ' ></a></li>');

        if (visible) {
            tabItem.show();
            tabItem.attr('class', 'hover');
        }
        if (onclick) {
            tabItem.click(onclick);
        }

        this.propertyItemsPane.append(tabItem);
        var tabItemContent = $('<div class="tab-pane" id="' + href + '"></div>');
        if (visible) {
            tabItemContent.show();
        }
        tabItemContent.append(this.createTableItemContentByObj(contentObj, isGroup, node));
        this.propertyTabContent.append(tabItemContent);
    },

    showTabByIndex: function (index) {
        // var tab = $('[href="#tab_"'+index+']');
        var id = 'tab_' + parseInt(index || 0);
        // $('[href="#tab_0"]').parent().attr('class','hover')
        if ($('#' + id)[0]
            && $('#' + id)[0].children
            && $('#' + id)[0].children.length > 0
            && $('[href="#' + id + '"]')
            && $('[href="#' + id + '"]').length > 0
        ) {
            this.tab._clearHover();
            // targetLi.className = 'hover';
            $('[href="#' + id + '"]').parent().attr('class', 'hover');
            $('.contentbox div.tab-pane').hide(); // 这种方式也会隐藏掉contentbox的子孙类的div
            $('#' + id).show();
        }
    },

    createTableItemContentByObj: function (contentObj, isGroup, node) {
        if (!contentObj) {
            return;
        }
        var table = $('<form class="form-horizontal" role="form"></form>');
        var src = contentObj.src;
        if (typeof(src) == 'function') {
            src = src(node);
        }
        if (contentObj.isIframe && src) { //如果是iframe，并且url不为空时，则直接嵌进去
            table = $('<form class="form-horizontal" role="form" style="position:relative;height:100%;width:100%"></form>');
            var pane = '<iframe src="' + src + '" style="position: relative;height: 100%;width: 100%"></iframe>';
            table.append(pane);
        } else if (contentObj instanceof Array) {  //[{name:'name',value:'维修信息dddd',callback:callback},{name:'id',value:'ssddfr',callback:callback}]
            if (contentObj.length > 0) {
                if (contentObj.title) {
                    var head = this._createTableRow(contentObj.title);
                    if (head) {
                        table.append(head);
                    }
                }
                for (var i = 0; i < contentObj.length; i++) {
                    var proItem = contentObj[i];
                    if (proItem) {
                        var callback = proItem.callback;
                        var mousemove = proItem.mousemove;
                        if (proItem.values) {
                            var values = proItem.values;
                            var row = this._createTableRow(values, (i + 1), callback, mousemove);
                            if (row) {
                                table.append(row);
                            }
                        } else if (proItem.name) {
                            var name = proItem.name;
                            var value = proItem.value;
                            var row = this._createKeyValueRow(name, value, isGroup, (i + 1), callback, mousemove);//默认的是有head的row需要间隔色
                            if (row) {
                                table.append(row);
                            }
                        }
                    }
                }
            }
        } else { // 对于一个object，就处理它所有的property
            for (var pro in contentObj) {
                if (typeof(contentObj[pro]) != 'function') {
                    var value = contentObj[pro];
                    var valText = value,
                        onclick = null,
                        style = null,
                        classname = null,
                        isButton = false;
                    if (value) {
                        if (value.value != undefined) {
                            valText = value.value;
                        }
                        if (value.onclick) {
                            onclick = value.onclick;
                        }
                        if (value.isButton && value.isButton == true) {
                            isButton = true;
                        }
                        if (value.style) {
                            style = value.style;
                        }
                        classname = value.classname;
                    }
                    var row = this._createKeyValueRow(pro, valText, isGroup, null, onclick, null, isButton, style, classname, node);
                    if (row) {
                        table.append(row);
                    }
                }
            }
        }
        return table;
    },

    _createTableHead: function (titles) {
        if (!titles) return;
        var row = $('<div class="form-group-no-margin"></div>');
        if (titles instanceof Array && titles.length > 0) {
            var count = Math.floor(12 / titles.length);
            if (count > 1) {
                var className = "col-sm-" + count + " table-label-min label-inline-block";
                for (var i = 0; i < titles.length; i++) {
                    var val = titles[i];
                    if (val) {
                        var label_Value = $('<label class="' + className + '">' + val + '</label>');
                        row.append(label_Value);
                    }
                }
                return row;
            }
        }
        else {
            // 暂时不支持
//        for(var pro in titles){
//            if(typeof(titles[pro]) != 'function') {
//                var value = titles[pro];
//                var row = this._createKeyValueRow(pro,value,isGroup);
//                if(row){
//                    table.append(row);
//                }
//            }
//        }
        }
    },

    /**
     *
     * @param label
     * @param value
     * @param isGroup 表示是否分组，分组的话，就将内容区域分成了两部分
     * @param hasHead
     * @param isTableRow
     * @param i
     * @param callback
     * @param mousemove
     * @returns {*}
     * @private
     */
    _createKeyValueRow: function (label, value, isGroup, i, onclick, mousemove, isButton, style, classname, node) {
        if (!label && !value) return null;
        var rowClass = 'form-group-no-margin';
        var row = $('<div class="' + rowClass + '"> </div>');
        var btnClass = '';
        if (isButton) {
            btnClass = 'col-btn';
        }
        var callback = function (e) {
            onclick && onclick(e, node);
        }
        if (value
            && typeof(value) != 'string' //还有可能是int类型
            && !(value instanceof Array)) { // 特别判断，可能不是key-value的那种方式，有可能是分隔符
            if (value.isTitle) {
                var size = 15 - label.length;
                var lbText = '';
                if (size > 0) {
                    for (var i = 0; i < size / 2; i++) {
                        lbText += '—';
                    }
                    ;
                }
                label = lbText + label + lbText;
                var labelNameClass = btnClass + '　col-sm-12 label-min label-inline-block ';
                var label_Name = $('<label style = "text-align:center" class="' + labelNameClass + '">' + label + '</label>');
                row.append(label_Name);
                return row;
            }
        }
        if (label) {
            label += ':';
        }
        var labelNameClass = 'col-sm-4 label-min label-inline-block';
        var label_Name = $('<label class="' + labelNameClass + '">' + label + '</label>');
        if (this.propertyPane.width() > 300) {
            label_Name.css('max-width', '100px');
        }
        row.append(label_Name);

        if (isGroup == undefined || isGroup == null) {
            isGroup = true;
        }
        var labelClass = 'contral-width label-inline-block';
        var label_Value = null;
        if (value instanceof Array && value.length > 0) {
            var div_Value = $('<div class = "col-sm-8 multi-label-value"></div>');
            if (this.propertyPane.width() > 300) {
                // div_Value.css('width',parseInt(this.propertyPane.width())-120);
            }
            if (!isGroup) {
                for (var i = 0; i < value.length; i++) {
                    var val = value[i];
                    if (val) {
                        var label_Value = $('<label class="' + labelClass + '">' + val + '</label>');
                        div_Value.append(label_Value);
                    }
                }
            } else {
                var step = 2;
                for (var i = 0; i < value.length; i += step) {
                    var val = value[i];
                    if (val) {
                        var val_0 = value[i];
                        var val_1 = value[i + 1];

                        var row_group = $('<div class = "row"></div>');
                        var row_div_0 = $('<div class = "col-xs-6 col-sm-6"></div>');
                        var row_div_1 = $('<div class = "col-xs-6 col-sm-6"></div>');
                        val_0 && row_group.append(row_div_0);
                        val_1 && row_group.append(row_div_1);
                        div_Value.append(row_group);

                        var col_v = $('<label class="' + labelClass + '">' + value[i] + '</label>');
                        row_div_0.append(col_v);

                        var col_v = $('<label class="' + labelClass + '">' + value[i + 1] + '</label>');
                        row_div_1.append(col_v);
                    }
                }
            }
            row.append(div_Value);
        } else {
            style = style || '';
            classname = classname || '';
            var hoverClass = '';
            if (!btnClass && callback) {
                // hoverClass = 'label_hover'; //remark 2016-12-29
            }
            ;
            label_Value = $('<label class=" ' + classname + btnClass + hoverClass + ' col-sm-8 label-value label-inline-block " style="' + style + '">' + value + '</label>');
            if (this.propertyPane.width() > 300) {
                // label_Value.css('width',parseInt(this.propertyPane.width())-120);
            }
            row.append(label_Value);
        }
        if (isButton && label_Value) {
            if (callback) {
                label_Value.click(callback);
            }
            if (mousemove) {
                label_Value.mousemove(mousemove);
            }
        } else {
            if (callback) {
                row.click(callback);
            }
            if (mousemove) {
                row.mousemove(mousemove);
            }
        }

        return row;
    },

    _createTableRow: function (values, i, callback, mousemove) {
        if (!values || values.length <= 0) return null;
        if (!(values instanceof Array)) {
            return;
        }
        var rowClass = 'form-group-no-margin';
        var count = Math.floor(12 / (values.length));
        if (count <= 0) return;
        if (i && i % 2 == 1) {
            rowClass = 'form-group-table-margin t-odd';
        } else {
            rowClass = 'form-group-table-margin';
        }

        var row = $('<div class="' + rowClass + '"> </div>');


        for (var j = 0; j < values.length; j++) {
            var val = values[j];
            if (val) {
                var text = val;
                var columnCount = count;
                if (val.c_width && parseInt(val.c_width)) {
                    columnCount = parseInt(val.c_width);
                }
//                if (val.text) { // 有可能确实为空哦
                if (val.text != undefined) {
                    text = val.text;
                }

                var labelNameClass = 'col-sm-' + columnCount + ' table-label-min label-inline-block';
                var label_Value = $('<label class="' + labelNameClass + '">' + text + '</label>');
                row.append(label_Value);
            }
        }

        if (callback) {
            row.click(callback);
        }
        if (mousemove) {
            row.mousemove(mousemove);
        }
        return row;
    },

    show: function (content, node, title, offset, showIndex) {
        if (offset) {
            this.propertyPane.css('left', 'auto');
            this.propertyPane.css('right', 'auto');
            this.propertyPane.css('top', 'auto');
            this.propertyPane.css('bottom', 'auto');
            if (offset.left != null && offset.left != undefined) {
                this.propertyPane.css('left', parseInt(offset.left) + 'px');
            }
            if (offset.right != null && offset.right != undefined) {
                if (this.propertyPane.parent() && this.propertyPane.parent().css('width')) {
                    var left = parseInt(this.propertyPane.parent().css('width')) - parseInt(this.propertyPane.css('width')) - offset.right;
                    this.propertyPane.css('left', left + 'px');
                } else {
                    this.propertyPane.css('right', parseInt(offset.right) + 'px');
                }
            }
            if (offset.bottom != null && offset.bottom != undefined) {
                if (this.propertyPane.parent() && this.propertyPane.parent().css('height')) {
                    var top = parseInt(this.propertyPane.parent().css('height')) - parseInt(this.propertyPane.css('height')) - offset.bottom;
                    this.propertyPane.css('top', top + 'px');
                } else {
                    this.propertyPane.css('bottom', parseInt(offset.bottom) + 'px');
                }
            }
            if (offset.top != null && offset.top != undefined) {
                this.propertyPane.css('top', parseInt(offset.top) + 'px');
            }
        }
        this.setData(content, node, title, showIndex);
        this.propertyPane.show();
        this.isvisible = true;
    },

    hide : function () {
        this.propertyPane.hide();
        this.clear(); //html也都是释放掉，html中可能有click，click中可能会引用node。2017-10-13
        this.isvisible = false;
    },

    /**
     * 显示tooltip
     * @param obj格式如下：
     * {
     * id:选则器的规则，如:'.menu ul li a'、'#maindivId'
     * selector,选择器处理后的item，如$('.menu ul li a')、$('#maindivId')
     * text:,tooltip的text，如果是用id选择器批量处理的话，那得是target上的rel
     * parent:,toolTip所在的panel
     * offsetY:,y方向上的偏移量
     * offsetX:x方向上的偏移量
     * }
     */
    showTooltip: function (obj) {
        if (!obj || !obj.parent) {
            return;
        }
        var offsetY = obj.offsetY ? obj.offsetY : 0, offsetX = obj.offsetX ? obj.offsetX : 0;
        if (obj.id) {
            $(obj.id).mouseover(
                function (e) {
                    var myTitle = e.target.rel;
                    var tooltip = $("<div id='tooltip' class='tap-tooltip-content it-shadow'>" + myTitle + "</div>");
                    obj.parent.append(tooltip);
                    var offsetTop = e.target.offsetTop - e.target.offsetHeight + offsetY;
                    var offsetLeft = e.target.offsetLeft + e.target.offsetWidth + offsetX;
                    tooltip.css('top', offsetTop);
                    tooltip.css('left', offsetLeft);
                }
            ).mouseout(
                function () {
                    $("#tooltip").remove();
                }
            );
        } else if (obj.selector) {
            if (!obj.text) {
                return;
            }
            obj.selector.mouseover(
                function (e) {
                    var tooltip = $("<div id='tooltip' class='tap-tooltip-content it-shadow'>" + obj.text + "</div>");
                    obj.parent.append(tooltip);
                    var offsetTop = e.target.offsetTop - e.target.offsetHeight + offsetY;
                    var offsetLeft = e.target.offsetLeft + e.target.offsetWidth + offsetX;
                    tooltip.css('top', offsetTop);
                    tooltip.css('left', offsetLeft);
                }
            ).mouseout(
                function () {
                    $("#tooltip").remove();
                }
            );
        }
    },

    setWidthForPropertyPane: function (width) { //setPanelWidth
        var width = width || "23%";
        this.propertyPane.css('width', width);
    },

    setHeightForPropertyPane: function (height) { //setPanelWHeight
        var height = height || "30%";
        this.propertyPane.css('height', height);
    }

});


it.PropertyManager = function (sceneManager,mainParentDiv) {
    this.sceneManager = null;
    this.dataManager = null;
    this.mainParentDiv = mainParentDiv;
    //注意：2D中也要用到，因此在切换的时候得切换parent,可是放到rootView上时，dialog的样式会受rootView的style的影响
    var parentDiv = mainParentDiv || (sceneManager != null && sceneManager.network3d !=null ? sceneManager.network3d.getRootView():null);
//    parentDiv.style.position = 'absolute'; // 要想孩子相对与父亲的话，父亲的position一定不能为空
    this.propertyPane = new it.PropertyPane(parentDiv);
    this.setSceneManager(sceneManager);
    this.getContentFunction = null; // 整个属性框的内容全部重新定义，注意格式，返回的是一个数值
    this.nodeDefaultInfoFunction = null; // node默认的基本信息
    this.mouseoverDevFunction = null; //鼠标划过设备时所要
    this.devClickFunction = null; //鼠标点击设备时，默认的是移动camera至设备
//    this.devHeaderFunction = null; //显示设备table的表头，注意格式，是一个数值，[{text:'abc'}]
//    this.devColumnFunciton = null; //设备table的每一行的内容，注意格式，同Header
    this.devListSortFunction = null;//设备table的排序

//    this.devTableRule['rack'] = [{header:'列1',width:'6',property:fun,},{header:'列2',..},..];
    this.devTableRule = {};
    this.dataInfoRule = {};
    this.statInfoRule = {};
    this.otherInfoRule = {}; //扩展的,放在后面的,可以是数组,也可以是一个对象。如：{'rack':[tab1,tab2],'equipment':{tab1}}
    this.preExtInfoRule = {}; //扩展的,但是是放在最前面的,可以是数组,也可以是一个对象
    this.width,this.height;
    this.defaultShowIndexFunction = null;
};

mono.extend(it.PropertyManager, Object, {

    /**
     * 此处的默认实现1，类似于机柜
     * @param rackTypes
     */
    setDefaultRackRule : function(rackTypes){
        if(!rackTypes || rackTypes.length < 1) return;
        if(!(rackTypes instanceof Array)){
            rackTypes = [rackTypes];
        }
        var self = this;
        var dataInfo = [
            {label:'资产编号',property:function(data){
                return data.getId();
            }},
            {label:'用户Id',property:'userId'},//默认的话在userMap中，否则则通过function自己去实现
            {label:'制造商',property:'制造商'}
        ];
        var devTable = [
            {header: '设备编号', width: '5',
                property: function (childData) {
                    return childData.getId();
                }},
            {header: '类型', width: 3,
                property: function (childData) {
                    var dataType = self.dataManager.getDataTypeForData(childData);
                    if(dataType && dataType.getDescription()){
                        return dataType.getDescription();
                    }
                    if (dataType && dataType.getModel()) {
                        return dataType.getModel();
                    }
                }
            },
            {header: '位置', width: 4,
                property: function (childData) {
                    var location = '';
                    var dataType = self.dataManager.getDataTypeForData(childData);
                    var sizeU = 1;
                    if (dataType
                        && dataType.getSize()
                        && dataType.getSize().ySize) {
                        sizeU = dataType.getSize().ySize;
                    }
                    if (childData.getLocation()
                        && childData.getLocation().y) {
                        location = childData.getLocation().y + 'U-' + (childData.getLocation().y + sizeU) + 'U(' + sizeU + 'U)';
                    }
                    return location;
                }}
        ];
        var statInfo = {
            value : function(data){
                var spManager = new it.SpaceManager(self.dataManager,self.sceneManager);
                var spObj = spManager.computeSpace(data);
                if(spObj && spObj instanceof it.Space1){
                    var empty_space_list = [];//['1U-2U(2U)','3U-5U(3U)','10U-12U(2U)'];
                    if(spObj._emptyList && spObj._emptyList.length > 0){
                        for(var i = 0 ;i < spObj._emptyList.length ; i++){
                            var empObj = spObj._emptyList[i];
                            empty_space_list.push(empObj.start+'U-'+empObj.end+'U('+empObj.total+'U)');
                        }
                    }
                    var emp_obj = {};
                    emp_obj.已用U数 =  spObj._occupation + 'U';
                    emp_obj.还剩U数 = (spObj._total - spObj._occupation) + 'U';
                    emp_obj.空余明细 = empty_space_list;
                    return emp_obj;
                }
            }
        };

        for(var i = 0 ; i <rackTypes.length ; i++){
            var type = rackTypes[i];
            if(type){
                this.dataInfoRule[type] = dataInfo;
                this.devTableRule[type] = devTable;
                this.statInfoRule[type] = statInfo;
            }
        }
    },

    /**
     * 这里是默认实现2，类似于设备的那种
     * @param equipTypes
     */
    setDefaultEquipmentRule : function(equipTypes){
        if(!equipTypes || equipTypes.length < 1){
            return;
        }
        if(!(equipTypes instanceof Array)){
            equipTypes = [equipTypes];
        }
        var self = this;
        var infoRule = [
            {label:'资产编号',property:function(data){
                return data.getId();
            }},
            { label:'尺寸',property:function(data){
                var dataType = self.dataManager.getDataTypeForData(data);
                var sizeU = 1;
                if (dataType
                    && dataType.getSize()
                    && dataType.getSize().ySize) {
                    sizeU = dataType.getSize().ySize;
                }
                return sizeU;
            }
            },
            {label:'制造商',property:'制造商'}
        ];
        for(var i = 0 ; i < equipTypes.length; i++){
            var type = equipTypes[i];
            if(type){
                this.dataInfoRule[type] = infoRule;
            }
        }
    },

    /**
     * 是否显示，默认的是返回true的
     */
    isShow : function(dataOrId){
        return true;
    },

    show : function(dataOrId,showIndex){
        if(!this.isShow(dataOrId)){
            return ;
        }
        if(!dataOrId){
            return ;
        }
        var data = null,link = null,dataNode = null;
        if(dataOrId instanceof it.Data){
            data = dataOrId;
        }else if(dataOrId instanceof it.Link){
            dataNode = this.sceneManager.getLinkNodeById(dataOrId);
        }else{
            data = this.dataManager.getDataById(dataOrId);
        }
        if(!dataNode){
            dataNode = this.sceneManager.getNodeByDataOrId(data);
        }
        var contents = this.getContentByNode(dataNode);
        var title = this.getTitleByNode(dataOrId);
        var offset = this.getOffset(dataNode);
        this.propertyPane.show({items:contents},dataNode,title,offset,showIndex);
    },

    showTabByIndex : function(index){
        this.propertyPane.showTabByIndex(index);
    },

    getDefaultShowIndex: function(data,node,content){
        if(this.defaultShowIndexFunction){
            return this.defaultShowIndexFunction(data,node,content);
        }
    },

    setSceneManager : function(sceneManager){
        if(!sceneManager) {
            return;
        }
        this.sceneManager = sceneManager;
        this.dataManager = sceneManager.dataManager;
        var defaultEventHandler = this.defaultEventHandler = sceneManager.viewManager3d.getDefaultEventHandler();
        if(defaultEventHandler){
            var self = this;
            var defaultAfterLookAtFun = defaultEventHandler.afterLookAtFunction;
            defaultEventHandler.afterLookAtFunction = function(node,cNode){
                if (defaultAfterLookAtFun) {
                    defaultAfterLookAtFun(node,cNode);
                }
                var itData = null;
                if (node instanceof it.Data) {
                      itData = node;
                    node = self.sceneManager.getNodeByDataOrId(node);
                }else{
                      itData = self.sceneManager.getNodeData(node);
                }
                var data = self.getContentByNode(node);
                if(data && data.length > 0 && self.isShow(data)){
                    var title = self.getTitleByNode(node);
                    var offset = self.getOffset(node);
                    var index = self.getDefaultShowIndex(itData,node,{items:data});
                    self.propertyPane.show({items:data},node,title,offset,index);
                }else{
                    self.propertyPane.hide();
                }
            }
        }
        // 2D的Network中显示属性框
        var eventHandel = new it.EventHandler();
        eventHandel.shouldHandleDoubleClickElement = function(){
            return true;
        };
        eventHandel.handleDoubleClickElement = function(node,network,data,element){
            var content = self.getContentByNode(node);
            if(content && content.length > 0){
                var title = self.getTitleByNode(data);
                var offset = self.getOffset(node);
                self.propertyPane.show({items:content},title,offset);
            }else{
                self.propertyPane.hide();
            }
        };
        this.sceneManager.addSceneChangeListener(function(e){
            self.propertyPane.hide(); // 场景切换时隐藏已有的。
        });
        if (this.sceneManager.viewManager2d) {
            this.sceneManager.viewManager2d.addEventHandler(eventHandel);
        }
    },
    
    setPropertyPaneSize : function(width,height){
        this.width = width;
        this.height = height;
    },

    getContentByNode : function(node){
        if (this.getContentFunction) {
            var obj = this.getContentFunction(node);
            if (!(obj instanceof Array)) {
                return [obj];
            } else {
                return obj;
            }
        }
        // remark by Kevin 2016-11-24 不用network的rootView了，用传过来的(如果有的话)
        if (!this.mainParentDiv) {
            var parentDiv = null;
            if (node instanceof twaver.Element) { //2D的network中
                parentDiv = this.sceneManager.network2d.getView();
            } else {
                parentDiv = this.sceneManager.network3d.getRootView();
            }
            if (parentDiv) {
                parentDiv.appendChild(this.propertyPane.propertyPane[0]);
            }
        }
        var link = this.sceneManager.getLinkData(node);
        if (link && (link instanceof it.Link)) {
            this.propertyPane.setWidthForPropertyPane('30%');
            return  this.createDefaultLinkContent(node);
        } else {
            if (this.width && parseInt(this.width)){
                this.propertyPane.setWidthForPropertyPane(parseInt(this.width) + 'px');
            }
            if (this.height &&　parseInt(this.height)) {
                this.propertyPane.setHeightForPropertyPane(parseInt(this.height) + 'px');
            }
            // this.propertyPane.setWidthForPropertyPane();
            return this.createDefaultDataContent(node);
        }
    },

    /**
     * 根据node创建属性框的title
     * @param nodeOrData
     * @returns {string}
     */
    getTitleByNode : function(nodeOrData){
        var id = '';
        if(!nodeOrData){
            return '';
        }
        if(nodeOrData instanceof it.Data){
            id = ':' + nodeOrData.getId();
        }else if(this.sceneManager && this.sceneManager.getNodeData(nodeOrData)){
            id = ':' + this.sceneManager.getNodeData(nodeOrData).getId();
        }
        return '资产编号' + id;
    },

    getOffset:function(nodeOrData){
        return {left:100,top:100};
    },

    /**
     * 属性框中内容的默认实现
     * 对于通道和机柜，它们有孩子，还得支持排序
     * tab1：基本信息；
     * tab2：设备信息；
     * tab3：统计
     * @param node
     */
    createDefaultDataContent : function(node){
        var preExtInfo = this.getPreExtInfo(node);
        var generalInfo = this.getGeneralInfo(node);
        var devInfo = this.getDevListInfo(node);
        var statInfo = this.getStatInfo(node);
        var others = this.getOthers(node);
        var content = [];
        if (preExtInfo) {
            if(preExtInfo instanceof Array){
                for(var i = 0 ; i < preExtInfo.length ; i++){
                    content.push(preExtInfo[i]);
                }
            }else{
                content.push(preExtInfo);
            }
        }
        if(generalInfo){
            content.push(generalInfo);
        }
        if(devInfo){
            content.push(devInfo);
        }
        if(statInfo){
            content.push(statInfo);
        }
        if(others){
            if(others instanceof Array){
                for(var i = 0 ; i < others.length ; i++){
                    content.push(others[i]);
                }
            }else{
                content.push(others);
            }
        }
        return content;
    },

    /**
     * 创建Link的属性框的显示内容
     * @param linkOrId
     * @returns {null}
     */
    createDefaultLinkContent : function(linkOrId){
        var link = null;
        if(linkOrId instanceof it.Link){
            link = linkOrId;
        }else if(linkOrId instanceof mono.Element){
            link = this.sceneManager.getLinkData(linkOrId);
        }else{
            link = this.dataManager.getLinkById(linkOrId);
        }
        if(!link){
            return null;
        }
        var fromId = link.getFromId(),toId = link.getToId();
        var fromDataType = this.dataManager.getDataTypeForData(fromId);
        var toDataType = this.dataManager.getDataTypeForData(toId);
        var fTypeDesc = fromDataType?fromDataType.getDescription():'';
        var tTypeDesc = toDataType?toDataType.getDescription():'';
        var content = {};
        content.线袋编号 = link.getName();
        content.线袋类型 = link.getType();
        content.A = fromId || '';
        content.A端口编号 = link.getFromPortId();
        content.B = toId || '';
        content.B端口编号 = link.getToPortId();
        content.连接设备1 = "设备编号:"+(fromId || '')+"  设备类型:"+fTypeDesc + ' 端口编号:' + link.getFromPortId();
        content.连接设备2 = "设备编号:"+(toId || '')+"  设备类型:"+tTypeDesc + ' 端口编号:' + link.getToPortId();
        var baseInfo = {title: '线袋信息',
            properties: content,
            className:'it-property-basic',
            onclick: function (e) {
            }
        };

        var labelInfo = {
            title:'标签',
            properties:null,
            className:'it-property-equip',
        }
        return [baseInfo,labelInfo];
    },

    /**
     * 根据rule创建基本信息
     * @param node
     * @returns {*}
     */
    getGeneralInfo: function(node) {
        if (!node) return null;
        var data = node.getClient(it.SceneManager.CLIENT_IT_DATA);
        // if (!data) return null;
        var content = null;
        var dataType = this.dataManager.getDataTypeForData(data);
        if (dataType && dataType.getCategoryId()) {
            var ruleInfo = this.dataInfoRule[dataType.getCategoryId()]; //dataType.getModel() dataType.getId()
            if (ruleInfo && ruleInfo.length > 0) {
                for (var i = 0; i < ruleInfo.length; i++) {
                    var rule = ruleInfo[i];
                    if (rule) {
                        var label = rule.label;
                        var value = '';
                        if (rule.property) {
                            if (typeof(rule.property) == 'function') {
                                value = rule.property(data);
                            } else {
                                value = data.getUserData(rule.property);
                            }
                        }
                        var isButton = false;
                        if (rule.isButton) {
                            if (typeof(rule.isButton) == 'function') {
                                isButton = rule.isButton(data);
                            }else{
                                isButton = rule.isButton;
                            }
                        }
                        var style = '';
                        if (rule.style) {
                            if (typeof(rule.style) == 'function') {
                                style = rule.style(data);
                            }else{
                                style = rule.style;
                            }
                        }
                        var classname = rule.classname;
                        var onclick = rule.onclick;
                        if (!content) {
                            content = {};
                        }
                        // content[label] = value || '';
                         content[label] = {value:value||'',isButton:isButton,style:style,onclick:onclick,classname:classname,origin:rule.origin}; //update 2016-12-29 是更丰富
                    }
                }
            }
        }
        if (!content && this.nodeDefaultInfoFunction && this.nodeDefaultInfoFunction(node)) {
            content = this.nodeDefaultInfoFunction(node);
        }
        if (!content) {
            return null;
        }
        var obj = {
            title: '基本',
            properties: content,
            className: 'it-property-basic',
            onclick: function(e) {}
        };
        return obj;
    },

    /**
     * 孩子列表的默认实现
     * 1、对于机柜的孩子和通道的孩子所显示的信息不太一样；
     * 2、支持排序；
     * 3、支持点击；
     * @param node
     * @returns {null}
     */
    getDevListInfo : function(node){
        if(!node || !this.dataManager) return null;
        var data = node.getClient(it.SceneManager.CLIENT_IT_DATA);
        if(!data) return null;
        var children = data.getChildren();//this.dataManager.getChildren(data);
        var devList = [];
        var dataType = this.dataManager.getDataTypeForData(data);
        if(!dataType || !dataType.getCategoryId()) return null;
        var ruleInfo = this.devTableRule[dataType.getCategoryId()]; //dataType.getModel() dataType.getId()
        if(!ruleInfo) return null;
        devList.title = this.createTableHeaderByRuleInfo(ruleInfo);
        if(children && children.size() > 0){
            var self = this;
            children.forEach(function(child){
                if(!child) return;
                var conlumns = self.createTableRowByRuleInfo(ruleInfo,child);
                var devInfo = {
                    values:conlumns, //列的值
                    callback:function(){
                        if(self.devClickFunction){
                            return self.devClickFunction(child);
                        }
                        if(self.defaultEventHandler && self.sceneManager){
                            var childNode = self.sceneManager.dataNodeMap[child.getId()];
                            if(childNode){
                                self.defaultEventHandler.lookAt(childNode);
                            }
                        }
                    },
                    mousemove:function(){
                        if(self.mouseoverDevFunction){
                            self.mouseoverDevFunction(child);
                        }
                    }
                };
                devList.push(devInfo);
            });
        }
        if(this.devListSortFunction){
            var self = this;
            devList.sort(function(a,b){
                return self.devListSortFunction(a,b);
            });
        }
        var obj = {
            title: '设备列表',
            properties:devList,
            className:'it-property-equip'
        };
        return obj;
    },


    /**
     * 列表的头信息
     * c_width的总和不能大于12
     * @param node
     * @returns {{c_width: number, text: string}[]}
     */
    createTableHeaderByRuleInfo : function(ruleInfo){
        var heads = [];
        if(ruleInfo && ruleInfo instanceof Array){
            for(var i = 0 ; i< ruleInfo.length ; i++){
                var columnInfo = ruleInfo[i];
                if(columnInfo){
                    var obj = {};
                    if(columnInfo.width){
                        obj.c_width = columnInfo.width;
                    }
                    if(columnInfo.header){
                        obj.text = columnInfo.header;
                    }
                    heads.push(obj);
                }
            }
        }
        return heads;
//        return [{c_width:6,text:'设备编号'},{c_width:3,text:'类型'},{c_width:3,text:'位置'}];
    },

    /**
     * 根据childData创建以行数据
     * @param childData
     * @returns {*}
     */
    createTableRowByRuleInfo : function(ruleInfo,childData){
        if(!childData) return null;

        var columns = [];
        if(ruleInfo && ruleInfo instanceof Array){
            for(var i = 0 ; i < ruleInfo.length ; i++){
                var columnInfo = ruleInfo[i];
                if(columnInfo){
                    var col = {};
                    if(columnInfo.width){
                        col.c_width = columnInfo.width;
                    }
                    if(columnInfo.property){
                        if(typeof(columnInfo.property) == 'function'){
                            col.text = columnInfo.property(childData);
                        }
                    }
                    columns.push(col);
                }
            }
        }
        return columns;
    },

    /**
     * 统计信息
     * @param node
     */
    getStatInfo : function(node){
        if(!node) return null;
        var data = node.getClient(it.SceneManager.CLIENT_IT_DATA);
        if(!data) return null;
        var dataType = this.dataManager.getDataTypeForData(data);
        if(!dataType || !dataType.getCategoryId()) return null;
        var ruleInfo = this.statInfoRule[dataType.getCategoryId()]; //dataType.getId() dataType.getModel()
        var emp_obj = null;
        if(ruleInfo && ruleInfo.value){
            if(typeof(ruleInfo.value) == 'function'){
                 emp_obj = ruleInfo.value(data);
            }else{
                emp_obj = ruleInfo.value;
            }
        }
        if(emp_obj){
            var obj = {
                title: '统计',
                properties: emp_obj,
                isGrop: false,
                className: 'it-property-chart'
            };
            return obj;
        }
    },

    getPreExtInfo : function(node){
        // if(this.getPreExtInfoFunction){ //add到标准的tab前
        //     var preExtInfoResult = this.getPreExtInfoFunction(node);
        //     if (preExtInfoResult != undefined) {
        //         return preExtInfoResult;
        //     }
        // }
        if(!node) return null;
        var data = node.getClient(it.SceneManager.CLIENT_IT_DATA);
        if(!data) return null;
        var result = [];
        var dataType = this.dataManager.getDataTypeForData(data);
        if(dataType && dataType.getCategoryId()) {
            var preExtInfoRule = this.preExtInfoRule[dataType.getCategoryId()];
            if (preExtInfoRule) {
                if (preExtInfoRule instanceof Array) {
                    result = preExtInfoRule;
                }else{
                    result.push(preExtInfoRule);
                }
            }
        }
        if(this.getPreExtInfoFunction){ //add到标准的tab前
            var preExtInfoResult = this.getPreExtInfoFunction(node);
            if (preExtInfoResult) {
                if (preExtInfoResult instanceof Array) {
                    for (var i = 0; i < preExtInfoResult.length; i++) {
                        result.push(preExtInfoResult[i]);
                    }
                }else{
                    result.push(preExtInfoResult);
                }
            }
        }
        return result;
    },

    /**
     * 扩展的
     * @param node
     */
    getOthers: function(node) {
        if (!node) return null;
        var data = node.getClient(it.SceneManager.CLIENT_IT_DATA);
        if (!data) return null;
        var result = [];
        var dataType = this.dataManager.getDataTypeForData(data);
        if (dataType && dataType.getCategoryId()) {
            var otherInfoRule = this.otherInfoRule[dataType.getCategoryId()];
            if (otherInfoRule) {
                if (otherInfoRule instanceof Array) {
                    result = otherInfoRule;
                } else {
                    result.push(otherInfoRule);
                }
            }
        }
        if (this.getExtInfoFunction) { // add到标准的tab后面
            var extInfoResult = this.getExtInfoFunction(node);
            if (extInfoResult) {
                if (extInfoResult instanceof Array) {
                    for (var i = 0; i < extInfoResult.length; i++) {
                        result.push(extInfoResult[i]);
                    }
                } else {
                    result.push(extInfoResult);
                }
            }
        }
        return result;
    }


});

//结合it.Size 用父亲的尺寸来规划孩子的位置。
// xSize 表示的是规划的最小的单位的个数，比如U数，比如把地板分成多少多少格子
var $Size = function (parameters) {
   parameters = parameters || {};
   this.xSize = parameters.x ;
   this.ySize = parameters.y ;
   this.zSize = parameters.z ;

   this.xPadding = parameters.xPadding || [0,0];
   this.yPadding = parameters.yPadding || [0,0];
   this.zPadding = parameters.zPadding || [0,0];

   this.xGap = 0;
   this.yGap = 0;
   this.zGap = 0;
};
mono.extend($Size,Object,{
    __accessor : ['xSize','ySize','zSize','xPadding','yPadding','zPadding'],
     
    parse : function(){ //
       
    }, 
});

it.Size =  $Size;
// 位置管理
// x,y,z 分别表示3个方位的布局： 
// x,y,z 支持数字，其中有一些特殊的数字，表示所在位置，而一些特殊的位置，表示对齐，比如设备放在机柜里面，y 按照数字 U数布局；
// x,z 的和父亲对齐，对齐方式 参考 it.Location.Align;
var $Location = function (parameters) {
  this.parse(parameters);

};
it.Location = $Location;

var $Align = it.Location.Align = {};
$Align.pos_neg = -1;
$Align.center_neg = -2;
$Align.neg_neg = -3;
$Align.center = -4;
$Align.pos_pos = -5;
$Align.center_pos = -6;
$Align.neg_pos = -7;

mono.extend($Location,Object,{

    set : function(key,value){
        var result = value;
        if(typeof value === "string"){// pos_neg 之类的
            result = it.Location.Align[value];
            if(!result){
                result = value;
            }
        }
        this[key] = result;
    },

	setX: function(x){
        this.set('x',x);
	},

	setY : function(y){
       this.set('y',y);
	},

	setZ : function(z){
       this.set('z',z);
	},

  getX : function () {
    return this.x;
  },

  getY : function () {
    return this.y;
  },

  getZ : function () {
    return this.z;
  },

  parse : function(parameters){
    if(!parameters){
      return;
    }
    // if(parameters instanceof it.Location){
    //     this.x = parameters.x;
    //     this.y = parameters.y;
    //     this.z = parameters.z;
    //     return;
    // }
    if(it.defaultLocatonParser){
       var loc = it.defaultLocatonParser.parse(parameters);
       if(loc == null || !(loc instanceof it.Location)){
          throw 'it.defaultLocatonParser.parse() does not return a it.Location';
       }else{
          this.location = loc;
       }
       this.x = loc.x;
       this.y = loc.y;
       this.z = loc.z;
    }else{
       throw 'it.defaultLocatonParser is null'; 
    }
  },

});
$Location.getAlignName  = function(value){
   for(var name in $Align){
       if($Align[name] === value){
          return name;
       }
   }
};
// 解析表达式 生成Location
it.LocationParser = function () {
};

mono.extend(it.LocationParser,Object,{
    parse : function(source){ // parse source(maybe json,maybe text) to it.Location
      return null;
    },
});

it.DefaultLocatonParser = function(){
   it.LocationParser.call(this);
};

mono.extend(it.DefaultLocatonParser,it.LocationParser,{
   parse : function(source){
   	  var l = new it.Location();
      if(source instanceof it.Location){
          l.x = source.x;
          l.y = source.y;
          l.z = source.z;
      }else if(source.x !== undefined || source.y !== undefined || source.z !== undefined){
         l.setX(source.x);
         l.setY(source.y);
         l.setZ(source.z);
      }else if(typeof source ==='string'){
        l = this.parseText(source);
      }
      return l;
   },

   parseText : function(source){
       var source = JSON.parse(source);
       if(!source) return null;
       if(source.x !== undefined || source.y !== undefined || source.z !== undefined){
           var l = new it.Location();
           l.setX(source.x);
           l.setY(source.y);
           l.setZ(source.z);
           return l;
       }
       return null;
   },

   charToNum : function(c){ // a == 1,A === 1
	    if(c && c.toUpperCase && c.length){
	    	c = c.toUpperCase();
	    	return c.chartCodeAt(0) - 96;
	    }
	},
});

it.defaultLocatonParser = new it.DefaultLocatonParser;
var $LocationManager = function (sceneManager) {
    this.sceneManager = sceneManager;
    this.dataManager = sceneManager.dataManager;
    this._positionFunctionMap = {};
    this._rotationFunctionMap = {};
};

mono.extend($LocationManager,Object,{

     registerPositionFunction : function(categoryId,pCategoryId,func){
        var key = pCategoryId + "&" + categoryId;
        this._positionFunctionMap[key] = func;
     },

     registerRotationFunction : function(categoryId,pCategoryId,func){
        var key = pCategoryId + "&" + categoryId;
        this._rotationFunctionMap[key] = func;
     },

     /**
      *  根据相关信息计算dataNode的位置，这里加了pbb，因为考虑到父类对象可能是复杂模型
      */
     _computePosition : function(data,parentData,node,parentNode,pbb){
         var dm = this.dataManager;
         // var category = dm.getCategoryForData(data);
         // var pCategory = dm.getCategoryForData(parentData);
         // var categoryId = category ? category.getId() : "";
         // var pCategoryId = pCategory ? pCategory.getId() : "";
         // var map = this._positionFunctionMap;
          var location = data.getLocation();
             var dataType = dm.getDataTypeForData(data);
             var parentDataType = dm.getDataTypeForData(parentData);
             var parentCategory = this.dataManager.getCategoryForDataType(parentDataType);
             var size = dataType.getSize();
             var pSize = parentDataType.getChildrenSize() || new it.Size();
             var bb = node.getBoundingBox();
             if (!bb.size() || (!bb.size().x && !bb.size().y && !bb.size().z)) {
                bb = it.Util.getBoundingBox(node);
             }
             var pbb = pbb || parentNode.getBoundingBox();
             var positionExp = dataType.getPositionExp()||{};
             var x = location.getX();
             var y = location.getY();
             var z = location.getZ();
                 var datas = {x:x,y:y,z:z,dataType:dataType,
                     parentDataType:parentDataType,
                     parentCategory : parentCategory,
                     data:data,parentData:parentData,
                     bb:bb,pbb:pbb};
                 if(positionExp.x){
//                 x = eval(positionExp.x);
                     var fun = new Function("x","y","z","data","return " + positionExp.x);
                     x = fun.call(this,x,y,z,datas)||x;
                 }
                 if(positionExp.z){
//                 z = eval(positionExp.z);
                     var fun = new Function("x","y","z","data","return " + positionExp.z);
                     z = fun.call(this,x,y,z,datas)||z;
                 }
                 if(positionExp.y){
//                 y = eval(positionExp.y);
                     var fun = new Function("x","y","z","data","return " + positionExp.y);
                     y = fun.call(this,x,y,z,datas)||y;
                 }

             var px = this._computeOneAxisPosition('x',x,size.getXSize(),pSize.getXSize(),pSize.getXPadding(),bb,pbb) || data.getPosition().x;
             var pz = this._computeOneAxisPosition('z',z,size.getZSize(),pSize.getZSize(),pSize.getZPadding(),bb,pbb) || data.getPosition().z;

             var locationY = location.getY();
             var floor = null;
             if(this._isAlignment(locationY)){
                 floor = this._findFloor(parentNode);
                 pbb = floor.getBoundingBox();
             }
             var py = this._computeOneAxisPosition('y',y,size.getYSize(),pSize.getYSize(),pSize.getYPadding(),bb,pbb) || data.getPosition().y;
             var position = new mono.Vec3(px,py,pz);
             node.p(position);
     },

     /**
      * 注意：如果node是billboard的情况，这时没有boundingBox
     **/
     computePosition : function(data,parentData,node,parentNode){
         var dm = this.dataManager;
         var category = dm.getCategoryForData(data);
         var pCategory = dm.getCategoryForData(parentData);
         var categoryId = category ? category.getId() : "";
         var pCategoryId = pCategory ? pCategory.getId() : "";
         var map = this._positionFunctionMap;
         var self = this;
         var func = map[pCategoryId + "&" + categoryId];
         if(func){
            var flag =  func(data,parentData,node,parentNode);
            if(flag !== false){
               return;
            }
         }       
         if(!parentData){
            node.p(data.getPosition());
            return;
         }
         var location = data.getLocation();
         if(!location){
            node.p(data.getPosition());
            return;
         }
         if(node instanceof mono.Billboard){
            node.p(data.getPosition());
            return;
         }
         if (!parentNode) {
            node.p(data.getPosition());
            return;
         }
         if (parentNode) {
            //如果node存在复杂对象的话，那计算该对象的孩子时，则要以复杂对象的信息来计算,注意complexParentNode可能是unload
             var complexParentNode = parentNode.getClient('complexNode'); 
             if (complexParentNode) {
                if (complexParentNode == 'unload') {
                    this.sceneManager.loadComplexNode(parentData,function(comNode){
                        var pbb = comNode.getBoundingBox();
                        if (!pbb.size() || (!pbb.size().x && !pbb.size().y && !pbb.size().z)) {
                            pbb = it.Util.getBoundingBox(comNode);
                        }
                        self._computePosition(data,parentData,node,parentNode,pbb);
                    });
                }else {
                    pbb = complexParentNode.getBoundingBox();
                    if (!pbb.size() || (!pbb.size().x && !pbb.size().y && !pbb.size().z)) {
                       pbb = it.Util.getBoundingBox(complexParentNode);
                    }
                    self._computePosition(data,parentData,node,parentNode,pbb);
                }
             }else{
                var  pbb = parentNode.getBoundingBox();
                if (!pbb.size() || (!pbb.size().x && !pbb.size().y && !pbb.size().z)) {
                   pbb = it.Util.getBoundingBox(parentNode);
                }
                self._computePosition(data,parentData,node,parentNode,pbb);
             }
         }
         /*
         if(parentNode){ // 2D 到 3D时 parentNode为null
             var dataType = dm.getDataTypeForData(data);
             var parentDataType = dm.getDataTypeForData(parentData);
             var parentCategory = this.dataManager.getCategoryForDataType(parentDataType);
             var size = dataType.getSize();
             var pSize = parentDataType.getChildrenSize() || new it.Size();
             var bb = node.getBoundingBox();
             if (!bb.size() || (!bb.size().x && !bb.size().y && !bb.size().z)) {
                bb = it.Util.getBoundingBox(node);
             }
             var pbb = parentNode.getBoundingBox();
             if (!pbb.size() || (!pbb.size().x && !pbb.size().y && !pbb.size().z)) {
                pbb = it.Util.getBoundingBox(parentNode);
             }
             var positionExp = dataType.getPositionExp()||{};
             var x = location.getX();
             var y = location.getY();
             var z = location.getZ();
                 var datas = {x:x,y:y,z:z,dataType:dataType,
                     parentDataType:parentDataType,
                     parentCategory : parentCategory,
                     data:data,parentData:parentData,
                     bb:bb,pbb:pbb};
                 if(positionExp.x){
//                 x = eval(positionExp.x);
                     var fun = new Function("x","y","z","data","return " + positionExp.x);
                     x = fun.call(this,x,y,z,datas)||x;
                 }
                 if(positionExp.z){
//                 z = eval(positionExp.z);
                     var fun = new Function("x","y","z","data","return " + positionExp.z);
                     z = fun.call(this,x,y,z,datas)||z;
                 }
                 if(positionExp.y){
//                 y = eval(positionExp.y);
                     var fun = new Function("x","y","z","data","return " + positionExp.y);
                     y = fun.call(this,x,y,z,datas)||y;
                 }

             var px = this._computeOneAxisPosition('x',x,size.getXSize(),pSize.getXSize(),pSize.getXPadding(),bb,pbb) || data.getPosition().x;
             var pz = this._computeOneAxisPosition('z',z,size.getZSize(),pSize.getZSize(),pSize.getZPadding(),bb,pbb) || data.getPosition().z;

             var locationY = location.getY();
             var floor = null;
             if(this._isAlignment(locationY)){
                 floor = this._findFloor(parentNode);
                 pbb = floor.getBoundingBox();
             }
             var py = this._computeOneAxisPosition('y',y,size.getYSize(),pSize.getYSize(),pSize.getYPadding(),bb,pbb) || data.getPosition().y;
             var position = new mono.Vec3(px,py,pz);
             node.p(position);
        }
        */
     },

     _findFloor : function (node) { //TODO 对于房间，需要计算地板
        return node;
     },

     _computeOneAxisPosition : function(axis,locationAxis,sizeAxis,pSizeAxis,paddingAxis,bb,pbb){
         locationAxis = parseFloat(locationAxis);
         if(Number.isNaN(locationAxis)){
            return null;
         }
         if(pSizeAxis && !this._isAlignment(locationAxis)){
            paddingAxis = paddingAxis || [0,0];
            var totolLength = pbb.max[axis] - pbb.min[axis] - parseFloat(paddingAxis[0]) - parseFloat(paddingAxis[1]);
            var unit = totolLength / pSizeAxis;
            return pbb.min[axis] - bb.min[axis] + unit * (locationAxis - 1) + parseFloat(paddingAxis[0]);// TODO 
         }else {
            if(this._isAlignment(locationAxis)){
               return this._getAlignPosition(bb,pbb,locationAxis,paddingAxis,axis);
            }
         }
     },

     _isAlignment : function (locationAxis) {
         return !!it.Location.getAlignName(locationAxis);
     },

     _getAlignPosition : function(bb,pbb,align,paddingAxis,axis){
        if(align === $Align.pos_neg){
          return pbb.min[axis] - bb.max[axis] + paddingAxis[0];
        }else if(align === $Align.center_neg){
          return pbb.min[axis];
        }else if(align === $Align.neg_neg){
          return pbb.min[axis] - bb.min[axis] + paddingAxis[0];
        }else if(align === $Align.center){
          return pbb.center()[axis];
        }else if(align === $Align.pos_pos){
          return pbb.max[axis] - bb.max[axis] - paddingAxis[1];
        }else if(align === $Align.center_pos){
          return pbb.max[axis];
        }else if(align === $Align.neg_pos){
          return pbb.max[axis] - bb.min[axis] - paddingAxis[1];
        }
     },

    isNull : function(value){
        if(value==undefined){
            return true;
        }
        if(typeof(value) == 'string' && value.trim() == ""){
            return true;
        }
        return false;
    },

    /**
     * 将角度换算成弧度
     * 注意：sdk中认为外面输入的都是角度制
     * @param rotation
     */
    translateRotation : function(rotation){
        if(!rotation){
            return rotation;
        }
        var rot = new mono.Vec3();
        if(rotation.x){
            rot.setX(Math.PI*rotation.x/180);
        }else{
            rot.setX(rotation.x);
        }
        if(rotation.y){
            rot.setY(Math.PI*rotation.y/180);
        }else{
            rot.setY(rotation.y);
        }
        if(rotation.z){
            rot.setZ(Math.PI*rotation.z/180);
        }else{
            rot.setZ(rotation.z);
        }
        return rot;
    },

     computeRotation : function(data,parentData,node,parentNode){
         var dm = this.dataManager;
         var location = data.getLocation();
         var dataType = dm.getDataTypeForData(data);
         var rotationExp = dataType.getRotationExp();
         var rotation = this.translateRotation(data.getRotation());
         node.setRotation(new mono.Vec3());  //先清空 add By Kevin 2017-07-11
         if(rotation && (!this.isNull(rotation.x)
             || !this.isNull(rotation.y)
             || !this.isNull(rotation.z))){
             node.setRotation(rotation);
             return;
         }
         if(!location || !rotationExp){
             return ;
         }
         var x = location.getX(),y = location.getY(),z = location.getZ();
         var scriptData = {x : x ,y : y ,z : z,data:data,dataType:dataType,parentData:parentData,location:location};
         var position = data.getPosition();
         var px = position.x,py = position.y,pz = position.z;
         var rx ,ry ,rz ;
         if(rotationExp.x){
//           rx = eval('witch'rotationExp.x);
             var func = new Function("x","y","z","data","return " + rotationExp.x);
             rx = func.call(this,x,y,z,scriptData)||0;
         }

         if(rotationExp.y){
//            ry = eval(rotationExp.y);
             var func = new Function("x","y","z","data","return " + rotationExp.y);
             ry = func.call(this,x,y,z,scriptData)||0;
         }
         if(rotationExp.z){
//            rz = eval(rotationExp.z);
             var func = new Function("x","y","z","data","return " + rotationExp.z);
             rz = func.call(this,x,y,z,scriptData)||0;
         }
         // node.setRotation(rx,ry,rz);
         if (rx != undefined && rx != null) {
            node.setRotationX(rx);
         }
         if (ry != undefined && ry != null) {
            node.setRotationY(ry);
         }
         if (rz != undefined && rz != null) {
            node.setRotationZ(rz);
         }
     },
});

it.LocationManager = $LocationManager;
it.Space1 = function (spaceArray,axis) {
   this._spaceArray = spaceArray || [];
   this._axis = axis;
   this.init();
   this.compute();
};

mono.extend(it.Space1,Object,{
	setSpaceArray : function(spaceArray){
		this._spaceArray = spaceArray;
		this.init();
		this.compute();
	},
    getSpaceArray : function(){
       return this._spaceArray;
    },

    getTotal : function(){
    	return this._total;
    },

    getPercent : function(){
    	return this._percent;
    },

    getOccupation : function(){
    	return this._occupation;
    },

    getOccupationList : function(){
    	return this._occupationList;
    },

    getEmptyList : function(){
    	return this._emptyList;
    },

    getAxis : function(){
    	return this._axis;
    },

    isAvailableAt : function(location,size){
       if(location < 1 && location > this._total){
         return false;
       }
       size = size || 1;
       var start = location,end = location + size - 1;
       if(end  > this._total){
         return false;
       }
       
       var i = 0,len = this._occupationList.length,occupation;
       for(;i < len;i ++){
           occupation = this._occupationList[i];
           if( (start >= occupation.start && start <= occupation.end) || (end >= occupation.start && end <= occupation.end) ){
             return false;
           }
       }
       return true;
    },

    isValid : function(){
    	return this._total > 0;
    },

    _addStatistic : function(unit,statistic,end){
       if(unit === 1 || unit === 0){
            statistic.end = end;
            if(statistic.occupation){
    	 	this._occupationList.push(statistic);
    	 	}else{
    	 		this._emptyList.push(statistic);
    	 	}
    	 	statistic.total = statistic.end - statistic.start + 1;
    	 	delete statistic.occupation;
        }
    },

    getCountForSize : function(size){
        var count = 0;
        for(var i = 0;i < this._emptyList.length;i ++){
        	var statistic = this._emptyList[i];
        	count += parseInt(statistic.total / size);
        }
        return count;
    },

    init : function(){
       this._total = 0;
	   this._percent = 0;
	   this._occupation = 0;
	   this._occupationList = [];
	   this._emptyList = [];
    },

    compute : function(){
    	var spaceArray = this._spaceArray,len = spaceArray.length,lastUnit = null,statistic;
    	this._total = len;
        for(var i = 0;i < len;i ++){
            var unit = spaceArray[i];
            if(unit == 1){
               this._occupation ++;
            }
            if(i == 0 || lastUnit != unit){
            	 this._addStatistic(lastUnit,statistic,i);
            	 statistic = {start : i + 1,occupation : unit};
            }
            lastUnit = unit;
            if(i == len - 1){
         	   this._addStatistic(lastUnit,statistic,i + 1);  
            }
        }
        if(this._total > 0){
        	this._percent = this._occupation / this._total;
        }
    },
})
it.Space2 = function (spaceArray,axis,mainAxis) {
	this._spaceArray = spaceArray || [[]]; // spaceArray 是一个it.Space1的数组
	this._axis = axis;
	this._mainAxis = mainAxis;

    this.init();
    this.compute();
};

mono.extend(it.Space2,Object,{
    setSpaceArray : function(spaceArray){
		this._spaceArray = spaceArray;
		this.init();
		this.compute();
	},
    getSpaceArray : function(){
       return this._spaceArray;
    },

    getAxis : function(){
    	return this._axis;
    },

    getMainAxis : function(){
    	return this._mainAxis;
    },

    init : function(){
       this._total = 0;
	   this._percent = 0;
	   this._occupation = 0;
	   // this._occupationList = []; 
	   // this._emptyList = [];
    },

    compute : function(){
    	var i = 0,len = this._spaceArray.length,space1;
    	for(;i < len;i ++){
           space1 = this._spaceArray[i];
           this._total += space1.getTotal();
           this._occupation += space1.getOccupation();
    	}

    	if(this._total > 0){
    		this._percent = this._occupation / this._total;
    	}
    },

    getCountForSize : function(size){
        var i = 0,len = this._spaceArray.length,space1,count = 0;
        for(;i < len;i ++){
            space1 = this._spaceArray[i];
        	count += space1.getCountForSize(size);
        }
        return count;
    },
});

// 空间计算
var $SpaceManager = function (dataManager, sceneManager) {
    this.dataManager = dataManager;
    this.sceneManager = sceneManager;
    this.nodeMap = {};
    this.spaceNodeColorFunction = null;
    this.spaceNodeFrameColorFunction = null;
    this.spaceVisibleFilter = new it.SpaceVisibleFilter(sceneManager, this); //用来管理想alarmBillboard这样的对象的隐藏显示
    this.spaceMaterialFilter = new it.SpaceMaterialFilter(sceneManager, this);
    this.spaceAdapter = new $SpaceAdapter(sceneManager, this);
};

mono.extend($SpaceManager, Object, {
    _initArray: function (length, initValue) {
        initValue = initValue || 0;
        var array = [];
        for (var i = 0; i < length; i++) {
            array.push(initValue);
        }
        return array;
    },
    _initArray2: function (length, length2, initValue) {
        initValue = initValue || 0;
        var array = [];
        for (var i = 0; i < length; i++) {
            var subArray = [];
            for (var j = 0; j < length2; j++) {
                subArray.push(0);
            }
            array.push(subArray);
        }
        return array;
    },

    initSpaceArray: function (xSize, ySize, zSize) {

    },

    computeSpace: function (data, mainAxis) {
        var dm = this.dataManager;
        var dataType = dm.getDataTypeForData(data);
        var size = dataType.getChildrenSize();
        var children = data.getChildren(), child;//dm.getChildren(data),child;

        var xSize = size.getXSize();
        var ySize = size.getYSize();
        var zSize = size.getZSize();

        var dimension = 0, sizeArray = [], axis = "", notMainAxis = "";
        if (xSize) {
            dimension++;
            sizeArray.push({ axis: "x", size: xSize });
            axis += "x";
            if (axis !== mainAxis) {
                notMainAxis = "x";
            }
        }
        if (ySize) {
            dimension++;
            sizeArray.push({ axis: "y", size: ySize });
            axis += "y";
            if (axis !== mainAxis) {
                notMainAxis = "y";
            }
        }
        if (zSize) {
            dimension++;
            axis += "z";
            sizeArray.push({ axis: "z", size: zSize });
            if (axis !== mainAxis) {
                notMainAxis = "z";
            }
        }
        if (dimension > 2) {
            console.error("Only support 1 or 2 dimension");
            return;
        } else if (dimension == 2 && !mainAxis) {
            console.error("Main Axis is needed for 2 dimension");
            return;
        }
        var spaceArray = null;
        if (dimension == 1) {
            spaceArray = this._initArray(sizeArray[0].size);
            for (var i = 0; i < children.size(); i++) {
                var child = children.get(i);
                var childType = dm.getDataTypeForData(child);
                var childSize = childType.getSize();
                var locaton = child.getLocation();
                this.computeOneDimesion(spaceArray, childSize['get' + axis.toUpperCase() + 'Size'](), locaton['get' + axis.toUpperCase()]());
            }
            var space = new it.Space1(spaceArray, axis);
            return space
        }
        if (dimension == 2) {
            var notMainAxisSize = size['get' + notMainAxis.toUpperCase() + 'Size']();
            var mainAxisSize = size['get' + mainAxis.toUpperCase() + 'Size']();
            var space1Array = [];
            for (var k = 0; k < notMainAxisSize; k++) {
                var spaceArray = this._initArray(mainAxisSize);
                for (var i = 0; i < children.size(); i++) {
                    var child = children.get(i);
                    var childType = dm.getDataTypeForData(child);
                    var childSize = childType.getSize();
                    var locaton = child.getLocation();
                    if (locaton['get' + notMainAxis.toUpperCase()]() == k + 1) {
                        this.computeOneDimesion(spaceArray, childSize['get' + mainAxis.toUpperCase() + 'Size'](), locaton['get' + mainAxis.toUpperCase()]());
                    }
                }
                var space1 = new it.Space1(spaceArray, mainAxis);
                space1Array.push(space1);
            }
            var space2 = new it.Space2(space1Array, axis, mainAxis);
            return space2;
        }
        return null;
    },

    computeOneDimesion: function (spaceArrayAxis, childSizeAxis, locatonAxis) {
        if (childSizeAxis == null || childSizeAxis == undefined) {
            childSizeAxis = 1;
        }
        if (!spaceArrayAxis || !childSizeAxis || !(locatonAxis > 0)) {
            return;
        }
        for (var i = 0; i < childSizeAxis; i++) {
            spaceArrayAxis[locatonAxis - 1 + i] = 1;
        }
        return spaceArrayAxis;
    },

    getSpaceNodeColor: function (percent, data, space) {
        if (this.spaceNodeColorFunction) {
            var color = this.spaceNodeColorFunction(percent, data, space);

            return color;
        }
        var color = null;
        if (percent <= 0.25) { // TODO

        }
        color = 'orange';
        return color;
    },

    getSpaceNodeFrameColor: function (percent, data, space) {
        if (this.spaceNodeFrameColorFunction) {
            var color = this.spaceNodeFrameColorFunction(percent, data, space);
            return color;
        } else {
            return this.getSpaceNodeColor(percent, data, space);
        }
    },

    showSpaceMode: function () {
        this.sceneManager.viewManager3d.addVisibleFilter(this.spaceVisibleFilter);
        this.sceneManager.viewManager3d.addMaterialFilter(this.spaceMaterialFilter);
        this.sceneManager.adapterManager.register(this.spaceAdapter);
    },

    hideSpaceMode: function () {
        this.sceneManager.viewManager3d.removeVisibleFilter(this.spaceVisibleFilter);
        this.sceneManager.viewManager3d.removeMaterialFilter(this.spaceMaterialFilter);
        this.sceneManager.adapterManager.deregister(this.spaceAdapter);

    },

    getModelParent: function (node) {
        if (node == null) {
            return null;
        }
        var parent = node.getClient('modelParent');
        if (parent == null) {
            return this.getModelParent(node.getParent());
        }
        return parent;
    },

    remove1DSpaceNodeForNodes: function (nodes) {
        if (nodes instanceof mono.List) {
            nodes = nodes.toArray();
        }
        var box = this.sceneManager.network3d.getDataBox();
        var i = 0, j = 0, node, child;
        for (; i < nodes.length; i++) {
            node = nodes[i];
            var spaceNode = null;
            var children = node.getChildren().toArray();
            for (j = 0; j < children.length; j++) {
                child = children[j];
                if (this.isSpaceNode(child) || this.isSpaceChildrenNode(child)) {
                    box.removeByDescendant(child);
                    child.setParent(null);
                    if (this.isSpaceNode(child)) {
                        spaceNode = child;
                    }
                }
            }
            if (spaceNode) {
                var removedNode = spaceNode.getClient("modelRemovedNode");
                if (removedNode) {
                    //有可能当前空间可视化的模式下正focus某个机柜，此时应该判断node的当前是的到底是真是假，
                    // 直接setParent可能会导致真假都在
                    // removedNode.setParent(node); 
                    // if (box.getDataById(node.getId())) {
                    //     box.addByDescendant(removedNode);
                    // }
                    var complexNode = node.getClient('complexNode');
                    var simpleNode = node.getClient('simpleNode');
                    if (complexNode != 'unload'
                        && complexNode && node.getChildren().contains(complexNode)) { //在空间可视化模式下聚焦的机柜
                        // 如果机柜没满时，那就要去掉中间的色块
                        var children = node.getChildren();
                        for (var k = 0; k < children.size(); k++) {
                            var child = children.get(k);
                            if (this.isSpaceChildrenNode(child)) {
                                child.setParent(null);
                                box.removeByDescendant(child);
                            }
                        }
                    } else { //当前显示的假机柜，此时就可以直接将假的移走
                        removedNode.setParent(node);
                        if (box.getDataById(node.getId())) {
                            box.addByDescendant(removedNode);
                        }
                    }
                }
            }
        }
    },

    create1DSpaceNodeForNodes: function (nodes, mode) {
        // this.nodeMap = {};
        mode = mode || 1;
        if (nodes instanceof mono.List) {
            nodes = nodes.toArray();
        }
        var box = this.sceneManager.network3d.getDataBox();
        box.startBatch();
        var focusNode = this.sceneManager.viewManager3d._focusNode;
        var i = 0, j = 0, node, data, spaceNode, spaceChildrenNodes, spaceChildNode;
        for (; i < nodes.length; i++) {
            node = nodes[i];
            /**
             * 空间资源利用率场景下，查看一个具体机柜时候，点击搜索面板清除按钮的时候，不再显示色块的样式
             * Author: alex
             */
            if (node === focusNode) continue;
            // 创建SpaceNode时，有可能之前创建过，为了避免重复，这里的先清除掉
            var children = node.getChildren().toArray();
            for (j = 0; j < children.length; j++) {
                var child = children[j];
                if (this.isSpaceNode(child) || this.isSpaceChildrenNode(child)) {
                    box.removeByDescendant(child);
                    child.setParent(null);
                    if (this.isSpaceNode(child)
                        && child.getClient("modelRemovedNode")) {
                        var removedNode = child.getClient("modelRemovedNode");
                        removedNode.setParent(node);
                        box.addByDescendant(removedNode);
                    }
                }
            }
            data = this.sceneManager.getNodeData(node);
            if (data) {
                spaceNode = mode == 1 ? this.create1DSpaceNode(data) : this.create1DSpaceNode2(data);
                if (!spaceNode) {
                    continue;
                }
                //将它从box中移除掉，而不是隐藏，但是父子关系依然保留着 --add By Kevin 2016-12-01
                var complexNode = node.getClient('complexNode');
                var simpleNode = node.getClient('simpleNode');
                if (simpleNode && node.getChildren().contains(simpleNode)) {
                    simpleNode.setParent(null);
                    box.removeByDescendant(simpleNode);
                    spaceNode.setClient("modelRemovedNode", simpleNode);
                } else if (complexNode != 'unload' && complexNode && node.getChildren().contains(complexNode)) {
                    complexNode.setParent(null);
                    box.removeByDescendant(complexNode);
                    spaceNode.setClient("modelRemovedNode", complexNode);
                }
                //add 2017-11-18 如果设备在中途被加进来了，也应该移除掉
                //2018-1-17 下面代码移除了一半的node导致移除的node父亲为null 不知道瞎下面代码的意思 --徐
                //   var cNodes = node.getChildren();
                //   if (cNodes && cNodes.size()){
                //     for(var k = 0 ; k < cNodes.size() ; k++){
                //         var childNode = cNodes.get(k);
                //         var childData = this.sceneManager.getNodeData(childNode);
                //         if (childData && childData.getParentId() == data.getId()) {
                //            childNode.setParent(null);
                //            box.removeByDescendant(childNode);
                //         }
                //     }
                //   }

                // this.nodeMap[data.getId()] = spaceNode;
                spaceNode.setClient("modelParent", node);
                spaceNode.setParent(node);
                box.addByDescendant(spaceNode);
            }
        }
        box.endBatch();
    },

    isSpaceNode: function (node) {
        return node.getClient("spaceNode");
    },

    hasSpaceNode: function (node) {
        if (!node) {
            return false;
        }
        var children = node.getChildren();
        if (children && children.size() > 0) {
            for (var i = 0; i < children._as.length; i++) {
                var child = children._as[i];
                if (this.isSpaceNode(child)) {
                    return true;
                }
            }
        }
        return false;
    },

    hasSpaceChildrenNode: function (node) {
        if (!node) {
            return false;
        }
        var children = node.getChildren();
        if (children && children.size() > 0) {
            for (var i = 0; i < children._as.length; i++) {
                var child = children._as[i];
                if (this.isSpaceChildrenNode(child)) {
                    return true;
                }
            }
        }
        return false;
    },

    isSpaceChildrenNode: function (node) {
        return node.getClient('spaceChildrenNode');
    },

    /**
     * 一维的布局，可以支持计算出一个SpaceNode来呈现
     */
    create1DSpaceNode: function (data, parameters) {
        var space = this.computeSpace(data);
        if (!(space instanceof it.Space1)) {
            return;
        }
        var dm = this.dataManager;
        var sm = this.sceneManager;
        var dataType = dm.getDataTypeForData(data);
        var childSize = dataType.getChildrenSize();
        var node = sm.getNodeForDataOrId(data);
        if (!node) {
            return;
        }

        var percent = space.getPercent();
        if (percent == 0) {
            percent = 0.01;
        }
        var color = this.getSpaceNodeColor(percent, data, space);
        var frameColor = this.getSpaceNodeFrameColor(percent, data, space) || color;
        var boundingBox = node.getBoundingBox();
        var width = boundingBox.max.x - boundingBox.min.x;
        var height = boundingBox.max.y - boundingBox.min.y;
        var depth = boundingBox.max.z - boundingBox.min.z;
        var offset = 1;
        width = width - 4;
        height = height - 4;
        var cube = new mono.Cube(width + offset, height + offset, depth + offset);
        // var cube = this.createColorCube(width + offset,height + offset,depth + offset);
        cube.setClient('spaceNode', true);
        cube.s({
            'm.wireframe': true,
            'm.transparent': true,
            // 'm.opacity': 0.1,
            'm.wireframeLineopacity': 0.1,
            //   'm.wireframeLinewidth': 2,
            //   'm.wireframeLinecolor': frameColor,
            //   'm.wireframeLineopacity': 0.5,
        });
        var axis = space.getAxis();
        if (axis === 'x') width = width * percent;
        if (axis === 'y') height = height * percent;
        if (axis === 'z') depth = depth * percent;
        // if(axis === 'x') width = width * percent*cube.getScaleX();
        // if(axis === 'y') height = height * percent*cube.getScaleY();
        // if(axis === 'z') depth = depth * percent * cube.getScaleZ();
        // var cube2 = new mono.Cube(width,height,depth);
        var cube2 = this.createColorCube(width, height, depth);
        cube2.setClient('spaceNode', true);
        cube2.setY(10);
        cube2.setParent(cube);
        var cbb = cube2.getBoundingBox();
        if (axis === 'x') {
            // cube2.setX(boundingBox.min.x - cbb.min.x);
            cube2.setX(boundingBox.min.x - cbb.min.x * cube2.getScaleX());
        } else if (axis === 'y') {
            // cube2.setY(boundingBox.min.y - cbb.min.y);
            cube2.setY(boundingBox.min.y - cbb.min.y * cube2.getScaleY() + 1); //老是钻到floor里面去了，所以+1
        } else {
            // cube2.setZ(boundingBox.min.z - cbb.min.z);
            cube2.setZ(boundingBox.min.z - cbb.min.z * cube2.getScaleZ());
        }
        var lightmap = 'data:image/jpeg;base64,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';
        //   var mColor = new mono.Color(color);
        //   mColor.lerp(mColor,0.5);
        var randomColor = -(Math.random() * 10 + 5);
        color = this.shadeColor(color, randomColor);
        cube2.s({
            'm.type': 'phong',
            'm.color': color,
            'm.ambient': color,
            'm.specularStrength': 20,
            'left.m.lightmap.image': lightmap,
            'right.m.lightmap.image': lightmap,
            'back.m.lightmap.image': lightmap,
            'front.m.lightmap.image': lightmap,
        });
        return cube;
    },
    shadeColor: function (color, percent) {
        var R = parseInt(color.substring(1, 3), 16);
        var G = parseInt(color.substring(3, 5), 16);
        var B = parseInt(color.substring(5, 7), 16);

        R = parseInt(R * (100 + percent) / 100);
        G = parseInt(G * (100 + percent) / 100);
        B = parseInt(B * (100 + percent) / 100);

        R = (R < 255) ? R : 255;
        G = (G < 255) ? G : 255;
        B = (B < 255) ? B : 255;

        var RR = ((R.toString(16).length == 1) ? "0" + R.toString(16) : R.toString(16));
        var GG = ((G.toString(16).length == 1) ? "0" + G.toString(16) : G.toString(16));
        var BB = ((B.toString(16).length == 1) ? "0" + B.toString(16) : B.toString(16));

        return "#" + RR + GG + BB;
    },

    /**
     * 创建彩色色块
     * 为了提高效率，我们只用创建一个原型，其他的都用原型的克隆
     */
    createColorCube: function (width, height, depth) {
        if (!this.colorCube) {
            this.colorCube = new mono.Cube(1, 1, 1);
        }
        var cloneCube = this.colorCube.clonePrefab();
        cloneCube.setScale(width, height, depth);
        return cloneCube;
    },

    removeSpaceNode: function (dataOrNodeOrId) {
        var sm = this.sceneManager;
        sm.removeNodeChildren(dataOrNodeOrId, function (child) {
            return child.getClient('spaceNode');
        });
    },

    create1DSpaceNode2: function (data, parameters) {
        var node = this.create1DChildrenSpaceNodes2(data, parameters);
        return node;
    },

    removeSpaceChildrenNode: function (dataOrNodeOrId) {
        var sm = this.sceneManager;
        sm.removeNodeChildren(dataOrNodeOrId, function (child) {
            return child.getClient('spaceChildrenNode');
        });
    },

    /**
     * 创建SpaceNode 用实体表示
     */
    create1DChildrenSpaceNodes2: function (data, parameters) {
        var space = this.computeSpace(data);
        if (!space instanceof it.Space1) {
            return;
        }
        var dm = this.dataManager;
        var sm = this.sceneManager;
        var node = sm.getNodeForDataOrId(data);
        var dataType = dm.getDataTypeForData(data);
        var childSize = dataType.getChildrenSize();
        if (!node) {
            return;
        }
        var axis = space.getAxis();
        if (!axis) {
            return;
        }
        var boundingBox = node.getBoundingBox();
        var size = boundingBox.size();
        var emptyList = space.getEmptyList();
        var occupationList = space.getOccupationList();
        var wrapNode = new mono.Cube(size.x - 2, size.y, size.z - 2);
        wrapNode.setClient('spaceNode', true);
        wrapNode.setParent(node);
        var nodes = [], total, start, end, object;
        for (var i = 0; i < emptyList.length; i++) {
            object = emptyList[i];
            // total = object.total,start = object.start,end = object.end;
            var spaceNode = this.create1DChildrenSpaceNode2(boundingBox, childSize, object, axis, true);
            spaceNode.setParent(wrapNode);
            nodes.push(spaceNode);
        }
        for (var i = 0; i < occupationList.length; i++) {
            object = occupationList[i];
            var spaceNode = this.create1DChildrenSpaceNode2(boundingBox, childSize, object, axis, false);
            spaceNode.setParent(wrapNode);
            nodes.push(spaceNode);
        }
        wrapNode.s({
            'm.transparent': true,
            'm.opacity': 0.1,
        });
        return wrapNode;
    },

    create1DChildrenSpaceNode2: function (boundingBox, childSize, object, axis, empty) {
        var total = object.total, start = object.start, end = object.end;
        var size = boundingBox.size();
        var width = size.x, height = size.y, depth = size.z;
        var xPadding = childSize.getXPadding() || [0, 0],
            yPadding = childSize.getYPadding() || [0, 0],
            zPadding = childSize.getZPadding() || [0, 0];
        var percent = 0, offset = 1;
        if (axis === 'x') {
            width = total * width / childSize.getXSize();
            width -= offset;
            percent = total / childSize.getXSize();
        } else if (axis === 'y') {
            height = total * height / childSize.getYSize();
            height -= offset;
            percent = total / childSize.getYSize();
        } else if (axis === 'z') {
            depth = total * depth / childSize.getZSize();
            depth -= offset;
            percent = total / childSize.getZSize();
        }
        var cube = new mono.Cube(width - 2, height - 2, depth - 2);
        var cbb = cube.getBoundingBox();
        var x = 0, y = 0, z = 0;
        if (axis === 'x') {
            x = boundingBox.min.x - cbb.min.x + size.x / childSize.getXSize() * (start - 1) + offset / 2;
        } else if (axis === 'y') {
            y = boundingBox.min.y - cbb.min.y + size.y / childSize.getYSize() * (start - 1) + offset / 2;
        } else if (axis === 'z') {
            z = boundingBox.min.z - cbb.min.z + size.z / childSize.getZSize() + offset / 2;
        }
        cube.p(x, y, z);
        //TODO 设置颜色，透明度 根据percent empty（空还是占用）
        var color = emtpy ? this.getSpaceNodeColor(percent) : '#A4A4A4';
        cube.s({
            'm.type': 'phong',
            'm.specularStrength': 50,
            'm.color': color,
            'm.ambient': color
        });
        if (empty) {
            cube.s({
                'm.transparent': true,
                'm.opacity': 0.6,
            });
        }
        cube.setClient('spaceNode', true);
        return cube;
    },

    create1DChildrenSpaceNodes: function (data, parameters) {
        var space = this.computeSpace(data);
        if (!(space instanceof it.Space1)) {
            return;
        }
        var dm = this.dataManager;
        var sm = this.sceneManager;
        var dataType = dm.getDataTypeForData(data);
        var childSize = dataType.getChildrenSize();
        var node = sm.getNodeForDataOrId(data);
        if (!node) {
            return;
        }
        var axis = space.getAxis();
        if (!axis) {
            return;
        }
        var boundingBox = node.getBoundingBox();
        var complexNode = node.getClient('complexNode');
        if (complexNode && complexNode != 'unload') {
            boundingBox = complexNode.getBoundingBox();
            if (!boundingBox.size() || (!boundingBox.size().x && !boundingBox.size().y && !boundingBox.size().z)) {
                boundingBox = it.Util.getBoundingBox(complexNode);
            }
        }
        var bSize = boundingBox.size();
        var width = bSize.x,height = bSize.y,depth = bSize.z;
        var xPadding = childSize.getXPadding() || [0,0],
            yPadding = childSize.getYPadding() || [0,0],
            zPadding = childSize.getZPadding() || [0,0];
        width -= (xPadding[0] + xPadding[1]);
        height -= (yPadding[0] + yPadding[1]);
        depth -= (zPadding[0] + zPadding[1]);
       
        var emptyList = space.getEmptyList();
        var nodes = [],i = 0,object,percent = space.getPercent();
        for(;i < emptyList.length;i ++){
            object = emptyList[i];
            var color = this.getSpaceNodeColor(percent,data);
            var bgColor = this.shadeColor(color, -30);
            var params = {
                object: object,
                width: width,
                height: height,
                depth:  depth,
                childSize: childSize,
                bgColor: bgColor,
                borderColor: color,
                lineColor: color,  
                lineWidth: 4, 
                textSize: '60px', 
                customPro: {
                    spaceChildrenNode: true,
                }
            }
            //nodes.push(this.createEmptyNode(object,width,height,depth,axis,childSize,boundingBox,data,percent));
            nodes.push(it.util.createOccupyPop(params, node));
        }
        return nodes;
    },

    // createEmptyNode : function(object,width,height,depth,axis,childSize,boundingBox,data,percent){
    //     var total = object.total,start = object.start,end = object.end;
    //     var xPadding = childSize.getXPadding() || [0,0],
    //         yPadding = childSize.getYPadding() || [0,0],
    //         zPadding = childSize.getZPadding() || [0,0];
    //     width -= (xPadding[0] + xPadding[1]);
    //     height -= (yPadding[0] + yPadding[1]);
    //     depth -= (zPadding[0] + zPadding[1]);
    //     var offset = 1;
    //     var text = "";
    //     if(axis === 'x'){
    //        width = total * width / childSize.getXSize();
    //        text = total + '('+start+'-' + (start+total-1) + ')';
    //     }else if(axis === 'y'){
    //        height = total * height / childSize.getYSize();
    //        text = total + 'U('+start+'-' + (start+total-1) + ')';//y的单位为U
    //     }else if(axis === 'z'){
    //       depth = total * depth / childSize.getZSize();
    //       text = total + '('+start+'-' + (start+total-1) + ')';
    //     }
    //     var cube = new mono.Cube(width - offset,height - offset,depth - offset);
    //     var cbb = cube.getBoundingBox();
    //     var x = 0,y = 0,z = 0
    //     if(axis === 'x'){
    //        x = boundingBox.min.x - cbb.min.x + xPadding[0] + width / total * (start - 1) + offset/2;
    //     }else if(axis === 'y'){
    //        y = boundingBox.min.y - cbb.min.y + yPadding[0] + height / total * (start - 1) + offset/2;
    //     }else if(axis === 'z'){
    //        z = boundingBox.min.z - cbb.min.z + zPadding[0] + depth / total * (start - 1) + offset/2;
    //     }
    //     cube.p(x,y,z);
    //     var color = this.getSpaceNodeColor(percent,data);
    //     cube.setClient('spaceChildrenNode',true);
  
        
    //     var ratio = cube.width / cube.height;
    //     // if(ratio && ratio > 6){ //当height太小可能显示会被遮挡
    //     //     ratio = 6;
    //     // }
    //     //   针对1U设备，即height太小的时候，使用上述方法，会使得字变得很窄，变形了，且某些情况下，字不符合2的幂规格，因此进行修改
    //     //   此处为修改1  2017.12.15 add by lyz 
    //     var image = this.createTextImage(text,{
    //           color : '#000000',//fontColor,
    //           font : '180px "Microsoft YaHei"',//20150420 设置组织节点字体 去掉bold 180px "Microsoft YaHei
    //           ratio : ratio,
    //           background : color,
    //           powerOfTwo : true,
    //     });
    //     var repeat = new mono.Vec3(image.drawRect.width/image.width,image.drawRect.height/image.height);
  
    //      // s_cube.setStyle('front.m.type','basic');
    //      //          s_cube.setStyle('front.m.texture.image',image);
    //      //          s_cube.setStyle('front.m.texture.repeat',repeat);
  
    //     cube.s({
    //         'm.color' : color,
    //         //设置为透明的话，生成的颜色块效果不好
    //         // 'm.transparent' : true,
    //         // 'm.opacity' : 1, //0.2
    //         'front.m.type':'basic',
    //         'front.m.texture.image':image,
    //         'front.m.texture.repeat':repeat
    //     });
    //     return cube;
    //   },

    createTextImage: function (text, parameters) {
        text = text || '';
        text += '';
        var font = parameters.font, color = parameters.color;
        var background = parameters.background, powerOfTwo = parameters.powerOfTwo, canvas = parameters.canvas;
        var drawFunction = parameters.drawFunction;
        canvas = canvas || document.createElement('canvas');
        font = font || '20px "Dialog"';
        color = color || 'white';
        background = background === undefined ? '#0F90C4' : background;
        powerOfTwo = powerOfTwo || false;
        var lines = text.split('\n');
        var size = mono.Utils.getMaxTextSize(lines, font);
        // 长度固定，如果不这样的话，当text字数少时，比如就一个字，但是cube的width正好也小，这会显示不下，
        // 可是这么固定后就无法居中了,所以就采用上面的左右补空格法，不齐到10个字符
        //        var size = {width:2048,height:256};
        var ratio = parameters.ratio || size.width / size.height;
        var realSize = canvas.realSize = {
            width: size.width,
            height: size.height,
        };

        // if (powerOfTwo) {
        //     size.width = mono.Utils.nextPowerOfTwo(size.width);
        //     size.height = mono.Utils.nextPowerOfTwo(size.height);
        // }
        var drawRect = canvas.drawRect = {
            width: realSize.width / realSize.height > ratio ? realSize.width : realSize.height * ratio,
            height: realSize.width / realSize.height > ratio ? realSize.width / ratio : realSize.height,
        }
        if (Number.isNaN(drawRect.width)) {
            console.log('debug -- b', realSize.width, realSize.height, ratio);
        }
        // drawRect.width = Math.min(drawRect.width, size.width);
        // drawRect.height = Math.min(drawRect.height, size.height);
        if (powerOfTwo) {
            size.width = mono.Utils.nextPowerOfTwo(drawRect.width);
            size.height = mono.Utils.nextPowerOfTwo(drawRect.height);
        }
        canvas.width = size.width;
        canvas.height = size.height;
        //   针对1U设备，即height太小的时候，使用上述方法，会使得字变得很窄，变形了，且某些情况下，字不符合2的幂规格，因此进行修改
        //   此处为修改2  2017.12.15 add by lyz 
        // if (ratio) {
        //     canvas.height = size.width / ratio;
        //     drawRect.height = drawRect.width / ratio;
        // }
        if (Number.isNaN(drawRect.width)) {
            console.log('debug -- a');
        }

        var ctx = canvas.getContext("2d");
        background && (ctx.fillStyle = background);
        if (drawFunction) {
            drawFunction(ctx, canvas.width, canvas.height);
        } else {
            background && (ctx.fillRect(0, 0, canvas.width, canvas.height));
            // drawText(ctx, text, font, color, can;vas, 'center');
            ctx.font = font;
            ctx.fillStyle = color;
            ctx.strokeStyle = 'gray';
            ctx.textBaseline = 'middle';
            // ctx.textAlign = 'center';
            var lineCount = lines.length, averageHeight = realSize.height / lineCount
            for (var i = 0; i < lineCount; i++) {
                var width = mono.Utils.getTextSize(font, lines[i]).width;
                var height = canvas.height;
                var x = (drawRect.width - realSize.width) / 2;
                var y = (drawRect.height - realSize.height) / 2 + averageHeight / 2 + i * averageHeight + (canvas.height - drawRect.height);

                ctx.strokeText(lines[i], x, y);
                ctx.fillText(lines[i], x, y);
            }
        }
        return canvas;
    },

});

it.SpaceManager = $SpaceManager;

var $SpaceVisibleFilter = function(sceneManager,spaceManager){
   this.sceneManager = sceneManager;
   this.spaceManager = spaceManager;
   this.visibleMap = {};
   var self = this;
   this.sceneManager.viewManager3d.addPropertyChangeListener(function(event){
       if(event.property == "focusNode"){
         self.visibleMap = {};
       }
   });
};

mono.extend($SpaceVisibleFilter,$VisibleFilter,{
  
    isVisible: function(node,data,network){
        var id = node.getId();
        // if(this.visibleMap[id] != undefined){
        //      return this.visibleMap[id];
        // }
        // var sm = this.sceneManager;
        // var sm2 = this.spaceManager;
        // var dm = sm.dataManager;
        // var focusNode = sm.viewManager3d.getFocusNode();
        // var root = node.getClient("modelParent") || node;
        // if(sm2.isSpaceNode(node) && root == node){
        //     root = node.getParent().getClient("modelParent") || root;
        // }
        if(node instanceof mono.Billboard){
            this.visibleMap[id] = false;
        	return false;
        }
        // if(focusNode === node){
        //     this.visibleMap[id] = true;
        // 	return true;
        // }
        // if(sm2.isSpaceNode(node)){
        // 	if(focusNode == root){
        //         this.visibleMap[id] = false;
        // 		return false;
        // 	}else{
        //         this.visibleMap[id] = true;
        // 		return true;
        // 	}
        // }
        // if(sm2.isSpaceChildrenNode(node)){
        // 	if(focusNode == node.getParent()){
        //         this.visibleMap[id] = true;
        // 		return true;
        // 	}
        //     this.visibleMap[id] = false;
        // 	return false;
        // }
        // if((node === root || sm.getMainNode(node) === root) && sm2.hasSpaceNode(root)){
        // 	if(focusNode == root){
        //         this.visibleMap[id] = true;
        // 		return true;
        // 	}else{
        //         this.visibleMap[id] = false;
        // 		return false;
        // 	}
        // }
        // if(data){
        //   var parent = sm.getParentNode(data);
        //   var parentData = dm.getParent(data);
        //   if(parent && parentData){
        //   	  var flag = this.isVisible(parent,parentData,network);
	       //    if(!flag){
        //         this.visibleMap[id] = false;
	       //    	return false;
	       //    }
        //   }
        // }
        // this.visibleMap[id] = true;
        return true;
    }
});

it.SpaceVisibleFilter = $SpaceVisibleFilter;

var $SpaceMaterialFilter = function (sceneManager,spaceManager) {
	this.sceneManager = sceneManager;
  this.spaceManager = spaceManager;
	this.materialMap = {};
};

mono.extend($SpaceMaterialFilter,$MaterialFilter,{
    filterMaterial : function(originalMaterial,filterdMaterial,node){
      var sm = this.sceneManager;
      var vm = sm.viewManager3d;
      var sm2 = this.spaceManager;
      var focusNode = vm.getFocusNode();
      var map = this.materialMap;

      if(sm.getNodeData(node)){
         return filterdMaterial;
      }
      if(sm2.isSpaceNode(node)){
         if(focusNode){
            if(node.isDescendantOf(focusNode)){
               return filterdMaterial;
            }else{
              var id = originalMaterial.getUniqueCode();
              var m = this.materialMap[id];
              if(!m){
                 m = originalMaterial.clone();
                 this.materialMap[id] = m;
                 m.transparent = true;
                 m.opacity = 0.05;
              }
              return m;
            }
         }
      }

	},

});

it.SpaceMaterialFilter = $SpaceMaterialFilter;
/**
 * create by Kevin
 * 综合布线管理
 *  Link在add至DataManagement中时其实就已经创建，只不过都隐藏掉了
 *  这里主要处理:
 *  1.什么时候显示哪些对象(包括it.Link本身，以及与其相关的it.Data);
 *  2.重新计算link的走向，虽一开始添加至datamanager中就计算好了走向，但是有可能没有考虑到同时显示多条link的问题(或者是没有考虑到其他的link的情况);
 *  3.当显示link时，如果其对应的fromNode或toNode没有加载则要将其加载；
 *
 * //如果fromNode和toNode(没加载)，则连到它的parent.
 * //可是当node加载后又应该自动连接到node本身,也就是每生成一个3D对象就得判断是不是有它的连线联到了其他的对象
 *
 * 或者点击父设备看详细时，查看该父设备上是不是有link，然后再判断该link本身是要连到哪里
 *
 * @constructor
 */

var $GCSManager = function(obj) {
    var obj = obj || {};
    this.sceneManager = obj.sceneManager;
    this.viewManager3d = this.sceneManager.viewManager3d;
    this.box3D = this.sceneManager.network3d.getDataBox();
    this.defaultMaterialFilter = this.viewManager3d.getDefaultVirtualMaterialFilter();
    this.defaultEventHandler = this.viewManager3d.getDefaultEventHandler();
    this._flagLink = null; // 用于存放动态变化了的Link，如：鼠标滑过link时link变粗，鼠标移走就又变回去，此时得把它保存至着
    this.animates = {};
    this.linkBillboard = {};
    this.linkManager = new $LinkManager(this.sceneManager);
    this.defaultSetFocusNode = this.viewManager3d.setFocusNode;
    this.undoSetFocusNode = function(node) {};
    this.mdfMap = {};
    this.lightBillboardMap = {};
    this.init();
};

mono.extend($GCSManager, $EventHandler, {

    init: function() {
        this.viewManager3d.addEventHandler(this);
        var self = this;
        this.gcsManagerInterval = setInterval(function() {
            var billboards = self.linkBillboard;
            if (billboards) {
                for (var id in billboards) {
                    var link = self.sceneManager.dataManager.getLinkById(id);
                    if (!link) {
                        continue;
                    }
                    var billboard = billboards[id];
                    var bg = '#5B8505';
                    var value = link._userDataMap['flow'] || 1;
                    var canvas = billboard.getStyle('m.texture.image');
                    if (!(canvas instanceof HTMLCanvasElement)) {
                        canvas = null;
                    }
                    billboard.setStyle('m.texture.image', it.Util.getSpecialTextBillboard(value.toFixed(2), it.util.i18n("LinkSearch_Flow") +':', 'M/s', bg, false, canvas));
                    billboard.invalidateTexture();
                }
            }
        }, 10000);

        this.sceneManager.addSceneChangeListener(function(eve){
            self.clearAllLink();
        });
    },

    /**
     * 隐藏所有的link
    */
    clearAllLink: function(withoutAfterClearCall, lookAtData) {
        for (var linkId in this.sceneManager.linkMap) {
            this.clearLinkById(linkId, lookAtData);
        }
        this.unlock();
        if(this.gcsManagerInterval){
            clearInterval(this.gcsManagerInterval);
        }
        if (!withoutAfterClearCall) {
            this.afterClearAllLinkFunction && this.afterClearAllLinkFunction();
        }
    },

    /**
     *
     * 锁定，就是锁定LookAt时的真假切换和lookAt时的虚幻管理
     * 若是点击背景回到上一层时，该如何处理，是否阻止？
     */
    lock: function() {
        this.sceneManager.doubleClickBackgroundGotoUpLevelScene = false;
        this.viewManager3d.setFocusNode = this.undoSetFocusNode;
        this.viewManager3d.setCameraDistanceForAfterPlayCamere(this.sceneManager.getCurrentRootNode());//每次锁定的时候，镜头的缩放范围根据rootNode来
    },

    /**
     * 解锁，就是解开LookAt时的真假切换和lookAt时的虚幻管理
     */
    unlock: function() {
        this.sceneManager.doubleClickBackgroundGotoUpLevelScene = true;
        this.viewManager3d.setFocusNode = this.defaultSetFocusNode;
    },

    stopAllAnimates: function() {
        if (!this.animates) {
            return;
        }
        for (var id in this.animates) {
            var animate = this.animates[id];
            if (animate instanceof Array) {
                for (var i = 0; i < animate.length; i++) {
                    animate[i] && animate[i].stop();
                }
            } else {
                this.animates[id].stop();
            }
            delete this.animates[id];
        }
    },

    clearAllAnimateBillboard: function() {
        if (!this.lightBillboardMap) {
            return;
        }
        for (var id in this.lightBillboardMap) {
            if (this.lightBillboardMap[id]) {
                this.box3D.remove(this.lightBillboardMap[id]);
            }
        }
    },

    /**
     * 清除Link
     * 注意：清除link时也得处理fromNode和toNode，如果from或to不在当前场景时得把from或to从box中remove掉，甚至包括from或to的parent
     *
     * @param linkOrId
     * @param lookAtData lookAt的对象，在怎么清空也不能把当前正(或马上准备)lookAt的对象给清空掉
     */
    clearLinkById: function(linkOrId, lookAtData) {
        var id = linkOrId;
        if (linkOrId instanceof it.Link) {
            id = linkOrId.getId();
        }
        var sm = this.sceneManager;
        var link = sm.dataManager.getLinkById(id);
        if (!link) return;
        var linkNode = sm.linkMap[id];
        if (!linkNode) { //有可能还没有创建
            return;
        }
        if (this.animates && this.animates[id]) {
            var animate = this.animates[id];
            if (animate instanceof Array) {
                for (var i = 0; i < animate.length; i++) {
                    animate[i] && animate[i].stop();
                }
            } else {
                this.animates[id].stop();
            }
            delete this.animates[id];
        }
        if (this.lightBillboardMap && this.lightBillboardMap[id]) {
            this.box3D.remove(this.lightBillboardMap[id]);
        }
        ///一开始link要是显示着的，并且要在box中,因为在其他的场景中也会调到该方法，因此有可能什么都不会显示
        if (linkNode && linkNode.isVisible() && this.box3D.getDataById(linkNode.getId())) {
            var fromId = link.getFromId();
            var toId = link.getToId();
            var fromData = sm.dataManager.getDataById(fromId);
            var toData = sm.dataManager.getDataById(toId);
            if (fromData && toData) {
                var fromSceneAndRoot = sm.getSceneAndRootByData(fromData);
                var toSceneAndRoot = sm.getSceneAndRootByData(toData);
                var isSameScene = true;
                var targetSceneAndRoot = sm.getSceneAndRootByData(lookAtData);
                if (fromSceneAndRoot && !toSceneAndRoot) {
                    isSameScene = false;
                } else if (!fromSceneAndRoot && toSceneAndRoot) {
                    isSameScene = false;
                } else if (fromSceneAndRoot && toSceneAndRoot && (fromSceneAndRoot.scene != toSceneAndRoot.scene || fromSceneAndRoot.rootData != toSceneAndRoot.rootData)) {
                    isSameScene = false;
                } else if (fromSceneAndRoot && targetSceneAndRoot && (fromSceneAndRoot.scene != targetSceneAndRoot.scene || fromSceneAndRoot.rootData != targetSceneAndRoot.rootData)) {
                    isSameScene = false;
                }
                if (!isSameScene) {
                    var fromRootNode = sm.getNodeByDataOrId(fromSceneAndRoot.rootData);
                    var toRootNode = sm.getNodeByDataOrId(toSceneAndRoot.rootData);
                    if (lookAtData && (lookAtData == fromData || lookAtData == toData)) {
                        if (lookAtData == fromData) {
                            this.box3D.removeByDescendant(toRootNode);
                            if (sm._currentScene != fromSceneAndRoot.scene || sm._currentRootNode != fromRootNode) {
                                sm._currentScene = fromSceneAndRoot.scene;
                                sm._currentRootNode = fromRootNode;
                                //还需要派发sceneChange的事件
                                sm._sceneChangeDispather.fire({
                                    kind: 'changeScene',
                                    data: fromSceneAndRoot.scene
                                });
                                this.defaultEventHandler.lookAt(sm.getNodeByDataOrId(lookAtData));
                            }
                        } else { //if(lookAtData == toData){
                            this.box3D.removeByDescendant(fromRootNode);
                            if (sm._currentScene != toSceneAndRoot.scene || sm._currentRootNode != toRootNode) {
                                sm._currentScene = toSceneAndRoot.scene;
                                sm._currentRootNode = toRootNode;
                                //还需要派发sceneChange的事件
                                sm._sceneChangeDispather.fire({
                                    kind: 'changeScene',
                                    data: toSceneAndRoot.scene
                                });
                                this.defaultEventHandler.lookAt(sm.getNodeByDataOrId(lookAtData));
                            }
                        }
                    } else {
                        if (fromSceneAndRoot && fromSceneAndRoot.rootData) {
                            if (fromRootNode != sm.getCurrentRootNode()) {
                                this.box3D.removeByDescendant(fromRootNode);
                            }
                        }
                        if (toSceneAndRoot && toSceneAndRoot.rootData) {
                            if (toRootNode != sm.getCurrentRootNode()) {
                                this.box3D.removeByDescendant(toRootNode);
                            }
                        }
                    }
                }
            }
            // 移除掉配线架
            var fromRackNode = this.getRackNodeByNode(this.sceneManager.getNodeByDataOrId(fromId));
            var fromRackData = this.sceneManager.getNodeData(fromRackNode);
            var fromMdfNode = this.mdfMap[fromRackData.getId()];
            if (fromMdfNode) {
                fromMdfNode.setParent(null);
                this.sceneManager.network3d.dataBox.remove(fromMdfNode);
            }
            var toRackNode = this.getRackNodeByNode(this.sceneManager.getNodeByDataOrId(toId));
            var toRackData = this.sceneManager.getNodeData(toRackNode);
            var toMdfNode = this.mdfMap[toRackData.getId()];
            if (toMdfNode) {
                toMdfNode.setParent(null);
                this.sceneManager.network3d.dataBox.remove(toMdfNode);
            }
        }
        linkNode.setVisible(false);
        var billboard = this.linkBillboard[id];
        if (billboard) {
            billboard.setVisible(false);
        }
    },

    /**
     * 根据data或dataId隐藏其对应的link
     * @param dataOrId
     */
    clearLinksByData: function(dataOrId, lookAtData) {
        var data = null;
        var sm = this.sceneManager;
        if (dataOrId instanceof it.Data) {
            data = dataOrId;
        } else {
            data = this.sceneManager.dataManager.getDataById(dataOrId);
        }
        if (!data) {
            return;
        }
        var rackNode = this.getRackNodeByNode(this.sceneManager.getNodeByDataOrId(data));
        var rackData = this.sceneManager.getNodeData(rackNode);
        var mdfNode = this.mdfMap[rackData.getId()];
        if (mdfNode) {
            mdfNode.setParent(null);
            this.sceneManager.network3d.dataBox.remove(mdfNode);
        }
        var links = data.getAllLinks();
        if (links) { //这是个对象不是数组
            var linkCount = 0;
            for (var linkId in links) {
                this.clearLinkById(linkId);
                linkCount++;
            }
            if (linkCount < 1) {
                return;
            }
            if (lookAtData) {
                var lookAtSceneAndRoot = this.sceneManager.getSceneAndRootByData(lookAtData);
                var isSameScene = true;
                var lookAtNode = sm.getNodeByDataOrId(lookAtData);
                var lookAtRootNode = null;
                if (lookAtSceneAndRoot && lookAtSceneAndRoot.rootData) {
                    lookAtRootNode = sm.getNodeByDataOrId(lookAtSceneAndRoot.rootData);
                }
                if (lookAtSceneAndRoot && !sm._currentScene) {
                    isSameScene = false;
                } else if (!lookAtSceneAndRoot && sm._currentScene) {
                    isSameScene = false;
                } else if (lookAtSceneAndRoot.scene != sm._currentScene || sm._currentRootNode != lookAtRootNode) {
                    isSameScene = false;
                }
                if (!isSameScene) {
                    this.box3D.removeByDescendant(sm._currentRootNode);
                    this.box3D.addByDescendant(lookAtRootNode);
                    this.box3D.addByDescendant(lookAtNode); //万一lookAt和lookAtRoot脱离了关系(如：中间的filter过滤掉了)
                    sm._currentScene = lookAtSceneAndRoot.scene;
                    sm._currentRootNode = lookAtRootNode;
                    //还需要派发sceneChange的事件
                    sm._sceneChangeDispather.fire({
                        kind: 'changeScene',
                        data: lookAtSceneAndRoot.scene
                    });
                    this.defaultEventHandler.lookAt(lookAtNode);
                }
            }
        }

    },

    /**
     * 根据data显示其上面的所有link
     * 如果link的数量大于1时，则需要实现自动排开（由于没有端口这个实体，电线估计就不需要排开了，如果是网线的话估计是应该排开的）
     * 排开基本算法：
     *  根据Node的boundbox的x来平均分？？？
     * @param dataOrId

     ** 此方法可以去掉。。。 
     */
    showLinksByData: function(dataOrId, resetControls) {
        var data = null;
        this.clearAllLink();
        if (dataOrId instanceof it.Data) {
            data = dataOrId;
        } else {
            data = this.sceneManager.dataManager.getDataById(dataOrId);
        }
        if (!data) {
            return;
        }
        var links = data.getAllLinks();
        var maxLink = null;
        var nodes = [];
        if (links) {
            var linkNodes = [];
            for (var linkId in links) {
                this._createLinkByLinkId(linkId, resetControls, false);
                var linkNode = this.sceneManager.linkMap[linkId];
                linkNodes.push(linkNode);
                var link = links[linkId];
                if (link) {
                    var fromNode = this.sceneManager.getNodeByDataOrId(link.getFromId());
                    var toNode = this.sceneManager.getNodeByDataOrId(link.getToId());
                    nodes.push(fromNode);
                    nodes.push(toNode);
                }
            }
            if (linkNodes.length === 1) {
                this.defaultEventHandler.lookAt(linkNodes[0]);
                return;
            } else {
                this.defaultEventHandler.lookAtElements(nodes);
            }
            this.lock();
        } else {
            var dataNode = this.sceneManager.getNodeByDataOrId(data);
            if (dataNode) {
                this.defaultEventHandler.lookAt(dataNode);
            }
        }
    },

    afterShowLink: function(link) {

    },

    /**
     * 显示了到某个node的多条链路后
     */
    afterShowNetLinks: function(objects) {
        // if (!links || links.length > 0) {
        //     for (var i = 0; i < links.length; i++) {
        //         var link = links[i];
        //         this.afterShowLink(link);
        //     }
        // }
    },
    
    /**
     * 根据dataOrId显示连到到data上的所有的链路
     */
    showMulLinkByData: function(dataOrId, resetControls) {
        var data = null;
        this.clearAllLink();
        if (dataOrId instanceof it.Data) {
            data = dataOrId;
        } else {
            data = this.sceneManager.dataManager.getDataById(dataOrId);
        }
        if (!data) {
            return;
        }
        if (!this.linkManager.linkMap) {
            this.linkManager.computeLinkTree();
        }
        var objects = this.linkManager.getMulLinksByDataId(dataOrId);
        var nodes = [];
        if (objects && objects.length > 0) {
            this.lock();
            var linkNodes = [];
            this.viewManager3d.defaultMaterialFilter.addAll(); //处理虚化，自己管理
            // 当link都在同一层显示时，floor可以不虚化；当link跨楼层时，floor应该都虚化掉 
            this.viewManager3d.defaultMaterialFilter.remove(this.sceneManager._currentRootData);
            for (var j = 0; j < objects.length; j++) {
                var links = objects[j];
                if (!links || links.length < 1) {
                    console.log("link's length is 0 ,please to check!!!");
                    continue;
                }
                for (var i = 0; i < links.length; i++) {
                    var link = links[i];
                    if (link) {
                        this._createLinkByLinkId(link.getId(), resetControls, false);
                        var linkNode = this.sceneManager.linkMap[link.getId()];
                        linkNodes.push(linkNode);
                        var fromNode = this.sceneManager.getNodeByDataOrId(link.getFromId());
                        var toNode = this.sceneManager.getNodeByDataOrId(link.getToId());
                        nodes.push(fromNode);
                        nodes.push(toNode);
                        this.viewManager3d.defaultMaterialFilter.remove(this.sceneManager.getNodeData(fromNode)); //处理虚化，自己管理
                        this.viewManager3d.defaultMaterialFilter.remove(this.sceneManager.getNodeData(toNode)); //处理虚化，自己管理
                    }
                }
            }
            if (nodes && nodes.length > 0) {
                for(var i = 0 ; i < nodes.length ; i++){
                    if (!this.sceneManager.isCurrentSceneInstance(this.sceneManager.getNodeData(nodes[i]))) {
                        this.viewManager3d.defaultMaterialFilter.add(this.sceneManager._currentRootData);
                        break;
                    }
                }
            }
            if (linkNodes.length === 1) {
                this.defaultEventHandler.lookAt(linkNodes[0]);
            } else {
                this.defaultEventHandler.lookAtElements(nodes);
            }
            this.afterShowNetLinks(objects);
            this.playAnimateByLinks(objects[0]);
        } else {
            var dataNode = this.sceneManager.getNodeByDataOrId(data);
            if (dataNode) {
                this.defaultEventHandler.lookAt(dataNode);
            }
        }
        // 2017-10-30 由于lookAtLink时，setFouce锁定了，如果当前focus的不是Floor时，
        //  不管怎么点击背景都总数看到一个地方，而现在的逻辑则是点击背景会清空link回退到上一层
        this.sceneManager.viewManager3d._focusNode = this.sceneManager.getCurrentRootNode();
    },

    /**
     * lookAt一整条链路
     */
    lookAtLinks: function(links) {
        if (!links) {
            return;
        }
        if (!(links instanceof Array)) {
            var linkNode = this.sceneManager.linkMap[links.getId()];
            this.defaultEventHandler.lookAt(linkNode);
            return;
        }
        if (links.length == 1) {
            var linkNode = this.sceneManager.linkMap[links[0].getId()];
            this.defaultEventHandler.lookAt(linkNode);
            return;
        }
        var nodes = [];
        for (var i = 0; i < links.length; i++) {
            var link = links[i];
            if (link) {
                var fromNode = this.sceneManager.getNodeByDataOrId(link.getFromId());
                var toNode = this.sceneManager.getNodeByDataOrId(link.getToId());
                nodes.push(fromNode);
                nodes.push(toNode);
            }
        }
        this.defaultEventHandler.lookAtElements(nodes);
    },

    /**
     * 显示所有的link，太多的话一般不需要全部显示，貌似没有什么意义
     * 注意：对于没有加载的link这里需要将fromNode和toNode加载好后，再重新加载Link
     * @param resetControls
     */
    showAllLinks: function(resetControls) {
        var linkMap = this.sceneManager.dataManager.getLinkMap();
        if (!linkMap) return;
        for (var id in linkMap) {
            this.showLinkByLinkId(id, resetControls, false);
        }
    },

    showBillboard: function(link) {
        return true;
    },

     //这里重写，把同步的程序给逆转为异步 -- add by azhuang 2018-1-10 

        /*
        * 连线搜索树的点击事件
        * 在点击的时候加载node
        * node的加载是异步的
        * 所以所有依赖node的操作都要放在加载完的callback里
        * node加载完是在loadlazydata的回调里
        * 先加载from->后加载to->加载link->Link的处理事件
        */
    _createLinkByLinkId: function(linkOrId, resetControls, removeOthers, withOutHeight, callback, scop) {
        var id = linkOrId;
        var isClear = true;
        if (removeOthers != undefined && removeOthers != null) {
            isClear = removeOthers;
        }
        if (isClear) {
            this.clearAllLink();
        }
        if (linkOrId instanceof it.Link) {
            id = linkOrId.getId();
        }
        if (id) {
            this.originLinkId = id;
            var contralPoints = null;
            var linkRes = this.createlinkRelationById(id);
            var link = linkRes.link;
            var fromId = linkRes.fromId;
            var toId = linkRes.toId;
            var fromPortId = linkRes.fromPortId;
            var toPortId = linkRes.toPortId;
            var fromSide = linkRes.fromSide;
            var toSide = linkRes.toSide;
            var fromNode = linkRes.fromNode;
            var toNode = linkRes.toNode;
            var linkNode = linkRes.linkNode;

            //这里重写，把同步的程序给逆转为异步 -- add by azhuang 2018-1-10 
            //思路：linkNode的加载依赖于fromNode和toNode，而这两个node的加载是异步的
            //问题1：两个设备还好，如果有多个node的加载状态需要监测怎么办
            // if (!linkNode) { // 如果没有，可能是因为之前from和to没有加载，这里得需要处理，并重新load
            //     if (this.reloadLink(id)) {
            //         linkNode = this.sceneManager.linkMap[id];
            //         fromNode = this.sceneManager.dataNodeMap[fromId];
            //         toNode = this.sceneManager.dataNodeMap[toId];
            //     }
            // }
            
            if (fromNode && toNode) {
                this.showFromAndToNode(fromNode,toNode);
                if(!linkNode){
                    this.sceneManager.loadLink(link);
                }
                this.afterLoadLinkNode(id, resetControls, withOutHeight, callback, scop);
            }else{
                var self = this;
                var afterLoadFromNode = function(fromNode){
                    var afterLoadToNode = function(toNode){
                        var link = self.createlinkRelationById(id).link;
                        var fromNode = self.createlinkRelationById(id).fromNode;
                        var toNode = self.createlinkRelationById(id).toNode;
                        self.showFromAndToNode(fromNode,toNode);
                        self.sceneManager.loadLink(link);
                        self.afterLoadLinkNode(id, resetControls, withOutHeight, callback, scop);
                        //连线这里是同步的
                    };
                    self.sceneManager.loadLazyData(toId,afterLoadToNode);
                }
                this.sceneManager.loadLazyData(fromId,afterLoadFromNode);
            }
        }
    },
    createlinkRelationById: function(id){
        var link = this.sceneManager.dataManager.getLinkById(id);
        var fromId = link.getFromId();
        var toId = link.getToId();
        var fromPortId = link.getFromPortId();
        var toPortId = link.getToPortId();
        var fromSide = link.getFromSide();
        var toSide = link.getToSide();
        //fromNode和toNode这么早弄出来，有可能为null，所以确保一定拿得到，下面reload后重取一次
        var fromNode = this.sceneManager.dataNodeMap[fromId];
        var toNode = this.sceneManager.dataNodeMap[toId];
        var linkNode = this.sceneManager.linkMap[id];
        return {
            link: link,
            fromId: fromId,
            toId: toId,
            fromPortId: fromPortId,
            toPortId: toPortId,
            fromSide: fromSide,
            toSide: toSide,
            fromNode: fromNode,
            toNode: toNode,
            linkNode: linkNode
        }
    },
    showLinkNode: function(id,resetControls,withOutHeight){
        var linkRes = this.createlinkRelationById(id);
        var link = linkRes.link;
        var fromId = linkRes.fromId;
        var toId = linkRes.toId;
        var fromPortId = linkRes.fromPortId;
        var toPortId = linkRes.toPortId;
        var fromSide = linkRes.fromSide;
        var toSide = linkRes.toSide;
        var fromNode = linkRes.fromNode;
        var toNode = linkRes.toNode;
        var linkNode = linkRes.linkNode;
        // 对于mono.Link，当fromNode或toNode从box中移除后，它会将link的from和to置为null
        if (!linkNode.getFromNode()) {
            var linkFromNode = fromNode;
            if (fromPortId) { // add by 2016-12-06 端对端
                var fromPortNode = this.sceneManager.postManager.loadPortByPortId(fromId, fromPortId, fromSide);
                if (fromPortNode) {
                    linkFromNode = fromPortNode;
                }
            }
            linkNode.setFromNode(linkFromNode);
        }
        if (!linkNode.getToNode()) {
            var linkToNode = toNode;
            if (toPortId) { // add by 2016-12-06 端对端
                var toPortNode = this.sceneManager.postManager.loadPortByPortId(toId, toPortId, toSide);
                if (toPortNode) {
                    linkToNode = toPortNode;
                }
            }
            linkNode.setToNode(toNode);
        }
        linkNode.setVisible(true);
        if (!this.box3D.getDataById(linkNode.getId())) { // 有可能中途被移除掉了，当from或to被移出时，link也会被移除
            this.box3D.add(linkNode);
        }
        if (resetControls) {
            contralPoints = this.resetPathByLink(id, withOutHeight);
        }
    },
    showFromAndToNode: function(fromNode,toNode){
        //去掉其透明
        this.defaultMaterialFilter.removeByDescendant(fromNode);
        this.defaultMaterialFilter.removeByDescendant(toNode);

        //如果不在box中也需要弄进去
        if (!this.box3D.getDataById(fromNode.getId())) {
            this.box3D.addByDescendant(fromNode);
        }
        if (!this.box3D.getDataById(toNode.getId())) {
            this.box3D.addByDescendant(toNode);
        }
        var fromRootNode = this.getNodeRootNodeByNode(fromNode);
        var fromRootData = this.sceneManager.getNodeData(fromRootNode);
        var self = this;
        if (fromRootNode && !this.box3D.getDataById(fromRootNode.getId())) {
            this.box3D.addByDescendant(fromRootNode, function(childNode) {
                var childNodeData = self.sceneManager.getNodeData(childNode);
                if (childNodeData && childNodeData == fromRootData) {
                    return true;
                } else {
                    return false;
                }
            });
        }
        var toRootNode = this.getNodeRootNodeByNode(toNode);
        var toRootData = this.sceneManager.getNodeData(toRootNode);
        if (toRootNode && !this.box3D.getDataById(toRootNode.getId())) {
            this.box3D.addByDescendant(toRootNode, function(childNode) {
                var childNodeData = self.sceneManager.getNodeData(childNode);
                if (childNodeData && childNodeData == toRootData) {
                    return true;
                } else {
                    return false;
                }
            });
        }
    },
    afterLoadLinkNode: function(id, resetControls, withOutHeight, callback, scop){
        var link = this.createlinkRelationById(id).link;
        this.lock();
        var fromId = link.getFromId();
        var toId = link.getToId();
        if (!this.sceneManager.isCurrentSceneInstance(fromId) 
            || !this.sceneManager.isCurrentSceneInstance(toId)) {
            this.viewManager3d.defaultMaterialFilter.add(this.sceneManager._currentRootData);
        }
        this.showLinkNode(id,resetControls,withOutHeight);
        if (this.showBillboard(link)) {
            var billboard = this.createBillboard(link);
        }
        this.afterShowLink(link);
        callback && callback(scop);
    },
    /**
     * 根据linkId显示link
     * 创建后，以及后续的是否创建billboard，是否调用afteer
     * @param linkOrId
     * @param resetControls
     * @param removeOthers
     *
     */
    showLinkByLinkId: function(linkOrId, resetControls, removeOthers, withOutHeight ,callback, scop) {
        var id = linkOrId;
        if (linkOrId instanceof it.Link) {
            id = linkOrId.getId();
        }
        var link = this.sceneManager.dataManager.getLinkById(id);
        if (!link) {
            return ;
        }
        this.viewManager3d.defaultMaterialFilter.addAll(); //2017-10-20 处理虚化 _createLinkByLinkId中会将link上的node的虚化清掉
        // 当link都在同一层显示时，floor可以不虚化；当link跨楼层时，floor应该都虚化掉 
        this.viewManager3d.defaultMaterialFilter.remove(this.sceneManager._currentRootData);
        this._createLinkByLinkId(link, resetControls, removeOthers, withOutHeight ,callback, scop);
    },

    /**
     * 获取node的根
     * @param node
     * @returns {*}
     */
    getNodeRootNodeByNode: function(node) {
        if (!node) {
            return null;
        }
        var data = this.sceneManager.getNodeData(node);
        var sceneAndRoot = this.sceneManager.getSceneAndRootByData(data);
        if (sceneAndRoot && sceneAndRoot.rootData) {
            return this.sceneManager.getNodeByDataOrId(sceneAndRoot.rootData);
        }
        return null;
    },

    createBillboard: function(link) {
        if (!link) {
            return;
        }
        var linkNode = this.sceneManager.linkMap[link.getId()];
        if (!linkNode) {
            return;
        }
        var contralPoints = linkNode.getControls();
        var px, py, pz;
        if (contralPoints && contralPoints.length > 4) {
            var p4 = contralPoints[3];
            px = p4.x;
            py = p4.y + 60;
            pz = p4.z;
        }
        var billboard = this.linkBillboard[link.getId()];
        if (!billboard) {
            var billboard = it.Util.createSpecailTextBillboard("text");
            billboard.setPosition(px || 0, py || 0, pz || 0);
            var bg = '#5B8505';
            var value = link._userDataMap['flow'] || 0;
            billboard.setStyle('m.texture.image', it.Util.getSpecialTextBillboard(value.toFixed(2), it.util.i18n("LinkSearch_Flow") +':', 'M/s', bg));
            billboard.invalidateTexture();
            billboard.s({
            	'm.fixedSize': 5000,
            })
            this.box3D.add(billboard);
            this.linkBillboard[link.getId()] = billboard;
        } else {
            billboard.setVisible(true);
            if (!this.box3D.getDataById(billboard.getId())) {
                this.box3D.add(billboard);
            }
        }
    },

    /**
     * 重新加载Link
     * @param linkOrId
     * @returns {boolean} 返回的为true时，表示的是重新加载了，否则则没有重新加载
     */
    reloadLink: function(linkOrId) {
        if (!linkOrId) {
            return false;
        }
        var link = null;
        if (linkOrId instanceof it.Link) {
            link = linkOrId;
        } else {
            link = this.sceneManager.dataManager.getLinkById(linkOrId);
        }
        if (!link) {
            return false;
        }
        var linkNode = this.sceneManager.linkMap[link.getId()];
        if (linkNode) {
            return false;
        }
        var fromId = link.getFromId();
        var toId = link.getToId();
        //如果from和to不是在同一个场景中，该怎么处理？将两个场景的数据都加载出来？可是lookAt到from或to时在回到上一级又该怎么处理
        var fromNode = this.sceneManager.dataNodeMap[fromId];
        if (!fromNode) {
            if (!this.sceneManager.dataManager.getDataById(fromId)) {
                return false;
            }
            this.sceneManager.loadLazyData(fromId);
        }
        var toNode = this.sceneManager.dataNodeMap[toId];
        if (!toNode) {
            if (!this.sceneManager.dataManager.getDataById(toId)) {
                return false;
            }
            this.sceneManager.loadLazyData(toId);
        }
        this.sceneManager.loadLink(link);
        return true;
    },

    resetPathByLink: function(linkOrId, withOutHeight) {
        if (!linkOrId) {
            return null;
        }
        var id = linkOrId;
        if (linkOrId instanceof it.Link) {
            id = linkOrId.getId();
        }
        var linkNode = this.sceneManager.linkMap[id];
        if (!linkNode) return null;
        var controls = null;
        if (withOutHeight) {
            controls = this.generateControlsWithOutHeight(linkNode);
        } else {
            // controls = this.generateControls(linkNode,200);
            controls = this.generateControlsWithMDF(linkNode);
        }
        if (controls) {
            linkNode.setControls(controls);
        }
        return controls;
    },

    resetPathByData: function(dataOrId) {

    },

    /**
     * 计算世界坐标上的点worldPosition相对于当前场景的rootNode的相对位置
     */
    getRelatePosition: function(worldPosition) {
        var rootNode = this.sceneManager.getCurrentRootNode();
        if (!rootNode || !worldPosition) {
            return null;
        }
        var wm = new mono.Mat4(); //new出来就是一个单位矩阵
        wm.setPosition(worldPosition);
        var m1, m2;
        m1 = new mono.Mat4().getInverse(rootNode.worldMatrix.clone());
        m2 = new mono.Mat4().multiplyMatrices(m1, wm);
        var position = new mono.Vec3().getPositionFromMatrix(m2);
        return position;
    },

    /**
     * 根据fromNode或toNode获取其对应的rack
     */
    getRackNodeByNode: function(node) {
        if (!node) {
            return null;
        }
        var data = this.sceneManager.getNodeData(node);
        var category = this.sceneManager.dataManager.getCategoryForData(data);
        if (category && category.getId() == 'rack') {
            return node;
        } else if (category && category.getId() == 'equipment') {
            var parentNode = this.sceneManager.getNodeByDataOrId(data.getParentId());
            var resuleNode = this.getRackNodeByNode.call(this, parentNode);
            return resuleNode || node;
        }
        if (node.getClient('parentId')) {
            var equipmentNode = this.sceneManager.getNodeByDataOrId(node.getClient('parentId'));
            var resultNode = this.getRackNodeByNode.call(this, equipmentNode);
            return resultNode || equipmentNode || node;
        }
        return node;
    },

    /**
     * 计算中间的控制点
     * 注意：考虑世界坐标是一方面，还得考虑floor旋转的问题； 
     *
     */
    /*
    generateControls : function(linkNode,height){
        if(!linkNode){
            return null;
        }
        var fromNode = linkNode.getFromNode();
        var toNode = linkNode.getToNode();
        if(!fromNode || !toNode){
            return null;
        }
        var bb1 = fromNode.getBoundingBox(),bb2 = toNode.getBoundingBox();
        var w_from = fromNode.getWorldPosition();
        var w_to = toNode.getWorldPosition();
        var w_r_from = null,w_r_to = null; // 机柜的世界坐标
        var frNode = this.getRackNodeByNode(fromNode);
        var trNode = this.getRackNodeByNode(toNode);
        if (frNode && frNode.getBoundingBox) {
            bb1 = frNode.getBoundingBox();
            w_r_from = frNode.getWorldPosition();
        }
        if (trNode && trNode.getBoundingBox) {
            bb2 = trNode.getBoundingBox();
            w_r_to = trNode.getWorldPosition();
        }
        var maxZ = 20, maxY = Math.max(bb1.max.y,bb2.max.y) + 20 ;
        if (maxY < 50) {
            maxY = 50;
        }
        var pos1 = fromNode.frontWorldPosition(bb1.max.z + maxZ),pos2 = toNode.frontWorldPosition(bb2.max.z + maxZ);

        // if(frNode){
        //      w_from = frNode.getWorldPosition();
        // }
        // if (trNode){
        //      w_to = trNode.getWorldPosition();
        // }
        var controls = [];
        controls.push(pos1);
        var f_pos = pos1.clone().add(new mono.Vec3(0,maxY,0));
        if (w_r_from) {
            f_pos.setY(w_r_from.y + maxY);
        }
        controls.push(f_pos);
        f_pos = w_from.clone().add(new mono.Vec3(0,maxY,0));
        if (w_r_from) {
            // f_pos.setX(w_r_from.x);
            f_pos.setY(w_r_from.y + maxY);
        }
        controls.push(f_pos); //顶

        var w_max_y = Math.max(w_from.y,w_to.y);
        if (w_r_from) {
            w_max_y = Math.max(w_max_y,w_r_from.y);
        }
        if (w_r_to) {
            w_max_y = Math.max(w_max_y,w_r_to.y);
        }
        controls.push(new mono.Vec3(w_from.x, w_max_y + height, w_from.z));
        controls.push(new mono.Vec3(w_from.x, w_max_y + height, w_to.z));
        controls.push(new mono.Vec3(w_to.x, w_max_y + height, w_to.z));

        var t_pos = pos2.clone().add(new mono.Vec3(0,maxY,0));
        if (w_r_to) {
            // t_pos.setX(w_r_to.x);
            t_pos.setY(w_r_to.y + maxY);
             var toTop = w_to.clone().add(new mono.Vec3(0,maxY,0));
             toTop.setY(w_r_to.y + maxY)
             controls.push(toTop); //顶
        }else{
            controls.push(w_to.clone().add(new mono.Vec3(0,maxY,0))); //顶
        }
        controls.push(t_pos);
        controls.push(pos2);
        return controls;
    },
    */

    /**
     *
     * 设备（或设备端口）——机柜上的配电架 —— —— 到配线架——设备（设备端口）
     * 设备——设备正面——设备正面的上方（机柜上方）——机柜上方的背后——左或右——上——配线架——穿过配线架置——到其他的机柜的配线架
     * 备注：如果不是连到设备而是连到的是机柜的话(网络设备一般不会这么连)，那就直接从机柜的顶端连下去
     *
     */
    generateControlsWithMDF: function(linkNode, height) {
        if (!linkNode) {
            return null;
        }
        var fromNode = linkNode.getFromNode();
        var toNode = linkNode.getToNode();
        if (!fromNode || !toNode) {
            return null;
        }
        var controls = [];
        var f2MdfPoints = this.getNodeToMDFControls(fromNode);
        var t2MdfPoints = this.getNodeToMDFControls(toNode);
        if (f2MdfPoints && t2MdfPoints && f2MdfPoints.length > 0 && t2MdfPoints.length > 0) {
            for (var i = 0; i < f2MdfPoints.length; i++) {
                controls.push(f2MdfPoints[i]);
            }
            var fp = f2MdfPoints[f2MdfPoints.length - 1];
            var tp = t2MdfPoints[t2MdfPoints.length - 1];
            var fMdf2TMdfPoints = this.getInflectionPoints(fp, tp);
            if (fMdf2TMdfPoints && fMdf2TMdfPoints.length > 0) {
                for (var i = 0; i < fMdf2TMdfPoints.length; i++) {
                    controls.push(fMdf2TMdfPoints[i]);
                }
            }
            for (var i = t2MdfPoints.length - 1; i >= 0; i--) {
                controls.push(t2MdfPoints[i]);
            }
        }
        return controls;
    },

    /**
     * 根据机柜创建配线架
     * 按理说，这个配线架应该是一个单独的资产，一般放在机柜中
     * 如果是资产的话，处理起来就比较方便了
     */
    getMdfByRack: function(node) {
        if (!node) {
            return null;
        }
        var nodeData = this.sceneManager.getNodeData(node);
        if (!nodeData) {
            return null;
        }
        var mdfNode = this.mdfMap[nodeData.getId()];
        if (!mdfNode) {
            var bb = node.getBoundingBox();
            var size = bb.size() || {
                x: 60
            };
            var width = 55;
            var z = 0;
            var y = 0
            var mdfNode = new mono.Cube(width, 20, 3);
            if (bb) {
                width = bb.size().x;
                z = bb.max.z - 5;
                z = z + 5 //让配线架往前突一点
                    // y = bb.max.y + 40; //放在机柜顶上
                y = bb.max.y - 12; //放在机柜里
            }
            mdfNode.setPosition(0, y, z);
            mdfNode.setClient(it.SceneManager.CLIENT_EXT_VITUAL, true);
            // mdfNode.setStyle('m.type', 'phong');
            // mdfNode.setStyle('m.color', '#3D3D3D');
            // mdfNode.setStyle('m.ambient', '#3D3D3D');
            mdfNode.setStyle('front.m.texture.image', './images/mdf_front.jpg');
            mdfNode.setStyle('back.m.texture.image', './images/mdf_front.jpg');
            mdfNode.setClient('itv_mdf', true);
            mdfNode.setClient('itv_mdf_rack_data', nodeData);
            this.mdfMap[nodeData.getId()] = mdfNode;
        }
        mdfNode.setParent(node);
        this.sceneManager.network3d.dataBox.add(mdfNode);
        return mdfNode;
    },

    /**
     * 计算两个点之间的拐点
     * 标准的计算如下：
     * 如果pos1和pos2相同或只有一个分量不同时，那可以直接返回
     * 如果有两个分量不同时，只有两个分量不同时，那返回一个中间的点即可
     * 如果三个分量不同时，那返回两个拐点
     * 否则算出的controls会有重复的点
     */
    getInflectionPoints: function(pos1, pos2) {
        if (!pos1 || !pos2) {
            return null;
        }
        var p1 = pos1.clone();
        var p2 = pos2.clone();
        var differentCount = 0;
        var points = [];
        if (p1.x != p2.x) {
            differentCount++;
            // points.push(new mono.Vec3(p2.x,p1.y,p1.z));
        }
        if (p1.y != p2.y) {
            differentCount++;
            // points.push(new mono.Vec3(p2.x,p2.y,p1.z));
        }
        if (p1.z != p2.z) {
            differentCount++;
        }
        if (differentCount <= 1) {
            return null;
        }
        if (p1.x != p2.x && differentCount > 1) {
            differentCount--;
            points.push(new mono.Vec3(p2.x, p1.y, p1.z));
        }
        if (p1.y != p2.y && differentCount > 1) {
            differentCount--;
            points.push(new mono.Vec3(p2.x, p2.y, p1.z));
        }
        // 最后z不管一不一样都没有必要计算了
        return points;
    },

    getNodeToMDFControls: function(node) {
        if (!node) {
            return null;
        }
        var controls = [];
        var rackNode = this.getRackNodeByNode(node);
        var nodeBb = node.getBoundingBox();
        var nodeWorldPosition = node.getWorldPosition();
        var frontDistance = 20;
        var backDistance = 10;
        var aboveRackDistance = 50;
        var belowRackDistance = -23;
        if (rackNode && rackNode != node) {
            var mdfNode = this.getMdfByRack(rackNode);
            var rackbb = rackNode.getBoundingBox();
            var w_r_from = rackNode.getWorldPosition();
            var pos1 = node.frontWorldPosition(nodeBb.max.z + frontDistance);
            var nodePos = node.getWorldPosition();
            controls.push(pos1); //设备前方
            var f_pos = pos1.clone();
            // f_pos.setY(w_r_from.y + rackbb.max.y + topDistance);// 机柜的前上方
            f_pos.setY(w_r_from.y + rackbb.max.y + belowRackDistance); // 机柜的前上方。现在topDistance是负的，变成机柜里
            controls.push(f_pos);
            var topOffset = new mono.Vec3(0, rackbb.max.y + belowRackDistance, 0);
            if (pos1.x != nodePos.x) {
                if (pos1.x > nodePos.x) {
                    topOffset.x = -backDistance - 10;
                } else {
                    topOffset.x = backDistance + 10;
                }
            }
            if (pos1.z != nodePos.z) {
                if (pos1.z > nodePos.z) {
                    topOffset.z = -backDistance - 10;
                } else {
                    topOffset.z = backDistance + 10;
                }
            }
            f_pos = nodeWorldPosition.clone().add(topOffset);
            f_pos.setY(w_r_from.y + rackbb.max.y + belowRackDistance);

            controls.push(f_pos); //顶
            // 连到配线架上：
            if (mdfNode) {
                var mdfAbsoluteRotationY = mdfNode.getParent().getRotationY() * 180 / Math.PI;
                var offX = 20 * Math.random(),
                    offZ = 0;
                if (mdfAbsoluteRotationY % 90 == 0) {
                    offZ = 20 * Math.random();
                    offX = 0;
                }
                var mdfOffsetPos = new mono.Vec3(offX, 5, offZ); // 连到配线架上的偏移，为了今后连到配线架上的具体位置做准备
                var mdfPos = mdfNode.getWorldPosition().clone().add(mdfOffsetPos);
                var mdfFrontPos = mdfNode.frontWorldPosition(frontDistance); //配线架出到前方的位置
                var backPos = f_pos.clone();
                if (mdfFrontPos.x != mdfPos.x && mdfPos.z != backPos.z) {
                    backPos.setZ(mdfPos.z);
                    controls.push(backPos);
                } else if (mdfFrontPos.z != mdfPos.z && mdfPos.x != backPos.x) {
                    backPos.setX(mdfPos.x);
                    controls.push(backPos);
                }
                var backTopPos = backPos.clone();
                backTopPos.setY(mdfPos.y);
                controls.push(backTopPos); //顶上往上拐一点，拐到配线架的高度

                mdfFrontPos = mdfFrontPos.clone().add(mdfOffsetPos);

                var top2MdfPoints = this.getInflectionPoints(backTopPos, mdfPos);
                if (top2MdfPoints && top2MdfPoints.length > 0) {
                    for (var i = 0; i < top2MdfPoints.length; i++) {
                        controls.push(top2MdfPoints[i]);
                    }
                }
                controls.push(mdfFrontPos);
                mdfFrontPos = mdfFrontPos.clone().add(new mono.Vec3(0, aboveRackDistance, 0)); //连到配线架的上方
                controls.push(mdfFrontPos);
            } else {
                f_pos = f_pos.clone().add(new mono.Vec3(0, 43, 0)); //如果没有配线架的话，那就再往机柜上方走100
                controls.push(f_pos);
            }
        } else {
            var tPos = rackNode.getWorldPosition().clone().add(new mono.Vec3(0, nodeBb.max.y + 43, 0)); //如果没有配线架的话，那就再往机柜上方走100
            controls.push(tPos);
        }
        return controls;
    },


    /**
     * 计算中间的控制点
     * 注意：考虑世界坐标是一方面，还得考虑floor旋转的问题； 
     *
     */
    generateControlsWithOutHeight: function(linkNode, height) {
        if (!linkNode) {
            return null;
        }
        var fromNode = linkNode.getFromNode();
        var toNode = linkNode.getToNode();
        if (!fromNode || !toNode) {
            return null;
        }
        var bb1 = fromNode.getBoundingBox(),
            bb2 = toNode.getBoundingBox();
        var w_from = fromNode.getWorldPosition();
        var w_to = toNode.getWorldPosition();
        var w_r_from = null,
            w_r_to = null; // 机柜的世界坐标
        var frNode = this.getRackNodeByNode(fromNode);
        var trNode = this.getRackNodeByNode(toNode);
        if (frNode && frNode.getBoundingBox) {
            bb1 = frNode.getBoundingBox();
            w_r_from = frNode.getWorldPosition();
        }
        if (trNode && trNode.getBoundingBox) {
            bb2 = trNode.getBoundingBox();
            w_r_to = trNode.getWorldPosition();
        }
        var maxZ = 20,
            maxY = Math.max(bb1.max.y, bb2.max.y) + 20;
        if (maxY < 50) {
            maxY = 50;
        }
        // var pos1 = fromNode.frontWorldPosition(bb1.max.z + maxZ);
        var pos1 = fromNode.worldPosition(new mono.Vec3(0, 0, -1), bb1.max.z + maxZ); //背面出
        var pos2 = toNode.frontWorldPosition(bb2.max.z + maxZ); //正面进
        // var pos2 = toNode.worldPosition(new mono.Vec3(0,0,-1),bb2.max.z + maxZ);

        var controls = [];
        controls.push(pos1);
        // var f_pos = pos1.clone().add(new mono.Vec3(0,maxY,0));
        // if (w_r_from) {
        //     f_pos.setY(w_r_from.y + maxY);
        // }
        // controls.push(f_pos);
        // f_pos = w_from.clone().add(new mono.Vec3(0,maxY,0)); 
        // if (w_r_from) {
        // f_pos.setX(w_r_from.x);
        // f_pos.setY(w_r_from.y + maxY);
        // }
        // controls.push(f_pos); //顶

        var w_max_y = Math.max(w_from.y, w_to.y);
        if (w_r_from) {
            w_max_y = Math.max(w_max_y, w_r_from.y);
        }
        if (w_r_to) {
            w_max_y = Math.max(w_max_y, w_r_to.y);
        }
        if (w_max_y != pos1.y) {
            controls.push(new mono.Vec3(pos1.x, w_max_y, pos1.z));
        }
        controls.push(new mono.Vec3(pos1.x, w_max_y, pos2.z));
        if (w_max_y != pos2.y) {
            controls.push(new mono.Vec3(pos2.x, w_max_y, pos2.z));
        }

        // var t_pos = pos2.clone().add(new mono.Vec3(0,maxY,0));
        // if (w_r_to) {
        //     // t_pos.setX(w_r_to.x);
        //     t_pos.setY(w_r_to.y + maxY);
        //      var toTop = w_to.clone().add(new mono.Vec3(0,maxY,0));
        //      toTop.setY(w_r_to.y + maxY)
        //      controls.push(toTop); //顶
        // }else{
        //     controls.push(w_to.clone().add(new mono.Vec3(0,maxY,0))); //顶
        // }
        // controls.push(t_pos);
        controls.push(pos2);
        return controls;
    },

    /**
     * 鼠标滑过Link时变粗(高亮)
     * @param node
     * @param network
     * @param data
     * @param element
     * @param event
     */
    handleMouseMoveElement: function(node, network, data, element, event) {
        var link = this.sceneManager.getLinkData(node);
        if (!link) {
            return;
        }
        if (!node.org_radius && node.setRadius) { // 注意已经划过加粗后，没有去掉之前再划
            var radius = node.getRadius() || 1;
            node.org_radius = node.getRadius();
            node.setRadius(radius + 1);
        }
        this._flagLink = node;
    },

    handleMouseMoveBackground: function(network, event) {
        if (this._flagLink && this._flagLink.org_radius) {
            this._flagLink.setRadius(this._flagLink.org_radius);
            delete this._flagLink.org_radius;
            this._flagLink = null;
        }
    },

    /**
     * 让link流动起来
     * @param link link的3D对象，id或者it.Link
     * @param neg 流动的方向
     */
    doFlow: function(link, neg) {
        if (!link) {
            return;
        }
        var linkNode = null;
        var id = link;
        if (link instanceof mono.Element) {
            linkNode = link;
            var linkData = this.sceneManager.getLinkData(linkNode);
            id = linkData.getId();
        } else {
            if (link instanceof it.Link) {
                id = link.getId();
            }
            linkNode = this.sceneManager.linkMap[id];
        }
        if (linkNode) {
            var flipx = true;
            if (neg == false) {
                flipx = false;
            }
            // linkNode.setStyle('m.texture.image','./images/link_flow.jpg');
            // linkNode.setStyle('m.texture.repeat',new mono.Vec2(100, 1));
            if (!linkNode.styleMap['m.texture.image']) {
                return;
            }
            linkNode.setStyle('m.texture.flipX', flipx);
            var animate = this.animates[id];
            if (!animate) {
                animate = new mono.Animate({
                    from: 0,
                    to: 1,
                    type: 'number',
                    dur: 500,
                    repeat: Number.POSITIVE_INFINITY,
                    reverse: false,
                    onUpdate: function(value) {
                        linkNode.setStyle('m.texture.offset', new mono.Vec2(value, 0));
                    }
                });
                this.animates[id] = animate;
            }
            animate.play();
        }
    },

    /**
     * 清除流动效果
     * @param linkOrId
     */
    clearFlow: function(linkOrId) {
        if (!linkOrId) {
            return;
        }
        var id = linkOrId;
        if (linkOrId instanceof it.Link) {
            id = linkOrId.getId();
        }
        var animate = this.animates[id];
        if (animate) {
            if (animate instanceof Array) {

            } else {
                animate.stop();
            }
            delete this.animates[id];
        }
    },

    /**
     * 清除所有的流动效果
     */
    clearAllFlow: function() {
        // if (!this.animates) {
        //     return;
        // }
        // for (var id in this.animates) {
        //     var animate = this.animates[id];
        //     if (animate) {
        //         if (animate instanceof Array) {
        //         } else {
        //             animate.stop();
        //         }
        //         delete this.animates[id];
        //     }
        // }
        this.stopAllAnimates();
    },
    // animate, 连线上的动画：

    /**
     * 流动的billboard的图片
     */
    getImage: function() {
        return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAKTWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVN3WJP3Fj7f92UPVkLY8LGXbIEAIiOsCMgQWaIQkgBhhBASQMWFiApWFBURnEhVxILVCkidiOKgKLhnQYqIWotVXDjuH9yntX167+3t+9f7vOec5/zOec8PgBESJpHmomoAOVKFPDrYH49PSMTJvYACFUjgBCAQ5svCZwXFAADwA3l4fnSwP/wBr28AAgBw1S4kEsfh/4O6UCZXACCRAOAiEucLAZBSAMguVMgUAMgYALBTs2QKAJQAAGx5fEIiAKoNAOz0ST4FANipk9wXANiiHKkIAI0BAJkoRyQCQLsAYFWBUiwCwMIAoKxAIi4EwK4BgFm2MkcCgL0FAHaOWJAPQGAAgJlCLMwAIDgCAEMeE80DIEwDoDDSv+CpX3CFuEgBAMDLlc2XS9IzFLiV0Bp38vDg4iHiwmyxQmEXKRBmCeQinJebIxNI5wNMzgwAABr50cH+OD+Q5+bk4eZm52zv9MWi/mvwbyI+IfHf/ryMAgQAEE7P79pf5eXWA3DHAbB1v2upWwDaVgBo3/ldM9sJoFoK0Hr5i3k4/EAenqFQyDwdHAoLC+0lYqG9MOOLPv8z4W/gi372/EAe/tt68ABxmkCZrcCjg/1xYW52rlKO58sEQjFu9+cj/seFf/2OKdHiNLFcLBWK8ViJuFAiTcd5uVKRRCHJleIS6X8y8R+W/QmTdw0ArIZPwE62B7XLbMB+7gECiw5Y0nYAQH7zLYwaC5EAEGc0Mnn3AACTv/mPQCsBAM2XpOMAALzoGFyolBdMxggAAESggSqwQQcMwRSswA6cwR28wBcCYQZEQAwkwDwQQgbkgBwKoRiWQRlUwDrYBLWwAxqgEZrhELTBMTgN5+ASXIHrcBcGYBiewhi8hgkEQcgIE2EhOogRYo7YIs4IF5mOBCJhSDSSgKQg6YgUUSLFyHKkAqlCapFdSCPyLXIUOY1cQPqQ28ggMor8irxHMZSBslED1AJ1QLmoHxqKxqBz0XQ0D12AlqJr0Rq0Hj2AtqKn0UvodXQAfYqOY4DRMQ5mjNlhXIyHRWCJWBomxxZj5Vg1Vo81Yx1YN3YVG8CeYe8IJAKLgBPsCF6EEMJsgpCQR1hMWEOoJewjtBK6CFcJg4Qxwicik6hPtCV6EvnEeGI6sZBYRqwm7iEeIZ4lXicOE1+TSCQOyZLkTgohJZAySQtJa0jbSC2kU6Q+0hBpnEwm65Btyd7kCLKArCCXkbeQD5BPkvvJw+S3FDrFiOJMCaIkUqSUEko1ZT/lBKWfMkKZoKpRzame1AiqiDqfWkltoHZQL1OHqRM0dZolzZsWQ8ukLaPV0JppZ2n3aC/pdLoJ3YMeRZfQl9Jr6Afp5+mD9HcMDYYNg8dIYigZaxl7GacYtxkvmUymBdOXmchUMNcyG5lnmA+Yb1VYKvYqfBWRyhKVOpVWlX6V56pUVXNVP9V5qgtUq1UPq15WfaZGVbNQ46kJ1Bar1akdVbupNq7OUndSj1DPUV+jvl/9gvpjDbKGhUaghkijVGO3xhmNIRbGMmXxWELWclYD6yxrmE1iW7L57Ex2Bfsbdi97TFNDc6pmrGaRZp3mcc0BDsax4PA52ZxKziHODc57LQMtPy2x1mqtZq1+rTfaetq+2mLtcu0W7eva73VwnUCdLJ31Om0693UJuja6UbqFutt1z+o+02PreekJ9cr1Dund0Uf1bfSj9Rfq79bv0R83MDQINpAZbDE4Y/DMkGPoa5hpuNHwhOGoEctoupHEaKPRSaMnuCbuh2fjNXgXPmasbxxirDTeZdxrPGFiaTLbpMSkxeS+Kc2Ua5pmutG003TMzMgs3KzYrMnsjjnVnGueYb7ZvNv8jYWlRZzFSos2i8eW2pZ8ywWWTZb3rJhWPlZ5VvVW16xJ1lzrLOtt1ldsUBtXmwybOpvLtqitm63Edptt3xTiFI8p0in1U27aMez87ArsmuwG7Tn2YfYl9m32zx3MHBId1jt0O3xydHXMdmxwvOuk4TTDqcSpw+lXZxtnoXOd8zUXpkuQyxKXdpcXU22niqdun3rLleUa7rrStdP1o5u7m9yt2W3U3cw9xX2r+00umxvJXcM970H08PdY4nHM452nm6fC85DnL152Xlle+70eT7OcJp7WMG3I28Rb4L3Le2A6Pj1l+s7pAz7GPgKfep+Hvqa+It89viN+1n6Zfgf8nvs7+sv9j/i/4XnyFvFOBWABwQHlAb2BGoGzA2sDHwSZBKUHNQWNBbsGLww+FUIMCQ1ZH3KTb8AX8hv5YzPcZyya0RXKCJ0VWhv6MMwmTB7WEY6GzwjfEH5vpvlM6cy2CIjgR2yIuB9pGZkX+X0UKSoyqi7qUbRTdHF09yzWrORZ+2e9jvGPqYy5O9tqtnJ2Z6xqbFJsY+ybuIC4qriBeIf4RfGXEnQTJAntieTE2MQ9ieNzAudsmjOc5JpUlnRjruXcorkX5unOy553PFk1WZB8OIWYEpeyP+WDIEJQLxhP5aduTR0T8oSbhU9FvqKNolGxt7hKPJLmnVaV9jjdO31D+miGT0Z1xjMJT1IreZEZkrkj801WRNberM/ZcdktOZSclJyjUg1plrQr1zC3KLdPZisrkw3keeZtyhuTh8r35CP5c/PbFWyFTNGjtFKuUA4WTC+oK3hbGFt4uEi9SFrUM99m/ur5IwuCFny9kLBQuLCz2Lh4WfHgIr9FuxYji1MXdy4xXVK6ZHhp8NJ9y2jLspb9UOJYUlXyannc8o5Sg9KlpUMrglc0lamUycturvRauWMVYZVkVe9ql9VbVn8qF5VfrHCsqK74sEa45uJXTl/VfPV5bdra3kq3yu3rSOuk626s91m/r0q9akHV0IbwDa0b8Y3lG19tSt50oXpq9Y7NtM3KzQM1YTXtW8y2rNvyoTaj9nqdf13LVv2tq7e+2Sba1r/dd3vzDoMdFTve75TsvLUreFdrvUV99W7S7oLdjxpiG7q/5n7duEd3T8Wej3ulewf2Re/ranRvbNyvv7+yCW1SNo0eSDpw5ZuAb9qb7Zp3tXBaKg7CQeXBJ9+mfHvjUOihzsPcw83fmX+39QjrSHkr0jq/dawto22gPaG97+iMo50dXh1Hvrf/fu8x42N1xzWPV56gnSg98fnkgpPjp2Snnp1OPz3Umdx590z8mWtdUV29Z0PPnj8XdO5Mt1/3yfPe549d8Lxw9CL3Ytslt0utPa49R35w/eFIr1tv62X3y+1XPK509E3rO9Hv03/6asDVc9f41y5dn3m978bsG7duJt0cuCW69fh29u0XdwruTNxdeo94r/y+2v3qB/oP6n+0/rFlwG3g+GDAYM/DWQ/vDgmHnv6U/9OH4dJHzEfVI0YjjY+dHx8bDRq98mTOk+GnsqcTz8p+Vv9563Or59/94vtLz1j82PAL+YvPv655qfNy76uprzrHI8cfvM55PfGm/K3O233vuO+638e9H5ko/ED+UPPR+mPHp9BP9z7nfP78L/eE8/sl0p8zAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAANuSURBVHjahFfZjhMxEKyZca49ACEE38D/fwovSIinXZBgEeLYDZmMD16qV5XCWSJZdhzHXd3Vl4fWGp74DLIe+X2Q32JdZa/ZgMzw78mEtTPCJwKAzaMJGwimyF0j91pPVjqj8WAajgIi9idZN7FENktUO3dijf8BGGWsDMQoa9d+kXWW35vT1QPgwlcEmghAR4++zLOZQCDWae4HybhuFBr7a47QPtn3EAhZj0ZZWCmbUz5aoHXMPVDIRkYA2PG7XxwmnwEcxEru3FXBJDHhZKhD2y0FrmQdltEwDAB73nPkUN5BWkYFoE41mfCNaLwFcCnrjYRkCDkKRXtaws9kAV6UAljIrUTYFsAFgGsAVwS145mgYQbwR6gazTdmyx0VwJAsucAsEBTsADwD8JzzlVABXv5gEZJJSZG9JNFQwgmnDg0r4/+Sgp8JgJXE/kQLHQH8pIAD+Z55RxZ/ifwwJIv7SQBEqK0J4ILjinOYeUPLvATwG8B7WmNLEGHJcErNro9hWEWj0SJiLf6wo6A39IctAb3ifAvgE89dSERoiENTcnDiBWawIhSZcAXgBYC3AF5Ldhxp0l80eVCXrHZMPQBeIqdOMRqkqs08u7M0fgfgozij+pXfFXMdrVKFh/oFGsd3AD5wDtAFwFcA32xPU2/pleXkJjEg6rEL9xYAN3S8a3G2L5L5FgtDHVWormOvRsvhzMsfOM+84IEg7nj+B7U/SEKaCWSxVF29H1B+mghfRPMAkSRKbumQDcBnAN95ZmY47mmRLNaoMgBgTFZMIlcf6fGhwZGXh6+sKeAdw25PK+wB3HPsCSaLNXOvI6pycZFqlSWTaQgV8h4F50YcLrS/l2I0SxIqlopLsiiIvF34h6nT6QbIoCMog/QC4TPhC7P4wklEJPP8qGwT/zCdoahX2YpoeuA4CoBskdACQLVqWCl8sJa6Ss2fJLuFAlk6okWAzBZVet9jFHgLrcKKaJ6lEWmW6dQK6rzOfxU5GPgyGqwhTZKWozfQSpk66buYty8WzqWTHf+5CJLJlPsm8Z/FclUskd3DO6NZ5h1S51FSJDKULwWgNWLwLscENsuAJ88ApQDWHw72KIXlg3PPrSp9YO1offoSeuJ17Fqi0z+2M69kfQmdeyF334Y494zuvG7Vm0ejqp0T6J+/AwD8jcgy4QZSjAAAAABJRU5ErkJggg==';
    },

    /**
     * 创建光点的billboard
     */
    createLightBillboard: function() {
        var billboard = new mono.Billboard();
        billboard.s({
            // 'm.texture.image': '../theme/models/light.png',
            'm.texture.image': this.getImage(),
            'm.transparent': true,
            'm.opacity': 1.0,
        });
        billboard.setScale(35, 35, 35);
        return billboard;
    },

    getAnimateDur: function() {
        return 2500;
    },

    /**
     * 创建一段动画
     */
    createLinkAnimate: function(lightBillboard, linkNode) {
        if (!lightBillboard || !linkNode) {
            return null;
        }
        if (!(linkNode instanceof mono.PathLink)) {
            return null;
        }
        var self = this;
        var animate = new mono.Animate({
            from: 0,
            to: 1,
            type: 'number',
            dur: self.getAnimateDur(),
            // repeat:Number.POSITIVE_INFINITY,
            // reverse: false,
            onUpdate: function(value) {
                // linkNode.setStyle('m.texture.offset', new mono.Vec2(value, 0));
                var position = linkNode.getPointAt(value);
                lightBillboard.p(position.x, position.y, position.z);
            }
        });
        return animate;
    },

    /**
     * 播放一系列连线的动画
     *  @links 这是连线的数组，并且需要有先后顺序，link的顺序是倒过来的
     *  需要根据links来创建一个动画链，链从起始开始
     */
    playAnimateByLinks: function(links) {
        if (!links) {
            return;
        }
        if (!(links instanceof Array)) {
            return this.playAnimate(links);
        }
        if (links.length < 1) {
            return;
        }
        var bid = links[0].getId(); //用终点的id来创建lightBillboard
        var lightBillboard = this.lightBillboardMap[bid];
        if (!lightBillboard) {
            lightBillboard = this.createLightBillboard();
            this.lightBillboardMap[bid] = lightBillboard;
        }
        var startAnimate = null,
            preAnimate = null,
            animates = [];
        for (var i = links.length - 1; i >= 0; i--) {
            var linkNode = this.sceneManager.linkMap[links[i].getId()];
            var animate = this.createLinkAnimate(lightBillboard, linkNode);
            if (!animate) {
                continue;
            }
            if (!startAnimate) {
                startAnimate = animate;
            }
            if (!preAnimate) {
                preAnimate = animate;
            } else {
                preAnimate.chain(animate);
                preAnimate = animate;
            }
            animates.push(animate);
        }
        if (preAnimate != startAnimate) {
            preAnimate.chain(startAnimate);
        }else{ // 表示就一条线
            if(!startAnimate){
                return;
            }
            startAnimate.repeat = Number.POSITIVE_INFINITY;
            startAnimate.reverse = false;
        }
        if (startAnimate) {
            this.box3D.add(lightBillboard);
            this.animates[bid] = animates;
            startAnimate.play();
        }
    },

    /**
     * 播放一条线上的动画
     */
    playAnimate: function(link) {
        if (!link) {
            return;
        }
        if (link instanceof Array) {
            return this.playAnimateByLinks(link);
        }
        var bid = link.getId();
        var lightBillboard = this.lightBillboardMap[bid];
        if (!lightBillboard) {
            lightBillboard = this.createLightBillboard();
            this.lightBillboardMap[bid] = lightBillboard;
        }
        var self = this;
        var linkNode = this.sceneManager.linkMap[bid];
        if (!linkNode || !(linkNode instanceof mono.PathLink)) {
            return;
        }
        this.box3D.add(lightBillboard);
        var animate = new mono.Animate({
            from: 0,
            to: 1,
            type: 'number',
            dur: self.getAnimateDur(),
            repeat: Number.POSITIVE_INFINITY,
            reverse: false,
            onUpdate: function(value) {
                // linkNode.setStyle('m.texture.offset', new mono.Vec2(value, 0));
                var position = linkNode.getPointAt(value);
                lightBillboard.p(position.x, position.y, position.z);
            }
        });
        animate.play();
        this.animates[bid] = animate;
    }

});

it.GCSManager = $GCSManager;

/**
 *
 * 节点信息的数据结构
 *   注意：有可能一个节点有多个父亲，据说对于网络设备，可能存在多个对外的网络端口
 *
 */
var $LNode = function(dataId) {
    this.id = dataId || ''; // 资产ID
    this.parent = null; //LNode
    this.parents = [];
    this.children = new mono.List(); // 
    this.toParentLink = null;
    this.toParentLinks = [];
};

mono.extend($LNode, Object, {

    setParent: function(parent) {
        this.parent = parent;
    },

    addChildren: function(datas) {
        if (!datas || datas.length < 1) {
            return;
        }
        for (var i = 0; i < datas.length; i++) {
            var data = datas[i];
            this.addChild(data);
        }
    },

    addChildren: function(child) {
        if (child && !this.children.contains(child)) {
            this.children.add(data); //这个list竟然不去重，
        }
    },

});

var $LinkManager = function(sceneManager) {
    this.sceneManager = sceneManager;
    this.linkMap = null;
};

mono.extend($LinkManager, Object, {

    /**
     *
     * 计算link树，否则找一个完整的链路要遍历所有的links数遍（也就是n遍，n=链路上的节点数，并且查任何链路都是这样，每次也是这么多）
     *
     */
    computeLinkTree: function() {
        this.linkMap = {}; //链路的节点信息，跟链路的对应关系
        var links = this.sceneManager.dataManager.getLinks();
        if (!links || links.length < 1) {
            return;
        }
        for (var i = 0; i < links.length; i++) {
            var link = links[i];
            if (!link) {
                continue;
            }
            var fId = link.getFromId();
            var tId = link.getToId();
            var fTreeData = this.linkMap[fId];
            var tTreeData = this.linkMap[tId];
            if (!fTreeData) {
                fTreeData = new $LNode(fId);
                fTreeData.parent = null;
                this.linkMap[fId] = fTreeData;
            }
            if (!tTreeData) {
                tTreeData = new $LNode(tId);
                tTreeData.toParentLink = link;
                tTreeData.parent = fTreeData;
                this.linkMap[tId] = tTreeData;
            }
             // 处理多个from连到一个to上的情况
            if (!tTreeData.parents.includes(fTreeData)) {
                tTreeData.parents.push(fTreeData);
            }
            tTreeData.toParentLinks.push(link);
        }
    },

    /**
     * 组织父子关系
     */
    setParentAndChildren: function(lNode) {
        if (!lNode) {
            return null;
        }
        var parentId = lNode.parent && lNode.parent.id;
        if (parentId) {
            var parentLNode = this.linkMap[parentId];
            if (parentLNode) {
                parentLNode.addChild(lNode);
            }
        }
        var children = this.getChildren(lNode.id);
        data.addChildren(children);
    },

    getChildren: function(pId) {
        var childArray = [];
        if (!pId) {
            return childArray;
        }
        for (var id in this.linkMap) {
            var lNode = this.linkMap[id];
            if (lNode.parent && lNode.parent.id === pId) {
                childArray.push(lNode);
            }
        }
        return childArray;
    },

    cloneArray : function(array){
        if (!array) {
            return [];
        }
        var newArray = [];
        for(var i = 0 ; i < array.length ; i++){
            newArray.push(array[i]);
        }
        return newArray;
    },

    /**
     * 根据dataId找连到它的所有的连线
     * 注意：1、有环路的情况，免得接下来的地方出现死循环的问题
     *      2、需要考虑多条链路的情况。到了某条节点时可能会存在分列的情况，此时又会分列
     */
    getMulLinksByDataId: function(dataOrId, objs, childLink, scope) {
        scope = scope || this;
        if (!dataOrId || !this.linkMap) {
            return null;
        }
        var dataId = dataOrId;
        if (dataOrId instanceof it.Data) {
            dataId = dataId.getId();
        }
        var lNode = this.linkMap[dataId];
        if (!lNode) {
            return null;
        }
        objs = objs || [];
        if (!childLink) {
           childLink = [];
           objs.push(childLink);
        }
        if (!lNode.toParentLinks || lNode.toParentLinks.length < 1) {
            return null;
        }
        if (lNode.toParentLinks.length > 1) {
            for (var i = 1; i < lNode.toParentLinks.length; i++) { //从1开始哦，第一个继续用来扩展第一个分支
                var newChildLink = scope.cloneArray(childLink);
                var cLink = lNode.toParentLinks[i];
                if(newChildLink.includes(cLink)){ // 避免死循环
                    continue;
                }
                objs.push(newChildLink);
                newChildLink.push(cLink);
                scope.getMulLinksByDataId(cLink.getFromId(), objs, newChildLink, scope);
            }
        }
        var cLink0 = lNode.toParentLinks[0];
        if(childLink.includes(cLink0)){ // 避免死循环
            return objs;
        }
        // 不管有多少个，第0个总是要加进去的，放到最后是因为放到前面copy的会包含不必要的links[0]
        childLink.push(cLink0);
        var parentId = cLink0.getFromId();
        if (parentId) {
            scope.getMulLinksByDataId(parentId, objs, childLink,scope);
        }
        return objs;
    },

    /**
     * 根据dataId找连到它的一根连线
     * 注意：1、有环路的情况，免得接下来的地方出现死循环的问题
     */
    getLinksByDataId: function(dataOrId, scope) {
        scope = scope || this;
        if (!dataOrId || !this.linkMap) {
            return null;
        }
        var dataId = dataOrId;
        if (dataOrId instanceof it.Data) {
            dataId = dataId.getId();
        }
        var lNode = this.linkMap[dataId];
        if (!lNode) {
            return null;
        }
        var result = [];
        if (lNode.toParentLink) {
            result.push(lNode.toParentLink);
        }
        var ancestorLinks = scope.getLinksByDataId(lNode.parent && lNode.parent.id);
        if (ancestorLinks && ancestorLinks.length > 0) {
            for (var i = 0; i < ancestorLinks.length; i++) {
                result.push(ancestorLinks[i]);
            }
        }
        return result;
    },

});
/**
 * 管理Data显示Tooltip的规则
 * sceneId 保留字段，用于多场景呈现的管理，目前先不用。
 */
it.TooltipRule = function(parameters){
	parameters = parameters || {};
	this._id = parameters.id || this.randomId();
    this._customerId = parameters.customerId || ""; //用户扩展
	this._categoryId = parameters.categoryId || "";
	this._dataTypeId = parameters.dataTypeId || "";
    this._sceneId = parameters.sceneId || ""; 
	this._propertiesDesc = parameters.propertiesDesc || "";
	this._extInfo = parameters.extInfo || {};
    this._mul = parameters.mul||false;
    this._withCloseDiv = parameters.withCloseDiv||false;//是否在上面加上一个关闭按钮
};

mono.extend(it.TooltipRule,it.Base,{
    ___accessor:['customerId','categoryId','mul',"dataTypeId","sceneId","propertiesDesc",'extInfo','withCloseDiv'],
    getId : function(){
    	return this._id;
    },

    randomId : function(){
    	return mono.id("tooltipRule");
    },
});
it.TooltipManager = function (sceneManager) {
    this.sceneManager = sceneManager;
    this.dataManager = sceneManager.dataManager;
    this._tooltipRules = [];
    this._tooltipRuleMap = {};
    this._lastData = null;
    this._tooltipDivCreator = new it.TooltipDivCreator();
    this.tooltipContentFunction = null;
    this.toolTipMap = {}; //用于存放“多例”(也就是同时可以显示那些tooltip)
    this.network3d = this.sceneManager.network3d;
    this.box3D = this.network3d.getDataBox();
    this.enableMulforTooltip = false; //如果开启的话，则多例(如：显示所有floors)时是显示的tooltip，默认是flase，配置后字体贴在墙上
    this.textNodeMap = {};
    this.init();
};

mono.extend(it.TooltipManager, it.EventHandler, {

    init: function () {
        var self = this;

        //创建textNode
        this.sceneManager.addSceneManagerChangeListener(function (eve) {
            if (eve.kind == 'add' && (eve.data instanceof mono.Element)) {
                if (self.enableMulforTooltip) {
                    self.createToolTipForNode(eve.data);
                } else {
                    self.createTextNodeForFloor(eve.data);
                }
            }
        });

        //当场景发生变化时，决定哪些TestNode隐藏，哪些显示
        // this.sceneManager.addSceneChangeListener(function (ele) {
        //     self.sceneChangeListener();
        // });
        this.sceneManager.cameraManager.addAfterPlayCameraListener(function (ele) {
            self.sceneChangeListener();
        });

    },
    /**
     * 这块工作后面要交给一个TooltipDivCreator.js来处理，本类应该只处理数据部分，
     * 数据和视图分离，可以实现用户对于样式的定制。
     */
    _createTooltipDiv: function (id) {
        var tooltipDiv = this._tooltipDivCreator.createTooltipDiv(id);
        tooltipDiv.style.position = "absolute";
        tooltipDiv.style.display = "none";
        return tooltipDiv;
    },

    setTooltipDivCreator: function (value) {
        if (value == null) {
            return;
        }
        if (this._tooltipDivCreator !== value) {
            this._tooltipDivCreator = value;
            this.destoryTooltipDiv();
        }
    },

    getTooltipDivCreator: function () {
        return this._tooltipDivCreator;
    },

    destoryTooltipDiv: function () {
        this._tooltipDiv = null;
    },

    getTooltipDiv: function () {
        if (this._tooltipDiv == null) {
            this._tooltipDiv = this._createTooltipDiv();
            var network = this.sceneManager.network3d;
            this._tooltipDivCreator.addToNetwork(network, this._tooltipDiv);
        }
        return this._tooltipDiv;
    },

    hideToolTipDiv: function () {
        var tooltip = this.getTooltipDiv();
        tooltip.style.display = "none";
    },

    showTooltipDiv: function (content, data, node) {
        // this.hideToolTipDiv(); //显示前先隐藏，add by Kevin 2017-06-14
        var tooltip = this.getTooltipDiv();
        tooltip.style.display = "";
        var withCloseDiv = false;
        if (content.tooltipRule && content.tooltipRule.getWithCloseDiv()) {
            withCloseDiv = content.tooltipRule.getWithCloseDiv();
        }
        this._tooltipDivCreator.setTooltipData(content, tooltip);
        if (withCloseDiv) {
            this.addCloseDivForTooltip(tooltip);
        }
        this.computeTooltipDivPosition(data,null, node);
    },

    addCloseDivForTooltip: function(tooltipDiv) {
        if (!tooltipDiv) {
            return;
        }
        var closeDiv = document.createElement('DIV');
        closeDiv.className = 'close';
        closeDiv.style = "float: right;";//position: static;
        var self = this;
        closeDiv.onclick = function(e) {
            tooltipDiv.style.display = "none";
            self._lastData = null;
        }
        tooltipDiv.appendChild(closeDiv);
        return closeDiv;
    },

    onRenderCallback: function (network) {
        this.computeTooltipDivPosition();
        if (this.enableMulforTooltip) {
            this.cameraChangeListener();
        }
    },

    /**
     * 根据node重新计算billboard的位置，像楼层的billboard。也可以给客户扩充用
     * @param node
     * @param x
     * @param y
     * @param z
     * @returns {TGL.Vec3}
     */
    generateTooltipPosition: function (node, x, y, z) {
        if (!node) {
            return new mono.Vec3(x, y, z);
        }
        var data = this.sceneManager.getNodeData(node);
        if (!data) {
            return new mono.Vec3(x, y, z);
        }
        var type = this.dataManager.getDataTypeForData(data);
        var category = this.dataManager.getCategoryForDataType(type);
        var position = node.getPosition();
        if (category && category.getId().indexOf('floor') >= 0) { //如果是楼层的话才这么计算
            if (!data.getPosition()) return new mono.Vec3(x, y, z);
            var dataHeight = data.getPosition().y;
            var parent = this.dataManager.getDataById(data.getParentId());
            if (parent) {
                var children = parent.getChildren();
                if (children && children.size() > 0) {
                    var minY = 0, maxY = 0;
                    children.forEach(function (child) {
                        var y = child.getPosition().y;
                        if (y < minY) {
                            minY = y;
                        }
                        if (y > maxY) {
                            maxY = y;
                        }
                    });
                    if (minY != maxY) {
                        var x1, y1, z1;
                        var bb = node.getBoundingBox();
                        var dz = (bb.max.z - bb.min.z) / 2; //对于floor的billboard往前移
                        z1 = position.z + dz;
                        var width = bb.max.x - bb.min.x;
                        var dw = width / (children.size() + 1);
                        x1 = parseInt((dataHeight - minY) / ((maxY - minY) / children.size())) * dw + dw / 2 - width / 2;
                        // y1 = position.y - 250;
                        y1 = position.y + (bb.max.y + bb.min.y) / 2 + bb.size().y / 2;
                        return new mono.Vec3(x1, y1, z1);
                    }
                }
            }
        }
        return new mono.Vec3(x, y, z);
    },

    computeTooltipDivPosition: function (data, tooltipDiv, targetNode) {
        var tooltip = tooltipDiv || this.getTooltipDiv();
        data = data || this._lastData;
        targetNode = targetNode || this._lastNode;
        if (!tooltip || !data) {
            return;
        }
        var sm = this.sceneManager;
        var node = sm.getNodeForDataOrId(data);
        node = this.getTooltipDivPositionNode(data, node, targetNode);
        var boundingBox = node.getBoundingBox?node.getBoundingBox():null;
        var position = node.getWorldPosition();
        // var x = position.x + boundingBox.center().x, y = position.y + boundingBox.max.y, z = position.z + boundingBox.center().z;
        var x = position.x,y = position.y , z = position.z;
        if (boundingBox) {
            x = x +  boundingBox.center().x;
            y = y +  boundingBox.max.y;
            z = z + boundingBox.center().z;
        };
        var newPos = this.generateTooltipPosition(node, x, y, z);
        if (newPos) {
            x = newPos.x || x;
            y = newPos.y || y;
            z = newPos.z || z;
        }
        var position2d = this.sceneManager.network3d.getViewPosition(new mono.Vec3(x, y, z)),
            offsetLeft = position2d.x,
            offsetTop = position2d.y;
        var style = $Util.getComputedStyle(tooltip);
        // 不应该是绝对于浏览器，若是Network的div有top和left的话就有问题
        offsetLeft = offsetLeft - parseInt(style.width) / 2;
        offsetTop = offsetTop - parseInt(style.height) - 10;

        //获取tooltip内层的包裹元素，并将其设置滚动条
        //如果tip高度大于最大高度300,则设置滚动条
        //获取滚动条宽度
        var scrollBarWidth = getScrollBarWidth();
        var tooltipInnerWrapper = tooltip.children[0];
        if(parseInt(style.height) > 300){
            tooltipInnerWrapper.style.overflowY = 'auto';
            tooltipInnerWrapper.style.height = 300+'px';
            tooltip.style.top = position2d.y - 330 + "px";
            tooltip.style.left = offsetLeft - scrollBarWidth/2 + "px";
        }else{
            tooltip.style.top = offsetTop + "px";
            tooltip.style.left = offsetLeft + "px";
        }
        
        //获取滚动条宽度
        function getScrollBarWidth(){
            var oP = document.createElement('p'),
            styles = {
                width: '100px',
                height: '100px',
            },
            cWidth1,cWidth2,sWidth;
            for(var i in styles){
                oP.style[i] = styles[i]
            };
            document.body.appendChild(oP);
            cWidth1 = oP.clientWidth;
            oP.style.overflowY = 'scroll';
            cWidth2 = oP.clientWidth;
            sWidth = cWidth1 - cWidth2;
            oP.remove();
            return sWidth;
        }

    },

    /**
     * 返回需要显示 tooltip 的 node 节点
     * @param data 选中的 data
     * @param node 选中的 data 对应的 node
     * @param targetNode 鼠标当前指向的 node
     * @returns {*}
     */
    getTooltipDivPositionNode:function(data, node, targetNode){
        // return node||targetNode;
        // update by Kevin 2017-06-14 如果是地球targetNode是billboard，进入园区退回后node是dc的复杂对象
        return targetNode || node;
    },

    getCustomerIdByNode: function (node) { //给用户自己扩展
        return '';
    },

    /**
     * 根据node创建tooltip的内容
     * @param node
     * @param isMul 只判断"多例"（表示同时可以显示多个，每个div只属于其自己的，不共享）的规则
     * @returns {*}
     *
     * 备注：node有可能是临时创建的，如空间可视化时的彩色方块，如果想通过这种配置的方式在这些对象上加上tooltip比较难搞，让用户
     *    重写tooltipContentFunction那还不如让重新写一套，因此这里做一下改进：
     *    在获取data时加了一层getDataFromNode，甚至是一下子直接获取"categoryId"(加上引号是因为可以不是真正的categoryId)，
     *    用户可以重写这个方法，返回的值和注册的id对应上即可
     */
    getTooltipContent: function (node, isMul) {
        if (this.tooltipContentFunction) {
            return this.tooltipContentFunction(node);
        }
        if (!node) {
            return;
        }
        if (node instanceof mono.Billboard && node.getStyle('m.opacity') && node.getStyle('m.opacity') < 0.3) {
            return;
        }
        var customerId = '', categoryId = '', dataTypeId = '';
        if (this.getCustomerIdByNode) {
            customerId = this.getCustomerIdByNode(node);
        }
        var currentScene = this.sceneManager._currentScene;
        var sm = this.sceneManager;
        var dm = this.dataManager;
        var data = sm.getNodeData(node);
        if (data) {
            var category = dm.getCategoryForData(data);
            var dataType = dm.getDataTypeForData(data);
            if (dataType) {
                categoryId = category ? category.getId() : "";
                dataTypeId = dataType.getId();
            }
        }
        var matchCustomer, matchDataType, matchCategory, matchAll, i = 0, tooltipRule;
        for (; i < this._tooltipRules.length; i++) {
            tooltipRule = this._tooltipRules[i];
            if (isMul && !tooltipRule.getMul()) {
                continue;
            }
            if (!isMul && tooltipRule.getMul()) {
                continue;
            }
            if (currentScene 
                && tooltipRule.getSceneId() 
                && currentScene.getId() != tooltipRule.getSceneId()) { // rule上有sceneId，也需要判断的
                continue;
            }
            if (tooltipRule.getCustomerId()
                && tooltipRule.getCustomerId() === customerId && !matchCustomer) {
                matchCustomer = tooltipRule;
            }
            if (tooltipRule.getDataTypeId()
                && tooltipRule.getDataTypeId() === dataTypeId && !matchDataType) {
                matchDataType = tooltipRule;
            }
            if (tooltipRule.getCategoryId()
                && tooltipRule.getCategoryId() === categoryId
                && !matchCategory) {
                matchCategory = tooltipRule;
            }
            if (!tooltipRule.getDataTypeId()
                && !tooltipRule.getCategoryId()
                && !tooltipRule.getCustomerId()) {
                matchAll = tooltipRule;
            }
        }
        if (matchCustomer) {
            return this._getTooltipContent(node, data, matchCustomer);
        } else if (matchDataType) {
            return this._getTooltipContent(node, data, matchDataType);
        } else if (matchCategory) {
            return this._getTooltipContent(node, data, matchCategory);
        } else if (matchAll) {
            return this._getTooltipContent(node, data, matchAll);
        }
    },

    _getDataFieldValue: function (node, data, field) {
        if (!data) {
            return "";
        }
        return data.getValue(field);
    },

    _getTooltipContent: function (node, data, tooltipRule) {
        var result = {};
        var propertiesDesc = tooltipRule.getPropertiesDesc();
        var propertiesDescArray = propertiesDesc.split("@@");
        if (propertiesDescArray.length) {
            for (var i = 0; i < propertiesDescArray.length; i++) {
                var propertyDesc = propertiesDescArray[i];
                var propertyDescArray = propertyDesc.split(":");
                if (propertyDescArray.length === 2) {
                    var label = propertyDescArray[0];
                    var field = propertyDescArray[1];
                    var value = this._getDataFieldValue(node, data, field);
                    result[label] = value || '';
                }
            }
        }
        var extInfo = tooltipRule.getExtInfo();
        if (typeof(extInfo) == 'function') {
            extInfo = extInfo(node, data);
        } else {
            extInfo = $Util.translateJson(extInfo);
        }
        if (extInfo instanceof Array) {
            // 其实这个array中的col也可能是个function
            extInfo.tooltipRule = tooltipRule;
            return extInfo;
        }else{
            if (extInfo) {
            for (var p in extInfo) {
                var info = extInfo[p];
                if (typeof(info) == 'function') {
                    result[p] = info(node, data);
                } else {
                    result[p] = info;
                }
            }
           }
           result.tooltipRule = tooltipRule;
           return result;
        }
    },

    addTooltipRule: function (tooltipRule) {
        var id = tooltipRule.getId();
        if (!this._tooltipRuleMap[id]) {
            this._tooltipRules.push(tooltipRule);
            this._tooltipRuleMap[id] = tooltipRule;
        }
    },

    removeTooltipRule: function (tooltipRule) {
        var id = tooltipRule.getId();
        if (this._tooltipRuleMap[id]) {
            var index = this._tooltipRules.indexOf(tooltipRule);
            if (index) {
                this._tooltipRules.splice(index, 1);
            }
            delete this._tooltipRuleMap[id];
        }
    },

    handleMouseMoveElement: function (node, network, data, element, event) {
        if (event._mousedown) {
            return;
        }
        var content = this.getTooltipContent(node);
        if (content == null) {
            this._lastData = null;
            this._lastNode = node;
            this.hideToolTipDiv();
            return;
        }
        var self = this;
        if (this._lastNode == node) {
            return;
        } else {
            clearTimeout(this._tooltipTimer);
            self._lastData = data;
            self._lastNode = node;
            this._tooltipTimer = setTimeout(function () {
               // self._lastData = data;
                self.showTooltipDiv(content, data, node);
            }, 200); //TODO 500 改成可以配置
        }
    },

    handleMouseMoveBackground: function (network, event) {
        this.hideToolTipDiv();
        this._lastData = null;
    },

    /**
     * 清除多例的tooltip
     */
    clearToolTipMap: function () {
        if (!this.toolTipMap) {
            return;
        }
        for (var id in this.toolTipMap) {
            var toolObj = this.toolTipMap[id];
            if (!toolObj) {
                continue;
            }
            $('#' + toolObj.id).remove();
        }
    },

    /**
     * 根据Element创建一个新的Tooltip，该tooltip不是单例，它只归element所有
     * 注意：由于该tip和Element绑定，所以element的显示隐藏也应该对改tip做处理
     * @param element
     */
    createToolTipForNode: function (element) {
        if (!element) {
            return;
        }
        var data = null;
        if (element instanceof it.Data) {
            data = element;
        } else {
            data = this.sceneManager.getNodeData(element);
        }
        if (!data) {
            return;
        }
        var content = this.getTooltipContent(element, true);
        if (!content) {
            return;
        }
        var id = "tooltip" + data.getId();
        var tipPane = null;
        if (this.toolTipMap[data.getId()]) {
            tipPane = document.getElementById(id);
        }else{
            this.toolTipMap[data.getId()] = {id: id, rule: content.tooltipRule,element:element};
            tipPane = this._createTooltipDiv(id);
            this._tooltipDivCreator.addToNetwork(this.sceneManager.network3d, tipPane);
        }
        if (tipPane) {
            tipPane.style.display = "block";
            var withCloseDiv = false;
            if (content.tooltipRule) { //setTooltipData 可能会将content的rule给删掉
                withCloseDiv = content.tooltipRule.getWithCloseDiv();
            }
            this._tooltipDivCreator.setTooltipData(content, tipPane);
            if (withCloseDiv) {
                this.addCloseDivForTooltip(tooltip);
            }
            this.computeTooltipDivPosition(data, tipPane);
        }
    },

    //对于楼层来讲创建div的tooltip的效果不是很好
    cameraChangeListener: function () {
        if (!this.toolTipMap) {
            return;
        }
        for (var id in this.toolTipMap) {
            var toolObj = this.toolTipMap[id];
            var element = toolObj.element;
            if (!toolObj) {
                continue;
            }
            var tooltipId = toolObj.id;
            var rule = toolObj.rule;
            if (tooltipId.startsWith('tooltip')) {
                var id = tooltipId.substring(7, tooltipId.length);
                var data = this.dataManager.getDataById(id);
                var node = this.sceneManager.getNodeByDataOrId(data);
                if (!data || !node) {
                    continue;
                }
                var tipPane = document.getElementById(tooltipId);
                if (!tipPane) {
                    continue;
                }
                var currentScene = this.sceneManager.getCurrentScene();
                if (rule.getSceneId()
                    && currentScene
                    && rule.getSceneId() != currentScene.getId()) {
                    tipPane.style.display = "none";
                    continue;
                }
                // 判断是否可见，这样(node.isVisible())不太准确，因为存在许多的visibleFilter，所以的判断每个visibleFilter,
                // 得在viewManager中封装一把
                if (!node
//                    || !node.isVisible()
                    || !this.sceneManager.viewManager3d.isVisible(node)
                    || !this.box3D.getDataById(node.getId())) { //当node不可见时，其对应的tooltip也要隐藏掉
                    tipPane.style.display = "none";
                    continue;
                }
                tipPane.style.display = "";
                if (element) {
                    var content = this.getTooltipContent(element, true);
                    if (content) {
                        var withCloseDiv = rule.getWithCloseDiv();
                        this._tooltipDivCreator.setTooltipData(content, tipPane);
                        if (withCloseDiv) {
                            this.addCloseDivForTooltip(tooltip);
                        }
                    }
                }
                this.computeTooltipDivPosition(data, tipPane);
            }
        }
    },

    getRuleByData : function(dataOrId,isMul){
        if (!dataOrId) {
            return;
        }
        var sm = this.sceneManager;
        var dm = this.dataManager;
        var data = null;
        if(dataOrId instanceof it.Data){
            data = dataOrId
        }else if(dataOrId instanceof it.Link){
            data = dataOrId
        }else {
            data = dm.getDataById(dataOrId);
        }
        if (!data) {
            return;
        }
        var category = dm.getCategoryForData(data);
        var dataType = dm.getDataTypeForData(data);
        if (dataType == null) {
            return;
        }
        var categoryId = category ? category.getId() : "";
        var dataTypeId = dataType.getId();
        var matchDataType, matchCategory, matchAll, i = 0, tooltipRule;
        for (; i < this._tooltipRules.length; i++) {
            tooltipRule = this._tooltipRules[i];
            if (isMul && !tooltipRule.getMul()) {
                continue;
            }
            if (!isMul && tooltipRule.getMul()) {
                continue;
            }
            if (tooltipRule.getDataTypeId() === dataTypeId && !matchDataType) {
                matchDataType = tooltipRule
            }
            if (categoryId && tooltipRule.getCategoryId() === categoryId && !matchCategory) {
                matchCategory = tooltipRule;
            }
            if (!tooltipRule.getDataTypeId() && !tooltipRule.getCategoryId()) {
                matchAll = tooltipRule;
            }
        }
        if (matchDataType) {
            return matchDataType;
        } else if (matchCategory) {
            return matchCategory;
        } else if (matchAll) {
            return matchAll;
        }
        return null;
    },

    computeTextNodePosition : function(node,fontLength){
        if(!node){
            return null;
        }
        var data = this.sceneManager.getNodeData(node);
        this.sceneManager.setParentRelationShip(data); // 因为派发_sceneManagerChangeDispatcher时并没有设置其位置等信息
        this.sceneManager.translatePosition(data);
        var fontLength = fontLength || 0;
        var boundingBox = node.getBoundingBox();
        var nodeWorldPos = it.Util.getNodeCenterPosition(node);
        var x = nodeWorldPos.x;
        var y = nodeWorldPos.y;
        var z = nodeWorldPos.z;

        if(boundingBox){
            x = x + (boundingBox.max.x-boundingBox.min.x)/2 - fontLength;
            z = z + (boundingBox.max.z -boundingBox.min.z)/2+5;
        }
        var height = boundingBox.max.y - boundingBox.min.y;
        y = height/2;

        var pz = z+50; //先加上50，以免z已经贴到了墙上
        //这里面的x,y,z不能是相对的(如果对象的中心点不是放在世界坐标的中心的话)，应该要弄成绝对的位置
        var obj = this.getElementsByPosition(x,y,pz);
        if(obj && obj.length > 0){
            var minDis = null;
            for (var i = 0; i < obj.length; i++) {
                var ele = obj[i];
                if (ele
//                    && this.sceneManager.getNodeData(ele) == data //应该还要判断node的data==ele的data
                    && ele.distance) {
                    if (!minDis || minDis > ele.distance) {
                        minDis = ele.distance;
                    }
                }
            }
            if (minDis) {
                z = pz - minDis;
            }
        }
        return {x: x, y: y, z: z};

    },

    // 若是该点在某物体内部最终判断的结果也是没有相交(1会出现这个问题),如果采用direction.sub(origin)减了一把后此问题就不存在了
    getElementsByPosition: function (x, y, z) {
        var origin = new mono.Vec3(x, y, z);
        var up = new mono.Vec3(0, 1, 0);
        var direction = new mono.Vec3(x, y, -1);
        var camera = this.network3d.getCamera();
//            var picking = new mono.Picking(origin,direction.normalize(), up);// 1.it is ok if origin is (0,0,0)
        var picking = new mono.Picking(origin, direction.sub(origin).normalize(), up, camera.getNear(), camera.getFar(), this.network3d);
        var intersects = new mono.List();
        intersects.addAll(this.box3D.getNodes());
//        intersects.addAll(network3d.getDataBox().getBillboards());
        var elements = picking.intersectObjects(intersects.toArray(), true, false);
        return elements;
    },


    /**
     * textNode的偏移量
     * @param node
     * @returns {null}
     */
    getTextNodeOffset: function (node) {
        return null;
    },

    /**
     * 给楼层创建label
     * @param element
     */
    createTextNodeForFloor: function (element) {
        if (!element) {
            return;
        }
        var data = null;
        if (element instanceof it.Data) {
            data = element;
        } else {
            data = this.sceneManager.getNodeData(element);
        }
        if (!data) {
            return;
        }
        var category = this.sceneManager.dataManager.getCategoryForData(data);
        if (!category || category.getId().toLowerCase().indexOf('floor') < 0) {
            return;
        }
        var rule = this.getRuleByData(data, true);
        if (!rule) {
            return;
        }
        var label = data.getId();
        var textNode = this.textNodeMap[label];
        if (!textNode) {
            if (label) {
                var textNode = new mono.TextNode(label, null, 100, 'helvetiker', 'bold');
                textNode.setStyle('m.texture.image', '../images/yellow.png');
                textNode.setStyle('m.type', 'phong');
                var scale = 1;
                textNode.setScale(scale, scale, scale * 0.1);
                textNode.setSelectable(false);
                textNode.setParent(element);
                var boundingBox = element.getBoundingBox();
                var x = element.getPositionX();
                var z = element.getPositionZ();
                var y = element.getPositionY();
                var fontLength = 0;
                var fontHeight = 0;
                var tnBoundingBox = textNode.getBoundingBox();
                if (tnBoundingBox) {
                    fontLength = tnBoundingBox.max.x - tnBoundingBox.min.x;
                    fontHeight = tnBoundingBox.max.y - tnBoundingBox.min.y;
                }
//                var txtPos = this.computeTextNodePosition(element,fontLength);
                if (boundingBox) {
                    x = boundingBox.max.x - fontLength;
//                    z = boundingBox.max.z+10;
                    z = boundingBox.max.z + 5;
                }
                var height = boundingBox.max.y - boundingBox.min.y;
//                if(fontHeight){
//                    y = height+fontHeight-30;
//                }
                y = height / 2;

                var offset = this.getTextNodeOffset(data);
                if (offset) {
                    if (offset.x) {
                        x = x + offset.x;
                    }
                    if (offset.y) {
                        y = y + offset.y;
                    }
                }

                var pz = z + 50; //先加上50，以免z已经贴到了墙上
                //这里面的x,y,z不能是相对的(如果对象的中心点不是放在世界坐标的中心的话)，应该要弄成绝对的位置
                var obj = this.getElementsByPosition(x, y, pz);
                if (obj && obj.length > 0) {
                    var minDis = null;
                    for (var i = 0; i < obj.length; i++) {
                        var ele = obj[i];
                        if (ele && ele.distance) {
                            if (!minDis || minDis > ele.distance) {
                                minDis = ele.distance;
                            }
                        }
                    }
                    if (minDis) {
                        z = pz - minDis;
                    }
                }

                if (offset && offset.z) {
                    if (offset.z) {
                        z = z + offset.z;
                    }
                }

                textNode.setPosition(x, y, z);
                this.textNodeMap[label] = textNode;
                textNode.setVisible(false);
                this.box3D.add(textNode);
                textNode.rule = rule;
            }
        }
    },

    sceneChangeListener: function () {
        if (this.textNodeMap) {
            for (var id in this.textNodeMap) {
                var textNode = this.textNodeMap[id];
                //在什么场景下才显示出来呢？也通过rule来控制，可是显示的内容也通过配置方式么，不过至少是否显示，并显示在哪里可以这么来控制
                var rule = textNode.rule;
                var currentScene = this.sceneManager.getCurrentScene();
                if (rule.getSceneId()
                    && currentScene
                    && rule.getSceneId() != currentScene.getId()) {
                    textNode.setVisible(false);
                    continue;
                }
                var node = this.sceneManager.getNodeByDataOrId(id);
                if (!node
//                    || !node.isVisible()
                    || !this.sceneManager.viewManager3d.isVisible(node)
                    || !this.box3D.getDataById(node.getId())) { //当node不可见时，其对应的tooltip也要隐藏掉
                    textNode.setVisible(false);
                    continue;
                }
                if (!this.box3D.getDataById(textNode.getId())) {
                    this.box3D.add(textNode);
                }
                textNode.setVisible(true);
            }
        }

        //切换场景时，先要要将之前场景中的tooltip隐藏掉。有个问题，tooltip的显示也是有延时的，有可能scene已经Change了，但是tooltip还没有显示出来
        if (this._tooltipTimer) {
            clearTimeout(this._tooltipTimer);
        }
        this.hideToolTipDiv();
    }


});
/**
 * 创建TooltipDiv的类,本类需要引用tooltip.css.
 */
it.TooltipDivCreator = function (argument) {
};

mono.extend(it.TooltipDivCreator, Object, {
    createTooltipDiv: function (id) {
        var tooltipDiv = document.createElement('DIV');
        tooltipDiv.className = "tooltip-panel";
        if (id) {
            tooltipDiv.id = id;
        }
        return tooltipDiv
    },

    addToNetwork: function (network, tooltipDiv) {
        network.getRootView().appendChild(tooltipDiv);
    },

    setTooltipData: function(content, tooltipDiv) {

        //清除tootip的默认style行间样式
        tooltipDiv.style = '';

        this._removeAllChildren(tooltipDiv);
        if (!content) return;
        delete content.tooltipRule;

        //创建一个tableWrapper，并将该div设置滚动条
        var tableWrapper = document.createElement('div');
        tooltipDiv.appendChild(tableWrapper);

        var table = document.createElement('table');
        var tbody = document.createElement('tbody');
        tableWrapper.appendChild(table);
        table.appendChild(tbody);
        if (content instanceof Array) { //以表格的方式显示
            var headerList = content.header;
            if (headerList) {
                var headerRow = this._createTableRow(headerList,true);
                tbody.appendChild(headerRow);
            }
            for(var i = 0 ; i < content.length ; i++){
                var rowData = content[i];
                var row = this._createTableRow(rowData);
                tbody.appendChild(row);
            }
        } else {
            for (var p in content) {
                if (typeof content[p] == 'object') {
                    var v = content[p].value;
                    var onclick = content[p].onclick;
                    var row = this._createRow(p, v, onclick);
                    tbody.appendChild(row);
                } else {
                    var row = this._createRow(p, content[p]);
                    tbody.appendChild(row);
                }
            }
        }
    },

    _createTableRow : function(rowData,isHeader){
        var row = document.createElement('tr');
        if (rowData instanceof Array) {
            for(var i = 0 ; i < rowData.length ; i++){
                var data = rowData[i];
                var col = this._createColumn(data,isHeader);
                row.appendChild(col);
            }
        }else {
            for(var p in rowData){
                var data = rowData[p];
                var col = this._createColumn(data,isHeader);
                row.appendChild(col);
            }
        }
        return row;
    },

    _createColumn : function(data,isHeader){
        var column = document.createElement('td');
        if (isHeader) {
            // column.className = "tooltip-key";
            column.style = "width: 60px;text-align:center;";
        }else{
            column.className = "tooltip-value";
            column.style = "text-align:center;";
        }
        if (data.className) {
            column.className = data.className;
        }
        if (data.style) {
            column.style = data.style;
        }
        var text = data;
        if (data.hasOwnProperty('value')) {
            text = data.value;
        }else if(data.hasOwnProperty('text')){
            text = data.text;
        }
        if (data.onclick) {
            column.onclick = data.onclick;
        }
        column.innerHTML = text;
        return column;
    },

    _createRow: function (key, value, onclick) {
        var row = document.createElement('tr');
        var columnKey = document.createElement('td');
        columnKey.className = "tooltip-key";
        columnKey.innerHTML = key + ":";
        var columnValue = document.createElement('td');
        var cn = "tooltip-value";
        if(onclick){
            cn += ' tooltip-value-btn'
        }
        columnValue.className = cn;
        columnValue.innerHTML = value;
        row.appendChild(columnKey);
        row.appendChild(columnValue);
        columnValue.onclick = onclick;
        return row;
    },

    _removeAllChildren: function (node) {
        while (node.hasChildNodes()) {
            node.removeChild(node.lastChild);
        }
    },
});

(function(window){
    var Framebuffer, Heights, Node, Shader, Texture, WebGLHeatmap, fragmentShaderBlit, nukeVendorPrefix, textureFloatShims, vertexShaderBlit,
        __indexOf = [].indexOf || function (item) {
            for (var i = 0, l = this.length; i < l; i++) {
                if (i in this && this[i] === item) return i;
            }
            return -1;
        };

    nukeVendorPrefix = function () {
        var getExtension, getSupportedExtensions, vendorRe, vendors;
        if (window.WebGLRenderingContext != null) {
            vendors = ['WEBKIT', 'MOZ', 'MS', 'O'];
            vendorRe = /^WEBKIT_(.*)|MOZ_(.*)|MS_(.*)|O_(.*)/;
            getExtension = WebGLRenderingContext.prototype.getExtension;
            WebGLRenderingContext.prototype.getExtension = function (name) {
                var extobj, match, vendor, _i, _len;
                match = name.match(vendorRe);
                if (match !== null) {
                    name = match[1];
                }
                extobj = getExtension.call(this, name);
                if (extobj === null) {
                    for (_i = 0, _len = vendors.length; _i < _len; _i++) {
                        vendor = vendors[_i];
                        extobj = getExtension.call(this, vendor + '_' + name);
                        if (extobj !== null) {
                            return extobj;
                        }
                    }
                    return null;
                } else {
                    return extobj;
                }
            };
            getSupportedExtensions = WebGLRenderingContext.prototype.getSupportedExtensions;
            return WebGLRenderingContext.prototype.getSupportedExtensions = function () {
                var extension, match, result, supported, _i, _len;
                supported = getSupportedExtensions.call(this);
                result = [];
                for (_i = 0, _len = supported.length; _i < _len; _i++) {
                    extension = supported[_i];
                    match = extension.match(vendorRe);
                    if (match !== null) {
                        extension = match[1];
                    }
                    if (__indexOf.call(result, extension) < 0) {
                        result.push(extension);
                    }
                }
                return result;
            };
        }
    };

    textureFloatShims = function () {
        var checkColorBuffer, checkFloatLinear, checkSupport, checkTexture, createSourceCanvas, getExtension, getSupportedExtensions, name, shimExtensions, shimLookup, unshimExtensions, unshimLookup, _i, _len;
        createSourceCanvas = function () {
            var canvas, ctx, imageData;
            canvas = document.createElement('canvas');
            canvas.width = 2;
            canvas.height = 2;
            ctx = canvas.getContext('2d');
            imageData = ctx.getImageData(0, 0, 2, 2);
            imageData.data.set(new Uint8ClampedArray([0, 0, 0, 0, 255, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255]));
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        };
        createSourceCanvas();
        checkFloatLinear = function (gl, sourceType) {
            var buffer, cleanup, fragmentShader, framebuffer, positionLoc, program, readBuffer, result, source, sourceCanvas, sourceLoc, target, vertexShader, vertices;
            program = gl.createProgram();
            vertexShader = gl.createShader(gl.VERTEX_SHADER);
            gl.attachShader(program, vertexShader);
            gl.shaderSource(vertexShader, 'attribute vec2 position;\nvoid main(){\n    gl_Position = vec4(position, 0.0, 1.0);\n}');
            gl.compileShader(vertexShader);
            if (!gl.getShaderParameter(vertexShader, gl.COMPILE_STATUS)) {
                throw gl.getShaderInfoLog(vertexShader);
            }
            fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
            gl.attachShader(program, fragmentShader);
            gl.shaderSource(fragmentShader, 'uniform sampler2D source;\nvoid main(){\n    gl_FragColor = texture2D(source, vec2(1.0, 1.0));\n}');
            gl.compileShader(fragmentShader);
            if (!gl.getShaderParameter(fragmentShader, gl.COMPILE_STATUS)) {
                throw gl.getShaderInfoLog(fragmentShader);
            }
            gl.linkProgram(program);
            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                throw gl.getProgramInfoLog(program);
            }
            gl.useProgram(program);
            cleanup = function () {
                gl.deleteShader(fragmentShader);
                gl.deleteShader(vertexShader);
                gl.deleteProgram(program);
                gl.deleteBuffer(buffer);
                gl.deleteTexture(source);
                gl.deleteTexture(target);
                gl.deleteFramebuffer(framebuffer);
                gl.bindBuffer(gl.ARRAY_BUFFER, null);
                gl.useProgram(null);
                gl.bindTexture(gl.TEXTURE_2D, null);
                return gl.bindFramebuffer(gl.FRAMEBUFFER, null);
            };
            target = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, target);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 2, 2, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            framebuffer = gl.createFramebuffer();
            gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, target, 0);
            sourceCanvas = createSourceCanvas();
            source = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, source);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, sourceType, sourceCanvas);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            vertices = new Float32Array([1, 1, -1, 1, -1, -1, 1, 1, -1, -1, 1, -1]);
            buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);
            positionLoc = gl.getAttribLocation(program, 'position');
            sourceLoc = gl.getUniformLocation(program, 'source');
            gl.enableVertexAttribArray(positionLoc);
            gl.vertexAttribPointer(positionLoc, 2, gl.FLOAT, false, 0, 0);
            gl.uniform1i(sourceLoc, 0);
            gl.drawArrays(gl.TRIANGLES, 0, 6);
            readBuffer = new Uint8Array(4 * 4);
            gl.readPixels(0, 0, 2, 2, gl.RGBA, gl.UNSIGNED_BYTE, readBuffer);
            result = Math.abs(readBuffer[0] - 127) < 10;
            cleanup();
            return result;
        };
        checkTexture = function (gl, targetType) {
            var target;
            target = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, target);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 2, 2, 0, gl.RGBA, targetType, null);
            if (gl.getError() === 0) {
                gl.deleteTexture(target);
                return true;
            } else {
                gl.deleteTexture(target);
                return false;
            }
        };
        checkColorBuffer = function (gl, targetType) {
            var check, framebuffer, target;
            target = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, target);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 2, 2, 0, gl.RGBA, targetType, null);
            framebuffer = gl.createFramebuffer();
            gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, target, 0);
            check = gl.checkFramebufferStatus(gl.FRAMEBUFFER);
            gl.deleteTexture(target);
            gl.deleteFramebuffer(framebuffer);
            gl.bindTexture(gl.TEXTURE_2D, null);
            gl.bindFramebuffer(gl.FRAMEBUFFER, null);
            if (check === gl.FRAMEBUFFER_COMPLETE) {
                return true;
            } else {
                return false;
            }
        };
        shimExtensions = [];
        shimLookup = {};
        unshimExtensions = [];
        checkSupport = function () {
            var canvas, extobj, gl, halfFloatExt, halfFloatTexturing, singleFloatExt, singleFloatTexturing;
            canvas = document.createElement('canvas');
            gl = null;
            try {
                gl = canvas.getContext('experimental-webgl');
                if (gl === null) {
                    gl = canvas.getContext('webgl');
                }
            } catch (_error) {
            }
            if (gl != null) {
                singleFloatExt = gl.getExtension('OES_texture_float');
                if (singleFloatExt === null) {
                    if (checkTexture(gl, gl.FLOAT)) {
                        singleFloatTexturing = true;
                        shimExtensions.push('OES_texture_float');
                        shimLookup.OES_texture_float = {
                            shim: true
                        };
                    } else {
                        singleFloatTexturing = false;
                        unshimExtensions.push('OES_texture_float');
                    }
                } else {
                    if (checkTexture(gl, gl.FLOAT)) {
                        singleFloatTexturing = true;
                        shimExtensions.push('OES_texture_float');
                    } else {
                        singleFloatTexturing = false;
                        unshimExtensions.push('OES_texture_float');
                    }
                }
                if (singleFloatTexturing) {
                    extobj = gl.getExtension('WEBGL_color_buffer_float');
                    if (extobj === null) {
                        if (checkColorBuffer(gl, gl.FLOAT)) {
                            shimExtensions.push('WEBGL_color_buffer_float');
                            shimLookup.WEBGL_color_buffer_float = {
                                shim: true,
                                RGBA32F_EXT: 0x8814,
                                RGB32F_EXT: 0x8815,
                                FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT: 0x8211,
                                UNSIGNED_NORMALIZED_EXT: 0x8C17
                            };
                        } else {
                            unshimExtensions.push('WEBGL_color_buffer_float');
                        }
                    } else {
                        if (checkColorBuffer(gl, gl.FLOAT)) {
                            shimExtensions.push('WEBGL_color_buffer_float');
                        } else {
                            unshimExtensions.push('WEBGL_color_buffer_float');
                        }
                    }
                    extobj = gl.getExtension('OES_texture_float_linear');
                    if (extobj === null) {
                        if (checkFloatLinear(gl, gl.FLOAT)) {
                            shimExtensions.push('OES_texture_float_linear');
                            shimLookup.OES_texture_float_linear = {
                                shim: true
                            };
                        } else {
                            unshimExtensions.push('OES_texture_float_linear');
                        }
                    } else {
                        if (checkFloatLinear(gl, gl.FLOAT)) {
                            shimExtensions.push('OES_texture_float_linear');
                        } else {
                            unshimExtensions.push('OES_texture_float_linear');
                        }
                    }
                }
                halfFloatExt = gl.getExtension('OES_texture_half_float');
                if (halfFloatExt === null) {
                    if (checkTexture(gl, 0x8D61)) {
                        halfFloatTexturing = true;
                        shimExtensions.push('OES_texture_half_float');
                        halfFloatExt = shimLookup.OES_texture_half_float = {
                            HALF_FLOAT_OES: 0x8D61,
                            shim: true
                        };
                    } else {
                        halfFloatTexturing = false;
                        unshimExtensions.push('OES_texture_half_float');
                    }
                } else {
                    if (checkTexture(gl, halfFloatExt.HALF_FLOAT_OES)) {
                        halfFloatTexturing = true;
                        shimExtensions.push('OES_texture_half_float');
                    } else {
                        halfFloatTexturing = false;
                        unshimExtensions.push('OES_texture_half_float');
                    }
                }
                if (halfFloatTexturing) {
                    extobj = gl.getExtension('EXT_color_buffer_half_float');
                    if (extobj === null) {
                        if (checkColorBuffer(gl, halfFloatExt.HALF_FLOAT_OES)) {
                            shimExtensions.push('EXT_color_buffer_half_float');
                            shimLookup.EXT_color_buffer_half_float = {
                                shim: true,
                                RGBA16F_EXT: 0x881A,
                                RGB16F_EXT: 0x881B,
                                FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT: 0x8211,
                                UNSIGNED_NORMALIZED_EXT: 0x8C17
                            };
                        } else {
                            unshimExtensions.push('EXT_color_buffer_half_float');
                        }
                    } else {
                        if (checkColorBuffer(gl, halfFloatExt.HALF_FLOAT_OES)) {
                            shimExtensions.push('EXT_color_buffer_half_float');
                        } else {
                            unshimExtensions.push('EXT_color_buffer_half_float');
                        }
                    }
                    extobj = gl.getExtension('OES_texture_half_float_linear');
                    if (extobj === null) {
                        if (checkFloatLinear(gl, halfFloatExt.HALF_FLOAT_OES)) {
                            shimExtensions.push('OES_texture_half_float_linear');
                            return shimLookup.OES_texture_half_float_linear = {
                                shim: true
                            };
                        } else {
                            return unshimExtensions.push('OES_texture_half_float_linear');
                        }
                    } else {
                        if (checkFloatLinear(gl, halfFloatExt.HALF_FLOAT_OES)) {
                            return shimExtensions.push('OES_texture_half_float_linear');
                        } else {
                            return unshimExtensions.push('OES_texture_half_float_linear');
                        }
                    }
                }
            }
        };
        if (window.WebGLRenderingContext != null) {
            checkSupport();
            unshimLookup = {};
            for (_i = 0, _len = unshimExtensions.length; _i < _len; _i++) {
                name = unshimExtensions[_i];
                unshimLookup[name] = true;
            }
            getExtension = WebGLRenderingContext.prototype.getExtension;
            WebGLRenderingContext.prototype.getExtension = function (name) {
                var extobj;
                extobj = shimLookup[name];
                if (extobj === void 0) {
                    if (unshimLookup[name]) {
                        return null;
                    } else {
                        return getExtension.call(this, name);
                    }
                } else {
                    return extobj;
                }
            };
            getSupportedExtensions = WebGLRenderingContext.prototype.getSupportedExtensions;
            WebGLRenderingContext.prototype.getSupportedExtensions = function () {
                var extension, result, supported, _j, _k, _len1, _len2;
                supported = getSupportedExtensions.call(this);
                result = [];
                for (_j = 0, _len1 = supported.length; _j < _len1; _j++) {
                    extension = supported[_j];
                    if (unshimLookup[extension] === void 0) {
                        result.push(extension);
                    }
                }
                for (_k = 0, _len2 = shimExtensions.length; _k < _len2; _k++) {
                    extension = shimExtensions[_k];
                    if (__indexOf.call(result, extension) < 0) {
                        result.push(extension);
                    }
                }
                return result;
            };
            return WebGLRenderingContext.prototype.getFloatExtension = function (spec) {
                var candidate, candidates, half, halfFramebuffer, halfLinear, halfTexture, i, importance, preference, result, single, singleFramebuffer, singleLinear, singleTexture, use, _j, _k, _l, _len1, _len2, _len3, _len4, _m, _ref, _ref1, _ref2;
                if (spec.prefer == null) {
                    spec.prefer = ['half'];
                }
                if (spec.require == null) {
                    spec.require = [];
                }
                if (spec.throws == null) {
                    spec.throws = true;
                }
                singleTexture = this.getExtension('OES_texture_float');
                halfTexture = this.getExtension('OES_texture_half_float');
                singleFramebuffer = this.getExtension('WEBGL_color_buffer_float');
                halfFramebuffer = this.getExtension('EXT_color_buffer_half_float');
                singleLinear = this.getExtension('OES_texture_float_linear');
                halfLinear = this.getExtension('OES_texture_half_float_linear');
                single = {
                    texture: singleTexture !== null,
                    filterable: singleLinear !== null,
                    renderable: singleFramebuffer !== null,
                    score: 0,
                    precision: 'single',
                    half: false,
                    single: true,
                    type: this.FLOAT
                };
                half = {
                    texture: halfTexture !== null,
                    filterable: halfLinear !== null,
                    renderable: halfFramebuffer !== null,
                    score: 0,
                    precision: 'half',
                    half: true,
                    single: false,
                    type: (_ref = halfTexture != null ? halfTexture.HALF_FLOAT_OES : void 0) != null ? _ref : null
                };
                candidates = [];
                if (single.texture) {
                    candidates.push(single);
                }
                if (half.texture) {
                    candidates.push(half);
                }
                result = [];
                for (_j = 0, _len1 = candidates.length; _j < _len1; _j++) {
                    candidate = candidates[_j];
                    use = true;
                    _ref1 = spec.require;
                    for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {
                        name = _ref1[_k];
                        if (candidate[name] === false) {
                            use = false;
                        }
                    }
                    if (use) {
                        result.push(candidate);
                    }
                }
                for (_l = 0, _len3 = result.length; _l < _len3; _l++) {
                    candidate = result[_l];
                    _ref2 = spec.prefer;
                    for (i = _m = 0, _len4 = _ref2.length; _m < _len4; i = ++_m) {
                        preference = _ref2[i];
                        importance = Math.pow(2, spec.prefer.length - i - 1);
                        if (candidate[preference]) {
                            candidate.score += importance;
                        }
                    }
                }
                result.sort(function (a, b) {
                    if (a.score === b.score) {
                        return 0;
                    } else if (a.score < b.score) {
                        return 1;
                    } else if (a.score > b.score) {
                        return -1;
                    }
                });
                if (result.length === 0) {
                    if (spec.throws) {
                        throw 'No floating point texture support that is ' + spec.require.join(', ');
                    } else {
                        return null;
                    }
                } else {
                    result = result[0];
                    return {
                        filterable: result.filterable,
                        renderable: result.renderable,
                        type: result.type,
                        precision: result.precision
                    };
                }
            };
        }
    };

    nukeVendorPrefix();

    textureFloatShims();

    Shader = (function () {
        function Shader(gl, _arg) {
            var fragment, vertex;
            this.gl = gl;
            vertex = _arg.vertex, fragment = _arg.fragment;
            this.program = this.gl.createProgram();
            this.vs = this.gl.createShader(this.gl.VERTEX_SHADER);
            this.fs = this.gl.createShader(this.gl.FRAGMENT_SHADER);
            this.gl.attachShader(this.program, this.vs);
            this.gl.attachShader(this.program, this.fs);
            this.compileShader(this.vs, vertex);
            this.compileShader(this.fs, fragment);
            this.link();
            this.value_cache = {};
            this.uniform_cache = {};
            this.attribCache = {};
        }

        Shader.prototype.attribLocation = function (name) {
            var location;
            location = this.attribCache[name];
            if (location === void 0) {
                location = this.attribCache[name] = this.gl.getAttribLocation(this.program, name);
            }
            return location;
        };

        Shader.prototype.compileShader = function (shader, source) {
            this.gl.shaderSource(shader, source);
            this.gl.compileShader(shader);
            if (!this.gl.getShaderParameter(shader, this.gl.COMPILE_STATUS)) {
                throw "Shader Compile Error: " + (this.gl.getShaderInfoLog(shader));
            }
        };

        Shader.prototype.link = function () {
            this.gl.linkProgram(this.program);
            if (!this.gl.getProgramParameter(this.program, this.gl.LINK_STATUS)) {
                throw "Shader Link Error: " + (this.gl.getProgramInfoLog(this.program));
            }
        };

        Shader.prototype.use = function () {
            this.gl.useProgram(this.program);
            return this;
        };

        Shader.prototype.uniformLoc = function (name) {
            var location;
            location = this.uniform_cache[name];
            if (location === void 0) {
                location = this.uniform_cache[name] = this.gl.getUniformLocation(this.program, name);
            }
            return location;
        };

        Shader.prototype.int = function (name, value) {
            var cached, loc;
            cached = this.value_cache[name];
            if (cached !== value) {
                this.value_cache[name] = value;
                loc = this.uniformLoc(name);
                if (loc) {
                    this.gl.uniform1i(loc, value);
                }
            }
            return this;
        };

        Shader.prototype.vec2 = function (name, a, b) {
            var loc;
            loc = this.uniformLoc(name);
            if (loc) {
                this.gl.uniform2f(loc, a, b);
            }
            return this;
        };

        Shader.prototype.float = function (name, value) {
            var cached, loc;
            cached = this.value_cache[name];
            if (cached !== value) {
                this.value_cache[name] = value;
                loc = this.uniformLoc(name);
                if (loc) {
                    this.gl.uniform1f(loc, value);
                }
            }
            return this;
        };

        return Shader;

    })();

    Framebuffer = (function () {
        function Framebuffer(gl) {
            this.gl = gl;
            this.buffer = this.gl.createFramebuffer();
        }

        Framebuffer.prototype.destroy = function () {
            return this.gl.deleteFRamebuffer(this.buffer);
        };

        Framebuffer.prototype.bind = function () {
            this.gl.bindFramebuffer(this.gl.FRAMEBUFFER, this.buffer);
            return this;
        };

        Framebuffer.prototype.unbind = function () {
            this.gl.bindFramebuffer(this.gl.FRAMEBUFFER, null);
            return this;
        };

        Framebuffer.prototype.check = function () {
            var result;
            result = this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);
            switch (result) {
                case this.gl.FRAMEBUFFER_UNSUPPORTED:
                    throw 'Framebuffer is unsupported';
                    break;
                case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:
                    throw 'Framebuffer incomplete attachment';
                    break;
                case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:
                    throw 'Framebuffer incomplete dimensions';
                    break;
                case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:
                    throw 'Framebuffer incomplete missing attachment';
            }
            return this;
        };

        Framebuffer.prototype.color = function (texture) {
            this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER, this.gl.COLOR_ATTACHMENT0, texture.target, texture.handle, 0);
            this.check();
            return this;
        };

        Framebuffer.prototype.depth = function (buffer) {
            this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER, this.gl.DEPTH_ATTACHMENT, this.gl.RENDERBUFFER, buffer.id);
            this.check();
            return this;
        };

        Framebuffer.prototype.destroy = function () {
            return this.gl.deleteFramebuffer(this.buffer);
        };

        return Framebuffer;

    })();

    Texture = (function () {
        function Texture(gl, params) {
            var _ref, _ref1;
            this.gl = gl;
            if (params == null) {
                params = {};
            }
            this.channels = this.gl[((_ref = params.channels) != null ? _ref : 'rgba').toUpperCase()];
            if (typeof params.type === 'number') {
                this.type = params.type;
            } else {
                this.type = this.gl[((_ref1 = params.type) != null ? _ref1 : 'unsigned_byte').toUpperCase()];
            }
            switch (this.channels) {
                case this.gl.RGBA:
                    this.chancount = 4;
                    break;
                case this.gl.RGB:
                    this.chancount = 3;
                    break;
                case this.gl.LUMINANCE_ALPHA:
                    this.chancount = 2;
                    break;
                default:
                    this.chancount = 1;
            }
            this.target = this.gl.TEXTURE_2D;
            this.handle = this.gl.createTexture();
        }

        Texture.prototype.destroy = function () {
            return this.gl.deleteTexture(this.handle);
        };

        Texture.prototype.bind = function (unit) {
            if (unit == null) {
                unit = 0;
            }
            if (unit > 15) {
                throw 'Texture unit too large: ' + unit;
            }
            this.gl.activeTexture(this.gl.TEXTURE0 + unit);
            this.gl.bindTexture(this.target, this.handle);
            return this;
        };

        Texture.prototype.setSize = function (width, height) {
            this.width = width;
            this.height = height;
            this.gl.texImage2D(this.target, 0, this.channels, this.width, this.height, 0, this.channels, this.type, null);
            return this;
        };

        Texture.prototype.upload = function (data) {
            this.width = data.width;
            this.height = data.height;
            this.gl.texImage2D(this.target, 0, this.channels, this.channels, this.type, data);
            return this;
        };

        Texture.prototype.linear = function () {
            this.gl.texParameteri(this.target, this.gl.TEXTURE_MAG_FILTER, this.gl.LINEAR);
            this.gl.texParameteri(this.target, this.gl.TEXTURE_MIN_FILTER, this.gl.LINEAR);
            return this;
        };

        Texture.prototype.nearest = function () {
            this.gl.texParameteri(this.target, this.gl.TEXTURE_MAG_FILTER, this.gl.NEAREST);
            this.gl.texParameteri(this.target, this.gl.TEXTURE_MIN_FILTER, this.gl.NEAREST);
            return this;
        };

        Texture.prototype.clampToEdge = function () {
            this.gl.texParameteri(this.target, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE);
            this.gl.texParameteri(this.target, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE);
            return this;
        };

        Texture.prototype.repeat = function () {
            this.gl.texParameteri(this.target, this.gl.TEXTURE_WRAP_S, this.gl.REPEAT);
            this.gl.texParameteri(this.target, this.gl.TEXTURE_WRAP_T, this.gl.REPEAT);
            return this;
        };

        return Texture;

    })();

    Node = (function () {
        function Node(gl, width, height) {
            var floatExt;
            this.gl = gl;
            this.width = width;
            this.height = height;
            floatExt = this.gl.getFloatExtension({
                require: ['renderable']
            });
            this.texture = new Texture(this.gl, {
                type: floatExt.type
            }).bind(0).setSize(this.width, this.height).nearest().clampToEdge();
            this.fbo = new Framebuffer(this.gl).bind().color(this.texture).unbind();
        }

        Node.prototype.use = function () {
            return this.fbo.bind();
        };

        Node.prototype.bind = function (unit) {
            return this.texture.bind(unit);
        };

        Node.prototype.end = function () {
            return this.fbo.unbind();
        };

        Node.prototype.resize = function (width, height) {
            this.width = width;
            this.height = height;
            return this.texture.bind(0).setSize(this.width, this.height);
        };

        return Node;

    })();

    vertexShaderBlit = 'attribute vec4 position;\n' +
        'varying vec2 texcoord;\n' +
        'void main(){\n' +
        '    texcoord = position.xy*0.5+0.5;\n' +
        '    gl_Position = position;\n' +
        '}';

    fragmentShaderBlit = '#ifdef GL_FRAGMENT_PRECISION_HIGH\n    ' +
        '  precision highp int;\n' +
        '    precision highp float;\n' +
        '#else\n' +
        '    precision mediump int;\n' +
        '    precision mediump float;\n' +
        '#endif\n' +
        'uniform sampler2D source;\n' +
        'varying vec2 texcoord;';

    Heights = (function () {
        function Heights(heatmap, gl, width, height) {
            var i, _i, _ref;
            this.heatmap = heatmap;
            this.gl = gl;
            this.width = width;
            this.height = height;
            this.shader = new Shader(this.gl, {
                vertex: 'attribute vec4 position, intensity;\nvarying vec2 off, dim;\nvarying float vIntensity;\nuniform vec2 viewport;\n\nvoid main(){\n    dim = abs(position.zw);\n' +
                    '    off = position.zw;\n    vec2 pos = position.xy + position.zw;\n   ' +
//                    ' off = vec2(-25,25);\n ' +
//                    'dim=vec2(20,50);\n ' +
                    ' vIntensity = intensity.x;\n    gl_Position = vec4((pos/viewport)*2.0-1.0, 0.0, 1.0);\n}',
                fragment: '#ifdef GL_FRAGMENT_PRECISION_HIGH\n   ' +
                    ' precision highp int;\n   ' +
                    ' precision highp float;\n#else\n   ' +
                    ' precision mediump int;\n   ' +
                    ' precision mediump float;\n#endif\n' +
                    ' varying vec2 off, dim;\n' +
                    ' varying float vIntensity;\nvoid main(){\n  ' +
                    '  float falloff = (1.0 - smoothstep(0.0, 1.0, length(off/dim)));\n  ' +
//                    '  falloff = 0.3; \n' +
                    '  float intensity = falloff*vIntensity;\n   ' +
//                    '  float intensity = vIntensity;\n   ' +
                    '  gl_FragColor = vec4(intensity,0.0,0,1.0);\n' +
                    ' }'
            });
            this.clampShader = new Shader(this.gl, {
                vertex: vertexShaderBlit,
                fragment: fragmentShaderBlit + 'uniform float low, high;\nvoid main(){\n    gl_FragColor = vec4(clamp(texture2D(source, texcoord).rgb, low, high), 1.0);\n}'
            });
            this.multiplyShader = new Shader(this.gl, {
                vertex: vertexShaderBlit,
                fragment: fragmentShaderBlit + 'uniform float value;\nvoid main(){\n    gl_FragColor = vec4(texture2D(source, texcoord).rgb*value, 1.0);\n}'
            });
            this.blurShader = new Shader(this.gl, {
                vertex: vertexShaderBlit,
                fragment: fragmentShaderBlit + 'uniform vec2 viewport;\nvoid main(){\n    vec4 result = vec4(0.0);\n    for(int x=-1; x<=1; x++){\n        for(int y=-1; y<=1; y++){\n            vec2 off = vec2(x,y)/viewport;\n            //float factor = 1.0 - smoothstep(0.0, 1.5, length(off));\n            float factor = 1.0;\n            result += vec4(texture2D(source, texcoord+off).rgb*factor, factor);\n        }\n    }\n    gl_FragColor = vec4(result.rgb/result.w, 1.0);\n}'
            });
            this.nodeBack = new Node(this.gl, this.width, this.height);
            this.nodeFront = new Node(this.gl, this.width, this.height);
            this.vertexBuffer = this.gl.createBuffer();
            this.vertexSize = 8;
            this.maxPointCount = 1024 * 10;
            this.vertexBufferData = new Float32Array(this.maxPointCount * this.vertexSize * 6);
            this.vertexBufferViews = [];
            for (i = _i = 0, _ref = this.maxPointCount; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
                this.vertexBufferViews.push(new Float32Array(this.vertexBufferData.buffer, 0, i * this.vertexSize * 6));
            }
            this.bufferIndex = 0;
            this.pointCount = 0;
        }

        Heights.prototype.resize = function (width, height) {
            this.width = width;
            this.height = height;
            this.nodeBack.resize(this.width, this.height);
            return this.nodeFront.resize(this.width, this.height);
        };

        Heights.prototype.update = function () {
            var intensityLoc, positionLoc;
            if (this.pointCount > 0) {
                this.gl.enable(this.gl.BLEND);
                this.nodeFront.use();
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.vertexBuffer);
                this.gl.bufferData(this.gl.ARRAY_BUFFER, this.vertexBufferViews[this.pointCount], this.gl.STREAM_DRAW);
                positionLoc = this.shader.attribLocation('position');
                intensityLoc = this.shader.attribLocation('intensity');
                this.gl.enableVertexAttribArray(1);
                this.gl.vertexAttribPointer(positionLoc, 4, this.gl.FLOAT, false, 8 * 4, 0 * 4);
                this.gl.vertexAttribPointer(intensityLoc, 4, this.gl.FLOAT, false, 8 * 4, 4 * 4);
                this.shader.use().vec2('viewport', this.width, this.height);
                this.gl.drawArrays(this.gl.TRIANGLES, 0, this.pointCount * 6);
                this.gl.disableVertexAttribArray(1);
                this.pointCount = 0;
                this.bufferIndex = 0;
                this.nodeFront.end();
                return this.gl.disable(this.gl.BLEND);
            }
        };

        Heights.prototype.clear = function () {
            this.nodeFront.use();
            this.gl.clear(this.gl.COLOR_BUFFER_BIT);
            return this.nodeFront.end();
        };

        Heights.prototype.clamp = function (min, max) {
            this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.heatmap.quad);
            this.gl.vertexAttribPointer(0, 4, this.gl.FLOAT, false, 0, 0);
            this.nodeFront.bind(0);
            this.nodeBack.use();
            this.clampShader.use().int('source', 0).float('low', min).float('high', max);
            this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
            this.nodeBack.end();
            return this.swap();
        };

        Heights.prototype.multiply = function (value) {
            this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.heatmap.quad);
            this.gl.vertexAttribPointer(0, 4, this.gl.FLOAT, false, 0, 0);
            this.nodeFront.bind(0);
            this.nodeBack.use();
            this.multiplyShader.use().int('source', 0).float('value', value);
            this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
            this.nodeBack.end();
            return this.swap();
        };

        Heights.prototype.blur = function () {
            this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.heatmap.quad);
            this.gl.vertexAttribPointer(0, 4, this.gl.FLOAT, false, 0, 0);
            this.nodeFront.bind(0);
            this.nodeBack.use();
            this.blurShader.use().int('source', 0).vec2('viewport', this.width, this.height);
            this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
            this.nodeBack.end();
            return this.swap();
        };

        Heights.prototype.swap = function () {
            var tmp;
            tmp = this.nodeFront;
            this.nodeFront = this.nodeBack;
            return this.nodeBack = tmp;
        };

        Heights.prototype.addVertex = function (x, y, xs, ys, intensity) {
            this.vertexBufferData[this.bufferIndex++] = x;
            this.vertexBufferData[this.bufferIndex++] = y;
            this.vertexBufferData[this.bufferIndex++] = xs;
            this.vertexBufferData[this.bufferIndex++] = ys;
            this.vertexBufferData[this.bufferIndex++] = intensity;
            this.vertexBufferData[this.bufferIndex++] = intensity;
            this.vertexBufferData[this.bufferIndex++] = intensity;
            return this.vertexBufferData[this.bufferIndex++] = intensity;
        };

        Heights.prototype.addPoint = function (x, y, size, intensity) {
            var s1, s2;
            if (size == null) {
                size = 50;
            }
            if (intensity == null) {
                intensity = 0.2;
            }
            if (this.pointCount >= this.maxPointCount - 1) {
                this.update();
            }
            y = this.height - y;
            s1 = size / 2;
            s2 = size / 2;
//            s1 = 25;
            this.addVertex(x, y, -s1, -s2, intensity);
            this.addVertex(x, y, +s1, -s2, intensity);
            this.addVertex(x, y, -s1, +s2, intensity);
            this.addVertex(x, y, -s1, +s2, intensity);
            this.addVertex(x, y, +s1, -s2, intensity);
            this.addVertex(x, y, +s1, +s2, intensity);
            return this.pointCount += 1;
        };

        return Heights;

    })();

    WebGLHeatmap = (function () {
        function WebGLHeatmap(_arg) {
            var alphaEnd, alphaRange, alphaStart, error, getColorFun, gradientTexture, image, intensityToAlpha, output, quad, textureGradient, _ref, _ref1,bgColor;
            _ref = _arg != null ? _arg : {}, this.canvas = _ref.canvas, this.width = _ref.width, this.height = _ref.height, intensityToAlpha = _ref.intensityToAlpha, gradientTexture = _ref.gradientTexture, alphaRange = _ref.alphaRange;
            bgColor = _ref.bgColor;
            if (!this.canvas) {
                this.canvas = document.createElement('canvas');
            }
            try {
                this.gl = this.canvas.getContext('experimental-webgl', {
                    depth: false,
                    antialias: false,
                    preserveDrawingBuffer: true
                });
                if (this.gl === null) {
                    this.gl = this.canvas.getContext('webgl', {
                        depth: false,
                        antialias: false,
                        preserveDrawingBuffer: true
                    });
                    if (this.gl === null) {
                        throw 'WebGL not supported';
                    }
                }
            } catch (_error) {
                error = _error;
                throw 'WebGL not supported';
            }
            if (window.WebGLDebugUtils != null) {
                console.log('debugging mode');
                this.gl = WebGLDebugUtils.makeDebugContext(this.gl, function (err, funcName, args) {
                    throw WebGLDebugUtils.glEnumToString(err) + " was caused by call to: " + funcName;
                });
            }
            this.gl.enableVertexAttribArray(0);
            this.gl.blendFunc(this.gl.ONE, this.gl.ONE);
            if (gradientTexture) {
                textureGradient = this.gradientTexture = new Texture(this.gl, {
                    channels: 'rgba'
                }).bind(0).setSize(2, 2).nearest().clampToEdge();
                if (typeof gradientTexture === 'string') {
                    image = new Image();
                    image.onload = function () {
                        return textureGradient.bind().upload(image);
                    };
                    image.src = gradientTexture;
                } else {
                    if (gradientTexture.width > 0 && gradientTexture.height > 0) {
                        textureGradient.upload(gradientTexture);
                    } else {
                        gradientTexture.onload = function () {
                            return textureGradient.upload(gradientTexture);
                        };
                    }
                }
                getColorFun = 'uniform sampler2D gradientTexture;\nvec3 getColor(float intensity){\n    return texture2D(gradientTexture, vec2(intensity, 0.0)).rgb;\n}';
            } else {
                textureGradient = null;
//                getColorFun = 'vec3 getColor(float intensity){\n' +
//                    '    vec3 blue = vec3(0.0, 0.0, 1.0);\n' +
//                '    vec3 cyan = vec3(0.0, 1.0, 1.0);\n' +
                getColorFun = 'vec3 getColor(float intensity){\n';
                if(bgColor){
                    getColorFun += ' vec3 blue = vec3('+parseInt(bgColor.r || 0.0)+', '+parseInt(bgColor.g || 0.0)+', '+parseInt(bgColor.b || 0.0)+');\n';
                }else{
                    getColorFun +='    vec3 blue = vec3(0.0, 0.0, 1.0);\n';
                }
                getColorFun += '    vec3 cyan = vec3(0.0, 1.0, 1.0);\n' +
                    '    vec3 green = vec3(0.0, 1.0, 0.0);\n' +
                    '    vec3 yellow = vec3(1.0, 1.0, 0.0);\n' +
                    '    vec3 red = vec3(1.0, 0.0, 0.0);\n\n' +
                    '    vec3 color = (\n' +
                    '        fade(-0.25, 0.25, intensity)*blue +\n' +
                    '        fade(0.0, 0.5, intensity)*cyan +\n' +
                    '        fade(0.25, 0.75, intensity)*green +\n' +
                    '        fade(0.5, 1.0, intensity)*yellow +\n' +
                    '        smoothstep(0.75, 1.0, intensity)*red\n' +
                    '    );\n' +
                    '    return color;\n' +
                    '}';
            }
            if (intensityToAlpha == null) {
                intensityToAlpha = true;
            }
            if (intensityToAlpha) {
                _ref1 = alphaRange != null ? alphaRange : [0, 1], alphaStart = _ref1[0], alphaEnd = _ref1[1];
                output = "vec4 alphaFun(vec3 color, float intensity){\n  " +
                    "  float alpha = smoothstep(" + (alphaStart.toFixed(8)) + ", " + (alphaEnd.toFixed(8)) + ", intensity);\n  " +
                    "  return vec4(color*alpha, alpha);\n" +
                    " }";
            } else {
                output = 'vec4 alphaFun(vec3 color, float intensity){\n   ' +
                    ' return vec4(color, 1.0);\n' +
                    ' }';
            }
            this.shader = new Shader(this.gl, {
                vertex: vertexShaderBlit,
                fragment: fragmentShaderBlit + ("float linstep(float low, float high, float value){\n   " +
                    " return clamp((value-low)/(high-low), 0.0, 1.0);\n}\n\n" +
                    " float fade(float low, float high, float value){\n   " +
                    " float mid = (low+high)*0.5;\n   " +
                    " float range = (high-low)*0.5;\n   " +
                    " float x = 1.0 - clamp(abs(mid-value)/range, 0.0, 1.0);\n   " +
                    " return smoothstep(0.0, 1.0, x);\n}\n\n" + getColorFun + "\n" + output + "\n\n" +
                    " void main(){\n   " +
                    "  float intensity = smoothstep(0.0, 1.0, texture2D(source, texcoord).r);\n  " +
                    "  vec3 color = getColor(intensity);\n   " +
                    "  gl_FragColor = alphaFun(color, intensity);\n" +
                    " }")
            });
            if (this.width == null) {
                this.width = this.canvas.offsetWidth || 2;
            }
            if (this.height == null) {
                this.height = this.canvas.offsetHeight || 2;
            }
            this.canvas.width = this.width;
            this.canvas.height = this.height;
            this.gl.viewport(0, 0, this.width, this.height);
            this.quad = this.gl.createBuffer();
            this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.quad);
            quad = new Float32Array([-1, -1, 0, 1, 1, -1, 0, 1, -1, 1, 0, 1, -1, 1, 0, 1, 1, -1, 0, 1, 1, 1, 0, 1]);
            this.gl.bufferData(this.gl.ARRAY_BUFFER, quad, this.gl.STATIC_DRAW);
            this.gl.bindBuffer(this.gl.ARRAY_BUFFER, null);
            this.heights = new Heights(this, this.gl, this.width, this.height);
        }

        WebGLHeatmap.prototype.adjustSize = function () {
            var canvasHeight, canvasWidth;
            canvasWidth = this.canvas.offsetWidth || 2;
            canvasHeight = this.canvas.offsetHeight || 2;
            if (this.width !== canvasWidth || this.height !== canvasHeight) {
                this.gl.viewport(0, 0, canvasWidth, canvasHeight);
                this.canvas.width = canvasWidth;
                this.canvas.height = canvasHeight;
                this.width = canvasWidth;
                this.height = canvasHeight;
                return this.heights.resize(this.width, this.height);
            }
        };

        WebGLHeatmap.prototype.display = function () {
            this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.quad);
            this.gl.vertexAttribPointer(0, 4, this.gl.FLOAT, false, 0, 0);
            this.heights.nodeFront.bind(0);
            if (this.gradientTexture) {
                this.gradientTexture.bind(1);
            }
            this.shader.use().int('source', 0).int('gradientTexture', 1);
            return this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
        };

        WebGLHeatmap.prototype.update = function () {
            return this.heights.update();
        };

        WebGLHeatmap.prototype.clear = function () {
            return this.heights.clear();
        };

        WebGLHeatmap.prototype.clamp = function (min, max) {
            if (min == null) {
                min = 0;
            }
            if (max == null) {
                max = 1;
            }
            return this.heights.clamp(min, max);
        };

        WebGLHeatmap.prototype.multiply = function (value) {
            if (value == null) {
                value = 0.95;
            }
            return this.heights.multiply(value);
        };

        WebGLHeatmap.prototype.blur = function () {
            return this.heights.blur();
        };

        WebGLHeatmap.prototype.addPoint = function (x, y, size, intensity) {
            return this.heights.addPoint(x, y, size, intensity);
        };

        WebGLHeatmap.prototype.addPoints = function (items) {
            var item, _i, _len, _results;
            _results = [];
            for (_i = 0, _len = items.length; _i < _len; _i++) {
                item = items[_i];
                _results.push(this.addPoint(item.x, item.y, item.size, item.intensity));
            }
            return _results;
        };

        return WebGLHeatmap;

    })();

    window.createWebGLHeatmap = function (params) {
        return new WebGLHeatmap(params);
    };
})(window);

var $HeatMap = function(obj){
    if(!obj){
        obj = {};
    }
    this.radius = obj.radius || 10;
    this.maxValue = obj.maxValue||1;
    this.minValue = obj.minValue||0;
    this.width = obj.width || 100; // 这个是最后生成的plane的大小
    this.height = obj.height || 100;
    this.intensityToAlpha = obj.intensityToAlpha||false;
    this.alphaRange = obj.alphaRange || [0,1];
    this.gradientTexture = obj.gradientTexture;
    this.canvasHeight = 100;
    this.canvasWidth = parseInt(this.canvasHeight*this.width/this.height); // 晕，原来canvas的尺寸不能为小数啊
    this.positionX = obj.positionX == undefined?this.width/2:parseFloat(obj.positionX);  //palan要放的位置，根据这个坐标来转换addPoint中的(x,y)将那个在3d中的坐标转成canvas中对应的点
    this.positionY = obj.positionY == undefined?this.height/2:parseFloat(obj.positionY);
    this.heatmap = createWebGLHeatmap({canvas: null,
        width: this.canvasWidth,
        height: this.canvasHeight,
        intensityToAlpha: this.intensityToAlpha,//false,
        alphaRange: this.alphaRange,//[0, 1] //[0, 0.05]
        gradientTexture: this.gradientTexture,
        bgColor:obj.bgColor
    });

};

mono.extend($HeatMap,Object,{

    // 环境温度，材料的属性(比如温度导热因子)，FF0000(红) - FFFF00(黄色) - 00FF00 - 00FFFF(浅蓝) - 0000FF
    createHeatMap: function () {
//    var heatmap = createWebGLHeatmap({canvas: null, intensityToAlpha:true, alphaRange: [0, 0.05]});
    },

    /**
     * 将canvas上的原点转成3D上对应的点，也就是最canvas上左下角(0,0)的对应的坐标
     * @private
     */
    _getOriginal: function () {
        var x = this.positionX - this.width / 2;
        var y = this.height / 2 + this.positionY;
        return {x: x, y: y};
    },

    _getOriginalX: function () {
        return this.positionX - this.width / 2;
    },

    _getOriginalY: function () {
//    return this.positionY - this.height/2;
        return this.height / 2 + this.positionY; // 由于3D中原点在左上角(2D中在左下角)，y的方向正好搞反了,所以算个原始x值时是+h/2
    },

    _transPositionX: function (x) {
        return (parseFloat(x) - this._getOriginalX()) * (this.canvasWidth / this.width);
    },

    _transPositionY: function (y) {
//    return parseFloat(y) - this.positionY;
        return (this._getOriginalY() - parseFloat(y)) * (this.canvasHeight / this.height);// 由于3D中原点在左上角(2D中在左下角)，y的方向正好搞反了
    },

    /**
     * 将3D中的宽度w换算成canvas上对应的w
     * @param w
     * @private
     */
    _transWidth: function (d) {
        var w = parseFloat(d);
        if (w <= 0) return 0;
        return w * this.canvasWidth / this.width;
    },

    _transHeight: function (l) {
        var h = parseFloat(l);
        if (h <= 0) {
            return 0;
        }
        return h * this.canvasHeight / this.height;
    },


    /**
     * 在区域附近生成热点
     * 注意：
     * 1、热点的数量
     * 2、范围
     * 3、热点的半径
     * @param x
     * @param y
     * @param w
     * @param l
     * @param value
     * @private
     */
    _generateNearPointsForArea: function (x, y, w, l, value) {
        if (!w || !l) return;
        var count = parseInt(w * l) * 3; //在该区域附件的随机热点的数量
        var min_x = x - w / 2;
        var min_y = y - l / 2;
        if (min_x < 0 || min_y < 0) return;
        var index = 0;
        var near_area = 5;//this.radius/2;
        while (index < count) {
            var offset_x = (Math.random() * 2 - 1) * (near_area + w / 2); // -1~1之间
            var offset_y = (Math.random() * 2 - 1) * (near_area + l / 2);
            var p_x = 0, p_y = 0;
            p_x = x + offset_x;
            p_y = y + offset_y;
            if (p_x > min_x
                && p_x < (min_x + w)
                && p_y > min_y
                && p_y < (min_y + l)) { // 如果在区域里则剔除掉
                continue;
            }
            this.heatmap.addPoint(p_x, p_y, this.radius / 2, value / 30);
            index++;
        }
    },

// 随机点的数量根据radius的大小来确定，是radius的两倍,怎么样？
// 随机点离实际点最远的距离也根据radius的大小来确定，也是radius的两倍，怎么样?
// 但是，对于area的方式来讲，随机点的数量要远远大于单个点附近的随机点，其还应该跟据area的大小，离该区域最远的距离也应该远大于radius*2,并且自己的半径非常的小

    /**
     * 根据一个点，在该区域内和区域外都添加一定数量的点，但是在该区域内的点是均匀分布的，但是离该区域越近点就愈多，越远就越少
     * 注意，x,y,l,w都要换算成canvas的上的点和大小
     * @param obj
     */
    addPointWithArea: function (obj) {
        if (!obj) return;
        if (obj instanceof Array && obj.length > 0) {
            for (var i = 0; i < obj.length; i++) {
                arguments.callee(obj[i]);
            }
        } else {
            if (obj.type && obj.type === 'circle') {
                this._createCircleCloud(obj);
            } else {
                this._createRectCloud(obj);
            }
        }
        //    this._generateNearPointsForArea(t_x,t_y, w,l,value); //去掉在区域附近再创建随机点了
    },

    /**
     * 生成一个圆或者圆弧行的温度云图
     * @param obj
     * @private
     */
    _createCircleCloud: function (obj) {
        if (!obj) return;
        var x = parseFloat(obj.x) || 0;
        var y = parseFloat(obj.y) || 0;
        var radius = parseFloat(obj.radius) || 0;
        if (radius || radius <= 0)return;
    },

    /**
     * 生成一个rect(矩形)的温度云图
     * @param obj
     * @private
     */
    _createRectCloud: function (obj) {
        if (!obj) return;
        var x = parseFloat(obj.x) || 0;
        var y = parseFloat(obj.y) || 0;
        var w = parseFloat(obj.w) || 0;
        var l = parseFloat(obj.l) || 0;
        var value = parseFloat(obj.value) || 0;
        var axis = obj.axis; //旋转轴
        w = this._transWidth(w);
        l = this._transHeight(l);
        if (axis && axis == 'z') {
            var v_l = l;
            l = w;
            w = v_l;
        }
        if (!w && !l) {
            this.addPoint(x, y, value);
            return;
        }
        if (!l) {
            l = w;
        }
        if (!w) {
            w = l;
        }
        var t_x = this._transPositionX(x);
        var t_y = this._transPositionY(y);
        this._generatePointsForArea(t_x, t_y, w, l, value);
    },

    /**
     * 在区域内生成相关的热点，该热点是均匀的
     * 注意：
     * 1、区域内的热点的半径为radius的1/3;
     * 2、热点的值应该是实际值的1/X？
     * 3、热点的数量=区域的面积
     * @param x
     * @param y
     * @param w
     * @param l
     * @param value
     * @private
     */
    _generatePointsForArea: function (x, y, w, l, value) {

//        this.heatmap.addPoint(x, y, 100, value);


         if(!w || !l) return;
         var min_x = x -  w/2;
         var min_y = y - l/2;
         var index = 0;
         var count = parseInt(w*l); //在该区域内所要生成的随机点的数量
         var offsetX = 1 , offsetY = 1;
         while(index < count){
         if(offsetX >= w){
         offsetX = 1;
         offsetY ++;
         }
         if(offsetX >= w && offsetY >= l){
         break;
         }
         var p_x = min_x + offsetX;
         var p_y = min_y + offsetY;
         this.heatmap.addPoint(p_x, p_y, this.radius, value/20);
         offsetX ++;
         index++;
         }

    },

    _generatePointsForArea_for_random: function (x, y, w, l, value) {
        if (!w || !l) return;
        w += 5;
        l += 5;
        var min_x = x - w / 2;
        var min_y = y - l / 2;
        var index = 0;
        var count = parseInt(w * l); //在该区域内所要生成的随机点的数量
        while (index < count) {
            var p_x = min_x + Math.random() * w;
            var p_y = min_y + Math.random() * l;
            this.heatmap.addPoint(p_x, p_y, this.radius, value / 30);
            index++;
        }
    },


    /**
     * 在某个点(x,y)附近加些云点，以(x,y)为圆心
     * @param x
     * @param y
     * @param value
     * @private
     */
    _paintAtCoord: function (x, y, value) {
        var count = 0;
//    this.heatmap.addPoint(x, y, this.radius, value);
//    return;
//    var max = parseInt(Math.random()*50);
        while (count < this.radius * 2) {
            var xoff = Math.random() * 2 - 1;
            var yoff = Math.random() * 2 - 1;
            var l = xoff * xoff + yoff * yoff;
            if (l > 1) {
                continue;
            }
            var ls = Math.sqrt(l);
            xoff /= ls;
            yoff /= ls;
            xoff *= 1 - l;
            yoff *= 1 - l;
            count += 1;
            this.heatmap.addPoint(x + xoff * this.radius * 2, y + yoff * this.radius * 2, this.radius, value / 10);
//        this.heatmap.addPoint(x+xoff, y+yoff, this.radius, value/30); // 由于现在的canvas才100*100
        }
    },

    addPoint: function (x, y, value, dic) {
        x = this._transPositionX(x);
        y = this._transPositionY(y);
//    if(value != null && value != undefined){
//        value = (parseFloat(value) - this.minValue)/(this.maxValue-this.minValue);
//        if(value < 0){
//            value = 0;
//        }
//    }
        var count = 0;
        while (count < 20) {
            var xoff = Math.random() * 2 - 1;
            var yoff = Math.random() * 2 - 1;
            var l = xoff * xoff + yoff * yoff;
            if (l > 1) {
                continue;
            }
            var ls = Math.sqrt(l);
            xoff /= ls;
            yoff /= ls;
            xoff *= 1 - l;
            yoff *= 1 - l;
            count += 1;
            this.heatmap.addPoint(x + xoff * 10, y + yoff * 5, this.radius, value / 20);
        }
    },

    addPoint1: function (x, y, value, radius) {
        x = this._transPositionX(x);
        y = this._transPositionY(y);
        if (value != null && value != undefined) {
            value = (parseFloat(value) - this.minValue) / (this.maxValue - this.minValue);
            if (value < 0) {
                value = 0;
            }
        }
        if (radius) {
            this.heatmap.addPoint(x, y, radius, value);
        } else {
            this._paintAtCoord(x, y, value);
        }
    },


    update: function () {
        this.heatmap.adjustSize(); // can be commented out for statically sized heatmaps, resize clears the map
        this.heatmap.update(); // adds the buffered points
        this.heatmap.display();
//    this.heatmap.multiply(0.9995);
//    this.heatmap.blur();
//    this.heatmap.clamp(0.0, 1.0); // depending on usecase you might want to clamp it
    },

    refresh: function (callback) {
        var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
            window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
        var self = this;
//        document.body.appendChild(this.heatmap.canvas); //需要放入requestAnimate中，否则多个field的话会有问题
        raf(function () {
            document.body.appendChild(self.heatmap.canvas);
            self.update();
//            console.log(self.heatmap.canvas.toDataURL());
            if (callback) {
                callback();
            }
        });
    },

    clear: function () {
        this.heatmap.clear();
    },

    getCanvas: function () {
        return this.heatmap.canvas;
    },

    getImage: function () {
        if (this.heatmap.canvas) {
//        var ctx = this.heatmap.canvas.getContext('2d');
//        ctx.fillStyle = 'rgba(0,0,255,1.0)';
//        ctx.fillRect(0,0,500,500);
            return this.heatmap.canvas.toDataURL();
        } else {
            console.log('getImage error!');
        }
    },

    getTemperatureBoard: function () {
        var board = new mono.Plane(this.width, this.height);
        board.setStyle('m.texture.repeat', new mono.Vec2(1, 1))
            .setStyle('m.type', 'basic')
//        .setStyle('m.texture.image', this.getImage())
//        .setStyle('m.transparent', true)
            .setStyle('m.side', 'both');
//    board.setStyle('m.color','#0000FF');
//    if (this.direction == 'h') {
        board.setRotation(90 * Math.PI / 180, 0, 0)
//    }
        var self = this;
        this.refresh(function () {
            board.setStyle('m.texture.image', self.getImage());
            document.body.removeChild(self.heatmap.canvas);
        });
        board.setPositionX(this.positionX);
        board.setPositionZ(this.positionY);
        return board;
    }

});

it.HeatMap3D = $HeatMap;




var $HeatMap2D = function(opt){
    this.defaultOptions = {
//        gradientColors: ['#0066FF', 'cyan', 'lime', 'yellow', 'red'],
//        gradientColors: [{color:'#0066FF',}, 'cyan', 'lime', 'yellow', 'red'],
                gradientColors: ['rgba(0, 102, 255, 0.9)', 'cyan', 'lime', 'yellow', 'red'],
//        gradientColors: ['blue', 'red'],
        minAlpha: 0.05,
        valueScale: 1,
        opacity: 1,
        positionX : null, //相对中心点的偏移量
        positionY : null, //相对中心点的偏移量
        width : 500,
        height : 500,
        canvasHeight : 500,
//        canvasWidth : 1000,
        blurSize: 30,
        withBg : true, // 没有热点的地方是不是染色，true表示染色，默认的是蓝色，false表示不染色，透明的
    };
    this.option = opt;
    if (opt) {
        for (var i in this.defaultOptions) {
            if (opt[i] !== undefined) {
                this.option[i] = opt[i];
            } else {
                this.option[i] = this.defaultOptions[i];
            }
        }
    } else {
        this.option = this.defaultOptions;
    }
    this.datas = [];
    this.heatMapCanvas = document.createElement('canvas');
    this.width = this.option.width;
    this.height = this.option.height;
    this.canvasHeight = this.option.canvasHeight;
    this.canvasWidth = this.option.canvasWidth = parseInt(this.canvasHeight*this.width/this.height); // 晕，原来canvas的尺寸不能为小数啊
    this.positionX = this.option.positionX == undefined?this.width/2:parseFloat(this.option.positionX);  //palan要放的位置，根据这个坐标来转换addPoint中的(x,y)将那个在3d中的坐标转成canvas中对应的点
    this.positionY = this.option.positionY == undefined?this.height/2:parseFloat(this.option.positionY);
    this.BRUSH_SIZE = 20*2*this.canvasHeight/this.height; // 也就是canvasWidth中的20*2哦
    this.GRADIENT_LEVELS = 256;
    this.withBg = this.option.withBg;

};

mono.extend($HeatMap2D,Object,{


    /**
     * 添加热点
     * @param x (x,y)是3D上的(x,z)点
     * @param y
     * @param value
     */
    addPoint : function(x,y,value){
        if(arguments.length === 1 && arguments[0] instanceof Array){
            var obj = arguments[0];
            x = obj[0];
            y = obj[1];
            value = obj[2];
        }
        x = this._transPositionX(x);
        y = this._transPositionY(y);
        this.datas.push([x,y,value]);
    },

    /**
     * 根据一个点，在该区域内和区域外都添加一定数量的点，但是在该区域内的点是均匀分布的，但是离该区域越近点就愈多，越远就越少
     * 注意，x,y,l,w都要换算成canvas的上的点和大小
     * @param obj
     */
    addPointWithArea: function (obj) {
        if (!obj) return;
        if (obj instanceof Array && obj.length > 0) {
            for (var i = 0; i < obj.length; i++) {
                arguments.callee(obj[i]);
            }
        } else {
//            if (obj.type && obj.type === 'circle') {
//                this._createCircleCloud(obj);
//            } else {
                this._createRectCloud(obj);
//            }
        }
    },

    /**
     * 生成一个rect(矩形)的温度云图
     * @param obj
     * @private
     */
    _createRectCloud: function (obj) {
        if (!obj) return;
        var x = parseFloat(obj.x) || 0;
        var y = parseFloat(obj.y) || 0;
        var w = parseFloat(obj.w) || 0;
        var l = parseFloat(obj.l) || 0;
        var value = parseFloat(obj.value) || 0;
        var axis = obj.axis; //旋转轴
        w = this._transWidth(w);
        l = this._transHeight(l);
        if (axis && axis == 'z') {
            var v_l = l;
            l = w;
            w = v_l;
        }
        if (!w && !l) {
            this.addPoint(x, y, value);
            return;
        }
        if (!l) {
            l = w;
        }
        if (!w) {
            w = l;
        }
        var t_x = this._transPositionX(x);
        var t_y = this._transPositionY(y);
        this._generatePointsForArea(t_x, t_y, w, l, value);
    },


    /**
     * 在区域内生成相关的热点，该热点是均匀的
     * 注意：
     * 1、区域内的热点的半径为radius的1/3;
     * 2、热点的值应该是实际值的1/X？
     * 3、热点的数量=区域的面积
     * @param x
     * @param y
     * @param w
     * @param l
     * @param value
     * @private
     */
    _generatePointsForArea: function (x, y, w, l, value) {
        if(!w || !l) return;
//        value = 0.8;
        var min_x = x -  w/2;
        var min_y = y - l/2;
//        var index = 0;
//        var count = parseInt(w*l); //在该区域内所要生成的随机点的数量
//        var offsetX = 1 , offsetY = 1;
        var size = this.BRUSH_SIZE;//+2;
        var columns  = parseInt(w/size);
        var rows = parseInt(l/(size));

        if(columns%2 ===0){
            columns = columns+1; //使之对称
        }
        if(rows%2 ===0){
            rows = rows+1;//使之对称
        }

        var deltaC=0 ,deltaR=0;
        if(columns > 5){
            deltaC=1;
            columns = columns+deltaC;//可添加往旁边的扩充点，它们的权值应该更小
        }
        if(rows > 5){
            deltaR=1;
            rows = rows+deltaR;//可添加往旁边的扩充点，它们的权值应该更小
        }

        var vx = x,vy = y;
//        this.datas.push([vx,vy,value]);
        for(var r = 0 ; r < rows; r++){
            var dy = vy + Math.pow(-1,r) * r/2 * size;
//            if(r === 0 ){ // 中心(x,y)
//                dy = vy;
//            }
            for(var c = 0 ; c < columns; c++ ){
                var dx = vx + Math.pow(-1,c) * c/2 * size;
                if(c===0){
                    dx = vx;
                }
                var deltaValue = 1;
                if( columns-c <= deltaC || rows -r < deltaR ){
//                    if(columns-c == 2 ||rows -r ==2 ){
//                        deltaValue = 0.5;
//                    }else{
                    deltaValue = 0.3;
//                    }
                }
                this.datas.push([dx,dy,value*deltaValue*Math.random()]);
            }
        }
        // 增加左右两边的点
//        for(var i = 0 ; i < rows ; i++){
//
//        }


//        for(var count = 0 ; count < rows*columns ; count++){
//            var x = min_x + Math.random() * w; //* this.BRUSH_SIZE;
//            var y = min_y + Math.random() * l;
//            this.datas.push([x,y,Math.random()]);
//        }

        // 增加左右两边的点
//        for(var i = 0 ; i < rows ; i++){
//            var x = min_x - 1.5*size;
//            var y = min_y + i*size;
//            var r_value = value * 0.5 * Math.random();
//            this.datas.push([x,y,r_value]);
//            x = min_x - 2.5*size;
//            r_value = value*0.3*Math.random();
//            this.datas.push([x,y,r_value]);
//
//            x = min_x + (columns+1)*size; //* this.BRUSH_SIZE;
//            r_value = value*0.5*Math.random();
//            this.datas.push([x,y,r_value]);
//            r_value = value*0.3*Math.random();
//            x = min_x + (columns+2)*size;
//            this.datas.push([x,y,r_value]);
//        }
//
//        // 增加上下两边的点
//        for(var i = 0 ; i < columns ; i++){
//            var x = min_x + i*size; //* this.BRUSH_SIZE;
//            var y = min_y - 1.5*size;
//            var r_value = value * 0.5 * Math.random();
//            this.datas.push([x,y,r_value]);
//            r_value = value * 0.3 * Math.random();
//            y = min_y - 2.5*size;
//            this.datas.push([x,y,r_value]);
//
//            y = min_y + (rows +1)*size;
//            r_value = value * 0.5*Math.random();
//            this.datas.push([x,y,r_value]);
//            r_value = value * 0.3*Math.random();
//            y = min_y + (rows +2)*size;
//            this.datas.push([x,y,r_value]);
//        }

    },
//    _generatePointsForArea: function (x, y, w, l, value) {
//        if(!w || !l) return;
//        value = 0.8;
//        var min_x = x -  w/2;
//        var min_y = y - l/2;
//        var size = this.BRUSH_SIZE;//+2;
//        var columns  = parseInt(w/size);
//        var rows = parseInt(l/(size));
//
//        //应该从中心往两边扩展，从min往max那边扩展不太好，如果只有一个点，那就不是落在中心的
//        var vx = x,vy = y;
//        this.datas.push([vx,vy,value*Math.random()]);
//        for(var r = 0 ; r < rows; r++){
//            var dy = vy + Math.pow(-1,r) * size;
//            for(var c = 0 ; c < columns; c++ ){
//                var dx = vx + Math.pow(-1,c) * size;
//                this.datas.push([dx,dy,value*Math.random()]);
//            }
//        }
//
////        for(var r = 0 ; r < rows; r++){
////            var y = min_y + r * size;
////            for(var c = 0 ; c < columns; c++ ){
////                var x = min_x + c * size;
////                this.datas.push([x,y,value*Math.random()]);
////            }
////        }
//
//        // 增加左右两边的点
//        for(var i = 0 ; i < rows ; i++){
//            var x = min_x - 1.5*size;
//            var y = min_y + i*size;
//            var r_value = value * 0.5 * Math.random();
//            this.datas.push([x,y,r_value]);
//            x = min_x - 2.5*size;
//            r_value = value*0.3*Math.random();
//            this.datas.push([x,y,r_value]);
//
//            x = min_x + (columns+1)*size; //* this.BRUSH_SIZE;
//            r_value = value*0.5*Math.random();
//            this.datas.push([x,y,r_value]);
//            r_value = value*0.3*Math.random();
//            x = min_x + (columns+2)*size;
//            this.datas.push([x,y,r_value]);
//        }
//
//        // 增加上下两边的点
//        for(var i = 0 ; i < columns ; i++){
//            var x = min_x + i*size; //* this.BRUSH_SIZE;
//            var y = min_y - 1.5*size;
//            var r_value = value * 0.5 * Math.random();
//            this.datas.push([x,y,r_value]);
//            r_value = value * 0.3 * Math.random();
//            y = min_y - 2.5*size;
//            this.datas.push([x,y,r_value]);
//
//            y = min_y + (rows +1)*size;
//            r_value = value * 0.5*Math.random();
//            this.datas.push([x,y,r_value]);
//            r_value = value * 0.3*Math.random();
//            y = min_y + (rows +2)*size;
//            this.datas.push([x,y,r_value]);
//        }
//
//    },

    /**
     * 创建heatMap的Canvas
     * @returns {HTMLElement|*|$HeatMap2D.heatMapCanvas}
     */
    getCanvas: function (){
        var data = this.datas;
        var width = this.canvasWidth;
        var height = this.canvasHeight;
        var brush = this._createBrush();
        var gradient = this._createGradient();
        var r = this.BRUSH_SIZE + this.option.blurSize;

        var canvas = this.heatMapCanvas ;//= document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        var ctx = canvas.getContext('2d');

        var len = data.length;
        for (var i = 0; i < len; ++i) {
            var p = data[i];
            var x = p[0];
            var y = p[1];
            var value = p[2];
            // calculate alpha using value
            var alpha = Math.min(1, Math.max(value * this.option.valueScale
                || this.option.minAlpha, this.option.minAlpha));
            // draw with the circle brush with alpha
            ctx.globalAlpha = alpha;
            ctx.drawImage(brush, x - r, y - r);
        }

        // colorize the canvas using alpha value and set with gradient
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var pixels = imageData.data;
        var len = pixels.length / 4;
        while (len--) {
            var id = len * 4 + 3;
            var alpha = pixels[id] / 256;
            var colorOffset = Math.floor(alpha * (this.GRADIENT_LEVELS - 1));
            pixels[id - 3] = gradient[colorOffset * 4];     // red
            pixels[id - 2] = gradient[colorOffset * 4 + 1]; // green
            pixels[id - 1] = gradient[colorOffset * 4 + 2]; // blue
            if (this.withBg) {
                //            if(!pixels[id] || pixels[id] < 10){
                pixels[id] = 190; //205 这个透明度是整体的，全局
                //            }else{
                //                pixels[id] = 205;
                //            }
            } else {
                pixels[id] *= this.option.opacity; // alpha
            }  
        }
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    },

    /**
     * 创建原型的刷子
     * @private
     * @returns
     */
    _createBrush: function () {
        if (!this._brushCanvas) {
            this._brushCanvas = document.createElement('canvas');

            // set brush size
            var r = this.BRUSH_SIZE + this.option.blurSize;
            var d = r * 2;
            this._brushCanvas.width = d;
            this._brushCanvas.height = d;

            var ctx = this._brushCanvas.getContext('2d');

            // in order to render shadow without the distinct circle,
            // draw the distinct circle in an invisible place,
            // and use shadowOffset to draw shadow in the center of the canvas
            ctx.shadowOffsetX = d;
            ctx.shadowBlur = this.option.blurSize;
            // draw the shadow in black, and use alpha and shadow blur to generate
            // color in color map
            ctx.shadowColor = 'black';

            // draw circle in the left to the canvas
            ctx.beginPath();
            ctx.arc(-r, r, this.BRUSH_SIZE, 0, Math.PI * 2, true);
            ctx.closePath();
            ctx.fill();
        }
        return this._brushCanvas;
    },

    /**
     * 根据value获取颜色值
     * @returns {array}
     */
    _createGradient: function () {
        if (!this._gradientPixels) {
            var levels = this.GRADIENT_LEVELS;
            var canvas = document.createElement('canvas');
            canvas.width = 1;
            canvas.height = levels;
            var ctx = canvas.getContext('2d');
            var gradient = ctx.createLinearGradient(0, 0, 0, levels);
            var len = this.option.gradientColors.length;
            for (var i = 0; i < len; ++i) {
                if (typeof this.option.gradientColors[i] === 'string') {
                    gradient.addColorStop((i + 1) / len,
                        this.option.gradientColors[i]);
                } else {
                    gradient.addColorStop(this.option.gradientColors[i].offset,
                        this.option.gradientColors[i].color);
                }
            }

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1, levels);
            this._gradientPixels = ctx.getImageData(0, 0, 1, levels).data;
        }
        return this._gradientPixels;
    },

    /**
     * 将canvas上的原点转成3D上对应的点，也就是最canvas上左下角(0,0)的对应的坐标
     * @private
     */
    _getOriginal: function () {
        var x = this.positionX - this.width / 2;
        var y = this.height / 2 + this.positionY;
        return {x: x, y: y};
    },

    _getOriginalX: function () {
        return this.positionX - this.width / 2;
    },

    _getOriginalY: function () {
//    return this.positionY - this.height/2;
        return this.height / 2 + this.positionY; // 由于3D中原点在左上角(2D中在左下角)，y的方向正好搞反了,所以算个原始x值时是+h/2
    },

    _transPositionX: function (x) {
        return (parseFloat(x) - this._getOriginalX()) * (this.canvasWidth / this.width);
    },

    _transPositionY: function (y) {
//    return parseFloat(y) - this.positionY;
        return (this._getOriginalY() - parseFloat(y)) * (this.canvasHeight / this.height);// 由于3D中原点在左上角(2D中在左下角)，y的方向正好搞反了
    },

    /**
     * 将3D中的宽度w换算成canvas上对应的w
     * @param w
     * @private
     */
    _transWidth: function (d) {
        var w = parseFloat(d);
        if (w <= 0) return 0;
        return w * this.canvasWidth / this.width;
    },

    _transHeight: function (l) {
        var h = parseFloat(l);
        if (h <= 0) {
            return 0;
        }
        return h * this.canvasHeight / this.height;
    },

    clear : function(){
        this.datas = [];
    },

    /**
     * 由于之前在WebGL中非要将canvas加到了document中才能画。
     * 而此时没有用到webgl是可以不需要加到document中，可以考虑去掉，否则还画好后还得考虑从document中remove掉
     * @param callback
     */
    refresh: function (callback) {
        var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
            window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
        var self = this;
        raf(function () {
            document.body.appendChild(self.getCanvas());
            if (callback) {
                callback();
            }
        });
    },

    getImage: function () {
        if (this.heatMapCanvas) {
//        var ctx = this.heatmap.canvas.getContext('2d');
//        ctx.fillStyle = 'rgba(0,0,255,1.0)';
//        ctx.fillRect(0,0,500,500);
            return this.heatMapCanvas.toDataURL();
        } else {
            console.log('getImage error!');
        }
    },

    getTemperatureBoard: function () {
        var board = new mono.Plane(this.width, this.height);
        board.setStyle('m.texture.repeat', new mono.Vec2(1, 1))
              .setStyle('m.type', 'basic')
//        .setStyle('m.texture.image', this.getImage())
           // .setStyle('m.transparent', true)
           // .setStyle('m.type', 'phong')
           .setStyle('m.side', 'both');
           if(!this.withBg){
              board.setStyle('m.transparent', true);
              board.setStyle('m.type', 'phong');
           }
        board.setRotation(90 * Math.PI / 180, 0, 0);
        var self = this;
        this.refresh(function () {
            board.setStyle('m.texture.image', self.heatMapCanvas); //直接用canvas，每次生成一个image，重新刷新后不会被删除
            // board.setStyle('m.texture.image', self.getImage());
            document.body.removeChild(self.heatMapCanvas);
        });
        // (this.positionX,this.positionY)相对于中心点的偏移量，因此其并不是物理坐标，默认的这么设置，
        // 若温度场的parent的中心点不是坐标中心点时，需要在获取后重新设置一下
        board.setPositionX(this.positionX);
        board.setPositionZ(this.positionY);
        return board;
    }

});

it.HeatMap = $HeatMap2D;


/**
 * 权限管理模块
 * 
 * user-asset-power
 * user其实可以不用了，就当前用户，powerMap就保存当前user的权限即可，保存其他的user也没有何用，角色都不用了
 *
 * 权限级别：0、可见可操作；1、虚化；2、不可见；3、不创建3D对象(这一级别估计会不太好处理，对于已创建的对象和在当前场景时动态的创建的问题)
 *         没有的话，级别也是0
 *
 * 注意父子关系：当parent的权限级别一定要低于孩子的权限级别，否则孩子的级别就是其父亲对应的权限级别
 * 
 **/
var $DRMManager = function(sceneManager){
	this.sceneManager = sceneManager;
	this.dataManager = this.sceneManager.dataManager;
	// this.userMap = {};
	this.dataPowerMap = {}; //资产权限Map
	this.virtualLevel = new it.VirtualManager(this.sceneManager); // level1
	this.visibleLevel = new it.VisibleManager(this.sceneManager); // level2
	this.initDrmListener();
	this._dRMManagerChangeDispatcher = new mono.EventDispatcher();
	this.registerDRM();
};

mono.extend($DRMManager,Object,{

	 registerDRM : function(){
	 	// if (this.drmListener) {
	 	this.addDRMChangeListener(this.drmListener);
	 	// }
	 	this.sceneManager.viewManager3d.addVisibleFilter(this.visibleLevel);
	 	this.sceneManager.viewManager3d.addMaterialFilter(this.virtualLevel);
	 },

	 unRegister : function(){
	 	this.removeDRMChangeListener(this.drmListener);
	 	this.sceneManager.viewManager3d.removeVisibleFilter(this.visibleLevel);
	 	this.sceneManager.viewManager3d.removeMaterialFilter(this.virtualLevel);
	 },

	initDrmListener: function() {
		var self = this;
		this.drmListener = function(e) {
			var kind = e.kind;
			var dataId = e.dataId;
			var oldLevel = e.oldLevel;
			var newLevel = e.newLevel;
			if (!kind) {
				return;
			} else if (kind == 'add') { //这个add也可能是update，到底是不是就看oldLevel的值
				self._addOrUpdateAction(dataId,oldLevel,newLevel);
			} else if (kind == 'remove') {
				self._removeAction(dataId,oldLevel,newLevel);
			} else if (kind == 'clear') {
				self._clearAction();
			}
		};
	},

    /**
     * 增加或更新dataId资产的权限
     * 注意：其孩子的权限问题，当设置父亲权限时，孩子的各filter也要做相应的处理；但是孩子的权限map发生了改变的话，也需要check其parent的权限map
     * 
     */
	_addOrUpdateAction: function(dataId, oldLevel, newLevel) {
		if (!dataId) {
			return;
		}
		var data = this.dataManager.getDataById(dataId);
		// if (oldLevel != undefined) { // update
		// 不管是否update，都统一处理
		var parentLevel = this.getParentLevel(data)||0; //先祖宗的权限level
		if (parentLevel <= newLevel) {
			if (newLevel == 1) {
				this.setLevel1ForData(data);
			} else if (newLevel == 2) {
				this.setLevel2ForData(data);
			} else if (newLevel == 3) {
				this.setLevel3ForData(data);
			} else { //newLevel == 0
				this.setLevel0ForData(data);
			}
			this.sceneManager.viewManager3d.clearVisibleMap(); //当visibleFilter发生了改变时，需要把visibleMap清空，否则不能马上生效(非得场景切换后才生效)
		}

	},
    
    /**
     * 获取离其最近的祖宗的权限Level
     * 改成其祖宗中级别最高的那个
     */
	getParentLevel : function(dataOrId){
		if (!dataOrId) {
			return 0;
		}
		var data = null;
		if (dataOrId instanceof it.Data) {
			data = dataOrId;
		}else {
			data = this.dataManager.getDataById(dataOrId);
		}
		if (!data) {
			return 0;
		}
		var parent = this.dataManager.getDataById(data.getParentId());
		if (!parent) {
			return 0;
		}
		if (this.dataPowerMap[parent.getId()] != undefined) {
			var level = this.dataPowerMap[parent.getId()];
			if (level == 3 ) { // 3是最高级别的了，直接返回，不在递归
				return 3;
			}
			var ancLevel = this.getParentLevel(parent,this);
			if (ancLevel > level) {
				return ancLevel;
			}else{
				return level;
			}
		}else {
			return this.getParentLevel(parent,this);
		}
		
	},

    /**
     * 给data设置level1级权限：虚幻
     */
	setLevel1ForData : function(data){
		if (!data) {
			return;
		}
		this._removeFromLevel3(data); //从level3的管理器中去除
		this._removeFromLevel2(data); //从level2的管理器中去除
		this.virtualLevel.add(data); // 加到了level1中，也要从高的level的管理器中去掉
		var children = data.getChildren();
        if(children && children.size() > 0){
            for(var i = 0 ; i < children.size(); i++){
                var child = children.get(i);
                var childLevel = this.dataPowerMap[child.getId()];
                if(child && (!childLevel || childLevel <= 1)){//当孩子没有设置过权限，或权限level比level1小时，则应该被parent权限覆盖
                    this.setLevel1ForData(child,this);
                }else if (childLevel == 2) {
                	this.setLevel2ForData(child,this);
                }else if (childLevel == 3){
                	this.setLevel3ForData(child,this);
                }
            }
        }
	},

    /**
     * 给data设置level2级权限：不可见
     */
	setLevel2ForData : function(data){
		if (!data) {
			return ;
		}
		this._removeFromLevel3(data); //从level3的管理器中去除
		this.visibleLevel.setVisible(data,false);
		var children = data.getChildren();
        if(children && children.size() > 0){
            for(var i = 0 ; i < children.size(); i++){
                var child = children.get(i);
                var childLevel = this.dataPowerMap[child.getId()];
                if(child && (!childLevel || childLevel <= 2)){//当孩子没有设置过权限，或权限level比level1小时，则应该被parent权限覆盖
                    this.setLevel2ForData(child,this);
                }else if(childLevel == 3){
                	this.setLevel3ForData(child,this);
                }
            }
        }
	},
    
    /**
     * 给data设置level3级权限：不创建3D对象
     * 这里需要注意的太多了：1、一开始要堵住入口；
                          2、已经创建了怎么整（从缓存中找到，删除父子关系，并删除）
                          3、已经创建了并且正在显示着怎么整（踢出父子关系，从box中删除）
     * 
     */
	setLevel3ForData : function(data){
		if (!data) {
			return ;
		}
	},

    /**
     * 给data设置level0级权限，由于默认的是0级，所以这里就处理清空
     */
	setLevel0ForData : function(data){
		if (!data) {
			return ;
		}
		this._removeFromLevel3(data);
		this._removeFromLevel2(data);
		this._removeFromLevel1(data);
		var children = data.getChildren();
        if(children && children.size() > 0){
            for(var i = 0 ; i < children.size(); i++){
                var child = children.get(i);
                var childLevel = this.dataPowerMap[child.getId()];
                if(child && !childLevel){//当孩子没有设置过权限，或权限为0时，则应该被parent权限覆盖(其实这里也就是清空)
                    this.setLevel0ForData(child,this);
                }else if (childLevel == 1) {
                	this.setLevel1ForData(child,this);
                }else if (childLevel == 2){
                	this.setLevel2ForData(child,this);
                }else if (childLevel == 3){
                	this.setLevel3ForData(child,this);
                }
            }
        }
	},

	_removeFromLevel3 : function(data){

	},

	_removeFromLevel2 : function(data){
		this.visibleLevel.setVisible(data,true); 
	},

	_removeFromLevel1 : function(data){
		this.virtualLevel.remove(data);
	},
    
    /**
     * 从level0管理器中去除，由于默认的是level0，这里可以do nothing。。。
     */
	_removeFromLevel0 : function(data){

	},

	_clearLevel3 : function(){

	},

	_clearLevel2 : function(){
		this.visibleLevel.clear();
	},

	_clearLevel1 : function(){
		this.virtualLevel.clearAll();
	},

	_clearLevel0 : function(){
		// do nothing......
	},

    /** 
     * 删除资产权限的处理
     */
	_removeAction : function(dataId,oldLevel){
		if (!dataId) {
			return;
		}
		var data = this.dataManager.getDataById(dataId);
		var parentLevel = this.getParentLevel(data) || 0; //先祖宗的权限level
		if (parentLevel < oldLevel) {
			if (parentLevel == 1) {
				this.setLevel1ForData(data);
			} else if (parentLevel == 2) {
				this.setLevel2ForData(data);
			} else if (parentLevel == 3) {
				this.setLevel3ForData(data);
			} else { //newLevel == 0 //理论上这条不可能会被执行
				this.setLevel0ForData(data);
			}
			this.sceneManager.viewManager3d.clearVisibleMap(); 
		}
	},

	_clearAction : function(){
		this._clearLevel0();
		this._clearLevel1();
		this._clearLevel2();
		this._clearLevel3();
		this.sceneManager.viewManager3d.clearVisibleMap(); 
	},

    /**
     * 设置默认的级别
     * 也是统一将所有的data都设置成同一level级别
     * 这样的效率不知道会怎样
     */
	initDefaultLevel : function(level){
		var dataMap = this.dataManager._dataMap;
		for(var id in dataMap){
			this._addOrUpdateAction(id,null,level);
		}
	},

     // /**
     //  * 给当前user设置dataOrId资产的权限
     //  */
     // add : function(dataOrId,powerLevel){
     // 	this.update(dataOrId,powerLevel);
     // },

     /**
      * 给当前user设置dataOrId资产的权限
      */
	 update : function(dataOrId,powerLevel){
	 	if (!dataOrId) {
	 		return ;
	 	}
	 	if (powerLevel == null || powerLevel == undefined) {
	 		console.log('please input right powerLevel, like 0,1,2,3');
	 	}
	 	var dataId = dataOrId;
	 	if (dataOrId instanceof it.Data) {
	 		dataId = dataOrId.getId();
	 	}
	 	var oldLevel = this.dataPowerMap[dataId];
	 	this.dataPowerMap[dataId] = powerLevel;
		this._dRMManagerChangeDispatcher.fire({
			kind: 'add', //这个add可能包含着update
			dataId : dataId,
			oldLevel: oldLevel,
			newLevel: powerLevel
		});
	 },
     
     /**
      * 删除资产权限
      */
	 remove : function(dataOrId){
	 	if (!dataOrId) {
	 		return;
	 	}
	 	var dataId = dataOrId;
	 	if (dataOrId instanceof it.Data) {
	 		dataId = dataOrId.getId();
	 	}
	 	if (this.dataPowerMap[dataId] == undefined) {
	 		return ;
	 	}
	 	var oldLevel = this.dataPowerMap[dataId];
	 	delete this.dataPowerMap[dataId];
	 	this._dRMManagerChangeDispatcher.fire({
			kind: 'remove',
			dataId: dataId,
			oldLevel: oldLevel
		});
	 },

     /**
      * 清除所有的权限，清除后所有的资产的权限级别都是0
      */
	 clear : function(){
	 	this.dataPowerMap = {};
	 	this._dRMManagerChangeDispatcher.fire({
			kind: 'clear'
		});
	 },

	 addDRMChangeListener : function(listener, scope, ahead){
	 	this._dRMManagerChangeDispatcher.add(listener, scope, ahead);
	 },

	 removeDRMChangeListener : function(listener, scope, ahead){
	 	this._dRMManagerChangeDispatcher.remove(listener, scope);
	 },


});

it.DRMManager = $DRMManager;



it.PopMenuManager = function(sceneManager){
    this.sceneManager = sceneManager;
    this.getMenuItemsFunction = null;
    this._initPopMenu();
};

mono.extend(it.PopMenuManager,Object,{
     _initPopMenu : function(){
     	var self = this,network = this.sceneManager.network3d;
        var popupMenu = this._popupMenu = new twaver.controls.PopupMenu(network.getRootView());
        popupMenu.setBackground('#90C3D4');
        popupMenu.setBorder("2px solid #90C3D4");
        var oShow = popupMenu.show;
        popupMenu.show = function(e){// 增加一个偏移
           oShow.call(this,e);
           var view = this._view;
           var style = view.style;
            style.left = (parseInt(style.left) + 1) + 'px';
            style.top = (parseInt(style.top) + 1)+ 'px';
        };
        initPopupMenu();
        function initPopupMenu(){
            var lastData, box = network.getDataBox(), event;
            popupMenu.onMenuShowing = function(e){
               event = e;
                var first = network.getFirstElementByMouseEvent(e, false, function (data) {
                    var flag = data.getClient('mainVisible');
                    var mainObj = Utils.isNotNull(flag);
                    return !mainObj;
                });
                var items = [];
                if(first){
                   lastData = first.element;
                   var data = main.sceneManager.getNodeData(lastData);
                   items = self.getMenuItems(lastData,data,event,first);
                }else{
                	items = self.getMenuItems(null,null,event,null);
                }
                if(items && items.length > 0){
                	popupMenu.setMenuItems(items);
                	return true;
                }
                return false;
            };
        };


     },

     getPopupMenu : function(){
     	return this._popupMenu;
     },
     // [{label : 增加机柜,action : function(menuItem){},group:none}]
     getMenuItems : function(element,data,event,eventObject){
        if(this.getMenuItemsFunction){
        	return this.getMenuItemsFunction(element,data,event,eventObject);
        }
        return [];
     },
});
})(window);